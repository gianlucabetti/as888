000100141210      //--------------------------------------------------------------
000200150130      //?AUTA04R - Crea WFAUT00F da WFAUC00F
000300141210      //--------------------------------------------------------------
000400141210
000500141210     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600141210     h dftactgrp(*no) actgrp(*caller)
000700141210
000800141210      //---------------------------------------------------------------
000900141210      //?Dichiarazione file.
001000141210      //---------------------------------------------------------------
001100070712
001200141210     fTNTAM04L  if   e           k disk
001300141210     fWFAUT00F  o    e             disk    usropn extfile('EDPAUMENTI/WFAUT00F')
001400141210
001500141210      //---------------------------------------------------------------
001600141210      //?Definizione costanti.
001700141210      //---------------------------------------------------------------
001800141210
001900141210      //---------------------------------------------------------------
002000141210      //?Definizione schiere.
002100141210      //---------------------------------------------------------------
002200141210
002300141210      //---------------------------------------------------------------
002400141210      //?Definizione aree dati.
002500141210      //---------------------------------------------------------------
002600141210
002700141210      // - Dati utente
002800141210     d §AzUte        e ds                  extname(AZUTE00F)
002900141210     d                                     dtaara
003000141210     d §DatiUte      e ds                  extname(dDatiUte)
003100141210     d                                     dtaara
003200141210
003300141210      //---------------------------------------------------------------
003400141210      //?Definizione strutture dati.
003500141210      //---------------------------------------------------------------
003600141210
003700141210      // - Parametri ricevuti
003800141210     d KPJBA         e ds
003900141210
004000141210      // - Reperimento dati utente
004100141210     d TIBS34DS      e ds
004200150130
004300150130      // - Reperimento dati Anagrafica Clienti
004400150130      /copy gaitrasrc/srcprotopi,TIBS69R
004500150130
004600150130      // - File WFAUC
004700150130     d WFAUC00F      e ds                  extname(WFAUC00F)
004800150130     d                                     prefix(WFC:3)
004900141210
005000141210      //---------------------------------------------------------------
005100141210      //?Definizione variabili globali.
005200141210      //---------------------------------------------------------------
005300141210
005400141210      // - Flags booleani
005500141210     d Fine            s               n   inz(*off)
005600141210     d wEoF            s               n   inz(*off)
005700141210
005800141210      // - Campi di comodo
005900141210     d Comando         s            512a   varying
006000141210     d Oggi            s              8s 0 inz
006100141210     d sav_TAMctr      s                   like(TAMctr) inz(999)
006200141210
006300141210      //---------------------------------------------------------------
006400141210      //?Definizione Procedure usate.
006500141210      //---------------------------------------------------------------
006600141210
006700141210      //---------------------------------------------------------------
006800141210      //?Definizione Prototipi.
006900141210      //---------------------------------------------------------------
007000141210      /copy gaitrasrc/srcprotopr,TIBS34R
007100150130      /copy gaitrasrc/srcprotopr,TIBS69R
007200141210      /copy gaitrasrc/srcprotopr,SYSTEM
007300141210
007400141210      //---------------------------------------------------------------
007500141210      //?Definizione key-list.
007600141210      //---------------------------------------------------------------
007700141210       // - File TNTAM04L
007800141210     d k03tntam      e ds                  extname(TNTAM04L:*key)
007900141210     d                                     prefix(k_)
008000141210
008100141210      //---------------------------------------------------------------
008200141210      //?M A I N - L I N E
008300141210      //---------------------------------------------------------------
008400141210
008500141210     c     *Entry        plist
008600141210     c                   parm                    kpjba
008700141210
008800141210      /free
008900141210
009000141210       //?Operazioni iniziali
009100141210       exsr RoutInz;
009200141210
009300141210       //?Elaborazione
009400141210       exsr Elabora;
009500141210
009600141210       //?Operazioni finali
009700141210       exsr RoutEnd;
009800141210
009900141210       //--------------------------------------------------------------
010000141210       //?Operazioni iniziali.
010100141210       //--------------------------------------------------------------
010200141210       BEGSR RoutInz;
010300141210
010400141210         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
010500141210
010600141210       //?Imposto oggi
010700141210         Oggi = %dec(%date());
010800141210
010900141210       //?Reperimento dati job
011000141210         exsr DatiJob;
011100141210
011200141210       //?Pulisco il file di work
011300141210         comando = 'CLRPFM FILE(EDPAUMENTI/WFAUT00F)';
011400141210         IF  ExecuteCommand (comando) > 0 ;
011500141210           exsr RoutEnd;
011600141210         ENDIF;
011700141210
011800141210       //?Apro il file di work
011900141210         open WFAUT00F;
012000141210
012100141210       ENDSR;
012200141210
012300141210       //--------------------------------------------------------------
012400141210       //?Reperimento Dati del job (Utente/Operativi).
012500141210       //--------------------------------------------------------------
012600141210       BEGSR DatiJob;
012700141210
012800141210         in(E) §AzUte;
012900141210         IF  not %error;
013000141210           in(E) §DatiUte;
013100141210         ENDIF;
013200141210         IF  %error or RSut = *blanks;
013300141210           clear TIBS34ds;
013400141210           tibs34r(tibs34ds);
013500141210           in §AzUte;
013600141210           in §DatiUte;
013700141210         ENDIF;
013800141210
013900141210       ENDSR;
014000141210
014100141210       //--------------------------------------------------------------
014200141210       //?Elaborazione.
014300141210       //--------------------------------------------------------------
014400141210       BEGSR Elabora;
014500150130
014600150130       //?Leggo WFAUC
014700150130       //?solo 'C'
014800150130       //?No annullato
014900150130       //?No bloccato
015000150130       //?ha tariffe
015100150130         exec sql
015200150130         DECLARE WRK cursor for
015300150130         SELECT * from WFAUC00F
015400150130         WHERE WFAtcl = 'C' and WFAflg = ' ' and
015500150204               WFAtar = ' ';
015600150130
015700150130         //?Apertura del cursore
015800150130         exec sql open WRK;
015900150130
016000150130         IF sqlcode < 0;
016100150130           exec sql close WRK;
016200150130           leavesr;
016300150130         ENDIF;
016400150130
016500150130         DOW  not wEoF;
016600150130           exec sql
016700150130           fetch next from WRK into :WFAUC00F;
016800150130           IF  sqlcod = 100 or sqlcod < 0;
016900150130             wEoF = *on;
017000150130             leave;
017100150130           ENDIF;
017200141210
017300150130         //?Leggo le tariffe
017400150130           setll WFCksc TNTAM04L;
017500150130           reade WFCksc TNTAM04L;
017600150130           DOW not %eof(TNTAM04L);
017700141210
017800150130         //?Faccio i ragionamenti a cambio tariffa
017900150130             IF  TAMctr <> sav_TAMctr;
018000150130           //?Scrivo il file di Work
018100150130               exsr Scrivi;
018200150130               sav_TAMctr = TAMctr;
018300150130             ENDIF;
018400150130
018500150130             reade WFCksc TNTAM04L;
018600141210
018700150130           ENDDO;
018800150130           reset sav_TAMctr;
018900150130
019000150130         ENDDO;
019100150130
019200150130         exec sql close WRK;
019300141210
019400141210       ENDSR;
019500141210
019600141210       //--------------------------------------------------------------
019700141210       //?Scrivo il file di Work.
019800141210       //--------------------------------------------------------------
019900141210       BEGSR Scrivi;
020000141210
020100141210         clear WFAUT000;
020200150130
020300141210         WFAclf = TAMksc;
020400141210
020500141210         clear TIBS69DS;
020600141210         clear ACOrag;
020700141210         I69kac = TAMksc;
020800141210         TIBS69R (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
020900141210         WFArag = ACOrag;
021000141210
021100141210         WFActrv = TAMctr;
021200141210         WFAprgv = TAMprg;
021300141210         WFAddtv = TAMddt;
021400141210         WFAdstv = TAMdst;
021500150202         WFAbap  = TAMbap;
021600141210
021700141210         WFApagv = TAMpag;
021800141210         WFAppav = TAMppa;
021900141210
022000141210         write WFAUT000;
022100141210
022200141210       ENDSR;
022300141210
022400141210       //--------------------------------------------------------------
022500141210       //?Operazioni finali.
022600141210       //--------------------------------------------------------------
022700141210       BEGSR RoutEnd;
022800141210
022900141210         *inLR = *on;
023000141210         return;
023100141210
023200141210       ENDSR;
023300141210
023400141210      /end-free
