000100141210      //--------------------------------------------------------------
000200141210      //?AUTA01R - Crea WF x Aumento tariffe 2015
000300141210      //--------------------------------------------------------------
000400141210
000500141210     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600141210     h dftactgrp(*no) actgrp(*caller)
000700141210
000800141210      //---------------------------------------------------------------
000900141210      //?Dichiarazione file.
001000141210      //---------------------------------------------------------------
001100070712
001200141210     fTNTAM04L  if   e           k disk
001300141210     fWFAUT00F  o    e             disk    usropn extfile('EDPAUMENTI/WFAUT00F')
001400141210
001500141210      //---------------------------------------------------------------
001600141210      //?Definizione costanti.
001700141210      //---------------------------------------------------------------
001800141210
001900141210      //---------------------------------------------------------------
002000141210      //?Definizione schiere.
002100141210      //---------------------------------------------------------------
002200141210
002300141210      //---------------------------------------------------------------
002400141210      //?Definizione aree dati.
002500141210      //---------------------------------------------------------------
002600141210
002700141210      // - Dati utente
002800141210     d §AzUte        e ds                  extname(AZUTE00F)
002900141210     d                                     dtaara
003000141210     d §DatiUte      e ds                  extname(dDatiUte)
003100141210     d                                     dtaara
003200141210
003300141210      //---------------------------------------------------------------
003400141210      //?Definizione strutture dati.
003500141210      //---------------------------------------------------------------
003600141210
003700141210      // - Parametri ricevuti
003800141210     d KPJBA         e ds
003900141210
004000141210      // - Reperimento dati utente
004100141210     d TIBS34DS      e ds
004200141210
004300141210      // - Reperimento dati Anagrafica Clienti
004400141210      /copy gaitrasrc/srcprotopi,TIBS69R
004500141210
004600141210      //---------------------------------------------------------------
004700141210      //?Definizione variabili globali.
004800141210      //---------------------------------------------------------------
004900141210
005000141210      // - Flags booleani
005100141210     d Fine            s               n   inz(*off)
005200141210     d wEoF            s               n   inz(*off)
005300141210
005400141210      // - Campi di comodo
005500141210     d Comando         s            512a   varying
005600141210     d Oggi            s              8s 0 inz
005700141210     d sav_TAMksc      s                   like(TAMksc) inz
005800141210     d sav_TAMctr      s                   like(TAMctr) inz(999)
005900141210
006000141210      //---------------------------------------------------------------
006100141210      //?Definizione Procedure usate.
006200141210      //---------------------------------------------------------------
006300141210
006400141210      //---------------------------------------------------------------
006500141210      //?Definizione Prototipi.
006600141210      //---------------------------------------------------------------
006700141210      /copy gaitrasrc/srcprotopr,TIBS34R
006800141210      /copy gaitrasrc/srcprotopr,TIBS69R
006900141210      /copy gaitrasrc/srcprotopr,SYSTEM
007000141210
007100141210      //---------------------------------------------------------------
007200141210      //?Definizione key-list.
007300141210      //---------------------------------------------------------------
007400141210       // - File TNTAM04L
007500141210     d k03tntam      e ds                  extname(TNTAM04L:*key)
007600141210     d                                     prefix(k_)
007700141210
007800141210      //---------------------------------------------------------------
007900141210      //?M A I N - L I N E
008000141210      //---------------------------------------------------------------
008100141210
008200141210     c     *Entry        plist
008300141210     c                   parm                    kpjba
008400141210
008500141210      /free
008600141210
008700141210       //?Operazioni iniziali
008800141210       exsr RoutInz;
008900141210
009000141210       //?Elaborazione
009100141210       exsr Elabora;
009200141210
009300141210       //?Operazioni finali
009400141210       exsr RoutEnd;
009500141210
009600141210       //--------------------------------------------------------------
009700141210       //?Operazioni iniziali.
009800141210       //--------------------------------------------------------------
009900141210       BEGSR RoutInz;
010000141210
010100141210         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
010200141210
010300141210       //?Imposto oggi
010400141210         Oggi = %dec(%date());
010500141210
010600141210       //?Reperimento dati job
010700141210         exsr DatiJob;
010800141210
010900141210       //?Pulisco il file di work
011000141210         comando = 'CLRPFM FILE(EDPAUMENTI/WFAUT00F)';
011100141210         IF  ExecuteCommand (comando) > 0 ;
011200141210           exsr RoutEnd;
011300141210         ENDIF;
011400141210
011500141210       //?Apro il file di work
011600141210         open WFAUT00F;
011700141210
011800141210       ENDSR;
011900141210
012000141210       //--------------------------------------------------------------
012100141210       //?Reperimento Dati del job (Utente/Operativi).
012200141210       //--------------------------------------------------------------
012300141210       BEGSR DatiJob;
012400141210
012500141210         in(E) §AzUte;
012600141210         IF  not %error;
012700141210           in(E) §DatiUte;
012800141210         ENDIF;
012900141210         IF  %error or RSut = *blanks;
013000141210           clear TIBS34ds;
013100141210           tibs34r(tibs34ds);
013200141210           in §AzUte;
013300141210           in §DatiUte;
013400141210         ENDIF;
013500141210
013600141210       ENDSR;
013700141210
013800141210       //--------------------------------------------------------------
013900141210       //?Elaborazione.
014000141210       //--------------------------------------------------------------
014100141210       BEGSR Elabora;
014200141210
014300141210       //?Leggo le tariffe
014400141210         clear k_TAMksc;
014500141210         setll k_TAMksc TNTAM04L;
014600141210         DOW not wEoF;
014700141210
014800141210           read TNTAM04L;
014900141210       //?Fine file
015000141210           IF  %eof(TNTAM04L);
015100141210             leavesr;
015200141210           ENDIF;
015300141210       //?Tariffa di cartello la scarto
015400141210           IF  %subst(%editc(TAMksc:'X'):1:3) = '888';
015500141210             iter;
015600141210           ENDIF;
015700141210
015800141210       //?Faccio i ragionamenti a cambio tariffa
015900141210           IF  TAMksc <> sav_TAMksc or TAMctr <> sav_TAMctr;
016000141210
016100141210         //?Tariffa senza Addizionale gestione anno corrente la scarto
016200141210         //?e leggo altra tariffa
016300141210             IF  TAMppa = 0;
016400141210               sav_TAMksc = TAMksc;
016500141210               sav_TAMctr = TAMctr;
016600141210               iter;
016700141210             ENDIF;
016800141210         //?Tariffa con decorrenza 2015 la scarto
016900141210         //?e leggo altra tariffa
017000141210             IF  TAMddt > 20141231;
017100141210               sav_TAMksc = TAMksc;
017200141210               sav_TAMctr = TAMctr;
017300141210               iter;
017400141210             ENDIF;
017500141210
017600141210         //?Scrivo il file di Work
017700141210             exsr Scrivi;
017800141210             sav_TAMksc = TAMksc;
017900141210             sav_TAMctr = TAMctr;
018000141210
018100141210           ENDIF;
018200141210
018300141210         ENDDO;
018400141210
018500141210       ENDSR;
018600141210
018700141210       //--------------------------------------------------------------
018800141210       //?Scrivo il file di Work.
018900141210       //--------------------------------------------------------------
019000141210       BEGSR Scrivi;
019100141210
019200141210         clear WFAUT000;
019300141210
019400141210         WFAclf = TAMksc;
019500141210
019600141210         clear TIBS69DS;
019700141210         clear ACOrag;
019800141210         I69kac = TAMksc;
019900141210         TIBS69R (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
020000141210         WFArag = ACOrag;
020100141210
020200141210         WFActrv = TAMctr;
020300141210         WFAprgv = TAMprg;
020400141210         WFAddtv = TAMddt;
020500141210         WFAdstv = TAMdst;
020600141210
020700141210         WFApagv = TAMpag;
020800141210         WFAppav = TAMppa;
020900141210
021000141210         write WFAUT000;
021100141210
021200141210       ENDSR;
021300141210
021400141210       //--------------------------------------------------------------
021500141210       //?Operazioni finali.
021600141210       //--------------------------------------------------------------
021700141210       BEGSR RoutEnd;
021800141210
021900141210         *inLR = *on;
022000141210         return;
022100141210
022200141210       ENDSR;
022300141210
022400141210      /end-free
