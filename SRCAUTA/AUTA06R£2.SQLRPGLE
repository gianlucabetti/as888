000100151202      //--------------------------------------------------------------
000200151202      //?AUTA06R - Crea WF x Addizionale Gestione tariffe 2016
000300151202      //--------------------------------------------------------------
000400151202
000500151202     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600151202     h dftactgrp(*no) actgrp(*caller)
000700151202
000800151202      //---------------------------------------------------------------
000900151202      //?Dichiarazione file.
001000151202      //---------------------------------------------------------------
001100151202
001200151202     fTNTAM04L  if   e           k disk
001300151202     fWFAUT00F  o    e             disk    usropn extfile('EDPAUMENTI/WFAUT00F')
001400151202
001500151202      //---------------------------------------------------------------
001600151202      //?Definizione costanti.
001700151202      //---------------------------------------------------------------
001800151202
001900151202      //---------------------------------------------------------------
002000151202      //?Definizione schiere.
002100151202      //---------------------------------------------------------------
002200151202
002300151202      //---------------------------------------------------------------
002400151202      //?Definizione aree dati.
002500151202      //---------------------------------------------------------------
002600151202
002700151202      // - Dati utente
002800151202     d §AzUte        e ds                  extname(AZUTE00F)
002900151202     d                                     dtaara
003000151202     d §DatiUte      e ds                  extname(dDatiUte)
003100151202     d                                     dtaara
003200151202
003300151202      //---------------------------------------------------------------
003400151202      //?Definizione strutture dati.
003500151202      //---------------------------------------------------------------
003600151202
003700151202      // - Parametri ricevuti
003800151202     d KPJBA         e ds
003900151202
004000151202      // - Reperimento dati utente
004100151202     d TIBS34DS      e ds
004200151202
004300151202      // - Reperimento dati Anagrafica Clienti
004400151202      /copy gaitrasrc/srcprotopi,TIBS69R
004500151202
004600151202      //---------------------------------------------------------------
004700151202      //?Definizione variabili globali.
004800151202      //---------------------------------------------------------------
004900151202
005000151202      // - Flags booleani
005100151202     d Fine            s               n   inz(*off)
005200151202     d wEoF            s               n   inz(*off)
005300151202
005400151202      // - Campi di comodo
005500151202     d Comando         s            512a   varying
005600151202     d Oggi            s              8s 0 inz
005700151202     d sav_TAMksc      s                   like(TAMksc) inz
005800151202     d sav_TAMctr      s                   like(TAMctr) inz(999)
005900151202
006000151202      //---------------------------------------------------------------
006100151202      //?Definizione Procedure usate.
006200151202      //---------------------------------------------------------------
006300151202
006400151202      //---------------------------------------------------------------
006500151202      //?Definizione Prototipi.
006600151202      //---------------------------------------------------------------
006700151202      /copy gaitrasrc/srcprotopr,TIBS34R
006800151202      /copy gaitrasrc/srcprotopr,TIBS69R
006900151202      /copy gaitrasrc/srcprotopr,SYSTEM
007000151202
007100151202      //---------------------------------------------------------------
007200151202      //?Definizione key-list.
007300151202      //---------------------------------------------------------------
007400151202       // - File TNTAM04L
007500151202     d k03tntam      e ds                  extname(TNTAM04L:*key)
007600151202     d                                     prefix(k_)
007700151202
007800151202      //---------------------------------------------------------------
007900151202      //?M A I N - L I N E
008000151202      //---------------------------------------------------------------
008100151202
008200151202     c     *Entry        plist
008300151202     c                   parm                    kpjba
008400151202
008500151202      /free
008600151202
008700151202       //?Operazioni iniziali
008800151202       exsr RoutInz;
008900151202
009000151202       //?Elaborazione
009100151202       exsr Elabora;
009200151202
009300151202       //?Operazioni finali
009400151202       exsr RoutEnd;
009500151202
009600151202       //--------------------------------------------------------------
009700151202       //?Operazioni iniziali.
009800151202       //--------------------------------------------------------------
009900151202       BEGSR RoutInz;
010000151202
010100151202         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
010200151202
010300151202       //?Imposto oggi
010400151202         Oggi = %dec(%date());
010500151202
010600151202       //?Reperimento dati job
010700151202         exsr DatiJob;
010800151202
010900151202       //?Pulisco il file di work
011000151202         comando = 'CLRPFM FILE(EDPAUMENTI/WFAUT00F)';
011100151202         IF  ExecuteCommand (comando) > 0 ;
011200151202           exsr RoutEnd;
011300151202         ENDIF;
011400151202
011500151202       //?Apro il file di work
011600151202         open WFAUT00F;
011700151202
011800151202       ENDSR;
011900151202
012000151202       //--------------------------------------------------------------
012100151202       //?Reperimento Dati del job (Utente/Operativi).
012200151202       //--------------------------------------------------------------
012300151202       BEGSR DatiJob;
012400151202
012500151202         in(E) §AzUte;
012600151202         IF  not %error;
012700151202           in(E) §DatiUte;
012800151202         ENDIF;
012900151202         IF  %error or RSut = *blanks;
013000151202           clear TIBS34ds;
013100151202           tibs34r(tibs34ds);
013200151202           in §AzUte;
013300151202           in §DatiUte;
013400151202         ENDIF;
013500151202
013600151202       ENDSR;
013700151202
013800151202       //--------------------------------------------------------------
013900151202       //?Elaborazione.
014000151202       //--------------------------------------------------------------
014100151202       BEGSR Elabora;
014200151202
014300151202       //?Leggo le tariffe
014400151202         clear k_TAMksc;
014500151202         setll k_TAMksc TNTAM04L;
014600151202         DOW not wEoF;
014700151202
014800151202           read TNTAM04L;
014900151202       //?Fine file
015000151202           IF  %eof(TNTAM04L);
015100151202             leavesr;
015200151202           ENDIF;
015300151202       //?Tariffa di cartello la scarto
015400151202           IF  %subst(%editc(TAMksc:'X'):1:3) = '888';
015500151202             iter;
015600151202           ENDIF;
015700151202
015800151202       //?Faccio i ragionamenti a cambio tariffa
015900151202           IF  TAMksc <> sav_TAMksc or TAMctr <> sav_TAMctr;
016000151202
016100151202         //?Tariffa senza Addizionale gestione anno corrente la scarto
016200151202         //?e leggo altra tariffa
016300151202             IF  TAMppa = 0;
016400151202               sav_TAMksc = TAMksc;
016500151202               sav_TAMctr = TAMctr;
016600151202               iter;
016700151202             ENDIF;
016800151202         //?Tariffa con decorrenza 2016 la scarto
016900151202         //?e leggo altra tariffa
017000151202             IF  TAMddt > 20151231;
017100151202               sav_TAMksc = TAMksc;
017200151202               sav_TAMctr = TAMctr;
017300151202               iter;
017400151202             ENDIF;
017500151202
017600151202         //?Scrivo il file di Work
017700151202             exsr Scrivi;
017800151202             sav_TAMksc = TAMksc;
017900151202             sav_TAMctr = TAMctr;
018000151202
018100151202           ENDIF;
018200151202
018300151202         ENDDO;
018400151202
018500151202       ENDSR;
018600151202
018700151202       //--------------------------------------------------------------
018800151202       //?Scrivo il file di Work.
018900151202       //--------------------------------------------------------------
019000151202       BEGSR Scrivi;
019100151202
019200151202         clear WFAUT000;
019300151202
019400151202         WFAclf = TAMksc;
019500151202
019600151202         clear TIBS69DS;
019700151202         clear ACOrag;
019800151202         I69kac = TAMksc;
019900151202         TIBS69R (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
020000151202         WFArag = ACOrag;
020100151202
020200151202         WFActrv = TAMctr;
020300151202         WFAprgv = TAMprg;
020400151202         WFAddtv = TAMddt;
020500151202         WFAdstv = TAMdst;
020600151202
020700151202         WFApagv = TAMpag;
020800151202         WFAppav = TAMppa;
020900151202
021000151202         write WFAUT000;
021100151202
021200151202       ENDSR;
021300151202
021400151202       //--------------------------------------------------------------
021500151202       //?Operazioni finali.
021600151202       //--------------------------------------------------------------
021700151202       BEGSR RoutEnd;
021800151202
021900151202         *inLR = *on;
022000151202         return;
022100151202
022200151202       ENDSR;
022300151202
022400151202      /end-free
