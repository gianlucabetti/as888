000100170210      //-------------------------------------------------------------------
000200170313      //?AUTAD06R - Da WF aggiorno il TAMPPA in TNTAM
000300170210      //-------------------------------------------------------------------
000400170210     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000500170210
000600170210      //---------------------------------------------------------------
000700170210      //?Dichiarazione file.
000800170210      //---------------------------------------------------------------
000900170210     fWFAUD01L  uf   e           k disk
001000170210
001100170313     fTITAV01L  if   e           k disk
001200170313     fTNTAM01L  uf   e           k disk
001300170210
001400170210      //---------------------------------------------------------------
001500170210      //?Definizione costanti.
001600170210      //---------------------------------------------------------------
001700170210
001800170210      //---------------------------------------------------------------
001900170210      //?Definizione schiere.
002000170210      //---------------------------------------------------------------
002100170210
002200170210      //---------------------------------------------------------------
002300170210      //?Definizione aree dati.
002400170210      //---------------------------------------------------------------
002500170210      // - Dati utente
002600170210     d §AzUte        e ds                  extname(AZUTE00F)
002700170210     d                                     dtaara
002800170210     d §DatiUte      e ds                  extname(dDatiUte)
002900170210     d                                     dtaara
003000170210
003100170210      //---------------------------------------------------------------
003200170210      //?Definizione strutture dati.
003300170210      //---------------------------------------------------------------
003400170210      // - Parametri ricevuti
003500170210     d KPJBA         e ds
003600170210
003700170210      // - Reperimento dati utente
003800170210     d TIBS34DS      e ds
003900170210
004000170210      //---------------------------------------------------------------
004100170210      //?Definizione variabili globali.
004200170210      //---------------------------------------------------------------
004300170210      // - Flags booleani
004400170210     d Fine            s               n   inz(*off)
004500170210     d wEoF            s               n   inz(*off)
004600170210
004700170210      // - Campi di comodo
004800170313     d ksc             s                   like(WFAksc) inz
004900170313     d Tipo            s                   like(WFAtipo) inz('T')
005000170313     d Trd             s                   like(TAVtrd) inz('TES')
005100170313     d wcta            s                   like(TAVcta)
005200170313     d wnoj            s                   like(TAVnoj)
005300170210
005400170210      //---------------------------------------------------------------
005500170210      //?Definizione Procedure usate.
005600170210      //---------------------------------------------------------------
005700170210
005800170210      //---------------------------------------------------------------
005900170210      //?Definizione Prototipi.
006000170210      //---------------------------------------------------------------
006100170210      /copy gaitrasrc/srcprotopr,TIBS34R
006200170210
006300170210      //---------------------------------------------------------------
006400170210      //?Definizione key-list.
006500170210      //---------------------------------------------------------------
006600170210
006700170210      //---------------------------------------------------------------
006800170210      //?M A I N - L I N E
006900170210      //---------------------------------------------------------------
007000170210     c     *Entry        plist
007100170210     c                   parm                    kpjba
007200170210
007300170210      /free
007400170210
007500170210       //?Operazioni iniziali
007600170210       exsr RoutInz;
007700170210
007800170210       //?Elaborazione
007900170210       exsr Elabora;
008000170210
008100170210       //?Operazioni finali
008200170210       exsr RoutEnd;
008300170210
008400170210       //--------------------------------------------------------------
008500170210       //?Operazioni iniziali.
008600170210       //--------------------------------------------------------------
008700170210       BEGSR RoutInz;
008800170213
008900170213         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
009000170210
009100170210       //?Reperimento dati job
009200170210         exsr DatiJob;
009300170210
009400170210       ENDSR;
009500170210
009600170210       //--------------------------------------------------------------
009700170210       //?Reperimento Dati del job (Utente/Operativi).
009800170210       //--------------------------------------------------------------
009900170210       BEGSR DatiJob;
010000170210
010100170210         in(E) §AzUte;
010200170210         IF  not %error;
010300170210           in(E) §DatiUte;
010400170210         ENDIF;
010500170210         IF  %error or RSut = *blanks;
010600170210           clear TIBS34ds;
010700170210           tibs34r(tibs34ds);
010800170210           in §AzUte;
010900170210           in §DatiUte;
011000170210         ENDIF;
011100170210
011200170210       ENDSR;
011300170210
011400170210       //--------------------------------------------------------------
011500170210       //?Elaborazione.
011600170210       //--------------------------------------------------------------
011700170210       BEGSR Elabora;
011800170313
011900170313         Fine = *off;
012000170210
012100170313         setll tipo WFAUD01L;
012200170313         reade tipo WFAUD01L;
012300170313         DOW  not Fine;
012400170313
012500170313         //?Fine File
012600170313           IF  %eof(WFAUD01L);
012700170313             Fine = *on;
012800170313             leave;
012900170313           ENDIF;
013000170313
013100170313         //?Solo i rcd elaborati
013200170313           IF  WFAppav > 0 and WFAprgv <> WFAprgn and WFAela <> ' ';
013300170313
013400170313           //?Leggo il titav relativo alla nuova tariffa rcd TES
013500170313             wEoF = *off;
013600170313             clear wcta;
013700170313             clear wnoj;
013800170313             setll (WFAksc:WFActrv:WFAprgn:Trd) TITAV01L;
013900170313             reade (WFAksc:WFActrv:WFAprgn:Trd) TITAV01L;
014000170313             DOW  not wEoF;
014100170313               IF  %eof(TITAV01L);
014200170313                 wEoF = *on;
014300170313                 leave;
014400170313               ENDIF;
014500170313               wCta = TAVcta;
014600170313               wNoj = TAVnoj;
014700170313               reade (WFAksc:WFActrv:WFAprgn:Trd) TITAV01L;
014800170313             ENDDO;
014900170313
015000170313             //?Se l'ultimo TITAV della testata è relativo
015100170313             //?ad una tariffa che ho duplicato io
015200170313             //?allora aggiorno
015300170313             IF  wcta = 'D' and wnoj = 'DV-2749';
015400170313               chain (WFAksc:WFActrv:WFAprgn) TNTAM01L;
015500170313               IF  %found(TNTAM01L);
015600170313                 TAMppa = WFAppav;
015700170313                 update TNTAM000;
015800170313                 WFAppan = WFAppav;
015900170313                 WFAela1 = 'S';
016000170313                 update WFAUD000;
016100170313               ENDIF;
016200170313             ENDIF;
016300170313
016400170313           ENDIF;
016500170313
016600170313           reade tipo WFAUD01L;
016700170210
016800170210         ENDDO;
016900170210
017000170210       ENDSR;
017100170210
017200170210       //--------------------------------------------------------------
017300170210       //?Operazioni finali.
017400170210       //--------------------------------------------------------------
017500170210       BEGSR RoutEnd;
017600170210
017700170210         *inLR = *on;
017800170210         return;
017900170210
018000170210       ENDSR;
018100170210
018200170210      /end-free
