000100050622     H DFTACTGRP(*NO) ACTGRP(*CALLER)
000200050622
000300050623     Fcommita01lUF A E           K DISK
000400050623     F                                     COMMIT(prmcommitfile)
000500050623     F                                     PREFIX(a)
000600050623     Fcommitb01lUF A E           K DISK
000700050622     F                                     COMMIT(prmcommitfile)
000800050623     F                                     PREFIX(c)
000900050623     Fcommitb01dCF   E             WORKSTN
001000050623     F                                     SFILE(s01:wrrn)
001100050623     F                                     INFDS(infdspf)
001200050623     F                                     INDDS(inddspf)
001300050623     F                                     PREFIX(s01)
001400050623
001500050623     D F3              C                   X'33'
001600050624     D F8              C                   X'38'
001700050623     D F12             C                   X'3C'
001800050623     D Enter           C                   X'F1'
001900050623     D RecordAlreadyLocked...
002000050623     D                 C                   01218
002100050623
002200050623     D infdspf         DS
002300050623     D  dsp_aid              369    369                                         AID byte
002400050623     D inddspf         DS
002500050623     D  sflclr                 1      1N
002600050622
002700050623     D prmida          S
002800050623     D                                     LIKE(aida)
002900050622     D prmdocommit     S              1
003000050622     D prmesito        S             10I 0
003100050623     D prmtasto        S              1
003200050623     D wrrn            S              5I 0
003300050623     D wimportob       S
003400050623     D                                     LIKE(aimportob)
003500050623
003600050623     ***********************************************************************************************
003700050623     **?
003800050624     **?Definizione chiavi.
003900050623     **?
004000050623     ***********************************************************************************************
004100050623     C     k02commitb01  KLIST
004200050623     C                   KFLD                    prmida
004300050623     C                   KFLD                    s01idb
004400050622
004500050622     ***********************************************************************************************
004600050622     **?
004700050624     **?Definizione parametri in ingresso.
004800050622     **?
004900050622     ***********************************************************************************************
005000050622     C     *ENTRY        PLIST
005100050623     C                   PARM                    prmida
005200050622     C                   PARM                    prmcommitfile
005300050622     C                   PARM                    prmdocommit
005400050622     C                   PARM                    prmesito
005500050623     C                   PARM      dsp_aid       prmtasto
005600050623
005700050623     ***********************************************************************************************
005800050623     **?
005900050624     **?Main.
006000050623     **?
006100050623     ***********************************************************************************************
006200050622
006300050622     C                   CLEAR                   prmesito
006400050623     C                   EXSR      inzs01
006500050624     C                   WRITE     t01
006600050624     C                   WRITE     f01
006700050623
006800050623     C                   DO        *HIVAL
006900050623     C                   EXFMT     c01
007000050623     C                   SELECT
007100050623     C                   WHEN      dsp_aid = F3
007200050623     C                   LEAVE
007300050624     C                   WHEN      dsp_aid = F8
007400050624     C                   LEAVE
007500050623     C                   WHEN      dsp_aid = F12
007600050623     C                   LEAVE
007700050623     C                   WHEN      dsp_aid = Enter
007800050623     C                   EXSR      runs01
007900050623     C                   LEAVE
008000050623     C                   ENDSL
008100050623     C                   ENDDO
008200050622
008300050622     C                   EXSR      uscita
008400050623
008500050623     ***********************************************************************************************
008600050623     **?
008700050623     **?Carico 999 righe del subfile.
008800050623     **?
008900050623     ***********************************************************************************************
009000050623     C     inzs01        BEGSR
009100050623
009200050623     C                   EVAL      sflclr = *ON
009300050623     C                   WRITE     c01
009400050623     C                   EVAL      sflclr = *OFF
009500050623
009600050623     C                   FOR       wrrn = 1 to 999
009700050623     C
009800050623     C                   EVAL      s01idb = wrrn
009900050623     C     k02commitb01  CHAIN(E)  commitb01l
010000050623     C
010100050623     C                   IF        %ERROR
010200050623     C                   IF        %STATUS = RecordAlreadyLocked
010300050623     C*                  Inserire qui la gestione del record allocato.
010400050623     C                   ENDIF
010500050623     C                   EXSR      *PSSR
010600050623     C                   ENDIF
010700050623     C
010800050623     C                   IF        %FOUND
010900050623     C                   EVAL      s01importo = cimporto
011000050623     C                   ELSE
011100050623     C                   CLEAR                   s01importo
011200050623     C                   ENDIF
011300050623     C
011400050623     C                   WRITE     s01
011500050623     C
011600050623     C                   ENDFOR
011700050623
011800050623     C                   ENDSR
011900050623
012000050623     ***********************************************************************************************
012100050623     **?
012200050624     **?Elaborazione subfile con gli importi e aggiornamento del file righe.
012300050623     **?
012400050623     ***********************************************************************************************
012500050623     C     runs01        BEGSR
012600050623
012700050623     C                   CLEAR                   wimportob
012800050623
012900050623     C                   FOR       wrrn = 1 to 999
013000050623     C
013100050623     C     wrrn          CHAIN     s01
013200050623     C
013300050623     C                   IF        %FOUND
013400050623     C
013500050623     C     k02commitb01  CHAIN     commitb01l
013600050623     C
013700050623     C                   IF        %FOUND
013800050623     C                   IF        cimporto <> s01importo
013900050623     C                   EVAL      cimporto = s01importo
014000050623     C                   UPDATE    commitb000
014100050623     C                   ELSE
014200050623     C                   UNLOCK    commitb01l
014300050623     C                   ENDIF
014400050623     C                   ELSE
014500050623     C                   IF        s01importo <> 0
014600050623     C                   EVAL      cida = prmida
014700050623     C                   EVAL      cidb = s01idb
014800050623     C                   EVAL      cimporto = s01importo
014900050623     C                   WRITE     commitb000
015000050623     C                   ENDIF
015100050623     C                   ENDIF
015200050623     C
015300050623     C                   ENDIF
015400050623     C
015500050623     C                   EVAL      wimportob = wimportob + s01importo
015600050623     C
015700050623     C                   ENDFOR
015800050623
015900050623     C                   EXSR      updcommita
016000050623
016100050623     C                   ENDSR
016200050623
016300050623     ***********************************************************************************************
016400050623     **?
016500050624     **?Aggiorno l'importo totale sulla testata e, se richiesto, confermo le modifiche.
016600050623     **?
016700050623     ***********************************************************************************************
016800050623     C     updcommita    BEGSR
016900050623
017000050623     C     prmida        CHAIN(E)  commita01l
017100050623
017200050623     C                   IF        %ERROR
017300050623     C                   IF        %STATUS = RecordAlreadyLocked
017400050623     C*                  Inserire qui la gestione del record allocato.
017500050623     C                   ELSE
017600050623     C                   EXSR      *PSSR
017700050623     C                   ENDIF
017800050623     C                   ENDIF
017900050623
018000050623     C                   EVAL      aimportob = wimportob
018100050623
018200050623     C                   IF        %FOUND(commita01l)
018300050623     C                   UPDATE    commita000
018400050623     C                   ELSE
018500050623     C                   EVAL      aida = prmida
018600050623     C                   WRITE     commita000
018700050623     C                   ENDIF
018800050623
018900050623     C                   IF        prmdocommit = *ON
019000050623     C                   IF        prmesito >= 0
019100050623     C                   COMMIT
019200050623     C                   ELSE
019300050623     C                   ROLBK
019400050623     C                   ENDIF
019500050623     C                   ENDIF
019600050623
019700050623     C                   ENDSR
019800050623
019900050623     ***********************************************************************************************
020000050623     **?
020100050623     **?
020200050623     **?
020300050623     ***********************************************************************************************
020400050623     C     *PSSR         BEGSR
020500050623
020600050624     **?Se qualcosa è andato male e il commit è a carico mio, rimuovo le modifiche.
020700050623     C                   IF        prmdocommit = *ON
020800050623     C                   ROLBK
020900050623     C                   ENDIF
021000050623
021100050623     C                   EVAL      prmesito = %STATUS * -1
021200050623     C                   EXSR      uscita
021300050623
021400050623     C                   ENDSR
021500050622
021600050622     ***********************************************************************************************
021700050622     **?
021800050624     **?Operazioni finali.
021900050622     **?
022000050622     ***********************************************************************************************
022100050622     C     uscita        BEGSR
022200050622
022300050623     C                   EVAL      *INLR = *ON
022400050622     C                   RETURN
022500050622
022600050622     C                   ENDSR
