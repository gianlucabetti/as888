000100090811      //---------------------------------------------------------------
000200090811      //?FIDNS0R - Statistica danni per cliente
000300090811      //---------------------------------------------------------------
000400090811     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000500090811
000600090811      //---------------------------------------------------------------
000700090811      //?Dichiarazione file.
000800090811      //---------------------------------------------------------------
000900090909     ffndct01l  if   e           k disk
001000090811     ffidns0d   cf   e             workstn
001100090811
001200090811      //---------------------------------------------------------------
001300090811      //?Definizione costanti.
001400090811      //---------------------------------------------------------------
001500090811
001600090811      //---------------------------------------------------------------
001700090811      //?Definizione schiere.
001800090811      //---------------------------------------------------------------
001900090811
002000090811      // - Messaggi di errore
002100090811     d $Msg            s             78    dim(10) ctdata perrcd(1)
002200090811
002300090811      //---------------------------------------------------------------
002400090811      //?Definizione aree dati.
002500090811      //---------------------------------------------------------------
002600090811
002700090811      // - Dati utente
002800090811     d §AzUte        e ds                  extname(AZUTE00F)
002900090811     d                                     dtaara
003000090811     d §DatiUte      e ds                  extname(dDatiUte)
003100090811     d                                     dtaara
003200090811
003300090811      //---------------------------------------------------------------
003400090811      //?Definizione strutture dati.
003500090811      //---------------------------------------------------------------
003600090811
003700090811      // - Status
003800090811     d Psds           sds
003900090811     d   SDSpgm          *proc
004000090811
004100090811      // - Controllo data
004200090811     d wlbdat          ds                  inz
004300090811     d  g02dat                 1      8  0
004400090811     d  g02inv                 9     16  0
004500090811     d  g02err                17     17
004600090811     d  g02tgi                18     22  0
004700090811
004800090811      // - Parametri ricevuti
004900090811     d KPJBA         e ds
005000090811
005100090811      // - Reperimento dati utente
005200090811     d TIBS34ds      e ds
005300090811
005400090811      // - Creazione statistica danni
005500090811     d FIDNS1ds      e ds
005600090811
005700090811      //---------------------------------------------------------------
005800090811      //?Definizione variabili globali.
005900090811      //---------------------------------------------------------------
006000090811
006100090811      // - Flags booleani
006200090811     d $Fine           s               n   inz(*off)
006300090811     d $InzD01         s               n   inz(*on)
006400090811
006500090811      // - Campi associati al video
006600090811     d $Video          s              2    inz('D1')
006700090811
006800090811      // - Campi di comodo
006900090909     d wanno           s              4  0
007000090811
007100090811     D wDIP            S                   LIKE(IS1DIP) INZ(*loval)
007200090811     D wDFP            S                   LIKE(IS1DFP) INZ(*hival)
007300090811
007400090811      //---------------------------------------------------------------
007500090811      //?Definizione procedure esterne.
007600090811      //---------------------------------------------------------------
007700090811
007800090811      // - Sottomissione lavoro batch
007900090811     d bch10           pr                  extpgm('BCH10')
008000090811     d  kpjba                              likeds(KPJBA)
008100090811
008200090811      // - Richiamo diretto lavoro batch
008300090811     d fidns1r         pr                  extpgm('FIDNS1R')
008400090811     d  kpjba                              likeds(KPJBA)
008500090811
008600090811      // - Reperimento dati utente
008700090811     d tibs34r         pr                  extpgm('TIBS34R')
008800090811     d  tibs34ds                           likeds(TIBS34ds)
008900090811
009000090811      /copy gaitrasrc/srcprotopr,xsrda8
009100090811
009200090811      //---------------------------------------------------------------
009300090811      //?Riepilogo indicatori.
009400090811      //---------------------------------------------------------------
009500090811
009600090811      // 28    : Emissione messaggio di errore a video
009700090811      // 41    : Data Dal
009800090811      // 42    : Data  Al
009900090811
010000090811      //---------------------------------------------------------------
010100090811      //?M A I N - L I N E
010200090811      //---------------------------------------------------------------
010300090811
010400090811     c     *Entry        plist
010500090811     c                   parm                    KPJBA
010600090811
010700090811      /free
010800090811
010900090811       //?Operazioni iniziali
011000090811       exsr sr_RoutInz;
011100090811
011200090811       //?Gestione video
011300090811       DOW  $Fine = *off;
011400090811         SELECT;
011500090811           WHEN  $Video = 'D1';
011600090811             exsr sr_GesD01;
011700090811           OTHER;
011800090811             $Fine = *on;
011900090811         ENDSL;
012000090811
012100090811       ENDDO;
012200090811
012300090811       //?Operazioni finali
012400090811       exsr sr_RoutEnd;
012500090811
012600090811       //--------------------------------------------------------------
012700090811       //?Operazioni iniziali.
012800090811       //--------------------------------------------------------------
012900090811       BEGSR sr_RoutInz;
013000090811
013100090811         //?Impostazione campi "fissi"
013200090811         T01pgm = SDSpgm;
013300090811
013400090811         //?Reperimento dati job
013500090811         exsr sr_DatiJob;
013600090811
013700090811       ENDSR;
013800090811
013900090811       //--------------------------------------------------------------
014000090811       //?Reperimento Dati del job (Utente/Operativi).
014100090811       //--------------------------------------------------------------
014200090811       BEGSR sr_DatiJob;
014300090811
014400090811         in(E) §AzUte;
014500090811         IF  NOT %error;
014600090811           in(E) §DatiUte;
014700090811         ENDIF;
014800090811         IF  %error or RSut = *blanks;
014900090811           clear TIBS34ds;
015000090811           tibs34r(tibs34ds);
015100090811           in §AzUte;
015200090811           in §DatiUte;
015300090811         ENDIF;
015400090811
015500090811       ENDSR;
015600090811
015700090811
015800090811       //--------------------------------------------------------------
015900090811       //?Gestione videata D01.
016000090811       //--------------------------------------------------------------
016100090811       BEGSR sr_GesD01;
016200090811
016300090811         //?Inizializzazione videata
016400090811         IF  $InzD01 = *on;
016500090811           exsr sr_InzD01;
016600090811           $InzD01 = *off;
016700090811         ENDIF;
016800090811
016900090811         //?Emissione videata
017000090811         write DNS0T01;
017100090811         write DNS0Z01;
017200090811         exfmt DNS0D01;
017300090811         *IN28  = *off;
017400090811         clear V1Cmsg;
017500090811
017600090811         SELECT;
017700090811
017800090811           //?F3=Fine
017900090811           WHEN  *inkc;
018000090811             exsr sr_F03D01;
018100090811
018200090811           //?F6=Elabora
018300090811           WHEN  *inkf;
018400090811             exsr sr_CtrD01;
018500090811             IF  *in28;
018600090811               leavesr;
018700090811             ENDIF;
018800090811             exsr sr_F06D01;
018900090811           //?Enter
019000090811           OTHER;
019100090811             //?- Controllo dati
019200090811             exsr sr_CtrD01;
019300090811             IF  *in28;
019400090811               leavesr;
019500090811             ENDIF;
019600090811
019700090811         ENDSL;
019800090811
019900090811       ENDSR;
020000090811
020100090811       //--------------------------------------------------------------
020200090811       //?Inizializzazione videata D01.
020300090811       //--------------------------------------------------------------
020400090811       BEGSR sr_InzD01;
020500090811
020600090811         clear DNS0D01;
020700090811
020800090811       ENDSR;
020900090811
021000090811       //--------------------------------------------------------------
021100090811       //?Gestione tasto funzionale F3 da videata D01.
021200090811       //?F3=Fine
021300090811       //--------------------------------------------------------------
021400090811       BEGSR sr_F03D01;
021500090811
021600090811         //?Chiusura del programma
021700090811         $Fine = *on;
021800090811
021900090811       ENDSR;
022000090811
022100090811       //--------------------------------------------------------------
022200090811       //?Gestione tasto funzionale F6 da videata D01.
022300090811       //?F6=Elabora
022400090811       //--------------------------------------------------------------
022500090811       BEGSR sr_F06D01;
022600090811
022700090811         clear FIDNS1ds;
022800090811         IS1dip = wDIP;
022900090811         IS1dfp = wDFP;
023000090811         IS1tca = V1Ctca;
023100090811
023200090811         kcoaz = 'DNS1';
023300090811         kpjbu = FIDNS1ds;
023400090811         kbuff = *blank;
023500090811         if  knmus = *all'1';
023600090811           fidns1r(kpjba);
023700090811         else;
023800090811           BCH10(kpjba);
023900090811         endif;
024000090916
024100090916         $Fine = *on;
024200090811
024300090811       ENDSR;
024400090811
024500090811       //--------------------------------------------------------------
024600090811       //?Controllo videata D01.
024700090811       //--------------------------------------------------------------
024800090811       BEGSR sr_CtrD01;
024900090811
025000090811         *in41 = *off;
025100090811         *in42 = *off;
025200090811         reset wDip;
025300090811         reset wDfp;
025400090811
025500090811         //?Controllo data Dal
025600090811         IF  V1cdip = *zeros;
025700090811           *in28 = *on;
025800090811           *in41 = *on;
025900090811           V1Cmsg = $Msg(01);
026000090811           leavesr;
026100090811         ENDIF;
026200090811
026300090811         clear wlbdat;
026400090811         g02dat = V1cdip;
026500090811         IF  V1cdip > 9999;
026600090811           g02dat += 1000000;
026700090811         ELSE;
026800090811           g02dat += 10000;
026900090811         ENDIF;
027000090811
027100090811         xsrda8(wlbdat);
027200090811
027300090811         IF  g02err    = '1';
027400090811           *in28 = *on;
027500090811           *in41 = *on;
027600090811           V1Cmsg = $Msg(01);
027700090811           leavesr;
027800090811         ENDIF;
027900090811
028000090909         V1Cdip = %dec(%subst(%editc(g02dat:'X'):3:6):6:0);
028100090811         wDip   = g02inv / 100;
028200090909
028300090909         //?Errore se nessuna C.A. presente nell'anno richiesto
028400090909         wanno = g02inv / 10000;
028500090909         setll wanno fndct01l;
028600090909         IF  not %equal(fndct01l);
028700090909           *in28 = *on;
028800090909           *in41 = *on;
028900090909           V1Cmsg = $Msg(03);
029000090909           leavesr;
029100090909         ENDIF;
029200090811
029300090811         //?Controllo data Al
029400090811         IF  V1cdfp = *zeros;
029500090909           V1cdfp = V1cdip;
029600090811           wDfp   = wDip;
029700090811           leavesr;
029800090811         ENDIF;
029900090811
030000090811         clear wlbdat;
030100090811         g02dat = V1cdfp;
030200090811         IF  V1cdfp > 9999;
030300090811           g02dat += 1000000;
030400090811         ELSE;
030500090811           g02dat += 10000;
030600090811         ENDIF;
030700090811
030800090811         xsrda8(wlbdat);
030900090811
031000090811         IF  g02err    = '1';
031100090811           *in28 = *on;
031200090811           *in42 = *on;
031300090811           V1Cmsg = $Msg(01);
031400090811           leavesr;
031500090811         ENDIF;
031600090811
031700090909         V1Cdfp = %dec(%subst(%editc(g02dat:'X'):3:6):6:0);
031800090811         wDfp   = g02inv / 100;
031900090811
032000090811         //?Controllo data Dal > data Al
032100090811         IF wDip > wDfp;
032200090811           *in28 = *on;
032300090811           *in41 = *on;
032400090811           *in42 = *on;
032500090811           V1Cmsg = $Msg(02);
032600090811           leavesr;
032700090811         ENDIF;
032800090811
032900090811       ENDSR;
033000090811
033100090811       //--------------------------------------------------------------
033200090811       //?Operazioni finali.
033300090811       //--------------------------------------------------------------
033400090811       BEGSR sr_RoutEnd;
033500090811
033600090811         *inLR = *on;
033700090811         return;
033800090811
033900090811       ENDSR;
034000090811
034100090811      /end-free
034200090811
034300090811       //--------------------------------------------------------------
034400090811       //?Schiere a tempo di compilazione.
034500090811       //--------------------------------------------------------------
034600090811
034700090811** - $MSG -------------------------------------------------------------------*
034800020311Mese/Anno errati                                                              01
034900020313Il Mese/Anno iniziale non puo' essere maggiore del Mese/Anno finale           02
035000090909C.A. non presenti nel periodo iniziale richiesto                              03
