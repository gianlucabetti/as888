000100131007       //==============================================================
000200131007       //
000300140318       //?FIOR01R - Recupera ora presunta ritiro da PDA
000400131007       //
000500131007       //==============================================================
000600140318     h DECEDIT('0,') DATEDIT(*YMD.) option(*nodebugio)
000700160429     h dftactgrp(*no) actgrp(*caller)
000800160429     h bnddir('UBRTVNETA')
000900131009
001000131009       //--------------------------------------------------------------
001100131009       //?Dichiarazione file.                                          ?
001200131009       //--------------------------------------------------------------
001300140318
001400140318       // -?File distinte
001500160429     fFIDST01L  if   e           k disk    usropn extfile(wFLib)
001600131010
001700140318       // -?File ritorno dati da PDA
001800140318     fFIPRO11L  if   e           k disk
001900131008
002000131007       //--------------------------------------------------------------
002100131007       //?Definizione costanti.                                        ?
002200131007       //--------------------------------------------------------------
002300131008
002400131007       //--------------------------------------------------------------
002500131007       //?Definizione strutture dati.                                  ?
002600131007       //--------------------------------------------------------------
002700140318       // -?Parametri
002800140318     d FIOR01DS      e ds                  QUALIFIED
002900140318
003000140318       // -?Ds per campo dati FIPRO10F
003100140318     d FIPRORORDS    e ds
003200131009
003300131009       //--------------------------------------------------------------
003400131009       //?Definizione schiere.
003500131009       //--------------------------------------------------------------
003600131007
003700131007       //--------------------------------------------------------------
003800131007       //?Definizione campi.
003900131007       //--------------------------------------------------------------
004000160429       // - Campi di comodo
004100160429     d wFlib           s             21a   inz
004200160429     d wlib            s             10a   inz
004300160429
004400160429       // -?Nome del sistema?
004500160429     d currSysNeta     s              8a   inz
004600131008
004700131008       //--------------------------------------------------------------
004800131008       //?Definizione procedure.
004900131008       //--------------------------------------------------------------
005000131008
005100131008       //--------------------------------------------------------------
005200131008       //?Definizione prototipi.
005300131008       //--------------------------------------------------------------
005400160429       // -?Reperimento NETA sistema AS/400 corrente?
005500160429      /copy gaitrasrc/srcProtoPR,UBRTVNETA
005600140318
005700140318       //---------------------------------------------------------------
005800140318       //?Definizione key-list.
005900140318       //---------------------------------------------------------------
006000140318       // -?File FIDST01L
006100140318     d k03fidst      e ds                  extname(FIDST01L:*key)
006200140318     d                                     prefix(k_)
006300140318     d                                     inz
006400140318
006500140318       // -?File FIPRO11L
006600140318     d k08fipro      e ds                  extname(FIPRO11L:*key)
006700140318     d                                     prefix(k_)
006800140318     d                                     inz
006900131007
007000131007       //--------------------------------------------------------------
007100131007       //?MAIN.
007200131007       //--------------------------------------------------------------
007300140318     c     *entry        plist
007400140318     c                   parm                    FIOR01DS
007500131008
007600131007      /free
007700131008
007800131008       //?Operazioni iniziali
007900131008       exsr RoutInz;
008000140318
008100140318       //?Controllo i dati passati
008200140318       exsr Controlla;
008300131008
008400140318       //?Elabora
008500140318       exsr Elabora;
008600131010
008700131010       //?Operazioni finali
008800131010       exsr RoutEnd;
008900131008
009000131008       //--------------------------------------------------------------
009100131008       //?Operazioni iniziali.                                         ?
009200131008       //--------------------------------------------------------------
009300131008       BEGSR  RoutInz;
009400131009
009500140318       //?Pulisco dati di output
009600140318         clear fior01ds.OOR01ora;
009700140318         fior01ds.OOR01err = '0';
009800140318         clear fior01ds.OOR01msg;
009900140318
010000131008         *inLR = *on;
010100160429
010200160429       //?Apro file Distinte
010300160429         IF  %open(FIDST01L);
010400160429           leavesr;
010500160429         ENDIF;
010600160429
010700160429       //?Cerco il nome del sistema
010800160429         UBRTVNETA_Rtv(currSysNeta);
010900160429         IF  %subst(currSysNetA:1:5 ) = 'AS888';
011000160429           wLib = 'FILTRAPRD';
011100160429         ELSE;
011200160429           wLib = 'FILTRA201';
011300160429         ENDIF;
011400160429
011500160429       //?Apro file Distinte
011600160429         wFLib = %trim(wLib) + '/FIDST01L';
011700160429         open  FIDST01L;
011800131008
011900131008       ENDSR;
012000140318
012100140318       //--------------------------------------------------------------
012200140318       //?Controlla i dati passati.                                    ?
012300140318       //--------------------------------------------------------------
012400140318       BEGSR  Controlla;
012500140318
012600140318         IF  fior01ds.IOR01fgs = 0 or fior01ds.IOR01ndc = 0;
012700140318           fior01ds.OOR01err = '1';
012800140318           fior01ds.OOR01msg = 'Passare la distinta';
012900140318           exsr RoutEnd;
013000140318         ENDIF;
013100140318
013200140318         IF  fior01ds.IOR01poe = 0 or fior01ds.IOR01nor = 0;
013300140318           fior01ds.OOR01err = '1';
013400140318           fior01ds.OOR01msg = 'Passare la chiave ORM';
013500140318           exsr RoutEnd;
013600140318         ENDIF;
013700140318
013800140318       ENDSR;
013900131007
014000131007       //--------------------------------------------------------------
014100140318       //?Elabora.
014200131007       //--------------------------------------------------------------
014300140318       BEGSR  Elabora;
014400140318
014500140318       //?Come prima cosa recupero il codice AUT
014600140318         k_DSTnpg = 4;
014700140318         k_DSTnfv = fior01ds.IOR01ndc;
014800140318         k_DSTfgs = fior01ds.IOR01fgs;
014900140318         chain %kds(k03fidst) FIDST01L;
015000140318         IF  not %found(FIDST01L);
015100140318           fior01ds.OOR01err = '1';
015200140318           fior01ds.OOR01msg = 'Distinta errata';
015300140318           exsr RoutEnd;
015400140318         ENDIF;
015500140318
015600140318       //?Recupero l'ora presunta del ritiro impostata sul PDA
015700140318         clear fiprorords;
015800140318         k_PROfgs = fior01ds.IOR01fgs;
015900140318         k_PROndc = fior01ds.IOR01ndc;
016000140318         k_PROtrd = 'ROR';
016100140318         k_PROcodaut = DSTpdr;
016200140318         k_PROpoe = fior01ds.IOR01poe;
016300140318         k_PROnsr = fior01ds.IOR01nsr;
016400140318         k_PROnor = fior01ds.IOR01nor;
016500140318         k_PROnrv = fior01ds.IOR01nrv;
016600140318         chain %kds(k08fipro) FIPRO11L;
016700140318         IF  %found(FIPRO11L);
016800140318           fiprorords = PROdati;
016900140318         ENDIF;
017000140318         fior01ds.OOR01ora = §PROorasti;
017100131007
017200131007       ENDSR;
017300131010
017400131010       //--------------------------------------------------------------
017500131010       //?Operazioni finali.
017600131010       //--------------------------------------------------------------
017700131010       BEGSR  RoutEnd;
017800131010
017900131010         return;
018000131010
018100131010       ENDSR;
018200131009
018300131007      /end-free
