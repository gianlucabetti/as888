000100080206      //--------------------------------------------------------------
000200130516      //?FIOR46R1 - Statistica ORM manuali - crea file work
000300080206      //--------------------------------------------------------------
000400130830
000500130830       //--------------------------------------------------------------
000600130830       //?Specifiche di controllo.                                     ?
000700130830       //--------------------------------------------------------------
000800080206
000900090407     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001000080206
001100080206      //---------------------------------------------------------------
001200080206      //?Dichiarazione file.
001300080206      //---------------------------------------------------------------
001400130830     fAZCMM01L  if   e           k disk
001500130516     fWFROM10F  o    e             disk
001600100310
001700080206      //---------------------------------------------------------------
001800090406      //?Definizione costanti.
001900080206      //---------------------------------------------------------------
002000080206
002100080206      //---------------------------------------------------------------
002200080206      //?Definizione schiere.
002300080206      //---------------------------------------------------------------
002400100325
002500130516      // - Filiali
002600130516     d wSKfil          s              3  0 dim(250)
002700080206
002800080206      //---------------------------------------------------------------
002900080206      //?Definizione aree dati.
003000080206      //---------------------------------------------------------------
003100080206
003200080206      // - Dati utente
003300080206     d §AzUte        e ds                  extname(AZUTE00F)
003400080206     d                                     dtaara
003500080206     d §DatiUte      e ds                  extname(dDatiUte)
003600080206     d                                     dtaara
003700080206
003800080206      //---------------------------------------------------------------
003900080206      //?Definizione strutture dati.
004000080206      //---------------------------------------------------------------
004100080206
004200080206      // - Parametri ricevuti
004300080206     d KPJBA         e ds
004400130516     d FIOR44DS      e ds
004500100308
004600080206      // - Reperimento dati utente
004700100305     d TIBS34DS      e ds
004800130517
004900130517       // - Reperimento dati anagrafici
005000130517     d TIBS69ds      e ds
005100130517     d DS_cnaco      e ds                  inz extname(CNACO00F)
005200130517     d DS_cnind      e ds                  inz extname(CNIND00F)
005300130517     d DS_cnclp      e ds                  inz extname(CNCLP00F)
005400130517     d DS_fncls      e ds                  inz extname(FNCLS00F)
005500100325
005600130516      // - Carico Filiali
005700130516     d TRUL26DS      e ds
005800130516     d skpo                   11    760  0 dim(250)
005900130517     d skpot                 761   1510  0 dim(250)
006000130517
006100130517      // File ORM
006200130517     d FNORM00F      e ds                  extname(FNORM00F)
006300130517
006400130531
006500130531     d ds_rigacli      ds
006600130531     d wCOD                          10  0
006700130531     d wRAG                          35
006800130531     d wIND                          35
006900130531     d wCAP                           9
007000130531     d wLOC                          35
007100130531     d wPRV                           2
007200130531     d wNAZ                           3
007300130531
007400130531     d ds_savcli       ds
007500130531     d savCOD                        10  0
007600130531     d savRAG                        35
007700130531     d savIND                        35
007800130531     d savCAP                         9
007900130531     d savLOC                        35
008000130531     d savPRV                         2
008100130531     d savNAZ          s              3
008200090629
008300080206      //---------------------------------------------------------------
008400080206      //?Definizione variabili globali.
008500080206      //---------------------------------------------------------------
008600080206
008700080206      // - Flags booleani
008800130517     d wEnd            s               n   inz(*off)
008900130522     d wNOokrcd        s               n   inz(*off)
009000100325
009100100325      // - Indici di schiera
009200100326     d xx              s              4  0 inz
009300100326     d yy              s              4  0 inz
009400080206
009500090806       // - Stringa SQL da eseguire
009600090806     d wSQL            s           2048    Varying        inz
009700100305
009800100305      // - Campi di comodo
009900130517     d savAGE          s                   like(CLPage)
010000100325
010100090508      //---------------------------------------------------------------
010200090807      //?Definizione procedure esterne.
010300090508      //---------------------------------------------------------------
010400130517
010500130517      // - Filiali da elaborare
010600130517     d trul26r         pr                  extpgm('TRUL26R')
010700130517     d  trul26ds                           likeds(trul26ds)
010800100120
010900100120      //---------------------------------------------------------------
011000100120      //?prototipi
011100100120      //---------------------------------------------------------------
011200090807
011300080626      /copy gaitrasrc/srcprotopr,tibs34r
011400130517      /copy gaitrasrc/srcprotopr,tibs69r
011500090807
011600080206      //---------------------------------------------------------------
011700080206      //?Definizione key-list.
011800080206      //---------------------------------------------------------------
011900130517
012000080206
012100080206      //---------------------------------------------------------------
012200080206      //?Riepilogo indicatori.
012300080206      //---------------------------------------------------------------
012400090807
012500080206      //---------------------------------------------------------------
012600080206
012700080206      //---------------------------------------------------------------
012800080206      //?M A I N - L I N E
012900080206      //---------------------------------------------------------------
013000080206
013100080206     c     *Entry        plist
013200080206     c                   parm                    KPJBA
013300080206
013400080206      /free
013500080206
013600090807       //?Operazioni iniziali
013700080206       exsr RoutInz;
013800100524
013900130517       //?Elaboro
014000130517       exsr Elabora;
014100080206
014200090807       //?Operazioni finali
014300080206       exsr RoutEnd;
014400080206
014500080206       //--------------------------------------------------------------
014600080206       //?Operazioni iniziali.
014700080206       //--------------------------------------------------------------
014800080206       BEGSR RoutInz;
014900100329
015000100709       //?Imposto la ds con i dati della KPJBU
015100130516         FIOR44ds = kpjbu;
015200090807
015300100709       //?Reperimento dati job
015400090807         exsr DatiJob;
015500090807
015600090807         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
015700100325
015800130516       //?Carico in sk le filiali da elaborare
015900130516         clear wSKfil;
016000130516         IF  I44poel <> 999;
016100130516           wSKfil(01) = I44poel;
016200130516           leavesr;
016300100325         ENDIF;
016400130516
016500130516         exsr carFIL;
016600090714
016700080206       ENDSR;
016800100524
016900100326       //--------------------------------------------------------------
017000130516       //?Carico SK Filiali.
017100100326       //--------------------------------------------------------------
017200130516       BEGSR carFIL;
017300100326
017400100326         clear xx;
017500130516         clear wSKfil;
017600100326
017700130516         clear TRUL26DS;
017800130516         I26tpt = 'P';
017900130516         I26tla = 'L';
018000130516         trul26r (TRUL26DS);
018100130516
018200130516       //?Carico solo le filiali che hanno come terminal di partenza = SIMFEL
018300130516         xx = 1;
018400130516         clear yy;
018500130516         FOR xx by 1 to %elem(skpo);
018600130517           IF skpo(xx) <> *zeros and skpot(xx) = simfel;
018700130516             yy += 1;
018800130516             wSKfil(yy) = skpo(xx);
018900130516           ENDIF;
019000130516         ENDFOR;
019100130516
019200100326       ENDSR;
019300100709
019400100709       //--------------------------------------------------------------
019500130516       //?Elaboro.
019600100709       //--------------------------------------------------------------
019700130516       BEGSR Elabora;
019800100526
019900130516         wEnd = *off;
020000100526
020100100709       //?Imposto la stringa per SQL
020200130516         exsr PrepSQL;
020300100708
020400100709       //?Dichiarazione cursore
020500100708         exec sql
020600100708           prepare S1   from :wSQL;
020700100708         exec sql
020800130517           declare ORM  cursor for S1;
020900100526
021000100709       //?Apertura del cursore
021100100526         exec sql
021200130517           open ORM;
021300100526
021400100526         IF sqlcode < 0;
021500130517           wEnd = *on;
021600100526         ENDIF;
021700130517
021800130517         clear WFROM100;
021900100526
022000130517         DOW not wEnd;
022100100526           exec sql
022200130517             fetch next from ORM into :fnorm00f;
022300100526           IF sqlcod = 100 or sqlcod < 0;
022400130517             wEnd = *on;
022500100526             leave;
022600100526           ENDIF;
022700130522
022800130522       //?Controllo se OK il rcd
022900130522           exsr CtrRcd;
023000130522           IF  wNOokrcd;
023100130522             iter;
023200130522           ENDIF;
023300130522
023400130523       //?Carico i dati
023500130523           SELECT;
023600130531             WHEN  I44sel = 'M';
023700130531               wCOD = ORMcra;
023800130522               wRAG = ORMrsr;
023900130523               wIND = ORMinr;
024000130523               wCAP = ORMcar;
024100130523               wLOC = ORMlor;
024200130523               wPRV = ORMprr;
024300130523               wNAZ = ORMnar;
024400130531             WHEN  I44sel = 'O';
024500130531               wCOD = ORMcor;
024600130522               wRAG = ORMrso;
024700130523               wIND = ORMino;
024800130523               wCAP = ORMcao;
024900130523               wLOC = ORMloo;
025000130523               wPRV = ORMpro;
025100130523               wNAZ = ORMnao;
025200130531           ENDSL;
025300130531
025400130531           exsr CarDati;
025500100526
025600100526         ENDDO;
025700100526
025800100526         exec sql
025900130517           close ORM;
026000130521
026100130521       //?Carico i dati nel file di work
026200130521       //?ultimo cliente
026300130531         IF  ROM1orm >= I44ORM;
026400130531           exsr Scrivi;
026500130531         ENDIF;
026600100526
026700100526       ENDSR;
026800100525
026900100525       //--------------------------------------------------------------
027000100525       //?Preparazione stringa SQL.
027100100525       //--------------------------------------------------------------
027200130517       BEGSR PrepSQL;
027300130517
027400130517       //?Seleziono gli ORM
027500130517         wSQL = 'select * from FNORM00F +
027600141215                 where ORMtco in(''M'', ''E'') +
027700141215                   and ORMpoe in(';
027800130517         yy = 0;
027900130517         xx = 1;
028000130517         FOR xx by 1 to %elem(wSKfil);
028100130517           IF wSKfil(xx) <> *zeros;
028200130517             IF yy > 0;
028300130517               wSQL += ', ';
028400130517             ELSE;
028500130517               yy = 1;
028600130517             ENDIF;
028700130517             wSQL += %editc(wSKfil(xx):'X');
028800130517           ENDIF;
028900130517         ENDFOR;
029000130517
029100130517         wSQL += ') and ORMdao between ' + %editc(I44dtda:'X') +
029200130517                   ' and ' + %editc(I44dtal:'X');
029300130517
029400130522         IF  I44sel = 'M';
029500130531           wSQL += ' ORDER BY ORMrsr, ORMcra, ORMinr, ORMcar, ORMlor,';
029600130531           wSQL += ' ORMprr, ORMnar';
029700130517         ENDIF;
029800130517
029900130522         IF  I44sel = 'O';
030000130531           wSQL += ' ORDER BY ORMrso, ORMcor , ORMino, ORMcao, ORMloo,';
030100130531           wSQL += ' ORMpro, ORMnao';
030200130517         ENDIF;
030300100525
030400100525       ENDSR;
030500130522
030600130522       //--------------------------------------------------------------
030700130522       //?Carico i dati nel file di work.
030800130522       //--------------------------------------------------------------
030900130522       BEGSR CtrRcd;
031000130522
031100130522         wNOokrcd = *off;
031200130522
031300130522       //?Controllo se il rcd è ok per la statistica
031400130522
031500130522         SELECT;
031600130522           WHEN  I44sel = 'M' and I44cod = 'S' and ORMcra = 0;
031700130522             wNOokrcd = *on;
031800130522           WHEN  I44sel = 'O' and I44cod = 'S' and ORMcor = 0;
031900130522             wNOokrcd = *on;
032000130522           WHEN  I44sel = 'O' and I44cod = *blanks and
032100130522                 ORMcor = 0 and ORMrso = *blanks;
032200130522             wNOokrcd = *on;
032300130522         ENDSL;
032400130522
032500130522       ENDSR;
032600130522
032700130522       //--------------------------------------------------------------
032800130531       //?Carico i dati nel file di work.
032900130522       //--------------------------------------------------------------
033000130531       BEGSR CarDati;
033100130522
033200130531       //?Scrivo a cambio cliente
033300130531         IF  ds_rigacli <> ds_savcli;
033400130522
033500130531           IF  savRAG <> *blanks and ROM1orm >= I44orm;
033600130522             exsr Scrivi;
033700130522           ENDIF;
033800130531
033900130531           clear  WFROM100;
034000130522
034100130531           savCOD = wCOD;
034200130523           savRAG = wRAG;
034300130523           savIND = wIND;
034400130523           savCAP = wCAP;
034500130523           savLOC = wLOC;
034600130523           savPRV = wPRV;
034700130523           savNAZ = wNAZ;
034800130531
034900130531           IF  wCOD > 0;
035000130531             exsr cercaCMM;
035100130531           ELSE;
035200130531             savAGE = 9999999;
035300130531           ENDIF;
035400130522         ENDIF;
035500130522
035600130522         //?ORM immessi
035700130522         ROM1orm += 1;
035800141217
035900141217         //?ORM immessi di cui mail
036000141217         IF  ORMtco = 'E';
036100141217           ROM1ormm += 1;
036200141217         ENDIF;
036300130531
036400130522         //?ORM immessi NON codificati
036500130531         IF  savCOD = 0;
036600130531           ROM1ormn += 1;
036700141217         //?di cui mail
036800141217           IF  ORMtco = 'E';
036900141217             ROM1ormnm += 1;
037000141217           ENDIF;
037100130531         ELSE;
037200130531         //?ORM immessi codificati
037300130531           ROM1ormc += 1;
037400141217         //?di cui mail
037500141217           IF  ORMtco = 'E';
037600141217             ROM1ormcm += 1;
037700141217           ENDIF;
037800130531         ENDIF;
037900130531
038000130531         //?Conto se ORM di mia competenza
038100130531         IF  ORMpoe = ORMpor;
038200130531           ROM1corm += 1;
038300130531           IF  savCOD = 0;
038400130531             ROM1cormn += 1;
038500130531           ELSE;
038600130531             ROM1cormc += 1;
038700130531           ENDIF;
038800130522         ENDIF;
038900100709
039000100709       ENDSR;
039100130517
039200130517       //--------------------------------------------------------------
039300130517       //?Cerco il codice commerciale.
039400130517       //--------------------------------------------------------------
039500130517       BEGSR CercaCMM;
039600130517
039700130517       //?Cerco il commerciale
039800130517           clear tibs69ds;
039900130517           I69kcp = %dec(%subst(%editc(savCOD:'X'):1:7):7:0);
040000130517           tibs69r (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
040100130517           IF  O69err <> *blanks;
040200130517             clear CLPage;
040300130517           ENDIF;
040400130517
040500130517       //?Cerco Unificante
040600130830           chain  (CLPage)  AZCMM000;
040700130830           IF  NOT %found( AZCMM01L );
040800130830             clear  CMMuni;
040900130517           ENDIF;
041000130830           savAGE = CMMuni;
041100130517
041200130517       ENDSR;
041300130517
041400130517       //--------------------------------------------------------------
041500130517       //?Scrivo file di WORK.
041600130517       //--------------------------------------------------------------
041700130517       BEGSR Scrivi;
041800130517
041900130517       //?Imposto i campi del file
042000130517         ROM1cmm = savAGE;
042100130517         ROM1cod = savCOD;
042200130523         ROM1rag = savRAG;
042300130523         ROM1ind = savIND;
042400130523         ROM1cap = savCAP;
042500130523         ROM1loc = savLOC;
042600130523         ROM1prv = savPRV;
042700130523         ROM1naz = savNAZ;
042800130517
042900130517         write  WFROM100;
043000130517
043100130517       ENDSR;
043200080206
043300080206       //--------------------------------------------------------------
043400080206       //?Reperimento Dati del job (Utente/Operativi).
043500080206       //--------------------------------------------------------------
043600080206       BEGSR DatiJob;
043700080206
043800080206         in(E) §AzUte;
043900080206         if NOT %error;
044000080206           in(E) §DatiUte;
044100080206         endif;
044200080206         if %error or RSut = *blanks;
044300080206           clear TIBS34ds;
044400080206           tibs34r(tibs34ds);
044500080206           in §AzUte;
044600080206           in §DatiUte;
044700080206         endif;
044800080206
044900080206       ENDSR;
045000100326
045100080206       //--------------------------------------------------------------
045200080206       //?Operazioni finali.
045300080206       //--------------------------------------------------------------
045400080206       BEGSR RoutEnd;
045500090521
045600080206         *inLR = *on;
045700080206         return;
045800080206
045900080206       ENDSR;
046000080206
046100080206      /end-free
