000100080206      //--------------------------------------------------------------
000200130516      //?FIOR46R1 - Statistica ORM manuali - crea file work
000300080206      //--------------------------------------------------------------
000400130830
000500130830       //--------------------------------------------------------------
000600130830       //?Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700130830       //--------------------------------------------------------------
000800130830
000900130830     /*END
001000130830
001100130830       //--------------------------------------------------------------
001200130830       //?Specifiche di controllo.                                     ?
001300130830       //--------------------------------------------------------------
001400080206
001500090407     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001600080206
001700080206      //---------------------------------------------------------------
001800080206      //?Dichiarazione file.
001900080206      //---------------------------------------------------------------
002000130830     fAZCMM01L  if   e           k disk
002100130516     fWFROM10F  o    e             disk
002200100310
002300080206      //---------------------------------------------------------------
002400090406      //?Definizione costanti.
002500080206      //---------------------------------------------------------------
002600080206
002700080206      //---------------------------------------------------------------
002800080206      //?Definizione schiere.
002900080206      //---------------------------------------------------------------
003000100325
003100130516      // - Filiali
003200130516     d wSKfil          s              3  0 dim(250)
003300080206
003400080206      //---------------------------------------------------------------
003500080206      //?Definizione aree dati.
003600080206      //---------------------------------------------------------------
003700080206
003800080206      // - Dati utente
003900080206     d §AzUte        e ds                  extname(AZUTE00F)
004000080206     d                                     dtaara
004100080206     d §DatiUte      e ds                  extname(dDatiUte)
004200080206     d                                     dtaara
004300080206
004400080206      //---------------------------------------------------------------
004500080206      //?Definizione strutture dati.
004600080206      //---------------------------------------------------------------
004700080206
004800080206      // - Parametri ricevuti
004900080206     d KPJBA         e ds
005000130516     d FIOR44DS      e ds
005100100308
005200080206      // - Reperimento dati utente
005300100305     d TIBS34DS      e ds
005400130517
005500130517       // - Reperimento dati anagrafici
005600130517     d TIBS69ds      e ds
005700130517     d DS_cnaco      e ds                  inz extname(CNACO00F)
005800130517     d DS_cnind      e ds                  inz extname(CNIND00F)
005900130517     d DS_cnclp      e ds                  inz extname(CNCLP00F)
006000130517     d DS_fncls      e ds                  inz extname(FNCLS00F)
006100100325
006200130516      // - Carico Filiali
006300130516     d TRUL26DS      e ds
006400130516     d skpo                   11    760  0 dim(250)
006500130517     d skpot                 761   1510  0 dim(250)
006600130517
006700130517      // File ORM
006800130517     d FNORM00F      e ds                  extname(FNORM00F)
006900130517
007000130531
007100130531     d ds_rigacli      ds
007200130531     d wCOD                          10  0
007300130531     d wRAG                          35
007400130531     d wIND                          35
007500130531     d wCAP                           9
007600130531     d wLOC                          35
007700130531     d wPRV                           2
007800130531     d wNAZ                           3
007900130531
008000130531     d ds_savcli       ds
008100130531     d savCOD                        10  0
008200130531     d savRAG                        35
008300130531     d savIND                        35
008400130531     d savCAP                         9
008500130531     d savLOC                        35
008600130531     d savPRV                         2
008700130531     d savNAZ          s              3
008800090629
008900080206      //---------------------------------------------------------------
009000080206      //?Definizione variabili globali.
009100080206      //---------------------------------------------------------------
009200080206
009300080206      // - Flags booleani
009400130517     d wEnd            s               n   inz(*off)
009500130522     d wNOokrcd        s               n   inz(*off)
009600100325
009700100325      // - Indici di schiera
009800100326     d xx              s              4  0 inz
009900100326     d yy              s              4  0 inz
010000080206
010100090806       // - Stringa SQL da eseguire
010200090806     d wSQL            s           2048    Varying        inz
010300100305
010400100305      // - Campi di comodo
010500130517     d savAGE          s                   like(CLPage)
010600100325
010700090508      //---------------------------------------------------------------
010800090807      //?Definizione procedure esterne.
010900090508      //---------------------------------------------------------------
011000130517
011100130517      // - Filiali da elaborare
011200130517     d trul26r         pr                  extpgm('TRUL26R')
011300130517     d  trul26ds                           likeds(trul26ds)
011400100120
011500100120      //---------------------------------------------------------------
011600100120      //?prototipi
011700100120      //---------------------------------------------------------------
011800090807
011900080626      /copy gaitrasrc/srcprotopr,tibs34r
012000130517      /copy gaitrasrc/srcprotopr,tibs69r
012100090807
012200080206      //---------------------------------------------------------------
012300080206      //?Definizione key-list.
012400080206      //---------------------------------------------------------------
012500130517
012600080206
012700080206      //---------------------------------------------------------------
012800080206      //?Riepilogo indicatori.
012900080206      //---------------------------------------------------------------
013000090807
013100080206      //---------------------------------------------------------------
013200080206
013300080206      //---------------------------------------------------------------
013400080206      //?M A I N - L I N E
013500080206      //---------------------------------------------------------------
013600080206
013700080206     c     *Entry        plist
013800080206     c                   parm                    KPJBA
013900080206
014000080206      /free
014100080206
014200090807       //?Operazioni iniziali
014300080206       exsr RoutInz;
014400100524
014500130517       //?Elaboro
014600130517       exsr Elabora;
014700080206
014800090807       //?Operazioni finali
014900080206       exsr RoutEnd;
015000080206
015100080206       //--------------------------------------------------------------
015200080206       //?Operazioni iniziali.
015300080206       //--------------------------------------------------------------
015400080206       BEGSR RoutInz;
015500100329
015600100709       //?Imposto la ds con i dati della KPJBU
015700130516         FIOR44ds = kpjbu;
015800090807
015900100709       //?Reperimento dati job
016000090807         exsr DatiJob;
016100090807
016200090807         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
016300100325
016400130516       //?Carico in sk le filiali da elaborare
016500130516         clear wSKfil;
016600130516         IF  I44poel <> 999;
016700130516           wSKfil(01) = I44poel;
016800130516           leavesr;
016900100325         ENDIF;
017000130516
017100130516         exsr carFIL;
017200090714
017300080206       ENDSR;
017400100524
017500100326       //--------------------------------------------------------------
017600130516       //?Carico SK Filiali.
017700100326       //--------------------------------------------------------------
017800130516       BEGSR carFIL;
017900100326
018000100326         clear xx;
018100130516         clear wSKfil;
018200100326
018300130516         clear TRUL26DS;
018400130516         I26tpt = 'P';
018500130516         I26tla = 'L';
018600130516         trul26r (TRUL26DS);
018700130516
018800130516       //?Carico solo le filiali che hanno come terminal di partenza = SIMFEL
018900130516         xx = 1;
019000130516         clear yy;
019100130516         FOR xx by 1 to %elem(skpo);
019200130517           IF skpo(xx) <> *zeros and skpot(xx) = simfel;
019300130516             yy += 1;
019400130516             wSKfil(yy) = skpo(xx);
019500130516           ENDIF;
019600130516         ENDFOR;
019700130516
019800100326       ENDSR;
019900100709
020000100709       //--------------------------------------------------------------
020100130516       //?Elaboro.
020200100709       //--------------------------------------------------------------
020300130516       BEGSR Elabora;
020400100526
020500130516         wEnd = *off;
020600100526
020700100709       //?Imposto la stringa per SQL
020800130516         exsr PrepSQL;
020900100708
021000100709       //?Dichiarazione cursore
021100100708         exec sql
021200100708           prepare S1   from :wSQL;
021300100708         exec sql
021400130517           declare ORM  cursor for S1;
021500100526
021600100709       //?Apertura del cursore
021700100526         exec sql
021800130517           open ORM;
021900100526
022000100526         IF sqlcode < 0;
022100130517           wEnd = *on;
022200100526         ENDIF;
022300130517
022400130517         clear WFROM100;
022500100526
022600130517         DOW not wEnd;
022700100526           exec sql
022800130517             fetch next from ORM into :fnorm00f;
022900100526           IF sqlcod = 100 or sqlcod < 0;
023000130517             wEnd = *on;
023100100526             leave;
023200100526           ENDIF;
023300130522
023400130522       //?Controllo se OK il rcd
023500130522           exsr CtrRcd;
023600130522           IF  wNOokrcd;
023700130522             iter;
023800130522           ENDIF;
023900130522
024000130523       //?Carico i dati
024100130523           SELECT;
024200130531             WHEN  I44sel = 'M';
024300130531               wCOD = ORMcra;
024400130522               wRAG = ORMrsr;
024500130523               wIND = ORMinr;
024600130523               wCAP = ORMcar;
024700130523               wLOC = ORMlor;
024800130523               wPRV = ORMprr;
024900130523               wNAZ = ORMnar;
025000130531             WHEN  I44sel = 'O';
025100130531               wCOD = ORMcor;
025200130522               wRAG = ORMrso;
025300130523               wIND = ORMino;
025400130523               wCAP = ORMcao;
025500130523               wLOC = ORMloo;
025600130523               wPRV = ORMpro;
025700130523               wNAZ = ORMnao;
025800130531           ENDSL;
025900130531
026000130531           exsr CarDati;
026100100526
026200100526         ENDDO;
026300100526
026400100526         exec sql
026500130517           close ORM;
026600130521
026700130521       //?Carico i dati nel file di work
026800130521       //?ultimo cliente
026900130531         IF  ROM1orm >= I44ORM;
027000130531           exsr Scrivi;
027100130531         ENDIF;
027200100526
027300100526       ENDSR;
027400100525
027500100525       //--------------------------------------------------------------
027600100525       //?Preparazione stringa SQL.
027700100525       //--------------------------------------------------------------
027800130517       BEGSR PrepSQL;
027900130517
028000130517       //?Seleziono gli ORM
028100130517         wSQL = 'select * from FNORM00F +
028200130517                 where ORMtco = ''M'' and ORMpoe in(';
028300130517         yy = 0;
028400130517         xx = 1;
028500130517         FOR xx by 1 to %elem(wSKfil);
028600130517           IF wSKfil(xx) <> *zeros;
028700130517             IF yy > 0;
028800130517               wSQL += ', ';
028900130517             ELSE;
029000130517               yy = 1;
029100130517             ENDIF;
029200130517             wSQL += %editc(wSKfil(xx):'X');
029300130517           ENDIF;
029400130517         ENDFOR;
029500130517
029600130517         wSQL += ') and ORMdao between ' + %editc(I44dtda:'X') +
029700130517                   ' and ' + %editc(I44dtal:'X');
029800130517
029900130522         IF  I44sel = 'M';
030000130531           wSQL += ' ORDER BY ORMrsr, ORMcra, ORMinr, ORMcar, ORMlor,';
030100130531           wSQL += ' ORMprr, ORMnar';
030200130517         ENDIF;
030300130517
030400130522         IF  I44sel = 'O';
030500130531           wSQL += ' ORDER BY ORMrso, ORMcor , ORMino, ORMcao, ORMloo,';
030600130531           wSQL += ' ORMpro, ORMnao';
030700130517         ENDIF;
030800100525
030900100525       ENDSR;
031000130522
031100130522       //--------------------------------------------------------------
031200130522       //?Carico i dati nel file di work.
031300130522       //--------------------------------------------------------------
031400130522       BEGSR CtrRcd;
031500130522
031600130522         wNOokrcd = *off;
031700130522
031800130522       //?Controllo se il rcd è ok per la statistica
031900130522
032000130522         SELECT;
032100130522           WHEN  I44sel = 'M' and I44cod = 'S' and ORMcra = 0;
032200130522             wNOokrcd = *on;
032300130522           WHEN  I44sel = 'O' and I44cod = 'S' and ORMcor = 0;
032400130522             wNOokrcd = *on;
032500130522           WHEN  I44sel = 'O' and I44cod = *blanks and
032600130522                 ORMcor = 0 and ORMrso = *blanks;
032700130522             wNOokrcd = *on;
032800130522         ENDSL;
032900130522
033000130522       ENDSR;
033100130522
033200130522       //--------------------------------------------------------------
033300130531       //?Carico i dati nel file di work.
033400130522       //--------------------------------------------------------------
033500130531       BEGSR CarDati;
033600130522
033700130531       //?Scrivo a cambio cliente
033800130531         IF  ds_rigacli <> ds_savcli;
033900130522
034000130531           IF  savRAG <> *blanks and ROM1orm >= I44orm;
034100130522             exsr Scrivi;
034200130522           ENDIF;
034300130531
034400130531           clear  WFROM100;
034500130522
034600130531           savCOD = wCOD;
034700130523           savRAG = wRAG;
034800130523           savIND = wIND;
034900130523           savCAP = wCAP;
035000130523           savLOC = wLOC;
035100130523           savPRV = wPRV;
035200130523           savNAZ = wNAZ;
035300130531
035400130531           IF  wCOD > 0;
035500130531             exsr cercaCMM;
035600130531           ELSE;
035700130531             savAGE = 9999999;
035800130531           ENDIF;
035900130522         ENDIF;
036000130522
036100130522         //?ORM immessi
036200130522         ROM1orm += 1;
036300130531
036400130522         //?ORM immessi NON codificati
036500130531         IF  savCOD = 0;
036600130531           ROM1ormn += 1;
036700130531         ELSE;
036800130531         //?ORM immessi codificati
036900130531           ROM1ormc += 1;
037000130531         ENDIF;
037100130531
037200130531         //?Conto se ORM di mia competenza
037300130531         IF  ORMpoe = ORMpor;
037400130531           ROM1corm += 1;
037500130531           IF  savCOD = 0;
037600130531             ROM1cormn += 1;
037700130531           ELSE;
037800130531             ROM1cormc += 1;
037900130531           ENDIF;
038000130522         ENDIF;
038100100709
038200100709       ENDSR;
038300130517
038400130517       //--------------------------------------------------------------
038500130517       //?Cerco il codice commerciale.
038600130517       //--------------------------------------------------------------
038700130517       BEGSR CercaCMM;
038800130517
038900130517       //?Cerco il commerciale
039000130517           clear tibs69ds;
039100130517           I69kcp = %dec(%subst(%editc(savCOD:'X'):1:7):7:0);
039200130517           tibs69r (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
039300130517           IF  O69err <> *blanks;
039400130517             clear CLPage;
039500130517           ENDIF;
039600130517
039700130517       //?Cerco Unificante
039800130830           chain  (CLPage)  AZCMM000;
039900130830           IF  NOT %found( AZCMM01L );
040000130830             clear  CMMuni;
040100130517           ENDIF;
040200130830           savAGE = CMMuni;
040300130517
040400130517       ENDSR;
040500130517
040600130517       //--------------------------------------------------------------
040700130517       //?Scrivo file di WORK.
040800130517       //--------------------------------------------------------------
040900130517       BEGSR Scrivi;
041000130517
041100130517       //?Imposto i campi del file
041200130517         ROM1cmm = savAGE;
041300130517         ROM1cod = savCOD;
041400130523         ROM1rag = savRAG;
041500130523         ROM1ind = savIND;
041600130523         ROM1cap = savCAP;
041700130523         ROM1loc = savLOC;
041800130523         ROM1prv = savPRV;
041900130523         ROM1naz = savNAZ;
042000130517
042100130517         write  WFROM100;
042200130517
042300130517       ENDSR;
042400080206
042500080206       //--------------------------------------------------------------
042600080206       //?Reperimento Dati del job (Utente/Operativi).
042700080206       //--------------------------------------------------------------
042800080206       BEGSR DatiJob;
042900080206
043000080206         in(E) §AzUte;
043100080206         if NOT %error;
043200080206           in(E) §DatiUte;
043300080206         endif;
043400080206         if %error or RSut = *blanks;
043500080206           clear TIBS34ds;
043600080206           tibs34r(tibs34ds);
043700080206           in §AzUte;
043800080206           in §DatiUte;
043900080206         endif;
044000080206
044100080206       ENDSR;
044200100326
044300080206       //--------------------------------------------------------------
044400080206       //?Operazioni finali.
044500080206       //--------------------------------------------------------------
044600080206       BEGSR RoutEnd;
044700090521
044800080206         *inLR = *on;
044900080206         return;
045000080206
045100080206       ENDSR;
045200080206
045300080206      /end-free
