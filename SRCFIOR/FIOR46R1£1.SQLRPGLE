000100080206      //--------------------------------------------------------------
000200130516      //?FIOR46R1 - Statistica ORM manuali - crea file work
000300080206      //--------------------------------------------------------------
000400080206
000500090407     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600080206
000700080206      //---------------------------------------------------------------
000800080206      //?Dichiarazione file.
000900080206      //---------------------------------------------------------------
001000100527     fAZORG01L  if   e           k disk
001100130517     fTABEL00F  if   e           k disk
001200130516     fWFROM10F  o    e             disk
001300100310
001400080206      //---------------------------------------------------------------
001500090406      //?Definizione costanti.
001600080206      //---------------------------------------------------------------
001700080206
001800080206      //---------------------------------------------------------------
001900080206      //?Definizione schiere.
002000080206      //---------------------------------------------------------------
002100100325
002200130516      // - Filiali
002300130516     d wSKfil          s              3  0 dim(250)
002400080206
002500080206      //---------------------------------------------------------------
002600080206      //?Definizione aree dati.
002700080206      //---------------------------------------------------------------
002800080206
002900080206      // - Dati utente
003000080206     d §AzUte        e ds                  extname(AZUTE00F)
003100080206     d                                     dtaara
003200080206     d §DatiUte      e ds                  extname(dDatiUte)
003300080206     d                                     dtaara
003400080206
003500080206      //---------------------------------------------------------------
003600080206      //?Definizione strutture dati.
003700080206      //---------------------------------------------------------------
003800080206
003900080206      // - Parametri ricevuti
004000080206     d KPJBA         e ds
004100130516     d FIOR44DS      e ds
004200100308
004300080206      // - Reperimento dati utente
004400100305     d TIBS34DS      e ds
004500130517
004600130517       // - Reperimento dati anagrafici
004700130517     d TIBS69ds      e ds
004800130517     d DS_cnaco      e ds                  inz extname(CNACO00F)
004900130517     d DS_cnind      e ds                  inz extname(CNIND00F)
005000130517     d DS_cnclp      e ds                  inz extname(CNCLP00F)
005100130517     d DS_fncls      e ds                  inz extname(FNCLS00F)
005200100325
005300130516      // - Carico Filiali
005400130516     d TRUL26DS      e ds
005500130516     d skpo                   11    760  0 dim(250)
005600130517     d skpot                 761   1510  0 dim(250)
005700130517
005800130517      // File ORM
005900130517     d FNORM00F      e ds                  extname(FNORM00F)
006000130517
006100130517      // - Tabella 01 = Codici Commerciali
006200130517     d ds01          e ds                  inz
006300130531
006400130531     d ds_rigacli      ds
006500130531     d wCOD                          10  0
006600130531     d wRAG                          35
006700130531     d wIND                          35
006800130531     d wCAP                           9
006900130531     d wLOC                          35
007000130531     d wPRV                           2
007100130531     d wNAZ                           3
007200130531
007300130531     d ds_savcli       ds
007400130531     d savCOD                        10  0
007500130531     d savRAG                        35
007600130531     d savIND                        35
007700130531     d savCAP                         9
007800130531     d savLOC                        35
007900130531     d savPRV                         2
008000130531     d savNAZ          s              3
008100090629
008200080206      //---------------------------------------------------------------
008300080206      //?Definizione variabili globali.
008400080206      //---------------------------------------------------------------
008500080206
008600080206      // - Flags booleani
008700130517     d wEnd            s               n   inz(*off)
008800130522     d wNOokrcd        s               n   inz(*off)
008900130523     d wUltimo         s               n   inz(*off)
009000100325
009100100325      // - Indici di schiera
009200100326     d xx              s              4  0 inz
009300100326     d yy              s              4  0 inz
009400080206
009500090806       // - Stringa SQL da eseguire
009600090806     d wSQL            s           2048    Varying        inz
009700100305
009800100305      // - Campi di comodo
009900130517     d savAGE          s                   like(CLPage)
010000130522     d wORM            s              5  0 inz
010100130522     d wORMC           s              5  0 inz
010200130522     d wORMN           s              5  0 inz
010300130522     d wCORM           s              5  0 inz
010400130522     d wCORMC          s              5  0 inz
010500130522     d wCORMN          s              5  0 inz
010600100325
010700090508      //---------------------------------------------------------------
010800090807      //?Definizione procedure esterne.
010900090508      //---------------------------------------------------------------
011000130517
011100130517      // - Filiali da elaborare
011200130517     d trul26r         pr                  extpgm('TRUL26R')
011300130517     d  trul26ds                           likeds(trul26ds)
011400100120
011500100120      //---------------------------------------------------------------
011600100120      //?prototipi
011700100120      //---------------------------------------------------------------
011800090807
011900080626      /copy gaitrasrc/srcprotopr,tibs34r
012000130517      /copy gaitrasrc/srcprotopr,tibs69r
012100090807
012200080206      //---------------------------------------------------------------
012300080206      //?Definizione key-list.
012400080206      //---------------------------------------------------------------
012500130517
012600130517       // - File TABEL00F
012700130517     d k03tabel      e ds                  extname(TABEL00F:*key)
012800130517     d                                     prefix(k_)
012900130517     d                                     inz
013000080206
013100080206      //---------------------------------------------------------------
013200080206      //?Riepilogo indicatori.
013300080206      //---------------------------------------------------------------
013400090807
013500080206      //---------------------------------------------------------------
013600080206
013700080206      //---------------------------------------------------------------
013800080206      //?M A I N - L I N E
013900080206      //---------------------------------------------------------------
014000080206
014100080206     c     *Entry        plist
014200080206     c                   parm                    KPJBA
014300080206
014400080206      /free
014500080206
014600090807       //?Operazioni iniziali
014700080206       exsr RoutInz;
014800100524
014900130517       //?Elaboro
015000130517       exsr Elabora;
015100080206
015200090807       //?Operazioni finali
015300080206       exsr RoutEnd;
015400080206
015500080206       //--------------------------------------------------------------
015600080206       //?Operazioni iniziali.
015700080206       //--------------------------------------------------------------
015800080206       BEGSR RoutInz;
015900100329
016000100709       //?Imposto la ds con i dati della KPJBU
016100130516         FIOR44ds = kpjbu;
016200090807
016300100709       //?Reperimento dati job
016400090807         exsr DatiJob;
016500090807
016600090807         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
016700100325
016800130516       //?Carico in sk le filiali da elaborare
016900130516         clear wSKfil;
017000130516         IF  I44poel <> 999;
017100130516           wSKfil(01) = I44poel;
017200130516           leavesr;
017300100325         ENDIF;
017400130516
017500130516         exsr carFIL;
017600130517
017700130517       //?Imposto dati fissi
017800130517         k_tblkut = 1;
017900090714
018000080206       ENDSR;
018100100524
018200100326       //--------------------------------------------------------------
018300130516       //?Carico SK Filiali.
018400100326       //--------------------------------------------------------------
018500130516       BEGSR carFIL;
018600100326
018700100326         clear xx;
018800130516         clear wSKfil;
018900100326
019000130516         clear TRUL26DS;
019100130516         I26tpt = 'P';
019200130516         I26tla = 'L';
019300130516         trul26r (TRUL26DS);
019400130516
019500130516       //?Carico solo le filiali che hanno come terminal di partenza = SIMFEL
019600130516         xx = 1;
019700130516         clear yy;
019800130516         FOR xx by 1 to %elem(skpo);
019900130517           IF skpo(xx) <> *zeros and skpot(xx) = simfel;
020000130516             yy += 1;
020100130516             wSKfil(yy) = skpo(xx);
020200130516           ENDIF;
020300130516         ENDFOR;
020400130516
020500100326       ENDSR;
020600100709
020700100709       //--------------------------------------------------------------
020800130516       //?Elaboro.
020900100709       //--------------------------------------------------------------
021000130516       BEGSR Elabora;
021100100526
021200130516         wEnd = *off;
021300100526
021400100709       //?Imposto la stringa per SQL
021500130516         exsr PrepSQL;
021600100708
021700100709       //?Dichiarazione cursore
021800100708         exec sql
021900100708           prepare S1   from :wSQL;
022000100708         exec sql
022100130517           declare ORM  cursor for S1;
022200100526
022300100709       //?Apertura del cursore
022400100526         exec sql
022500130517           open ORM;
022600100526
022700100526         IF sqlcode < 0;
022800130517           wEnd = *on;
022900100526         ENDIF;
023000130517
023100130517         clear WFROM100;
023200100526
023300130517         DOW not wEnd;
023400100526           exec sql
023500130517             fetch next from ORM into :fnorm00f;
023600100526           IF sqlcod = 100 or sqlcod < 0;
023700130517             wEnd = *on;
023800100526             leave;
023900100526           ENDIF;
024000130522
024100130522       //?Controllo se OK il rcd
024200130522           exsr CtrRcd;
024300130522           IF  wNOokrcd;
024400130522             iter;
024500130522           ENDIF;
024600130522
024700130523       //?Carico i dati
024800130523           SELECT;
024900130531             WHEN  I44sel = 'M';
025000130531               wCOD = ORMcra;
025100130522               wRAG = ORMrsr;
025200130523               wIND = ORMinr;
025300130523               wCAP = ORMcar;
025400130523               wLOC = ORMlor;
025500130523               wPRV = ORMprr;
025600130523               wNAZ = ORMnar;
025700130531             WHEN  I44sel = 'O';
025800130531               wCOD = ORMcor;
025900130522               wRAG = ORMrso;
026000130523               wIND = ORMino;
026100130523               wCAP = ORMcao;
026200130523               wLOC = ORMloo;
026300130523               wPRV = ORMpro;
026400130523               wNAZ = ORMnao;
026500130531           ENDSL;
026600130531
026700130531           exsr CarDati;
026800100526
026900100526         ENDDO;
027000100526
027100100526         exec sql
027200130517           close ORM;
027300130521
027400130521       //?Carico i dati nel file di work
027500130521       //?ultimo cliente
027600130531         IF  ROM1orm >= I44ORM;
027700130531           exsr Scrivi;
027800130531         ENDIF;
027900100526
028000100526       ENDSR;
028100100525
028200100525       //--------------------------------------------------------------
028300100525       //?Preparazione stringa SQL.
028400100525       //--------------------------------------------------------------
028500130517       BEGSR PrepSQL;
028600130517
028700130517       //?Seleziono gli ORM
028800130517         wSQL = 'select * from FNORM00F +
028900130517                 where ORMtco = ''M'' and ORMpoe in(';
029000130517         yy = 0;
029100130517         xx = 1;
029200130517         FOR xx by 1 to %elem(wSKfil);
029300130517           IF wSKfil(xx) <> *zeros;
029400130517             IF yy > 0;
029500130517               wSQL += ', ';
029600130517             ELSE;
029700130517               yy = 1;
029800130517             ENDIF;
029900130517             wSQL += %editc(wSKfil(xx):'X');
030000130517           ENDIF;
030100130517         ENDFOR;
030200130517
030300130517         wSQL += ') and ORMdao between ' + %editc(I44dtda:'X') +
030400130517                   ' and ' + %editc(I44dtal:'X');
030500130517
030600130522         IF  I44sel = 'M';
030700130531           wSQL += ' ORDER BY ORMrsr, ORMcra, ORMinr, ORMcar, ORMlor,';
030800130531           wSQL += ' ORMprr, ORMnar';
030900130517         ENDIF;
031000130517
031100130522         IF  I44sel = 'O';
031200130531           wSQL += ' ORDER BY ORMrso, ORMcor , ORMino, ORMcao, ORMloo,';
031300130531           wSQL += ' ORMpro, ORMnao';
031400130517         ENDIF;
031500100525
031600100525       ENDSR;
031700130522
031800130522       //--------------------------------------------------------------
031900130522       //?Carico i dati nel file di work.
032000130522       //--------------------------------------------------------------
032100130522       BEGSR CtrRcd;
032200130522
032300130522         wNOokrcd = *off;
032400130522
032500130522       //?Controllo se il rcd è ok per la statistica
032600130522
032700130522         SELECT;
032800130522           WHEN  I44sel = 'M' and I44cod = 'S' and ORMcra = 0;
032900130522             wNOokrcd = *on;
033000130522           WHEN  I44sel = 'O' and I44cod = 'S' and ORMcor = 0;
033100130522             wNOokrcd = *on;
033200130522           WHEN  I44sel = 'O' and I44cod = *blanks and
033300130522                 ORMcor = 0 and ORMrso = *blanks;
033400130522             wNOokrcd = *on;
033500130522         ENDSL;
033600130522
033700130522       ENDSR;
033800130522
033900130522       //--------------------------------------------------------------
034000130531       //?Carico i dati nel file di work.
034100130522       //--------------------------------------------------------------
034200130531       BEGSR CarDati;
034300130522
034400130531       //?Scrivo a cambio cliente
034500130531         IF  ds_rigacli <> ds_savcli;
034600130522
034700130531           IF  savRAG <> *blanks and ROM1orm >= I44orm;
034800130522             exsr Scrivi;
034900130522           ENDIF;
035000130531
035100130531           clear  WFROM100;
035200130522
035300130531           savCOD = wCOD;
035400130523           savRAG = wRAG;
035500130523           savIND = wIND;
035600130523           savCAP = wCAP;
035700130523           savLOC = wLOC;
035800130523           savPRV = wPRV;
035900130523           savNAZ = wNAZ;
036000130531
036100130531           IF  wCOD > 0;
036200130531             exsr cercaCMM;
036300130531           ELSE;
036400130531             savAGE = 9999999;
036500130531           ENDIF;
036600130522         ENDIF;
036700130522
036800130522         //?ORM immessi
036900130522         ROM1orm += 1;
037000130531
037100130522         //?ORM immessi NON codificati
037200130531         IF  savCOD = 0;
037300130531           ROM1ormn += 1;
037400130531         ELSE;
037500130531         //?ORM immessi codificati
037600130531           ROM1ormc += 1;
037700130531         ENDIF;
037800130531
037900130531         //?Conto se ORM di mia competenza
038000130531         IF  ORMpoe = ORMpor;
038100130531           ROM1corm += 1;
038200130531           IF  savCOD = 0;
038300130531             ROM1cormn += 1;
038400130531           ELSE;
038500130531             ROM1cormc += 1;
038600130531           ENDIF;
038700130522         ENDIF;
038800100709
038900100709       ENDSR;
039000130517
039100130517       //--------------------------------------------------------------
039200130517       //?Cerco il codice commerciale.
039300130517       //--------------------------------------------------------------
039400130517       BEGSR CercaCMM;
039500130517
039600130517       //?Cerco il commerciale
039700130517           clear tibs69ds;
039800130517           I69kcp = %dec(%subst(%editc(savCOD:'X'):1:7):7:0);
039900130517           tibs69r (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
040000130517           IF  O69err <> *blanks;
040100130517             clear CLPage;
040200130517           ENDIF;
040300130517
040400130517       //?Cerco Unificante
040500130517           clear ds01;
040600130520           k_tblkut = 1;
040700130517           k_tblcod = '01';
040800130517           k_tblkey = %editc(CLPage:'X');
040900130517           chain  %kds(K03tabel) TABEL00F;
041000130517           IF  %found( TABEL00F );
041100130517             ds01 = TBLuni;
041200130517           ENDIF;
041300130517           savAGE = §01rgf;
041400130517
041500130517       ENDSR;
041600130517
041700130517       //--------------------------------------------------------------
041800130517       //?Scrivo file di WORK.
041900130517       //--------------------------------------------------------------
042000130517       BEGSR Scrivi;
042100130517
042200130517       //?Imposto i campi del file
042300130517         ROM1cmm = savAGE;
042400130517         ROM1cod = savCOD;
042500130523         ROM1rag = savRAG;
042600130523         ROM1ind = savIND;
042700130523         ROM1cap = savCAP;
042800130523         ROM1loc = savLOC;
042900130523         ROM1prv = savPRV;
043000130523         ROM1naz = savNAZ;
043100130517
043200130517         write  WFROM100;
043300130517
043400130517       ENDSR;
043500080206
043600080206       //--------------------------------------------------------------
043700080206       //?Reperimento Dati del job (Utente/Operativi).
043800080206       //--------------------------------------------------------------
043900080206       BEGSR DatiJob;
044000080206
044100080206         in(E) §AzUte;
044200080206         if NOT %error;
044300080206           in(E) §DatiUte;
044400080206         endif;
044500080206         if %error or RSut = *blanks;
044600080206           clear TIBS34ds;
044700080206           tibs34r(tibs34ds);
044800080206           in §AzUte;
044900080206           in §DatiUte;
045000080206         endif;
045100080206
045200080206       ENDSR;
045300100326
045400080206       //--------------------------------------------------------------
045500080206       //?Operazioni finali.
045600080206       //--------------------------------------------------------------
045700080206       BEGSR RoutEnd;
045800090521
045900080206         *inLR = *on;
046000080206         return;
046100080206
046200080206       ENDSR;
046300080206
046400080206      /end-free
