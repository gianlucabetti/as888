000100100223       //--------------------------------------------------------------
000200100223       //?TEST - PREPARA E-MAIL PER CONFERMA ORM (STAMPA, NON INVIA)   ?
000300100223       //--------------------------------------------------------------
000400151014
000500151014       //--------------------------------------------------------------
000600151014       //?Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700151014       //--------------------------------------------------------------
000800151014
000900151014     /*END
001000151014
001100151014       //--------------------------------------------------------------
001200151014       //?Specifiche di controllo.                                     ?
001300151014       //--------------------------------------------------------------
001400100223
001500100223     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001600100223     h dftactgrp(*no) actgrp('QILE')
001700100223
001800100223       //--------------------------------------------------------------
001900100223       //?Dichiarazione file.                                          ?
002000100223       //--------------------------------------------------------------
002100100223
002200100223       // -?Archivio O.R.M.?
002300100223     fFNORM01L  if   e           k disk
002400100223
002500100223       // -?Video?
002600100223     fFIOR52TSTDcf   e             workstn
002700100223     f                                     indds(IndDspF)
002800100223     f                                     infds(InfDspF)
002900100223
003000100223       //--------------------------------------------------------------
003100100223       //?Definizione costanti.                                        ?
003200100223       //--------------------------------------------------------------
003300100223
003400100223       // -?Tasti funzionali a video?
003500100223     d c_F01           c                   const(x'31')
003600100223     d c_F02           c                   const(x'32')
003700100223     d c_F03           c                   const(x'33')
003800100223     d c_F04           c                   const(x'34')
003900100223     d c_F05           c                   const(x'35')
004000100223     d c_F06           c                   const(x'36')
004100100223     d c_F07           c                   const(x'37')
004200100223     d c_F08           c                   const(x'38')
004300100223     d c_F09           c                   const(x'39')
004400100223     d c_F10           c                   const(x'3A')
004500100223     d c_F11           c                   const(x'3B')
004600100223     d c_F12           c                   const(x'3C')
004700100223     d c_F13           c                   const(x'B1')
004800100223     d c_F14           c                   const(x'B2')
004900100223     d c_F15           c                   const(x'B3')
005000100223     d c_F16           c                   const(x'B4')
005100100223     d c_F17           c                   const(x'B5')
005200100223     d c_F18           c                   const(x'B6')
005300100223     d c_F19           c                   const(x'B7')
005400100223     d c_F20           c                   const(x'B8')
005500100223     d c_F21           c                   const(x'B9')
005600100223     d c_F22           c                   const(x'BA')
005700100223     d c_F23           c                   const(x'BB')
005800100223     d c_F24           c                   const(x'BC')
005900100223     d c_Enter         c                   const(x'F1')
006000100223     d c_RollDown      c                   const(x'F4')
006100100223     d c_RollUp        c                   const(x'F5')
006200100223
006300100223       //--------------------------------------------------------------
006400100223       //?Definizione schiere.                                         ?
006500100223       //--------------------------------------------------------------
006600100223
006700100223       // -?Messaggi di errore?
006800100223     d $Msg            s             78    dim( 2) ctdata perrcd(1)
006900100223
007000100223       //--------------------------------------------------------------
007100100223       //?Definizione aree dati.                                       ?
007200100223       //--------------------------------------------------------------
007300100223
007400100223       // -?Dati utente?
007500100223     d §AzUte        e ds                  extname(AZUTE00F)
007600100223     d                                     dtaara
007700100223     d §DatiUte      e ds                  extname(dDatiUte)
007800100223     d                                     dtaara
007900100223
008000100223       //--------------------------------------------------------------
008100100223       //?Definizione strutture dati.                                  ?
008200100223       //--------------------------------------------------------------
008300100223
008400100223       // -?Status ds?
008500100223     d Status         sds
008600100223     d  SDSpgm           *proc
008700100223     d  SDSprm           *parms
008800100223     d  SDSusr               254    263
008900100223
009000100223       // -?InfDS?
009100100223     d InfDspF         ds
009200100223     d  dsp_aid              369    369a
009300100223
009400100223       // -?Indicatori su DspF?
009500100223     d IndDspF         ds
009600100223         // -?Indicatori di errore?
009700100223     d   ErrMessage                   1n   overlay(IndDspF : 28)
009800100223     d   PosCurORM                    1n   overlay(IndDspF : 50)
009900100223     d   ErrGenerico                  1n   overlay(IndDspF : 99)
010000100223
010100100223       // -?Parametri per pgm. controllo/inversione data?
010200100223     d WLBdat          ds                  inz
010300100223     d  G08dat                        8  0 inz
010400100223     d  G08inv                        8  0 inz
010500100223     d  G08err                        1    inz('3')
010600100223     d  G08tgi                        5  0 inz
010700100223
010800100223       // -?Parametri ricevuti?
010900100223     d KPJBA         e ds
011000100223
011100100223       // -?Parametri x Controllo profilo utenti?
011200100223     d TIBS34ds      e ds
011300100223
011400100223       // -?Parametri per interrogazione O.R.M.?
011500151014     d FIOR010ds     e ds                  inz
011600100223
011700100223       // -?Dati ORM da stampare?
011800100223     d FIOR52ds      e ds                  inz
011900100223
012000100223       //--------------------------------------------------------------
012100100223       //?Definizione variabili globali.                               ?
012200100223       //--------------------------------------------------------------
012300100223
012400100223       // -?Flags booleani?
012500100223     d $Fine           s               n   inz(*off)
012600100223     d $InzD01         s               n   inz(*on)
012700100223
012800100223       //--------------------------------------------------------------
012900100223       //?Definizione procedure usate.                                 ?
013000100223       //--------------------------------------------------------------
013100100223
013200100223       // -?Reperimento dati utente?
013300100223     d tibs34r         pr                  extpgm('TIBS34R')
013400100223     d   tibs34ds                          likeds(TIBS34ds)
013500100223
013600100223       // -?Interrogazione O.R.M.?
013700151014     d fior010r        pr                  extpgm('FIOR010R')
013800100223     d   kpjba                             likeds(KPJBA)
013900151014     d   fior010ds                         likeds(FIOR010ds)
014000100223
014100100223       // -?Stampa e-mail?
014200100223     d fior52r         pr                  extpgm('FIOR52R')
014300100223     d   kpjba                             likeds(KPJBA)
014400100224     d   fior52ds                          likeds(FIOR52ds)
014500100223
014600100223       //--------------------------------------------------------------
014700100223       //?Definizione key-list.                                        ?
014800100223       //--------------------------------------------------------------
014900100223
015000100223       // -?File FNORM01L?
015100100223     d k04fnorm01    e ds                  extname(FNORM01L:*key)
015200100223     d                                     prefix(k_)
015300100223     d                                     inz
015400100223
015500100223       //--------------------------------------------------------------
015600100223       //?Riepilogo indicatori.                                        ?
015700100223       //--------------------------------------------------------------
015800100223
015900100223     c     *Entry        plist
016000100223     c                   parm                    KPJBA
016100100223
016200100223      /free
016300100223
016400100223       // -?Start?
016500100223       *inLR = *on;
016600100223
016700100223       // -?Elab?
016800100223       dow  $Fine = *off;
016900100223         exsr sr_GesD01;
017000100223       enddo;
017100100223
017200100223       // -?End?
017300100223       return;
017400100223
017500100223       //--------------------------------------------------------------
017600100223       //?Operazioni iniziali                                          ?
017700100223       //--------------------------------------------------------------
017800100223       BEGSR  *InzSR;
017900100223
018000100223         // -?Reperimento dati utente?
018100100223         exsr sr_DatiJob;
018200100223
018300100223         // -?Impostazione nome programma in testata a video?
018400100223         VTDpgm = SDSpgm;
018500100223
018600100223       ENDSR;
018700100223
018800100223       //--------------------------------------------------------------
018900100223       //?Reperimento Dati del job (Utente/Operativi).                 ?
019000100223       //--------------------------------------------------------------
019100100223       BEGSR  sr_DatiJob;
019200100223
019300100223         in(E) §AzUte;
019400100223         if NOT %error;
019500100223           in(E) §DatiUte;
019600100223         endif;
019700100223         if %error or RSut = *blanks;
019800100223           clear TIBS34ds;
019900100223           tibs34r(tibs34ds);
020000100223           in §AzUte;
020100100223           in §DatiUte;
020200100223         endif;
020300100223
020400100223       ENDSR;
020500100223
020600100223       //--------------------------------------------------------------
020700100223       //?Gestione videata D01                                         ?
020800100223       //--------------------------------------------------------------
020900100223       BEGSR  sr_GesD01;
021000100223
021100100223         // -?Inizializzazione videata?
021200100223         if  $InzD01 = *on;
021300100223           clear OR52D01;
021400100223           $InzD01  = *off;
021500100223         endif;
021600100223
021700100223         // -?Emissione videata?
021800100223         if  ErrMessage = *off;
021900100223           write OR52T01;
022000100223           write OR52Z01;
022100100223         endif;
022200100223
022300100223         exfmt OR52D01;
022400100223
022500100223         reset ErrMessage;
022600100223         reset ErrGenerico;
022700100223         clear V1Dmsg;
022800100223
022900100223         SELECT;
023000100223
023100100223           // -?F3=Fine?
023200100223           WHEN  dsp_aid = c_F03;
023300100223             $Fine = *on;
023400100223
023500100223           // -?F4=Interrogazione O.R.M.?
023600100223           WHEN  dsp_aid = c_F04;
023700151014             exsr Call_FIOR010R;
023800100223
023900100223           // -?Invio o F6=Conferma?
024000100223           OTHER;
024100100223             exsr sr_CtrD01;
024200100223             select;
024300100223               // -?rilevato errore?
024400100223               when  ErrGenerico = *on;
024500100223               // -?non premuto F6?
024600100223               when  dsp_aid <> c_F06;
024700100223               // -?selezionata una singola spedizione?
024800100223               when  I52poe  <> *zero   and
024900100223                     I52nor  <> *zero;
025000100223                 exsr  Call_FIOR52R;
025100100223                 //reset  $InzD01;
025200100223             endsl;
025300100223
025400100223         ENDSL;
025500100223
025600100223       ENDSR;
025700100223
025800100223       //--------------------------------------------------------------
025900100223       //?Richiamo pgm. Interrogazione O.R.M.                          ?
026000100223       //--------------------------------------------------------------
026100151014       BEGSR  Call_FIOR010R;
026200100223
026300151014         clear  FIOR010ds;
026400151014         IOR010ric = '1';
026500100223         if  DUTlpo <> 'S';
026600151014           IOR010por = DUTpou;
026700100223         endif;
026800100223
026900151014         fior010r (kpjba : FIOR010ds);
027000100223
027100151014         if  OOR010f03 = *on  or
027200151014             OOR010f12 = *on  or
027300151014             OOR010err = *on;
027400100223           leavesr;
027500100223         endif;
027600100223
027700151014         I52poe = OOR010poe;
027800151014         I52nsr = OOR010nsr;
027900151014         I52nor = OOR010nor;
028000151014         I52nrv = OOR010nrv;
028100100223
028200100223       ENDSR;
028300100223
028400100223       //--------------------------------------------------------------
028500130627       //?Richiamo *pgm Invio e-mail al cliente con O.R.M. allegato    ?
028600100223       //--------------------------------------------------------------
028700100223       BEGSR  Call_FIOR52R;
028800100223
028900100224         fior52r (kpjba : FIOR52ds);
029000100223
029100100223         write  Protect;
029200100223         exfmt  OR52D02;
029300100223
029400100223         // -?F3=Fine?
029500100223         if  dsp_aid = c_F03;
029600100223           $Fine = *on;
029700100223           leavesr;
029800100223         endif;
029900100223
030000100223       ENDSR;
030100100223
030200100223       //--------------------------------------------------------------
030300100223       //?Controllo dati in videata D01                                ?
030400100223       //--------------------------------------------------------------
030500100223       BEGSR  sr_CtrD01;
030600100223
030700100223         %subst( IndDspF : 50 ) = *off;
030800100223
030900100223         SELECT;
031000100223
031100100223           // -?Nessun O.R.M. inserito?
031200100223           WHEN  I52poe = *zero   and
031300100223                 I52nsr = *zero   and
031400100223                 I52nor = *zero;
031500100223             ErrMessage  = *on;
031600100223             ErrGenerico = *on;
031700100223             PosCurORM   = *on;
031800100223             V1Dmsg = $Msg(01);
031900100223             leavesr;
032000100223
032100100223           // -?Selezionato un singolo O.R.M.?
032200100223           WHEN  I52poe <> *zero   or
032300100223                 I52nsr <> *zero   or
032400100223                 I52nor <> *zero;
032500100223             k_ORMpoe = I52poe;
032600100223             k_ORMnsr = I52nsr;
032700100223             k_ORMnor = I52nor;
032800100223             k_ORMnrv = I52nrv;
032900100223             setll  %kds(k04fnorm01) FNORM000;
033000100223             if not %equal(FNORM01L);
033100100223               ErrMessage  = *on;
033200100223               ErrGenerico = *on;
033300100223               PosCurORM   = *on;
033400100223               V1Dmsg = $Msg(02);
033500100223               leavesr;
033600100223             endif;
033700100223
033800100223         ENDSL;
033900100223
034000100223       ENDSR;
034100100223
034200100223      /end-free
034300100223
034400100223       //--------------------------------------------------------------
034500100223       //?Schiere a tempo di compilazione.                             ?
034600100223       //--------------------------------------------------------------
034700100223
034800100223** - $Msg
034900100223Nessuna selezione inserita
035000100223O.R.M. inesistente
