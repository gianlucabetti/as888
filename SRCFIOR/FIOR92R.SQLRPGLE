000100170809      //---------------------------------------------------------------
000200170809      //
000300170809      //      Sistema filiale ritiro ORM (£6)
000400170809      //
000500170809      //---------------------------------------------------------------
000600170809     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000700170809
000800170809      //---------------------------------------------------------------
000900170809      //?Dichiarazione file.
001000170809      //---------------------------------------------------------------
001100170809     fAZORG01L  if   e           k disk
001200170809     fFNORG01L  uf   e           k disk
001300170809     fFNORM01L  uf   e           k disk
001400170809     fFIOR92D   cf   e             workstn indds(IndDspF)
001500170809     f                                     infds(InfDspF)
001600170809
001700170809      //---------------------------------------------------------------
001800170809      //?Definizione costanti.
001900170809      //---------------------------------------------------------------
002000170809
002100170809      //---------------------------------------------------------------
002200170809      //?Definizione schiere.
002300170809      //---------------------------------------------------------------
002400170809      // - Tasti funzionali a video
002500170809     d c_F01           c                   const(x'31')
002600170809     d c_F02           c                   const(x'32')
002700170809     d c_F03           c                   const(x'33')
002800170809     d c_F04           c                   const(x'34')
002900170809     d c_F05           c                   const(x'35')
003000170809     d c_F06           c                   const(x'36')
003100170809     d c_F07           c                   const(x'37')
003200170809     d c_F08           c                   const(x'38')
003300170809     d c_F09           c                   const(x'39')
003400170809     d c_F10           c                   const(x'3A')
003500170809     d c_F11           c                   const(x'3B')
003600170809     d c_F12           c                   const(x'3C')
003700170809     d c_F13           c                   const(x'B1')
003800170809     d c_F14           c                   const(x'B2')
003900170809     d c_F15           c                   const(x'B3')
004000170809     d c_F16           c                   const(x'B4')
004100170809     d c_F17           c                   const(x'B5')
004200170809     d c_F18           c                   const(x'B6')
004300170809     d c_F19           c                   const(x'B7')
004400170809     d c_F20           c                   const(x'B8')
004500170809     d c_F21           c                   const(x'B9')
004600170809     d c_F22           c                   const(x'BA')
004700170809     d c_F23           c                   const(x'BB')
004800170809     d c_F24           c                   const(x'BC')
004900170809     d c_Enter         c                   const(x'F1')
005000170809     d c_RollDown      c                   const(x'F4')
005100170809     d c_RollUp        c                   const(x'F5')
005200170809
005300170809     d Digits          c                   const('0123456789')
005400170809
005500170809      //---------------------------------------------------------------
005600170809      //?Definizione schiere.
005700170809      //---------------------------------------------------------------
005800170809      // - Messaggi di errore
005900170809     d Msg             s             78    dim(20) ctdata perrcd(1)
006000170809
006100170809      //---------------------------------------------------------------
006200170809      //?Definizione aree dati.
006300170809      //---------------------------------------------------------------
006400170809      // - Dati utente
006500170809     d §AzUte        e ds                  extname(AZUTE00F)
006600170809     d                                     dtaara
006700170809     d §DatiUte      e ds                  extname(dDatiUte)
006800170809     d                                     dtaara
006900170809
007000170809      //---------------------------------------------------------------
007100170809      //?Definizione strutture dati.
007200170809      //---------------------------------------------------------------
007300170809      // - Status
007400170809     d Psds           sds
007500170809     d   SDSpgm          *proc
007600170809
007700170809      // - InfDS
007800170809     d InfDspF         ds
007900170809     d  dsp_aid              369    369a
008000170809
008100170809      // - Indicatori su DspF
008200170809     d IndDspF         ds
008300170809        // - Indicatori di errore in videata
008400170809     d  ErrMessage                    1n   overlay(IndDspF : 28)
008500170809        // - Indicatori di errore
008600170809     d  PosCurFil                     1n   overlay(IndDspF : 50)
008700170809     d  PosCurData                    1n   overlay(IndDspF : 51)
008800170809        // - Indicatori di errore generico
008900170809     d  ErrGenerico                   1n   overlay(IndDspF : 99)
009000170809
009100170809     d WindDspF        ds                  inz
009200170809     d  WindDspFa              1     49    inz(*zero)
009300170809     d  WindDspFb             50     99    inz(*zero)
009400170809
009500170809     d fnormds       e ds                  extname(FNORM00F)
009600170809     d                                     prefix(w_)
009700170809
009800170809     d kpjba         e ds
009900170809
010000170809      // - Ricerca terminal
010100170809     d FNLV55DS      e ds                  QUALIFIED INZ
010200170809
010300170809      // - Reperimento dati utente
010400170809     d TIBS34DS      e ds
010500170809
010600170809      //---------------------------------------------------------------
010700170809      //?Definizione variabili globali.
010800170809      //---------------------------------------------------------------
010900170809      // - Flags booleani
011000170809     d wEnd            s               n   inz(*off)
011100170809     d wFine           s               n   inz(*off)
011200170809     d wInzD01         s               n   inz(*on)
011300170809     d wInzD02         s               n   inz(*off)
011400170809
011500170809      // - Campi associati al video
011600170809     d wVideo          s              2    inz('D1')
011700170809
011800170809      // - Campi di comodo
011900170809     d Data_EUR        s               d   datfmt(*eur)
012000170809     d Data_ISO        s               d   datfmt(*iso)
012100170809     d db2NumberRows   s             31p 0 inz
012200170809     d wdata           s              8s 0 inz
012300170809     d wfiliale        s              3s 0 inz
012400170809     d wnrr            s              5s 0 inz
012500170809
012600170809      // - Parametri per pgm. controllo/inversione data?
012700170809     d wlbdat          ds                  inz
012800170809     d  G08dat                 1      8  0
012900170809     d  G08inv                 9     16  0
013000170809     d  G08err                17     17
013100170809     d  G08tgi                18     22  0
013200170809
013300170809      //---------------------------------------------------------------
013400170809      //?Definizione procedure esterne.
013500170809      //---------------------------------------------------------------
013600170809      // - Ricerca terminal
013700170809     d fnlv55r         pr                  extpgm('FNLV55R')
013800170809     d  fnlv55ds                           likeds(FNLV55DS)
013900170809
014000170809      //---------------------------------------------------------------
014100170809      //?Definizione prototipi.
014200170809      //---------------------------------------------------------------
014300170809      /copy gaitrasrc/srcprotopr,TIBS34R
014400170809      /copy gaitrasrc/srcprotopr,XSRDA8
014500170809
014600170809      //---------------------------------------------------------------
014700170809      //?Definizione key-list.
014800170809      //---------------------------------------------------------------
014900170809
015000170809      //---------------------------------------------------------------
015100170809      //?Main.
015200170809      //---------------------------------------------------------------
015300170809     c     *entry        plist
015400170809     c                   parm                    kpjba
015500170809
015600170809      /free
015700170809
015800170809       //?Operazioni iniziali
015900170809       exsr RoutInz;
016000170809
016100170809       //?Gestione video
016200170809       DOW wFine = *off;
016300170809         SELECT;
016400170809           WHEN wVideo = 'D1';
016500170809             exsr GesD01;
016600170809           WHEN wVideo = 'D2';
016700170809             exsr GesD02;
016800170809           OTHER;
016900170809             wFine = *on;
017000170809         ENDSL;
017100170809       ENDDO;
017200170809
017300170809       //?Operazioni finali
017400170809       exsr RoutEnd;
017500170809
017600170809       //--------------------------------------------------------------
017700170809       //?Operazioni iniziali.
017800170809       //--------------------------------------------------------------
017900170809       BEGSR RoutInz;
018000170809
018100170809       //?Impostazione campi "fissi"
018200170809         V00pgm = SDSpgm;
018300170809
018400170809       //?Reperimento dati job
018500170809         exsr DatiJob;
018600170809
018700170809         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
018800170809
018900170809       ENDSR;
019000170809
019100170809       //--------------------------------------------------------------
019200170809       //?Reperimento Dati del job (Utente/Operativi).
019300170809       //--------------------------------------------------------------
019400170809       BEGSR DatiJob;
019500170809
019600170809         in(E) §AzUte;
019700170809         IF  NOT %error;
019800170809           in(E) §DatiUte;
019900170809         ENDIF;
020000170809         IF  %error or Rsut = *blanks;
020100170809           clear TIBS34ds;
020200170809           tibs34r(tibs34ds);
020300170809           in §AzUte;
020400170809           in §DatiUte;
020500170809         ENDIF;
020600170809
020700170809       ENDSR;
020800170809
020900170809       //--------------------------------------------------------------
021000170809       //?Gestione videata D01.
021100170809       //--------------------------------------------------------------
021200170809       BEGSR GesD01;
021300170809
021400170809       //?Inizializzazione videata
021500170809         IF  wInzD01;
021600170809           exsr InzD01;
021700170809           wInzD01  = *off;
021800170809         ENDIF;
021900170809
022000170809       //?Emissione videata
022100170809         write OR92T00;
022200170809         write OR92Z01;
022300170809         exfmt OR92D01;
022400170809         reset ErrMessage;
022500170809         reset ErrGenerico;
022600170809         clear V01msg;
022700170809
022800170809         SELECT;
022900170809
023000170809       //?- F03=Fine
023100170809           WHEN  dsp_aid = c_F03;
023200170809             exsr F03D01;
023300170809
023400170809       //?- F06=Conferma
023500170809           WHEN  dsp_aid = c_F06;
023600170809             exsr F06D01;
023700170809             IF  ErrGenerico;
023800170809               leavesr;
023900170809             ENDIF;
024000170809
024100170809       //?Invio
024200170809           OTHER;
024300170809             exsr CtrD01;
024400170809             IF  ErrGenerico;
024500170809               leavesr;
024600170809             ENDIF;
024700170809
024800170809         ENDSL;
024900170809
025000170809       ENDSR;
025100170809
025200170809       //--------------------------------------------------------------
025300170809       //?Inizializzazione videata D01.
025400170809       //--------------------------------------------------------------
025500170809       BEGSR InzD01;
025600170809
025700170809         clear V01fil;
025800170809         clear V01fild;
025900170809
026000170809         wdata = %dec(%date());
026100170809         Data_EUR = %date(wdata:*ISO);
026200170809         V01data = %dec(Data_EUR);
026300170809
026400170809       ENDSR;
026500170809
026600170809       //--------------------------------------------------------------
026700170809       //?Controllo videata D01.
026800170809       //--------------------------------------------------------------
026900170809       BEGSR CtrD01;
027000170809
027100170809         IF  V01fil = 0;
027200170809           ErrMessage  = *on;
027300170809           ErrGenerico = *on;
027400170809           PosCurFil   = *on;
027500170809           V01msg = Msg(01);
027600170809           leavesr;
027700170809         ENDIF;
027800170809
027900170809         chain V01fil AZORG01L;
028000170809         IF  not %found(AZORG01L);
028100170809           ErrMessage  = *on;
028200170809           ErrGenerico = *on;
028300170809           PosCurFil   = *on;
028400170809           V01msg = Msg(01);
028500170809           leavesr;
028600170809         ENDIF;
028700170809
028800170809         V01fild = ORGdes;
028900170809
029000170809         IF  V01data = 0;
029100170809           ErrMessage  = *on;
029200170809           ErrGenerico = *on;
029300170809           PosCurData  = *on;
029400170809           V01msg = Msg(03);
029500170809           leavesr;
029600170809         ENDIF;
029700170809
029800170809         clear wlbdat;
029900170809         G08dat = V01data;
030000170809         xsrda8(wlbdat);
030100170809         IF  G08err = '1';
030200170809           ErrMessage  = *on;
030300170809           ErrGenerico = *on;
030400170809           PosCurData  = *on;
030500170809           V01msg = Msg(03);
030600170809           leavesr;
030700170809         ENDIF;
030800170809         V01data = G08dat;
030900170809         wdata   = G08inv;
031000170809
031100170809       //?Cerco la filiale "MAMMA"
031200170809         clear FNLV55DS;
031300170809         fnlv55ds.D55tpt = '6';
031400170809         fnlv55ds.D55lin = V01fil;
031500170809         fnlv55ds.D55drf = wdata;
031600170809         fnlv55r (FNLV55DS);
031700170809         IF  fnlv55ds.D55err <> *blanks;
031800170809           ErrMessage  = *on;
031900170809           ErrGenerico = *on;
032000170809           PosCurFil   = *on;
032100170809           V01msg = Msg(04);
032200170809           leavesr;
032300170809         ENDIF;
032400170809         wfiliale = fnlv55ds.D55tfa;
032500170809
032600170809       ENDSR;
032700170809
032800170809       //--------------------------------------------------------------
032900170809       //?F03 Fine Lavoro.
033000170809       //--------------------------------------------------------------
033100170809       BEGSR F03D01;
033200170809
033300170809         exsr RoutEnd;
033400170809
033500170809       ENDSR;
033600170809
033700170809       //--------------------------------------------------------------
033800170809       //?F06 Conferma.
033900170809       //--------------------------------------------------------------
034000170809       BEGSR F06D01;
034100170809
034200170809         exec sql
034300170809         DECLARE orm insensitive no scroll cursor for
034400170809         SELECT fnorm01l.*
034500170809         FROM fnorm01l JOIN fnorg01l on
034600170809         ormpoe = orgpoe and ormnsr = orgnsr and ormnor = orgnor and
034700170809         ormnrv = orgnrv
034800170809         WHERE ormpor = :v01fil and ormfao < 600  and
034900170809         ormdao < :wdata and ormnsr = 0;
035000170809
035100170809         exec sql
035200170809         OPEN orm;
035300170809         IF  sqlcode < 0;
035400170809           wEnd = *on;
035500170809         ENDIF;
035600170809
035700170809       //?Recupero il numero totali di codici che dovrò leggere
035800170809         exec sql
035900170809          GET DIAGNOSTICS :wnrr = DB2_NUMBER_ROWS;
036000170809
036100170809         IF  wnrr = *zeros;
036200170809           exec sql CLOSE orm;
036300170809           ErrMessage  = *on;
036400170809           ErrGenerico = *on;
036500170809           V01msg = Msg(02);
036600170809           leavesr;
036700170809         ENDIF;
036800170809
036900170809         wInzD02 = *on;
037000170809         wVideo = 'D2';
037100170809
037200170809       ENDSR;
037300170809
037400170809       //--------------------------------------------------------------
037500170809       //?Gestione videata D02.
037600170809       //--------------------------------------------------------------
037700170809       BEGSR GesD02;
037800170809
037900170809       //?Inizializzazione videata
038000170809         IF  wInzD02;
038100170809           exsr InzD02;
038200170809           wInzD02  = *off;
038300170809         ENDIF;
038400170809
038500170809       //?Emissione videata
038600170809         write OR92T00;
038700170809         write OR92Z02;
038800170809         write OR92D01;
038900170809         exfmt OR92D02;
039000170809         reset ErrMessage;
039100170809         reset ErrGenerico;
039200170809
039300170809         SELECT;
039400170809
039500170809       //?- F03=Fine
039600170809           WHEN  dsp_aid = c_F03;
039700170809             exsr F03D01;
039800170809
039900170809       //?- F06=Conferma
040000170809           WHEN  dsp_aid = c_F06;
040100170809             exsr F06D02;
040200170809
040300170809       //?- F12=Ritorno
040400170809           WHEN  dsp_aid = c_F12;
040500170809             exsr F12D02;
040600170809
040700170809         ENDSL;
040800170809
040900170809       ENDSR;
041000170809
041100170809       //--------------------------------------------------------------
041200170809       //?Inizializzazione videata D02.
041300170809       //--------------------------------------------------------------
041400170809       BEGSR InzD02;
041500170809
041600170809         V02nrr = wnrr;
041700170809
041800170809       ENDSR;
041900170809
042000170809       //--------------------------------------------------------------
042100170809       //?F06 Conferma.
042200170809       //--------------------------------------------------------------
042300170809       BEGSR F06D02;
042400170809
042500170809         DOW  not wEnd;
042600170809           exec sql
042700170809           FETCH NEXT from orm into :fnormds;
042800170809           IF  sqlcod = 100 or sqlcod < 0;
042900170809             wEnd = *on;
043000170809             leave;
043100170809           ENDIF;
043200170809
043300170809           exsr sr_sistema;
043400170809
043500170809         ENDDO;
043600170809
043700170809         exec sql
043800170809         CLOSE orm;
043900170809
044000170809       //?Fine
044100170809         wFine = *on;
044200170809
044300170809       ENDSR;
044400170809
044500170809       //--------------------------------------------------------------
044600170809       //? sistemo i dati degli ORM
044700170809       //--------------------------------------------------------------
044800170809       BEGSR sr_sistema;
044900170809
045000170809         chain (w_ormpoe:w_ormnsr:w_ormnor:w_ormnrv) FNORG01L;
045100170809         IF  %found(FNORG01L);
045200170809           ORGpor = wfiliale;
045300170809           clear ORGtgi;
045400170809           clear ORGpocgi;
045500170809           clear ORGcgi;
045600170809           clear ORGdtvtel;
045700170809           clear ORGhvtel;
045800170809           UPDATE fnorg000;
045900170809         ENDIF;
046000170809
046100170809         chain (w_ormpoe:w_ormnsr:w_ormnor:w_ormnrv) FNORM01L;
046200170809         IF  %found(FNORM01L);
046300170809           ORMpor = wfiliale;
046400170809           UPDATE fnorm000;
046500170809         ENDIF;
046600170809
046700170809       ENDSR;
046800170809
046900170809       //--------------------------------------------------------------
047000170809       //?F12-Ritorno.
047100170809       //--------------------------------------------------------------
047200170809       BEGSR F12D02;
047300170809
047400170809         exec sql
047500170809         CLOSE orm;
047600170809         wVideo = 'D1';
047700170809
047800170809       ENDSR;
047900170809
048000170809       //--------------------------------------------------------------
048100170809       //?Operazioni finali.
048200170809       //--------------------------------------------------------------
048300170809       BEGSR RoutEnd;
048400170809
048500170809         *inLR = *on;
048600170809         return;
048700170809
048800170809       ENDSR;
048900170809
049000170809      /end-free
049100170809
049200170809       //--------------------------------------------------------------
049300170809       //?Schiere a tempo di compilazione.
049400170809       //--------------------------------------------------------------
049500170809
049600170809** - MSG --------------------------------------------------------------------*
049700170809Filiale ritiro errata.                                                         1
049800170809Non ci sono ritiri da sistemare per la filiale richiesta.                      2
049900170809Data errata.                                                                   3
050000170809Filiale non presente in £6.                                                    4
