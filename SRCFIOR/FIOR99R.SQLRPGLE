000100091021      //---------------------------------------------------------------
000200091021      //
000300091021      //      Sistema dati per ORM assegnati a mezzo
000400091021      //
000500091021      //---------------------------------------------------------------
000600091021
000700091021     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800091021
000900091021      //---------------------------------------------------------------
001000091021      //?Dichiarazione file.
001100091021      //---------------------------------------------------------------
001200091021
001300140721     fAZORG01L  if   e           k disk
001400140721     fFNORG01L  uf   e           k disk
001500140721     fFIOR99D   cf   e             workstn indds(IndDspF)
001600140722     f                                     infds(InfDspF)
001700091021
001800091021      //---------------------------------------------------------------
001900091021      //?Definizione costanti.
002000091021      //---------------------------------------------------------------
002100091021
002200091021      //---------------------------------------------------------------
002300091021      //?Definizione schiere.
002400091021      //---------------------------------------------------------------
002500140721
002600140721      // - Tasti funzionali a video
002700140721     d c_F01           c                   const(x'31')
002800140721     d c_F02           c                   const(x'32')
002900140721     d c_F03           c                   const(x'33')
003000140721     d c_F04           c                   const(x'34')
003100140721     d c_F05           c                   const(x'35')
003200140721     d c_F06           c                   const(x'36')
003300140721     d c_F07           c                   const(x'37')
003400140721     d c_F08           c                   const(x'38')
003500140721     d c_F09           c                   const(x'39')
003600140721     d c_F10           c                   const(x'3A')
003700140721     d c_F11           c                   const(x'3B')
003800140721     d c_F12           c                   const(x'3C')
003900140721     d c_F13           c                   const(x'B1')
004000140721     d c_F14           c                   const(x'B2')
004100140721     d c_F15           c                   const(x'B3')
004200140721     d c_F16           c                   const(x'B4')
004300140721     d c_F17           c                   const(x'B5')
004400140721     d c_F18           c                   const(x'B6')
004500140721     d c_F19           c                   const(x'B7')
004600140721     d c_F20           c                   const(x'B8')
004700140721     d c_F21           c                   const(x'B9')
004800140721     d c_F22           c                   const(x'BA')
004900140721     d c_F23           c                   const(x'BB')
005000140721     d c_F24           c                   const(x'BC')
005100140721     d c_Enter         c                   const(x'F1')
005200140721     d c_RollDown      c                   const(x'F4')
005300140721     d c_RollUp        c                   const(x'F5')
005400140721
005500140721     d Digits          c                   const('0123456789')
005600140721
005700140721      //---------------------------------------------------------------
005800140721      //?Definizione schiere.
005900140721      //---------------------------------------------------------------
006000140721
006100140721      // - Messaggi di errore
006200140721     d wMsg            s             78    dim(20) ctdata perrcd(1)
006300091021
006400091021      //---------------------------------------------------------------
006500091021      //?Definizione aree dati.
006600091021      //---------------------------------------------------------------
006700140806      // - Dati utente
006800140806     d §AzUte        e ds                  extname(AZUTE00F)
006900140806     d                                     dtaara
007000140806     d §DatiUte      e ds                  extname(dDatiUte)
007100140806     d                                     dtaara
007200091021
007300091021      //---------------------------------------------------------------
007400091021      //?Definizione strutture dati.
007500091021      //---------------------------------------------------------------
007600140721
007700140721      // - Status
007800140721     d Psds           sds
007900140721     d   SDSpgm          *proc
008000140721
008100140721      // - InfDS
008200140721     d InfDspF         ds
008300140721     d  dsp_aid              369    369a
008400140721
008500140721      // - Indicatori su DspF
008600140721     d IndDspF         ds
008700140721        // - Indicatori di errore in videata
008800140721     d  ErrMessage                    1n   overlay(IndDspF : 28)
008900140721        // - Indicatori di errore
009000140721     d  PosCurFil                     1n   overlay(IndDspF : 50)
009100140721        // - Indicatori di errore generico
009200140721     d  ErrGenerico                   1n   overlay(IndDspF : 99)
009300140721
009400140721     d WindDspF        ds                  inz
009500140721     d   WindDspFa             1     49    inz(*zero)
009600140721     d   WindDspFb            50     99    inz(*zero)
009700140721
009800140721     d fnormds       e ds                  extname(FNORM00F)
009900140721     d kpjba         e ds
010000140806
010100140806      // - Reperimento dati utente
010200140806     d TIBS34ds      e ds
010300091021
010400091021      //---------------------------------------------------------------
010500091021      //?Definizione variabili globali.
010600091021      //---------------------------------------------------------------
010700091021      // - Flags booleani
010800140721     d wEnd            s               n   inz(*off)
010900140721     d wFine           s               n   inz(*off)
011000140806     d wInzD01         s               n   inz(*on)
011100140806     d wInzD02         s               n   inz(*off)
011200140721
011300140721      // - Campi associati al video
011400140806     d wVideo          s              2    inz('D1')
011500140806
011600140806      // - Campi di comodo
011700140806     d db2NumberRows   s             31p 0 inz
011800140806     d wnrr            s              5s 0 inz
011900091021
012000091021      //---------------------------------------------------------------
012100091021      //?Definizione procedure esterne.
012200091021      //---------------------------------------------------------------
012300140806
012400140806      //---------------------------------------------------------------
012500140806      //?Definizione prototipi.
012600140806      //---------------------------------------------------------------
012700140806      /copy gaitrasrc/srcprotopr,tibs34r
012800091021
012900091021      //---------------------------------------------------------------
013000091021      //?Definizione key-list.
013100091021      //---------------------------------------------------------------
013200091021
013300091021      //---------------------------------------------------------------
013400091021      //?Main.
013500091021      //---------------------------------------------------------------
013600140721
013700140721     c     *entry        plist
013800140721     c                   parm                    kpjba
013900091021
014000091021      /free
014100140721
014200140721       //?Operazioni iniziali
014300140721       exsr RoutInz;
014400140721
014500140721       //?Gestione video
014600140721       DOW wFine = *off;
014700140721         SELECT;
014800140806           WHEN wVideo = 'D1';
014900140806             exsr GesD01;
015000140806           WHEN wVideo = 'D2';
015100140806             exsr GesD02;
015200140721           OTHER;
015300140721             wFine = *on;
015400140721         ENDSL;
015500140721       ENDDO;
015600140721
015700140721       //?Operazioni finali
015800140721       exsr RoutEnd;
015900140721
016000140721       //--------------------------------------------------------------
016100140721       //?Operazioni iniziali.
016200140721       //--------------------------------------------------------------
016300140721       BEGSR RoutInz;
016400140806
016500140806       //?Impostazione campi "fissi"
016600140806         V00pgm = SDSpgm;
016700140806
016800140806       //?Reperimento dati job
016900140806         exsr DatiJob;
017000140806
017100140806         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
017200140721
017300140721       ENDSR;
017400140806
017500140806       //--------------------------------------------------------------
017600140806       //?Reperimento Dati del job (Utente/Operativi).
017700140806       //--------------------------------------------------------------
017800140806       BEGSR DatiJob;
017900140806
018000140806         in(E) §AzUte;
018100140806         IF  NOT %error;
018200140806           in(E) §DatiUte;
018300140806         ENDIF;
018400140806         IF  %error or RSut = *blanks;
018500140806           clear TIBS34ds;
018600140806           tibs34r(tibs34ds);
018700140806           in §AzUte;
018800140806           in §DatiUte;
018900140806         ENDIF;
019000140806
019100140806       ENDSR;
019200140721
019300140721       //--------------------------------------------------------------
019400140806       //?Gestione videata D01.
019500140721       //--------------------------------------------------------------
019600140806       BEGSR GesD01;
019700140721
019800140721       //?Inizializzazione videata
019900140806         IF  wInzD01;
020000140806           exsr InzD01;
020100140806           wInzD01  = *off;
020200140721         ENDIF;
020300140721
020400140721       //?Emissione videata
020500140806         write  OR99T00;
020600140806         write  OR99Z01;
020700140806         exfmt  OR99D01;
020800140721         reset ErrMessage;
020900140721         reset ErrGenerico;
021000140806         clear V01msg;
021100140721
021200140721         SELECT;
021300140721
021400140721       //?- F03=Fine
021500140721           WHEN  dsp_aid = c_F03;
021600140806             exsr F03D01;
021700140721
021800140721       //?- F06=Conferma
021900140721           WHEN  dsp_aid = c_F06;
022000140806             exsr F06D01;
022100140806             IF  ErrGenerico;
022200140806               leavesr;
022300140806             ENDIF;
022400140721
022500140721       //?Invio
022600140721           OTHER;
022700140806             exsr CtrD01;
022800140721             IF  ErrGenerico;
022900140721               leavesr;
023000140721             ENDIF;
023100140721
023200140721         ENDSL;
023300140721
023400140721       ENDSR;
023500140721
023600140721       //--------------------------------------------------------------
023700140806       //?Inizializzazione videata D01.
023800140721       //--------------------------------------------------------------
023900140806       BEGSR InzD01;
024000140721
024100140806         clear V01fil;
024200140806         clear V01fild;
024300140721
024400140721       ENDSR;
024500140721
024600140721       //--------------------------------------------------------------
024700140806       //?Controllo videata D01.
024800140721       //--------------------------------------------------------------
024900140806       BEGSR CtrD01;
025000140721
025100140806         IF  V01fil = 0;
025200140721           ErrMessage  = *on;
025300140721           ErrGenerico = *on;
025400140721           PosCurFil   = *on;
025500140806           V01msg = wMsg(01);
025600140721           leavesr;
025700140721         ENDIF;
025800140721
025900140806         chain V01fil AZORG01L;
026000140721         IF  not %found(AZORG01L);
026100140721           ErrMessage  = *on;
026200140721           ErrGenerico = *on;
026300140721           PosCurFil   = *on;
026400140806           V01msg = wMsg(01);
026500140721           leavesr;
026600140721         ENDIF;
026700140806
026800140806         V01fild = ORGdes;
026900140721
027000140721       ENDSR;
027100140721
027200140721       //--------------------------------------------------------------
027300140721       //?F03-Fine Lavoro.
027400140721       //--------------------------------------------------------------
027500140806       BEGSR F03D01;
027600140721
027700140721         exsr RoutEnd;
027800140721
027900140721       ENDSR;
028000140721
028100140721       //--------------------------------------------------------------
028200140721       //?F06-Conferma.
028300140721       //--------------------------------------------------------------
028400140806       BEGSR F06D01;
028500140721
028600140721         exec sql
028700140806         DECLARE orm insensitive no scroll cursor for
028800140721         SELECT fnorm01l.*
028900140721         FROM fnorm01l JOIN fnorg01l on
029000140721         ormpoe = orgpoe and ormnsr = orgnsr and ormnor = orgnor and
029100140721         ormnrv = orgnrv
029200140806         WHERE ormpor = :v01fil and ormfao = 100  and
029300140806         orgndc > 0 and orgfgs = :v01fil and ormndc = 0;
029400091021
029500140721         exec sql
029600140721         OPEN orm;
029700140721         IF  sqlcode < 0;
029800140721           wEnd = *on;
029900140721         ENDIF;
030000140806
030100140806       //?Recupero il numero totali di codici che dovrò leggere
030200140806         exec sql
030300140806          GET DIAGNOSTICS :wnrr = DB2_NUMBER_ROWS;
030400140806
030500140806         IF  wnrr = *zeros;
030600140806           exec sql CLOSE orm;
030700140806           ErrMessage  = *on;
030800140806           ErrGenerico = *on;
030900140806           V01msg = wMsg(02);
031000140806           leavesr;
031100140806         ENDIF;
031200140806
031300140806         wInzD02 = *on;
031400140806         wVideo = 'D2';
031500140806
031600140806       ENDSR;
031700140806
031800140806       //--------------------------------------------------------------
031900140806       //?Gestione videata D02.
032000140806       //--------------------------------------------------------------
032100140806       BEGSR GesD02;
032200140806
032300140806       //?Inizializzazione videata
032400140806         IF  wInzD02;
032500140806           exsr InzD02;
032600140806           wInzD02  = *off;
032700140806         ENDIF;
032800140806
032900140806       //?Emissione videata
033000140806         write  OR99T00;
033100140806         write  OR99Z02;
033200140806         write  OR99D01;
033300140806         exfmt  OR99D02;
033400140806         reset ErrMessage;
033500140806         reset ErrGenerico;
033600140806
033700140806         SELECT;
033800140806
033900140806       //?- F03=Fine
034000140806           WHEN  dsp_aid = c_F03;
034100140806             exsr F03D01;
034200140806
034300140806       //?- F06=Conferma
034400140806           WHEN  dsp_aid = c_F06;
034500140806             exsr F06D02;
034600140806
034700140806       //?- F12=Ritorno
034800140806           WHEN  dsp_aid = c_F12;
034900140806             exsr F12D02;
035000140806
035100140806         ENDSL;
035200140806
035300140806       ENDSR;
035400140806
035500140806       //--------------------------------------------------------------
035600140806       //?Inizializzazione videata D02.
035700140806       //--------------------------------------------------------------
035800140806       BEGSR InzD02;
035900140806
036000140806         V02nrr = wnrr;
036100140806
036200140806       ENDSR;
036300140806
036400140806       //--------------------------------------------------------------
036500140806       //?F06-Conferma.
036600140806       //--------------------------------------------------------------
036700140806       BEGSR F06D02;
036800091021
036900140721         DOW  not wEnd;
037000140721           exec sql
037100140721           FETCH NEXT from orm into :fnormds;
037200140721           IF  sqlcod = 100 or sqlcod < 0;
037300140721             wEnd = *on;
037400140721             leave;
037500140721           ENDIF;
037600091021
037700140721           exsr sr_sistema;
037800091021
037900140721         ENDDO;
038000091021
038100140721         exec sql
038200140721         CLOSE orm;
038300140721
038400140721       //?Fine
038500140721         wFine = *on;
038600140721
038700140721       ENDSR;
038800070927
038900091021       //--------------------------------------------------------------
039000091021       //? sistemo i dati degli ORM
039100091021       //--------------------------------------------------------------
039200091021       BEGSR sr_sistema;
039300091021
039400091021         chain (ormpoe:ormnsr:ormnor:ormnrv) fnorg01l;
039500091021         IF  %found(fnorg01l);
039600091021           clear orgpdc;
039700091021           clear orgfgs;
039800091021           clear orgndc;
039900091021           clear orgddc;
040000091021           clear orgnftl;
040100091021           clear orgslo;
040200091021           clear orgdtvdis;
040300091021           clear orghvdis;
040400091021           UPDATE fnorg000;
040500091021         ENDIF;
040600091021
040700091021       ENDSR;
040800140806
040900140806       //--------------------------------------------------------------
041000140806       //?F12-Ritorno.
041100140806       //--------------------------------------------------------------
041200140806       BEGSR F12D02;
041300140806
041400140806         exec sql
041500140806         CLOSE orm;
041600140806         wVideo = 'D1';
041700140806
041800140806       ENDSR;
041900140721
042000140721       //--------------------------------------------------------------
042100140721       //?Operazioni finali.
042200140721       //--------------------------------------------------------------
042300140721       BEGSR RoutEnd;
042400140721
042500140721         *inLR = *on;
042600140721         return;
042700140721
042800140721       ENDSR;
042900140806
043000140806      /end-free
043100140806
043200140806       //--------------------------------------------------------------
043300140806       //?Schiere a tempo di compilazione.
043400140806       //--------------------------------------------------------------
043500140806
043600140806** - wMSG -------------------------------------------------------------------*
043700140806Filiale ritiro errata.                                                         1
043800140806Non ci sono ritiri da sistemare per la filiale richiesta.                      2
