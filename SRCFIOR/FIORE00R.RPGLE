000100160526      //--------------------------------------------------------------
000200160526      //?FIORE00R - Torna Orari Servizio per Ritiri Esteri
000300160526      //--------------------------------------------------------------
000400160526     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000500160526
000600160526      //---------------------------------------------------------------
000700160526      //?Dichiarazione file.
000800160526      //---------------------------------------------------------------
000900160526
001000160526      //---------------------------------------------------------------
001100160526      //?Definizione costanti.
001200160526      //---------------------------------------------------------------
001300160526
001400160526      //---------------------------------------------------------------
001500160526      //?Definizione schiere.
001600160526      //---------------------------------------------------------------
001700160526      // - Messaggi di errore
001800160526     d Msg             s             78    dim(10) ctdata perrcd(1)
001900160526
002000160526      //---------------------------------------------------------------
002100160526      //?Definizione aree dati.
002200160526      //---------------------------------------------------------------
002300160526      // - Dati utente
002400160526     d §AzUte        e ds                  extname(AZUTE00F)
002500160526     d                                     dtaara
002600160526     d §DatiUte      e ds                  extname(dDatiUte)
002700160526     d                                     dtaara
002800160526
002900160526      //---------------------------------------------------------------
003000160526      //?Definizione strutture dati.
003100160526      //---------------------------------------------------------------
003200160526      // - Parametri ricevuti
003300160526     d KPJBA         e ds
003400160526     d FIORE00DS     e ds
003500160526
003600160526      // - Ricerca/Controllo tabelle
003700160526     d TIBS02DS      e ds                  inz
003800160526     d  T02mod       e                     inz('C')
003900160526     d  T02cod       e                     inz('EOR')
004000160526
004100160526      // - Reperimento dati utente
004200160526     d TIBS34DS      e ds
004300160526
004400160526      // - Tabella EOR
004500160526     d dEOR          e ds                  inz
004600160526
004700160526      //---------------------------------------------------------------
004800160526      //?Definizione variabili globali.
004900160526      //---------------------------------------------------------------
005000160526      // - Flags booleani
005100160526     d Fine            s               n   inz(*off)
005200160526     d wEnd            s               n   inz(*off)
005300160526
005400160526      // - Campi di comodo data
005500160526     d Data_EUR        s               d   datfmt(*eur)
005600160526     d Data_ISO        s               d   datfmt(*iso)
005700160526
005800160526      // - Campi di comodo
005900160526     d Oggi            s              8s 0 inz
006000160526
006100160526      //---------------------------------------------------------------
006200160526      //?Definizione Procedure usate.
006300160526      //---------------------------------------------------------------
006400160526
006500160526      //---------------------------------------------------------------
006600160526      //?Definizione Prototipi.
006700160526      //---------------------------------------------------------------
006800160526      /copy gaitrasrc/srcprotopr,TIBS02R
006900160526      /copy gaitrasrc/srcprotopr,TIBS34R
007000160526
007100160526      //---------------------------------------------------------------
007200160526      //?Definizione key-list.
007300160526      //---------------------------------------------------------------
007400160526
007500160526      //---------------------------------------------------------------
007600160526      //?M A I N - L I N E
007700160526      //---------------------------------------------------------------
007800160526
007900160526     c     *Entry        plist
008000160526     c                   parm                    FIORE00DS
008100160526
008200160526      /free
008300160526
008400160526       //?Operazioni iniziali
008500160526       exsr RoutInz;
008600160526
008700160526       //?Controlla dati ricevuti
008800160526       exsr CtrDati;
008900160526
009000160526       //?Elabora
009100160526       IF  not Fine;
009200160526         exsr Elabora;
009300160526       ENDIF;
009400160526
009500160526       //?Operazioni finali
009600160526       exsr RoutEnd;
009700160526
009800160526       //--------------------------------------------------------------
009900160526       //?Operazioni iniziali.
010000160526       //--------------------------------------------------------------
010100160526       BEGSR RoutInz;
010200160526
010300160526       //?Reperimento dati job
010400160526         exsr DatiJob;
010500160526
010600160526       //?Imposto oggi
010700160526         Oggi = %dec(%date());
010800160526
010900160526         clear OORE00err;
011000160526         clear OORE00msg;
011100160526
011200160526       ENDSR;
011300160526
011400160526       //--------------------------------------------------------------
011500160526       //?Reperimento Dati del job (Utente/Operativi).
011600160526       //--------------------------------------------------------------
011700160526       BEGSR DatiJob;
011800160526
011900160526         in(E) §AzUte;
012000160526         IF  NOT %error;
012100160526           in(E) §DatiUte;
012200160526         ENDIF;
012300160526         IF  %error or RSut = *blanks;
012400160526           clear TIBS34ds;
012500160526           tibs34r(tibs34ds);
012600160526           in §AzUte;
012700160526           in §DatiUte;
012800160526         ENDIF;
012900160526
013000160526       ENDSR;
013100160526
013200160526       //--------------------------------------------------------------
013300160526       //?Controllo i dati ricevuti.
013400160526       //--------------------------------------------------------------
013500160526       BEGSR CtrDati;
013600160526
013700160526       //?Filiale Ritiro
013800160526         IF  IORE00por = 0;
013900160526           OORE00err = '1';
014000160526           OORE00msg = Msg(01);
014100160526           Fine = *on;
014200160526           leavesr;
014300160526         ENDIF;
014400160526
014500160526       //?Nazione
014600160526         IF  IORE00nar = *blanks;
014700160526           OORE00err = '1';
014800160526           OORE00msg = Msg(02);
014900160526           Fine = *on;
015000160526           leavesr;
015100160526         ENDIF;
015200160526
015300160526       //?Aggancio la tabella Standard
015400160526         clear dEOR;
015500160526         reset TIBS02DS;
015600160526         T02ke1 = '999';
015700160526         clear T02ke2;
015800160526         TNTBE_RicercaControllo (kpjba:tibs02ds);
015900160526         IF  T02err <> *blanks;
016000160526           OORE00err = '1';
016100160526           OORE00msg = Msg(03);
016200160526           Fine = *on;
016300160526           leavesr;
016400160526         ENDIF;
016500160526         dEOR = T02uni;
016600160526
016700160526       ENDSR;
016800160526
016900160526       //--------------------------------------------------------------
017000160526       //?Elabora.
017100160526       //--------------------------------------------------------------
017200160526       BEGSR Elabora;
017300160526
017400160526       //?Come prima cosa aggancio la tabella
017500160526       //?con Filiale Ritiro e Nazione
017600160526         reset TIBS02DS;
017700160526         T02ke1 = %editc(IORE00por:'X');
017800160526         T02ke2 = IORE00nar;
017900160526         TNTBE_RicercaControllo (kpjba:tibs02ds);
018000160526         IF  T02err = *blanks;
018100160526           clear dEOR;
018200160526           dEOR = T02uni;
018300160526           leavesr;
018400160526         ENDIF;
018500160526
018600160526       //?Se non trovo per Filiale Ritiro e Nazione
018700160526       //?Provo solo con Filiale Ritiro
018800160526         reset TIBS02DS;
018900160526         T02ke1 = %editc(IORE00por:'X');
019000160526         clear T02ke2;
019100160526         TNTBE_RicercaControllo (kpjba:tibs02ds);
019200160526         IF  T02err = *blanks;
019300160526           clear dEOR;
019400160526           dEOR = T02uni;
019500160526           leavesr;
019600160526         ENDIF;
019700160526
019800160526       ENDSR;
019900160526
020000160526       //--------------------------------------------------------------
020100160526       //?Operazioni finali.
020200160526       //--------------------------------------------------------------
020300160526       BEGSR RoutEnd;
020400160526
020500160526         OORE00min = §EORmin;
020600160526         OORE00max = §EORmax;
020700160526         OORE00lrg = §EORlrg;
020800160526
020900160526         *inLR = *on;
021000160526         return;
021100160526
021200160526       ENDSR;
021300160526
021400160526      /end-free
021500160526
021600160526       //--------------------------------------------------------------
021700160526       //?Schiere a tempo di compilazione.
021800160526       //--------------------------------------------------------------
021900160526
022000160526** -- MSG -------------------------------------------------------------------*
022100160526Filiale Ritiro non Passata                                                    01
022200160526Nazione Ritiro non Passata                                                    02
022300160526Tabella EOR generica non Trovata                                              03
