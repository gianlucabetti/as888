000100060331      //********************************************************************************************
000200060330      //
000300060914      // Questo programma visualizza l'elenco delle regole dei numeratori AZNMRR00F.
000400060330      //
000500060330      //********************************************************************************************
000600060921     H DFTACTGRP(*NO) ACTGRP('NUMERATORI')
000700060915     H BNDDIR('PJXBND':'QC2LE':'TIBS')
000800060207     H DATEDIT(*YMD) DECEDIT(*JOBRUN)
000900060127
001000060330      //********************************************************************************************
001100060330      //
001200060330      // Definizione files.
001300060330      //
001400060330      //********************************************************************************************
001500060914     Ftibs2620d CF   E             WORKSTN
001600060320     F                                     USROPN
001700060130     F                                     INFDS(infDspF)
001800060127     F                                     INDDS(indDspF)
001900060130     F                                     SFILE(s01:s01Rrn)
002000060127
002100060330      //********************************************************************************************
002200060330      //
002300060330      // Definizione costanti.
002400060330      //
002500060330      //********************************************************************************************
002600060127     D F3              C                   X'33'
002700060127     D F5              C                   X'35'
002800060511     D F6              C                   X'36'
002900060427     D F10             C                   X'3A'
003000060127     D F12             C                   X'3C'
003100060127     D Enter           C                   X'F1'
003200060403     D Normal          C                   X'20'
003300060202     D ReverseImage    C                   X'21'
003400060404     D HighIntensity   C                   X'22'
003500060314     D Blink           C                   X'28'
003600060414     D RighePagina     C                   15
003700060414     D OpzScelta...
003800060414     D                 C                   1
003900060414     D OpzModifica...
004000060414     D                 C                   2
004100060427     D OpzCopia...
004200060403     D                 C                   3
004300060427     D OpzVisualizza...
004400060427     D                 C                   5
004500060921     D OpzNumeratori...
004600060915     D                 C                   11
004700060509     D OpzCommenti...
004800060509     D                 C                   14
004900060511     D OpzCancella...
005000060511     D                 C                   44
005100060404
005200060330      //********************************************************************************************
005300060330      //
005400060330      // Definizione delle procedure esterne usate.
005500060330      //
005600060330      //********************************************************************************************
005700060222     D xSoc            PR
005800060222     D                                     EXTPROC('XSOC')
005900060222     D  tipXsc                        6A
006000060222     D                                     CONST
006100060222     D  socXsc
006200060222     D                                     LIKE(pjzSocieta)
006300060222     D  cdsXsc                        9P 0
006400060222     D                                     CONST
006500060222     D  modXsc                        3A
006600060222     D                                     CONST
006700060222     D  rtnXsc                        1A
006800060921     D  xSoc001DS
006900060921     D                                     LIKEDS(xSoc001DS)
007000060222     D  kpjba
007100060222     D                                     LIKEDS(kpjba)
007200060921     D xChkAut         PR
007300060921     D                                     EXTPROC('XCHKAUT')
007400060921     D  xChkAutDS
007500060921     D                                     LIKEDS(xChkAutDS)
007600061013     D x58Com          PR
007700061013     D                                     EXTPROC('X58COM')
007800061013     D  x58ComDS
007900061013     D                                     LIKEDS(x58ComDS)
008000060331     D tibs34r         PR
008100060131     D                                     EXTPGM('TIBS34R')
008200060131     D  tibs34ds
008300060131     D                                     LIKEDS(tibs34ds)
008400060426     D atoi            PR            10I 0
008500060222     D                                     EXTPROC('atoi')
008600060222     D  char                           *
008700060222     D                                     VALUE
008800060222     D                                     OPTIONS(*STRING)
008900060509     D ana725r         PR
009000060509     D                                     EXTPGM('ANA725R')
009100060509     D  kpjba
009200060509     D                                     LIKEDS(kpjba)
009300060512     D displayLongText...
009400060512     D                 PR
009500060512     D                                     EXTPGM('QUILNGTX')
009600060512     D  textString...
009700060512     D                              256A
009800060512     D                                     CONST
009900060512     D                                     OPTIONS(*VARSIZE)
010000060512     D  lengthOfTextString...
010100060512     D                               10I 0
010200060512     D                                     CONST
010300060512     D  messageID...
010400060512     D                                7A
010500060512     D                                     CONST
010600060512     D  qualifiedMessageFileName...
010700060512     D                               20A
010800060512     D                                     CONST
010900060512     D  errorCode...
011000060512     D                                     LIKE(qusec)
011100060512     D                                     OPTIONS(*VARSIZE)
011200060921     D tibs2631r       PR
011300060921     D                                     EXTPGM('TIBS2631R')
011400060921     D  kpjba
011500060921     D                                     LIKEDS(kpjba)
011600060927     D tibs2640r       PR
011700060927     D                                     EXTPGM('TIBS2640R')
011800060927     D  kpjba
011900060927     D                                     LIKEDS(kpjba)
012000060512
012100060330      //********************************************************************************************
012200060330      //
012300060330      // Definizione strutture dati.
012400060330      //
012500060330      //********************************************************************************************
012600060330     D psds           SDS
012700060131     D  pgmName          *PROC
012800060130     D infDspF         DS
012900060222     D  dsp_aid              369    369A                                        AID byte
013000060206     D  sf_rrn               376    377I 0                                      Subfile rrn
013100060206     D indDspF         DS
013200060130     D  sflDsp                 1      1N
013300060130     D  sflClr                 2      2N
013400060222     D  sflEnd                 3      3N
013500060926     D  errMsgOpzione         30     30N
013600060427     D  errGenerico           99     99N
013700060404     D kpjba         E DS
013800060921     D xSoc001DS     E DS
013900060414     D                                     INZ
014000060921     D xChkAutDS     E DS
014100060921     D                                     INZ
014200060921     D  xcaFnc       E
014300060921     D                                     INZ('YAZNMR')
014400060921     D  xcaVfu       E
014500060926     D                                     INZ(*ZERO)
014600060921     D  xcaTck       E
014700060921     D                                     INZ('CK')
014800060921     D  xcaNau       E
014900060921     D                                     INZ('1')
015000061013     D x58ComDS      E DS
015100061013     D                                     INZ
015200061013     D  x58Inz       E
015300061013     D                                     INZ(*ON)
015400060414     D cndizion      E DS
015500060130     D                                     BASED(nullPtr)
015600060130     D                                     PREFIX(diz)
015700060222     D andiz00f      E DS
015800060222     D                                     BASED(nullPtr)
015900060222     D                                     PREFIX(pjz)
016000060914     D tibs2620s     E DS
016100060914     D                                     INZ
016200060914     D                                     QUALIFIED
016300060921     D tibs2631s     E DS
016400060921     D                                     INZ
016500060921     D                                     QUALIFIED
016600060927     D tibs2640s     E DS
016700060927     D                                     INZ
016800060927     D                                     QUALIFIED
016900060414     D tibs34ds      E DS
017000060414     D                                     INZ
017100060914     D aznmrr00f     E DS
017200060427     D                                     INZ
017300060509     D ana725ds      E DS
017400060509     D                                     INZ
017500060509     D  tpa725       E
017600060921     D                                     INZ('YNU')
017700060509     D  cmt725       E
017800060509     D                                     INZ(*OFF)
017900060131
018000060330      //********************************************************************************************
018100060330      //
018200060330      // Definizione variabili.
018300060330      //
018400060330      //********************************************************************************************
018500060512     D/COPY QSYSINC/QRPGLESRC,QCAPCMD
018600060512     D/COPY QSYSINC/QRPGLESRC,QUSEC
018700060512     D nullPtr         S               *
018800060130     D opCode          S             10
018900060221     D                                     INZ('INZC01')
019000060414     D rtnXsc          S              1A
019100060414     D s01Rrn          S              5I 0
019200060223     D s01RrnLast      S              5I 0
019300060403     D wrkRrn          S              5I 0
019400060317     D i               S              5I 0
019500060222     D p               S              5I 0
019600060228     D esito           S             10I 0
019700060228     D elementi        S             10I 0
019800060202     D wrkErrS01       S               N
019900060303     D stop            S               N
020000060207     D wrkCsrRrn       S              5I 0
020100060207     D                                     INZ(1)
020200060427     D wrkSqlStm       S            512A
020300060427     D                                     VARYING
020400060427     D oxx             S
020500060427     D                                     LIKE(s01Opz)
020600060511     D                                     DIM(6)
020700060427     D                                     ASCEND
020800060427     D fxx             S
020900060427     D                                     LIKE(dsp_aid)
021000060427     D                                     DIM(4)
021100060427     D                                     ASCEND
021200060512     D textString...
021300060512     D                 S            256A
021400060512     D lengthOfTextString...
021500060512     D                 S             10I 0
021600060512     D                                     INZ(%SIZE(textString))
021700060512     D messageID...
021800060512     D                 S              7A
021900060512     D                                     INZ('BAR0019')
022000060512     D qualifiedMessageFileName...
022100060512     D                 S             20A
022200060512     D                                     INZ('YBARMSG   *LIBL')
022300060512
022400060330      //********************************************************************************************
022500060330      //
022600060330      // Definizione aree dati.
022700060330      //
022800060330      //********************************************************************************************
022900060201     D §azute        E DS
023000060201     D                                     EXTNAME(azute00f)
023100060201     D                                     DTAARA
023200060201     D §DatiUte      E DS
023300060201     D                                     EXTNAME(dDatiUte)
023400060201     D                                     DTAARA
023500060403
023600060330      //********************************************************************************************
023700060330      //
023800060330      // Definizione parametri procedura.
023900060330      //
024000060330      //********************************************************************************************
024100060131     C     *ENTRY        PLIST
024200060131     C                   PARM                    kpjba
024300060127
024400060127      /FREE
024500060130
024600060131       EXSR inzProc;
024700060130
024800060130       DOU opCode = 'END';
024900060130         SELECT;
025000060221           WHEN opCode = 'INZC01';
025100060221             EXSR inzC01;
025200060130           WHEN opCode = 'LODC01';
025300060131             EXSR lodC01;
025400060130           WHEN opCode = 'PUTC01';
025500060131             EXSR putC01;
025600060131           WHEN opCode = 'CHKC01';
025700060427             EXSR chkC01;
025800060427           WHEN opCode = 'RUNC01';
025900060427             EXSR runC01;
026000060914           WHEN opCode = 'NUOVAREGOL';
026100060914             EXSR nuovaRegola;
026200060330           WHEN opCode = 'ERRORE';
026300060512             EXSR errore;
026400060512             opCode = 'END';
026500060512           WHEN opCode = 'END';
026600060512             LEAVE;
026700060130           OTHER;
026800060512             textString = 'Codice operativo ' + %TRIMR(opCode)
026900060512             + ' sconosciuto.';
027000060512             opCode = 'ERRORE';
027100060512         ENDSL;
027200060130       ENDDO;
027300060130
027400060130       EXSR uscita;
027500060323
027600060323       //*******************************************************************************************
027700060323       //
027800060323       // Operazioni iniziali da eseguire una tantum.
027900060323       //
028000060323       //*******************************************************************************************
028100060323       BEGSR *INZSR;
028200060323
028300060330      /END-FREE
028400060330     C/EXEC SQL
028500060330     C+ SET OPTION CLOSQLCSR = *ENDMOD, DYNUSRPRF = *OWNER
028600060330     C/END-EXEC
028700060330      /FREE
028800060330
028900060323         IN(E) §azute;
029000060323         IF NOT %ERROR;
029100060323           IN(E) §DatiUte;
029200060323         ENDIF;
029300060323         IF %ERROR OR rsut = ' ';
029400060323           tibs34r(tibs34ds);
029500060323           IN §azute;
029600060323           IN §DatiUte;
029700060323         ENDIF;
029800060427
029900060323         t01PgmName = pgmName;
030000060407
030100060407       ENDSR;
030200060131
030300060131       //*******************************************************************************************
030400060131       //
030500060131       // Operazioni iniziali.
030600060131       //
030700060131       //*******************************************************************************************
030800060131       BEGSR inzProc;
030900060330
031000060330         RESET opCode;
031100060131
031200060131         EXSR chkParm;
031300060222
031400060222         CLEAR kpjbu;
031500060921         CLEAR xSoc001DS;
031600060921         xSoc('SOC001':xscSoc:0:*BLANK:rtnXsc:xSoc001DS:kpjba);
031700060222         IF rtnXsc = *ON;
031800060928           tibs2620s.rtnCode = 'XSOC';
031900060926           opCode = 'END';
032000060330           LEAVESR;
032100060222         ENDIF;
032200060308
032300060921         // Controllo autorizzazione alla gestione delle regole numeratori.
032400060921         RESET xChkAutDS;
032500060921         xcaSoc = xscSoc;
032600060921         xcaGrp = xscGrp;
032700060921         xcaPrf = kNmUs;
032800060921         xChkAut(xChkAutDS);
032900060921         IF xcaRtn <> 0;
033000060928           tibs2620s.rtnCode = 'XCHKAUT';
033100060921           opCode = 'END';
033200060921           LEAVESR;
033300060921         ENDIF;
033400060921
033500060131       ENDSR;
033600060131
033700060131       //*******************************************************************************************
033800060131       //
033900060131       // Controllo dei parametri ricevuti.
034000060928       // All'inizio di KPJBU c'è tibs2620s.
034100060914       // A seguire ci può essere TIBS2610S oppure TIBS2620S, a seconda che
034200060427       // la chiamata sia fatta per gestire i modelli o per cercare e scegliere un modello.
034300060131       //
034400060131       //*******************************************************************************************
034500060131       BEGSR chkParm;
034600060414
034700060928         tibs2620s = kpjbu;
034800060928         CLEAR tibs2620s.rtnCmd;
034900060928         CLEAR tibs2620s.rtnCode;
035000060928         CLEAR tibs2620s.rtnEsito;
035100060426
035200060426         SELECT;
035300060928           WHEN tibs2620s.opCode = 'GESTIONE';
035400060928           WHEN tibs2620s.opCode = 'RICERCA';
035500060914             CLEAR tibs2620s.codice;
035600060914             CLEAR tibs2620s.rrnAznmrr;
035700060426         ENDSL;
035800060414
035900060131       ENDSR;
036000060221
036100060221       //*******************************************************************************************
036200060221       //
036300060330       // Inizializzo subfile movimenti.
036400060221       //
036500060221       //*******************************************************************************************
036600060221       BEGSR inzC01;
036700060320
036800060330         opCode = 'LODC01';
036900060914         IF NOT %OPEN(tibs2620d);
037000060914           OPEN tibs2620d;
037100060320         ENDIF;
037200060221         sflDsp = *OFF;
037300060221         sflClr = *ON;
037400060221         WRITE c01;
037500060221         sflClr = *OFF;
037600060221         CLEAR s01Rrn;
037700060223         CLEAR s01RrnLast;
037800060221         RESET wrkCsrRrn;
037900060331
038000060221       ENDSR;
038100060201
038200060201       //*******************************************************************************************
038300060201       //
038400060414       // Carico elenco modelli.
038500060201       //
038600060201       //*******************************************************************************************
038700060201       BEGSR lodC01;
038800060201
038900060330         opCode = 'PUTC01';
039000060330
039100060925         wrkSqlStm = 'SELECT RRN(R), R.CODICE, R.DESCRIZION, R.TEMPORIZZA, +
039200060921         IFNULL(N.COUNT, 0)';
039300060921         wrkSqlStm = wrkSqlStm + ' FROM AZNMRR00F R';
039400060921         wrkSqlStm = wrkSqlStm + ' LEFT OUTER JOIN (SELECT N.CODICE, COUNT(*) +
039500060921         COUNT FROM AZNMRN00F N WHERE N.PROGRESSIV >= 0 GROUP BY N.CODICE) +
039600060921         AS N ON R.CODICE = N.CODICE';
039700060921         wrkSqlStm = wrkSqlStm + ' ORDER BY R.CODICE';
039800060427         wrkSqlStm = wrkSqlStm + ' FOR READ ONLY';
039900060426
040000060426      /END-FREE
040100060426     C/EXEC SQL
040200060914     C+ PREPARE REGOLE FROM :wrkSqlStm
040300060426     C/END-EXEC
040400060426     C
040500060426     C/EXEC SQL
040600060914     C+ DECLARE REGOLE CURSOR FOR REGOLE
040700060426     C/END-EXEC
040800060426     C
040900060426     C/EXEC SQL
041000060914     C+ OPEN REGOLE
041100060426     C/END-EXEC
041200060426      /FREE
041300060330
041400060921         IF sqlCode < 0;
041500060928           tibs2620s.rtnCode = 'SQLCODE';
041600060928           tibs2620s.rtnEsito = sqlCode;
041700060928           textString = 'Codice ritorno ' + %TRIMR(tibs2620s.rtnCode)
041800060928           + ' esito ' + %CHAR(tibs2620s.rtnEsito) +
041900060512           '. Premere invio per continuare.';
042000060330           opCode = 'ERRORE';
042100060330           LEAVESR;
042200060330         ENDIF;
042300060330
042400060414         EXSR inzS01;
042500060414
042600060921         DOU sqlCode = 100;
042700060330      /END-FREE
042800060330     C/EXEC SQL
042900060914     C+ FETCH REGOLE
043000060925     C+ INTO :h01RrnNmrR, :codice, :descrizion, :temporizza, :s01Attivi
043100060330     C/END-EXEC
043200060330      /FREE
043300060330           SELECT;
043400060921             WHEN sqlCode = 100;
043500060330               sflEnd = *ON;
043600060330               LEAVE;
043700060921             WHEN sqlCode < 0;
043800060928               tibs2620s.rtnCode = 'SQLCODE';
043900060928               tibs2620s.rtnEsito = sqlCode;
044000060330               opCode = 'ERRORE';
044100060330               LEAVE;
044200060330             OTHER;
044300060330               EXSR setS01;
044400060331               EXSR wrtS01;
044500060330           ENDSL;
044600060330         ENDDO;
044700060330
044800060330      /END-FREE
044900060330     C/EXEC SQL
045000060914     C+ CLOSE REGOLE
045100060330     C/END-EXEC
045200060330      /FREE
045300060330
045400060330         s01RrnLast = s01Rrn;
045500060330
045600060201       ENDSR;
045700060330
045800060330       //*******************************************************************************************
045900060330       //
046000060330       // Inizializzo riga subfile movimenti.
046100060330       //
046200060330       //*******************************************************************************************
046300060330       BEGSR inzS01;
046400060330         CLEAR s01;
046500060330       ENDSR;
046600060330
046700060330       //*******************************************************************************************
046800060330       //
046900060405       // Imposto riga subfile movimenti come definito nel modello.
047000060330       //
047100060330       //*******************************************************************************************
047200060330       BEGSR setS01;
047300061013
047400061013         RESET x58ComDS;
047500061013         x58Societa = xscCpa;
047600061013         x58Cpa = xscCpa;
047700061013         x58Tpi = 'YNU';
047800061013         x58K1i = codice;
047900061013         x58Com(x58ComDS);
048000061013         IF x58Eof = *OFF;
048100061013           s01Comment = xscOn;
048200061013         ELSE;
048300061013           RESET s01Comment;
048400061013         ENDIF;
048500061013
048600060330       ENDSR;
048700060331
048800060331       //*******************************************************************************************
048900060331       //
049000060331       // Scrittura riga subfile movimenti.
049100060331       //
049200060331       //*******************************************************************************************
049300060331       BEGSR wrtS01;
049400060331         s01Rrn += 1;
049500060331         WRITE s01;
049600060331       ENDSR;
049700060130
049800060131       //*******************************************************************************************
049900060131       //
050000060131       // Emissione subfile spedizioni.
050100060131       //
050200060131       //*******************************************************************************************
050300060131       BEGSR putC01;
050400060130
050500060403         opCode = 'PUTC01';
050600060427         RESET oxx;
050700060427         RESET fxx;
050800060427
050900060427         SELECT;
051000060928           WHEN tibs2620s.opCode = 'GESTIONE';
051100060914             c01Opzioni = '2=Modifica  3=Copia  +
051200060921             5=Visualizza  11=Numeratori  14=Commenti  44=Cancella';
051300060427             oxx(1) = OpzModifica;
051400060427             oxx(2) = OpzCopia;
051500060914             oxx(3) = OpzVisualizza;
051600060921             oxx(4) = OpzNumeratori;
051700060915             oxx(5) = OpzCommenti;
051800060915             oxx(6) = OpzCancella;
051900060921             f01Tasti = 'F3=Fine  F5=Ricarica  F10=Nuova regola  +
052000060914             F12=Ritorno';
052100060427             fxx(1) = F3;
052200060427             fxx(2) = F5;
052300060427             fxx(3) = F10;
052400060427             fxx(4) = F12;
052500060928           WHEN tibs2620s.opCode = 'RICERCA';
052600060509             c01Opzioni = '1=Scelta  14=Commenti';
052700060511             oxx(5) = OpzScelta;
052800060511             oxx(6) = OpzCommenti;
052900060427             f01Tasti = 'F3=Fine  F5=Ricarica  F12=Ritorno';
053000060511             fxx(2) = F3;
053100060511             fxx(3) = F5;
053200060511             fxx(4) = F12;
053300060427         ENDSL;
053400060427
053500060131         WRITE t01;
053600060131         WRITE f01;
053700060404
053800060207         SELECT;
053900060207           WHEN wrkCsrRrn > 0;
054000060207             c01RcdNbr = wrkCsrRrn;
054100060207             CLEAR wrkCsrRrn;
054200060207           WHEN c01CsrRrn > 0;
054300060207             c01RcdNbr = c01CsrRrn;
054400060207           OTHER;
054500060207             c01RcdNbr = 1;
054600060207         ENDSL;
054700060131
054800060427         sflDsp = (s01RrnLast > 0);
054900060131         EXFMT c01;
055000060130
055100060928         tibs2620s.rtnCmd = dsp_aid;
055200060130
055300060131         SELECT;
055400060131           WHEN dsp_aid = F3 OR dsp_aid = F12;
055500060414             opCode = 'END';
055600060131           WHEN dsp_aid = F5;
055700060221             opCode = 'INZC01';
055800060427           WHEN dsp_aid = Enter;
055900060131             opCode = 'CHKC01';
056000060427           WHEN dsp_aid = F10;
056100060914             opCode = 'NUOVAREGOL';
056200060206         ENDSL;
056300060130
056400060131       ENDSR;
056500060130
056600060131       //*******************************************************************************************
056700060131       //
056800060427       // Lettura subfile per controlli.
056900060131       //
057000060131       //*******************************************************************************************
057100060427       BEGSR chkC01;
057200060130
057300060403         opCode = 'PUTC01';
057400060427         RESET errGenerico;
057500060207         CLEAR wrkCsrRrn;
057600060303         RESET stop;
057700060130
057800060427         EXSR chkC01Fxx;
057900060427         IF errGenerico;
058000060427           LEAVESR;
058100060427         ENDIF;
058200060427
058300060403         FOR wrkRrn = 1 TO s01RrnLast;
058400060403           CHAIN wrkRrn s01;
058500060403           IF NOT %FOUND;
058600060221             LEAVE;
058700060221           ENDIF;
058800060427           EXSR chkS01;
058900060427           EXSR updS01;
059000060427           IF wrkErrS01;
059100060427             errGenerico = *ON;
059200060427             IF wrkCsrRrn = 0;
059300060427               wrkCsrRrn = s01Rrn;
059400060427             ENDIF;
059500060427           ENDIF;
059600060427           IF stop;
059700060427             LEAVE;
059800060404           ENDIF;
059900060403         ENDFOR;
060000060130
060100060427         IF NOT errGenerico AND dsp_aid = Enter;
060200060427           opCode = 'RUNC01';
060300060131         ENDIF;
060400060130
060500060131       ENDSR;
060600060427
060700060427       //*******************************************************************************************
060800060427       //
060900060427       // Controllo tasto funzionale premuto.
061000060427       //
061100060427       //*******************************************************************************************
061200060427       BEGSR chkC01Fxx;
061300060427
061400060427         IF dsp_aid <> Enter;
061500060427           IF %LOOKUP(dsp_aid:fxx) = 0;
061600060427             errGenerico = *ON;
061700060427           ENDIF;
061800060427         ENDIF;
061900060427
062000060427       ENDSR;
062100060427
062200060427       //*******************************************************************************************
062300060427       //
062400060427       // Controllo riga subfile.
062500060427       //
062600060427       //*******************************************************************************************
062700060427       BEGSR chkS01;
062800060427
062900060427         RESET wrkErrS01;
063000060427         EXSR chkS01Oxx;
063100060427
063200060427       ENDSR;
063300060403
063400060403       //*******************************************************************************************
063500060403       //
063600060403       // Controllo opzione immessa su riga subfile.
063700060403       //
063800060403       //*******************************************************************************************
063900060427       BEGSR chkS01Oxx;
064000060404
064100060511         RESET p01Opz;
064200060404         IF s01Opz <> 0;
064300060427           IF %LOOKUP(s01Opz:oxx) = 0;
064400060427             wrkErrS01 = *ON;
064500060926             errMsgOpzione = *ON;
064600060926             errGenerico = *ON;
064700060427             p01Opz = ReverseImage;
064800060427           ENDIF;
064900060404         ENDIF;
065000060403
065100060403       ENDSR;
065200060427
065300060427       //*******************************************************************************************
065400060427       //
065500060427       // Lettura subfile per elaborazione delle opzioni immesse.
065600060427       //
065700060427       //*******************************************************************************************
065800060427       BEGSR runC01;
065900060427
066000060427         opCode = 'PUTC01';
066100060427         RESET stop;
066200060427
066300060427         FOR wrkRrn = 1 TO s01RrnLast;
066400060427           CHAIN wrkRrn s01;
066500060427           IF NOT %FOUND;
066600060427             LEAVE;
066700060427           ENDIF;
066800060427           EXSR runS01Opz;
066900060427           EXSR updS01;
067000060427           IF stop;
067100060427             LEAVE;
067200060427           ENDIF;
067300060427         ENDFOR;
067400060427
067500060427       ENDSR;
067600060427
067700060427       //*******************************************************************************************
067800060427       //
067900060427       // Nuovo modello.
068000060427       //
068100060427       //*******************************************************************************************
068200060914       BEGSR nuovaRegola;
068300060427
068400060921         RESET tibs2631s;
068500060921         tibs2631s.opCode = 'NUOVO';
068600060921         EXSR gestioneRegola;
068700060427
068800060427       ENDSR;
068900060427
069000060427       //*******************************************************************************************
069100060427       //
069200060427       // Elaborazione opzione immessa su riga subfile.
069300060427       //
069400060427       //*******************************************************************************************
069500060427       BEGSR runS01Opz;
069600060427
069700060427         IF s01Opz <> 0;
069800060921           RESET tibs2631s;
069900060921           tibs2631s.codice = codice;
070000060921           tibs2631s.rrnAznmrr = h01RrnNmrR;
070100060427           SELECT;
070200060427             WHEN s01Opz = OpzScelta;
070300060914               tibs2620s.codice = codice;
070400060921               tibs2620s.rrnAznmrr = h01RrnNmrR;
070500060427               stop = *ON;
070600060427               opCode = 'END';
070700060427             WHEN s01Opz = OpzModifica;
070800060921               tibs2631s.opCode = 'MODIFICA';
070900060914               EXSR gestioneRegola;
071000060427             WHEN s01Opz = OpzCopia;
071100060921               tibs2631s.opCode = 'COPIA';
071200060914               EXSR gestioneRegola;
071300060511             WHEN s01Opz = OpzCancella;
071400060921               tibs2631s.opCode = 'CANCELLA';
071500060914               EXSR gestioneRegola;
071600060427             WHEN s01Opz = OpzVisualizza;
071700060921               tibs2631s.opCode = 'VISUALIZZA';
071800060914               EXSR gestioneRegola;
071900060509             WHEN s01Opz = OpzCommenti;
072000060509               EXSR gestioneCommenti;
072100060927             WHEN s01Opz = OpzNumeratori;
072200060927               EXSR gestioneNumeratori;
072300060427             OTHER;
072400060427           ENDSL;
072500060427           CLEAR s01Opz;
072600060427         ENDIF;
072700060427
072800060427       ENDSR;
072900060427
073000060427       //*******************************************************************************************
073100060427       //
073200060427       // Aggiornamento riga subfile.
073300060427       //
073400060427       //*******************************************************************************************
073500060427       BEGSR updS01;
073600060427
073700060427         UPDATE s01;
073800060427
073900060427       ENDSR;
074000060427
074100060427       //*******************************************************************************************
074200060427       //
074300060927       // Gestione regola.
074400060427       //
074500060427       //*******************************************************************************************
074600060914       BEGSR gestioneRegola;
074700060427
074800060921         kpjbu = tibs2631s;
074900060921         tibs2631r(kpjba);
075000060921         tibs2631s = kpjbu;
075100060921
075200060921         IF tibs2631s.rtnCode = 'DONE';
075300060921           SELECT;
075400060921             WHEN tibs2631s.rtnCmd = F3;
075500060921               opCode = 'END';
075600060921             WHEN tibs2631s.rtnCmd = F6;
075700060926               IF tibs2631s.opCode <> 'NUOVO';
075800060926                 opCode = 'INZC01';
075900060926               ENDIF;
076000060928             WHEN tibs2631s.rtnCmd = F12;
076100060928               stop = *ON;
076200060928               opCode = 'PUTC01';
076300060926             OTHER;
076400060926               opCode = 'PUTC01';
076500060921           ENDSL;
076600060921         ELSE;
076700060921           textString = 'Codice ritorno ' + %TRIMR(tibs2631s.rtnCode)
076800060921           + ' esito ' + %CHAR(tibs2631s.rtnEsito) +
076900060921           '. Premere invio per continuare.';
077000060921           opCode = 'ERRORE';
077100060921         ENDIF;
077200060427
077300060427       ENDSR;
077400060927
077500060927       //*******************************************************************************************
077600060927       //
077700060927       // Gestione numeratori.
077800060927       //
077900060927       //*******************************************************************************************
078000060927       BEGSR gestioneNumeratori;
078100060927
078200060927         RESET tibs2640s;
078300060928         tibs2640s.opCode = tibs2620s.opCode;
078400060927         tibs2640s.codice = codice;
078500060928         kpjbu = tibs2640s;
078600060927         tibs2640r(kpjba);
078700060928         tibs2640s = kpjbu;
078800060927
078900060928         IF tibs2640s.rtnCode = 'DONE';
079000060927           SELECT;
079100060928             WHEN tibs2640s.rtnCmd = F3;
079200060927               opCode = 'END';
079300060927             OTHER;
079400060927               opCode = 'PUTC01';
079500060927           ENDSL;
079600060927         ELSE;
079700060928           textString = 'Codice ritorno ' + %TRIMR(tibs2640s.rtnCode)
079800060928           + ' esito ' + %CHAR(tibs2640s.rtnEsito) +
079900060927           '. Premere invio per continuare.';
080000060927           opCode = 'ERRORE';
080100060927         ENDIF;
080200060928
080300060928         WRITE frcDta;
080400060927
080500060927       ENDSR;
080600060509
080700060509       //*******************************************************************************************
080800060509       //
080900060509       // Gestione commenti.
081000060509       //
081100060509       //*******************************************************************************************
081200060509       BEGSR gestioneCommenti;
081300060509
081400060509         RESET ana725ds;
081500060928         IF tibs2620s.opCode = 'GESTIONE';
081600060509           opz725 = '02';
081700060509         ELSE;
081800060509           opz725 = '05';
081900060509         ENDIF;
082000060914         ky1725 = codice;
082100061013         soc725 = xscCpa;
082200060509         kpjbu = ana725ds;
082300060509         ana725r(kpjba);
082400060509         ana725ds = kpjbu;
082500060509
082600060509       ENDSR;
082700060512
082800060512       //*******************************************************************************************
082900060512       //
083000060512       // Gestione errori.
083100060512       //
083200060512       //*******************************************************************************************
083300060512       BEGSR errore;
083400060512
083500060512         CLEAR qusec;
083600060512         qusbprv = %SIZE(qusec);
083700060512         displayLongText(textString:lengthOfTextString:messageID
083800060512         :qualifiedMessageFileName:qusec);
083900060512
084000060512       ENDSR;
084100060407
084200060131       //*******************************************************************************************
084300060131       //
084400060131       // Uscita.
084500060131       //
084600060131       //*******************************************************************************************
084700060131       BEGSR uscita;
084800060131
084900060320         IF dsp_aid = F12;
085000060320           WRITE frcDta;
085100060320         ELSE;
085200060914           CLOSE(E) tibs2620d;
085300060320         ENDIF;
085400060426
085500060928         IF tibs2620s.rtnCode = ' ';
085600060928           tibs2620s.rtnCode = 'DONE';
085700060131         ENDIF;
085800060426
085900060928         kpjbu = tibs2620s;
086000060928         *INLR = (tibs2620s.setOnLR = *ON);
086100060131         RETURN;
086200060131
086300060131       ENDSR;
086400060131
086500060131      /END-FREE
