000100060331      //********************************************************************************************
000200060330      //
000300060914      // Questo programma visualizza l'elenco delle regole dei numeratori AZNMRR00F.
000400060330      //
000500060330      //********************************************************************************************
000600060921     H DFTACTGRP(*NO) ACTGRP('NUMERATORI')
000700060915     H BNDDIR('PJXBND':'QC2LE':'TIBS')
000800060207     H DATEDIT(*YMD) DECEDIT(*JOBRUN)
000900060127
001000060330      //********************************************************************************************
001100060330      //
001200060330      // Definizione files.
001300060330      //
001400060330      //********************************************************************************************
001500060914     Ftibs2620d CF   E             WORKSTN
001600060320     F                                     USROPN
001700060130     F                                     INFDS(infDspF)
001800060127     F                                     INDDS(indDspF)
001900060130     F                                     SFILE(s01:s01Rrn)
002000060127
002100060330      //********************************************************************************************
002200060330      //
002300060330      // Definizione costanti.
002400060330      //
002500060330      //********************************************************************************************
002600060127     D F3              C                   X'33'
002700060127     D F5              C                   X'35'
002800060511     D F6              C                   X'36'
002900060427     D F10             C                   X'3A'
003000060127     D F12             C                   X'3C'
003100060127     D Enter           C                   X'F1'
003200060403     D Normal          C                   X'20'
003300060202     D ReverseImage    C                   X'21'
003400060404     D HighIntensity   C                   X'22'
003500060314     D Blink           C                   X'28'
003600060414     D RighePagina     C                   15
003700060414     D OpzScelta...
003800060414     D                 C                   1
003900060414     D OpzModifica...
004000060414     D                 C                   2
004100060427     D OpzCopia...
004200060403     D                 C                   3
004300060427     D OpzVisualizza...
004400060427     D                 C                   5
004500060921     D OpzNumeratori...
004600060915     D                 C                   11
004700060509     D OpzCommenti...
004800060509     D                 C                   14
004900060511     D OpzCancella...
005000060511     D                 C                   44
005100060404
005200060330      //********************************************************************************************
005300060330      //
005400060330      // Definizione delle procedure esterne usate.
005500060330      //
005600060330      //********************************************************************************************
005700060222     D xSoc            PR
005800060222     D                                     EXTPROC('XSOC')
005900060222     D  tipXsc                        6A
006000060222     D                                     CONST
006100060222     D  socXsc
006200060222     D                                     LIKE(pjzSocieta)
006300060222     D  cdsXsc                        9P 0
006400060222     D                                     CONST
006500060222     D  modXsc                        3A
006600060222     D                                     CONST
006700060222     D  rtnXsc                        1A
006800060921     D  xSoc001DS
006900060921     D                                     LIKEDS(xSoc001DS)
007000060222     D  kpjba
007100060222     D                                     LIKEDS(kpjba)
007200060921     D xChkAut         PR
007300060921     D                                     EXTPROC('XCHKAUT')
007400060921     D  xChkAutDS
007500060921     D                                     LIKEDS(xChkAutDS)
007600060331     D tibs34r         PR
007700060131     D                                     EXTPGM('TIBS34R')
007800060131     D  tibs34ds
007900060131     D                                     LIKEDS(tibs34ds)
008000060426     D atoi            PR            10I 0
008100060222     D                                     EXTPROC('atoi')
008200060222     D  char                           *
008300060222     D                                     VALUE
008400060222     D                                     OPTIONS(*STRING)
008500060509     D ana725r         PR
008600060509     D                                     EXTPGM('ANA725R')
008700060509     D  kpjba
008800060509     D                                     LIKEDS(kpjba)
008900060512     D displayLongText...
009000060512     D                 PR
009100060512     D                                     EXTPGM('QUILNGTX')
009200060512     D  textString...
009300060512     D                              256A
009400060512     D                                     CONST
009500060512     D                                     OPTIONS(*VARSIZE)
009600060512     D  lengthOfTextString...
009700060512     D                               10I 0
009800060512     D                                     CONST
009900060512     D  messageID...
010000060512     D                                7A
010100060512     D                                     CONST
010200060512     D  qualifiedMessageFileName...
010300060512     D                               20A
010400060512     D                                     CONST
010500060512     D  errorCode...
010600060512     D                                     LIKE(qusec)
010700060512     D                                     OPTIONS(*VARSIZE)
010800060921     D tibs2631r       PR
010900060921     D                                     EXTPGM('TIBS2631R')
011000060921     D  kpjba
011100060921     D                                     LIKEDS(kpjba)
011200060512
011300060330      //********************************************************************************************
011400060330      //
011500060330      // Definizione strutture dati.
011600060330      //
011700060330      //********************************************************************************************
011800060330     D psds           SDS
011900060131     D  pgmName          *PROC
012000060130     D infDspF         DS
012100060222     D  dsp_aid              369    369A                                        AID byte
012200060206     D  sf_rrn               376    377I 0                                      Subfile rrn
012300060206     D indDspF         DS
012400060130     D  sflDsp                 1      1N
012500060130     D  sflClr                 2      2N
012600060222     D  sflEnd                 3      3N
012700060926     D  errMsgOpzione         30     30N
012800060427     D  errGenerico           99     99N
012900060404     D kpjba         E DS
013000060921     D xSoc001DS     E DS
013100060414     D                                     INZ
013200060921     D xChkAutDS     E DS
013300060921     D                                     INZ
013400060921     D  xcaFnc       E
013500060921     D                                     INZ('YAZNMR')
013600060921     D  xcaVfu       E
013700060926     D                                     INZ(*ZERO)
013800060921     D  xcaTck       E
013900060921     D                                     INZ('CK')
014000060921     D  xcaNau       E
014100060921     D                                     INZ('1')
014200060414     D cndizion      E DS
014300060130     D                                     BASED(nullPtr)
014400060130     D                                     PREFIX(diz)
014500060222     D andiz00f      E DS
014600060222     D                                     BASED(nullPtr)
014700060222     D                                     PREFIX(pjz)
014800060914     D tibs2600s     E DS
014900060426     D                                     INZ
015000060426     D                                     QUALIFIED
015100060914     D tibs2620s     E DS
015200060914     D                                     INZ
015300060914     D                                     QUALIFIED
015400060921     D tibs2631s     E DS
015500060921     D                                     INZ
015600060921     D                                     QUALIFIED
015700060414     D tibs34ds      E DS
015800060414     D                                     INZ
015900060914     D aznmrr00f     E DS
016000060427     D                                     INZ
016100060509     D ana725ds      E DS
016200060509     D                                     INZ
016300060509     D  tpa725       E
016400060921     D                                     INZ('YNU')
016500060509     D  cmt725       E
016600060509     D                                     INZ(*OFF)
016700060131
016800060330      //********************************************************************************************
016900060330      //
017000060330      // Definizione variabili.
017100060330      //
017200060330      //********************************************************************************************
017300060512     D/COPY QSYSINC/QRPGLESRC,QCAPCMD
017400060512     D/COPY QSYSINC/QRPGLESRC,QUSEC
017500060512     D nullPtr         S               *
017600060130     D opCode          S             10
017700060221     D                                     INZ('INZC01')
017800060414     D rtnXsc          S              1A
017900060414     D s01Rrn          S              5I 0
018000060223     D s01RrnLast      S              5I 0
018100060403     D wrkRrn          S              5I 0
018200060317     D i               S              5I 0
018300060222     D p               S              5I 0
018400060228     D esito           S             10I 0
018500060228     D elementi        S             10I 0
018600060202     D wrkErrS01       S               N
018700060303     D stop            S               N
018800060207     D wrkCsrRrn       S              5I 0
018900060207     D                                     INZ(1)
019000060427     D wrkSqlStm       S            512A
019100060427     D                                     VARYING
019200060427     D oxx             S
019300060427     D                                     LIKE(s01Opz)
019400060511     D                                     DIM(6)
019500060427     D                                     ASCEND
019600060427     D fxx             S
019700060427     D                                     LIKE(dsp_aid)
019800060427     D                                     DIM(4)
019900060427     D                                     ASCEND
020000060512     D textString...
020100060512     D                 S            256A
020200060512     D lengthOfTextString...
020300060512     D                 S             10I 0
020400060512     D                                     INZ(%SIZE(textString))
020500060512     D messageID...
020600060512     D                 S              7A
020700060512     D                                     INZ('BAR0019')
020800060512     D qualifiedMessageFileName...
020900060512     D                 S             20A
021000060512     D                                     INZ('YBARMSG   *LIBL')
021100060512
021200060330      //********************************************************************************************
021300060330      //
021400060330      // Definizione aree dati.
021500060330      //
021600060330      //********************************************************************************************
021700060201     D §azute        E DS
021800060201     D                                     EXTNAME(azute00f)
021900060201     D                                     DTAARA
022000060201     D §DatiUte      E DS
022100060201     D                                     EXTNAME(dDatiUte)
022200060201     D                                     DTAARA
022300060403
022400060330      //********************************************************************************************
022500060330      //
022600060330      // Definizione parametri procedura.
022700060330      //
022800060330      //********************************************************************************************
022900060131     C     *ENTRY        PLIST
023000060131     C                   PARM                    kpjba
023100060127
023200060127      /FREE
023300060130
023400060131       EXSR inzProc;
023500060130
023600060130       DOU opCode = 'END';
023700060130         SELECT;
023800060221           WHEN opCode = 'INZC01';
023900060221             EXSR inzC01;
024000060130           WHEN opCode = 'LODC01';
024100060131             EXSR lodC01;
024200060130           WHEN opCode = 'PUTC01';
024300060131             EXSR putC01;
024400060131           WHEN opCode = 'CHKC01';
024500060427             EXSR chkC01;
024600060427           WHEN opCode = 'RUNC01';
024700060427             EXSR runC01;
024800060914           WHEN opCode = 'NUOVAREGOL';
024900060914             EXSR nuovaRegola;
025000060330           WHEN opCode = 'ERRORE';
025100060512             EXSR errore;
025200060512             opCode = 'END';
025300060512           WHEN opCode = 'END';
025400060512             LEAVE;
025500060130           OTHER;
025600060512             textString = 'Codice operativo ' + %TRIMR(opCode)
025700060512             + ' sconosciuto.';
025800060512             opCode = 'ERRORE';
025900060512         ENDSL;
026000060130       ENDDO;
026100060130
026200060130       EXSR uscita;
026300060323
026400060323       //*******************************************************************************************
026500060323       //
026600060323       // Operazioni iniziali da eseguire una tantum.
026700060323       //
026800060323       //*******************************************************************************************
026900060323       BEGSR *INZSR;
027000060323
027100060330      /END-FREE
027200060330     C/EXEC SQL
027300060330     C+ SET OPTION CLOSQLCSR = *ENDMOD, DYNUSRPRF = *OWNER
027400060330     C/END-EXEC
027500060330      /FREE
027600060330
027700060323         IN(E) §azute;
027800060323         IF NOT %ERROR;
027900060323           IN(E) §DatiUte;
028000060323         ENDIF;
028100060323         IF %ERROR OR rsut = ' ';
028200060323           tibs34r(tibs34ds);
028300060323           IN §azute;
028400060323           IN §DatiUte;
028500060323         ENDIF;
028600060427
028700060323         t01PgmName = pgmName;
028800060407
028900060407       ENDSR;
029000060131
029100060131       //*******************************************************************************************
029200060131       //
029300060131       // Operazioni iniziali.
029400060131       //
029500060131       //*******************************************************************************************
029600060131       BEGSR inzProc;
029700060330
029800060330         RESET opCode;
029900060131
030000060131         EXSR chkParm;
030100060222
030200060222         CLEAR kpjbu;
030300060921         CLEAR xSoc001DS;
030400060921         xSoc('SOC001':xscSoc:0:*BLANK:rtnXsc:xSoc001DS:kpjba);
030500060222         IF rtnXsc = *ON;
030600060926           tibs2600s.rtnCode = 'XSOC';
030700060926           opCode = 'END';
030800060330           LEAVESR;
030900060222         ENDIF;
031000060308
031100060921         // Controllo autorizzazione alla gestione delle regole numeratori.
031200060921         RESET xChkAutDS;
031300060921         xcaSoc = xscSoc;
031400060921         xcaGrp = xscGrp;
031500060921         xcaPrf = kNmUs;
031600060921         xChkAut(xChkAutDS);
031700060921         IF xcaRtn <> 0;
031800060926           tibs2600s.rtnCode = 'XCHKAUT';
031900060921           opCode = 'END';
032000060921           LEAVESR;
032100060921         ENDIF;
032200060921
032300060131       ENDSR;
032400060131
032500060131       //*******************************************************************************************
032600060131       //
032700060131       // Controllo dei parametri ricevuti.
032800060914       // All'inizio di KPJBU c'è TIBS2600S.
032900060914       // A seguire ci può essere TIBS2610S oppure TIBS2620S, a seconda che
033000060427       // la chiamata sia fatta per gestire i modelli o per cercare e scegliere un modello.
033100060131       //
033200060131       //*******************************************************************************************
033300060131       BEGSR chkParm;
033400060414
033500060914         tibs2600s = kpjbu;
033600060914         CLEAR tibs2600s.rtnCmd;
033700060914         CLEAR tibs2600s.rtnCode;
033800060914         CLEAR tibs2600s.rtnEsito;
033900060914         CLEAR tibs2620s;
034000060426
034100060426         SELECT;
034200060914           WHEN tibs2600s.opCode = 'GESTIONE';
034300060914           WHEN tibs2600s.opCode = 'RICERCA';
034400060914             tibs2620s = %SUBST(kpjbu:%SIZE(tibs2600s)+1);
034500060914             CLEAR tibs2620s.codice;
034600060914             CLEAR tibs2620s.rrnAznmrr;
034700060426         ENDSL;
034800060414
034900060131       ENDSR;
035000060221
035100060221       //*******************************************************************************************
035200060221       //
035300060330       // Inizializzo subfile movimenti.
035400060221       //
035500060221       //*******************************************************************************************
035600060221       BEGSR inzC01;
035700060320
035800060330         opCode = 'LODC01';
035900060914         IF NOT %OPEN(tibs2620d);
036000060914           OPEN tibs2620d;
036100060320         ENDIF;
036200060221         sflDsp = *OFF;
036300060221         sflClr = *ON;
036400060221         WRITE c01;
036500060221         sflClr = *OFF;
036600060221         CLEAR s01Rrn;
036700060223         CLEAR s01RrnLast;
036800060221         RESET wrkCsrRrn;
036900060331
037000060221       ENDSR;
037100060201
037200060201       //*******************************************************************************************
037300060201       //
037400060414       // Carico elenco modelli.
037500060201       //
037600060201       //*******************************************************************************************
037700060201       BEGSR lodC01;
037800060201
037900060330         opCode = 'PUTC01';
038000060330
038100060925         wrkSqlStm = 'SELECT RRN(R), R.CODICE, R.DESCRIZION, R.TEMPORIZZA, +
038200060921         IFNULL(N.COUNT, 0)';
038300060921         wrkSqlStm = wrkSqlStm + ' FROM AZNMRR00F R';
038400060921         wrkSqlStm = wrkSqlStm + ' LEFT OUTER JOIN (SELECT N.CODICE, COUNT(*) +
038500060921         COUNT FROM AZNMRN00F N WHERE N.PROGRESSIV >= 0 GROUP BY N.CODICE) +
038600060921         AS N ON R.CODICE = N.CODICE';
038700060921         wrkSqlStm = wrkSqlStm + ' ORDER BY R.CODICE';
038800060427         wrkSqlStm = wrkSqlStm + ' FOR READ ONLY';
038900060426
039000060426      /END-FREE
039100060426     C/EXEC SQL
039200060914     C+ PREPARE REGOLE FROM :wrkSqlStm
039300060426     C/END-EXEC
039400060426     C
039500060426     C/EXEC SQL
039600060914     C+ DECLARE REGOLE CURSOR FOR REGOLE
039700060426     C/END-EXEC
039800060426     C
039900060426     C/EXEC SQL
040000060914     C+ OPEN REGOLE
040100060426     C/END-EXEC
040200060426      /FREE
040300060330
040400060921         IF sqlCode < 0;
040500060914           tibs2600s.rtnCode = 'ERRSQL';
040600060921           tibs2600s.rtnEsito = sqlCode;
040700060914           textString = 'Codice ritorno ' + %TRIMR(tibs2600s.rtnCode)
040800060914           + ' esito ' + %CHAR(tibs2600s.rtnEsito) +
040900060512           '. Premere invio per continuare.';
041000060330           opCode = 'ERRORE';
041100060330           LEAVESR;
041200060330         ENDIF;
041300060330
041400060414         EXSR inzS01;
041500060414
041600060921         DOU sqlCode = 100;
041700060330      /END-FREE
041800060330     C/EXEC SQL
041900060914     C+ FETCH REGOLE
042000060925     C+ INTO :h01RrnNmrR, :codice, :descrizion, :temporizza, :s01Attivi
042100060330     C/END-EXEC
042200060330      /FREE
042300060330           SELECT;
042400060921             WHEN sqlCode = 100;
042500060330               sflEnd = *ON;
042600060330               LEAVE;
042700060921             WHEN sqlCode < 0;
042800060914               tibs2600s.rtnCode = 'ERRSQL';
042900060921               tibs2600s.rtnEsito = sqlCode;
043000060330               opCode = 'ERRORE';
043100060330               LEAVE;
043200060330             OTHER;
043300060330               EXSR setS01;
043400060331               EXSR wrtS01;
043500060330           ENDSL;
043600060330         ENDDO;
043700060330
043800060330      /END-FREE
043900060330     C/EXEC SQL
044000060914     C+ CLOSE REGOLE
044100060330     C/END-EXEC
044200060330      /FREE
044300060330
044400060330         s01RrnLast = s01Rrn;
044500060330
044600060201       ENDSR;
044700060330
044800060330       //*******************************************************************************************
044900060330       //
045000060330       // Inizializzo riga subfile movimenti.
045100060330       //
045200060330       //*******************************************************************************************
045300060330       BEGSR inzS01;
045400060330         CLEAR s01;
045500060330       ENDSR;
045600060330
045700060330       //*******************************************************************************************
045800060330       //
045900060405       // Imposto riga subfile movimenti come definito nel modello.
046000060330       //
046100060330       //*******************************************************************************************
046200060330       BEGSR setS01;
046300060330       ENDSR;
046400060331
046500060331       //*******************************************************************************************
046600060331       //
046700060331       // Scrittura riga subfile movimenti.
046800060331       //
046900060331       //*******************************************************************************************
047000060331       BEGSR wrtS01;
047100060331         s01Rrn += 1;
047200060331         WRITE s01;
047300060331       ENDSR;
047400060130
047500060131       //*******************************************************************************************
047600060131       //
047700060131       // Emissione subfile spedizioni.
047800060131       //
047900060131       //*******************************************************************************************
048000060131       BEGSR putC01;
048100060130
048200060403         opCode = 'PUTC01';
048300060427         RESET oxx;
048400060427         RESET fxx;
048500060427
048600060427         SELECT;
048700060914           WHEN tibs2600s.opCode = 'GESTIONE';
048800060914             c01Opzioni = '2=Modifica  3=Copia  +
048900060921             5=Visualizza  11=Numeratori  14=Commenti  44=Cancella';
049000060427             oxx(1) = OpzModifica;
049100060427             oxx(2) = OpzCopia;
049200060914             oxx(3) = OpzVisualizza;
049300060921             oxx(4) = OpzNumeratori;
049400060915             oxx(5) = OpzCommenti;
049500060915             oxx(6) = OpzCancella;
049600060921             f01Tasti = 'F3=Fine  F5=Ricarica  F10=Nuova regola  +
049700060914             F12=Ritorno';
049800060427             fxx(1) = F3;
049900060427             fxx(2) = F5;
050000060427             fxx(3) = F10;
050100060427             fxx(4) = F12;
050200060914           WHEN tibs2600s.opCode = 'RICERCA';
050300060509             c01Opzioni = '1=Scelta  14=Commenti';
050400060511             oxx(5) = OpzScelta;
050500060511             oxx(6) = OpzCommenti;
050600060427             f01Tasti = 'F3=Fine  F5=Ricarica  F12=Ritorno';
050700060511             fxx(2) = F3;
050800060511             fxx(3) = F5;
050900060511             fxx(4) = F12;
051000060427         ENDSL;
051100060427
051200060131         WRITE t01;
051300060131         WRITE f01;
051400060404
051500060207         SELECT;
051600060207           WHEN wrkCsrRrn > 0;
051700060207             c01RcdNbr = wrkCsrRrn;
051800060207             CLEAR wrkCsrRrn;
051900060207           WHEN c01CsrRrn > 0;
052000060207             c01RcdNbr = c01CsrRrn;
052100060207           OTHER;
052200060207             c01RcdNbr = 1;
052300060207         ENDSL;
052400060131
052500060427         sflDsp = (s01RrnLast > 0);
052600060131         EXFMT c01;
052700060130
052800060914         tibs2600s.rtnCmd = dsp_aid;
052900060130
053000060131         SELECT;
053100060131           WHEN dsp_aid = F3 OR dsp_aid = F12;
053200060414             opCode = 'END';
053300060131           WHEN dsp_aid = F5;
053400060221             opCode = 'INZC01';
053500060427           WHEN dsp_aid = Enter;
053600060131             opCode = 'CHKC01';
053700060427           WHEN dsp_aid = F10;
053800060914             opCode = 'NUOVAREGOL';
053900060206         ENDSL;
054000060130
054100060131       ENDSR;
054200060130
054300060131       //*******************************************************************************************
054400060131       //
054500060427       // Lettura subfile per controlli.
054600060131       //
054700060131       //*******************************************************************************************
054800060427       BEGSR chkC01;
054900060130
055000060403         opCode = 'PUTC01';
055100060427         RESET errGenerico;
055200060207         CLEAR wrkCsrRrn;
055300060303         RESET stop;
055400060130
055500060427         EXSR chkC01Fxx;
055600060427         IF errGenerico;
055700060427           LEAVESR;
055800060427         ENDIF;
055900060427
056000060403         FOR wrkRrn = 1 TO s01RrnLast;
056100060403           CHAIN wrkRrn s01;
056200060403           IF NOT %FOUND;
056300060221             LEAVE;
056400060221           ENDIF;
056500060427           EXSR chkS01;
056600060427           EXSR updS01;
056700060427           IF wrkErrS01;
056800060427             errGenerico = *ON;
056900060427             IF wrkCsrRrn = 0;
057000060427               wrkCsrRrn = s01Rrn;
057100060427             ENDIF;
057200060427           ENDIF;
057300060427           IF stop;
057400060427             LEAVE;
057500060404           ENDIF;
057600060403         ENDFOR;
057700060130
057800060427         IF NOT errGenerico AND dsp_aid = Enter;
057900060427           opCode = 'RUNC01';
058000060131         ENDIF;
058100060130
058200060131       ENDSR;
058300060427
058400060427       //*******************************************************************************************
058500060427       //
058600060427       // Controllo tasto funzionale premuto.
058700060427       //
058800060427       //*******************************************************************************************
058900060427       BEGSR chkC01Fxx;
059000060427
059100060427         IF dsp_aid <> Enter;
059200060427           IF %LOOKUP(dsp_aid:fxx) = 0;
059300060427             errGenerico = *ON;
059400060427           ENDIF;
059500060427         ENDIF;
059600060427
059700060427       ENDSR;
059800060427
059900060427       //*******************************************************************************************
060000060427       //
060100060427       // Controllo riga subfile.
060200060427       //
060300060427       //*******************************************************************************************
060400060427       BEGSR chkS01;
060500060427
060600060427         RESET wrkErrS01;
060700060427         EXSR chkS01Oxx;
060800060427
060900060427       ENDSR;
061000060403
061100060403       //*******************************************************************************************
061200060403       //
061300060403       // Controllo opzione immessa su riga subfile.
061400060403       //
061500060403       //*******************************************************************************************
061600060427       BEGSR chkS01Oxx;
061700060404
061800060511         RESET p01Opz;
061900060404         IF s01Opz <> 0;
062000060427           IF %LOOKUP(s01Opz:oxx) = 0;
062100060427             wrkErrS01 = *ON;
062200060926             errMsgOpzione = *ON;
062300060926             errGenerico = *ON;
062400060427             p01Opz = ReverseImage;
062500060427           ENDIF;
062600060404         ENDIF;
062700060403
062800060403       ENDSR;
062900060427
063000060427       //*******************************************************************************************
063100060427       //
063200060427       // Lettura subfile per elaborazione delle opzioni immesse.
063300060427       //
063400060427       //*******************************************************************************************
063500060427       BEGSR runC01;
063600060427
063700060427         opCode = 'PUTC01';
063800060427         RESET stop;
063900060427
064000060427         FOR wrkRrn = 1 TO s01RrnLast;
064100060427           CHAIN wrkRrn s01;
064200060427           IF NOT %FOUND;
064300060427             LEAVE;
064400060427           ENDIF;
064500060427           EXSR runS01Opz;
064600060427           EXSR updS01;
064700060427           IF stop;
064800060427             LEAVE;
064900060427           ENDIF;
065000060427         ENDFOR;
065100060427
065200060427       ENDSR;
065300060427
065400060427       //*******************************************************************************************
065500060427       //
065600060427       // Nuovo modello.
065700060427       //
065800060427       //*******************************************************************************************
065900060914       BEGSR nuovaRegola;
066000060427
066100060921         RESET tibs2631s;
066200060921         tibs2631s.opCode = 'NUOVO';
066300060921         EXSR gestioneRegola;
066400060427
066500060427       ENDSR;
066600060427
066700060427       //*******************************************************************************************
066800060427       //
066900060427       // Elaborazione opzione immessa su riga subfile.
067000060427       //
067100060427       //*******************************************************************************************
067200060427       BEGSR runS01Opz;
067300060427
067400060427         IF s01Opz <> 0;
067500060921           RESET tibs2631s;
067600060921           tibs2631s.codice = codice;
067700060921           tibs2631s.rrnAznmrr = h01RrnNmrR;
067800060427           SELECT;
067900060427             WHEN s01Opz = OpzScelta;
068000060914               tibs2620s.codice = codice;
068100060921               tibs2620s.rrnAznmrr = h01RrnNmrR;
068200060427               stop = *ON;
068300060427               opCode = 'END';
068400060427             WHEN s01Opz = OpzModifica;
068500060921               tibs2631s.opCode = 'MODIFICA';
068600060914               EXSR gestioneRegola;
068700060427             WHEN s01Opz = OpzCopia;
068800060921               tibs2631s.opCode = 'COPIA';
068900060914               EXSR gestioneRegola;
069000060511             WHEN s01Opz = OpzCancella;
069100060921               tibs2631s.opCode = 'CANCELLA';
069200060914               EXSR gestioneRegola;
069300060427             WHEN s01Opz = OpzVisualizza;
069400060921               tibs2631s.opCode = 'VISUALIZZA';
069500060914               EXSR gestioneRegola;
069600060509             WHEN s01Opz = OpzCommenti;
069700060509               EXSR gestioneCommenti;
069800060427             OTHER;
069900060427           ENDSL;
070000060427           CLEAR s01Opz;
070100060427         ENDIF;
070200060427
070300060427       ENDSR;
070400060427
070500060427       //*******************************************************************************************
070600060427       //
070700060427       // Aggiornamento riga subfile.
070800060427       //
070900060427       //*******************************************************************************************
071000060427       BEGSR updS01;
071100060427
071200060427         UPDATE s01;
071300060427
071400060427       ENDSR;
071500060427
071600060427       //*******************************************************************************************
071700060427       //
071800060427       // Gestione modello.
071900060427       //
072000060427       //*******************************************************************************************
072100060914       BEGSR gestioneRegola;
072200060427
072300060921         kpjbu = tibs2631s;
072400060921         tibs2631r(kpjba);
072500060921         tibs2631s = kpjbu;
072600060921
072700060921         IF tibs2631s.rtnCode = 'DONE';
072800060921           SELECT;
072900060921             WHEN tibs2631s.rtnCmd = F3;
073000060921               opCode = 'END';
073100060921             WHEN tibs2631s.rtnCmd = F6;
073200060926               IF tibs2631s.opCode <> 'NUOVO';
073300060926                 opCode = 'INZC01';
073400060926               ENDIF;
073500060926             OTHER;
073600060926               opCode = 'PUTC01';
073700060921           ENDSL;
073800060921         ELSE;
073900060921           textString = 'Codice ritorno ' + %TRIMR(tibs2631s.rtnCode)
074000060921           + ' esito ' + %CHAR(tibs2631s.rtnEsito) +
074100060921           '. Premere invio per continuare.';
074200060921           opCode = 'ERRORE';
074300060921         ENDIF;
074400060427
074500060427       ENDSR;
074600060509
074700060509       //*******************************************************************************************
074800060509       //
074900060509       // Gestione commenti.
075000060509       //
075100060509       //*******************************************************************************************
075200060509       BEGSR gestioneCommenti;
075300060509
075400060509         RESET ana725ds;
075500060914         IF tibs2600s.opCode = 'GESTIONE';
075600060509           opz725 = '02';
075700060509         ELSE;
075800060509           opz725 = '05';
075900060509         ENDIF;
076000060914         ky1725 = codice;
076100060509         kpjbu = ana725ds;
076200060509         ana725r(kpjba);
076300060509         ana725ds = kpjbu;
076400060509
076500060509       ENDSR;
076600060512
076700060512       //*******************************************************************************************
076800060512       //
076900060512       // Gestione errori.
077000060512       //
077100060512       //*******************************************************************************************
077200060512       BEGSR errore;
077300060512
077400060512         CLEAR qusec;
077500060512         qusbprv = %SIZE(qusec);
077600060512         displayLongText(textString:lengthOfTextString:messageID
077700060512         :qualifiedMessageFileName:qusec);
077800060512
077900060512       ENDSR;
078000060407
078100060131       //*******************************************************************************************
078200060131       //
078300060131       // Uscita.
078400060131       //
078500060131       //*******************************************************************************************
078600060131       BEGSR uscita;
078700060131
078800060320         IF dsp_aid = F12;
078900060320           WRITE frcDta;
079000060320         ELSE;
079100060914           CLOSE(E) tibs2620d;
079200060320         ENDIF;
079300060426
079400060914         IF tibs2600s.rtnCode = ' ';
079500060914           tibs2600s.rtnCode = 'DONE';
079600060131         ENDIF;
079700060426
079800060426         SELECT;
079900060914           WHEN tibs2600s.opCode = 'GESTIONE';
080000060914           WHEN tibs2600s.opCode = 'RICERCA';
080100060914             kpjbu = tibs2600s + tibs2620s;
080200060426         ENDSL;
080300060426
080400060914         *INLR = (tibs2600s.setOnLR = *ON);
080500060131         RETURN;
080600060131
080700060131       ENDSR;
080800060131
080900060131      /END-FREE
