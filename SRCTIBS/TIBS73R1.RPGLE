000100100803      //--------------------------------------------------------------
000200100803      //?TIBS73R1 - Registra variazioni coordinate bancarie
000300100803      //--------------------------------------------------------------
000400100803
000500100803     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600100803
000700100803      //---------------------------------------------------------------
000800100803      //?Dichiarazione file.
000900100803      //---------------------------------------------------------------
001000100803
001100100803      // - Variazioni
001200100803     fCNACVD0F  o    e             disk
001300100803     fCNACVT1L  uf a e           k disk
001400100803
001500100803      //---------------------------------------------------------------
001600100803      //?Definizione costanti.
001700100803      //---------------------------------------------------------------
001800100803
001900100803      //---------------------------------------------------------------
002000100803      //?Definizione schiere.
002100100803      //---------------------------------------------------------------
002200100803     d msg             s             78    dim(2) ctdata perrcd(1)
002300100803
002400100803      //---------------------------------------------------------------
002500100803      //?Definizione aree dati.
002600100803      //---------------------------------------------------------------
002700100803
002800100803      //---------------------------------------------------------------
002900100803      //?Definizione strutture dati.
003000100803      //---------------------------------------------------------------
003100100804     d dacv_I        e ds                  prefix(d)
003200100804     d wdacv_I       e ds                  extname(dacv_I)
003300100805     d                                     prefix(w) inz
003400100803
003500100803     d tibs73ds      e ds
003600100803
003700100803      //---------------------------------------------------------------
003800100803      //?Definizione variabili globali.
003900100803      //---------------------------------------------------------------
004000100803
004100100803      // - Campi di comodo
004200100803     d conta           s              4  0 inz
004300100803     d kscnew          s                   like(ACVksc)
004400100803     d kscprima        s                   like(ACVksc)
004500100803
004600100803      //---------------------------------------------------------------
004700100803      //?Definizione procedure usate.
004800100803      //---------------------------------------------------------------
004900100803
005000100803      //---------------------------------------------------------------
005100100803      //?prototipi
005200100803      //---------------------------------------------------------------
005300100803
005400100803      //---------------------------------------------------------------
005500100803      //?Definizione key-list.
005600100803      //---------------------------------------------------------------
005700100803
005800100803      //---------------------------------------------------------------
005900100803      //?Riepilogo indicatori.
006000100803      //---------------------------------------------------------------
006100100803
006200100803      //---------------------------------------------------------------
006300100803      //?M A I N - L I N E
006400100803      //---------------------------------------------------------------
006500100803     c     *Entry        plist
006600100803     c                   parm                    tibs73ds
006700100804     c                   parm                    dacv_I
006800100803
006900100803      /free
007000100803
007100100803       IF  IBS73tla <> 'C';
007200100803       //?Memorizzo immagine precedente
007300100803         IF  IBS73immag = 'P';
007400100804           conta = 1;
007500100804           wCBAksc  = dCBAksc;
007600100805           wCBAcod  = dCBAcod;
007700100804           wCBAiban = dCBAiban;
007800100803         ENDIF;
007900100803       //?Memorizzo immagine dopo
008000100803         IF  IBS73immag = 'D';
008100100803           SELECT;
008200100803         //?Errore se non ho registrato nessuna immagine PRIMA
008300100804         //?se richiamato in manutenzione
008400100804             WHEN  conta <> 1 and IBS73cta <> 'I';
008500100803               OBS73err = '1';
008600100803               OBS73msg = msg(01);
008700100803         //?Errore se codice diverso tra PRIMA e DOPO
008800100805             WHEN  wCBAksc <> dCBAksc and wCBAksc > 0 and dCBAksc > 0;
008900100803               OBS73err = '1';
009000100803               OBS73msg = msg(02);
009100100803             OTHER;
009200100803               exsr dopo;
009300100803          ENDSL;
009400100803         ENDIF;
009500100803       ENDIF;
009600100803
009700100803       IF  IBS73tla = *blanks;
009800100803         *inrt = *on;
009900100803       ELSE;
010000100803         *inlr = *on;
010100100803       ENDIF;
010200100803
010300100803       //--------------------------------------------------------------
010400100803       //?Memorizzo immagine DOPO.
010500100803       //--------------------------------------------------------------
010600100803       BEGSR dopo;
010700100803
010800100803         clear cnacvt00;
010900100803         clear cnacvd00;
011000100803
011100100803         ACVkcc = 151;
011200100804         ACVksc = dCBAksc;
011300100804         ACVpgm = IBS73pgm;
011400100804         ACVdav = dCBAdav;
011500100804         ACVorv = dCBAorv;
011600100803         ACVnoj = IBS73noj;
011700100804         ACVpru = IBS73pru;
011800100803
011900100804       //?se dati variati memorizzo
012000100805         IF  wCBAiban <> dCBAiban or wCBAcod <> dCBAcod;
012100100804           ACVyda   = IBS73yda;
012200100805           ACVprima = wCBAcod + wCBAiban;
012300100805           ACVdopo  = dCBAcod + dCBAiban;
012400100804           write CNACVD00;
012500100804         //?aggiorno o scrivo testata
012600100804           exsr testata;
012700100804         ENDIF;
012800100803
012900100803       ENDSR;
013000100803
013100100803       //--------------------------------------------------------------
013200100803       //?Scrivo o aggiorno testata.
013300100803       //--------------------------------------------------------------
013400100803       BEGSR testata;
013500100803
013600100803         chain (ACVkcc:ACVksc:ACVdav:ACVorv) CNACVT1L;
013700100803         IF  not %found(CNACVT1L);
013800100803           ACVflo = IBS73yda;
013900100803           ACVcta = IBS73cta;
014000100803           write  CNACVT00;
014100100803         ELSE;
014200100803           IF  %scan(IBS73yda:ACVflo) = 0;
014300100803             ACVflo = %trim(ACVflo) + IBS73yda;
014400100803           ENDIF;
014500100803           update  CNACVT00;
014600100803         ENDIF;
014700100803
014800100803       ENDSR;
014900100803
015000100803      /end-free
015100060531**
015200060531Errore: non passata l'immagine PRECEDENTE. Variazione non registrabile
015300100803Errore: codice cliente diverso tra immagine PRECEDENTE imm.SEGUENTE
