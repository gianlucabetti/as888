000100100803      //--------------------------------------------------------------
000200100803      //?TIBS73R1 - Registra variazioni coordinate bancarie
000300100803      //--------------------------------------------------------------
000400100803
000500100803     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600100803
000700100803      //---------------------------------------------------------------
000800100803      //?Dichiarazione file.
000900100803      //---------------------------------------------------------------
001000100803
001100100803      // - Variazioni
001200100803     fCNACVD0F  o    e             disk
001300100803     fCNACVT1L  uf a e           k disk
001400100803
001500100803      //---------------------------------------------------------------
001600100803      //?Definizione costanti.
001700100803      //---------------------------------------------------------------
001800100803
001900100803      //---------------------------------------------------------------
002000100803      //?Definizione schiere.
002100100803      //---------------------------------------------------------------
002200100803     d msg             s             78    dim(2) ctdata perrcd(1)
002300100803
002400100803      //---------------------------------------------------------------
002500100803      //?Definizione aree dati.
002600100803      //---------------------------------------------------------------
002700100803
002800100803      //---------------------------------------------------------------
002900100803      //?Definizione strutture dati.
003000100803      //---------------------------------------------------------------
003100100803     d dacv_S2       e ds                  prefix(d)
003200100803     d wdacv_S2      e ds                  extname(dacv_S2)
003300100803     d                                     prefix(w)
003400100803     d dacv_S3       e ds                  prefix(d)
003500100803     d wdacv_S3      e ds                  extname(dacv_S3)
003600100803     d                                     prefix(w)
003700100803
003800100803     d tibs73ds      e ds
003900100803     d fncbads       e ds                  extname(fncba00f)
004000100803
004100100803      //---------------------------------------------------------------
004200100803      //?Definizione variabili globali.
004300100803      //---------------------------------------------------------------
004400100803
004500100803      // - Parametri di arrivo al pgm
004600100803     d clstic          s              2a
004700100803     d Dataora         s             14a
004800100803     d Tipo            s              2a
004900100803
005000100803      // - Campi di comodo
005100100803     d conta           s              4  0 inz
005200100803     d kscnew          s                   like(ACVksc)
005300100803     d kscprima        s                   like(ACVksc)
005400100803
005500100803      //---------------------------------------------------------------
005600100803      //?Definizione procedure usate.
005700100803      //---------------------------------------------------------------
005800100803
005900100803      //---------------------------------------------------------------
006000100803      //?prototipi
006100100803      //---------------------------------------------------------------
006200100803
006300100803      //---------------------------------------------------------------
006400100803      //?Definizione key-list.
006500100803      //---------------------------------------------------------------
006600100803
006700100803      //---------------------------------------------------------------
006800100803      //?Riepilogo indicatori.
006900100803      //---------------------------------------------------------------
007000100803
007100100803      //---------------------------------------------------------------
007200100803      //?M A I N - L I N E
007300100803      //---------------------------------------------------------------
007400100803     c     *Entry        plist
007500100803     c                   parm                    tibs73ds
007600100803     c                   parm                    clstic
007700100803     c                   parm                    fncbads
007800100803     c                   parm                    Tipo
007900100803     c                   parm                    Dataora
008000100803
008100100803      /free
008200100803
008300100803       IF  IBS73tla <> 'C';
008400100803       //?Memorizzo immagine precedente
008500100803         IF  IBS73immag = 'P';
008600100803           clear conta;
008700100803           exsr impods;
008800100803           exsr prima;
008900100803         ENDIF;
009000100803       //?Memorizzo immagine dopo
009100100803         IF  IBS73immag = 'D';
009200100803           ACVksc = CBAksc;
009300100803           kscnew = ACVksc;
009400100803           SELECT;
009500100803         //?Errore se non ho registrato nessuna immagine PRIMA
009600100803             WHEN  conta <> 1;
009700100803               OBS73err = '1';
009800100803               OBS73msg = msg(01);
009900100803         //?Errore se codice diverso tra PRIMA e DOPO
010000100803             WHEN  kscprima <> kscnew;
010100100803               OBS73err = '1';
010200100803               OBS73msg = msg(02);
010300100803             OTHER;
010400100803               exsr impods;
010500100803               exsr dopo;
010600100803          ENDSL;
010700100803         ENDIF;
010800100803       ENDIF;
010900100803
011000100803       IF  IBS73tla = *blanks;
011100100803         *inrt = *on;
011200100803       ELSE;
011300100803         *inlr = *on;
011400100803       ENDIF;
011500100803
011600100803       //--------------------------------------------------------------
011700100803       //?Imposto i campi nella ds.
011800100803       //--------------------------------------------------------------
011900100803       BEGSR impods;
012000100803
012100100803         IF  tipo = 'DN';
012200100803           dclsticdn = %subst(clstic:1:1);
012300100803           dcbaibandn = cbaiban;
012400100803         ENDIF;
012500100803
012600100803         IF  tipo = 'NA';
012700100803           dclsticna = %subst(clstic:2:1);
012800100803           dcbaibanna = cbaiban;
012900100803         ENDIF;
013000100803
013100100803       ENDSR;
013200100803
013300100803       //--------------------------------------------------------------
013400100803       //?Memorizzo immagine PRIMA.
013500100803       //--------------------------------------------------------------
013600100803       BEGSR prima;
013700100803
013800100803         conta = 1;
013900100803         ACVksc = CBAksc;
014000100803         kscprima = ACVksc;
014100100803
014200100803         //?imposto le ds per verificare se sono stati variati i dati
014300100803         IF  tipo = 'DN';
014400100803           wdacv_s2 = dacv_s2;
014500100803         ENDIF;
014600100803
014700100803         IF  tipo = 'NA';
014800100803           wdacv_s3 = dacv_s3;
014900100803         ENDIF;
015000100803
015100100803       ENDSR;
015200100803
015300100803       //--------------------------------------------------------------
015400100803       //?Memorizzo immagine DOPO.
015500100803       //--------------------------------------------------------------
015600100803       BEGSR dopo;
015700100803
015800100803         clear cnacvt00;
015900100803         clear cnacvd00;
016000100803
016100100803         ACVkcc = 151;
016200100803         ACVdav = %dec(%subst(DataOra:1:8):8:0);
016300100803         ACVorv = %dec(%subst(DataOra:9:6):6:0);
016400100803         ACVpru = IBS73pru;
016500100803         ACVnoj = IBS73noj;
016600100803         ACVpgm = IBS73pgm;
016700100803
016800100803       //?manutenzione
016900100803         IF  IBS73cta = 'M';
017000100803           IF  Tipo = 'DN';
017100100803         //?se dati variati memorizzo
017200100803             IF  dacv_s2 <> wdacv_s2;
017300100803               ACVyda   = IBS73yda;
017400100803               ACVprg   = 2;
017500100803               ACVprima = wdacv_s2;
017600100803               ACVdopo  = dacv_s2;
017700100803               write CNACVD00;
017800100803           //?aggiorno o scrivo testata
017900100803               exsr testata;
018000100803             ENDIF;
018100100803           ENDIF;
018200100803           IF  Tipo = 'NA';
018300100803         //?se dati variati memorizzo
018400100803             IF  dacv_s3 <> wdacv_s3;
018500100803               ACVyda   = IBS73yda;
018600100803               ACVprg   = 3;
018700100803               ACVprima = wdacv_s3;
018800100803               ACVdopo  = dacv_s3;
018900100803               write CNACVD00;
019000100803           //?aggiorno o scrivo testata
019100100803               exsr testata;
019200100803             ENDIF;
019300100803           ENDIF;
019400100803         ENDIF;
019500100803
019600100803
019700100803       ENDSR;
019800100803
019900100803       //--------------------------------------------------------------
020000100803       //?Scrivo o aggiorno testata.
020100100803       //--------------------------------------------------------------
020200100803       BEGSR testata;
020300100803
020400100803         chain (ACVkcc:ACVksc:ACVdav:ACVorv) CNACVT1L;
020500100803         IF  not %found(CNACVT1L);
020600100803           ACVflo = IBS73yda;
020700100803           ACVcta = IBS73cta;
020800100803           write  CNACVT00;
020900100803         ELSE;
021000100803           IF  %scan(IBS73yda:ACVflo) = 0;
021100100803             ACVflo = %trim(ACVflo) + IBS73yda;
021200100803           ENDIF;
021300100803           update  CNACVT00;
021400100803         ENDIF;
021500100803
021600100803       ENDSR;
021700100803
021800100803      /end-free
021900060531**
022000060531Errore: non passata l'immagine PRECEDENTE. Variazione non registrabile
022100100803Errore: codice cliente diverso tra immagine PRECEDENTE imm.SEGUENTE
