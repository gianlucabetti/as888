000100111128       //==============================================================
000200120514       // TIS785R1 - Lancia la cancellazione (interattiva) di generici oggetti
000300120405       //==============================================================
000400111128
000500111128       //--------------------------------------------------------------
000600120207       // Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700111128       //--------------------------------------------------------------
000800111128
000900111128     /*PRM  dbgview(*source)
001000111128     /*END
001100111128
001200111128       //--------------------------------------------------------------
001300120207       // Specifiche di controllo.                                     ?
001400111128       //--------------------------------------------------------------
001500111128
001600111128     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001700120521     h dftactgrp(*no) actgrp('QILE') bnddir('UBBNDDIR')
001800111128     h alwnull(*inputonly)
001900111128
002000111128       //--------------------------------------------------------------
002100120207       // Dichiarazione file.                                          ?
002200111128       //--------------------------------------------------------------
002300120215       // - Video
002400120514     fTIS785D1  cf   e             workstn
002500120207     f                                     indds(IndDspF)
002600120207     f                                     infds(InfDspF)
002700111128
002800111128
002900111128       //--------------------------------------------------------------
003000120207       // Definizione costanti.                                        ?
003100111128       //--------------------------------------------------------------
003200120207
003300120207       // - Tasti funzionali a video
003400120207     d c_F01           c                   const(x'31')
003500120207     d c_F02           c                   const(x'32')
003600120207     d c_F03           c                   const(x'33')
003700120207     d c_F05           c                   const(x'35')
003800120207     d c_F06           c                   const(x'36')
003900120207     d c_F07           c                   const(x'37')
004000120207     d c_F08           c                   const(x'38')
004100120207     d c_F09           c                   const(x'39')
004200120207     d c_F10           c                   const(x'3A')
004300120207     d c_F12           c                   const(x'3C')
004400120207     d c_F13           c                   const(x'B1')
004500120207     d c_F14           c                   const(x'B2')
004600120207     d c_F15           c                   const(x'B3')
004700120207     d c_F16           c                   const(x'B4')
004800120207     d c_F17           c                   const(x'B5')
004900120207     d c_F18           c                   const(x'B6')
005000120207     d c_F19           c                   const(x'B7')
005100120207     d c_F20           c                   const(x'B8')
005200120207     d c_F21           c                   const(x'B9')
005300120207     d c_F22           c                   const(x'BA')
005400120207     d c_F23           c                   const(x'BB')
005500120207     d c_F24           c                   const(x'BC')
005600120207     d c_Enter         c                   const(x'F1')
005700120207     d c_RollDown      c                   const(x'F4')
005800120207     d c_RollUp        c                   const(x'F5')
005900111128
006000111128
006100111128       //--------------------------------------------------------------
006200120207       // Definizione schiere.                                         ?
006300111128       //--------------------------------------------------------------
006400111128
006500111128
006600111128       //--------------------------------------------------------------
006700120207       // Definizione aree dati.                                       ?
006800111128       //--------------------------------------------------------------
006900111128
007000111128
007100111128       //--------------------------------------------------------------
007200120207       // Definizione strutture dati.                                  ?
007300111128       //--------------------------------------------------------------
007400120510
007500120510
007600111128       //--------------------------------------------------------------
007700120207       // Definizione variabili globali.                               ?
007800111128       //--------------------------------------------------------------
007900111128
008000120208       // - Stringa SQL da eseguire
008100111128     d wSQl            s           1024    inz  varying
008200111128
008300120208       // - Parametri SQL
008400120207
008500120207       // - InfDS
008600120207     d InfDspF         ds
008700120207     d   dsp_aid             369    369a                                        AID byte
008800120207
008900120207       // - Indicatori su DspF
009000120207     d IndDspF         ds
009100120207        // - Indicatori di errore
009200120518     d  EmettoMsg                     1n   overlay(IndDspF : 28)
009300120207     d  ErrGenerico                   1n   overlay(IndDspF : 99)
009400120404
009500120404     d KPJBA         e ds
009600120207
009700120207       // - Flags booleani
009800120207     d $Fine           s               n   inz(*off)
009900120510     d $InzW01         s               n   inz(*on)
010000120208     d ErrBlock        s               n   inz(*off)
010100120210     d Qcmd            s            500    inz
010200120207
010300120207       // - Campi associati al video
010400120510     d $Video          s              2    inz('W1')
010500120207
010600120207       // - Variabili di appoggio
010700120510     d wData08         s              8s 0
010800120405     d wX              s              5s 0
010900120514     d wError          s              2
011000120514     d wErrorD         s             70
011100111128
011200111128       //--------------------------------------------------------------
011300120210       // Definizione procedure usate
011400111128       //--------------------------------------------------------------
011500120207
011600120210       // - Parametri API QCAPCMD (Process Commands)
011700120207      /copy qSysInc/qRpgleSrc,QCAPCMD
011800120207      /copy gaitrasrc/srcProtoPR,QCAPCMD
011900120510      /COPY GAITRASRC/SRCPROTOPR,UBFMTDATE
012000120207
012100120210       // - Parametri gestione errori API
012200120207      /copy qSysInc/qRpgleSrc,QUSEC
012300120404
012400120514     dTIS785R          pr                  extpgm('TIS785R')
012500120514     d InLib                         10    const
012600120514     d InObjType                      7    const
012700120514     d InObj                         10    const
012800120514     d InDate                         8s 0 const
012900120514     d InDateType                     1
013000120514     d InMode                         1
013100120514     d OutError                       2
013200120514     d OutErrorD                     70
013300120514
013400120514     d TIS785R1        pr
013500120404     d  Arch                        502
013600120404
013700120514     d TIS785R1        pi
013800120404     d  Arch                        502
013900111128
014000111128       //--------------------------------------------------------------
014100120208       // Definizione key-list.                                        ?
014200111128       //--------------------------------------------------------------
014300111128
014400111128
014500111128       //--------------------------------------------------------------
014600120208       // M A I N - L I N E                                            ?
014700111128       //--------------------------------------------------------------
014800111128
014900111128      /free
015000111128
015100120208       // - Operazioni iniziali
015200111128       exsr  sr_RoutInz;
015300111128
015400120207       // - Gestione video
015500120207       DOW  $Fine = *off;
015600120207         select;
015700120510           when  $Video = 'W1';
015800120510             exsr  sr_GesW01;
015900120207           other;
016000120207             $Fine = *on;
016100120207         endsl;
016200120207       ENDDO;
016300120207
016400120208       // - Operazioni finali
016500111128       exsr  sr_RoutEnd;
016600111128
016700111128       //--------------------------------------------------------------
016800120208       // Operazioni iniziali
016900111128       //--------------------------------------------------------------
017000111128       BEGSR sr_RoutInz;
017100111128
017200111128         *inLR = *on;
017300120207         IndDspF  = *off;
017400120404         KPJBA = Arch;
017500111128
017600120208         // - Impostazione opzioni per SQL
017700111128         exec SQL   set option   DynUsrPrf = *owner,
017800111128                                 CloSqlCsr = *endmod;
017900111128
018000111128
018100111128       ENDSR;
018200120207
018300120207       //--------------------------------------------------------------
018400120510       // Gestione videata W01
018500120207       //--------------------------------------------------------------
018600120510       BEGSR  sr_GesW01;
018700120207
018800120207         // - Inizializzazione videata
018900120510         if  $InzW01   = *on;
019000120510           exsr  sr_InzW01;
019100120510           $InzW01  = *off;
019200120207         endif;
019300120207
019400120207         // - Emissione videata
019500120514         exfmt  S785W01;
019600120207
019700120518         reset  EmettoMsg;
019800120510         clear  W01msg;
019900120515         clear  W01msg2;
020000120207
020100120207         SELECT;
020200120207
020300120207           // - F3=Fine
020400120207           WHEN  dsp_aid = c_F03;
020500120510             exsr sr_F03W01;
020600120207
020700120207           // - F12=Ritorno
020800120207           WHEN  dsp_aid = c_F12;
020900120510             exsr sr_F12W01;
021000120207
021100120207           // - Invio / F6=Conferma
021200120207           OTHER;
021300120510             exsr  sr_CtrW01;
021400120207             if  ErrGenerico = *on;
021500120207               leavesr;
021600120207             endif;
021700120207             if  dsp_aid = c_F06;
021800120510               exsr sr_F06W01;
021900120207             endif;
022000120207
022100120207         ENDSL;
022200120207
022300120207       ENDSR;
022400120207
022500120207       //--------------------------------------------------------------
022600120510       // Inizializzazione videata W01
022700120207       //--------------------------------------------------------------
022800120510       BEGSR  sr_InzW01;
022900120207
023000120207         // - Pulizia videata
023100120514         clear  S785W01;
023200120404
023300120404         // - impostazioni default
023400120514         w01Data = %dec(%date() : *EUR);
023500120518         w01TObj = '*FILE';
023600120207
023700120207       ENDSR;
023800120207
023900120207       //--------------------------------------------------------------
024000120510       // Gestione tasto funzionale F3 da videata W01                  ?
024100120510       // F3=Fine                                                      ?
024200120207       //--------------------------------------------------------------
024300120510       BEGSR  sr_F03W01;
024400120207
024500120207         // - Chiusura del programma
024600120207         $Fine = *on;
024700120207
024800120207       ENDSR;
024900120207
025000120207       //--------------------------------------------------------------
025100120510       // Gestione tasto funzionale F6 da videata W01
025200120208       // F6=Conferma
025300120207       //--------------------------------------------------------------
025400120510       BEGSR  sr_F06W01;
025500120405
025600120518           EmettoMsg = *off;
025700120514
025800120514         // Chiamo cancellazione
025900120518         TIS785R(W01Lib:W01TOBJ:W01OBJ:wData08:W01TDATA:W01MODO:wError:wErrorD);
026000120215
026100120514         // se c'è un errore metto la descrizione nel campo del msg
026200120514         if wError <> '0';
026300120514           W01Msg = wErrorD;
026400120518           EmettoMsg = *on;
026500120518           if wError = '8';
026600120515             W01Msg2 = 'ERRORE: Parametri formalmente scorretti.';
026700120515           endif;
026800120518         // se NON c'è un errore emetto la segnalazione di eseguita cancellazione
026900120518         else;
027000120518           W01Msg = 'Eseguita cancellazione';
027100120518           EmettoMsg = *on;
027200120518         endif;
027300120207
027400120207       ENDSR;
027500120208
027600120207       //--------------------------------------------------------------
027700120510       // Gestione tasto funzionale F12 da videata W01
027800120208       // F12=Ritorno
027900120207       //--------------------------------------------------------------
028000120510       BEGSR  sr_F12W01;
028100120207
028200120207         // - Chiusura del programma
028300120207         $Fine = *on;
028400120207
028500120207       ENDSR;
028600120207
028700120207       //--------------------------------------------------------------
028800120510       // Controllo videata W01                                        ?
028900120207       //--------------------------------------------------------------
029000120510       BEGSR  sr_CtrW01;
029100120207
029200120207         IndDspF  = *off;
029300120208
029400120510         // se scritta, la data deve essere corretta
029500120514         if  W01Data>0;
029600120510           wData08 = %dec(%subst(
029700120510                    UBFMTDATE_Convert(
029800120514                     %editc(W01Data:'X'):
029900120510                     'DDMMYYYY':
030000120510                     'YYYYMMDD') :
030100120510                     1 : 8) : 8 : 0);
030200120514           if  wData08 = W01Data;
030300120510             W01msg = 'Data errata';
030400120518             EmettoMsg = *on;
030500120510             ErrGenerico = *on;
030600120510             leavesr;
030700120510           else;
030800120510           // se la data è corretta, deve essere <= oggi
030900120510             if wData08 > %dec(%date() : *ISO);
031000120510               W01msg = 'Data > di oggi';
031100120518               EmettoMsg = *on;
031200120510               ErrGenerico = *on;
031300120510               leavesr;
031400120510             endif;
031500120510           endif;
031600120510         endif;
031700120207
031800120207       ENDSR;
031900120215
032000120215       //--------------------------------------------------------------
032100120215       // Esecuzione del comando (già impostato)
032200120215       //--------------------------------------------------------------
032300120215       BEGSR  sr_ExecCmd;
032400120215
032500111128         clear Qcap0100;
032600111128         Qcabcsdh = *off;
032700111128         Qcapa    = *off;
032800111128         Qcacmdss = *off;
032900111128         Qcaerved = *allX'00';
033000111128
033100111128         clear Qusec;
033200111128         Qusbprv  = %size(Qusec);
033300111128
033400111128         ProcessCommands ( Qcmd : %len( %trimr( Qcmd ) ) : Qcap0100 :
033500111128                           %size(Qcap0100) : 'CPOP0100' : *omit :
033600111128                           0 : 0 : Qusec);
033700111128
033800120210         // - Stampa DUMP + JobLog  &  Chiusura *pgm  in caso di errore
033900111128         if  Qusei <> *blank;
034000111128           exsr  sr_PrintErr;
034100111128         endif;
034200111128
034300111128       ENDSR;
034400111128
034500111128       //--------------------------------------------------------------
034600120210       // Stampa segnalazione dell'errore rilevato
034700111128       //--------------------------------------------------------------
034800111128       BEGSR  sr_PrintErr;
034900111128
035000120210         // - Stampa del Dump
035100111128         Dump(A);
035200111128
035300120210         // - Stampa del Job-Log
035400111128         Qcmd = 'DSPJOBLOG job(*) output(*print)';
035500111128         exsr  sr_ExecCmd;
035600111128
035700111128       ENDSR;
035800111128
035900111128       //--------------------------------------------------------------
036000120208       // Operazioni finali
036100111128       //--------------------------------------------------------------
036200111128       BEGSR  sr_RoutEnd;
036300111128
036400120208         // - Uscita
036500111128         return;
036600111128
036700111128       ENDSR;
036800111128
036900111128      /end-free
