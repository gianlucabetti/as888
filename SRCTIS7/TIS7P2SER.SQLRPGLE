000100150224       //==============================================================
000200130318       // Driver scrittura EDIVAT - PDF to SPOOL
000300091228       //==============================================================
000400091228
000500091228       //--------------------------------------------------------------
000600121106       // Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700091228       //--------------------------------------------------------------
000800091228
000900100325     /*PRM dbgview(*source)
001000091223     /*END
001100091228
001200091228       //--------------------------------------------------------------
001300121106       // Specifiche di controllo.
001400091228       //--------------------------------------------------------------
001500091223
001600091223     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001700100325     h dftactgrp(*no)
001800091223     h alwnull(*inputonly)
001900100325     h bnddir('UBBNDDIR')
002000091223
002100091223       //--------------------------------------------------------------
002200121106       // Dichiarazione file.
002300091223       //--------------------------------------------------------------
002400100112
002500130318     FEDIVATwr  O    E             DISK    usropn
002600091223
002700091223       //--------------------------------------------------------------
002800121106       // Definizione costanti.
002900091223       //--------------------------------------------------------------
003000100302
003100091223
003200091223       //--------------------------------------------------------------
003300121106       // Definizione schiere.
003400091223       //--------------------------------------------------------------
003500091223
003600091223
003700091223       //--------------------------------------------------------------
003800121106       // Definizione aree dati.
003900091223       //--------------------------------------------------------------
004000091223
004100091223
004200091223       //--------------------------------------------------------------
004300121106       // Definizione strutture dati.
004400091223       //--------------------------------------------------------------
004500110516
004600130307     D TIVLR00F      e ds
004700130318     D EDIVAB0F      e ds
004800130318     D FIVAB00F      e ds                  prefix(x_)
004900130307     D dscmz         e ds                  inz
005000130307     D dvatp         e ds
005100121106       // - Status
005200110516     d Psds           sds
005300110516     d   SDSpgm          *proc
005400121106     d   JobName             244    253                                         Job name
005500121106     d   JobUser             254    263                                         User name
005600121106     d   JobNumber           264    269s 0                                      Job number
005700091223
005800091223       //--------------------------------------------------------------
005900121106       // Definizione variabili.
006000091223       //--------------------------------------------------------------
006100091223
006200121106       // - Parametri ricevuti:
006300130307     d pIn_Opz         s              1a
006400130307     d pIn_CdIdAz      s              2a
006500130307     d pIn_MaskPDF     s             50a
006600130307     d pOut_Esito      s              1a
006700091223
006800121106       // Stringa SQL da eseguire
006900130108     d wSQL            s           5000    inz  varying
007000121106
007100121106       // Campi di comodo
007200130307     d wMaskPDF        s             50a
007300121106     d wDate           s              8  0 inz
007400130307     d wEsito          s              1a
007500130318     d wHDL            s                   like(VLRHDL)
007600170707     d wFGS            s                   like(VABFGS)
007700091223
007800091223       //--------------------------------------------------------------
007900121106       // Definizione prototipi procedure.
008000091223       //--------------------------------------------------------------
008100091223
008200130318     d TITVEVTC        pr                  extpgm('TITVEVTC')
008300130307     d  parccm                        8
008400130307     d  parmbr                       10
008500130307     d  paropz                        1
008600130307
008700130307     d TIS711C         pr                  extpgm('TIS711C')
008800130307     d  cmz711                      110
008900130307     d  esito711                      1
009000130314
009100130318     d TIS7P2SR1       pr                  extpgm('TIS7P2SR1')
009200130318     d  FIVAB                              like(FIVAB00F)
009300130314     d  pIn_MaskPDF                        like(pIn_MaskPDF)
009400130314     d  wMaskPDF                           like(pIn_MaskPDF)
009500130314     d  wEsito                             like(wEsito)
009600130307
009700091223       //--------------------------------------------------------------
009800121106       // Definizione key-list.
009900091223       //--------------------------------------------------------------
010000091223
010100091223
010200091223       //--------------------------------------------------------------
010300121107       // Definizione parametri procedura.
010400091223       //--------------------------------------------------------------
010500091223
010600091223     c     *Entry        plist
010700130307     c                   parm                    pIn_Opz
010800130307     c                   parm                    TIVLR00F
010900130318     c                   parm                    EDIVAB0F
011000130307     c                   parm                    pIn_CdIdAz
011100130307     c                   parm                    pIn_MaskPDF
011200130307     c                   parm                    pOut_Esito
011300091223
011400130307      /free
011500091223
011600091223       //--------------------------------------------------------------
011700121106       // M A I N - L I N E
011800091223       //--------------------------------------------------------------
011900130307
012000130307       // Operazioni iniziali?
012100130307       exsr sr_RoutInz;
012200130307
012300130307       // attività richiesta dal chiamante
012400130307       select;
012500130307         // OPEN
012600130307         when pIn_Opz = 'O';
012700130307         exsr sr_open;
012800130307         // WRITE
012900130307         when pIn_Opz = 'W';
013000130307         exsr sr_write;
013100130307         // CLOSE
013200130307         when pIn_Opz = 'C';
013300130307         exsr sr_close;
013400130307         // richiesta errata
013500130307         other;
013600130307         pOut_Esito = '2';
013700130307         exsr sr_RoutEnd;
013800130307       endsl;
013900091223
014000121106       // Operazioni finali?
014100091223       exsr sr_RoutEnd;
014200091223
014300091223       //--------------------------------------------------------------
014400121107       // Operazioni iniziali.
014500091223       //--------------------------------------------------------------
014600091223       BEGSR  sr_RoutInz;
014700091223
014800091223         exec sql  set option  dynusrprf = *owner,
014900121107                               closqlcsr = *endmod;
015000130307
015100130307         pOut_Esito = '1';
015200121108
015300121108         // Reperimento data odierna (fmt aaaa/mm/gg)
015400121108         wDate = %dec( %date() );
015500091223
015600091223       ENDSR;
015700110523
015800110523       //--------------------------------------------------------------
015900130307       // OPEN
016000110523       //--------------------------------------------------------------
016100130307       BEGSR  sr_open;
016200110523
016300130318         wHDL = VLRHDL;
016400130318         %subst(wHDL:1:1) = 'P';
016500130307         wEsito = '1';
016600130307
016700130307         monitor;
016800130318           TITVEVTC(VLRKSC:wHDL:wEsito);
016900130307         on-error;
017000130307           pOut_Esito = '2';
017100130307           exsr sr_RoutEnd;
017200130307         endmon;
017300121106
017400121106       ENDSR;
017500130307
017600130307       //--------------------------------------------------------------
017700130307       // WRITE
017800130307       //--------------------------------------------------------------
017900130307       BEGSR  sr_write;
018000130307
018100130307
018200130307         //sostituzione
018300130307
018400130318         //il pgm che costruisce il nome pdf dalla maschera si aspetta i dati sulla DS FIVAB00F
018500130318         //EDIVAB0F è uguale a FIVAB00F tranne per i dati del CMR, che sono in più
018600130318         FIVAB00F = EDIVAB0F;
018700170707
018800170707         //Salvo l'FGS corrente
018900170707         wFGS = VABFGS;
019000130318
019100130318         TIS7P2SR1(FIVAB00F:pIn_MaskPDF:wMaskPDF:wEsito);
019200130314         //se il pgm di sostituzione maschera ha trovato un errore, anch'io chiudo con errore
019300130314         if wEsito = '2';
019400130314           pOut_Esito = '2';
019500130314           exsr sr_RoutEnd;
019600130314         endif;
019700130307
019800130307
019900130307         //scrittura
020000130307
020100130318         if not %open(edivatwr);
020200130318           open edivatwr;
020300130307         endif;
020400130307
020500130307         §VATppdfn = wMaskPDF;
020600130307         §VATpidz = pIn_CdIdAz;
020700130307
020800130307         VATATB = *blanks;
020900130307         VATFGS = VABFGS;
021000130307         VATCCM = VABCCM;
021100130307         VATLNP = VABLNP;
021200130307         VATAAS = VABAAS;
021300130307         VATNRS = VABNRS;
021400130307         VATNSP = VABNSP;
021500130318         VATCMR = VABCMR;
021600130318         VATCNT = VABCNT;
021700130307         VATTRC = 'P';
021800130307         VATNOT = DVATP;
021900130307
022000130318         write edivat00;
022100130307
022200130307       ENDSR;
022300130307
022400130307       //--------------------------------------------------------------
022500130307       // CLOSE
022600130307       //--------------------------------------------------------------
022700130307       BEGSR  sr_close;
022800130318
022900130318         //chiudo il file
023000130318         if %open(edivatwr);
023100130318           close edivatwr;
023200130318         endif;
023300130307
023400130318         wHDL = VLRHDL;
023500130318         %subst(wHDL:1:1) = 'P';
023600130314         wEsito=*blank;
023700130307
023800130307         reset dscmz;
023900170706         if VLRPOI <> 999;
024000170706           cmzdst = %editc(VLRPOI:'X');
024100170706         else;
024200170707           cmzdst = %editc(wFGS:'X');
024300170706         endif;
024400130318         cmzfld = 'EDIVATWR';
024500130318         cmzmbd = wHDL;
024600130318         cmzfla = 'EDIVAT0F';
024700130318         cmzmba = 'EDIVAT0F';
024800130307         cmznrr = *zeros;
024900130307         cmzlba = vlrfl1;
025000130307         monitor;
025100130307           TIS711C(dscmz:wEsito);
025200130307         on-error;
025300130307           pOut_Esito = '2';
025400130307           exsr sr_RoutEnd;
025500130307         endmon;
025600130307         if cmzerr = '1';
025700130307           pOut_Esito = '2';
025800130307           exsr sr_RoutEnd;
025900130307         endif;
026000130307
026100130307         // se tutto OK
026200150224         wEsito = '4';
026300130318         TITVEVTC(VLRKSC:wHDL:wEsito);
026400130307         if %error;
026500130307           pOut_Esito = '2';
026600130307           exsr sr_RoutEnd;
026700130307         endif;
026800130307
026900130307       ENDSR;
027000121106
027100091223       //--------------------------------------------------------------
027200121107       // Operazioni finali.
027300091223       //--------------------------------------------------------------
027400091223       BEGSR  sr_RoutEnd;
027500130109
027600130109         // Chiusura pgm
027700130307         if pIn_Opz = 'C' or pOut_Esito='2';
027800130307           *inlr = *on;
027900130307         else;
028000130307           *inrt = *on;
028100130307         endif;
028200130109         return;
028300091223
028400091223       ENDSR;
028500091223
028600091223      /end-free
