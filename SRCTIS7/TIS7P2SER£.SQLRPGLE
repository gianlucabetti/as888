000100150224       //==============================================================
000200130318       // Driver scrittura EDIVAT - PDF to SPOOL
000300091228       //==============================================================
000400091228
000500091228       //--------------------------------------------------------------
000600121106       // Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700091228       //--------------------------------------------------------------
000800091228
000900100325     /*PRM dbgview(*source)
001000091223     /*END
001100091228
001200091228       //--------------------------------------------------------------
001300121106       // Specifiche di controllo.
001400091228       //--------------------------------------------------------------
001500091223
001600091223     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001700100325     h dftactgrp(*no)
001800091223     h alwnull(*inputonly)
001900100325     h bnddir('UBBNDDIR')
002000091223
002100091223       //--------------------------------------------------------------
002200121106       // Dichiarazione file.
002300091223       //--------------------------------------------------------------
002400100112
002500130318     FEDIVATwr  O    E             DISK    usropn
002600091223
002700091223       //--------------------------------------------------------------
002800121106       // Definizione costanti.
002900091223       //--------------------------------------------------------------
003000100302
003100091223
003200091223       //--------------------------------------------------------------
003300121106       // Definizione schiere.
003400091223       //--------------------------------------------------------------
003500091223
003600091223
003700091223       //--------------------------------------------------------------
003800121106       // Definizione aree dati.
003900091223       //--------------------------------------------------------------
004000091223
004100091223
004200091223       //--------------------------------------------------------------
004300121106       // Definizione strutture dati.
004400091223       //--------------------------------------------------------------
004500110516
004600130307     D TIVLR00F      e ds
004700130318     D EDIVAB0F      e ds
004800130318     D FIVAB00F      e ds                  prefix(x_)
004900130307     D dscmz         e ds                  inz
005000130307     D dvatp         e ds
005100121106       // - Status
005200110516     d Psds           sds
005300110516     d   SDSpgm          *proc
005400121106     d   JobName             244    253                                         Job name
005500121106     d   JobUser             254    263                                         User name
005600121106     d   JobNumber           264    269s 0                                      Job number
005700091223
005800091223       //--------------------------------------------------------------
005900121106       // Definizione variabili.
006000091223       //--------------------------------------------------------------
006100091223
006200121106       // - Parametri ricevuti:
006300130307     d pIn_Opz         s              1a
006400130307     d pIn_CdIdAz      s              2a
006500130307     d pIn_MaskPDF     s             50a
006600130307     d pOut_Esito      s              1a
006700091223
006800121106       // Stringa SQL da eseguire
006900130108     d wSQL            s           5000    inz  varying
007000121106
007100121106       // Campi di comodo
007200130307     d wMaskPDF        s             50a
007300121106     d wDate           s              8  0 inz
007400130307     d wEsito          s              1a
007500130318     d wHDL            s                   like(VLRHDL)
007600091223
007700091223       //--------------------------------------------------------------
007800121106       // Definizione prototipi procedure.
007900091223       //--------------------------------------------------------------
008000091223
008100130318     d TITVEVTC        pr                  extpgm('TITVEVTC')
008200130307     d  parccm                        8
008300130307     d  parmbr                       10
008400130307     d  paropz                        1
008500130307
008600130307     d TIS711C         pr                  extpgm('TIS711C')
008700130307     d  cmz711                      110
008800130307     d  esito711                      1
008900130314
009000130318     d TIS7P2SR1       pr                  extpgm('TIS7P2SR1')
009100130318     d  FIVAB                              like(FIVAB00F)
009200130314     d  pIn_MaskPDF                        like(pIn_MaskPDF)
009300130314     d  wMaskPDF                           like(pIn_MaskPDF)
009400130314     d  wEsito                             like(wEsito)
009500130307
009600091223       //--------------------------------------------------------------
009700121106       // Definizione key-list.
009800091223       //--------------------------------------------------------------
009900091223
010000091223
010100091223       //--------------------------------------------------------------
010200121107       // Definizione parametri procedura.
010300091223       //--------------------------------------------------------------
010400091223
010500091223     c     *Entry        plist
010600130307     c                   parm                    pIn_Opz
010700130307     c                   parm                    TIVLR00F
010800130318     c                   parm                    EDIVAB0F
010900130307     c                   parm                    pIn_CdIdAz
011000130307     c                   parm                    pIn_MaskPDF
011100130307     c                   parm                    pOut_Esito
011200091223
011300130307      /free
011400091223
011500091223       //--------------------------------------------------------------
011600121106       // M A I N - L I N E
011700091223       //--------------------------------------------------------------
011800130307
011900130307       // Operazioni iniziali?
012000130307       exsr sr_RoutInz;
012100130307
012200130307       // attività richiesta dal chiamante
012300130307       select;
012400130307         // OPEN
012500130307         when pIn_Opz = 'O';
012600130307         exsr sr_open;
012700130307         // WRITE
012800130307         when pIn_Opz = 'W';
012900130307         exsr sr_write;
013000130307         // CLOSE
013100130307         when pIn_Opz = 'C';
013200130307         exsr sr_close;
013300130307         // richiesta errata
013400130307         other;
013500130307         pOut_Esito = '2';
013600130307         exsr sr_RoutEnd;
013700130307       endsl;
013800091223
013900121106       // Operazioni finali?
014000091223       exsr sr_RoutEnd;
014100091223
014200091223       //--------------------------------------------------------------
014300121107       // Operazioni iniziali.
014400091223       //--------------------------------------------------------------
014500091223       BEGSR  sr_RoutInz;
014600091223
014700091223         exec sql  set option  dynusrprf = *owner,
014800121107                               closqlcsr = *endmod;
014900130307
015000130307         pOut_Esito = '1';
015100121108
015200121108         // Reperimento data odierna (fmt aaaa/mm/gg)
015300121108         wDate = %dec( %date() );
015400091223
015500091223       ENDSR;
015600110523
015700110523       //--------------------------------------------------------------
015800130307       // OPEN
015900110523       //--------------------------------------------------------------
016000130307       BEGSR  sr_open;
016100110523
016200130318         wHDL = VLRHDL;
016300130318         %subst(wHDL:1:1) = 'P';
016400130307         wEsito = '1';
016500130307
016600130307         monitor;
016700130318           TITVEVTC(VLRKSC:wHDL:wEsito);
016800130307         on-error;
016900130307           pOut_Esito = '2';
017000130307           exsr sr_RoutEnd;
017100130307         endmon;
017200121106
017300121106       ENDSR;
017400130307
017500130307       //--------------------------------------------------------------
017600130307       // WRITE
017700130307       //--------------------------------------------------------------
017800130307       BEGSR  sr_write;
017900130307
018000130307
018100130307         //sostituzione
018200130307
018300130318         //il pgm che costruisce il nome pdf dalla maschera si aspetta i dati sulla DS FIVAB00F
018400130318         //EDIVAB0F è uguale a FIVAB00F tranne per i dati del CMR, che sono in più
018500130318         FIVAB00F = EDIVAB0F;
018600130318
018700130318         TIS7P2SR1(FIVAB00F:pIn_MaskPDF:wMaskPDF:wEsito);
018800130314         //se il pgm di sostituzione maschera ha trovato un errore, anch'io chiudo con errore
018900130314         if wEsito = '2';
019000130314           pOut_Esito = '2';
019100130314           exsr sr_RoutEnd;
019200130314         endif;
019300130307
019400130307
019500130307         //scrittura
019600130307
019700130318         if not %open(edivatwr);
019800130318           open edivatwr;
019900130307         endif;
020000130307
020100130307         §VATppdfn = wMaskPDF;
020200130307         §VATpidz = pIn_CdIdAz;
020300130307
020400130307         VATATB = *blanks;
020500130307         VATFGS = VABFGS;
020600130307         VATCCM = VABCCM;
020700130307         VATLNP = VABLNP;
020800130307         VATAAS = VABAAS;
020900130307         VATNRS = VABNRS;
021000130307         VATNSP = VABNSP;
021100130318         VATCMR = VABCMR;
021200130318         VATCNT = VABCNT;
021300130307         VATTRC = 'P';
021400130307         VATNOT = DVATP;
021500130307
021600130318         write edivat00;
021700130307
021800130307       ENDSR;
021900130307
022000130307       //--------------------------------------------------------------
022100130307       // CLOSE
022200130307       //--------------------------------------------------------------
022300130307       BEGSR  sr_close;
022400130318
022500130318         //chiudo il file
022600130318         if %open(edivatwr);
022700130318           close edivatwr;
022800130318         endif;
022900130307
023000130318         wHDL = VLRHDL;
023100130318         %subst(wHDL:1:1) = 'P';
023200130314         wEsito=*blank;
023300130307
023400130307         reset dscmz;
023500170706         if VLRPOI <> 999;
023600170706           cmzdst = %editc(VLRPOI:'X');
023700170706         else;
023800170706           cmzdst = %editc(VABFGS:'X');
023900170706         endif;
024000130318         cmzfld = 'EDIVATWR';
024100130318         cmzmbd = wHDL;
024200130318         cmzfla = 'EDIVAT0F';
024300130318         cmzmba = 'EDIVAT0F';
024400130307         cmznrr = *zeros;
024500130307         cmzlba = vlrfl1;
024600130307         monitor;
024700130307           TIS711C(dscmz:wEsito);
024800130307         on-error;
024900130307           pOut_Esito = '2';
025000130307           exsr sr_RoutEnd;
025100130307         endmon;
025200130307         if cmzerr = '1';
025300130307           pOut_Esito = '2';
025400130307           exsr sr_RoutEnd;
025500130307         endif;
025600130307
025700130307         // se tutto OK
025800150224         wEsito = '4';
025900130318         TITVEVTC(VLRKSC:wHDL:wEsito);
026000130307         if %error;
026100130307           pOut_Esito = '2';
026200130307           exsr sr_RoutEnd;
026300130307         endif;
026400130307
026500130307       ENDSR;
026600121106
026700091223       //--------------------------------------------------------------
026800121107       // Operazioni finali.
026900091223       //--------------------------------------------------------------
027000091223       BEGSR  sr_RoutEnd;
027100130109
027200130109         // Chiusura pgm
027300130307         if pIn_Opz = 'C' or pOut_Esito='2';
027400130307           *inlr = *on;
027500130307         else;
027600130307           *inrt = *on;
027700130307         endif;
027800130109         return;
027900091223
028000091223       ENDSR;
028100091223
028200091223      /end-free
