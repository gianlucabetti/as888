000100150224       //==============================================================
000200130307       // Driver scrittura FIVAT - PDF to SPOOL
000300091228       //==============================================================
000400091228
000500091228       //--------------------------------------------------------------
000600121106       // Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700091228       //--------------------------------------------------------------
000800091228
000900100325     /*PRM dbgview(*source)
001000091223     /*END
001100091228
001200091228       //--------------------------------------------------------------
001300121106       // Specifiche di controllo.
001400091228       //--------------------------------------------------------------
001500091223
001600091223     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001700100325     h dftactgrp(*no)
001800091223     h alwnull(*inputonly)
001900100325     h bnddir('UBBNDDIR')
002000091223
002100091223       //--------------------------------------------------------------
002200121106       // Dichiarazione file.
002300091223       //--------------------------------------------------------------
002400100112
002500130307     FFIVATwwr  O    E             DISK    usropn
002600091223
002700091223       //--------------------------------------------------------------
002800121106       // Definizione costanti.
002900091223       //--------------------------------------------------------------
003000100302
003100091223
003200091223       //--------------------------------------------------------------
003300121106       // Definizione schiere.
003400091223       //--------------------------------------------------------------
003500091223
003600091223
003700091223       //--------------------------------------------------------------
003800121106       // Definizione aree dati.
003900091223       //--------------------------------------------------------------
004000091223
004100091223
004200091223       //--------------------------------------------------------------
004300121106       // Definizione strutture dati.
004400091223       //--------------------------------------------------------------
004500110516
004600130307     D TIVLR00F      e ds
004700130307     D FIVAB00F      e ds
004800130307     D dscmz         e ds                  inz
004900130307     D dvatp         e ds
005000121106       // - Status
005100110516     d Psds           sds
005200110516     d   SDSpgm          *proc
005300121106     d   JobName             244    253                                         Job name
005400121106     d   JobUser             254    263                                         User name
005500121106     d   JobNumber           264    269s 0                                      Job number
005600091223
005700091223       //--------------------------------------------------------------
005800121106       // Definizione variabili.
005900091223       //--------------------------------------------------------------
006000091223
006100121106       // - Parametri ricevuti:
006200130307     d pIn_Opz         s              1a
006300130307     d pIn_CdIdAz      s              2a
006400130307     d pIn_MaskPDF     s             50a
006500130307     d pOut_Esito      s              1a
006600091223
006700121106       // Stringa SQL da eseguire
006800130108     d wSQL            s           5000    inz  varying
006900121106
007000121106       // Campi di comodo
007100130307     d wMaskPDF        s             50a
007200121106     d wDate           s              8  0 inz
007300130307     d wEsito          s              1a
007400130318     d wHDL            s                   like(VLRHDL)
007500091223
007600091223       //--------------------------------------------------------------
007700121106       // Definizione prototipi procedure.
007800091223       //--------------------------------------------------------------
007900091223
008000130307     d TITVVTC         pr                  extpgm('TITVVTC')
008100130307     d  parccm                        8
008200130307     d  parmbr                       10
008300130307     d  paropz                        1
008400130307
008500130307     d TIS711C         pr                  extpgm('TIS711C')
008600130307     d  cmz711                      110
008700130307     d  esito711                      1
008800130314
008900130318     d TIS7P2SR1       pr                  extpgm('TIS7P2SR1')
009000130314     d  FIVAB                              like(FIVAB00F)
009100130314     d  pIn_MaskPDF                        like(pIn_MaskPDF)
009200130314     d  wMaskPDF                           like(pIn_MaskPDF)
009300130314     d  wEsito                             like(wEsito)
009400130307
009500091223       //--------------------------------------------------------------
009600121106       // Definizione key-list.
009700091223       //--------------------------------------------------------------
009800091223
009900091223
010000091223       //--------------------------------------------------------------
010100121107       // Definizione parametri procedura.
010200091223       //--------------------------------------------------------------
010300091223
010400091223     c     *Entry        plist
010500130307     c                   parm                    pIn_Opz
010600130307     c                   parm                    TIVLR00F
010700130307     c                   parm                    FIVAB00F
010800130307     c                   parm                    pIn_CdIdAz
010900130307     c                   parm                    pIn_MaskPDF
011000130307     c                   parm                    pOut_Esito
011100091223
011200130307      /free
011300091223
011400091223       //--------------------------------------------------------------
011500121106       // M A I N - L I N E
011600091223       //--------------------------------------------------------------
011700130307
011800130307       // Operazioni iniziali?
011900130307       exsr sr_RoutInz;
012000130307
012100130307       // attività richiesta dal chiamante
012200130307       select;
012300130307         // OPEN
012400130307         when pIn_Opz = 'O';
012500130307         exsr sr_open;
012600130307         // WRITE
012700130307         when pIn_Opz = 'W';
012800130307         exsr sr_write;
012900130307         // CLOSE
013000130307         when pIn_Opz = 'C';
013100130307         exsr sr_close;
013200130307         // richiesta errata
013300130307         other;
013400130307         pOut_Esito = '2';
013500130307         exsr sr_RoutEnd;
013600130307       endsl;
013700091223
013800121106       // Operazioni finali?
013900091223       exsr sr_RoutEnd;
014000091223
014100091223       //--------------------------------------------------------------
014200121107       // Operazioni iniziali.
014300091223       //--------------------------------------------------------------
014400091223       BEGSR  sr_RoutInz;
014500091223
014600091223         exec sql  set option  dynusrprf = *owner,
014700121107                               closqlcsr = *endmod;
014800130307
014900130307         pOut_Esito = '1';
015000121108
015100121108         // Reperimento data odierna (fmt aaaa/mm/gg)
015200121108         wDate = %dec( %date() );
015300091223
015400091223       ENDSR;
015500110523
015600110523       //--------------------------------------------------------------
015700130307       // OPEN
015800110523       //--------------------------------------------------------------
015900130307       BEGSR  sr_open;
016000110523
016100130318         wHDL = VLRHDL;
016200130318         %subst(wHDL:1:1) = 'P';
016300130307         wEsito = '1';
016400130307
016500130307         monitor;
016600130318           TITVVTC(VLRKSC:wHDL:wEsito);
016700130307         on-error;
016800130307           pOut_Esito = '2';
016900130307           exsr sr_RoutEnd;
017000130307         endmon;
017100121106
017200121106       ENDSR;
017300130307
017400130307       //--------------------------------------------------------------
017500130307       // WRITE
017600130307       //--------------------------------------------------------------
017700130307       BEGSR  sr_write;
017800130307
017900130307
018000130307         //sostituzione
018100130307
018200130318         TIS7P2SR1(FIVAB00F:pIn_MaskPDF:wMaskPDF:wEsito);
018300130314         //se il pgm di sostituzione maschera ha trovato un errore, anch'io chiudo con errore
018400130314         if wEsito = '2';
018500130314           pOut_Esito = '2';
018600130314           exsr sr_RoutEnd;
018700130314         endif;
018800130307
018900130307
019000130307         //scrittura
019100130307
019200130307         if not %open(fivatwwr);
019300130307           open fivatwwr;
019400130307         endif;
019500130307
019600130307         §VATppdfn = wMaskPDF;
019700130307         §VATpidz = pIn_CdIdAz;
019800130307
019900130307         VATATB = *blanks;
020000130307         VATFGS = VABFGS;
020100130307         VATCCM = VABCCM;
020200130307         VATLNP = VABLNP;
020300130307         VATAAS = VABAAS;
020400130307         VATNRS = VABNRS;
020500130307         VATNSP = VABNSP;
020600130307         VATTRC = 'P';
020700130307         VATNOT = DVATP;
020800130307
020900130307         write fivat000;
021000130307
021100130307       ENDSR;
021200130307
021300130307       //--------------------------------------------------------------
021400130307       // CLOSE
021500130307       //--------------------------------------------------------------
021600130307       BEGSR  sr_close;
021700130318
021800130318         if %open(fivatwwr);
021900130318           close fivatwwr;
022000130318         endif;
022100130307
022200130318         wHDL = VLRHDL;
022300130318         %subst(wHDL:1:1) = 'P';
022400130314         wEsito=*blank;
022500130307
022600130307         reset dscmz;
022700170706         if VLRPOI <> 999;
022800170706           cmzdst = %editc(VLRPOI:'X');
022900170706         else;
023000170706           cmzdst = %editc(VABFGS:'X');
023100170706         endif;
023200130307         cmzfld = 'FIVATWWR';
023300130318         cmzmbd = wHDL;
023400130307         cmzfla = 'FIVAT00F';
023500130307         cmzmba = 'FIVAT00F';
023600130307         cmznrr = *zeros;
023700130307         cmzlba = vlrfl1;
023800130307         monitor;
023900130307           TIS711C(dscmz:wEsito);
024000130307         on-error;
024100130307           pOut_Esito = '2';
024200130307           exsr sr_RoutEnd;
024300130307         endmon;
024400130307         if cmzerr = '1';
024500130307           pOut_Esito = '2';
024600130307           exsr sr_RoutEnd;
024700130307         endif;
024800130307
024900130307         // se tutto OK
025000150224         wEsito = '4';
025100130406         monitor;
025200130406           TITVVTC(VLRKSC:wHDL:wEsito);
025300130406         on-error;
025400130307           pOut_Esito = '2';
025500130307           exsr sr_RoutEnd;
025600130406         endmon;
025700130307
025800130307       ENDSR;
025900121106
026000091223       //--------------------------------------------------------------
026100121107       // Operazioni finali.
026200091223       //--------------------------------------------------------------
026300091223       BEGSR  sr_RoutEnd;
026400130109
026500130109         // Chiusura pgm
026600130307         if pIn_Opz = 'C' or pOut_Esito='2';
026700130307           *inlr = *on;
026800130307         else;
026900130307           *inrt = *on;
027000130307         endif;
027100130109         return;
027200091223
027300091223       ENDSR;
027400091223
027500091223      /end-free
