000100091228       //==============================================================
000200140415       // Driver scrittura FNVAOEWR
000300091228       //==============================================================
000400091228
000500091228       //--------------------------------------------------------------
000600121106       // Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700091228       //--------------------------------------------------------------
000800091228
000900100325     /*PRM dbgview(*source)
001000091223     /*END
001100091228
001200091228       //--------------------------------------------------------------
001300121106       // Specifiche di controllo.
001400091228       //--------------------------------------------------------------
001500091223
001600091223     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001700140415     H DFTACTGRP(*NO) BNDDIR('TRUL')
001800091223     h alwnull(*inputonly)
001900091223
002000091223       //--------------------------------------------------------------
002100121106       // Dichiarazione file.
002200091223       //--------------------------------------------------------------
002300100112
002400140415     FFNVAOEWR  O    E             DISK    usropn prefix(x_)
002500140416     FTIORE00F  O    E             DISK    usropn prefix(t_)
002600091223
002700091223       //--------------------------------------------------------------
002800121106       // Definizione costanti.
002900091223       //--------------------------------------------------------------
003000100302
003100091223
003200091223       //--------------------------------------------------------------
003300121106       // Definizione schiere.
003400091223       //--------------------------------------------------------------
003500091223
003600091223
003700091223       //--------------------------------------------------------------
003800121106       // Definizione aree dati.
003900091223       //--------------------------------------------------------------
004000091223
004100091223
004200091223       //--------------------------------------------------------------
004300121106       // Definizione strutture dati.
004400091223       //--------------------------------------------------------------
004500110516
004600140415     D TIVLR00F      e ds
004700141209     D FNVAOEAER     e ds
004800140415     D DOREGEN       e ds
004900140415     D DORESMS       e ds
005000140415     D DOREORARI     e ds
005100140415     D dscmz         e ds                  inz
005200140415
005300091223
005400091223       //--------------------------------------------------------------
005500121106       // Definizione variabili.
005600091223       //--------------------------------------------------------------
005700091223
005800121106       // - Parametri ricevuti:
005900130307     d pIn_Opz         s              1a
006000140416     d pIn_OREPRG      s                   like(t_orePRG)
006100140528     d pIn_Dst         s              3a
006200130307     d pOut_Esito      s              1a
006300121106
006400121106       // Campi di comodo
006500121106     d wDate           s              8  0 inz
006600130307     d wEsito          s              1a
006700140415     d wHDL            s                   like(VLRHDL)
006800091223
006900091223       //--------------------------------------------------------------
007000121106       // Definizione prototipi procedure.
007100091223       //--------------------------------------------------------------
007200140415
007300140415     d TITVVOEC        pr                  extpgm('TITVVOEC')
007400140415     d  parccm                        8
007500140415     d  parmbr                       10
007600140415     d  paropz                        1
007700140415
007800140415     d TIS711C         pr                  extpgm('TIS711C')
007900140415     d  cmz711                      110
008000140415     d  esito711                      1
008100130307
008200091223       //--------------------------------------------------------------
008300121106       // Definizione key-list.
008400091223       //--------------------------------------------------------------
008500091223
008600091223
008700091223       //--------------------------------------------------------------
008800121107       // Definizione parametri procedura.
008900091223       //--------------------------------------------------------------
009000091223
009100091223     c     *Entry        plist
009200130307     c                   parm                    pIn_Opz
009300140415     c                   parm                    TIVLR00F
009400141209     c                   parm                    FNVAOEAER
009500140416     c                   parm                    pIn_OREPRG
009600140528     c                   parm                    pIn_Dst
009700130307     c                   parm                    pOut_Esito
009800091223
009900130307      /free
010000091223
010100091223       //--------------------------------------------------------------
010200121106       // M A I N - L I N E
010300091223       //--------------------------------------------------------------
010400130307
010500130307       // Operazioni iniziali?
010600130307       exsr sr_RoutInz;
010700130307
010800130307       // attività richiesta dal chiamante
010900130307       select;
011000140415         // OPEN
011100130307         when pIn_Opz = 'O';
011200140416              exsr sr_open;
011300130307         // WRITE
011400130307         when pIn_Opz = 'W';
011500140416              exsr sr_write;
011600130307         // CLOSE
011700130307         when pIn_Opz = 'C';
011800140416              exsr sr_close;
011900140528         // SEND
012000140528         when pIn_Opz = 'S';
012100140528              exsr sr_send;
012200130307         // richiesta errata
012300130307         other;
012400140416              pOut_Esito = '2';
012500140416              exsr sr_RoutEnd;
012600130307       endsl;
012700091223
012800121106       // Operazioni finali?
012900091223       exsr sr_RoutEnd;
013000091223
013100091223       //--------------------------------------------------------------
013200121107       // Operazioni iniziali.
013300091223       //--------------------------------------------------------------
013400091223       BEGSR  sr_RoutInz;
013500130307
013600130307         pOut_Esito = '1';
013700121108
013800121108         // Reperimento data odierna (fmt aaaa/mm/gg)
013900121108         wDate = %dec( %date() );
014000091223
014100091223       ENDSR;
014200110523
014300110523       //--------------------------------------------------------------
014400130307       // OPEN
014500110523       //--------------------------------------------------------------
014600130307       BEGSR  sr_open;
014700140415
014800140415         wHDL = VLRHDL;
014900140415         %subst(wHDL:1:1) = 'P';
015000140415         wEsito = '1';
015100140415
015200140415         monitor;
015300140415           TITVVOEC(VLRKSC:wHDL:wEsito);
015400140415         on-error;
015500140415           pOut_Esito = '2';
015600140415           exsr sr_RoutEnd;
015700140415         endmon;
015800121106
015900121106       ENDSR;
016000130307
016100130307       //--------------------------------------------------------------
016200130307       // WRITE
016300130307       //--------------------------------------------------------------
016400130307       BEGSR  sr_write;
016500130307
016600140415         if not %open(fnvaoewr);
016700140415           open fnvaoewr;
016800130307         endif;
016900140416         if not %open(tiore00f);
017000140416           open tiore00f;
017100140416         endif;
017200140415
017300140415         PiStr=VAOCOR;
017400140415         exsr CHKNUM;
017500140415         if PiInt=*on;
017600140415           x_VAOECOR = PiVal;
017700140415         else;
017800140415           pOut_Esito = '2';
017900140415           exsr sr_RoutEnd;
018000140415         endif;
018100140415         PiStr=VAOPOE;
018200140415         exsr CHKNUM;
018300140415         if PiInt=*on;
018400140415           x_VAOEPOE = PiVal;
018500140415         else;
018600140415           pOut_Esito = '2';
018700140415           exsr sr_RoutEnd;
018800140415         endif;
018900140415         PiStr=VAONSR;
019000140416         if %trim(PiStr) <> *blanks AND %trim(PiStr) <> *zeros;
019100140416            exsr CHKNUM;
019200140416            if PiInt=*on;
019300140416              x_VAOENSR = PiVal;
019400140416            else;
019500140416              pOut_Esito = '2';
019600140416              exsr sr_RoutEnd;
019700140416            endif;
019800140416         endif;
019900140415         PiStr=VAONOR;
020000140416         if %trim(PiStr) <> *blanks AND %trim(PiStr) <> *zeros;
020100140416            exsr CHKNUM;
020200140416            if PiInt=*on;
020300140416              x_VAOENOR = PiVal;
020400140416            else;
020500140416              pOut_Esito = '2';
020600140416              exsr sr_RoutEnd;
020700140416            endif;
020800140416         endif;
020900140415         PiStr=VAONRV;
021000140416         if %trim(PiStr) <> *blanks AND %trim(PiStr) <> *zeros;
021100140416            exsr CHKNUM;
021200140416            if PiInt=*on;
021300140416              x_VAOENRV = PiVal;
021400140416            else;
021500140416              pOut_Esito = '2';
021600140416              exsr sr_RoutEnd;
021700140416            endif;
021800140416         endif;
021900140415
022000140415         //TRC = G
022100140415         x_VAOETRC = 'G';
022200140415         clear DOREGEN;
022300140415         §ORETSP = VAOTSPS;
022400140415         §OREFIMV = VAOEMLRF;
022500140415         §OREFISV = VAOSMSRF;
022600140415         §OREORIP = VAOORIP ;
022700140415         §OREDOIO = VAODOIO ;
022800140415         x_VAOEDATI = DOREGEN;
022900140416         if x_VAOEDATI <> *blanks;
023000140416            write fnvaoe00;
023100140416            exsr sr_WriTIORE;
023200140416         endif;
023300140415
023400140415         //TRC = MA
023500140415         x_VAOETRC = 'MA';
023600140415         x_VAOEDATI = VAOEMLR;
023700140416         if x_VAOEDATI <> *blanks;
023800140416            write fnvaoe00;
023900140416            exsr sr_WriTIORE;
024000140416         endif;
024100140415
024200140415         //TRC = N
024300140415         x_VAOETRC = 'N';
024400140415         x_VAOEDATI = VAONOTE;
024500140416         if x_VAOEDATI <> *blanks;
024600140416            write fnvaoe00;
024700140416            exsr sr_WriTIORE;
024800140416         endif;
024900140415
025000140415         //TRC = S
025100140415         x_VAOETRC = 'S';
025200140415         clear DORESMS;
025300140415         §ORESMS = VAOSMSR;
025400140416         x_VAOEDATI = DORESMS;
025500140416         if x_VAOEDATI <> *blanks;
025600140416            write fnvaoe00;
025700140416            exsr sr_WriTIORE;
025800140416         endif;
025900140415
026000140415         //TRC = O
026100140415         x_VAOETRC = 'O';
026200140415         clear DOREORARI;
026300140417         *in50 = *on;
026400140417
026500140417         // Verifico se nessun orario indicato => non scrivo il record
026600140417         if VAOORDA1 = *blanks AND
026700140417            VAOORAA1 = *blanks AND
026800140417            VAOORDA2 = *blanks AND
026900140417            VAOORAA1 = *blanks;
027000140417            *in50 = *off;
027100140417         endif;
027200140417
027300140417         PiStr=VAOORDA1;
027400140417         exsr CHKNUM;
027500140417         if PiInt=*on;
027600140417           §OREORAMDA = PiVal;
027700140417         else;
027800140417           // scrivo quelli corretti
027900140417         endif;
028000140417         PiStr=VAOORAA1;
028100140417         exsr CHKNUM;
028200140417         if PiInt=*on;
028300140417           §OREORAMA  = PiVal;
028400140417         else;
028500140417           // scrivo quelli corretti
028600140417         endif;
028700140417         PiStr=VAOORDA2;
028800140417         exsr CHKNUM;
028900140417         if PiInt=*on;
029000140417           §OREORAPDA = PiVal;
029100140417         else;
029200140417           // scrivo quelli corretti
029300140417         endif;
029400140417         PiStr=VAOORAA2;
029500140417         exsr CHKNUM;
029600140417         if PiInt=*on;
029700140417           §OREORAPA  = PiVal;
029800140417         else;
029900140417           // scrivo quelli corretti
030000140417         endif;
030100140417
030200140415         x_VAOEDATI = DOREORARI;
030300140417         if *in50 AND x_VAOEDATI <> *blanks;
030400140416            write fnvaoe00;
030500140416            exsr sr_WriTIORE;
030600140416         endif;
030700130307
030800130307       ENDSR;
030900140416
031000140416       //--------------------------------------------------------------
031100140416       // Scrittura TIORE00F
031200140416       //--------------------------------------------------------------
031300140416       BEGSR  sr_WriTIORE;
031400140416
031500140416           if %subst(vlrppt:4:1) <> 'T';
031600140416              t_OREPRG   = pIn_OREPRG;
031700140416              t_VAOETRC  = x_VAOETRC;
031800140416              t_VAOEDATI = x_VAOEDATI;
031900140416              write tiore000;
032000140416           endif;
032100140416
032200140416       ENDSR;
032300140528
032400140528       //--------------------------------------------------------------
032500140528       // CLOSE
032600140528       //--------------------------------------------------------------
032700140528       BEGSR  sr_close;
032800140528
032900140528         //chiudo il file
033000140528         if %open(fnvaoewr);
033100140528           close fnvaoewr;
033200140528         endif;
033300140528         if %open(tiore00f);
033400140528           close tiore00f;
033500140528         endif;
033600140528
033700140528       ENDSR;
033800140528
033900140528       //--------------------------------------------------------------
034000140528       // SEND
034100140528       //--------------------------------------------------------------
034200140528       BEGSR  sr_send;
034300140528
034400140528         wHDL = VLRHDL;
034500140528         %subst(wHDL:1:1) = 'P';
034600140528         wEsito=*blank;
034700140528
034800140528         reset dscmz;
034900140528         cmzdst = pIn_Dst;
035000140528         cmzfld = 'FNVAOEWR';
035100140528         cmzmbd = wHDL;
035200140528         cmzfla = 'FNVAOE0F';
035300140528         cmzmba = 'FNVAOE0F';
035400140528         cmznrr = *zeros;
035500140528         cmzlba = vlrfl1;
035600140528         monitor;
035700140528           TIS711C(dscmz:wEsito);
035800140528         on-error;
035900140528           pOut_Esito = '2';
036000140528           exsr sr_RoutEnd;
036100140528         endmon;
036200140528         if cmzerr = '1';
036300140528           pOut_Esito = '2';
036400140528           exsr sr_RoutEnd;
036500140528         endif;
036600140528
036700140528         // se tutto OK
036800140528         wEsito = '2';
036900140528         TITVVOEC(VLRKSC:wHDL:wEsito);
037000140528         if %error;
037100140528           pOut_Esito = '2';
037200140528           exsr sr_RoutEnd;
037300140528         endif;
037400140528
037500140528       ENDSR;
037600121106
037700091223       //--------------------------------------------------------------
037800121107       // Operazioni finali.
037900091223       //--------------------------------------------------------------
038000091223       BEGSR  sr_RoutEnd;
038100130109
038200130109         // Chiusura pgm
038300130307         if pIn_Opz = 'C' or pOut_Esito='2';
038400130307           *inlr = *on;
038500130307         else;
038600130307           *inrt = *on;
038700130307         endif;
038800130109         return;
038900091223
039000091223       ENDSR;
039100091223
039200091223      /end-free
039300140415
039400140415     C*----------------------------------------------------*
039500140415     C*  CONTROLLO NUMERICITA' CAMPI
039600140415     C*----------------------------------------------------*
039700140415     C     CHKNUM        BEGSR
039800140415     C*
039900140415     C                   call(e)   'ISNUMERIC'
040000140415     C                   PARM                    PiStr            30
040100140415     C                   PARM      '.'           PiDecChr          1
040200140415     C                   PARM      *ZEROS        PiVal            30 9
040300140415     C                   PARM      '0'           PiInt             1
040400140415     C                   PARM      '0'           PiNum             1
040500140415     C                   IF        %error
040600140415     C                   EVAL      PiInt=*off
040700140415     C                   ENDIF
040800140415     C*
040900140415     C                   ENDSR
