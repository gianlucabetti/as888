000100091228       //==============================================================
000200151118       // Driver scrittura FNVAOEADS
000300091228       //==============================================================
000400091228
000500091228       //--------------------------------------------------------------
000600151118       // Parametri di compilazione (vedi *cmd UBCRTOBJ)               ?
000700091228       //--------------------------------------------------------------
000800091228
000900100325     /*PRM dbgview(*source)
001000091223     /*END
001100151118
001200091228       //--------------------------------------------------------------
001300121106       // Specifiche di controllo.
001400091228       //--------------------------------------------------------------
001500091223
001600151118     H decedit('0,') datedit(*dmy/) option(*nodebugio)
001700151118     H DFTACTGRP(*NO) BNDDIR('TRUL')
001800151118     H alwnull(*inputonly)
001900091223
002000091223       //--------------------------------------------------------------
002100121106       // Dichiarazione file.
002200091223       //--------------------------------------------------------------
002300100112
002400151118     FTIVGD00F  UF A E             DISK
002500151119     FFNORE01L  IF   E           K DISK
002600091223
002700091223       //--------------------------------------------------------------
002800121106       // Definizione costanti.
002900091223       //--------------------------------------------------------------
003000100302
003100091223
003200091223       //--------------------------------------------------------------
003300121106       // Definizione schiere.
003400091223       //--------------------------------------------------------------
003500091223
003600091223
003700091223       //--------------------------------------------------------------
003800121106       // Definizione aree dati.
003900091223       //--------------------------------------------------------------
004000091223
004100091223
004200091223       //--------------------------------------------------------------
004300121106       // Definizione strutture dati.
004400091223       //--------------------------------------------------------------
004500110516
004600151119     D FNORMDS       E DS                  extname(FNORM00F)
004700151118     D FNVAOEADS     E DS                  inz
004800151118     D DOREGEN       E DS                  inz
004900151118     D DORESMS       E DS                  inz
005000151118     D DOREORARI     E DS                  inz
005100151118     D trul47ds      E DS                  inz
005200140415
005300091223
005400091223       //--------------------------------------------------------------
005500121106       // Definizione variabili.
005600091223       //--------------------------------------------------------------
005700091223
005800121106       // - Parametri ricevuti:
005900151118     D pIn_Opz         S              5A
006000151118     D pIn_KSU         S                   like(vgdKSU)
006100151118     D pOut_Esito      S              1A
006200121106
006300121106       // Campi di comodo
006400151118     D wDatCor         S              8  0 inz
006500091223
006600151118
006700091223       //--------------------------------------------------------------
006800121106       // Definizione prototipi procedure.
006900091223       //--------------------------------------------------------------
007000151118
007100151118     D TRUL47R         PR                  extpgm('TRUL47R')
007200151119     D  trul47ds                           like(trul47ds)
007300151118
007400130307
007500091223       //--------------------------------------------------------------
007600121106       // Definizione key-list.
007700091223       //--------------------------------------------------------------
007800091223
007900091223
008000091223       //--------------------------------------------------------------
008100121107       // Definizione parametri procedura.
008200091223       //--------------------------------------------------------------
008300091223
008400151118     C     *Entry        plist
008500151118     C                   parm                    pIn_Opz
008600151118     C                   parm                    pIn_KSU
008700151118     C                   parm                    FNORMDS
008800151118     C                   parm                    pOut_Esito
008900091223
009000130307      /free
009100091223
009200091223       //--------------------------------------------------------------
009300121106       // M A I N - L I N E
009400091223       //--------------------------------------------------------------
009500130307
009600130307       // Operazioni iniziali?
009700130307       exsr sr_RoutInz;
009800151119
009900151119       // Controllo passaggio parametri
010000151119       exsr sr_ChkParam;
010100130307
010200151118       // Gestisco attività richiesta dal chiamante
010300130307       select;
010400140415         // OPEN
010500151118         when pIn_Opz = 'OPEN';
010600140416              exsr sr_open;
010700130307         // WRITE
010800151118         when pIn_Opz = 'WRITE';
010900140416              exsr sr_write;
011000130307         // CLOSE
011100151118         when pIn_Opz = 'CLOSE';
011200140416              exsr sr_close;
011300140528         // SEND
011400130307         other;
011500151119              pOut_Esito = '3';
011600140416              exsr sr_RoutEnd;
011700130307       endsl;
011800091223
011900121106       // Operazioni finali?
012000091223       exsr sr_RoutEnd;
012100091223
012200151118
012300151118
012400091223       //--------------------------------------------------------------
012500121107       // Operazioni iniziali.
012600091223       //--------------------------------------------------------------
012700091223       BEGSR  sr_RoutInz;
012800130307
012900151118         pOut_Esito = '1';
013000151118
013100151118         // Reperimento data odierna (fmt aaaa/mm/gg)
013200151118         wDatCor = %dec( %date() : *ISO);
013300151202
013400151202         // Inizializzazione DS di oputput
013500151202         clear FNVAOEADS;
013600091223
013700091223       ENDSR;
013800151119
013900151119
014000151119
014100151119       //--------------------------------------------------------------
014200151119       // Controllo passaggio parametri
014300151119       //--------------------------------------------------------------
014400151119       BEGSR  sr_ChkParam;
014500151119
014600151119         if pIn_Opz = 'WRITE' and FNORMDS = *blanks;
014700151119              pOut_Esito = '3';
014800151119              exsr sr_RoutEnd;
014900151119         endif;
015000151119
015100151119         if pIn_KSU = *blanks;
015200151119              pOut_Esito = '3';
015300151119              exsr sr_RoutEnd;
015400151119         endif;
015500151119
015600151119       ENDSR;
015700110523
015800151118
015900151118
016000110523       //--------------------------------------------------------------
016100130307       // OPEN
016200110523       //--------------------------------------------------------------
016300130307       BEGSR  sr_open;
016400151118
016500151118         clear trul47ds;
016600151118         d47opz  = 'I';
016700151118         d47tip  = 'BO';
016800151118         d47lck  = 'N';
016900151118         d47chkj = 'N';
017000151118         d47pgm  = 'TIS7TBOR';
017100140415
017200140415         monitor;
017300151118           TRUL47R(trul47ds);
017400151118           if d47sts <> 'A' and d47sts <> '1';
017500151118           else;
017600151118              pOut_Esito = '2';
017700151118              exsr sr_RoutEnd;
017800151118           endif;
017900140415         on-error;
018000140415           pOut_Esito = '2';
018100140415           exsr sr_RoutEnd;
018200140415         endmon;
018300121106
018400121106       ENDSR;
018500130307
018600151118
018700151118
018800130307       //--------------------------------------------------------------
018900130307       // WRITE
019000130307       //--------------------------------------------------------------
019100130307       BEGSR  sr_write;
019200151118
019300151118         // Reperisco eventuali estensioni del ORM corrente
019400151119         exsr sr_ValORE;
019500151127
019600151127         // Trasposizione campi "ORM" in campi "VAO"
019700151127         exsr sr_ORM2VAO;
019800151118
019900151118         // Infine scarico il buffer di output
020000151119         exsr sr_WriVGD;
020100130307
020200130307       ENDSR;
020300151118
020400151118
020500151118
020600151118       //--------------------------------------------------------------
020700151118       // Reperimento estensione ORM
020800151118       //--------------------------------------------------------------
020900151118       BEGSR  sr_ValORE;
021000151118
021100151118         monitor;
021200151118
021300151118           // Quindi procedo con l'elaborazione delle estensioni ORM
021400151118           setll (ormPOE:ormNSR:ormNOR:ormNRV) fnore01l;
021500151118           reade (ormPOE:ormNSR:ormNOR:ormNRV) fnore01l;
021600151118
021700151118           // leggo TUTTO il fnore01l
021800151118           dow not %eof(fnore01l);
021900151118
022000151118             //TRC = G
022100151118             if ORETRC = 'G';
022200151118                clear DOREGEN;
022300151118                DOREGEN  = OREDATI;
022400151118                VAOTSPS  = §ORETSP;
022500151118                VAOEMLRF = §OREFIMV;
022600151118                VAOSMSRF = §OREFISV;
022700151118                VAOORIP  = §OREORIP;
022800151118                VAODOIO  = §OREDOIO;
022900151118             endif;
023000151118
023100151118             //TRC = MA
023200151118             if ORETRC = 'MA';
023300151118                VAOEMLR = OREDATI;
023400151118             endif;
023500151118
023600151118             //TRC = N
023700151118             if ORETRC = 'N';
023800151118                VAONOTE = OREDATI;
023900151118             endif;
024000151118
024100151118             //TRC = S
024200151118             if ORETRC = 'S';
024300151118                clear DORESMS;
024400151118                DORESMS  = OREDATI;
024500151118                VAOSMSR  = §ORESMS;
024600151118             endif;
024700151118
024800151118             //TRC = O
024900151118             if ORETRC = 'O';
025000151118                clear DOREORARI;
025100151118                DOREORARI = OREDATI;
025200151118                VAOSMSR   = §ORESMS;
025300151118                VAOORDA1  = §OREORAMDA;
025400151118                VAOORAA1  = §OREORAMA;
025500151118                VAOORDA2  = §OREORAPDA;
025600151118                VAOORAA1  = §OREORAPA;
025700151118             endif;
025800151118
025900151118             // Proseguo con la lettura
026000151118             reade (ormPOE:ormNSR:ormNOR:ormNRV) fnore01l;
026100151118
026200151118           enddo;
026300151118
026400151118         on-error;
026500151118           pOut_Esito = '2';
026600151118           exsr sr_RoutEnd;
026700151118         endmon;
026800151118
026900151118       ENDSR;
027000151130
027100151130
027200151130
027300151130       //--------------------------------------------------------------
027400151130       // Trasposizione campi "ORM" in campi "VAO"
027500151130       //--------------------------------------------------------------
027600151130       BEGSR  sr_ORM2VAO;
027700151130
027800151130         monitor;
027900151130
028000151130             VAOATB  = ORMATB;
028100151130             VAOPOE  = ORMPOE;
028200151130             VAONSR  = ORMNSR;
028300151130             VAONOR  = ORMNOR;
028400151130             VAONRV  = ORMNRV;
028500151130             VAOTOR  = ORMTOR;
028600151130             VAOTCO  = ORMTCO;
028700151130             VAODAO  = ORMDAO;
028800151130             VAOOAO  = ORMOAO;
028900151130             VAOCOR  = ORMCOR;
029000151130             VAORSO  = ORMRSO;
029100151130             VAOINO  = ORMINO;
029200151130             VAOCAO  = ORMCAO;
029300151130             VAOLOO  = ORMLOO;
029400151130             VAOPRO  = ORMPRO;
029500151130             VAONAO  = ORMNAO;
029600151130             VAOCRA  = ORMCRA;
029700151130             VAORSR  = ORMRSR;
029800151130             VAOINR  = ORMINR;
029900151130             VAOCAR  = ORMCAR;
030000151130             VAOLOR  = ORMLOR;
030100151130             VAOPRR  = ORMPRR;
030200151130             VAONAR  = ORMNAR;
030300151130             VAORER  = ORMRER;
030400151130             VAOTER  = ORMTER;
030500151130             VAOCRC  = ORMCRC;
030600151130             VAORSC  = ORMRSC;
030700151130             VAOINC  = ORMINC;
030800151130             VAOCAC  = ORMCAC;
030900151130             VAOLOC  = ORMLOC;
031000151130             VAOPRC  = ORMPRC;
031100151130             VAONAC  = ORMNAC;
031200151130             VAOFFD  = ORMFFD;
031300151130             VAODAR  = ORMDAR;
031400151130             VAOORR  = ORMORR;
031500151130             VAORMP  = ORMRMP;
031600151130             VAONAM  = ORMNAM;
031700151130             VAONCL  = ORMNCL;
031800151130             VAOPKG  = ORMPKG;
031900151130             VAOVLM  = ORMVLM;
032000151130             VAOBNC  = ORMBNC;
032100151130             VAOBLC  = ORMBLC;
032200151130             VAOATT  = ORMATT;
032300151130             VAOMTC  = ORMMTC;
032400151130             VAOPAG  = ORMPAG;
032500151130             VAOKSC  = ORMKSC;
032600151130             VAOCTR  = ORMCTR;
032700151130             VAOPOR  = ORMPOR;
032800151130             VAOZOR  = ORMZOR;
032900151130             VAOPOC  = ORMPOC;
033000151130             VAONO1  = ORMNO1;
033100151130             VAONO2  = ORMNO2;
033200151130             VAODDT  = ORMDDT;
033300151130             VAORFA  = ORMRFA;
033400151130             VAOSTO  = ORMSTO;
033500151130             VAOSPI  = ORMSPI;
033600151130             VAOFLO  = ORMFLO;
033700151130
033800151130         on-error;
033900151130           pOut_Esito = '2';
034000151130           exsr sr_RoutEnd;
034100151130         endmon;
034200151130
034300151130       ENDSR;
034400140416
034500151118
034600151118
034700140416       //--------------------------------------------------------------
034800140416       // Scrittura TIORE00F
034900140416       //--------------------------------------------------------------
035000151118       BEGSR  sr_WriVGD;
035100140416
035200151118         clear tivgd000;
035300151118         vgdDTA = FNVAOEADS;
035400151118         vgdTIP = 'BO';
035500151118         vgdKSU = pIn_KSU;
035600151118         vgdTSC = 'WW';
035700151118         vgdDAT = wDatCor;
035800151118         vgdPGM = 'TIS7TBOR';
035900151118         write(e) tivgd000;
036000151118         if %error;
036100151118            pOut_Esito = '2';
036200151118            exsr sr_RoutEnd;
036300151118         endif;
036400140416
036500140416       ENDSR;
036600140528
036700151118
036800151118
036900140528       //--------------------------------------------------------------
037000140528       // CLOSE
037100140528       //--------------------------------------------------------------
037200140528       BEGSR  sr_close;
037300151118
037400151118         clear trul47ds;
037500151118         d47opz  = 'F';
037600151118         d47tip  = 'BO';
037700151118         d47pgm  = 'TIS7TBOR';
037800151118
037900151118         monitor;
038000151118           TRUL47R(trul47ds);
038100151118         on-error;
038200151118           pOut_Esito = '2';
038300151118           exsr sr_RoutEnd;
038400151118         endmon;
038500140528
038600140528       ENDSR;
038700140528
038800151118
038900121106
039000091223       //--------------------------------------------------------------
039100121107       // Operazioni finali.
039200091223       //--------------------------------------------------------------
039300091223       BEGSR  sr_RoutEnd;
039400130109
039500130109         // Chiusura pgm
039600151118         if pIn_Opz = 'CLOSE' or pOut_Esito='2';
039700130307           *inlr = *on;
039800130307         else;
039900130307           *inrt = *on;
040000130307         endif;
040100130109         return;
040200091223
040300091223       ENDSR;
040400091223
040500091223      /end-free
040600140415
