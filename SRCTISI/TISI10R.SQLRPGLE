000100081204      *PARMS CLOSQLCSR(*ENDMOD) DBGVIEW(*SOURCE) DYNUSRPRF(*OWNER)
000200081204      *PARMS OPTION(*NOXREF)
000300081205       //--------------------------------------------------------------
000400081205       //?Cancellazione records annullati dagli archivi del CAPPARIO:
000500081205       //?· AZCPC00F     · AZCPE00F     · AZCPL00F
000600081205       //?· AZCPR00F     · AZCPS00F     · AZCPT00F
000700081205       //?· AZCAE00F     · AZCAS00F     · AZCLN00F
000800081205       //--------------------------------------------------------------
000900081204
001000081205     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001100081204     h alwnull(*inputonly)
001200081204
001300081205       //--------------------------------------------------------------
001400081205       //?Dichiarazione file.
001500081205       //--------------------------------------------------------------
001600081204
001700081204
001800081205       //--------------------------------------------------------------
001900081205       //?Definizione costanti.
002000081205       //--------------------------------------------------------------
002100081204
002200081204
002300081205       //--------------------------------------------------------------
002400081205       //?Definizione schiere.
002500081205       //--------------------------------------------------------------
002600081204
002700081204     d $File           s             10    dim( 9)  ctdata   perrcd(1)
002800081204     d $Atb            s             10    dim(%elem($File)) alt($File)
002900081204
003000081205       //--------------------------------------------------------------
003100081205       //?Definizione aree dati.
003200081205       //--------------------------------------------------------------
003300081204
003400081204
003500081205       //--------------------------------------------------------------
003600081205       //?Definizione strutture dati.
003700081205       //--------------------------------------------------------------
003800081204
003900081205       // - Status ds
004000081205     d Status         sds
004100081205     d  SDSprm           *parms
004200081205     d  SDSusr               254    263
004300090126
004400090126       // - Parametri
004500090126     d kpjba         e ds
004600081204
004700081205       //--------------------------------------------------------------
004800081205       //?Definizione variabili globali.
004900081205       //--------------------------------------------------------------
005000081205
005100090126       // - Parametri eventualmente ricevuti
005200090126     d £File           s             10    inz
005300081204
005400081205       // - Indici di schiere
005500081204     d xx              s              3  0 inz
005600081204
005700090126       // - Stringa SQL da eseguire
005800090126     d wrkSQLstr       s            512a   varying  inz
005900081204
006000081205       //--------------------------------------------------------------
006100081205       //?Definizione procedure usate.
006200081205       //--------------------------------------------------------------
006300081204
006400081204
006500081205       //--------------------------------------------------------------
006600081205       //?Definizione key-list.
006700081205       //--------------------------------------------------------------
006800081204
006900081204
007000081205       //--------------------------------------------------------------
007100081205       //?Riepilogo indicatori utilizzati.
007200081205       //--------------------------------------------------------------
007300081205       //--------------------------------------------------------------
007400081204
007500081204
007600081205       //--------------------------------------------------------------
007700081205       //?M A I N - L I N E
007800081205       //--------------------------------------------------------------
007900081205
008000081205     c     *Entry        plist
008100090126     c                   parm                    kpjba
008200081204
008300081204      /free
008400081204
008500081204       // Operazioni iniziali
008600090126       // ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
008700081205       exsr  sr_RoutInz;
008800081205
008900081205
009000081205       // Ricevuto parametro con il nome del file da gestire
009100090126       // ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
009200090126       IF  £File <> *blank;
009300081205
009400081205         // Cancellazione record annullati dal solo file il cui nome
009500090126         // ¯ è stato ricevuto come parametro ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
009600090126         //   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
009700081205         xx = %lookup(£File : $File);
009800081205
009900081205         if  xx > *zero   and   $Atb(xx) <> *blank;
010000081205           exsr  sr_ExecSQL;
010100081205         endif;
010200081205
010300081205       ELSE;
010400081204
010500081205         // Cancellazione record annullati dagli archivi in schiera
010600090126         // ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
010700081205         for  xx = 1  to  %elem($File);
010800081205
010900081205           if  $File(xx) <> *blank   and   $Atb(xx) <> *blank;
011000081205             exsr sr_ExecSQL;
011100081205           endif;
011200081205
011300081205         endfor;
011400081204
011500081205       ENDIF;
011600081205
011700081205
011800081204       // Operazioni finali
011900090126       // ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
012000081205       exsr  sr_RoutEnd;
012100081204
012200081204       //--------------------------------------------------------------
012300081204       //?Operazioni iniziali.
012400081204       //--------------------------------------------------------------
012500081205       BEGSR  sr_RoutInz;
012600081204
012700081204         *inLR = *on;
012800081204
012900090126         // Impostazione parametri eventualmente ricevuti
013000090126         // ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
013100090126         clear  £File;
013200090126         select;
013300090126           when  SDSprm > *zero;
013400090126             if  kpjbu <> *blank;
013500090126               £File = %subst(kpjbu : 1);
013600090126             endif;
013700090126           when  SDSprm = *zero;
013800090126             clear  £File;
013900090126         endsl;
014000090126
014100081204         // Impostazione opzioni per SQL
014200090126         // ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
014300081204         exec SQL   set option   DynUsrPrf = *owner,
014400081204                                 CloSqlCsr = *endmod;
014500081204
014600081204       ENDSR;
014700081204
014800081204       //--------------------------------------------------------------
014900081204       //?Cancellazione records annullati dal singolo file in esame
015000081204       //--------------------------------------------------------------
015100081205       BEGSR  sr_ExecSQL;
015200081204
015300081204         wrkSQLstr = 'DELETE from ' + %trimr($File(xx))
015400090126                   + ' where '      + %trimr($Atb(xx)) + ' <> '' ''';
015500081204
015600081204         exec SQL   execute immediate :wrkSQLstr;
015700081204
015800090126         // In caso di errore: segnala (stampa), ma NON chiude il pgm
015900090126         // ¯ e prosegue con il file successivo ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
016000090126         //   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
016100081204         if  sqlCode < *zero;
016200081204           dump(a);
016300090126           //exsr  sr_RoutEnd;         // NON chiudere il pgm !!!
016400081204         endif;
016500081204
016600081204       ENDSR;
016700081204
016800081204       //--------------------------------------------------------------
016900081204       //?Operazioni finali.
017000081204       //--------------------------------------------------------------
017100081205       BEGSR  sr_RoutEnd;
017200081204
017300081204         return;
017400081204
017500081204       ENDSR;
017600081204
017700081204      /end-free
017800081204
017900090126      //---------------------------------------------------------------
018000090126      //?Schiere a tempo di compilazione
018100090126      //---------------------------------------------------------------
018200081204** - $File / $Atb
018300081204AZCPC00F  CPCatb      1
018400081204AZCPE00F  CPEatb      2
018500081204AZCPL00F  CPLatb      3
018600081204AZCPR00F  CPRatb      4
018700081204AZCPS00F  CPSatb      5
018800090126AZCPT00F  CPTatb      6
018900081204AZCAE00F  CAEatb      7
019000081204AZCAS00F  CASatb      8
019100081204AZCLN00F  CLNatb      9
