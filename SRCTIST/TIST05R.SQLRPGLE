000100100201       //==============================================================
000200120904       //?TIST05R * Conteggio anomalia 005 per TFP/TFA
000300100201       //==============================================================
000400100201
000700100201       //--------------------------------------------------------------
000800100201
000900100201     /*PRM closqlcsr(*endmod) dbgview(*source) dynusrprf(*owner)
001000100201     /*PRM commit(*none)
001100100201     /*END
001200100201
001300100201       //--------------------------------------------------------------
001400100201       //?Specifiche di controllo.                                     ?
001500100201       //--------------------------------------------------------------
001600100201
001700100201     h decedit('0,') datedit(*ymd/) option(*nodebugio)
002000100201
002100100201       //--------------------------------------------------------------
002200100201       //?Dichiarazione file.                                          ?
002300100201       //--------------------------------------------------------------
002400100201
002401120905     FWfan500f  o  A e             disk    usropn
002500100201
002600100201       //--------------------------------------------------------------
002700100201       //?Definizione costanti.                                        ?
002800100201       //--------------------------------------------------------------
002900100201
003500100201
003600100201       //--------------------------------------------------------------
003700100201       //?Definizione schiere.                                         ?
003800100201       //--------------------------------------------------------------
003900100201
004000100201
004100100201       //--------------------------------------------------------------
004200100201       //?Definizione aree dati.                                       ?
004300100201       //--------------------------------------------------------------
004400100201
004500100201       // -?Dati utente?
004600100201     d §AzUte        e ds                  extname(AZUTE00F)
004700100201     d                                     dtaara
004800100201     d §DatiUte      e ds                  extname(dDatiUte)
004900100201     d                                     dtaara
005000100201
005100100201       //--------------------------------------------------------------
005200100201       //?Definizione strutture dati.                                  ?
005300100201       //--------------------------------------------------------------
005400100201
005500100201       // -?Parametri ricevuti?
005600100201     d KPJBA         e ds
005700120904     d Tist05ds      e ds                  inz
005800100201
005900100201       // -?Parametri per Reperimento dati utente?
006000100201     d TIBS34ds      e ds                  inz
006100100201
006800100201       // -?Dati estratti via SQL?
006801120905     d dsfnblp       e ds                  extname(fnblp00f) inz
006802120905     d dsfnanm       e ds                  extname(fnanm00f) inz
007000120905     d ds_sql          ds                  inz
007100120905     d  tfp                                like(blptfp)      inz
007200120905     d  tfa                                like(blptfa)      inz
007300120905     d  Ncolli                        5s 0                   inz
007400120905     d  dal                           8s 0                   inz
007500120905     d  al                            8s 0                   inz
007501120906     d  pst                           2a                     inz
008500100201
008600100201       //--------------------------------------------------------------
008700100201       //?Definizione variabili globali.                               ?
008800100201       //--------------------------------------------------------------
008900110209
009200100201
009300100201       // -?Flags booleani?
009400100201     d $Fine           s               n   inz
009600100201
009700100201       // -?Stringa SQL da eseguire?
009800100201     d wrkGetLista     s           4096    varying  inz
009900100201
010000100201       // -?Campi di comodo?
010001120905
010002120905     d dataiso_cor     s               d   datfmt(*iso)
010003120906     d Wp              s              2
010004120905     D Wlibfil         S             09
010005120905     D WlibfilP        S             09    inz('FILTRAPRD')
010006120905     D WlibfilB        S             09    INZ('FILTRA201')
010400100201
010500100201       //--------------------------------------------------------------
010600100201       //?Definizione prototipi procedure.                             ?
010700100201       //--------------------------------------------------------------
010800100201
010900100201       // -?Reperimento dati utente?
011000100201      /copy gaitrasrc/srcProtoPR,TIBS34R
011100110208
011600100201
011700100201       //--------------------------------------------------------------
011800100201       //?Definizione key-list.                                        ?
011900100201       //--------------------------------------------------------------
012000100201
012100100201
012200100201       //--------------------------------------------------------------
012300100201       //?M A I N - L I N E                                            ?
012400100201       //--------------------------------------------------------------
012500100201
012600100201     c     *Entry        plist
012700100201     c                   parm                    KPJBA
012900100201
013000100201      /free
013100100201
013200100201       // -?Operazioni iniziali?
013300100201       exsr  sr_RoutInz;
013301120906
013302120906       wp='88';
013303120906       exsr Elabora;
013304120906       if o05err=*blanks;
013305120906       wp='89';
013306120906       exsr Elabora;
013307120906       if o05err=*blanks;
013308120906       wp='SI';
013309120906       exsr Elabora;
013310120906       endif;
013311120906       endif;
013900051228
014000100201       // -?Operazioni finali?
014100100201       exsr  sr_RoutEnd;
014200100201
014300100201       //--------------------------------------------------------------
014400100201       //?Operazioni iniziali.                                         ?
014500100201       //--------------------------------------------------------------
014600100201       BEGSR  sr_RoutInz;
014700100201
014800100201         exec sql   set option dynusrprf = *owner, closqlcsr = *endmod;
014900100201         *inLR = *on;
015000100201
015100120904         TISt05ds = KPJBU;
015101120906         clear o05err;
015200110209
015201120905       // Reperisco la data corrente
015202120905       dataiso_cor=(%date());
015203120905
015204120905       if %subst(knsif:7:1) = 'P';
015205120905         Wlibfil = Wlibfilp;
015206120905         Else ;
015207120905         wlibfil = Wlibfilb;
015208120905       endif;
016400100201
016500100201         // -?Reperimento dati job?
016600100201         exsr  sr_DatiJob;
016700120113
016701120905         //
016702120905
016703120905         exec sql delete from wfan500f;
016704120905         open wfan500f;
029500100201
029600100201       ENDSR;
029700100201
029800100201       //--------------------------------------------------------------
029900100201       //?Reperimento Dati del job (Utente/Operativi).                 ?
030000100201       //--------------------------------------------------------------
030100100201       BEGSR  sr_DatiJob;
030200100201
030300100201         in(e) §AzUte;
030400100201         if NOT %error;
030500100201           in(e) §DatiUte;
030600100201         endif;
030700100201         if %error or RSut = *blank;
030800100201           tibs34r ( tibs34ds );
030900100201           in §AzUte;
031000100201           in §DatiUte;
031100100201         endif;
031200100201
031300100201       ENDSR;
031400100201
031401120906       //--------------------------------------------------------------
031402120906       //?
031403120906       //--------------------------------------------------------------
031404120906       BEGSR  Elabora;
031405120906       exsr  lista;
031406120906       // -?Elaborazione SQL?
031407120906
031408120906       $fine=*off;
031409120906
031410120906       doW  Not $Fine;
031411120906         exsr  sr_Elab;
031412120906       enddo;
031413120906       exec sql   close C1;
031414120906       endsr;
031415120906       //--------------------------------------------------------------
031416120906       //?
031417120906       //--------------------------------------------------------------
031418120906       BEGSR  lista;
031419120906         // -?Compilazione stringa SQL?
031420120906         wrkGetLista = 'with +
031421120906
031422120906         // -?-?
031423120906                        Sel001  as +
031424120906                        (select * from ' + wlibfil + '/FNANM00F, ' +
031425120906                         wlibfil + '/FNBLP00F +
031426120906                          where anmaas=blpaas and anmlnp=blplnp +
031427120906                            and anmnrs=blpnrs and anmnsp=blpnsp +
031428120906                            and anmcaa=5 and anmdao between';
031429120906           wrkGetLista += ' ' + %char(i05dal) + ' and '  + %char(i05al) +
031430120906                          ' and anmnsp>0 and (anmdch < ' + %char(i05dal) +
031431120906                         ' or anmdch> '+ %char(i05al) + ') and anmcch<>''AN'' +
031432120906                         and anmnps';
031433120906
031434120906         select;
031435120906         when wp='88';
031436120906            wrkGetLista +=' in (88, 90, 98, 96))';
031437120906         when wp='89';
031438120906            wrkGetLista +=' in (89))';
031439120906         other;
031440120906            wrkGetLista +=' not in (88, 90, 98, 96, 89))';
031441120906         endsl;
031442120906         wrkGetLista +=' select  blptfp, blptfa, count(*) as ncolli, ''' +
031443120906                         %char(i05dal) +''''  + ' as Dal, ''' + %char(i05al) +
031444120906                          ''' as Al,';
031445120906         select;
031446120906         when wp='88';
031447120906            wrkGetLista +=' ''88'' as PST';
031448120906         when wp='89';
031449120906            wrkGetLista +=' ''89'' as PST';
031450120906         other;
031451120906            wrkGetLista +=' ''SI'' as PST';
031452120906         endsl;
031453120906            wrkGetLista +=' from sel001 group by blptfp, blptfa +
031454120906                          order by blptfp, blptfa for read only' ;
031455120906
031456120906         // -?Start SQL?
031457120906         exec sql   prepare S1   from :wrkGetLista;
031458120906         exec sql   declare C1   cursor for S1;
031459120906         exec sql   open C1;
031460120906         endsr;
031500100201       //--------------------------------------------------------------
031600100201       //?Elaborazione singola estrazione SQL.                         ?
031700100201       //--------------------------------------------------------------
031800100201       BEGSR  sr_Elab;
031900100201
032000120905         exec sql   fetch next   from C1   into :ds_sql;
032100100201
032200100201         select;
032300100201           when  SQLcode = 100;
032400100201             $Fine = *on;
032500100201             leavesr;
032600100201           when  SQLcode < *zero;
032700100201             dump(a);
032800120905             O05err = 'S';
032900100201             $Fine  = *on;
033000100201             leavesr;
033100100201           other;
033200100201             exsr  sr_ElabRec;
033300100201         endsl;
033400100201
033500100201       ENDSR;
033600100201
033700100201       //--------------------------------------------------------------
033800100201       //?Elaborazione singolo record estratto via SQL.                ?
033900100201       //--------------------------------------------------------------
034000100201       BEGSR  sr_ElabRec;
034001120905
034006120905         clear wfan5000;
034007120905         AN5DEL=%dec(dataiso_cor);
034008120905         AN5USR=knmus;
034009120905         AN5DAL=i05dal;
034010120905         AN5ALL=i05al;
034011120905         an5tfp=tfp;
034012120905         an5tfa=tfa;
034013120905         an5tcl=ncolli;
034014120906         an5nps=pst;
034015120905         write wfan5000;
053700100201
053800100201       ENDSR;
053900100201
054000100201       //--------------------------------------------------------------
054100100201       //?Operazioni finali.                                           ?
054200100201       //--------------------------------------------------------------
054300100201       BEGSR  sr_RoutEnd;
054400100201
054500100201         // -?End SQL?
054600100201         exec SQL   close C1;
054700100201
057700100201
057800100201         // -?Uscita?
057900120905         KPJBU = tist05ds;
058000100201         *inLR = *on;
058100100201         return;
058200100201
058300100201       ENDSR;
