000100170123      //--------------------------------------------------------------
000200170123      //?TNSB49R - Pulizia Fatturato Giornaliero
000300170123      //--------------------------------------------------------------
000400170123     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000500170123
000600170123      //---------------------------------------------------------------
000700170123      //?Dichiarazione file.
000800170123      //---------------------------------------------------------------
000900170123      // -?Tabelle
001000170123     fTABEL00F  if   e           k disk
001100170123
001200170123      //---------------------------------------------------------------
001300170123      //?Definizione costanti.
001400170123      //---------------------------------------------------------------
001500170123
001600170123      //---------------------------------------------------------------
001700170123      //?Definizione schiere.
001800170123      //---------------------------------------------------------------
001900170123
002000170123      //---------------------------------------------------------------
002100170123      //?Definizione aree dati.
002200170123      //---------------------------------------------------------------
002300170123      // -?Dati utente
002400170123     d §AzUte        e ds                  extname(AZUTE00F)
002500170123     d                                     dtaara
002600170123     d §DatiUte      e ds                  extname(dDatiUte)
002700170123     d                                     dtaara
002800170123
002900170123      //---------------------------------------------------------------
003000170123      //?Definizione strutture dati.
003100170123      //---------------------------------------------------------------
003200170123      // -?Paremetri ricevuti
003300170123     d KPJBA         e ds
003400170123
003500170123      // -?Reperimento dati utente
003600170123     d TIBS34DS      e ds
003700170123
003800170123      // -?DS Tabella 5A - rcd SEDE1
003900170123     d ds5AS1        e ds
004000170123
004100170123      //---------------------------------------------------------------
004200170123      //?Definizione variabili globali.
004300170123      //---------------------------------------------------------------
004400170123      // -?Flags booleani
004500170123     d wEoF            s               n   inz(*off)
004600170123     d wFine           s               n   inz(*off)
004700170123
004800170123      // -?Campi di comodo
004900170123     d Data_ISO        s               d   datfmt(*iso)
005000170123     d DataPul         s              8s 0 inz
005100170123     d Oggi            s              8s 0 inz
005200170123
005300170123      //---------------------------------------------------------------
005400170123      //?Definizione procedure esterne.
005500170123      //---------------------------------------------------------------
005600170123
005700170123      //---------------------------------------------------------------
005800170123      //?Definizione prototipi.
005900170123      //---------------------------------------------------------------
006000170123      // -?Reperimento dati utente
006100170123      /copy gaitrasrc/srcprotopr,tibs34r
006200170123
006300170123      //---------------------------------------------------------------
006400170123      //?Definizione key-list.
006500170123      //---------------------------------------------------------------
006600170123      // -?File TABEL00F
006700170123     d k03tabel      e ds                  extname(TABEL00F:*key)
006800170123     d                                     prefix(k_)
006900170123
007000170123      //---------------------------------------------------------------
007100170123      //?Riepilogo indicatori.
007200170123      //---------------------------------------------------------------
007300170123
007400170123      //---------------------------------------------------------------
007500170123
007600170123      //---------------------------------------------------------------
007700170123      //?M A I N - L I N E
007800170123      //---------------------------------------------------------------
007900170123     c     *Entry        plist
008000170123     c                   parm                    KPJBA
008100170123
008200170123      /free
008300170123
008400170123      //?Operazioni iniziali
008500170123       exsr RoutInz;
008600170123
008700170123      //?Pulizia
008800170123       exsr Pulisci;
008900170123
009000170123      //?Operazioni finali
009100170123       exsr RoutEnd;
009200170123
009300170123      //--------------------------------------------------------------
009400170123      //?Operazioni iniziali.
009500170123      //--------------------------------------------------------------
009600170123       BEGSR RoutInz;
009700170123
009800170123         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
009900170123
010000170123      //?Reperimento dati job
010100170123         exsr DatiJob;
010200170123
010300170123      //?Carico Tabella 5A - Sede 1
010400170123         clear ds5AS1;
010500170124         k_TBLkut = 1;
010600170123         k_TBLcod = '5A';
010700170123         k_TBLkey = 'SEDE1';
010800170123         chain %kds(K03tabel) TABEL00F;
010900170123         IF  %found(TABEL00F);
011000170123           ds5AS1 = TBLuni;
011100170123         ENDIF;
011200170123
011300170123      //?Calcolo la data limite di pulizia
011400170123         Oggi = %dec(%date());
011500170123         Data_ISO = %date(Oggi);
011600170123         Data_ISO = Data_ISO - %months(§5AS1ftgio);
011700170123         DataPul = %dec(Data_ISO);
011800170123
011900170123       ENDSR;
012000170123
012100170123       //--------------------------------------------------------------
012200170123       //?Reperimento Dati del job (Utente/Operativi).
012300170123       //--------------------------------------------------------------
012400170123       BEGSR DatiJob;
012500170123
012600170123         in(E) §AzUte;
012700170123         IF  NOT %error;
012800170123           in(E) §DatiUte;
012900170123         ENDIF;
013000170123         IF  %error or RSut = *blanks;
013100170123           clear TIBS34ds;
013200170123           tibs34r(tibs34ds);
013300170123           in §AzUte;
013400170123           in §DatiUte;
013500170123         ENDIF;
013600170123
013700170123       ENDSR;
013800170123
013900170123       //--------------------------------------------------------------
014000170123       //?Pulizia file fatturato giornaliero.
014100170123       //--------------------------------------------------------------
014200170123       BEGSR Pulisci;
014300170123
014400170123       exec sql
014500170123       delete from TFFGC00F where FGCDTELA < :DataPul;
014600170123
014700170123       exec sql
014800170123       delete from TFFGK00F where FGKDTELA < :DataPul;
014900170123
015000170123       ENDSR;
015100170123
015200170123       //--------------------------------------------------------------
015300170123       //?Operazioni finali.
015400170123       //--------------------------------------------------------------
015500170123       BEGSR RoutEnd;
015600170123
015700170123         *inLR = *on;
015800170123         return;
015900170123
016000170123       ENDSR;
016100170123
016200170123      /end-free
