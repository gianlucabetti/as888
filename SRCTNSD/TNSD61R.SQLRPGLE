000200180213      //---------------------------------------------------------------
000300180213      // TNSD61R - Pulizia files per SEDE - TIDVD00F               ?
000301180213      //---------------------------------------------------------------
000600070111     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000800070111
000809180213      //---------------------------------------------------------------
000810180213      //?Definizione aree dati.
000811180213      //---------------------------------------------------------------
000812180213      // - Dati utente
000813180213     d §AzUte        e ds                  extname(AZUTE00F)
000814180213     d                                     dtaara
000815180213     d §DatiUte      e ds                  extname(dDatiUte)
000816180213     d                                     dtaara
000817180213      //---------------------------------------------------------------
000818180213      //?Definizione strutture dati.
000819180213      //---------------------------------------------------------------
001800070111     d KPJBA         e ds
001801180213
001802180213      // - Parametri ricevuti
001803180213     d TNSD61DS      e ds                  qualified
001804180213
002200180213      // - Parametri x Controllo profilo utenti
002300180213     d TIBS34DS      e ds                  inz
002301180213
002302180213      // - File TIDVD00F
002303180213     d TIDVD00F      e ds                  extname(TIDVD00F)
002304180213
002800180213      //---------------------------------------------------------------
002801180213      //?Definizione variabili globali.
002802180213      //---------------------------------------------------------------
002804180213     d KeyAS           s                   like(DVDkeyas)
002806180213     d wTMSTPiso       s               z   inz(*loval)
002807180213     d wtmstp          s             20s 0 inz
002808180213
002809180213      //--------------------------------------------------------------
002810180213      //?Definizione procedure usate.                                 ?
002811180213      //--------------------------------------------------------------
002812180213      /copy gaitrasrc/srcProtoPR,TIBS34R
002813180213
004100180213      //---------------------------------------------------------------
004101180213      //?M A I N - L I N E
004102180213      //---------------------------------------------------------------
004200070111     c     *Entry        plist
004300180213     c                   parm                    tnsd61ds
004302180213
004700180213      //Operazioni Iniziali
004800180213       exsr Routinz;
004900180213
005000180213      //Pulizia file
005100180213       exsr Delete_TIDVD;
005200180213
005300180213      //Operazioni Finali
005400180213       exsr RoutEnd;
005500070111
005801180213      //---------------------------------------------------------------
005900180213      // ?Operazioni Iniziali
005901180213      //---------------------------------------------------------------
006100180213        BEGSR RoutInz;
006500180213
006501180213         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
006504180213
006800180213        // Reperimento dati job
006900180213          exsr DatiJob;
006901180213
006902180213          wtmstp = tnsd61ds.DATAPUL * 1000000000000;
006903180213          wTMSTPiso = %timestamp(wtmstp);
006905180213
007100180213        ENDSR;
007200070111
007201180213      //---------------------------------------------------------------
007400180213      // ?Reperimento Dati del job (Utente/Operativi)
007401180213      //---------------------------------------------------------------
007402180213        BEGSR DatiJob;
007403180213
007404180213         in(E) §AzUte;
007405180213         IF  NOT %error;
007406180213           in(E) §DatiUte;
007407180213         ENDIF;
007408180213         IF  %error or RSut = *blanks;
007409180213           clear TIBS34ds;
007410180213           tibs34r(tibs34ds);
007411180213           in §AzUte;
007412180213           in §DatiUte;
007413180213         ENDIF;
007414180213
007415180213       ENDSR;
009000070111
009001180213      //---------------------------------------------------------------
009200180213      // ?Cancellazione records
009201180213      //---------------------------------------------------------------
009202180213        BEGSR Delete_TIDVD;
009206180213
009207180213          IF  tnsd61ds.DATAPUL > *zeros;
009500180213            IF  tnsd61ds.KEYAS <> *blanks;
009501180213              exec sql DELETE from TIDVD00F where DVDkeyas = :tnsd61ds.KEYAS and
009503180213                       DVDdtaburn < :wTMSTPiso and DVDstatus = 'DON' and
009504180213                       substr(DVDcodtask, 1, 3) = :tnsd61ds.IDTASK;
009505180213            ELSE;
009508180213              exec sql DELETE from TIDVD00F where DVDdtaburn < :wTMSTPiso and
009509180213                       DVDstatus = 'DON' and
009510180213                       substr(DVDcodtask, 1, 3) = :tnsd61ds.IDTASK;
009511180213            ENDIF;
009512180213          ENDIF;
009513180213
010300180213        ENDSR;
010400070111
010401180213      //---------------------------------------------------------------
010600180213      // ?Operazioni Finali
010601180213      //---------------------------------------------------------------
010602180213        BEGSR RoutEnd;
010603180213
010604180213          *inlr = *on;
010605180213          return;
010606180213
010607180213        ENDSR;
