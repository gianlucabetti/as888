000100090708      //---------------------------------------------------------------
000200091008      //?TNTA45R - Controlla appuntamento e commerciale su trattativa
000300090708      //---------------------------------------------------------------
000400090708
000500090708     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600090708
000700090708      //---------------------------------------------------------------
000800090708      //?Dichiarazione file.
000900090708      //---------------------------------------------------------------
001000090708
001100090708      //---------------------------------------------------------------
001200090511      //?Definizione costanti.
001300090511      //---------------------------------------------------------------
001400090511
001500090511      //---------------------------------------------------------------
001600090511      //?Definizione schiere.
001700090511      //---------------------------------------------------------------
001800090708
001900090708      // - Messaggi di errore
002000090708     d $Msg            s             78    dim(10) ctdata perrcd(1)
002100090721
002200090511      //---------------------------------------------------------------
002300090511      //?Definizione aree dati.
002400090511      //---------------------------------------------------------------
002500090511
002600090511      //---------------------------------------------------------------
002700090511      //?Definizione strutture dati.
002800090511      //---------------------------------------------------------------
002900090708
003000090708      // - Parametri ricevuti
003100091008     d TNTA45ds      e ds
003200090709
003300091008      // File attività
003400091008     d tiatc00f      e ds                  extname(TIATC00F)
003500091008
003600091008      // File trattative
003700091008     d tivis00f      e ds                  extname(TIVIS00F)
003800090511
003900090511      //---------------------------------------------------------------
004000090511      //?Definizione variabili globali.
004100090511      //---------------------------------------------------------------
004200091014
004300091014      // - Flags booleani
004400091014     d $End_APP        s               n   inz(*off)
004500090511
004600090511      //---------------------------------------------------------------
004700090511      //?Definizione procedure esterne.
004800090511      //---------------------------------------------------------------
004900090511
005000090511      //---------------------------------------------------------------
005100090511      //?Definizione key-list.
005200090511      //---------------------------------------------------------------
005300090708
005400090708      //---------------------------------------------------------------
005500090708      //?Riepilogo indicatori.
005600090708      //---------------------------------------------------------------
005700090511
005800090511      //---------------------------------------------------------------
005900090708      //?M A I N - L I N E
006000090511      //---------------------------------------------------------------
006100090708
006200090708     c     *Entry        plist
006300091009     c                   parm                    tnta45ds
006400090708
006500090708      /free
006600090708
006700090708       //?Operazioni iniziali
006800090708       exsr sr_RoutInz;
006900091007
007000091007       //?Controllo dati passati
007100091007       exsr sr_CtrDati;
007200091007
007300091008       //?Verifico se ci sono appuntamenti da efettuare su comm.le
007400091008       //?diverso dal comm.le trattativa
007500091009       IF  Ota45Err = *blanks and Ita45Tip = 'A';
007600091008         exsr sr_CtrAppuntamenti;
007700091007       ENDIF;
007800091008
007900091008       //?Verifico se comm.le trattativa diverso da da comm.le passato
008000091009       IF  Ota45Err = *blanks and Ita45Tip = 'C';
008100091008         exsr sr_CtrCommerciale;
008200091008       ENDIF;
008300090708
008400090708       //?Operazioni finali
008500090708       exsr sr_RoutEnd;
008600090708
008700090708       //--------------------------------------------------------------
008800090708       //?Operazioni iniziali.
008900090708       //--------------------------------------------------------------
009000090708       BEGSR sr_RoutInz;
009100090708
009200091009         clear Ota45Cmm;
009300091009         clear Ota45Err;
009400091009         clear Ota45Msg;
009500090708
009600090708         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
009700090708
009800090708       ENDSR;
009900090805
010000090805       //--------------------------------------------------------------
010100091007       //?Controllo dati passati.
010200090805       //--------------------------------------------------------------
010300091007       BEGSR sr_CtrDati;
010400090810
010500091008         IF  Ita45Tip <> 'C' and Ita45Tip <> 'A';
010600091009           Ota45Err = '9';
010700091008           Ota45Msg = $msg(01);
010800091009           leavesr;
010900090810         ENDIF;
011000091008
011100091008         IF  Ita45Tip = 'A' and Ita45Nrv = 0;
011200091009           Ota45Err = '9';
011300091008           Ota45Msg = $msg(01);
011400091009           leavesr;
011500091008         ENDIF;
011600091008
011700091008         IF  Ita45Tip = 'C' and (Ita45Nrv = 0 or Ita45Cmm = 0);
011800091009           Ota45Err = '9';
011900091008           Ota45Msg = $msg(01);
012000091009           leavesr;
012100091008         ENDIF;
012200090805
012300090805       ENDSR;
012400091007
012500091007       //--------------------------------------------------------------
012600091008       //?Controllo appuntamenti.
012700091007       //--------------------------------------------------------------
012800091008       BEGSR sr_CtrAppuntamenti;
012900091008
013000091008         exec sql
013100091014         declare APP cursor for
013200091014         select atccmm from
013300091008         tivis00f join tiatc00f on visnrv = atcnrv
013400091008         where viscmm <> atccmm and atctat = 'A' and
013500091009         atcdco = 0 and atcnrv = :Ita45Nrv;
013600091014
013700091014         exec sql
013800091014           open APP;
013900091014           IF sqlcode < 0;
014000091014             leavesr;
014100091014           ENDIF;
014200091014
014300091014         DOW not $End_APP;
014400091014           exec sql
014500091014             fetch next from APP into :atccmm;
014600091014             IF sqlcod = 100 or sqlcod < 0;
014700091014               $End_APP = *on;
014800091014               leave;
014900091014             ENDIF;
015000091014
015100091014         //?trovo almeno un rcd errore
015200091009           Ota45Err = 'A';
015300091009           Ota45Msg = $msg(02);
015400091014           leave;
015500091014
015600091014         ENDDO;
015700091014
015800091014         exec sql close APP;
015900091007
016000091007       ENDSR;
016100091008
016200091008       //--------------------------------------------------------------
016300091008       //?Controllo commerciale.
016400091008       //--------------------------------------------------------------
016500091008       BEGSR sr_CtrCommerciale;
016600091008
016700091008         exec sql
016800091008         select viscmm into :viscmm from
016900091009         tivis00f where visnrv = :Ita45Nrv and
017000091009         viscmm <> :Ita45Cmm;
017100091008         //?non trovo rcd OK
017200091008           IF  sqlcod <> 0;
017300091008             leavesr;
017400091008           ENDIF;
017500091008         //?trovo rcd errore
017600091009           Ota45Err = 'C';
017700091009           Ota45Msg = $msg(03);
017800091009           Ota45Cmm = viscmm;
017900091009           leavesr;
018000091008
018100091008       ENDSR;
018200090708
018300090708       //--------------------------------------------------------------
018400090708       //?Operazioni finali.
018500090708       //--------------------------------------------------------------
018600090708       BEGSR sr_RoutEnd;
018700090708
018800090708         *inLR = *on;
018900090708         return;
019000090708
019100090708       ENDSR;
019200090708
019300090708      /end-free
019400090708
019500090708       //--------------------------------------------------------------
019600090708       //?Schiere a tempo di compilazione.
019700090708       //--------------------------------------------------------------
019800090708
019900090708** - $MSG -------------------------------------------------------------------*
020000091014Dati non passati                                                              01
020100091014Appuntamento da effettuare su commerciale diverso da trattativa               02
020200091014Commerciale trattativa diverso da commerciale richiesto                       03
