000100080206      //--------------------------------------------------------------
000200100820      //?TNTAD2R - Pulizia  TRATTATIVE Fittizie senza offerte
000300080206      //--------------------------------------------------------------
000400080206
000500100820     h decedit('0,') datedit(*ymd) option(*nodebugio)
000600080206
000700080206      //---------------------------------------------------------------
000800080206      //?Dichiarazione file.
000900080206      //---------------------------------------------------------------
001000080206
001100100927      // - Archivio Trattative commerciale
001200100927     fTIVIS05L  if   e           k disk
001300090720      // - Archivio Offerte    commerciale
001400090720     fTIVOF01L  if   e           k disk
001500110422      // - Archivio ATTIVITÀ COMMERCIALI
001600110422     fTIATC04L  if   e           k disk
001700080206
001800080206      //---------------------------------------------------------------
001900090406      //?Definizione costanti.
002000080206      //---------------------------------------------------------------
002100050519
002200080206
002300080206      //---------------------------------------------------------------
002400080206      //?Definizione schiere.
002500080206      //---------------------------------------------------------------
002600080206
002700080206
002800080206      //---------------------------------------------------------------
002900080206      //?Definizione aree dati.
003000080206      //---------------------------------------------------------------
003100080206
003200080206
003300080206      //---------------------------------------------------------------
003400080206      //?Definizione strutture dati.
003500080206      //---------------------------------------------------------------
003600080206
003700080206      // - Status
003800080206     d Psds           sds
003900080206     d   SDSpgm          *proc
004000080206
004100080206      // - Parametri ricevuti
004200080206     d KPJBA         e ds
004300090717
004400100719      // - Chiusura trattativa
004500100719     d TNTA16ds      e ds                  inz
004600100719     d  esi_ta16c      s              1
004700100719
004800080206      //---------------------------------------------------------------
004900080206      //?Definizione variabili globali.
005000080206      //---------------------------------------------------------------
005100080206
005200080206      // - Flags booleani
005300100312     d $End            s               n   inz(*off)
005400100927     d $EndVis         s               n   inz(*off)
005500100927     d $OffOk          s               n   inz(*off)
005600110422     d $AttOk          s               n   inz(*off)
005700080206
005800080206
005900090401      // - Campi di comodo data
006000100927     d wdata_eur       s               d   Datfmt(*eur)
006100100927     d wdata_iso       s               d   Datfmt(*iso)
006200100927     d Woggi           s              8  0
006300100927     d Woggi_14        s              8  0
006400090401
006500080206      // - Campi di comodo
006600090717
006700100723     d StringaSql      s            750    Varying       inz
006800080208
006900090508      //---------------------------------------------------------------
007000090508      //?Definizione procedure usate.
007100090508      //---------------------------------------------------------------
007200080206
007300080626      //---------------------------------------------------------------
007400080626      //?prototipi
007500080626      //---------------------------------------------------------------
007600100719
007700100719     d TNTA16C         pr                  extpgm('TNTA16C')
007800100719     d  kpjba                              likeds(kpjba)
007900100719     d  tnta16ds                           likeds(tnta16ds)
008000100719     d  esi_ta16c                     1A
008100100820
008200080206      //---------------------------------------------------------------
008300080206      //?Definizione key-list.
008400080206      //---------------------------------------------------------------
008500080206
008600080206
008700080206      //---------------------------------------------------------------
008800080206      //?Riepilogo indicatori.
008900080206      //---------------------------------------------------------------
009000090518      // - Comuni
009100080207      // 99    : Generico di Errore
009200080206      //---------------------------------------------------------------
009300080206
009400080206      //---------------------------------------------------------------
009500080206      //?M A I N - L I N E
009600080206      //---------------------------------------------------------------
009700080206
009800080206     c     *Entry        plist
009900080206     c                   parm                    KPJBA
010000080206
010100080206      /free
010200080206
010300080206       // Operazioni iniziali
010400080206       exsr RoutInz;
010500090601
010600100909       // Esegui
010700100909       exsr Esegui ;
010800080206
010900080206       // Operazioni finali
011000080206       exsr RoutEnd;
011100080206
011200080206       //--------------------------------------------------------------
011300080206       //?Operazioni iniziali.
011400080206       //--------------------------------------------------------------
011500080206       BEGSR RoutInz;
011600100427
011700100427         exec sql  set option  dynusrprf = *owner,
011800100427                               closqlcsr = *endmod;
011900080206
012000100909
012100100909         //?Imposto data DI CONTROLLO
012200100909         wOggi     = %dec(%date());
012300100927         wData_ISO = %date(wOggi:*ISO);
012400100927         WData_iso = Wdata_iso - %days(14);
012500100927         woggi_14  = %dec(wData_iso) ;
012600100909
012700090714
012800080206       ENDSR;
012900080206
013000100909       //--------------------------------------------------------------
013100100909       //?Esecuzione lettura Tivis
013200100909       //--------------------------------------------------------------
013300100909       BEGSR Esegui ;
013400100909
013500100927         exec sql
013600100927          declare VIS cursor for
013700100927          select visnrv
013800100927          from tivis05l where visffz = 'S' and visdat <= :Woggi_14  ;
013900100927
014000100927         exec sql
014100100927           open VIS;
014200100927           IF sqlcode < 0;
014300100927             $EndVis = *on;
014400100927           ENDIF;
014500100927
014600100927         DOW not $EndVis;
014700100927           exec sql
014800100927             fetch next from VIS into :Visnrv ;
014900100927             IF sqlcod = 100 or sqlcod < 0;
015000100927               $EndVis = *on;
015100100927               leave;
015200100927             ENDIF;
015300110422
015400110422             $attok = *off ;
015500100927             $offok = *off ;
015600110422         // verifico se ha offerte
015700100927             setll visnrv tivof01l ;
015800100927             reade visnrv tivof01l ;
015900100927             dow not %eof(tivof01l) ;
016000100927                 if vofeso <> '*';
016100100927                    $offok = *on ;
016200100927                    leave ;
016300100927                 endif ;
016400100927                 reade visnrv tivof01l ;
016500100927             enddo ;
016600110422
016700110422         // verifico se ha attività aperte
016800110422             If $offok = *off ;
016900121029                chain (viscpo:visksc:visnrv:0:0) tiatc04l ;
017000110422                If %found(tiatc04l);
017100110422                    $attok = *on ;
017200110422                endif ;
017300110422             endif ;
017400110422
017500110422             If $offok = *off and $attok = *off ;
017600100927                clear tnta16ds ;
017700100927
017800100927                ita16fcmt = '1' ;
017900100927                ita16cmt = 'S' ;
018000100927                ita16nrv = VISnrv ;
018100100927                ita16ffz = 'S'    ;
018200100927                tnta16c (Kpjba:tnta16ds:esi_ta16c) ;
018300100927
018400100927             endif ;
018500100927
018600100927         ENDDO;
018700100927
018800100927         exec sql close VIS;
018900100927
019000100909       ENDSR;
019100100909
019200080206       //--------------------------------------------------------------
019300080206       //?Operazioni finali.
019400080206       //--------------------------------------------------------------
019500080206       BEGSR RoutEnd;
019600080206
019700080206         *inLR = *on;
019800080206         return;
019900080206
020000080206       ENDSR;
020100080206
020200080206      /end-free
