000100141003      //--------------------------------------------------------------
000200141003      //?TNTAD3R - Pulizia file zoppi CRM
000300141003      //--------------------------------------------------------------
000400141003
000500141003     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600141003
000700141003      //---------------------------------------------------------------
000800141003      //?Dichiarazione file.
000900141003      //---------------------------------------------------------------
001000141003      // - File Rubrica - Note
001100141003     fTFNTC01L  uf   e           k disk
001200141003
001300141003      //---------------------------------------------------------------
001400141003      //?Definizione costanti.
001500141003      //---------------------------------------------------------------
001600141003
001700141003      //---------------------------------------------------------------
001800141003      //?Definizione schiere.
001900141003      //---------------------------------------------------------------
002000141003
002100141003      //---------------------------------------------------------------
002200141003      //?Definizione aree dati.
002300141003      //---------------------------------------------------------------
002400141003      // - Dati utente
002500141003     d §AzUte        e ds                  extname(AZUTE00F)
002600141003     d                                     dtaara
002700141003     d §DatiUte      e ds                  extname(dDatiUte)
002800141003     d                                     dtaara
002900141003
003000141003      //---------------------------------------------------------------
003100141003      //?Definizione strutture dati.
003200141003      //---------------------------------------------------------------
003300141003
003400141003      // - Parametri ricevuti
003500141003     d KPJBA         e ds
003600141003
003700141003      // - File Rubrica - Note
003800141003     d TFNTCDS       e ds                  extname(TFNTC00F)
003900141003     d                                     prefix(s_)
004000141003
004100141003      //---------------------------------------------------------------
004200141003      //?Definizione variabili globali.
004300141003      //---------------------------------------------------------------
004400141003      // - Flags booleani
004500141003     d wEoF            s               n   inz(*off)
004600141003     d wEoFntc         s               n   inz(*off)
004700141003     d wFine           s               n   inz(*off)
004800141003
004900141003      //---------------------------------------------------------------
005000141003      //?Definizione procedure usate.
005100141003      //---------------------------------------------------------------
005200141003
005300141003      //---------------------------------------------------------------
005400141003      //?Definizione prototipi.
005500141003      //---------------------------------------------------------------
005600141003
005700141003      //---------------------------------------------------------------
005800141003      //?Definizione key-list.
005900141003      //---------------------------------------------------------------
006000141003       // - File TFNTC01L
006100141003     d k02tfntc      e ds                  extname(TFNTC01L:*key)
006200141003     d                                     prefix(k_) inz
006300141003
006400141003      //---------------------------------------------------------------
006500141003      //?M A I N - L I N E
006600141003      //---------------------------------------------------------------
006700141003
006800141003     c     *entry        plist
006900141003     c                   parm                    KPJBA
007000141003
007100141003      /free
007200141003
007300141003       //?Operazioni iniziali
007400141003       exsr RoutInz;
007500141003
007600141003       //?Elaborazioni
007700141003       exsr Sistema_Clienti;
007800141003       exsr Sistema_Potenziali;
007900141003       exsr Sistema_Trattative;
008000141003
008100141003       //?Operazioni finali
008200141003       exsr RoutEnd;
008300141003
008400141003       //--------------------------------------------------------------
008500141003       //?Operazioni iniziali.
008600141003       //--------------------------------------------------------------
008700141003       BEGSR RoutInz;
008800141003
008900141003         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
009000141003
009100141003       ENDSR;
009200141003
009300141003       //--------------------------------------------------------------
009400141003       //?Sistemo i dati zoppi dei Clienti.
009500141003       //--------------------------------------------------------------
009600141003       BEGSR Sistema_Clienti;
009700141003
009800141003         wEoF = *off;
009900141003
010000141003       //?Leggo i TFNTC di tipo 'C' senza relativo CNACO
010100141003         exec sql
010200141003         DECLARE FNTCC cursor for
010300141003         SELECT NTCnk1
010400141003         FROM TFNTC00F
010500141003         EXCEPTION JOIN CNACO00F on
010600141003          substr(NTCnk1, 5, 7) = digits(ACOksc)
010700141003         WHERE NTCapl = 'C'
010800141003         GROUP BY NTCnk1
010900141003         ORDER BY NTCnk1;
011000141003
011100141003       //?Apertura del cursore
011200141003         exec sql
011300141003         OPEN FNTCC;
011400141003
011500141003         IF  sqlcode < 0;
011600141003           wEoF = *on;
011700141003         ENDIF;
011800141003
011900141003         DOW  not wEoF;
012000141003           exec sql
012100141003           FETCH NEXT FROM FNTCC into :s_NTCnk1;
012200141003
012300141003           IF  sqlcod = 100 or sqlcod < 0;
012400141003             wEoF = *on;
012500141003             leave;
012600141003           ENDIF;
012700141003
012800141003         //?Elimino i dati zoppi su TFNTC
012900141003           k_NTCapl = 'C';
013000141003           k_NTCnk1 = s_NTCnk1;
013100141003           exsr Elimina;
013200141003
013300141003         ENDDO;
013400141003
013500141003       //?Chiudo il cursore
013600141003         exec sql
013700141003         CLOSE FNTCC;
013800141003
013900141003       ENDSR;
014000141003
014100141003       //--------------------------------------------------------------
014200141003       //?Sistemo i dati zoppi dei Potenziali.
014300141003       //--------------------------------------------------------------
014400141003       BEGSR Sistema_Potenziali;
014500141003
014600141003         wEoF = *off;
014700141003
014800141003       //?Leggo i TFNTC di tipo 'P' senza relativo TNCPO
014900141003         exec sql
015000141003         DECLARE FNTCP cursor for
015100141003         SELECT NTCnk1
015200141003         FROM TFNTC00F
015300141003         EXCEPTION JOIN TNCPO00F on
015400141003          NTCnk1 = digits(CPOcpo)
015500141003         WHERE NTCapl = 'P'
015600141003         GROUP BY NTCnk1
015700141003         ORDER BY NTCnk1;
015800141003
015900141003       //?Apertura del cursore
016000141003         exec sql
016100141003         OPEN FNTCP;
016200141003
016300141003         IF  sqlcode < 0;
016400141003           wEoF = *on;
016500141003         ENDIF;
016600141003
016700141003         DOW  not wEoF;
016800141003           exec sql
016900141003           FETCH NEXT FROM FNTCP into :s_NTCnk1;
017000141003
017100141003           IF  sqlcod = 100 or sqlcod < 0;
017200141003             wEoF = *on;
017300141003             leave;
017400141003           ENDIF;
017500141003
017600141003         //?Elimino i dati zoppi su TFNTC
017700141003           k_NTCapl = 'P';
017800141003           k_NTCnk1 = s_NTCnk1;
017900141003           exsr Elimina;
018000141003
018100141003         ENDDO;
018200141003
018300141003       //?Chiudo il cursore
018400141003         exec sql
018500141003         CLOSE FNTCP;
018600141003
018700141003       ENDSR;
018800141003
018900141003       //--------------------------------------------------------------
019000141003       //?Sistemo i dati zoppi delle Trattative.
019100141003       //--------------------------------------------------------------
019200141003       BEGSR Sistema_Trattative;
019300141003
019400141003         wEoF = *off;
019500141003
019600141003       //?Leggo i TFNTC di tipo 'T' senza relativo TIVIS
019700141003         exec sql
019800141003         DECLARE FNTCT cursor for
019900141003         SELECT NTCnk1
020000141003         FROM TFNTC00F
020100141003         EXCEPTION JOIN TIVIS00F on
020200141003          substr(NTCnk1, 5, 7) = digits(VISnrv)
020300141003         WHERE NTCapl = 'T'
020400141003         GROUP BY NTCnk1
020500141003         ORDER BY NTCnk1;
020600141003
020700141003       //?Apertura del cursore
020800141003         exec sql
020900141003         OPEN FNTCT;
021000141003
021100141003         IF  sqlcode < 0;
021200141003           wEoF = *on;
021300141003         ENDIF;
021400141003
021500141003         DOW  not wEoF;
021600141003           exec sql
021700141003           FETCH NEXT FROM FNTCT into :s_NTCnk1;
021800141003
021900141003           IF  sqlcod = 100 or sqlcod < 0;
022000141003             wEoF = *on;
022100141003             leave;
022200141003           ENDIF;
022300141003
022400141003         //?Elimino i dati zoppi su TFNTC
022500141003           k_NTCapl = 'T';
022600141003           k_NTCnk1 = s_NTCnk1;
022700141003           exsr Elimina;
022800141003
022900141003         ENDDO;
023000141003
023100141003       //?Chiudo il cursore
023200141003         exec sql
023300141003         CLOSE FNTCT;
023400141003
023500141003       ENDSR;
023600141003
023700141003       //--------------------------------------------------------------
023800141003       //?Deleto i dati zoppi si TFNTC.
023900141003       //--------------------------------------------------------------
024000141003       BEGSR Elimina;
024100141003
024200141003         wEoFntc = *off;
024300141003
024400141003       //?Aggancio il file TFNTC
024500141003         setll %kds(k02tfntc : 2) TFNTC01L;
024600141003         reade %kds(k02tfntc : 2) TFNTC01L;
024700141003         DOW  not wEoFntc;
024800141003           delete TFNTC;
024900141003           reade %kds(k02tfntc : 2) TFNTC01L;
025000141003         ENDDO;
025100141003
025200141003       ENDSR;
025300141003
025400141003       //--------------------------------------------------------------
025500141003       //?Operazioni finali.
025600141003       //--------------------------------------------------------------
025700141003       BEGSR RoutEnd;
025800141003
025900141003         *inLR = *on;
026000141003         return;
026100141003
026200141003       ENDSR;
026300141003
026400141003      /end-free
