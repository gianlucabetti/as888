000100130225       //==============================================================
000200130507       //?TNTE51R * TEST-Lancio Simulazione Delta Tariffa/Offerta
000300130225       //==============================================================
000400121025
000500121025       //--------------------------------------------------------------
000600121025       //?Specifiche di controllo.                                     ?
000700121025       //--------------------------------------------------------------
000800121025
000900121025     h decedit('0,') datedit(*ymd/) option(*nodebugio)
001000121025
001100121025       //--------------------------------------------------------------
001200121025       //?Dichiarazione file.                                          ?
001300121025       //--------------------------------------------------------------
001400130507
001500130507       // -?File Tariffe
001600130507     fTNTAM00L  if   e           k disk    usropn
001700121025
001800121025       // -?File video
001900130507     fTNTE51D   cf   e             workstn
002000121107     f                                     indds(IndDspF)
002100121107     f                                     infds(InfDspF)
002200121025
002300121025       //--------------------------------------------------------------
002400121025       //?Definizione costanti.                                        ?
002500121025       //--------------------------------------------------------------
002600121025
002700130225       // -?Tasti funzionali a video
002800121024     d c_F01           c                   const(x'31')
002900121024     d c_F02           c                   const(x'32')
003000121024     d c_F03           c                   const(x'33')
003100121024     d c_F04           c                   const(x'34')
003200121024     d c_F05           c                   const(x'35')
003300121024     d c_F06           c                   const(x'36')
003400121024     d c_F07           c                   const(x'37')
003500121024     d c_F08           c                   const(x'38')
003600121024     d c_F09           c                   const(x'39')
003700121024     d c_F10           c                   const(x'3A')
003800121024     d c_F11           c                   const(x'3B')
003900121024     d c_F12           c                   const(x'3C')
004000121024     d c_F13           c                   const(x'B1')
004100121024     d c_F14           c                   const(x'B2')
004200121024     d c_F15           c                   const(x'B3')
004300121024     d c_F16           c                   const(x'B4')
004400121024     d c_F17           c                   const(x'B5')
004500121024     d c_F18           c                   const(x'B6')
004600121024     d c_F19           c                   const(x'B7')
004700121024     d c_F20           c                   const(x'B8')
004800121024     d c_F21           c                   const(x'B9')
004900121024     d c_F22           c                   const(x'BA')
005000121024     d c_F23           c                   const(x'BB')
005100121024     d c_F24           c                   const(x'BC')
005200121024     d c_Enter         c                   const(x'F1')
005300121024     d c_RollDown      c                   const(x'F4')
005400121024     d c_RollUp        c                   const(x'F5')
005500121024
005600121024     d Digits          c                   const('0123456789')
005700121025
005800121025       //--------------------------------------------------------------
005900121025       //?Definizione schiere.                                         ?
006000121025       //--------------------------------------------------------------
006100121025
006200121024      // -?Messaggi di errore
006300130225     d skMsg           s             78    dim(30) ctdata perrcd(1)
006400121025
006500121025       //--------------------------------------------------------------
006600121025       //?Definizione aree dati.                                       ?
006700121025       //--------------------------------------------------------------
006800121025
006900121025       // -?Dati utente?
007000121025     d §AzUte        e ds                  extname(AZUTE00F)
007100121025     d                                     dtaara
007200121025     d §DatiUte      e ds                  extname(dDatiUte)
007300121025     d                                     dtaara
007400121025
007500121025       //--------------------------------------------------------------
007600121025       //?Definizione strutture dati.                                  ?
007700121025       //--------------------------------------------------------------
007800121025
007900121025       // -?Status ds?
008000121025     d Status         sds
008100121025     d  SDSpgm           *proc
008200121025     d  SDSusr               254    263
008300121024
008400130225       // -?InfDS
008500121024     d InfDspF         ds
008600121024     d  dsp_aid              369    369a
008700121024
008800130225       // -?Indicatori su DspF
008900121024     d IndDspF         ds
009000130225       // -?Indicatori di Errore
009100121024     d  ErrMessage                    1n   overlay(IndDspF : 28)
009200130225       // -?Indicatori di errore generico
009300121024     d  ErrGenerico                   1n   overlay(IndDspF : 99)
009400121024
009500130225       // -?DS indicatori Dspf
009600121024     d WindDspF        ds                  inz
009700121024     d   WindDspFa             1     49    inz(*zero)
009800121024     d   WindDspFb            50     99    inz(*zero)
009900121024
010000130225       // -?DS controllo data
010100121024     d wlbdat          ds                  inz
010200121024     d  g02dat                 1      8  0
010300121024     d  g02inv                 9     16  0
010400121024     d  g02err                17     17
010500121024     d  g02tgi                18     22  0
010600130507
010700130507       // -?Parametri x CL da richiamare in caso di 'Offerta'
010800130507     d param           ds                  inz
010900130507     d  parksc                 1      7  0
011000130507     d  parctr                 8     10  0
011100130507     d  parprg                11     13  0
011200130507     d  pardtcal              14     14
011300130508     d  paraas                15     18  0
011400130508     d  parlnp                19     21  0
011500130508     d  parnrs                22     23  0
011600130508     d  parnsp                24     30  0
011700130509     d  parclose              31     31
011800130225
011900121025       // -?Parametri ricevuti
012000121025     d KPJBA         e ds
012100100507
012200121025       // -?Parametri per Reperimento dati utente?
012300121025     d TIBS34ds      e ds
012400130225
012500130507       // -?Parametri per TNTE50R
012600130507     d TNTE50ds      e ds
012700121025
012800121025       //--------------------------------------------------------------
012900121025       //?Definizione variabili globali.                               ?
013000121025       //--------------------------------------------------------------
013100121025
013200121025       // -?Flags booleani
013300121024     d wEnd            s               n   inz(*off)
013400121024     d wFine           s               n   inz(*off)
013500130222     d wInzD01         s               n   inz(*on)
013600121024
013700121024       // -?Campi Data
013800130222     d wData_ISO       s               d   datfmt(*iso)
013900130222     d wData_EUR       s               d   datfmt(*eur)
014000121024     d wOggi           s              8s 0 inz
014100130225
014200130225       // -?Campi di Comodo
014300130507     d  parddt         s              8s 0
014400130507     d  partest        s              1a
014500130509     d  sav_D50ksc     s                   like(D50ksc)
014600130509     d  sTNTE50ds      s                   like(TNTE50DS)
014700121025
014800121025       //--------------------------------------------------------------
014900121025       //?Definizione procedure esterne.                     ?
015000121025       //--------------------------------------------------------------
015100130507       // -?CL per file in QTEMP
015200130507     d tnte51c         pr                  extpgm('TNTE51C')
015300130507     d  kpjba                              likeds(kpjba)
015400121025
015500130507       // -?pgm calcolo delta
015600130507     d tnte50r         pr                  extpgm('TNTE50R')
015700130507     d  TNTE50ds                           likeds(TNTE50DS)
015800130509     d  parddt                        8s 0 options(*nopass:*omit)
015900130509     d  partest                       1a   options(*nopass:*omit)
016000130507
016100121024       //--------------------------------------------------------------
016200121024       //?Definizione prototipi.
016300121024       //--------------------------------------------------------------
016400121024
016500121025      /copy gaitrasrc/srcprotopr,tibs34r
016600121024      /copy gaitrasrc/srcprotopr,xsrda8
016700121025
016800121025       //--------------------------------------------------------------
016900121025       //?Definizione key-list.                                        ?
017000121025       //--------------------------------------------------------------
017100121025
017200121025       //--------------------------------------------------------------
017300121025       //?M A I N - L I N E                                            ?
017400121025       //--------------------------------------------------------------
017500121025
017600121025     c     *Entry        plist
017700121025     c                   parm                    KPJBA
017800121025
017900121025      /free
018000121025
018100121024       //?Operazioni iniziali?
018200121025       exsr RoutInz;
018300121025
018400121024       //?Gestione vidata?
018500121024       DOW wFine = *off;
018600130222         exsr GesD01;
018700121025       ENDDO;
018800121025
018900121024       //?Operazioni finali?
019000121025       exsr RoutEnd;
019100121025
019200121025       //--------------------------------------------------------------
019300121025       //?Operazioni iniziali.                                         ?
019400121025       //--------------------------------------------------------------
019500121024       BEGSR  RoutInz;
019600121025
019700121024       //?Reperimento dati job?
019800121024         exsr  DatiJob;
019900130222
020000130222       //?Impostazione campi "fissi"
020100130222         V01pgm = SDSpgm;
020200121025
020300121025       //?Reperimento della data corrente (in formato aaaa/mm/gg)?
020400121024         wOggi = %dec(%date());
020500121025
020600121025       ENDSR;
020700121025
020800121025       //--------------------------------------------------------------
020900121025       //?Reperimento Dati del job (Utente/Operativi).                 ?
021000121025       //--------------------------------------------------------------
021100121024       BEGSR  DatiJob;
021200121025
021300121025         in(E) §AzUte;
021400121025         IF  NOT %error;
021500121025           in(E) §DatiUte;
021600121025         ENDIF;
021700121025         IF  %error or RSut = *blanks;
021800121025           clear TIBS34DS;
021900121025           tibs34r ( TIBS34DS );
022000121025           in §AzUte;
022100121025           in §DatiUte;
022200121025         ENDIF;
022300121025
022400121025       ENDSR;
022500121024
022600121024       //--------------------------------------------------------------
022700130225       //?Gestione videata.
022800121024       //--------------------------------------------------------------
022900130225       BEGSR  GesD01;
023000121024
023100121024       //?Inizializzazione videata
023200130222         IF  wInzD01;
023300130222           exsr Inzd01;
023400130222           wInzD01 = *off;
023500121024         ENDIF;
023600121024
023700121024       //?Emissione videata
023800130507         write TE51T01;
023900130507         exfmt TE51D01;
024000121024         ErrMessage   = *off;
024100121024         ErrGenerico  = *off;
024200130222         clear V01msg;
024300121024
024400121024         SELECT;
024500121024
024600121024       //?F3=Fine
024700121024           WHEN  dsp_aid = c_F03;
024800130222             exsr F03D01;
024900130507
025000130507       //?F6=Conferma
025100130507           WHEN  dsp_aid = c_F06;
025200130507             exsr F06D01;
025300121024
025400121024       //?Enter
025500121024           OTHER;
025600121024
025700121024         ENDSL;
025800130226
025900121024       ENDSR;
026000121024
026100121024       //--------------------------------------------------------------
026200121024       //?Inizializzazione videata.
026300121024       //--------------------------------------------------------------
026400130222       BEGSR InzD01;
026500121024
026600130507         clear TE51D01;
026700130222
026800130222       //?Imposto T=Tariffa
026900130225         V01taof = 'T';
027000121205
027100130222       //?Imposto S=Spedizione in Data Calcolo
027200130225         V01dtacal = 'S';
027300121024
027400121024       ENDSR;
027500121024
027600121024       //--------------------------------------------------------------
027700121024       //?Gestione tasto funzionale F3.
027800121024       //?F3=Fine
027900121024       //--------------------------------------------------------------
028000130225       BEGSR F03D01;
028100121024
028200121024       //?Chiusura del programma
028300121024         wFine = *on;
028400121024
028500121024       ENDSR;
028600121024
028700121024       //--------------------------------------------------------------
028800130507       //?Gestione tasto funzionale F6.
028900130507       //?F6=Conferma
029000121024       //--------------------------------------------------------------
029100130507       BEGSR F06D01;
029200130507
029300130507       //?Se Offerta richiamo CL per creare file in QTEMP
029400130507         IF  V01taof = 'O';
029500130509           clear param;
029600130507           parksc = D50ksc;
029700130507           parctr = D50ctr;
029800130507           parprg = D50prg;
029900130509           pardtcal = V01dtacal;
030000130508           paraas = D50aas;
030100130508           parlnp = D50lnp;
030200130508           parnrs = D50nrs;
030300130508           parnsp = D50nsp;
030400130507           kpjbu  = param;
030500130507           tnte51c (kpjba);
030600130509           param = kpjbu;
030700130507         ENDIF;
030800130507
030900130507       //?Apro testata tariffa per recupero data decorrenza
031000130509         IF  not %open(TNTAM00L);
031100130509           open TNTAM00L;
031200130509         ENDIF;
031300130507         clear TAMddt;
031400130507         chain (D50ksc:D50ctr:D50prg) TNTAM00L;
031500130507         IF  %found(TNTAM00L);
031600130507           parddt = TAMddt;
031700130507         ENDIF;
031800130509
031900130509
032000130509       //?In caso di offerta devo passare al TNTE50R il codice cliente e non la trattativa
032100130509         IF  V01taof = 'O';
032200130509           sav_D50ksc = D50ksc;
032300130509           D50ksc = parksc;
032400130509         ENDIF;
032500121024
032600130507         clear D50dtr;
032700130507         IF  V01dtacal = 'O';
032800130507           D50dtr = wOggi;
032900130507         ENDIF;
033000130507
033100130507         partest = 'T';
033200130507
033300130507         tnte50r (TNTE50ds:parddt:partest);
033400130509         sTNTE50DS = TNTE50DS;
033500130509
033600130509       //?richiamo tnte50R in chiusura
033700130509         clear TNTE50DS;
033800130509         D50tla = 'C';
033900130509         tnte50r (TNTE50ds);
034000130509         TNTE50DS = sTNTE50DS;
034100130509
034200130509       //?Chiudo TNTAM
034300130509         close TNTAM00L;
034400130509
034500130509       //?richiam il CL per cancellare i file in qtemp
034600130509         IF  V01taof = 'O';
034700130509           D50ksc = sav_D50ksc;
034800130509           clear param;
034900130509           parclose = 'C';
035000130509           kpjbu  = param;
035100130509           tnte51c (kpjba);
035200130509         ENDIF;
035300130225
035400121024       ENDSR;
035500121025
035600121025       //--------------------------------------------------------------
035700121025       //?Operazioni finali.                                           ?
035800121025       //--------------------------------------------------------------
035900121024       BEGSR  RoutEnd;
036000121025
036100121025         *inLR = *on;
036200100507
036300121025       //?Uscita dal pgm
036400121025         return;
036500121025
036600121025       ENDSR;
036700121025
036800121025      /end-free
036900121024
037000121024       //--------------------------------------------------------------
037100121024       //?Schiere a tempo di compilazione.
037200121024       //--------------------------------------------------------------
037300121024
037400130222** - skMSG ------------------------------------------------------------------*
037500130507....................................                                           01
