000100130301       //======================================================================
000200130304       //?TNTE60R - Stampa simulazione delta                            (batch)  ?
000300130301       //======================================================================
000400120705
000500120705       //--------------------------------------------------------------
000600120705       //?Specifiche di controllo.                                     ?
000700120705       //--------------------------------------------------------------
000800120705
000900120705     h decedit('0,') datedit(*ymd.) option(*nodebugio)
001000120705
001100120705       //--------------------------------------------------------------
001200120705       //?Dichiarazione file.                                          ?
001300120705       //--------------------------------------------------------------
001400120705
001500130301       //?Tabelle?
001600120705     fTABEL00F  if   e           k disk
001700130304
001800130304       //?Tariffa/offerta
001900130304     fTNTAM01L  if   e           k disk
002000130304     fTITAD04L  if   e           k disk
002100130301
002200130301       //?Trattativa
002300130301     fTIVIS05L  if   e           k disk
002400120705
002500130301       //?File di stampa?
002600130301     fTNTE60P2  o    e             printer
002700120705
002800120705       //--------------------------------------------------------------
002900120705       //?Definizione costanti.                                        ?
003000120705       //--------------------------------------------------------------
003100120705
003200130301       //?Codice utente x TABEL00F?
003300120705     d c_Kut           c                   const(1)
003400120705
003500120705       //--------------------------------------------------------------
003600120705       //?Definizione schiere.                                         ?
003700120705       //--------------------------------------------------------------
003800120705
003900130301       //?Varia, importo e n° spedizioni x Singolo Cliente?
004000130301     d sk_Voce         s                   dim(99)  inz  like(WF1sv1)
004100120706     d sk_Impo         s             12  3 dim(99)  inz
004200120706     d sk_Sped         s              9  0 dim(99)  inz
004300130304
004400130304       //?Codici tassazione
004500130304     d cts             s              2    dim(600) inz
004600130304
004700130304       //?Scaglioni
004800130304     d ssgl            s             13  3 dim(200) inz
004900130304
005000130304       //?Schiere totali
005100120705
005200120705       //--------------------------------------------------------------
005300120705       //?Definizione aree dati.                                       ?
005400120705       //--------------------------------------------------------------
005500120705
005600130301       //?Dati utente?
005700120705     d §AzUte        e ds                  extname(AZUTE00F)
005800120705     d                                     dtaara
005900120705     d §DatiUte      e ds                  extname(dDatiUte)
006000120705     d                                     dtaara
006100120705
006200120705       //--------------------------------------------------------------
006300120705       //?Definizione strutture dati.                                  ?
006400120705       //--------------------------------------------------------------
006500120705
006600130301       //?Parametri ricevuti?
006700120705     d KPJBA         e ds
006800130301
006900130301       //?Parametri per il pgm chiamato
007000130301     d param           ds                  inz
007100130301     d  parks1                 1      7  0
007200130301     d  parks2                 8     14  0
007300130301     d  parks3                15     21  0
007400130301     d  parks4                22     28  0
007500130301     d  parks5                29     35  0
007600130301     d  parta1                36     38  0
007700130301     d  parta2                39     41  0
007800130301     d  parta3                42     44  0
007900130301     d  parta4                45     47  0
008000130301     d  parta5                48     50  0
008100130301     d  parln1                51     53  0
008200130301     d  parln2                54     56  0
008300130301     d  parln3                57     59  0
008400130301     d  parln4                60     62  0
008500130301     d  parln5                63     65  0
008600130301     d  pards1                66     73  0
008700130301     d  pards2                74     81  0
008800130301     d  parct1                82     83
008900130301     d  parct2                84     85
009000130301     d  parct3                86     87
009100130301     d  parct4                88     89
009200130301     d  parct5                90     91
009300130301     d  parct6                92     93
009400130301     d  parct7                94     95
009500130301     d  parct8                96     97
009600130301     d  parct9                98     99
009700130301     d  parct10              100    101
009800130301     d  parkgd               102    108  1
009900130301     d  parkga               109    115  1
010000130301     d  parcod               116    121  0
010100130301     d  parcoa               122    127  0
010200130301     d  partaof              128    128
010300130301     d  parksc               129    135  0
010400130301     d  parctr               136    138  0
010500130301     d  parprg               139    141  0
010600130301     d  parlnp               142    144  0
010700130301     d  pardtcal             145    145
010800130301     d  pardet               146    146
010900130301     d  parnrv               147    153  0
011000130301     d  parddt               154    161  0
011100120705
011200130301       //?Tabella "CC" = Codici Tassazione?
011300120705     d dsCC          e ds                  inz
011400130301
011500130301       //?File Work Varie
011600130301     d WFDBF10F      e ds                  extname(WFDBF10F)
011700120705
011800130301       //?Status ds?
011900120705     d Status         sds
012000120705     d   SDSpgm          *proc
012100120705
012200120705       //--------------------------------------------------------------
012300120705       //?Definizione variabili globali.                               ?
012400120705       //--------------------------------------------------------------
012500130301
012600130301       //?Flag booleani
012700130301     d wEnd            s               n   inz(*off)
012800130304     d wTAD            s               n   inz(*off)
012900120705
013000130301       //?Indici di schiera?
013100130304     d xi              s              4  0 inz
013200130304     d xc              s              4  0 inz
013300120705     d xx              s              3  0 inz
013400120705     d yy              s              3  0 inz
013500120705
013600130301       //?Campi di comodo?
013700130304     d ultSGL          s              6  0 inz
013800130304     d ultCTS          s              6  0 inz
013900130301     d wConta          s              1  0 inz
014000130301     d wVaria          s                   like(WF1sv1)   inz
014100130301     d wImpo           s                   like(WF1va1)   inz
014200120705
014300120705       //--------------------------------------------------------------
014400120705       //?Definizione prototipi procedure.                             ?
014500120705       //--------------------------------------------------------------
014600120705
014700130301       //?Reperimento dati utente?
014800120705     d TIBS34ds      e ds                  inz
014900120705      /copy gaitrasrc/srcProtoPR,TIBS34R
015000120705
015100130301       //?Controllo/Decodifica cliente?
015200120705      /copy gaitrasrc/srcProtoPI,TIBS69R
015300120705      /copy gaitrasrc/srcProtoPR,TIBS69R
015400120705
015500130301       //?Controllo formale / Inversione data?
015600120705     d WLBdat          ds                  inz
015700120705     d   G08dat                1      8  0 inz
015800120705     d   G08inv                9     16  0 inz
015900120705     d   G08err               17     17    inz('3')
016000120705     d   G08tgi               18     22  0 inz
016100120705      /copy gaitrasrc/srcProtoPR,XSRDA8
016200120705
016300120705       //--------------------------------------------------------------
016400120705       //?Definizione key-list.                                        ?
016500120705       //--------------------------------------------------------------
016600120705
016700130301       //?File TABEL00F?
016800120705     d k03tabel00    e ds                  extname(TABEL00F : *key)
016900120705     d                                     prefix(k_)   inz
017000120705
017100120705       //--------------------------------------------------------------
017200120705       //?M A I N - L I N E                                            ?
017300120705       //--------------------------------------------------------------
017400120705
017500120705     c     *Entry        plist
017600120705     c                   parm                    KPJBA
017700120705
017800120705      /free
017900120705
018000130301       //?Operazioni iniziali?
018100130301       exsr  RoutInz;
018200120705
018300130304       //?Carico scaglioni
018400130304       exsr  Scaglioni;
018500130304
018600130304       //?Stampa la pagina dei parametri richiesi a video
018700130304       exsr  Parametri;
018800130304
018900130301       //?Elaborazione file riepilogo varie?
019000130301       exsr  LeggiWF;
019100120705
019200130301       //?Stampa a totale
019300130301       exsr  StampaTOT;
019400120705
019500130301       //?Operazioni finali?
019600130301       exsr  RoutEnd;
019700120705
019800120705       //--------------------------------------------------------------
019900120705       //?Operazioni iniziali.                                         ?
020000120705       //--------------------------------------------------------------
020100130301       BEGSR  RoutInz;
020200130301
020300130301         exec sql  set option  dynusrprf = *owner,
020400130301                               closqlcsr = *endmod;
020500120705
020600130301       //?Impostazione parametri ricevuti?
020700130301         param = kpjbu;
020800120705
020900130301       //?Reperimento dati job?
021000130301         exsr  DatiJob;
021100120705
021200130301       //?Impostazione campi fissi?
021300120705         clear  k03tabel00;
021400120705         k_TBLkut = c_Kut;
021500120705
021600130301       //?Impostazione campi in testata?
021700120705         P1Trsu = RsUt;
021800120705         P1Tpgm = SDSpgm;
021900120705
022000120705       ENDSR;
022100120705
022200120705       //--------------------------------------------------------------
022300120705       //?Reperimento Dati del job (Utente/Operativi).                 ?
022400120705       //--------------------------------------------------------------
022500130301       BEGSR  DatiJob;
022600120705
022700120705         in(E) §AzUte;
022800120705         if NOT %error;
022900120705           in(E) §DatiUte;
023000120705         endif;
023100120705         if %error or RSut = *blanks;
023200120705           clear TIBS34ds;
023300120705           tibs34r ( tibs34ds );
023400120705           in §AzUte;
023500120705           in §DatiUte;
023600120705         endif;
023700120705
023800120705       ENDSR;
023900130304
024000130304       //--------------------------------------------------------------
024100130304       //?Carico scaglioni.
024200130304       //--------------------------------------------------------------
024300130304       BEGSR  Scaglioni;
024400130304
024500130304         clear xi;
024600130304         clear xc;
024700130304         wTAD = *off;
024800130304
024900130304         IF  parlnp = 0;
025000130304           setll (parksc:parctr:parprg) TITAD04L;
025100130304           reade (parksc:parctr:parprg) TITAD04L;
025200130304         ELSE;
025300130304           setll (parksc:parctr:parprg:parlnp) TITAD04L;
025400130304           reade (parksc:parctr:parprg:parlnp) TITAD04L;
025500130304         ENDIF;
025600130304         DOW  not %eof(TITAD04L);
025700130304           wTAD = *on;
025800130304           exsr memTAD;
025900130304
026000130304           IF  parlnp = 0;
026100130304             reade (parksc:parctr:parprg) TITAD04L;
026200130304           ELSE;
026300130304             reade (parksc:parctr:parprg:parlnp) TITAD04L;
026400130304           ENDIF;
026500130304         ENDDO;
026600130304
026700130304         ultSGL = xi;
026800130304         utlcts = xc;
026900130304
027000130304         IF  not wTAD;
027100130304           exsr RoutEnd;
027200130304         ENDIF;
027300130304
027400130304       ENDSR;
027500130304
027600130304       //--------------------------------------------------------------
027700130304       //?Memorizza gli scaglioni.
027800130304       //--------------------------------------------------------------
027900130304       BEGSR  memTAD;
028000130304
028100130304
028200130304       ENDSR;
028300130304
028400130304       //--------------------------------------------------------------
028500130304       //?Stampa pagina parametri.
028600130304       //--------------------------------------------------------------
028700130304       BEGSR  Parametri;
028800130304
028900130304
029000130304       ENDSR;
029100120705
029200120705       //--------------------------------------------------------------
029300130301       //?Elaborazione file riepilogo varie
029400120705       //--------------------------------------------------------------
029500130301       BEGSR  LeggiWF;
029600130301
029700130301       //?Dichiarazione cursore
029800130301         exec sql
029900130301           DECLARE WFDBF cursor for
030000130301           SELECT * from WFDBF10F;
030100130301
030200130301       //?Apertura del cursore
030300130301         exec sql
030400130301           open WFDBF;
030500130301
030600130301         IF sqlcode < 0;
030700130301           wEnd = *on;
030800130301         ENDIF;
030900130301
031000130301         DOW not wEnd;
031100130301           exec sql
031200130301             fetch next from WFDBF into :WFDBF10F;
031300130301           IF  sqlcod = 100 or sqlcod < 0;
031400130301             wEnd = *on;
031500130301             leave;
031600130301           ENDIF;
031700120705
031800130301       //?Sommo le varie
031900130301           exsr varieWF;
032000130301
032100130301         ENDDO;
032200130301
032300130301         exec sql
032400130301           close WFDBF;
032500120705
032600120705       ENDSR;
032700130301
032800130301       //--------------------------------------------------------------
032900130301       //?Varie del Work File in SK.                                   ?
033000130301       //--------------------------------------------------------------
033100130301       BEGSR  varieWF;
033200130301
033300130301         IF  WF1sv1 <> *blanks;
033400130301           Wvaria = WF1sv1;
033500130301           Wimpo  = WF1va1;
033600130301           exsr  TOTvaria;
033700130301         ENDIF;
033800130301
033900130301         IF  WF1sv2 <> *blanks;
034000130301           Wvaria = WF1sv2;
034100130301           Wimpo  = WF1va2;
034200130301           exsr  TOTvaria;
034300130301         ENDIF;
034400130301
034500130301         IF  WF1sv3 <> *blanks;
034600130301           Wvaria = WF1sv3;
034700130301           Wimpo  = WF1va3;
034800130301           exsr  TOTvaria;
034900130301         ENDIF;
035000130301
035100130301         IF  WF1sv4 <> *blanks;
035200130301           Wvaria = WF1sv4;
035300130301           Wimpo  = WF1va4;
035400130301           exsr  TOTvaria;
035500130301         ENDIF;
035600130301
035700130301         IF  WF1sv5 <> *blanks;
035800130301           Wvaria = WF1sv5;
035900130301           Wimpo  = WF1va5;
036000130301           exsr  TOTvaria;
036100130301         ENDIF;
036200130301
036300130301         IF  WF1sv6 <> *blanks;
036400130301           Wvaria = WF1sv6;
036500130301           Wimpo  = WF1va6;
036600130301           exsr  TOTvaria;
036700130301         ENDIF;
036800130301
036900130301         IF  WF1sv7 <> *blanks;
037000130301           Wvaria = WF1sv7;
037100130301           Wimpo  = WF1va7;
037200130301           exsr  TOTvaria;
037300130301         ENDIF;
037400130301
037500130301         IF  WF1sv8 <> *blanks;
037600130301           Wvaria = WF1sv8;
037700130301           Wimpo  = WF1va8;
037800130301           exsr  TOTvaria;
037900130301         ENDIF;
038000130301
038100130301         IF  WF1sv9 <> *blanks;
038200130301           Wvaria = WF1sv9;
038300130301           Wimpo  = WF1va9;
038400130301           exsr  TOTvaria;
038500130301         ENDIF;
038600130301
038700130301         IF  WF1s10 <> *blanks;
038800130301           Wvaria = WF1s10;
038900130301           Wimpo  = WF1v10;
039000130301           exsr  TOTvaria;
039100130301         ENDIF;
039200130301
039300130301         IF  WF1s11 <> *blanks;
039400130301           Wvaria = WF1s11;
039500130301           Wimpo  = WF1v11;
039600130301           exsr  TOTvaria;
039700130301         ENDIF;
039800130301
039900130301         IF  WF1s12 <> *blanks;
040000130301           Wvaria = WF1s12;
040100130301           Wimpo  = WF1v12;
040200130301           exsr  TOTvaria;
040300130301         ENDIF;
040400130301
040500130301         IF  WF1s13 <> *blanks;
040600130301           Wvaria = WF1s13;
040700130301           Wimpo  = WF1v13;
040800130301           exsr  TOTvaria;
040900130301         ENDIF;
041000130301
041100130301         IF  WF1s14 <> *blanks;
041200130301           Wvaria = WF1s14;
041300130301           Wimpo  = WF1v14;
041400130301           exsr  TOTvaria;
041500130301         ENDIF;
041600130301
041700130301         IF  WF1s15 <> *blanks;
041800130301           Wvaria = WF1s15;
041900130301           Wimpo  = WF1v15;
042000130301           exsr  TOTvaria;
042100130301         ENDIF;
042200130301
042300130301         IF  WF1s16 <> *blanks;
042400130301           Wvaria = WF1s16;
042500130301           Wimpo  = WF1v16;
042600130301           exsr  TOTvaria;
042700130301         ENDIF;
042800130301
042900130301         IF  WF1s17 <> *blanks;
043000130301           Wvaria = WF1s17;
043100130301           Wimpo  = WF1v17;
043200130301           exsr  TOTvaria;
043300130301         ENDIF;
043400130301
043500130301         IF  WF1s18 <> *blanks;
043600130301           Wvaria = WF1s18;
043700130301           Wimpo  = WF1v18;
043800130301           exsr  TOTvaria;
043900130301         ENDIF;
044000130301
044100130301         IF  WF1s19 <> *blanks;
044200130301           Wvaria = WF1s19;
044300130301           Wimpo  = WF1v19;
044400130301           exsr  TOTvaria;
044500130301         ENDIF;
044600130301
044700130301         IF  WF1s20 <> *blanks;
044800130301           Wvaria = WF1s20;
044900130301           Wimpo  = WF1v20;
045000130301           exsr  TOTvaria;
045100130301         ENDIF;
045200130301
045300130301       ENDSR;
045400120705
045500120705       //--------------------------------------------------------------
045600120705       //?Incremento totali per voce in schiera.                       ?
045700120705       //--------------------------------------------------------------
045800130301       BEGSR  TOTvaria;
045900120705
046000130304         xx = %lookup(Wvaria : sk_Voce);
046100130301         IF  xx = *zero;
046200130304           xx = %lookup(*blank : sk_Voce);
046300130301           IF  xx > *zero;
046400120705             sk_Voce(xx) = Wvaria;
046500130301           ENDIF;
046600130301         ENDIF;
046700120705
046800120705         sk_Impo(xx) += Wimpo;
046900120705         sk_Sped(xx) += 1;
047000120705
047100120705       ENDSR;
047200120705
047300120705       //--------------------------------------------------------------
047400130301       //?Stampa TOTALI.
047500120705       //--------------------------------------------------------------
047600130301       BEGSR  StampaTOT;
047700120705
047800130301       //?Decodifica cliente/offerta?
047900130301         IF  partaof = 'T';
048000120705           clear  TIBS69ds;
048100120705           I69sif = knsif;
048200120705           I69kcc = DUTkci;
048300130301           I69kac = P1Tksc;
048400120705           tibs69r( tibs69ds :
048500120705                    ds_cnaco : ds_cnind : ds_cnclp : ds_fncls );
048600130301           IF  O69err <> *on;
048700130301             P1Trag = ACOrag;
048800130301           ENDIF;
048900130301         ELSE;
049000130301           chain P1Tksc TIVIS05L;
049100130301           IF  %found(TIVIS05L);
049200130301             P1Trag = VISrag;
049300130301           ENDIF;
049400130301         ENDIF;
049500120705
049600130301       //?Stampa testate?
049700130301         write  TE60PT1;
049800130301         write  TE60PT2;
049900120705
050000130301       //?Stampa delle varie di 2 in 2?
050100120705         xx = 1;
050200130301         DOW  sk_Voce(xx) <> *blank;
050300120705
050400130301           wConta = 1;
050500130301           clear  TE60VAR;
050600120705
050700130301           DOW  wConta <= 2  and  sk_Voce(xx) <> *blank;
050800130301             wVaria = sk_Voce(xx);
050900130304             exsr  sr_TabCC;
051000130304             IF  wConta = 1;
051100130304               P1Csv1 = sk_Voce(xx) + ' -';
051200130304               P1Dsv1 = §CCdes;
051300130304               P1Cva1  = sk_Impo(xx);
051400130304               P1Cspe1 = sk_Sped(xx);
051500130304             ELSE;
051600130304               P1Csv2  = sk_Voce(xx) + ' -';
051700130304               P1Dsv2  = §CCdes;
051800130304               P1Cva2  = sk_Impo(xx);
051900130304               P1Cspe2 = sk_Sped(xx);
052000130304             ENDIF;
052100120705             xx += 1;
052200130301             wConta += 1;
052300130301           ENDDO;
052400120705
052500130301           write  TE60VAR;
052600120705
052700130301         ENDDO;
052800120705
052900120705       ENDSR;
053000120705
053100120705       //--------------------------------------------------------------
053200120705       //?Decodifica Sigla Varia.                                      ?
053300120705       //--------------------------------------------------------------
053400120705       BEGSR  sr_TabCC;
053500120705
053600120705         clear  dsCC;
053700120705         k_TBLcod = 'CC';
053800130301         k_TBLkey = 'VARIE  ' + wVaria;
053900120705
054000120705         chain  %kds( k03tabel00 )  TABEL;
054100120705
054200120705         if  %found(TABEL00F);
054300120705           dsCC = TBLuni;
054400120705         else;
054500120705           §CCdes = *all'?';
054600120705         endif;
054700120705
054800120705       ENDSR;
054900120705
055000120705       //--------------------------------------------------------------
055100130301       //?Routine Finale.
055200120705       //--------------------------------------------------------------
055300130301       BEGSR  RoutEnd;
055400120710
055500130301       //?Stampa "*** FINE STAMPA ***"?
055600130301         write  TE60END;
055700120705
055800130301       //?Chiusura funzioni precedentemente aperte?
055900120705         reset  TIBS69ds;
056000120705         tibs69r( tibs69ds :
056100120705                  ds_cnaco : ds_cnind : ds_cnclp : ds_fncls );
056200130301
056300130301         *inLR = *on;
056400120705
056500130301       //?Chiusura pgm?
056600120705         return;
056700120705
056800120705       ENDSR;
