000100110414      //--------------------------------------------------------------
000200110414      //?TNVRATC1 - Aggiorna Categoria Potenziale in TIATC / TIVIS
000300110414      //?         - nei FLO dei file
000400110414      //--------------------------------------------------------------
000500110414
000600110414     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000700110414     h dftactgrp(*no) actgrp(*caller)
000800110414
000900110414      //---------------------------------------------------------------
001000110414      //?Dichiarazione file.
001100110414      //---------------------------------------------------------------
001200110414     fTNCPO01L  if   e           k disk
001300110414     fTIVIS01L  uf   e           k disk
001400110414     fTIATC04L  uf   e           k disk
001500110414
001600110414      //---------------------------------------------------------------
001700110414      //?Definizione costanti.
001800110414      //---------------------------------------------------------------
001900110414
002000110414      //---------------------------------------------------------------
002100110414      //?Definizione schiere.
002200110414      //---------------------------------------------------------------
002300110414
002400110414      //---------------------------------------------------------------
002500110414      //?Definizione aree dati.
002600110414      //---------------------------------------------------------------
002700110414
002800110414      // - Dati utente
002900110414     d §AzUte        e ds                  extname(AZUTE00F)
003000110414     d                                     dtaara
003100110414     d §DatiUte      e ds                  extname(dDatiUte)
003200110414     d                                     dtaara
003300110414
003400110414      //---------------------------------------------------------------
003500110414      //?Definizione strutture dati.
003600110414      //---------------------------------------------------------------
003700110414
003800110414      // - Parametri ricevuti
003900110414     d KPJBA         e ds
004000110414
004100110414      // - Flag operativi tiatc
004200110414     d datc01        e ds                  inz
004300110414
004400110414      // - Flag operativi tivis
004500110414     d dvis01        e ds                  inz
004600110414
004700110414
004800110414      //---------------------------------------------------------------
004900110414      //?Definizione variabili globali.
005000110414      //---------------------------------------------------------------
005100110414
005200110414      // - Flags booleani
005300110414     d $End            s               n   inz(*off)
005400110414
005500110414      // - Indici di schiera
005600110414
005700110414      // - Campi di comodo
005800110414     d w_cpo           s             11  0 inz
005900110414     d w_cpofls        s              1    inz
006000110414
006100110414      //---------------------------------------------------------------
006200110414      //?Definizione procedure esterne.
006300110414      //---------------------------------------------------------------
006400110414
006500110414
006600110414      //---------------------------------------------------------------
006700110414      //?prototipi
006800110414      //---------------------------------------------------------------
006900110414
007000110414      //---------------------------------------------------------------
007100110414      //?Definizione key-list.
007200110414      //---------------------------------------------------------------
007300110414
007400110414      //---------------------------------------------------------------
007500110414      //?Riepilogo indicatori.
007600110414      //---------------------------------------------------------------
007700110414
007800110414      //---------------------------------------------------------------
007900110414
008000110414      //---------------------------------------------------------------
008100110414      //?M A I N - L I N E
008200110414      //---------------------------------------------------------------
008300110414
008400110414     c     *Entry        plist
008500110414     c                   parm                    KPJBA
008600110414
008700110414      /free
008800110414
008900110414       //?Elaborazione attività / Visite
009000110414       exsr Sr_Aggiorna ;
009100110414
009200110414       //?Operazioni finali
009300110414       exsr RoutEnd;
009400110414
009500110414       //--------------------------------------------------------------
009600110414       //?Aggiornamento archivi Tiatc Tivis
009700110414       //--------------------------------------------------------------
009800110414       BEGSR Sr_aggiorna ;
009900110414
010000110414       // Imposto uno alla chiave perchè voglio evitare di leggere tutte
010100110414       // le attività non legate ai potenziali
010200110414         W_cpo = 1 ;
010300110414         setll W_cpo tiatc04l ;
010400110414         Dow not $end ;
010500110414             read(e) tiatc04l ;
010600110414             If %error ;
010700110414                iter;
010800110414             endif ;
010900110414             If %eof(tiatc04l) ;
011000110414                leave ;
011100110414             Endif ;
011200110414             If atccpo = 0 ;
011300110414                iter ;
011400110414             Endif ;
011500110414             If W_cpo <> atccpo  ;
011600110414                W_cpo = atccpo   ;
011700110414                clear W_cpofls   ;
011800110414       // a rottura di codice aggancio il file TNCPO per recuperare l'attuale
011900110414       // categoria da aggiornare sui files
012000110414                chain atccpo ticpo01l ;
012100110414                If not %found(ticpo01l) ;
012200110414       // Se non trovo il potenziale mi posizione sulle attività del potenmziale successivo
012300110414                   setgt W_cpo tiatc04l ;
012400110414                   Clear W_cpo ;
012500110414                   iter ;
012600110414                endif ;
012700110414             endif ;
012800110414             datc01 = atcflo ;
012900110414       // verifico se 1° categoria potenziale è blank e causale da fare valorizzata
013000110414       // valorizzo la categoria
013100110414             If §atccapo1 = ' ' and atccad <> '  ' ;
013200110414                §atccapo1 = cpofls ;
013300110414             Endif ;
013400110414
013500110414       // verifico se 2° categoria potenziale è blank e causale esecuzione valorizzata
013600110414       // valorizzo la categoria
013700110414             If §atccapo2 = ' ' and atccac <> '  ' ;
013800110414                §atccapo2 = cpofls ;
013900110414             Endif ;
014000110414
014100110414             update tiatc000 ;
014200110414
014300110414         Enddo ;
014400110414
014500110414       // Aggiorniamo il file visite
014600110414
014700110414         W_cpo = 1 ;
014800110414         setll W_cpo tivis01l ;
014900110414         Dow not $end ;
015000110414             read(e) tivis01l ;
015100110414             If %error ;
015200110414                iter;
015300110414             endif ;
015400110414             If %eof(tivis01l) ;
015500110414                leave ;
015600110414             Endif ;
015700110414             If viscpo = 0 ;
015800110414                iter ;
015900110414             Endif ;
016000110414             If W_cpo <> viscpo  ;
016100110414                W_cpo = viscpo   ;
016200110414                clear W_cpofls   ;
016300110414       // a rottura di codice aggancio il file TNCPO per recuperare l'attuale
016400110414       // categoria da aggiornare sui files
016500110414                chain viscpo ticpo01l ;
016600110414                If not %found(ticpo01l) ;
016700110414       // Se non trovo il potenziale mi posizione sulle attività del potenmziale successivo
016800110414                   setgt W_cpo tivis01l ;
016900110414                   Clear W_cpo ;
017000110414                   iter ;
017100110414                endif ;
017200110414             endif ;
017300110414             dvis01 = visflo ;
017400110414       // verifico se categoria potenziale è blank
017500110414       // valorizzo la categoria
017600110414             If §viscatpo = ' ' ;
017700110414                §viscatpo = cpofls ;
017800110414             Endif ;
017900110414
018000110414             update tivis000 ;
018100110414
018200110414         Enddo ;
018300110414
018400110414       ENDSR ;
018500110414       //--------------------------------------------------------------
018600110414       //?Operazioni finali.
018700110414       //--------------------------------------------------------------
018800110414       BEGSR RoutEnd;
018900110414
019000110414         *inLR = *on;
019100110414         return;
019200110414
019300110414       ENDSR;
019400110414
019500110414      /end-free
