000100100413      //---------------------------------------------------------------
000200110222      //?TNVRCPO04 - Metto codice commerciale se = 0
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000110207      // - File Anagrafica clienti
001100110207     fCNACO16L  if   e           k disk
001200110222     fCNCLP00F  if   e           k disk
001300110222
001400110222      // - File Anagrafica Potenziali
001500110222     fTNCPO00F  uf   e             disk
001600100413
001700100413      //---------------------------------------------------------------
001800100413      //?Definizione costanti.
001900100413      //---------------------------------------------------------------
002000100413
002100100413      //---------------------------------------------------------------
002200100413      //?Definizione schiere.
002300100413      //---------------------------------------------------------------
002400090715
002500100413      //---------------------------------------------------------------
002600100413      //?Definizione aree dati.
002700100413      //---------------------------------------------------------------
002800100413
002900100413      //---------------------------------------------------------------
003000100413      //?Definizione strutture dati.
003100100413      //---------------------------------------------------------------
003200110204
003300110204     d KPJBA         e ds
003400110223
003500110223      // File Attività
003600110223     d TIATCds       e ds                  extname(TIATC00F)
003700100415
003800100413      //---------------------------------------------------------------
003900100413      //?Definizione variabili globali.
004000100413      //---------------------------------------------------------------
004100100413
004200100413      // - Flags booleani
004300100413     d $End            s               n   inz(*off)
004400110204     d $Fine           s               n   inz(*off)
004500110222
004600110222      // - Campi di comodo
004700110222     d nRec            s             10  0 inz
004800110222     d savage          s                   like(CLPage)
004900100413
005000100413      //---------------------------------------------------------------
005100100413      //?Definizione procedure esterne.
005200100413      //---------------------------------------------------------------
005300100413
005400100413      //---------------------------------------------------------------
005500110204      //?Prototipi.
005600100413      //---------------------------------------------------------------
005700100413
005800100413      //---------------------------------------------------------------
005900100413      //?Definizione key-list.
006000100413      //---------------------------------------------------------------
006100100413
006200100413      //---------------------------------------------------------------
006300100413      //?Riepilogo indicatori.
006400100413      //---------------------------------------------------------------
006500100413
006600100413      //---------------------------------------------------------------
006700100413      //?M A I N - L I N E
006800100413      //---------------------------------------------------------------
006900100413
007000100413     c     *Entry        plist
007100110204     c                   parm                    kpjba
007200100413
007300100413      /free
007400100413
007500100413       //?Operazioni iniziali
007600100513       exsr RoutInz;
007700110204
007800110204       exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
007900100413
008000100726       //?Elaboro
008100100726       exsr Elabora;
008200100413
008300100413       //?Operazioni finali
008400100513       exsr RoutEnd;
008500100413
008600100413       //--------------------------------------------------------------
008700100413       //?Operazioni iniziali.
008800100413       //--------------------------------------------------------------
008900100513       BEGSR RoutInz;
009000110204
009100100413
009200100413       ENDSR;
009300100413
009400100413       //--------------------------------------------------------------
009500100422       //?Elaboro.
009600100413       //--------------------------------------------------------------
009700100513       BEGSR Elabora;
009800100413
009900110204         $Fine = *off;
010000100413
010100110222       //?Leggo i potenziali senza codice commerciale
010200100413         exec sql
010300100726         DECLARE CPO cursor for
010400110222         SELECT  rrn(TNCPO00F) as nRec, CPOcpo, CPOfls, CPOflt
010500110204         FROM TNCPO00F
010600110222         WHERE CPOcmm = 0
010700110223         ORDER by CPOfls, CPOcpo;
010800100413
010900100726         exec sql OPEN CPO;
011000100413
011100110204         DOW  not $Fine;
011200110222           exec sql FETCH next from CPO into :nRec, :CPOcpo,
011300110223                                             :CPOfls, :CPOflt;
011400100413           IF  sqlcod = 100 or sqlcod < 0;
011500110204             $Fine = *on;
011600100413             leave;
011700100413           ENDIF;
011800100422
011900110222         //?Se potenziale perso o codificato
012000110222           IF  CPOfls <> 'M';
012100110222             clear savage;
012200110222         //?Aggancio CNACO e prendo il codice commerciale del primo cliente che aggancio
012300110222             chain CPOcpo CNACO16L;
012400110222             IF  %found(CNACO16L);
012500110222               chain (ACOkut:ACOkcc:ACOksc) CNCLP00F;
012600110222               IF  %found(CNCLP00F);
012700110222                 savage = CLPage;
012800110222               ENDIF;
012900110222             ENDIF;
013000110222           ENDIF;
013100110222
013200110223         //?Se potenziale mai codificato
013300110222           IF  CPOfls = 'M';
013400110223         //?Cerco l'ultima attività e metto il commerciale dell'attività che trovo
013500110223             clear savage;
013600110223             exsr Attivita;
013700110204           ENDIF;
013800110223
013900110223         //?Aggiorno il potenziale
014000110223           IF  savage > 0;
014100110223             chain nRec TNCPO00F;
014200110223             IF  %found;
014300110223               IF  %subst(%editc(savage:'X'):1:3) <>
014400110223                   %subst(%editc(CPOflt:'X'):1:3);
014500110223                  CPOflt = %dec(%subst(%editc(savage:'X'):1:3):3:0);
014600110223               ENDIF;
014700110223               CPOcmm = savage;
014800110223               update TNCPO000;
014900110223             ENDIF;
015000110223           ENDIF;
015100100726
015200100413         ENDDO;
015300100413
015400100726         exec sql CLOSE CPO;
015500100413
015600100413       ENDSR;
015700100726
015800100726       //--------------------------------------------------------------
015900110223       //?Cerco l'ultima attività del potenziale mai codificato.
016000100726       //--------------------------------------------------------------
016100110223       BEGSR Attivita;
016200100726
016300110223         $End = *off;
016400110223
016500110223         exec sql
016600110223          declare ATT cursor for
016700110223          select TIATC00F.*
016800110223          from TIATC00F
016900110223          where ATCcpo = :CPOcpo
017000110223          order by ATCcpo, ATCatn, ATCatnp, ATCdad, ATChda, ATCdco, ATChco;
017100110223
017200110223         exec sql
017300110223           open ATT;
017400110223           IF sqlcode < 0;
017500110223             $End = *on;
017600110223           ENDIF;
017700110223
017800110223         DOW not $End;
017900110223           exec sql
018000110223             fetch next from ATT into :TIATCds;
018100110223             IF sqlcod = 100 or sqlcod < 0;
018200110223               $End = *on;
018300110223               leave;
018400110223             ENDIF;
018500110223
018600110223             SELECT;
018700110223               WHEN  ATCcmm > 0;
018800110223                 savage = ATCcmm;
018900110223               WHEN  ATCcco > 0;
019000110223                 savage = ATCcco;
019100110223             ENDSL;
019200110223
019300110223         ENDDO;
019400110223
019500110223         exec sql close ATT;
019600100726
019700100726       ENDSR;
019800100413
019900100413       //--------------------------------------------------------------
020000100413       //?Operazioni finali.
020100100413       //--------------------------------------------------------------
020200100513       BEGSR RoutEnd;
020300100413
020400100413         *inLR = *on;
020500100413         return;
020600100413
020700100413       ENDSR;
020800100413
020900100413      /end-free
