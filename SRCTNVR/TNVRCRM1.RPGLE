000100100413      //---------------------------------------------------------------
000200100513      //?TNVRCRM1 - Crea file di work visite
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000100413     fCNACO00F  if   e           k disk
001100100416     fCNACO16L  if   e           k disk    rename(cnaco000:cnaco16)
001200100413     fTFACO00F  if   e           k disk    rename(cnaco000:tfaco000)
001300100416     fTNCPO01L  if   e           k disk
001400100416     fTNOFM01L  if   e           k disk
001500100414     fTNVIS02L  uf   e           k disk
001600100413     fWFVIS00F  o    e             disk
001700100414     fTNVRCRMP  o    e             printer oflind(*in99)
001800100413
001900100413      //---------------------------------------------------------------
002000100413      //?Definizione costanti.
002100100413      //---------------------------------------------------------------
002200100413
002300100413      //---------------------------------------------------------------
002400100413      //?Definizione schiere.
002500100413      //---------------------------------------------------------------
002600100513
002700100513     d filiali         s              3a   dim(10)
002800100513     d $Pog            s              3  0 dim(2500)
002900090715
003000100413      //---------------------------------------------------------------
003100100413      //?Definizione aree dati.
003200100413      //---------------------------------------------------------------
003300100413
003400100413      //---------------------------------------------------------------
003500100413      //?Definizione strutture dati.
003600100413      //---------------------------------------------------------------
003700100423
003800100423     d KPJBA         e ds
003900100413
004000100413      // - Reperimento filiali
004100100413     d TRUL31DS      e ds
004200100413     d pog                    10    759  0 dim(250)
004300100413
004400100413      //---------------------------------------------------------------
004500100413      //?Definizione variabili globali.
004600100413      //---------------------------------------------------------------
004700100413
004800100413      // - Flags booleani
004900100413     d $End            s               n   inz(*off)
005000100413     d $Fine           s               n   inz(*off)
005100100414     d $Stampa         s               n   inz(*off)
005200100413
005300100413      // - Indici di schiera
005400100513     d xx              s              4  0 inz
005500100513     d yy              s              4  0 inz
005600100513     d zz              s              4  0 inz
005700100413
005800100413      // - Campi di comodo
005900100413     d k_VIScmmda      s                   like(VIScmm)
006000100413     d k_VIScmmal      s                   like(VIScmm)
006100100513     d TotNrv          s              7  0
006200100513     d TotNrw          s              7  0
006300100422     d wRiga           s              2  0
006400100413
006500100413      //---------------------------------------------------------------
006600100413      //?Definizione procedure esterne.
006700100413      //---------------------------------------------------------------
006800100413
006900100413      //---------------------------------------------------------------
007000100413      //?prototipi
007100100413      //---------------------------------------------------------------
007200100414
007300100413      /copy gaitrasrc/srcprotopr,trul31r
007400100413
007500100413      //---------------------------------------------------------------
007600100413      //?Definizione key-list.
007700100413      //---------------------------------------------------------------
007800100413
007900100413      //---------------------------------------------------------------
008000100413      //?Riepilogo indicatori.
008100100413      //---------------------------------------------------------------
008200100414
008300100414      // 99    : Salto pagina
008400100413
008500100413      //---------------------------------------------------------------
008600100413      //?M A I N - L I N E
008700100413      //---------------------------------------------------------------
008800100413
008900100413     c     *Entry        plist
009000100513     c                   parm                    filiali
009100100413
009200100413      /free
009300100413
009400100413       //?Operazioni iniziali
009500100513       exsr RoutInz;
009600100413
009700100413       //?Scrivo le trattative da trascodificare sul file di work
009800100413       IF  not $Fine;
009900100513         exsr Elabora;
010000100413       ENDIF;
010100100413
010200100413       //?Operazioni finali
010300100513       exsr RoutEnd;
010400100413
010500100413       //--------------------------------------------------------------
010600100413       //?Operazioni iniziali.
010700100413       //--------------------------------------------------------------
010800100513       BEGSR RoutInz;
010900100513
011000100513         yy = 1;
011100100413
011200100513       //?Ciclo per filiali passate
011300100513         FOR  yy BY 1 to 10;
011400100513
011500100514           IF  filiali(yy) <> *zeros and filiali(yy) <> *blanks;
011600100513
011700100513         //?Recupero filiali del 'RA' per ogni filiale che sto leggendo
011800100513             clear TRUL31DS;
011900100513             I31abi = 'RA';
012000100513             I31cpo = %dec(filiali(yy):3:0);
012100100513             callp trul31r (kpjba : trul31ds);
012200100513             IF  O31pog <= *zeros;
012300100513               $Fine = *on;
012400100513               leavesr;
012500100513             ENDIF;
012600100513
012700100513         //?Memorizzo le filiali appena caricate in un'unica schiera
012800100514             zz = %lookup(*zeros:$Pog);
012900100514             %subarr($Pog:zz:250) = pog;
013000100513
013100100513           ENDIF;
013200100413
013300100513         ENDFOR;
013400100513
013500100513         clear TotNrv;
013600100513         clear TotNrw;
013700100513
013800100413       ENDSR;
013900100414
014000100414       //--------------------------------------------------------------
014100100513       //?Elaboro le visite.
014200100414       //--------------------------------------------------------------
014300100513       BEGSR Elabora;
014400100414
014500100513         xx = 1;
014600100513         FOR xx by 1 to %elem($Pog);
014700100513           IF  $Pog(xx) > 0;
014800100513             k_VIScmmda = $pog(xx) * 10000;
014900100513             k_VIScmmal = k_VIScmmda + 9999;
015000100513         //?Leggo file visite
015100100513             exsr Leggi_Vis;
015200100513           ENDIF;
015300100513         ENDFOR;
015400100513
015500100513       //?Stampa totali
015600100513         wRiga = 00;
015700100513         exsr Stampa;
015800100414
015900100414       ENDSR;
016000100413
016100100413       //--------------------------------------------------------------
016200100413       //?Leggo il file visite.
016300100413       //--------------------------------------------------------------
016400100413       BEGSR Leggi_Vis;
016500100413
016600100413         setll k_VIScmmda TNVIS02L;
016700100413         read  TNVIS02L;
016800100413         DOW  not %eof(TNVIS02L);
016900100413
017000100513         //?A rottura di commerciale esco
017100100413           IF  VIScmm > k_VIScmmal;
017200100413             leave;
017300100413           ENDIF;
017400100414         //?Scarto le visite chiuse e le visite già elaborate
017500100414           IF  VISfsv <> 'C' and VISdat = 0;
017600100413           //?Scrivo file di work
017700100413             exsr Scrivi_Vis;
017800100414           //?Imposto data trascodifica in VISdat
017900100414             VISdat = %dec(%date());
018000100414             update TNVIS000;
018100100513          //?Conto il nr. di visite aggiornate
018200100513             TotNrv += 1;
018300100413           ENDIF;
018400100413
018500100413           read TNVIS02L;
018600100413         ENDDO;
018700100413
018800100413       ENDSR;
018900100413
019000100413       //--------------------------------------------------------------
019100100413       //?Scrivo il file di work.
019200100413       //--------------------------------------------------------------
019300100413       BEGSR Scrivi_Vis;
019400100413
019500100413         clear WFVIS000;
019600100416
019700100413       //?Recupero il potenziale
019800100413         ACOkut = 1;
019900100413         ACOkcc = 151;
020000100414         chain (ACOkut:ACOKcc:VISNRV) TFACO00F;
020100100414         IF  %Found(TFACO00F);
020200100414           WIScpo = ACOlib;
020300100414         ENDIF;
020400100414         IF  VISksc > 0 and not %Found(TFACO00F);
020500100414           chain (ACOkut:ACOKcc:VISksc) CNACO00F;
020600100414           IF  %Found(CNACO00F);
020700100414             WIScpo = ACOlib;
020800100414           ENDIF;
020900100413         ENDIF;
021000100416
021100100416       //?Recupero commerciale e filiale potenziale
021200100416         IF  WIScpo > 0;
021300100416           chain WIScpo TNCPO01L;
021400100416           IF  %Found(TNCPO01L);
021500100416             WIScmmp = CPOcmm;
021600100416             WISfil  = CPOflt;
021700100416           ENDIF;
021800100422         //?Non trovo anagrafica potenziale stampo errore e non scrivo il file di work
021900100422           IF  not %Found(TNCPO01L);
022000100422           STPcpo = WIScpo;
022100100422           wRiga = 04;
022200100426           STPdes = 'Visita ' + %editc(VISnrv:'Z') + ' non scritta.';
022300100513           exsr Stampa;
022400100422           leavesr;
022500100422           ENDIF;
022600100416
022700100416       //?Imposto se mai codificato
022800100416           chain WIScpo CNACO16L;
022900100416           IF  not %Found(CNACO16L);
023000100416             WIScod = 'S';
023100100416           ENDIF;
023200100416         ENDIF;
023300100416
023400100416       //?Imposto se ha offerte
023500100416         setll VISnrv TNOFM01L;
023600100416         IF  %equal(TNOFM01L);
023700100416           WISoff = 'S';
023800100416         ENDIF;
023900100414
024000100414         WIScmm = VIScmm;
024100100413         WISksc = VISksc;
024200100413         WISnrv = VISnrv;
024300100413         WISdvi = VISdvi;
024400100414         WIShmv = VIShmv;
024500100413         WIStpv = VIStpv;
024600100413         WISffz = VISffz;
024700100510         WISntpv= VIStpv;
024800100514         WISdpo = VISdpo;
024900100514         WISdoe = VISdoe;
025000100517         WISrag = VISrag;
025100100517         WIScnw = VIScnw;
025200100414
025300100414       //?Se visita senza potenziale stampo errore e non scrivo il file di work
025400100414         IF  WIScpo = 0;
025500100422           wRiga = 01;
025600100513           exsr Stampa;
025700100414           leavesr;
025800100414         ENDIF;
025900100413
026000100413         write WFVIS000;
026100100513
026200100513       //?Conto il nr. di visite scritte nel file di work
026300100513         TotNrw += 1;
026400100413
026500100413       ENDSR;
026600100414
026700100414       //--------------------------------------------------------------
026800100414       //?Stampa errori.
026900100414       //--------------------------------------------------------------
027000100513       BEGSR Stampa;
027100100414
027200100414         IF  not $Stampa;
027300100414           write CRMT01;
027400100414           $Stampa = *on;
027500100426           DESpgm = 'Creazione file di Work WFVIS00F';
027600100517           fil01 = %dec(Filiali(01):3:0);
027700100517           fil02 = %dec(Filiali(02):3:0);
027800100517           fil03 = %dec(Filiali(03):3:0);
027900100517           fil04 = %dec(Filiali(04):3:0);
028000100517           fil05 = %dec(Filiali(05):3:0);
028100100517           fil06 = %dec(Filiali(06):3:0);
028200100517           fil07 = %dec(Filiali(07):3:0);
028300100517           fil08 = %dec(Filiali(08):3:0);
028400100517           fil09 = %dec(Filiali(09):3:0);
028500100517           fil10 = %dec(Filiali(10):3:0);
028600100426           write CRMT02;
028700100414         ENDIF;
028800100414
028900100422         IF  wRiga = 01;
029000100422           write CRMD01;
029100100422         ENDIF;
029200100422
029300100422         IF  wRiga = 04;
029400100422           write CRMD04;
029500100422         ENDIF;
029600100513
029700100513         IF  wRiga = 00;
029800100513           write CRMTOTV;
029900100513         ENDIF;
030000100414
030100100414       ENDSR;
030200100413
030300100413       //--------------------------------------------------------------
030400100413       //?Operazioni finali.
030500100413       //--------------------------------------------------------------
030600100513       BEGSR RoutEnd;
030700100413
030800100413         *inLR = *on;
030900100413         return;
031000100413
031100100413       ENDSR;
031200100413
031300100413      /end-free
