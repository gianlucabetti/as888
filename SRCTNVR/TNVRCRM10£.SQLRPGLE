000100100413      //---------------------------------------------------------------
000200110208      //?TNVRCRM9 - Elimina Info trattative
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000100413
001100110208      // - File trattative
001200110209     fTIVIS00F  UF   E             DISK    usropn
001300110209     f                                     extfile(wFLib)
001400100413      //---------------------------------------------------------------
001500100413      //?Definizione costanti.
001600100413      //---------------------------------------------------------------
001700100413
001800100413      //---------------------------------------------------------------
001900100413      //?Definizione schiere.
002000100413      //---------------------------------------------------------------
002100110208
002200110208      // - Tipi trattative NO info
002300110208     d $TTR            s              1    dim(10)
002400090715
002500100413      //---------------------------------------------------------------
002600100413      //?Definizione aree dati.
002700100413      //---------------------------------------------------------------
002800100413
002900100413      //---------------------------------------------------------------
003000100413      //?Definizione strutture dati.
003100100413      //---------------------------------------------------------------
003200100415
003300100413      //---------------------------------------------------------------
003400100413      //?Definizione variabili globali.
003500100413      //---------------------------------------------------------------
003600100413
003700100413      // - Flags booleani
003800110204     d $Fine           s               n   inz(*off)
003900110204
004000110204      // - Indici di schiera
004100110204     d xx              s              4  0 inz
004200110208
004300110208      // - Campi di comodo
004400110209     d nRec            s             10  0 inz
004500110208     d wTTR            s                   like(VIStpv)
004600110209
004700110209       // - Nome libreria del file TIVIS
004800110209     d wFLib           s             21    inz
004900110209
005000110209       // - Stringhe SQL da eseguire
005100110209     d wSQL            s           2048    Varying        inz
005200100413
005300100413      //---------------------------------------------------------------
005400100413      //?Definizione procedure esterne.
005500100413      //---------------------------------------------------------------
005600100413
005700100413      //---------------------------------------------------------------
005800110204      //?Prototipi.
005900100413      //---------------------------------------------------------------
006000100413
006100100413      //---------------------------------------------------------------
006200100413      //?Definizione key-list.
006300100413      //---------------------------------------------------------------
006400100413
006500100413      //---------------------------------------------------------------
006600100413      //?Riepilogo indicatori.
006700100413      //---------------------------------------------------------------
006800100413
006900100413      //---------------------------------------------------------------
007000100413      //?M A I N - L I N E
007100100413      //---------------------------------------------------------------
007200100413
007300100413      /free
007400100413
007500100413       //?Operazioni iniziali
007600100513       exsr RoutInz;
007700110204
007800110204       exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
007900110322
008000110322       //?Sql per cambiare tipo trattativa su TIVIS e su SIC
008100110322       exsr Modifica;
008200100413
008300100726       //?Elaboro
008400100726       exsr Elabora;
008500100413
008600100413       //?Operazioni finali
008700100513       exsr RoutEnd;
008800100413
008900100413       //--------------------------------------------------------------
009000100413       //?Operazioni iniziali.
009100100413       //--------------------------------------------------------------
009200100513       BEGSR RoutInz;
009300110208
009400110208         //?carico sk con tipi trattativa che non hanno info
009500110322         //?CHIODATA A PROGRAMMA
009600110208         clear $TTR;
009700110322         $TTR(01) = 'C';
009800110322         $TTR(02) = 'M';
009900110322         $TTR(03) = 'R';
010000110209
010100110209         //?Apro il file delle trattative
010200110322         wFLib = 'FILTRAGRU/TIVIS00F';
010300110209         open  TIVIS00F;
010400100413
010500100413       ENDSR;
010600110322
010700110322       //--------------------------------------------------------------
010800110322       //?Modifica tipo trattativa.
010900110322       //--------------------------------------------------------------
011000110322       BEGSR Modifica;
011100110322
011200110322         //?Cambio tipo trattativa da 'A' a 'I' su TIVIS e sul SIC
011300110322         exec sql
011400110322         UPDATE FILTRAGRU/TIVIS00F
011500110322         SET VIStpv = 'I'
011600110322         WHERE VIStpv = 'A';
011700110322
011800110322         exec sql
011900110322         UPDATE GAITRAAZM/TIVISC0F
012000110322         SET VICtpv = 'I'
012100110322         WHERE VICtpv = 'A';
012200110323
012300110323         exec sql
012400110323         UPDATE GAITRAAZM/TIVISI0F
012500110323         SET VIItpv = 'I'
012600110323         WHERE VIItpv = 'A';
012700110322
012800110322       ENDSR;
012900100413
013000100413       //--------------------------------------------------------------
013100100422       //?Elaboro.
013200100413       //--------------------------------------------------------------
013300100513       BEGSR Elabora;
013400110208
013500110208         xx = 1;
013600110208         FOR xx by 1 to %elem($TTR);
013700110208           $Fine = *off;
013800110208           IF $TTR(xx) <> *blanks;
013900110208             wTTR = $TTR(xx);
014000110209           //?Preparo SQL per leggere file trattative
014100110209             clear wSQL;
014200110209             wSQL = 'select VISnrv, VISinfot, rrn(TIVIS00F) as nRec from ';
014300110322             wSQL += 'FILTRAGRU/TIVIS00F ';
014400110209             wSQL += 'where VIStpv = ' + '''' + wTTR + '''' + ' ';
014500110209             wSQL += 'order by VISnrv';
014600110209
014700110209           //?Preparo il cursore
014800110209             exec sql prepare S1 from :wSQL;
014900110209
015000110209             exec sql declare VIS cursor for S1;
015100110209
015200110209          //?Apro il cursore
015300110209             exec sql open VIS;
015400110209             IF  sqlcode < 0;
015500110209               $Fine = *on;
015600110209             ENDIF;
015700110209
015800110209          //?Leggo le trattative
015900110209             DOW  not $Fine;
016000110208               exec sql FETCH next from VIS into :VISnrv, :VISinfot, :nRec;
016100110208               IF  sqlcod = 100 or sqlcod < 0;
016200110208                 $Fine = *on;
016300110208                 leave;
016400110208               ENDIF;
016500110208
016600110208             //?Cancello le INFO
016700110208               exsr DelInfo;
016800110208
016900110208             //?Pulisco flag di INFO presenti su trattative
017000110208               IF  VISinfot <> *blanks;
017100110208                 exsr AggVis;
017200110208               ENDIF;
017300110208
017400110208             //?Cancello le INFO dal SIC
017500110208               exsr DelSic;
017600110208
017700110208             ENDDO;
017800110208
017900110208             exec sql CLOSE VIS;
018000110208           ENDIF;
018100110208
018200110208         ENDFOR;
018300100413
018400100413       ENDSR;
018500100726
018600100726       //--------------------------------------------------------------
018700110208       //?Cancello le INFO.
018800100726       //--------------------------------------------------------------
018900110208       BEGSR DelInfo;
019000100726
019100110322         exec sql
019200110322         DELETE from FILTRAGRU/TIVII00F
019300110322         WHERE VIInrv = :VISnrv;
019400100726
019500100726       ENDSR;
019600110208
019700110208       //--------------------------------------------------------------
019800110208       //?Pulisco flag di INFO presenti su trattativa.
019900110208       //--------------------------------------------------------------
020000110208       BEGSR AggVis;
020100110208
020200110208         chain nRec TIVIS00F;
020300110208         IF  %found;
020400110208           clear VISinfot;
020500110208           update TIVIS000;
020600110208         ENDIF;
020700110208
020800110208       ENDSR;
020900110208
021000110208       //--------------------------------------------------------------
021100110208       //?Cancello il SIC.
021200110208       //--------------------------------------------------------------
021300110208       BEGSR DelSic;
021400110208
021500110208       //?Cancello SIC storico
021600110322         exec sql
021700110322         DELETE from GAITRAAZM/TIVIIC0F
021800110322         WHERE VICnrv = :VISnrv;
021900110208
022000110208       //?Cancello SIC in corso
022100110322         exec sql
022200110322         DELETE from GAITRAAZM/TIVIII0F
022300110322         WHERE VIInrv = :VISnrv;
022400110208
022500110208       ENDSR;
022600100413
022700100413       //--------------------------------------------------------------
022800100413       //?Operazioni finali.
022900100413       //--------------------------------------------------------------
023000100513       BEGSR RoutEnd;
023100100413
023200100413         *inLR = *on;
023300100413         return;
023400100413
023500100413       ENDSR;
023600100413
023700100413      /end-free
