000100120925      //--------------------------------------------------------------
000200121025      //?TNVRCRM15 - Pulisce NrVis su TICPN se non esite su TIVIS
000300120925      //--------------------------------------------------------------
000400120925
000500120925     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600120925
000700120925      //---------------------------------------------------------------
000800120925      //?Dichiarazione file.
000900120925      //---------------------------------------------------------------
001000121025
001100121025       // -?File Note
001200121025     fTICPN00F  uf   e             disk    prefix(w)
001300121025
001400121025       // -?File Trattative
001500121025     fTIVIS05L  if   e           k disk
001600120925
001700120925      //---------------------------------------------------------------
001800120925      //?Definizione costanti.
001900120925      //---------------------------------------------------------------
002000120925
002100120925      //---------------------------------------------------------------
002200120925      //?Definizione schiere.
002300120925      //---------------------------------------------------------------
002400120925
002500120925      //---------------------------------------------------------------
002600120925      //?Definizione aree dati.
002700120925      //---------------------------------------------------------------
002800120925
002900120925      //---------------------------------------------------------------
003000120925      //?Definizione strutture dati.
003100120925      //---------------------------------------------------------------
003200120928
003300121025       // -?File TICPN00F
003400121025     d TICPNds       e ds                  extname(TICPN00F)
003500120925
003600120925      //---------------------------------------------------------------
003700120925      //?Definizione variabili globali.
003800120925      //---------------------------------------------------------------
003900120925
004000120925       // -?Flags booleani
004100120925     d wEoF            s               n   inz(*off)
004200120928
004300121025       // -?Campi Rnn
004400121025     d CPN_Rrn         s              9  0
004500120925
004600120925      //---------------------------------------------------------------
004700120925      //?Definizione procedure esterne.
004800120925      //---------------------------------------------------------------
004900120925
005000120925      //---------------------------------------------------------------
005100120925      //?Definizione prototipi.
005200120925      //---------------------------------------------------------------
005300120925
005400120925      //---------------------------------------------------------------
005500120925      //?Definizione key-list.
005600120925      //---------------------------------------------------------------
005700120925
005800120925      //---------------------------------------------------------------
005900120925      //?Riepilogo indicatori.
006000120925      //---------------------------------------------------------------
006100120925
006200120925      //---------------------------------------------------------------
006300120925
006400120925      //---------------------------------------------------------------
006500120925      //?M A I N - L I N E
006600120925      //---------------------------------------------------------------
006700120925
006800120925      /free
006900120925
007000120925       //?Operazioni iniziali
007100120925       exsr RoutInz;
007200120925
007300120925       //?Elabora
007400121025       exsr Pul_cpnVIS;
007500120925
007600120925       //?Operazioni finali
007700120925       exsr RoutEnd;
007800120925
007900120925       //--------------------------------------------------------------
008000120925       //?Operazioni iniziali.
008100120925       //--------------------------------------------------------------
008200120925       BEGSR RoutInz;
008300120925
008400120925         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
008500120925
008600120925       ENDSR;
008700120928
008800120928       //--------------------------------------------------------------
008900121025       //?Sistemo note.
009000120928       //--------------------------------------------------------------
009100121025       BEGSR Pul_cpnVIS;
009200120928
009300120928         wEoF = *off;
009400120927
009500121025       //?Leggo le note con nr. trattativa
009600120928         exec sql
009700121025          DECLARE CPN_vis cursor for
009800121025          SELECT rrn(TICPN00F), TICPN00F.* from TICPN00F
009900121025          WHERE CPNnrv > 0;
010000120928
010100120928         exec sql
010200121025           open CPN_vis;
010300120928
010400120928         IF sqlcode < 0;
010500120928           wEoF = *on;
010600120928           leavesr;
010700120928         ENDIF;
010800120928
010900120928         DOW  not wEoF;
011000120928
011100121025           exec sql fetch next from CPN_vis into :CPN_rrn, :TICPNds;
011200120928           IF  sqlcod = 100 or sqlcod < 0;
011300120928             wEoF = *on;
011400120928             leave;
011500120928           ENDIF;
011600120928
011700121025         //?Se la visita non esiste più devo pulire il campo CPNnrv
011800121025           chain (CPNnrv) TIVIS05L;
011900121025           IF  not %found(TIVIS05L);
012000121025             chain CPN_rrn TICPN00F;
012100121025             IF  %found(TICPN00F);
012200121025               clear wCPNnrv;
012300121025               UPDATE  TICPN000;
012400121025             ENDIF;
012500121025           ENDIF;
012600120928
012700120928         ENDDO;
012800120928
012900121025         exec sql close CPN_vis;
013000120928         wEoF = *off;
013100120928
013200120928       ENDSR;
013300120925
013400120925       //--------------------------------------------------------------
013500120925       //?Operazioni finali.
013600120925       //--------------------------------------------------------------
013700120925       BEGSR RoutEnd;
013800120925
013900120925         *inLR = *on;
014000120925         return;
014100120925
014200120925       ENDSR;
014300120925
014400120925      /end-free
