000100120925      //--------------------------------------------------------------
000200121015      //?TRMKS00R - Storicizzo gli stati A2.
000300120925      //--------------------------------------------------------------
000400120925
000500120925     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600120925
000700120925      //---------------------------------------------------------------
000800120925      //?Dichiarazione file.
000900120925      //---------------------------------------------------------------
001000121001
001100120928       // -?File Storico
001200120928     fTICRM00F  o    e             disk
001300120925
001400120925      //---------------------------------------------------------------
001500120925      //?Definizione costanti.
001600120925      //---------------------------------------------------------------
001700120925
001800120925      //---------------------------------------------------------------
001900120925      //?Definizione schiere.
002000120925      //---------------------------------------------------------------
002100120925
002200120925      //---------------------------------------------------------------
002300120925      //?Definizione aree dati.
002400120925      //---------------------------------------------------------------
002500120925
002600120925      //---------------------------------------------------------------
002700120925      //?Definizione strutture dati.
002800120925      //---------------------------------------------------------------
002900121015
003000121015       // -?KPJBA
003100121015     d kpjba         e ds
003200121015     d  DataEla              247    254s 0
003300120928
003400121001       // -?File TICPS00F
003500121001     d TICPSds       e ds                  extname(TICPS00F)
003600120925
003700120925      //---------------------------------------------------------------
003800120925      //?Definizione variabili globali.
003900120925      //---------------------------------------------------------------
004000120925
004100120925       // -?Flags booleani
004200120925     d wEoF            s               n   inz(*off)
004300120928
004400120925       // -?Campi di comodo data
004500121008     d DataPul         s              8s 0
004600121015       // DataEla         s              8s 0 inz(20130101)
004700120928     d DataISO         s               d   datfmt(*iso)
004800120925
004900120925      //---------------------------------------------------------------
005000120925      //?Definizione procedure esterne.
005100120925      //---------------------------------------------------------------
005200120925
005300120925      //---------------------------------------------------------------
005400120925      //?Definizione prototipi.
005500120925      //---------------------------------------------------------------
005600120925
005700120925      //---------------------------------------------------------------
005800120925      //?Definizione key-list.
005900120925      //---------------------------------------------------------------
006000120925
006100120925      //---------------------------------------------------------------
006200120925      //?Riepilogo indicatori.
006300120925      //---------------------------------------------------------------
006400120925
006500120925      //---------------------------------------------------------------
006600120925
006700120925      //---------------------------------------------------------------
006800120925      //?M A I N - L I N E
006900120925      //---------------------------------------------------------------
007000121015
007100121015     c     *entry        plist
007200121015     c                   parm                    KPJBA
007300120925
007400120925      /free
007500120925
007600120925       //?Operazioni iniziali
007700120925       exsr RoutInz;
007800120925
007900120925       //?Elabora
008000121001       exsr Sto_CPS;
008100120925
008200120925       //?Operazioni finali
008300120925       exsr RoutEnd;
008400120925
008500120925       //--------------------------------------------------------------
008600120925       //?Operazioni iniziali.
008700120925       //--------------------------------------------------------------
008800120925       BEGSR RoutInz;
008900120925
009000120925         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
009100120927
009200120928       //?Calcolo la data pulizia
009300120928         DataISO = %date(DataEla:*ISO);
009400120928         DataISO = DataISO - %years(2);
009500120928         DataPul = %dec(DataISO);
009600120925
009700120925       ENDSR;
009800120928
009900120928       //--------------------------------------------------------------
010000121001       //?Storicizzo gli stati A2.
010100120928       //--------------------------------------------------------------
010200121001       BEGSR Sto_CPS;
010300120928
010400120928         wEoF = *off;
010500120927
010600121001       //?Leggo SOLO gli stati A2 li storicizzo
010700120928         exec sql
010800121001          DECLARE CPSA2 cursor for
010900121001          SELECT * from TICPS00F
011000121001          WHERE CPSfst = 'A2';
011100120928
011200120928         exec sql
011300121001           open CPSA2;
011400120928
011500120928         IF sqlcode < 0;
011600120928           wEoF = *on;
011700120928           leavesr;
011800120928         ENDIF;
011900120928
012000120928         DOW  not wEoF;
012100120928
012200121001           exec sql fetch next from CPSA2 into :TICPSds;
012300120928           IF  sqlcod = 100 or sqlcod < 0;
012400120928             wEoF = *on;
012500120928             leave;
012600120928           ENDIF;
012700120928
012800121001         //?Storicizzo lo stato
012900121001           clear TICRM000;
013000121001           CRMtrc = 'S';
013100121001           CRMcpo = CPScpo;
013200121001           CRMdai = CPSdim;
013300121001           CRMdaf = CPSdst;
013400121001           CRMmmd = CPScmd;
013500121012           CRMdca = 'VISITATO';
013600121001           WRITE  TICRM000;
013700120928
013800120928         ENDDO;
013900120928
014000121001         exec sql close CPSA2;
014100120928         wEoF = *off;
014200120928
014300120928       ENDSR;
014400120925
014500120925       //--------------------------------------------------------------
014600120925       //?Operazioni finali.
014700120925       //--------------------------------------------------------------
014800120925       BEGSR RoutEnd;
014900120925
015000120925         *inLR = *on;
015100120925         return;
015200120925
015300120925       ENDSR;
015400120925
015500120925      /end-free
