000100100413      //---------------------------------------------------------------
000200100414      //?TNVRCRM1 - Crea file di appoggio
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000100413     fCNACO00F  if   e           k disk
001100100416     fCNACO16L  if   e           k disk    rename(cnaco000:cnaco16)
001200100413     fTFACO00F  if   e           k disk    rename(cnaco000:tfaco000)
001300100416     fTNCPO01L  if   e           k disk
001400100416     fTNOFM01L  if   e           k disk
001500100414     fTNVIS02L  uf   e           k disk
001600100413     fWFVIS00F  o    e             disk
001700100414     fTNVRCRMP  o    e             printer oflind(*in99)
001800100413
001900100413      //---------------------------------------------------------------
002000100413      //?Definizione costanti.
002100100413      //---------------------------------------------------------------
002200100413
002300100413      //---------------------------------------------------------------
002400100413      //?Definizione schiere.
002500100413      //---------------------------------------------------------------
002600090715
002700100413      //---------------------------------------------------------------
002800100413      //?Definizione aree dati.
002900100413      //---------------------------------------------------------------
003000100413
003100100413      //---------------------------------------------------------------
003200100413      //?Definizione strutture dati.
003300100413      //---------------------------------------------------------------
003400100423
003500100423     d KPJBA         e ds
003600100413
003700100413      // - Reperimento filiali
003800100413     d TRUL31DS      e ds
003900100413     d pog                    10    759  0 dim(250)
004000100413
004100100413      //---------------------------------------------------------------
004200100413      //?Definizione variabili globali.
004300100413      //---------------------------------------------------------------
004400100413
004500100413      // - Flags booleani
004600100413     d $End            s               n   inz(*off)
004700100413     d $Fine           s               n   inz(*off)
004800100414     d $Stampa         s               n   inz(*off)
004900100413
005000100413      // - Indici di schiera
005100100413     d xx              s              3  0 inz
005200100413
005300100413      // - Parametro ricevuto
005400100413     d filiale         s              3
005500100413
005600100413      // - Campi di comodo
005700100413     d k_VIScmmda      s                   like(VIScmm)
005800100413     d k_VIScmmal      s                   like(VIScmm)
005900100422     d wRiga           s              2  0
006000100413
006100100413      //---------------------------------------------------------------
006200100413      //?Definizione procedure esterne.
006300100413      //---------------------------------------------------------------
006400100413
006500100413      //---------------------------------------------------------------
006600100413      //?prototipi
006700100413      //---------------------------------------------------------------
006800100414
006900100413      /copy gaitrasrc/srcprotopr,trul31r
007000100413
007100100413      //---------------------------------------------------------------
007200100413      //?Definizione key-list.
007300100413      //---------------------------------------------------------------
007400100413
007500100413      //---------------------------------------------------------------
007600100413      //?Riepilogo indicatori.
007700100413      //---------------------------------------------------------------
007800100414
007900100414      // 99    : Salto pagina
008000100413
008100100413      //---------------------------------------------------------------
008200100413      //?M A I N - L I N E
008300100413      //---------------------------------------------------------------
008400100413
008500100413     c     *Entry        plist
008600100413     c                   parm                    filiale
008700100413
008800100413      /free
008900100413
009000100413       //?Operazioni iniziali
009100100413       exsr sr_RoutInz;
009200100413
009300100413       //?Scrivo le trattative da trascodificare sul file di work
009400100413       IF  not $Fine;
009500100414       //?Se ho ricevuto la filiale devo elaborare solo quella
009600100414         IF  filiale <> *blanks;
009700100414           exsr Elab_x_Fil;
009800100414       //?Se non ho ricevuto la filiale devo elaborare tutte le visite
009900100414         ELSE;
010000100414           exsr Elab_All;
010100100414         ENDIF;
010200100413       ENDIF;
010300100413
010400100413       //?Operazioni finali
010500100413       exsr sr_RoutEnd;
010600100413
010700100413       //--------------------------------------------------------------
010800100413       //?Operazioni iniziali.
010900100413       //--------------------------------------------------------------
011000100413       BEGSR sr_RoutInz;
011100100413
011200100413       //?Recupero filiali del 'RA' della filiale ricevuta
011300100414         IF  filiale <> *blanks;
011400100414           clear TRUL31DS;
011500100414           I31abi = 'RA';
011600100414           I31cpo = %dec(filiale:3:0);
011700100414           callp trul31r (kpjba : trul31ds);
011800100414           IF  O31pog <= *zeros;
011900100414             $Fine = *on;
012000100414           ENDIF;
012100100414         ENDIF;
012200100413
012300100413       ENDSR;
012400100413
012500100413       //--------------------------------------------------------------
012600100413       //?Elaboro per filiale.
012700100413       //--------------------------------------------------------------
012800100414       BEGSR Elab_x_Fil;
012900100413
013000100413         xx = 1;
013100100413         FOR xx by 1 to %elem(pog);
013200100413           IF  pog(xx) > 0;
013300100414             k_VIScmmda = pog(xx) * 10000;
013400100414             k_VIScmmal = k_VIScmmda + 9999;
013500100414         //?Leggo file visite
013600100413             exsr Leggi_Vis;
013700100413           ENDIF;
013800100413         ENDFOR;
013900100413
014000100413       ENDSR;
014100100414
014200100414       //--------------------------------------------------------------
014300100414       //?Elaboro tutte le visite.
014400100414       //--------------------------------------------------------------
014500100414       BEGSR Elab_All;
014600100414
014700100414         k_VIScmmda = 0;
014800100414         k_VIScmmal = 9999999;
014900100414       //?Leggo file visite
015000100414         exsr Leggi_Vis;
015100100414
015200100414       ENDSR;
015300100413
015400100413       //--------------------------------------------------------------
015500100413       //?Leggo il file visite.
015600100413       //--------------------------------------------------------------
015700100413       BEGSR Leggi_Vis;
015800100413
015900100413         setll k_VIScmmda TNVIS02L;
016000100413         read  TNVIS02L;
016100100413         DOW  not %eof(TNVIS02L);
016200100413
016300100413         //?Commerciale non della filiale che sto elaborando esco
016400100413           IF  VIScmm > k_VIScmmal;
016500100413             leave;
016600100413           ENDIF;
016700100414         //?Scarto le visite chiuse e le visite già elaborate
016800100414           IF  VISfsv <> 'C' and VISdat = 0;
016900100413           //?Scrivo file di work
017000100413             exsr Scrivi_Vis;
017100100414           //?Imposto data trascodifica in VISdat
017200100414             VISdat = %dec(%date());
017300100414             update TNVIS000;
017400100413           ENDIF;
017500100413
017600100413           read TNVIS02L;
017700100413         ENDDO;
017800100413
017900100413       ENDSR;
018000100413
018100100413       //--------------------------------------------------------------
018200100413       //?Scrivo il file di work.
018300100413       //--------------------------------------------------------------
018400100413       BEGSR Scrivi_Vis;
018500100413
018600100413         clear WFVIS000;
018700100416
018800100413       //?Recupero il potenziale
018900100413         ACOkut = 1;
019000100413         ACOkcc = 151;
019100100414         chain (ACOkut:ACOKcc:VISNRV) TFACO00F;
019200100414         IF  %Found(TFACO00F);
019300100414           WIScpo = ACOlib;
019400100414         ENDIF;
019500100414         IF  VISksc > 0 and not %Found(TFACO00F);
019600100414           chain (ACOkut:ACOKcc:VISksc) CNACO00F;
019700100414           IF  %Found(CNACO00F);
019800100414             WIScpo = ACOlib;
019900100414           ENDIF;
020000100413         ENDIF;
020100100416
020200100416       //?Recupero commerciale e filiale potenziale
020300100416         IF  WIScpo > 0;
020400100416           chain WIScpo TNCPO01L;
020500100416           IF  %Found(TNCPO01L);
020600100416             WIScmmp = CPOcmm;
020700100416             WISfil  = CPOflt;
020800100416           ENDIF;
020900100422         //?Non trovo anagrafica potenziale stampo errore e non scrivo il file di work
021000100422           IF  not %Found(TNCPO01L);
021100100422           STPcpo = WIScpo;
021200100422           wRiga = 04;
021300100426           STPdes = 'Visita ' + %editc(VISnrv:'Z') + ' non scritta.';
021400100422           exsr sr_Stampa;
021500100422           leavesr;
021600100422           ENDIF;
021700100416
021800100416       //?Imposto se mai codificato
021900100416           chain WIScpo CNACO16L;
022000100416           IF  not %Found(CNACO16L);
022100100416             WIScod = 'S';
022200100416           ENDIF;
022300100416         ENDIF;
022400100416
022500100416       //?Imposto se ha offerte
022600100416         setll VISnrv TNOFM01L;
022700100416         IF  %equal(TNOFM01L);
022800100416           WISoff = 'S';
022900100416         ENDIF;
023000100414
023100100414         WIScmm = VIScmm;
023200100413         WISksc = VISksc;
023300100413         WISnrv = VISnrv;
023400100413         WISdvi = VISdvi;
023500100414         WIShmv = VIShmv;
023600100413         WIStpv = VIStpv;
023700100413         WISffz = VISffz;
023800100414
023900100414       //?Se visita senza potenziale stampo errore e non scrivo il file di work
024000100414         IF  WIScpo = 0;
024100100422           wRiga = 01;
024200100414           exsr sr_Stampa;
024300100414           leavesr;
024400100414         ENDIF;
024500100413
024600100413         write WFVIS000;
024700100413
024800100413       ENDSR;
024900100414
025000100414       //--------------------------------------------------------------
025100100414       //?Stampa errori.
025200100414       //--------------------------------------------------------------
025300100414       BEGSR sr_Stampa;
025400100414
025500100414         IF  not $Stampa;
025600100414           write CRMT01;
025700100414           $Stampa = *on;
025800100426           DESpgm = 'Creazione file di Work WFVIS00F';
025900100426           write CRMT02;
026000100414         ENDIF;
026100100414
026200100422         IF  wRiga = 01;
026300100422           write CRMD01;
026400100422         ENDIF;
026500100422
026600100422         IF  wRiga = 04;
026700100422           write CRMD04;
026800100422         ENDIF;
026900100414
027000100414       ENDSR;
027100100413
027200100413       //--------------------------------------------------------------
027300100413       //?Operazioni finali.
027400100413       //--------------------------------------------------------------
027500100413       BEGSR sr_RoutEnd;
027600100413
027700100413         *inLR = *on;
027800100413         return;
027900100413
028000100413       ENDSR;
028100100413
028200100413      /end-free
