000100100413      //---------------------------------------------------------------
000200100422      //?TNVRCRM5 - Note clienti INTERNE
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000100422     fTICPN00F  o    e             disk
001100100414     fTNVRCRMP  o    e             printer oflind(*in99)
001200100413
001300100413      //---------------------------------------------------------------
001400100413      //?Definizione costanti.
001500100413      //---------------------------------------------------------------
001600100413
001700100413      //---------------------------------------------------------------
001800100413      //?Definizione schiere.
001900100413      //---------------------------------------------------------------
002000100514
002100100514     d filiali         s              3a   dim(10)
002200100514     d $Pog            s              3  0 dim(2500)
002300090715
002400100413      //---------------------------------------------------------------
002500100413      //?Definizione aree dati.
002600100413      //---------------------------------------------------------------
002700100413
002800100413      //---------------------------------------------------------------
002900100413      //?Definizione strutture dati.
003000100413      //---------------------------------------------------------------
003100100422
003200100422       // - Reperimento dati anagrafici
003300100422     d TIBS69ds      e ds
003400100422     d DS_cnaco      e ds                  inz extname(CNACO00F)
003500100422     d DS_cnind      e ds                  inz extname(CNIND00F)
003600100422     d DS_cnclp      e ds                  inz extname(CNCLP00F)
003700100422     d DS_fncls      e ds                  inz extname(FNCLS00F)
003800100413
003900100413      // - Reperimento filiali
004000100413     d TRUL31DS      e ds
004100100413     d pog                    10    759  0 dim(250)
004200100422
004300100422      // Note
004400100422     d TFNTCds       e ds                  extname(TFNTC00F)
004500100413
004600100413      //---------------------------------------------------------------
004700100413      //?Definizione variabili globali.
004800100413      //---------------------------------------------------------------
004900100413
005000100413      // - Flags booleani
005100100413     d $End            s               n   inz(*off)
005200100413     d $Fine           s               n   inz(*off)
005300100414     d $Stampa         s               n   inz(*off)
005400100413
005500100413      // - Indici di schiera
005600100514     d xx              s              4  0 inz
005700100514     d yy              s              4  0 inz
005800100514     d zz              s              4  0 inz
005900100422
006000100422       // - Stringa SQL da eseguire
006100100422     d wSQL            s           2048    Varying        inz
006200100413
006300100413      // - Campi di comodo
006400100422     d old_NTCnk1      s                   like(NTCnk1)
006500100422     d old_NTCntr      s                   like(NTCntr)
006600100422     d sav_CPNpno      s                   like(CPNpno)
006700100422     d wData           s              8  0
006800100422     d wRiga           s              2  0
006900100413
007000100413      //---------------------------------------------------------------
007100100413      //?Definizione procedure esterne.
007200100413      //---------------------------------------------------------------
007300100414
007400100413     d KPJBA         e ds
007500100413
007600100413      //---------------------------------------------------------------
007700100413      //?prototipi
007800100413      //---------------------------------------------------------------
007900100414
008000100422      /copy gaitrasrc/srcprotopr,tibs69r
008100100413      /copy gaitrasrc/srcprotopr,trul31r
008200100413
008300100413      //---------------------------------------------------------------
008400100413      //?Definizione key-list.
008500100413      //---------------------------------------------------------------
008600100413
008700100413      //---------------------------------------------------------------
008800100413      //?Riepilogo indicatori.
008900100413      //---------------------------------------------------------------
009000100414
009100100414      // 99    : Salto pagina
009200100413
009300100413      //---------------------------------------------------------------
009400100413      //?M A I N - L I N E
009500100413      //---------------------------------------------------------------
009600100413
009700100413     c     *Entry        plist
009800100514     c                   parm                    filiali
009900100413
010000100413      /free
010100100413
010200100413       //?Operazioni iniziali
010300100514       exsr RoutInz;
010400100422
010500100422       //?Imposto la stringa per SQL
010600100514       exsr PrepSQL;
010700100413
010800100422       //?Scrivo le note INTERNE
010900100413       IF  not $Fine;
011000100422         exsr Elabora;
011100100413       ENDIF;
011200100413
011300100413       //?Operazioni finali
011400100514       exsr RoutEnd;
011500100413
011600100413       //--------------------------------------------------------------
011700100413       //?Operazioni iniziali.
011800100413       //--------------------------------------------------------------
011900100514       BEGSR RoutInz;
012000100514
012100100514         yy = 1;
012200100514
012300100514       //?Ciclo per filiali passate
012400100514         FOR  yy BY 1 to 10;
012500100514
012600100514           IF  filiali(yy) <> *zeros and filiali(yy) <> *blanks;
012700100413
012800100413       //?Recupero filiali del 'RA' della filiale ricevuta
012900100514             clear TRUL31DS;
013000100514             I31abi = 'RA';
013100100514             I31cpo = %dec(filiali(yy):3:0);
013200100514             callp trul31r (kpjba : trul31ds);
013300100514             IF  O31pog <= *zeros;
013400100514               $Fine = *on;
013500100514               leavesr;
013600100514             ENDIF;
013700100422
013800100514         //?Memorizzo le filiali appena caricate in un'unica schiera
013900100514             zz = %lookup(*zeros:$Pog);
014000100514             %subarr($Pog:zz:250) = pog;
014100100514
014200100514           ENDIF;
014300100514
014400100514         ENDFOR;
014500100413
014600100413       ENDSR;
014700100422
014800100422       //--------------------------------------------------------------
014900100422       //?Preparazione stringa SQL.
015000100422       //--------------------------------------------------------------
015100100514       BEGSR PrepSQL;
015200100422
015300100422         wSQL  = 'select * from TFNTC00F where NTCapl = ';
015400100422         wSQL += '''' + 'C' + '''';
015500100514         wSQL += ' and  substr(NTCnk1, 5, 3) in(';
015600100422
015700100514         yy = 0;
015800100514         xx = 1;
015900100514         FOR xx by 1 to %elem($Pog);
016000100514           IF $Pog(xx) <> *zeros;
016100100514             IF yy > 0;
016200100514               wSQL += ', ';
016300100514             ELSE;
016400100514               yy = 1;
016500100514             ENDIF;
016600100514             wSQL += %editc($Pog(xx):'X');
016700100514           ENDIF;
016800100514         ENDFOR;
016900100422
017000100422         wSQL += ') and NTCtnt = ';
017100100422         wSQL += '''' + 'IN' + '''';
017200100422
017300100422         wSQL += ' order by NTCnk1 +
017400100422                   for fetch only';
017500100422
017600100422       ENDSR;
017700100413
017800100413       //--------------------------------------------------------------
017900100422       //?Elaboro.
018000100413       //--------------------------------------------------------------
018100100422       BEGSR Elabora;
018200100414
018300100422         $End = *off;
018400100422
018500100422       //?Preparazione del cursore
018600100422         exec sql PREPARE S1   from :wSQL;
018700100422       //?Dichiarazione del cursore
018800100422         exec sql DECLARE NTC  cursor for S1;
018900100422
019000100422       //?Apertura del cursore
019100100422         exec sql open NTC;
019200100422
019300100422         IF sqlcode < 0;
019400100422           $End = *on;
019500100422         ENDIF;
019600100422
019700100422         DOW not $End;
019800100422
019900100422           exec sql FETCH next from NTC into :TFNTCds;
020000100422
020100100422           IF sqlcod = 100 or sqlcod < 0;
020200100422             $End = *on;
020300100422             leave;
020400100422           ENDIF;
020500100422
020600100422           //?scrivo le note dei clienti
020700100422           exsr Scrivi_Note;
020800100422
020900100422         ENDDO;
021000100422
021100100422         exec sql CLOSE NTC;
021200100414
021300100414       ENDSR;
021400100422
021500100422       //--------------------------------------------------------------
021600100422       //?Scrivo file note.
021700100422       //--------------------------------------------------------------
021800100422       BEGSR Scrivi_Note;
021900100422
022000100422       //?se cliente o giorno memorizzazione diversi azzero progressivo nuove note
022100100422         IF NTCnk1 <> old_NTCnk1 or NTCntr <> old_NTCntr;
022200100422           clear sav_CPNpno;
022300100422           old_NTCnk1 = NTCnk1;
022400100422           old_NTCntr = NTCntr;
022500100422         ENDIF;
022600100422       //?scrivo solo se data > 0
022700100422         IF  NTCntr > 0;
022800100422           exsr Scrivi_TICPN;
022900100422         ENDIF;
023000100422
023100100422       ENDSR;
023200100422
023300100422       //--------------------------------------------------------------
023400100422       //?Scrivo file TICPN.
023500100422       //--------------------------------------------------------------
023600100422       BEGSR Scrivi_TICPN;
023700100422
023800100422       //?Cerco i dati del cliente
023900100422         clear TIBS69DS;
024000100422         I69kac = %dec(%subst(NTCnk1:5:7):7:0);
024100100422         tibs69r (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
024200100422         IF  O69err <> *blanks;
024300100422           wRiga = 08;
024400100514           exsr Stampa;
024500100422           leavesr;
024600100422         ENDIF;
024700100517         IF  ACOlib = *zeros;
024800100517           IF  ACOabl = *blanks;
024900100517             wRiga = 09;
025000100517             exsr Stampa;
025100100517           ENDIF;
025200100422           leavesr;
025300100422         ENDIF;
025400100422
025500100422         clear TICPN000;
025600100422         CPNcpo = ACOlib;
025700100422         CPNksc = ACOksc;
025800100422       //?Costruisco la data lunga 8 da data lunga 6
025900100422         IF  NTCntr  < 000101;
026000100422           wData = NTCntr + 19000000;
026100100422         ELSE;
026200100422           wData = NTCntr + 20000000;
026300100422         ENDIF;
026400100422         CPNdim = wData;
026500100422         CPNhim = 235900;
026600100422         CPNsns = 'S';
026700100422         CPNnot = NTCrnt;
026800100422         CPNpno = sav_CPNpno + 1;
026900100514         CPNpos = 046;
027000100514         CPNpru = 'BATCH';
027100100422         write TICPN000;
027200100422         sav_CPNpno = CPNpno;
027300100422
027400100422       ENDSR;
027500100422
027600100414       //--------------------------------------------------------------
027700100414       //?Stampa errori.
027800100414       //--------------------------------------------------------------
027900100514       BEGSR Stampa;
028000100414
028100100414         IF  not $Stampa;
028200100414           write CRMT01;
028300100414           $Stampa = *on;
028400100426           DESpgm = 'Trascodifica note interne clienti';
028500100517           fil01 = %dec(Filiali(01):3:0);
028600100517           fil02 = %dec(Filiali(02):3:0);
028700100517           fil03 = %dec(Filiali(03):3:0);
028800100517           fil04 = %dec(Filiali(04):3:0);
028900100517           fil05 = %dec(Filiali(05):3:0);
029000100517           fil06 = %dec(Filiali(06):3:0);
029100100517           fil07 = %dec(Filiali(07):3:0);
029200100517           fil08 = %dec(Filiali(08):3:0);
029300100517           fil09 = %dec(Filiali(09):3:0);
029400100517           fil10 = %dec(Filiali(10):3:0);
029500100426           write CRMT02;
029600100414         ENDIF;
029700100414
029800100422         IF  wRiga = 08;
029900100422           write CRMD08;
030000100422         ENDIF;
030100100422
030200100422         IF  wRiga = 09;
030300100422           write CRMD09;
030400100422         ENDIF;
030500100414
030600100414       ENDSR;
030700100413
030800100413       //--------------------------------------------------------------
030900100413       //?Operazioni finali.
031000100413       //--------------------------------------------------------------
031100100514       BEGSR RoutEnd;
031200100413
031300100413         *inLR = *on;
031400100413         return;
031500100413
031600100413       ENDSR;
031700100413
031800100413      /end-free
