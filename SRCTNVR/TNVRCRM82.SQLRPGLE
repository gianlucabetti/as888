000100100413      //---------------------------------------------------------------
000200110421      //?TNVRCRM82 - Genero attività 60
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000110204      // - File di controllo
001100110421     fwfcad60   o    e             disk    rename(wfcad60:wfcad6000)
001200110204     f                                     prefix(w_)
001300100413
001400100413      //---------------------------------------------------------------
001500100413      //?Definizione costanti.
001600100413      //---------------------------------------------------------------
001700100413
001800100413      //---------------------------------------------------------------
001900100413      //?Definizione schiere.
002000100413      //---------------------------------------------------------------
002100090715
002200100413      //---------------------------------------------------------------
002300100413      //?Definizione aree dati.
002400100413      //---------------------------------------------------------------
002500100413
002600100413      //---------------------------------------------------------------
002700100413      //?Definizione strutture dati.
002800100413      //---------------------------------------------------------------
002900110204
003000110204     d KPJBA         e ds
003100100726
003200100726      // File potenziali
003300110204     d TNCPO00F      e ds                  extname(TNCPO00F)
003400110204
003500110204      // - Controllo se potenziale codificato
003600110204     d TRMK05ds      e ds                  inz
003700100415
003800100413      //---------------------------------------------------------------
003900100413      //?Definizione variabili globali.
004000100413      //---------------------------------------------------------------
004100100413
004200100413      // - Flags booleani
004300100413     d $End            s               n   inz(*off)
004400110204     d $Fine           s               n   inz(*off)
004500100413
004600100413      // - Campi di comodo
004700110407     d NrAtt           s              5i 0
004800110422     d NrCps           s              5i 0
004900110407     d NrVis           s              5i 0
005000100413
005100100413      //---------------------------------------------------------------
005200100413      //?Definizione procedure esterne.
005300100413      //---------------------------------------------------------------
005400110204
005500110204      // - Controllo categoria potenziale
005600110204     d Trmk05R         pr                  extpgm('TRMK05R')
005700110204     d  KPJBA                              likeds(KPJBA)
005800110204     d  TRMK05ds                           likeds(TRMK05ds)
005900100413
006000100413      //---------------------------------------------------------------
006100110204      //?Prototipi.
006200100413      //---------------------------------------------------------------
006300100413
006400100413      //---------------------------------------------------------------
006500100413      //?Definizione key-list.
006600100413      //---------------------------------------------------------------
006700100413
006800100413      //---------------------------------------------------------------
006900100413      //?Riepilogo indicatori.
007000100413      //---------------------------------------------------------------
007100100413
007200100413      //---------------------------------------------------------------
007300100413      //?M A I N - L I N E
007400100413      //---------------------------------------------------------------
007500100413
007600100413     c     *Entry        plist
007700110204     c                   parm                    kpjba
007800100413
007900100413      /free
008000100413
008100100413       //?Operazioni iniziali
008200100513       exsr RoutInz;
008300110204
008400110204       exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
008500100413
008600100726       //?Elaboro
008700100726       exsr Elabora;
008800100413
008900100413       //?Operazioni finali
009000100513       exsr RoutEnd;
009100100413
009200100413       //--------------------------------------------------------------
009300100413       //?Operazioni iniziali.
009400100413       //--------------------------------------------------------------
009500100513       BEGSR RoutInz;
009600110407
009700100413
009800100413       ENDSR;
009900100413
010000100413       //--------------------------------------------------------------
010100100422       //?Elaboro.
010200100413       //--------------------------------------------------------------
010300100513       BEGSR Elabora;
010400100413
010500110204         $Fine = *off;
010600100413
010700110204       //?Leggo i potenziali
010800100413         exec sql
010900100726         DECLARE CPO cursor for
011000110204         SELECT  CPOcpo, CPOrag, CPOcmm, CPOftr
011100110204         FROM TNCPO00F
011200100726         ORDER by CPOcpo;
011300100413
011400100726         exec sql OPEN CPO;
011500100413
011600110204         DOW  not $Fine;
011700110204           exec sql FETCH next from CPO into :CPOCPO, :CPORAG,
011800110204                                             :CPOCMM, :CPOFTR;
011900100413           IF  sqlcod = 100 or sqlcod < 0;
012000110204             $Fine = *on;
012100100413             leave;
012200100413           ENDIF;
012300100422
012400110204         //?Controllo la categoria del potenziale
012500110204           exsr Categoria;
012600110204
012700110421           //?Per potenziale Mai codificato controllo se devo fare l'attività
012800110421           IF  OMK05cat = 'M';
012900110407             exsr Controlla;
013000110204           ENDIF;
013100100726
013200100413         ENDDO;
013300100413
013400100726         exec sql CLOSE CPO;
013500100413
013600100413       ENDSR;
013700100726
013800100726       //--------------------------------------------------------------
013900110204       //?Controllo la categoria del potenziale.
014000100726       //--------------------------------------------------------------
014100110204       BEGSR Categoria;
014200100726
014300110204         clear TRMK05DS;
014400110204         IMK05cpo = CPOcpo;
014500110204         trmk05r (kpjba: TRMK05DS);
014600110204         IF  OMK05err <> *blanks;
014700110204           clear OMK05cat;
014800110204         ENDIF;
014900100726
015000100726       ENDSR;
015100100413
015200100413       //--------------------------------------------------------------
015300110407       //?Controllo se l'attività è da scrivere.
015400100413       //--------------------------------------------------------------
015500110407       BEGSR Controlla;
015600110207
015700110407         //?Controllo se potenziale ha azioni o trattative aperte
015800110407           exsr CtrAtt;
015900110422
016000110422         //?Controllo se potenziale ha stati
016100110422           exsr CtrCps;
016200110407
016300110426         //?Scrivo nuova attività solo se NON trovo attività da eseguire o trattative aperte
016400110422         //?e il potenziale ha almeno 1 stato
016500110422           IF  NrAtt = 0 and NrVis = 0 and NrCps > 0;
016600110407
016700110421           //?Genero nuova attività 60
016800110407             IF  CPOcmm > 0;
016900110407               exsr Scrivi;
017000110407             ENDIF;
017100110407           ENDIF;
017200110204
017300110204       ENDSR;
017400110407
017500110407       //--------------------------------------------------------------
017600110407       //?Controllo attività/trattative.
017700110407       //--------------------------------------------------------------
017800110407       BEGSR CtrAtt;
017900110407
018000110407         clear NrAtt;
018100110407         clear NrVis;
018200110407
018300110426       //?Controllo se ci sono attività da eseguire
018400110407         exec sql
018500110407         select count(*) into :NrAtt from tiatc00f
018600110407         where atccpo = :CPOcpo and atcdco = 0;
018700110407
018800110407       //?Se ho trovato attività esco
018900110407         IF  NrAtt > 0;
019000110407           leavesr;
019100110407         ENDIF;
019200110407
019300110407       //?Se non ho trovato attività controllo se il potenziale ha trattative aperte
019400110407         exec sql
019500110407         select count(*) into :NrVis from tivis00f
019600110407         where viscpo = :CPOcpo and visdch = 0 and visffz = ' ';
019700110407
019800110407       ENDSR;
019900110422
020000110422       //--------------------------------------------------------------
020100110422       //?Controllo stati.
020200110422       //--------------------------------------------------------------
020300110422       BEGSR CtrCps;
020400110422
020500110422         clear NrCps;
020600110422
020700110422         exec sql
020800110422         select count(*) into :NrCps from ticps00f
020900110422         where cpscpo = :CPOcpo;
021000110422
021100110422       ENDSR;
021200100415
021300100415       //--------------------------------------------------------------
021400110204       //?Scrivo il file.
021500100415       //--------------------------------------------------------------
021600110204       BEGSR Scrivi;
021700100415
021800110421         clear wfcad6000;
021900110204         w_cpocpo = cpocpo;
022000110204         w_cporag = cporag;
022100110204         w_cpocmm = cpocmm;
022200110204         w_cpoftr = cpoftr;
022300110207
022400110421         write wfcad6000;
022500100415
022600100415       ENDSR;
022700100413
022800100413       //--------------------------------------------------------------
022900100413       //?Operazioni finali.
023000100413       //--------------------------------------------------------------
023100100513       BEGSR RoutEnd;
023200100413
023300100413         *inLR = *on;
023400100413         return;
023500100413
023600100413       ENDSR;
023700100413
023800100413      /end-free
