000100100413      //---------------------------------------------------------------
000200110208      //?TNVRCRM9 - Elimina Info trattative
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000100413
001100110208      // - File trattative
001200110209     fTIVIS00F  UF   E             DISK    usropn
001300110209     f                                     extfile(wFLib)
001400100413      //---------------------------------------------------------------
001500100413      //?Definizione costanti.
001600100413      //---------------------------------------------------------------
001700100413
001800100413      //---------------------------------------------------------------
001900100413      //?Definizione schiere.
002000100413      //---------------------------------------------------------------
002100110208
002200110208      // - Tipi trattative NO info
002300110208     d $TTR            s              1    dim(10)
002400090715
002500100413      //---------------------------------------------------------------
002600100413      //?Definizione aree dati.
002700100413      //---------------------------------------------------------------
002800100413
002900100413      //---------------------------------------------------------------
003000100413      //?Definizione strutture dati.
003100100413      //---------------------------------------------------------------
003200110204
003300110204     d KPJBA         e ds
003400110208
003500110208      // File Tabelle
003600110208     d TNTBE00F      e ds                  extname(TNTBE00F)
003700110208
003800110208      // - Tabella TTR = Tipi trattative
003900110208     d dTTR          e ds                  inz
004000100415
004100100413      //---------------------------------------------------------------
004200100413      //?Definizione variabili globali.
004300100413      //---------------------------------------------------------------
004400100413
004500100413      // - Flags booleani
004600100413     d $End            s               n   inz(*off)
004700110204     d $Fine           s               n   inz(*off)
004800110204
004900110204      // - Indici di schiera
005000110204     d xx              s              4  0 inz
005100110208
005200110208      // - Campi di comodo
005300110209     d nRec            s             10  0 inz
005400110208     d wTTR            s                   like(VIStpv)
005500110209
005600110209       // - Nome libreria del file TIVIS
005700110209     d wFLib           s             21    inz
005800110209
005900110209       // - Stringhe SQL da eseguire
006000110209     d wSQL            s           2048    Varying        inz
006100100413
006200100413      //---------------------------------------------------------------
006300100413      //?Definizione procedure esterne.
006400100413      //---------------------------------------------------------------
006500100413
006600100413      //---------------------------------------------------------------
006700110204      //?Prototipi.
006800100413      //---------------------------------------------------------------
006900100413
007000100413      //---------------------------------------------------------------
007100100413      //?Definizione key-list.
007200100413      //---------------------------------------------------------------
007300100413
007400100413      //---------------------------------------------------------------
007500100413      //?Riepilogo indicatori.
007600100413      //---------------------------------------------------------------
007700100413
007800100413      //---------------------------------------------------------------
007900100413      //?M A I N - L I N E
008000100413      //---------------------------------------------------------------
008100100413
008200100413     c     *Entry        plist
008300110204     c                   parm                    kpjba
008400100413
008500100413      /free
008600100413
008700100413       //?Operazioni iniziali
008800100513       exsr RoutInz;
008900110204
009000110204       exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
009100100413
009200100726       //?Elaboro
009300100726       exsr Elabora;
009400100413
009500100413       //?Operazioni finali
009600100513       exsr RoutEnd;
009700100413
009800100413       //--------------------------------------------------------------
009900100413       //?Operazioni iniziali.
010000100413       //--------------------------------------------------------------
010100100513       BEGSR RoutInz;
010200110208
010300110208         //?carico sk con tipi trattativa che non hanno info
010400110208         clear $TTR;
010500110208         clear xx;
010600110208         $End = *off;
010700110208
010800110208         exec sql
010900110208          declare TBE cursor for
011000110208          select tbeke1, tbeuni
011100110208          from tntbe00f where tbecod = 'TTR' and tbeatb = ' '
011200110208          order by tbeke1;
011300110208
011400110208         exec sql
011500110208           open TBE;
011600110208           IF sqlcode < 0;
011700110208             $End = *on;
011800110208           ENDIF;
011900110208
012000110208         DOW not $End;
012100110208           exec sql
012200110208             fetch next from TBE into :tbeke1, :tbeuni;
012300110208             IF sqlcod = 100 or sqlcod < 0;
012400110208               $End = *on;
012500110208               leave;
012600110208             ENDIF;
012700110208
012800110208             dTTR = TBEuni;
012900110208             IF  §TTRinfo = 'N';
013000110208               xx += 1;
013100110208               $TTR(xx) = TBEke1;
013200110208             ENDIF;
013300110208
013400110208         ENDDO;
013500110208
013600110208         exec sql close TBE;
013700110208         $End = *off;
013800110209
013900110209         //?Apro il file delle trattative
014000110209         IF  %subst(knsif : 7 : 1) = 'P';
014100110218           wFLib = 'FILTRAGRU/TIVIS00F';
014200110209         ELSE;
014300110209           wFLib = 'FILTRAGRU/TIVIS00F';
014400110209         ENDIF;
014500110209         open  TIVIS00F;
014600100413
014700100413       ENDSR;
014800100413
014900100413       //--------------------------------------------------------------
015000100422       //?Elaboro.
015100100413       //--------------------------------------------------------------
015200100513       BEGSR Elabora;
015300110208
015400110208         xx = 1;
015500110208         FOR xx by 1 to %elem($TTR);
015600110208           $Fine = *off;
015700110208           IF $TTR(xx) <> *blanks;
015800110208             wTTR = $TTR(xx);
015900110209           //?Preparo SQL per leggere file trattative
016000110209             clear wSQL;
016100110209             wSQL = 'select VISnrv, VISinfot, rrn(TIVIS00F) as nRec from ';
016200110209             IF  %subst(knsif : 7 : 1) = 'P';
016300110218               wSQL += 'FILTRAGRU/TIVIS00F ';
016400110209             ELSE;
016500110209               wSQL += 'FILTRAGRU/TIVIS00F ';
016600110209             ENDIF;
016700110209             wSQL += 'where VIStpv = ' + '''' + wTTR + '''' + ' ';
016800110209             wSQL += 'order by VISnrv';
016900110209
017000110209           //?Preparo il cursore
017100110209             exec sql prepare S1 from :wSQL;
017200110209
017300110209             exec sql declare VIS cursor for S1;
017400110209
017500110209          //?Apro il cursore
017600110209             exec sql open VIS;
017700110209             IF  sqlcode < 0;
017800110209               $Fine = *on;
017900110209             ENDIF;
018000110209
018100110209          //?Leggo le trattative
018200110209             DOW  not $Fine;
018300110208               exec sql FETCH next from VIS into :VISnrv, :VISinfot, :nRec;
018400110208               IF  sqlcod = 100 or sqlcod < 0;
018500110208                 $Fine = *on;
018600110208                 leave;
018700110208               ENDIF;
018800110208
018900110208             //?Cancello le INFO
019000110208               exsr DelInfo;
019100110208
019200110208             //?Pulisco flag di INFO presenti su trattative
019300110208               IF  VISinfot <> *blanks;
019400110208                 exsr AggVis;
019500110208               ENDIF;
019600110208
019700110208             //?Cancello le INFO dal SIC
019800110208               exsr DelSic;
019900110208
020000110208             ENDDO;
020100110208
020200110208             exec sql CLOSE VIS;
020300110208           ENDIF;
020400110208
020500110208         ENDFOR;
020600100413
020700100413       ENDSR;
020800100726
020900100726       //--------------------------------------------------------------
021000110208       //?Cancello le INFO.
021100100726       //--------------------------------------------------------------
021200110208       BEGSR DelInfo;
021300100726
021400110209         IF  %subst(knsif : 7 : 1) = 'P';
021500110209           exec sql
021600110218           DELETE from FILTRAGRU/TIVII00F
021700110209           WHERE VIInrv = :VISnrv;
021800110209         ELSE;
021900110209           exec sql
022000110209           DELETE from FILTRAGRU/TIVII00F
022100110209           WHERE VIInrv = :VISnrv;
022200110209         ENDIF;
022300100726
022400100726       ENDSR;
022500110208
022600110208       //--------------------------------------------------------------
022700110208       //?Pulisco flag di INFO presenti su trattativa.
022800110208       //--------------------------------------------------------------
022900110208       BEGSR AggVis;
023000110208
023100110208         chain nRec TIVIS00F;
023200110208         IF  %found;
023300110208           clear VISinfot;
023400110208           update TIVIS000;
023500110208         ENDIF;
023600110208
023700110208       ENDSR;
023800110208
023900110208       //--------------------------------------------------------------
024000110208       //?Cancello il SIC.
024100110208       //--------------------------------------------------------------
024200110208       BEGSR DelSic;
024300110208
024400110208       //?Cancello SIC storico
024500110209         IF  %subst(knsif : 7 : 1) = 'P';
024600110209           exec sql
024700110209           //DELETE from GAITRAAZP/TIVIIC0F
024800110209           DELETE from GAITRAAZM/TIVIIC0F
024900110209           WHERE VICnrv = :VISnrv;
025000110209         ELSE;
025100110209           exec sql
025200110209           DELETE from GAITRAAZM/TIVIIC0F
025300110209           WHERE VICnrv = :VISnrv;
025400110209         ENDIF;
025500110208
025600110208       //?Cancello SIC in corso
025700110209         IF  %subst(knsif : 7 : 1) = 'P';
025800110209           exec sql
025900110209           //DELETE from GAITRAAZP/TIVIII0F
026000110209           DELETE from GAITRAAZM/TIVIII0F
026100110209           WHERE VIInrv = :VISnrv;
026200110209         ELSE;
026300110209           exec sql
026400110209           DELETE from GAITRAAZM/TIVIII0F
026500110209           WHERE VIInrv = :VISnrv;
026600110209         ENDIF;
026700110208
026800110208       ENDSR;
026900100413
027000100413       //--------------------------------------------------------------
027100100413       //?Operazioni finali.
027200100413       //--------------------------------------------------------------
027300100513       BEGSR RoutEnd;
027400100413
027500100413         *inLR = *on;
027600100413         return;
027700100413
027800100413       ENDSR;
027900100413
028000100413      /end-free
