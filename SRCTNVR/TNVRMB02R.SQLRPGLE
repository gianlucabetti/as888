000100120423      //---------------------------------------------------------------
000200120423      //
000300130128      //?      Cancella TNOFM + legati non presenti su TIVIS
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130125
001300130128      // - File offerte
001400130128     fTNOFM01L  uf   e           k disk
001500130128     fTIOFD01L  uf   e           k disk
001600130128     fTIOPT01L  uf   e           k disk
001700130128     fTIOPD01L  uf   e           k disk
001800130128     fTIOGC01L  uf   e           k disk
001900120423
002000120423      //---------------------------------------------------------------
002100120423      //?Definizione costanti.
002200120423      //---------------------------------------------------------------
002300120423
002400120423      //---------------------------------------------------------------
002500120423      //?Definizione schiere.
002600120423      //---------------------------------------------------------------
002700120423
002800120423      //---------------------------------------------------------------
002900120423      //?Definizione aree dati.
003000120423      //---------------------------------------------------------------
003100120423
003200120423      //---------------------------------------------------------------
003300120423      //?Definizione strutture dati.
003400120423      //---------------------------------------------------------------
003500130128
003600130128     d kpjba         e ds
003700130128
003800130128      // - Annulla dati tipo
003900130128     d TNTA47ds      e ds
004000120706
004100120706      // - File trattative
004200120706     d tivisds       e ds                  extname(TIVIS00F)
004300120423
004400120423      //---------------------------------------------------------------
004500120423      //?Definizione variabili globali.
004600120423      //---------------------------------------------------------------
004700120423      // - Flags booleani
004800120423     d wEoF            s               n   inz(*off)
004900120423
005000120423      // - Campi di comodo
005100120423
005200120423      //---------------------------------------------------------------
005300120423      //?Definizione procedure esterne.
005400120423      //---------------------------------------------------------------
005500130128
005600130128      * Annullo dati tipo
005700130128     d TNTA47R         pr                  extpgm('TNTA47R')
005800130128     d  kpjba                              likeds(kpjba)
005900120423
006000120423      //---------------------------------------------------------------
006100120423      //?Definizione prototipi.
006200120423      //---------------------------------------------------------------
006300120423
006400120423      //---------------------------------------------------------------
006500120423      //?Definizione key-list.
006600120423      //---------------------------------------------------------------
006700120423
006800120423      //---------------------------------------------------------------
006900120423      //?Riepilogo indicatori.
007000120423      //---------------------------------------------------------------
007100120423
007200120423      //---------------------------------------------------------------
007300120423      //?M A I N - L I N E
007400120423      //---------------------------------------------------------------
007500130128
007600130128     C     *ENTRY        PLIST
007700130128     C                   PARM                    KPJBA
007800120423
007900120423      /free
008000120423
008100120423       //?Operazioni iniziali
008200120423       exsr RoutInz;
008300120423
008400120430       //?Elabora file
008500120430       exsr Elabora;
008600120423
008700120423       //?Operazioni finali
008800120423       exsr RoutEnd;
008900120423
009000120423       //--------------------------------------------------------------
009100120423       //?Operazioni iniziali.
009200120423       //--------------------------------------------------------------
009300120423       BEGSR RoutInz;
009400120706
009500120706       //?Impostazione opzioni per SQL?
009600120706         exec sql   set  option  DynUsrPrf = *Owner,
009700120706                                 CloSqlCsr = *EndMod;
009800120423
009900120423       ENDSR;
010000120423
010100120423       //--------------------------------------------------------------
010200120430       //?Elabora file
010300120423       //--------------------------------------------------------------
010400120430       BEGSR Elabora;
010500120423
010600120423         wEoF = *off;
010700120423
010800130125       //?Leggo file Info Trattative
010900120706         exec sql
011000130128           DECLARE  OFFERTE cursor FOR
011100130128           SELECT   TAMksc, TAMctr, TAMprg from TNOFM00F
011200130125           EXCEPTION JOIN TIVIS00F
011300130128           on TAMksc = VISnrv
011400130128           ORDER BY TAMksc;
011500120706
011600120706         exec sql
011700130128           open OFFERTE;
011800120706           IF sqlcode < 0;
011900120706             wEoF = *on;
012000120706           ENDIF;
012100120706
012200120706         DOW not wEoF;
012300120706           exec sql
012400130128             FETCH NEXT from OFFERTE into :TAMksc, :TAMctr, :TAMprg;
012500120706           IF sqlcod = 100 or sqlcod < 0;
012600120706             wEOF = *on;
012700120706             leave;
012800120706           ENDIF;
012900130128
013000130128         //?Annullo dati  tipo legati all'offerta
013100130128           clear tnta47ds ;
013200130128           d47tup = '2' ;
013300130128           d47cto = 'O' ;
013400130128           d47dsf = 'S' ;
013500130128           d47ksc = tamksc ;
013600130128           d47ctr = tamctr ;
013700130128           d47prg = tamprg ;
013800130128           kpjbu = tnta47ds ;
013900130128           tnta47r (kpjba) ;
014000120706
014100130128         //?Cancello le offerte
014200130128           setll TAMksc TNOFM01L;
014300130128           reade TAMksc TNOFM01L;
014400130128           DOW not %eof(TNOFM01L);
014500130128             DELETE TNOFM01L;
014600130128             reade TAMksc TNOFM01L;
014700130125           ENDDO;
014800130128
014900130128           setll TAMksc TIOFD01L;
015000130128           reade TAMksc TIOFD01L;
015100130128           DOW not %eof(TIOFD01L);
015200130128             DELETE TIOFD01L;
015300130128             reade TAMksc TIOFD01L;
015400130128           ENDDO;
015500120706
015600130128           setll TAMksc TIOPT01L;
015700130128           reade TAMksc TIOPT01L;
015800130128           DOW not %eof(TIOPT01L);
015900130128             DELETE TIOPT01L;
016000130128             reade TAMksc TIOPT01L;
016100130128           ENDDO;
016200130128
016300130128           setll TAMksc TIOPD01L;
016400130128           reade TAMksc TIOPD01L;
016500130128           DOW not %eof(TIOPD01L);
016600130128             DELETE TIOPD01L;
016700130128             reade TAMksc TIOPD01L;
016800130128           ENDDO;
016900130128
017000130128           setll TAMksc TIOGC01L;
017100130128           reade TAMksc TIOGC01L;
017200130128           DOW not %eof(TIOGC01L);
017300130128             DELETE TIOGC01L;
017400130128             reade TAMksc TIOGC01L;
017500130128           ENDDO;
017600130128
017700120706         ENDDO;
017800120706
017900120706       //?Chiudo il cursore
018000120706         exec sql
018100130128           close OFFERTE;
018200120706
018300120706       ENDSR;
018400130125
018500120423       //--------------------------------------------------------------
018600120423       //?Operazioni finali.
018700120423       //--------------------------------------------------------------
018800120423       BEGSR RoutEnd;
018900120423
019000120423         *inLR = *on;
019100120423         return;
019200120423
019300120423       ENDSR;
019400051221
019500051221      /end-free
019600051221
