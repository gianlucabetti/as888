000100120423      //---------------------------------------------------------------
000200120423      //
000300130201      //?      Data Immissione di TICPN su trattative storicizzate
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130201
001300130201      // - File info trattative
001400130201     fTICPN00F  uf   e             disk
001500120423
001600120423      //---------------------------------------------------------------
001700120423      //?Definizione costanti.
001800120423      //---------------------------------------------------------------
001900120423
002000120423      //---------------------------------------------------------------
002100120423      //?Definizione schiere.
002200120423      //---------------------------------------------------------------
002300120423
002400120423      //---------------------------------------------------------------
002500120423      //?Definizione aree dati.
002600120423      //---------------------------------------------------------------
002700120423
002800120423      //---------------------------------------------------------------
002900120423      //?Definizione strutture dati.
003000120423      //---------------------------------------------------------------
003100130201
003200130201      // File Note
003300130201     d CPNds         e ds                  extname(TICPN00F)
003400130201     d                                     prefix(w_)
003500130204
003600130204      // File Storico
003700130204     d CRMds         e ds                  extname(TICRM00F)
003800120423
003900120423      //---------------------------------------------------------------
004000120423      //?Definizione variabili globali.
004100120423      //---------------------------------------------------------------
004200120423      // - Flags booleani
004300120423     d wEoF            s               n   inz(*off)
004400120423
004500120423      // - Campi di comodo
004600130204     d sav_CRMnrv      s                   like(CRMnrv)
004700130201     d w_CPNrcd        s             15  0 inz
004800130201     d wdata           s              8  0 inz(20130123)
004900130204     d wora            s              6  0 inz(235900)
005000130204     d wTimeISO        s               t   timfmt(*iso)
005100120423
005200120423      //---------------------------------------------------------------
005300120423      //?Definizione procedure esterne.
005400120423      //---------------------------------------------------------------
005500120423
005600120423      //---------------------------------------------------------------
005700120423      //?Definizione prototipi.
005800120423      //---------------------------------------------------------------
005900120423
006000120423      //---------------------------------------------------------------
006100120423      //?Definizione key-list.
006200120423      //---------------------------------------------------------------
006300120423
006400120423      //---------------------------------------------------------------
006500120423      //?Riepilogo indicatori.
006600120423      //---------------------------------------------------------------
006700120423
006800120423      //---------------------------------------------------------------
006900120423      //?M A I N - L I N E
007000120423      //---------------------------------------------------------------
007100120423
007200120423      /free
007300120423
007400120423       //?Operazioni iniziali
007500120423       exsr RoutInz;
007600120423
007700120430       //?Elabora file
007800120430       exsr Elabora;
007900120423
008000120423       //?Operazioni finali
008100120423       exsr RoutEnd;
008200120423
008300120423       //--------------------------------------------------------------
008400120423       //?Operazioni iniziali.
008500120423       //--------------------------------------------------------------
008600120423       BEGSR RoutInz;
008700120706
008800120706       //?Impostazione opzioni per SQL?
008900120706         exec sql   set  option  DynUsrPrf = *Owner,
009000120706                                 CloSqlCsr = *EndMod;
009100120423
009200120423       ENDSR;
009300130204
009400130204       //--------------------------------------------------------------
009500130204       //?Elabora
009600130204       //--------------------------------------------------------------
009700130204       BEGSR elabora;
009800130204
009900130204         wEoF = *off;
010000130204
010100130204       //?Leggo il file dello storico trattative + note
010200130204         exec sql
010300130204         DECLARE  NOTE cursor FOR
010400130204         SELECT rrn(TICPN00F) as w_CPNrrn, TICRM00F.*, TICPN00F.*
010500130204         from TICRM00F  join TICPN00F
010600130204         on CRMcpo = CPNcpo and CRMksc = CPNksc and CRMnrv = CPNnrv
010700130204         WHERE CRMtrc = 'T' and CPNdim = :wdata and CPNpru = 'BATCH'
010800130204         ORDER BY CRMcpo, CRMnrv;
010900130204
011000130204         exec sql
011100130204         open NOTE;
011200130204         IF sqlcode < 0;
011300130204           wEoF = *on;
011400130204         ENDIF;
011500130204
011600130204         DOW not wEoF;
011700130204           exec sql
011800130204           FETCH NEXT from NOTE into :w_CPNrcd, :CRMds, :CPNds;
011900130204           IF sqlcod = 100 or sqlcod < 0;
012000130204             wEOF = *on;
012100130204             leave;
012200130204           ENDIF;
012300130204
012400130204         //?A cambio trattativa imposto l'ora
012500130204           IF  CRMnrv <> sav_CRMnrv;
012600130204             wTimeISO = %time(wora:*ISO);
012700130204             sav_CRMnrv = CRMnrv;
012800130204           ENDIF;
012900130204
013000130204         //?Aggiorno il file note
013100130204           wTimeISO = wTimeISO + %seconds(1);
013200130204           chain w_CPNrcd TICPN00F;
013300130204           IF  %found(TICPN00F);
013400130204             CPNdim = CRMdaf;
013500130204             CPNhim =  %dec(wTimeISO);
013600130204             update TICPN000;
013700130204           ENDIF;
013800130204         ENDDO;
013900130204
014000130204       //?Chiudo il cursore
014100130204         exec sql
014200130204           close NOTE;
014300130204
014400130204       ENDSR;
014500130125
014600120423       //--------------------------------------------------------------
014700120423       //?Operazioni finali.
014800120423       //--------------------------------------------------------------
014900120423       BEGSR RoutEnd;
015000120423
015100120423         *inLR = *on;
015200120423         return;
015300120423
015400120423       ENDSR;
015500051221
015600051221      /end-free
015700051221
