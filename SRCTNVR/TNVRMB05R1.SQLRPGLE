000100120423      //---------------------------------------------------------------
000200120423      //
000300130201      //?      Data Immissione di TICPN su trattative storicizzate
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130201
001300130201      // - File info trattative
001400130201     fTICPN00F  uf   e             disk
001500130125
001600130201      // - File Storico trattative
001700130201     fTICRM01L  if   e           k disk
001800120423
001900120423      //---------------------------------------------------------------
002000120423      //?Definizione costanti.
002100120423      //---------------------------------------------------------------
002200120423
002300120423      //---------------------------------------------------------------
002400120423      //?Definizione schiere.
002500120423      //---------------------------------------------------------------
002600120423
002700120423      //---------------------------------------------------------------
002800120423      //?Definizione aree dati.
002900120423      //---------------------------------------------------------------
003000120423
003100120423      //---------------------------------------------------------------
003200120423      //?Definizione strutture dati.
003300120423      //---------------------------------------------------------------
003400130201
003500130201      // File Note
003600130201     d CPNds         e ds                  extname(TICPN00F)
003700130201     d                                     prefix(w_)
003800120423
003900120423      //---------------------------------------------------------------
004000120423      //?Definizione variabili globali.
004100120423      //---------------------------------------------------------------
004200120423      // - Flags booleani
004300120423     d wEoF            s               n   inz(*off)
004400120423
004500120423      // - Campi di comodo
004600130201     d w_CPNrcd        s             15  0 inz
004700130201     d wdata           s              8  0 inz(20130123)
004800120423
004900120423      //---------------------------------------------------------------
005000120423      //?Definizione procedure esterne.
005100120423      //---------------------------------------------------------------
005200120423
005300120423      //---------------------------------------------------------------
005400120423      //?Definizione prototipi.
005500120423      //---------------------------------------------------------------
005600120423
005700120423      //---------------------------------------------------------------
005800120423      //?Definizione key-list.
005900120423      //---------------------------------------------------------------
006000120423
006100120423      //---------------------------------------------------------------
006200120423      //?Riepilogo indicatori.
006300120423      //---------------------------------------------------------------
006400120423
006500120423      //---------------------------------------------------------------
006600120423      //?M A I N - L I N E
006700120423      //---------------------------------------------------------------
006800120423
006900120423      /free
007000120423
007100120423       //?Operazioni iniziali
007200120423       exsr RoutInz;
007300120423
007400120430       //?Elabora file
007500120430       exsr Elabora;
007600120423
007700120423       //?Operazioni finali
007800120423       exsr RoutEnd;
007900120423
008000120423       //--------------------------------------------------------------
008100120423       //?Operazioni iniziali.
008200120423       //--------------------------------------------------------------
008300120423       BEGSR RoutInz;
008400120706
008500120706       //?Impostazione opzioni per SQL?
008600120706         exec sql   set  option  DynUsrPrf = *Owner,
008700120706                                 CloSqlCsr = *EndMod;
008800120423
008900120423       ENDSR;
009000120423
009100120423       //--------------------------------------------------------------
009200120430       //?Elabora file
009300120423       //--------------------------------------------------------------
009400120430       BEGSR Elabora;
009500120423
009600120423         wEoF = *off;
009700120423
009800130125       //?Leggo file Info Trattative
009900120706         exec sql
010000130128           DECLARE  NOTE cursor FOR
010100130201           SELECT   rrn(TICPN00F) as w_CPNrrn, TICPN00F.* from TICPN00F
010200130201           WHERE CPNpru = 'BATCH' and CPNdim = :wdata
010300130201           ORDER BY CPNcpo;
010400120706
010500120706         exec sql
010600130128           open NOTE;
010700120706           IF sqlcode < 0;
010800120706             wEoF = *on;
010900120706           ENDIF;
011000120706
011100120706         DOW not wEoF;
011200120706           exec sql
011300130201             FETCH NEXT from NOTE into :w_CPNrcd, :CPNds;
011400120706           IF sqlcod = 100 or sqlcod < 0;
011500120706             wEOF = *on;
011600120706             leave;
011700120706           ENDIF;
011800120706
011900130201         //?Cerco la trattativa storicizzata
012000130201           setll (w_CPNcpo) TICRM01L;
012100130201           reade (w_CPNcpo) TICRM01L;
012200130201           DOW  not %eof(TICRM01L);
012300130201             IF  CRMnrv = w_CPNnrv;
012400130201               chain w_CPNrcd TICPN00F;
012500130201               IF  %found(TICPN00F);
012600130201                 CPNdim = CRMdaf;
012700130204                 CPNhim = 235959;
012800130201                 update TICPN000;
012900130201               ENDIF;
013000130201             ENDIF;
013100130201             reade (w_CPNcpo) TICRM01L;
013200130201           ENDDO;
013300120706
013400120706         ENDDO;
013500120706
013600120706       //?Chiudo il cursore
013700120706         exec sql
013800130128           close NOTE;
013900120706
014000120706       ENDSR;
014100130125
014200120423       //--------------------------------------------------------------
014300120423       //?Operazioni finali.
014400120423       //--------------------------------------------------------------
014500120423       BEGSR RoutEnd;
014600120423
014700120423         *inLR = *on;
014800120423         return;
014900120423
015000120423       ENDSR;
015100051221
015200051221      /end-free
015300051221
