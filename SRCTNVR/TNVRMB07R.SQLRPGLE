000100120423      //---------------------------------------------------------------
000200120423      //
000300130304      //?      Sistema Blocco clienti
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130201
001300130304     fCNACO00F  if   e           k disk
001400130305     fCNACVT1L  if   e           k disk
001500130304     fCNACVD1L  if   e           k disk
001600130304     fCNACVDmb  o    e             disk    rename(cnacvdmb:cnacvdm)
001700130304     f                                     prefix(m)
001800120423
001900120423      //---------------------------------------------------------------
002000120423      //?Definizione costanti.
002100120423      //---------------------------------------------------------------
002200120423
002300120423      //---------------------------------------------------------------
002400120423      //?Definizione schiere.
002500120423      //---------------------------------------------------------------
002600120423
002700120423      //---------------------------------------------------------------
002800120423      //?Definizione aree dati.
002900120423      //---------------------------------------------------------------
003000120423
003100120423      //---------------------------------------------------------------
003200120423      //?Definizione strutture dati.
003300120423      //---------------------------------------------------------------
003400130214
003500130214       // -?Parametri ricevuti?
003600130214     d kpjba         e ds
003700130304
003800130304      // -?File CNACVD
003900130304     d ACVDds        e ds                  extname(CNACVD0F)
004000130304     d                                     prefix(w)
004100120423
004200120423      //---------------------------------------------------------------
004300120423      //?Definizione variabili globali.
004400120423      //---------------------------------------------------------------
004500120423      // - Flags booleani
004600120423     d wEoF            s               n   inz(*off)
004700120423
004800120423      // - Campi di comodo
004900130305     d savKSC          s              7  0
005000120423
005100120423      //---------------------------------------------------------------
005200120423      //?Definizione procedure esterne.
005300120423      //---------------------------------------------------------------
005400120423
005500120423      //---------------------------------------------------------------
005600120423      //?Definizione prototipi.
005700120423      //---------------------------------------------------------------
005800120423
005900120423      //---------------------------------------------------------------
006000120423      //?Definizione key-list.
006100120423      //---------------------------------------------------------------
006200120423
006300120423      //---------------------------------------------------------------
006400120423      //?Riepilogo indicatori.
006500120423      //---------------------------------------------------------------
006600120423
006700120423      //---------------------------------------------------------------
006800120423      //?M A I N - L I N E
006900120423      //---------------------------------------------------------------
007000130214
007100130214     c     *Entry        plist
007200130214     c                   parm                    kpjba
007300120423
007400120423      /free
007500120423
007600120423       //?Operazioni iniziali
007700120423       exsr RoutInz;
007800120423
007900120430       //?Elabora file
008000120430       exsr Elabora;
008100120423
008200120423       //?Operazioni finali
008300120423       exsr RoutEnd;
008400120423
008500120423       //--------------------------------------------------------------
008600120423       //?Operazioni iniziali.
008700120423       //--------------------------------------------------------------
008800120423       BEGSR RoutInz;
008900120706
009000130214       //?Impostazione opzioni per SQL?
009100130214         exec sql   set  option  DynUsrPrf = *Owner,
009200130214                                 CloSqlCsr = *EndMod;
009300120423
009400120423       ENDSR;
009500130204
009600130204       //--------------------------------------------------------------
009700130204       //?Elabora
009800130204       //--------------------------------------------------------------
009900130204       BEGSR elabora;
010000130304
010100130304         wEoF = *off;
010200130304
010300130304       //?parto a leggere dalle variazioni fatte con pgm YCO08200R
010400130304         exec sql
010500130304         DECLARE VAR cursor FOR
010600130304         SELECT b.*
010700130304         from CNACVT0F as a join CNACVD0F as b on
010800130304         a.acvkcc = b.acvkcc and a.acvksc = b.acvksc and
010900130304         a.acvdav = b.acvdav and a.acvorv = b.acvorv
011000130304         WHERE acvpgm = 'YCO08200R' and acvyda = 'B' and
011100130305         substr(acvprima, 3, 1) <> ' ' and substr(acvdopo, 3, 1) = ' '
011200130305         ORDER BY b.ACVksc, b.ACVdav desc, b.ACVorv desc;
011300130304
011400130304         exec sql
011500130304         open VAR;
011600130304         IF sqlcode < 0;
011700130304           wEoF = *on;
011800130304         ENDIF;
011900130304
012000130304         DOW not wEoF;
012100130304           exec sql
012200130304           FETCH NEXT from VAR into :ACVDds;
012300130304           IF sqlcod = 100 or sqlcod < 0;
012400130304             wEOF = *on;
012500130304             leave;
012600130304           ENDIF;
012700130305
012800130305       //?A cambio cliente
012900130305          IF  wACVksc <> savKSC;
013000130304
013100130304       //?Per i clienti bloccati non faccio niente
013200130304           chain (1:wACVkcc:wACVksc) CNACO00F;
013300130304           IF  ACOabl <> *blanks;
013400130304           ELSE;
013500130304       //?Per i clienti NON bloccati verifico se la variazione che ho letto
013600130304       //?è l'ultima
013700130304             exsr leggi_var;
013800130304           ENDIF;
013900130305
014000130305           savKSC = wACVksc;
014100130305           ENDIF;
014200130304
014300130304         ENDDO;
014400130304
014500130304       //?Chiudo il cursore
014600130304         exec sql
014700130304           close VAR;
014800130204
014900130204       ENDSR;
015000130304
015100130304       //--------------------------------------------------------------
015200130304       //?Leggo le variazioni.
015300130304       //--------------------------------------------------------------
015400130304       BEGSR leggi_var;
015500130304
015600130305         setll (wACVkcc:wACVksc) CNACVT1L;
015700130305         reade (wACVkcc:wACVksc) CNACVT1L;
015800130305         DOW  not %eof(CNACVT1L);
015900130305           IF  ACVcta = 'M' and %scan('B':ACVflo) > *zeros;
016000130304             IF  wACVdav = ACVdav and wACVorv = ACVorv;
016100130305               chain (acvkcc:acvksc:acvdav:acvorv:acvnoj:'B') CNACVD1L;
016200130305               IF  %found(CNACVD1L);
016300130305                 clear cnacvdm;
016400130305                 macvatb = acvatb;
016500130305                 macvkcc = acvkcc;
016600130305                 macvksc = acvksc;
016700130305                 macvdav = acvdav;
016800130305                 macvorv = acvorv;
016900130305                 macvnoj = acvnoj;
017000130305                 macvyda = acvyda;
017100130305                 macvprg = acvprg;
017200130305                 macvprima = acvprima;
017300130305                 macvdopo = acvdopo;
017400130305                 write  cnacvdm;
017500130305               ENDIF;
017600130304             ENDIF;
017700130304             leave;
017800130304           ENDIF;
017900130305           reade (wACVkcc:wACVksc) CNACVT1L;
018000130304         ENDDO;
018100130304
018200130304       ENDSR;
018300130125
018400120423       //--------------------------------------------------------------
018500120423       //?Operazioni finali.
018600120423       //--------------------------------------------------------------
018700120423       BEGSR RoutEnd;
018800120423
018900120423         *inLR = *on;
019000120423         return;
019100120423
019200120423       ENDSR;
019300051221
019400051221      /end-free
019500051221
