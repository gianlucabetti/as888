000100120423      //---------------------------------------------------------------
000200120423      //
000300130304      //?      Sistema Blocco clienti
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130314
001300130314     fCNACO00F  uf   e           k disk
001400130314     fCNCLP00F  uf   e           k disk
001500130314
001600130314     fTNTAM00L  if   e           k disk
001700130314     fFNBLP55L  if   e           k disk
001800130201
001900130307     fCNACVDmb  if   e             disk    rename(cnacvdmb:cnacvdm)
002000130304     f                                     prefix(m)
002100120423
002200120423      //---------------------------------------------------------------
002300120423      //?Definizione costanti.
002400120423      //---------------------------------------------------------------
002500120423
002600120423      //---------------------------------------------------------------
002700120423      //?Definizione schiere.
002800120423      //---------------------------------------------------------------
002900120423
003000120423      //---------------------------------------------------------------
003100120423      //?Definizione aree dati.
003200120423      //---------------------------------------------------------------
003300120423
003400120423      //---------------------------------------------------------------
003500120423      //?Definizione strutture dati.
003600120423      //---------------------------------------------------------------
003700130214
003800130214       // -?Parametri ricevuti?
003900130214     d kpjba         e ds
004000130304
004100130304      // -?File CNACVD
004200130314     d ACVDds        e ds                  extname(CNACVDmb)
004300130314     d dacv_B        e ds                  prefix(b)
004400120423
004500120423      //---------------------------------------------------------------
004600120423      //?Definizione variabili globali.
004700120423      //---------------------------------------------------------------
004800120423      // - Flags booleani
004900120423     d wEoF            s               n   inz(*off)
005000120423
005100120423      //---------------------------------------------------------------
005200120423      //?Definizione procedure esterne.
005300120423      //---------------------------------------------------------------
005400120423
005500120423      //---------------------------------------------------------------
005600120423      //?Definizione prototipi.
005700120423      //---------------------------------------------------------------
005800120423
005900120423      //---------------------------------------------------------------
006000120423      //?Definizione key-list.
006100120423      //---------------------------------------------------------------
006200120423
006300120423      //---------------------------------------------------------------
006400120423      //?Riepilogo indicatori.
006500120423      //---------------------------------------------------------------
006600120423
006700120423      //---------------------------------------------------------------
006800120423      //?M A I N - L I N E
006900120423      //---------------------------------------------------------------
007000130214
007100130214     c     *Entry        plist
007200130214     c                   parm                    kpjba
007300120423
007400120423      /free
007500120423
007600120423       //?Operazioni iniziali
007700120423       exsr RoutInz;
007800120423
007900120430       //?Elabora file
008000120430       exsr Elabora;
008100120423
008200120423       //?Operazioni finali
008300120423       exsr RoutEnd;
008400120423
008500120423       //--------------------------------------------------------------
008600120423       //?Operazioni iniziali.
008700120423       //--------------------------------------------------------------
008800120423       BEGSR RoutInz;
008900120706
009000130214       //?Impostazione opzioni per SQL?
009100130214         exec sql   set  option  DynUsrPrf = *Owner,
009200130214                                 CloSqlCsr = *EndMod;
009300120423
009400120423       ENDSR;
009500130204
009600130204       //--------------------------------------------------------------
009700130204       //?Elabora
009800130204       //--------------------------------------------------------------
009900130204       BEGSR elabora;
010000130304
010100130304         wEoF = *off;
010200130304
010300130304       //?parto a leggere dalle variazioni fatte con pgm YCO08200R
010400130304         exec sql
010500130314         DECLARE ACVD cursor FOR
010600130314         SELECT *
010700130314         from CNACVDMB;
010800130304
010900130304         exec sql
011000130314         open ACVD;
011100130304         IF sqlcode < 0;
011200130304           wEoF = *on;
011300130304         ENDIF;
011400130304
011500130304         DOW not wEoF;
011600130304           exec sql
011700130314           FETCH NEXT from ACVD into :ACVDds;
011800130304           IF sqlcod = 100 or sqlcod < 0;
011900130304             wEOF = *on;
012000130304             leave;
012100130304           ENDIF;
012200130314
012300130314       //?Per i clienti bloccati non faccio niente
012400130314           chain (1:ACVkcc:ACVksc) CNACO00F;
012500130314           IF  not %found(CNACO00F) or
012600130314               ACOabl <> *blanks;
012700130314             iter;
012800130314           ENDIF;
012900130314
013000130314       //?Cliente con tariffa non faccio niente
013100130314           chain (ACVksc) TNTAM00L;
013200130314           IF  %found(TNTAM00L);
013300130314             iter;
013400130314           ENDIF;
013500130314
013600130314       //?Cliente con bolla partenza non faccio niente
013700130314           chain (ACVksc) FNBLP55L;
013800130314           IF  %found(FNBLP55L);
013900130314             iter;
014000130314           ENDIF;
014100130314
014200130314       //?Imposto la DS prima
014300130314           dACV_b = ACVprima;
014400130314
014500130314       //?Aggiorno CNACO + CNCLP
014600130314           chain (ACOkut:ACOkcc:ACOksc) CNCLP00F;
014700130314           CLPnar = bCLPnar;
014800130314           update  CNCLP000;
014900130314
015000130314           ACOabl = bACOabl;
015100130314           clear ACOdtr;
015200130314           clear ACOftr;
015300130314           update CNACO000;
015400130304
015500130304         ENDDO;
015600130304
015700130304       //?Chiudo il cursore
015800130304         exec sql
015900130314           close ACVD;
016000130204
016100130204       ENDSR;
016200130125
016300120423       //--------------------------------------------------------------
016400120423       //?Operazioni finali.
016500120423       //--------------------------------------------------------------
016600120423       BEGSR RoutEnd;
016700120423
016800120423         *inLR = *on;
016900120423         return;
017000120423
017100120423       ENDSR;
017200051221
017300051221      /end-free
017400051221
