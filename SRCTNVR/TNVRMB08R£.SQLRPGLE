000100120423      //---------------------------------------------------------------
000200120423      //
000300130304      //?      Sistema Blocco clienti
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130201
001300130304     fCNACO00F  if   e           k disk
001400130305     fCNACVT1L  if   e           k disk
001500130304     fCNACVD1L  if   e           k disk
001600130304     fCNACVDmb  o    e             disk    rename(cnacvdmb:cnacvdm)
001700130304     f                                     prefix(m)
001800120423
001900120423      //---------------------------------------------------------------
002000120423      //?Definizione costanti.
002100120423      //---------------------------------------------------------------
002200120423
002300120423      //---------------------------------------------------------------
002400120423      //?Definizione schiere.
002500120423      //---------------------------------------------------------------
002600120423
002700120423      //---------------------------------------------------------------
002800120423      //?Definizione aree dati.
002900120423      //---------------------------------------------------------------
003000120423
003100120423      //---------------------------------------------------------------
003200120423      //?Definizione strutture dati.
003300120423      //---------------------------------------------------------------
003400130214
003500130214       // -?Parametri ricevuti?
003600130214     d kpjba         e ds
003700130304
003800130304      // -?File CNACVD
003900130304     d ACVDds        e ds                  extname(CNACVD0F)
004000130304     d                                     prefix(w)
004100130304     d dacv_B        e DS
004200130304     d                                     prefix(d)
004300130304     d dacv_Bp       e DS                  extname(dacv_B)
004400130304     d                                     prefix(p)
004500120423
004600120423      //---------------------------------------------------------------
004700120423      //?Definizione variabili globali.
004800120423      //---------------------------------------------------------------
004900120423      // - Flags booleani
005000120423     d wEoF            s               n   inz(*off)
005100120423
005200120423      // - Campi di comodo
005300130305     d savKSC          s              7  0
005400120423
005500120423      //---------------------------------------------------------------
005600120423      //?Definizione procedure esterne.
005700120423      //---------------------------------------------------------------
005800120423
005900120423      //---------------------------------------------------------------
006000120423      //?Definizione prototipi.
006100120423      //---------------------------------------------------------------
006200120423
006300120423      //---------------------------------------------------------------
006400120423      //?Definizione key-list.
006500120423      //---------------------------------------------------------------
006600120423
006700120423      //---------------------------------------------------------------
006800120423      //?Riepilogo indicatori.
006900120423      //---------------------------------------------------------------
007000120423
007100120423      //---------------------------------------------------------------
007200120423      //?M A I N - L I N E
007300120423      //---------------------------------------------------------------
007400130214
007500130214     c     *Entry        plist
007600130214     c                   parm                    kpjba
007700120423
007800120423      /free
007900120423
008000120423       //?Operazioni iniziali
008100120423       exsr RoutInz;
008200120423
008300120430       //?Elabora file
008400120430       exsr Elabora;
008500120423
008600120423       //?Operazioni finali
008700120423       exsr RoutEnd;
008800120423
008900120423       //--------------------------------------------------------------
009000120423       //?Operazioni iniziali.
009100120423       //--------------------------------------------------------------
009200120423       BEGSR RoutInz;
009300120706
009400130214       //?Impostazione opzioni per SQL?
009500130214         exec sql   set  option  DynUsrPrf = *Owner,
009600130214                                 CloSqlCsr = *EndMod;
009700120423
009800120423       ENDSR;
009900130204
010000130204       //--------------------------------------------------------------
010100130204       //?Elabora
010200130204       //--------------------------------------------------------------
010300130204       BEGSR elabora;
010400130304
010500130304         wEoF = *off;
010600130304
010700130304       //?parto a leggere dalle variazioni fatte con pgm YCO08200R
010800130304         exec sql
010900130304         DECLARE VAR cursor FOR
011000130304         SELECT b.*
011100130304         from CNACVT0F as a join CNACVD0F as b on
011200130304         a.acvkcc = b.acvkcc and a.acvksc = b.acvksc and
011300130304         a.acvdav = b.acvdav and a.acvorv = b.acvorv
011400130304         WHERE acvpgm = 'YCO08200R' and acvyda = 'B' and
011500130305         substr(acvprima, 3, 1) <> ' ' and substr(acvdopo, 3, 1) = ' '
011600130305         ORDER BY b.ACVksc, b.ACVdav desc, b.ACVorv desc;
011700130304
011800130304         exec sql
011900130304         open VAR;
012000130304         IF sqlcode < 0;
012100130304           wEoF = *on;
012200130304         ENDIF;
012300130304
012400130304         DOW not wEoF;
012500130304           exec sql
012600130304           FETCH NEXT from VAR into :ACVDds;
012700130304           IF sqlcod = 100 or sqlcod < 0;
012800130304             wEOF = *on;
012900130304             leave;
013000130304           ENDIF;
013100130305
013200130305       //?A cambio cliente
013300130305          IF  wACVksc <> savKSC;
013400130304
013500130304       //?Per i clienti bloccati non faccio niente
013600130304           chain (1:wACVkcc:wACVksc) CNACO00F;
013700130304           IF  ACOabl <> *blanks;
013800130304           ELSE;
013900130304       //?Per i clienti NON bloccati verifico se la variazione che ho letto
014000130304       //?è l'ultima
014100130304             exsr leggi_var;
014200130304           ENDIF;
014300130305
014400130305           savKSC = wACVksc;
014500130305           ENDIF;
014600130304
014700130304         ENDDO;
014800130304
014900130304       //?Chiudo il cursore
015000130304         exec sql
015100130304           close VAR;
015200130204
015300130204       ENDSR;
015400130304
015500130304       //--------------------------------------------------------------
015600130304       //?Leggo le variazioni.
015700130304       //--------------------------------------------------------------
015800130304       BEGSR leggi_var;
015900130304
016000130305         setll (wACVkcc:wACVksc) CNACVT1L;
016100130305         reade (wACVkcc:wACVksc) CNACVT1L;
016200130305         DOW  not %eof(CNACVT1L);
016300130305           IF  ACVcta = 'M' and %scan('B':ACVflo) > *zeros;
016400130304             IF  wACVdav = ACVdav and wACVorv = ACVorv;
016500130305               chain (acvkcc:acvksc:acvdav:acvorv:acvnoj:'B') CNACVD1L;
016600130305               IF  %found(CNACVD1L);
016700130305                 clear cnacvdm;
016800130305                 macvatb = acvatb;
016900130305                 macvkcc = acvkcc;
017000130305                 macvksc = acvksc;
017100130305                 macvdav = acvdav;
017200130305                 macvorv = acvorv;
017300130305                 macvnoj = acvnoj;
017400130305                 macvyda = acvyda;
017500130305                 macvprg = acvprg;
017600130305                 macvprima = acvprima;
017700130305                 macvdopo = acvdopo;
017800130305                 write  cnacvdm;
017900130305               ENDIF;
018000130304             ENDIF;
018100130304             leave;
018200130304           ENDIF;
018300130305           reade (wACVkcc:wACVksc) CNACVT1L;
018400130304         ENDDO;
018500130304
018600130304       ENDSR;
018700130125
018800120423       //--------------------------------------------------------------
018900120423       //?Operazioni finali.
019000120423       //--------------------------------------------------------------
019100120423       BEGSR RoutEnd;
019200120423
019300120423         *inLR = *on;
019400120423         return;
019500120423
019600120423       ENDSR;
019700051221
019800051221      /end-free
019900051221
