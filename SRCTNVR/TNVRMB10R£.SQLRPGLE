000100131001      //---------------------------------------------------------------
000200131001      //
000300131001      //?      Scrive File ORM immessi ogni 30 minuti
000400131001      //
000500131001      //---------------------------------------------------------------
000600131001
000700080520     h decedit('0,') datedit(*ymd.) option(*nodebugio)
000800040511
000900131001      //---------------------------------------------------------------
001000131001      //?Dichiarazione file.
001100131001      //---------------------------------------------------------------
001200080710
001300131001     fWFSTAT1   uf a e           k disk
001400040511
001500131001      //---------------------------------------------------------------
001600131001      //?Definizione costanti.
001700131001      //---------------------------------------------------------------
001800131001
001900131001      //---------------------------------------------------------------
002000131001      //?Definizione schiere.
002100131001      //---------------------------------------------------------------
002200131001
002300131001      //---------------------------------------------------------------
002400131001      //?Definizione aree dati.
002500131001      //---------------------------------------------------------------
002600131001
002700131001      //---------------------------------------------------------------
002800131001      //?Definizione strutture dati.
002900131001      //---------------------------------------------------------------
003000131001
003100131001       // -?Parametri ricevuti?
003200131001     d kpjba         e ds
003300131001
003400131001      // -?File AZORG00F
003500131001     d AZORG00F      e ds                  extname(AZORG00F)
003600131001
003700131001      // -?File FNORM00F
003800131001     d FNORM00F      e ds                  extname(FNORM00F)
003900131001
004000131001      //---------------------------------------------------------------
004100131001      //?Definizione variabili globali.
004200131001      //---------------------------------------------------------------
004300131001
004400131001      // -?Flag booleani
004500131001     d wEoF            s               n   inz(*off)
004600131001
004700131001      // -?Campi di comodo
004800131001     d key_orada       s              6  0
004900131001     d key_oraa        s              6  0
005000131001     d wdataini        s              8  0
005100131001     d wdatafin        s              8  0
005200131001
005300131001      //---------------------------------------------------------------
005400131001      //?Definizione procedure esterne.
005500131001      //---------------------------------------------------------------
005600131001
005700131001      //---------------------------------------------------------------
005800131001      //?Definizione prototipi.
005900131001      //---------------------------------------------------------------
006000131001
006100131001      //---------------------------------------------------------------
006200131001      //?Definizione key-list.
006300131001      //---------------------------------------------------------------
006400131001
006500131001      //---------------------------------------------------------------
006600131001      //?Riepilogo indicatori.
006700131001      //---------------------------------------------------------------
006800131001
006900131001      //---------------------------------------------------------------
007000131001      //?M A I N - L I N E
007100131001      //---------------------------------------------------------------
007200131001
007300131001     c     *Entry        plist
007400131001     c                   parm                    kpjba
007500131001
007600131001      /free
007700131001
007800131001       //?Operazioni iniziali
007900131001       exsr RoutInz;
008000131001
008100131001       //?Elabora file
008200131001       exsr Elabora;
008300131001
008400131001       //?Operazioni finali
008500131001       exsr RoutEnd;
008600131001
008700131001       //--------------------------------------------------------------
008800131001       //?Operazioni iniziali.
008900131001       //--------------------------------------------------------------
009000131001       BEGSR RoutInz;
009100131001
009200131001       //?Impostazione opzioni per SQL?
009300131001         exec sql   set  option  DynUsrPrf = *Owner,
009400131001                                 CloSqlCsr = *EndMod;
009500131001
009600131001       //?Imposto le date
009700131001         wdataini = 20130901;
009800131001         wdatafin = 20130930;
009900131001
010000131001       ENDSR;
010100131001
010200131001       //--------------------------------------------------------------
010300131001       //?Elabora
010400131001       //--------------------------------------------------------------
010500131001       BEGSR elabora;
010600131001
010700131001         wEoF = *off;
010800131001
010900131001       //?Leggo gli ORM
011000131001         exec sql
011100131001         DECLARE ORM cursor FOR
011200131001         SELECT *
011300131001         from FNORM00F, AZORG00F
011400131001         WHERE  ORMdao between :wdataini and :wdatafin
011500131001                and ORMpoe = 001 and ORMtco = 'M'
011600131001                and ORMnrv = 0 and ORMpor = ORGfil
011700131001         ORDER BY ORMdao, ORMoao, ORMpor;
011800131001
011900131001         exec sql
012000131001         open ORM;
012100131001         IF sqlcode < 0;
012200131001           wEoF = *on;
012300131001         ENDIF;
012400131001
012500131001         DOW not wEoF;
012600131001           exec sql
012700131001           FETCH NEXT from ORM into :FNORM00F, :AZORG00F;
012800131001           IF sqlcod = 100 or sqlcod < 0;
012900131001             wEOF = *on;
013000131001             leave;
013100131001           ENDIF;
013200131001
013300131001           exsr Orari;
013400131001
013500131001         ENDDO;
013600131001
013700131001       //?Chiudo il cursore
013800131001         exec sql
013900131001           close ORM;
014000131001
014100131001       ENDSR;
014200131001
014300131001       //--------------------------------------------------------------
014400131001       //?Calcolo i 30 minuti.
014500131001       //--------------------------------------------------------------
014600131001       BEGSR Orari;
014700131001
014800131001         SELECT;
014900131001           WHEN  ORMoao >= 000100 and ORMoao < 003100;
015000131001             key_orada = 000100;
015100131001             key_oraa  = 003000;
015200131001           WHEN  ORMoao >= 003100 and ORMoao < 010100;
015300131001             key_orada = 003100;
015400131001             key_oraa  = 010000;
015500131001           WHEN  ORMoao >= 010100 and ORMoao < 013100;
015600131001             key_orada = 010100;
015700131001             key_oraa  = 013000;
015800131001           WHEN  ORMoao >= 013100 and ORMoao < 020100;
015900131001             key_orada = 013100;
016000131001             key_oraa  = 020000;
016100131001           WHEN  ORMoao >= 020100 and ORMoao < 023100;
016200131001             key_orada = 020100;
016300131001             key_oraa  = 023000;
016400131001           WHEN  ORMoao >= 023100 and ORMoao < 030100;
016500131001             key_orada = 023100;
016600131001             key_oraa  = 030000;
016700131001           WHEN  ORMoao >= 030100 and ORMoao < 033100;
016800131001             key_orada = 030100;
016900131001             key_oraa  = 033000;
017000131001           WHEN  ORMoao >= 033100 and ORMoao < 040100;
017100131001             key_orada = 033100;
017200131001             key_oraa  = 040000;
017300131001           WHEN  ORMoao >= 040100 and ORMoao < 043100;
017400131001             key_orada = 040100;
017500131001             key_oraa  = 043000;
017600131001           WHEN  ORMoao >= 043100 and ORMoao < 050100;
017700131001             key_orada = 043100;
017800131001             key_oraa  = 050000;
017900131001           WHEN  ORMoao >= 050100 and ORMoao < 053100;
018000131001             key_orada = 050100;
018100131001             key_oraa  = 053000;
018200131001           WHEN  ORMoao >= 053100 and ORMoao < 060100;
018300131001             key_orada = 053100;
018400131001             key_oraa  = 060000;
018500131001           WHEN  ORMoao >= 060100 and ORMoao < 063100;
018600131001             key_orada = 060100;
018700131001             key_oraa  = 063000;
018800131001           WHEN  ORMoao >= 063100 and ORMoao < 070100;
018900131001             key_orada = 063100;
019000131001             key_oraa  = 070000;
019100131001           WHEN  ORMoao >= 070100 and ORMoao < 073100;
019200131001             key_orada = 073100;
019300131001             key_oraa  = 073000;
019400131001           WHEN  ORMoao >= 073100 and ORMoao < 080100;
019500131001             key_orada = 073100;
019600131001             key_oraa  = 080000;
019700131001           WHEN  ORMoao >= 080100 and ORMoao < 083100;
019800131001             key_orada = 080100;
019900131001             key_oraa  = 083000;
020000131001           WHEN  ORMoao >= 083100 and ORMoao < 090100;
020100131001             key_orada = 083100;
020200131001             key_oraa  = 090000;
020300131001           WHEN  ORMoao >= 090100 and ORMoao < 093100;
020400131001             key_orada = 090100;
020500131001             key_oraa  = 093000;
020600131001           WHEN  ORMoao >= 093100 and ORMoao < 100100;
020700131001             key_orada = 093100;
020800131001             key_oraa  = 100000;
020900131001           WHEN  ORMoao >= 100100 and ORMoao < 103100;
021000131001             key_orada = 100100;
021100131001             key_oraa  = 103000;
021200131001           WHEN  ORMoao >= 103100 and ORMoao < 110100;
021300131001             key_orada = 103100;
021400131001             key_oraa  = 110000;
021500131001           WHEN  ORMoao >= 110100 and ORMoao < 113100;
021600131001             key_orada = 110100;
021700131001             key_oraa  = 113000;
021800131001           WHEN  ORMoao >= 113100 and ORMoao < 120100;
021900131001             key_orada = 113100;
022000131001             key_oraa  = 120000;
022100131001           WHEN  ORMoao >= 120100 and ORMoao < 123100;
022200131001             key_orada = 120100;
022300131001             key_oraa  = 123000;
022400131001           WHEN  ORMoao >= 123100 and ORMoao < 130100;
022500131001             key_orada = 123100;
022600131001             key_oraa  = 130000;
022700131001           WHEN  ORMoao >= 130100 and ORMoao < 133100;
022800131001             key_orada = 130100;
022900131001             key_oraa  = 133000;
023000131001           WHEN  ORMoao >= 133100 and ORMoao < 140100;
023100131001             key_orada = 133100;
023200131001             key_oraa  = 140000;
023300131001           WHEN  ORMoao >= 140100 and ORMoao < 143100;
023400131001             key_orada = 140100;
023500131001             key_oraa  = 143000;
023600131001           WHEN  ORMoao >= 143100 and ORMoao < 150100;
023700131001             key_orada = 143100;
023800131001             key_oraa  = 150000;
023900131001           WHEN  ORMoao >= 150100 and ORMoao < 153100;
024000131001             key_orada = 150100;
024100131001             key_oraa  = 153000;
024200131001           WHEN  ORMoao >= 153100 and ORMoao < 160100;
024300131001             key_orada = 153100;
024400131001             key_oraa  = 160000;
024500131001           WHEN  ORMoao >= 160100 and ORMoao < 163100;
024600131001             key_orada = 160100;
024700131001             key_oraa  = 163000;
024800131001           WHEN  ORMoao >= 163100 and ORMoao < 170100;
024900131001             key_orada = 163100;
025000131001             key_oraa  = 170000;
025100131001           WHEN  ORMoao >= 170100 and ORMoao < 173100;
025200131001             key_orada = 170100;
025300131001             key_oraa  = 173000;
025400131001           WHEN  ORMoao >= 173100 and ORMoao < 180100;
025500131001             key_orada = 173100;
025600131001             key_oraa  = 180000;
025700131001           WHEN  ORMoao >= 180100 and ORMoao < 183100;
025800131001             key_orada = 180100;
025900131001             key_oraa  = 183000;
026000131001           WHEN  ORMoao >= 183100 and ORMoao < 190100;
026100131001             key_orada = 183100;
026200131001             key_oraa  = 190000;
026300131001           WHEN  ORMoao >= 190100 and ORMoao < 193100;
026400131001             key_orada = 190100;
026500131001             key_oraa  = 193000;
026600131001           WHEN  ORMoao >= 193100 and ORMoao < 200100;
026700131001             key_orada = 193100;
026800131001             key_oraa  = 200000;
026900131001           WHEN  ORMoao >= 200100 and ORMoao < 203100;
027000131001             key_orada = 200100;
027100131001             key_oraa  = 203000;
027200131001           WHEN  ORMoao >= 203100 and ORMoao < 210100;
027300131001             key_orada = 203100;
027400131001             key_oraa  = 210000;
027500131001           WHEN  ORMoao >= 210100 and ORMoao < 213100;
027600131001             key_orada = 210100;
027700131001             key_oraa  = 213000;
027800131001           WHEN  ORMoao >= 213100 and ORMoao < 220100;
027900131001             key_orada = 213100;
028000131001             key_oraa  = 220000;
028100131001           WHEN  ORMoao >= 220100 and ORMoao < 223100;
028200131001             key_orada = 220100;
028300131001             key_oraa  = 223000;
028400131001           WHEN  ORMoao >= 223100 and ORMoao < 230100;
028500131001             key_orada = 223100;
028600131001             key_oraa  = 230000;
028700131001           WHEN  ORMoao >= 230100 and ORMoao < 233100;
028800131001             key_orada = 230100;
028900131001             key_oraa  = 233000;
029000131001           WHEN  ORMoao >= 233100 and ORMoao < 000100;
029100131001             key_orada = 233100;
029200131001             key_oraa  = 000000;
029300131001         ENDSL;
029400080710
029500131001         chain (ORMdao:key_orada:ORMpor) WFSTAT1;
029600131001         IF  %found(WFSTAT1);
029700131001           exsr Aggiorna;
029800131001         ELSE;
029900131001           exsr Scrivi;
030000131001         ENDIF;
030100131001
030200131001       ENDSR;
030300131001
030400131001       //--------------------------------------------------------------
030500131001       //?Aggiorna.
030600131001       //--------------------------------------------------------------
030700131001       BEGSR Aggiorna;
030800131001
030900131001          totale += 1;
031000131001          update  WFSTAT;
031100131001
031200131001       ENDSR;
031300131001
031400131001       //--------------------------------------------------------------
031500131001       //?Scrive.
031600131001       //--------------------------------------------------------------
031700131001       BEGSR Scrivi;
031800131001
031900131001          clear WFSTAT;
032000131001          filiale = ORMpor;
032100131001          descri  = ORGdes;
032200131001          data    = ORMdao;
032300131001          orada   = key_orada;
032400131001          oraa    = Key_oraa;
032500131001          totale  = 1;
032600131001
032700131001          write  WFSTAT;
032800131001
032900131001       ENDSR;
033000131001
033100131001       //--------------------------------------------------------------
033200131001       //?Operazioni finali.
033300131001       //--------------------------------------------------------------
033400131001       BEGSR RoutEnd;
033500131001
033600131001         *inLR = *on;
033700131001         return;
033800131001
033900131001       ENDSR;
034000131001
034100131001      /end-free
034200131001
