000100120423      //---------------------------------------------------------------
000200120423      //
000300130430      //?      Controllo quadrature Distinte - Fase RQE
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130314
001300130430     fFIDSF02L  if   e           k disk
001400130430     fFNORM06L  if   e           k disk
001500130430     fDISTINTE  o    e             disk    rename(DISTINTE:DIST)
001600120423
001700120423      //---------------------------------------------------------------
001800120423      //?Definizione costanti.
001900120423      //---------------------------------------------------------------
002000120423
002100120423      //---------------------------------------------------------------
002200120423      //?Definizione schiere.
002300120423      //---------------------------------------------------------------
002400120423
002500120423      //---------------------------------------------------------------
002600120423      //?Definizione aree dati.
002700120423      //---------------------------------------------------------------
002800120423
002900120423      //---------------------------------------------------------------
003000120423      //?Definizione strutture dati.
003100120423      //---------------------------------------------------------------
003200130214
003300130214       // -?Parametri ricevuti?
003400130214     d kpjba         e ds
003500130304
003600130430      // -?File FIDST00F
003700130430     d FIDST00F      e ds                  extname(FIDST00F)
003800130430
003900130430      // -?Campo DSTflr
004000130430     d dDSTflr       e ds
004100120423
004200120423      //---------------------------------------------------------------
004300120423      //?Definizione variabili globali.
004400120423      //---------------------------------------------------------------
004500120423      // - Flags booleani
004600120423     d wEoF            s               n   inz(*off)
004700130430     d wRQE            s               n   inz(*off)
004800130430
004900130430      // - Campi di comodo
005000130430     d sav_DSTfgs      s                   like(DSTfgs)
005100130430     d sav_DSTdfv      s                   like(DSTdfv)
005200130430     d wdataini        s              8  0
005300130430     d wdatafin        s              8  0
005400130430     d wNrDst          s              5  0
005500130430     d wNrPda          s              5  0
005600130430     d wNrRQE          s              5  0
005700130430     d wTRD            s                   like(DSFtrd) inz('RQE')
005800120423
005900120423      //---------------------------------------------------------------
006000120423      //?Definizione procedure esterne.
006100120423      //---------------------------------------------------------------
006200120423
006300120423      //---------------------------------------------------------------
006400120423      //?Definizione prototipi.
006500120423      //---------------------------------------------------------------
006600120423
006700120423      //---------------------------------------------------------------
006800120423      //?Definizione key-list.
006900120423      //---------------------------------------------------------------
007000120423
007100120423      //---------------------------------------------------------------
007200120423      //?Riepilogo indicatori.
007300120423      //---------------------------------------------------------------
007400120423
007500120423      //---------------------------------------------------------------
007600120423      //?M A I N - L I N E
007700120423      //---------------------------------------------------------------
007800130214
007900130214     c     *Entry        plist
008000130214     c                   parm                    kpjba
008100120423
008200120423      /free
008300120423
008400120423       //?Operazioni iniziali
008500120423       exsr RoutInz;
008600120423
008700120430       //?Elabora file
008800120430       exsr Elabora;
008900120423
009000120423       //?Operazioni finali
009100120423       exsr RoutEnd;
009200120423
009300120423       //--------------------------------------------------------------
009400120423       //?Operazioni iniziali.
009500120423       //--------------------------------------------------------------
009600120423       BEGSR RoutInz;
009700120706
009800130214       //?Impostazione opzioni per SQL?
009900130214         exec sql   set  option  DynUsrPrf = *Owner,
010000130214                                 CloSqlCsr = *EndMod;
010100130430
010200130430       //?Imposto le date
010300130916         wdataini = 20130826;
010400130916         wdatafin = 20130908;
010500120423
010600120423       ENDSR;
010700130204
010800130204       //--------------------------------------------------------------
010900130204       //?Elabora
011000130204       //--------------------------------------------------------------
011100130204       BEGSR elabora;
011200130304
011300130304         wEoF = *off;
011400130304
011500130430       //?Leggo tutte le distinte delle ultime 2 settimane con ORM
011600130304         exec sql
011700130430         DECLARE DST cursor FOR
011800130314         SELECT *
011900130430         from FIDST00F
012000130430         WHERE  DSTdfv between :wdataini and :wdatafin
012100130430                and DSTatb = ''
012200130515         ORDER BY DSTfgs;
012300130430
012400130304         exec sql
012500130430         open DST;
012600130304         IF sqlcode < 0;
012700130304           wEoF = *on;
012800130304         ENDIF;
012900130304
013000130304         DOW not wEoF;
013100130304           exec sql
013200130430           FETCH NEXT from DST into :FIDST00F;
013300130304           IF sqlcod = 100 or sqlcod < 0;
013400130304             wEOF = *on;
013500130304             leave;
013600130304           ENDIF;
013700130430
013800130430           dDSTflr = DSTflr;
013900130430
014000130515           IF  sav_DSTfgs <> DSTfgs;
014100130515             IF  sav_DSTfgs <> *zeros and wNrDst > 0;
014200130430           //?Scrivo file di work
014300130430               clear  DIST;
014400130430               dfgs = DSTfgs;
014500130515              // ddfv = DSTdfv;
014600130430               nrdst = %editc(wNrDst:'4');
014700130430               nrrqe = %editc(wNrRQE:'4');
014800130430               nrpda = %editc(wNrPda:'4');
014900130430               write  DIST;
015000130430             ENDIF;
015100130430             clear wNrDst;
015200130430             clear wNrPda;
015300130430             clear wNrRQE;
015400130515            // sav_DSTdfv = DSTdfv;
015500130430             sav_DSTfgs = DSTfgs;
015600130430           ENDIF;
015700130314
015800130430       //?Controllo se ha ORM
015900130430           chain (DSTfgs:DSTnfv) FNORM06L;
016000130430           IF  not %found(FNORM06L);
016100130430             iter;
016200130314           ENDIF;
016300130430
016400130430           wNrDst += 1;
016500130430
016600130430       //?Controllo se ha il PDA non in test
016700130430          IF  DSTpda <> 'N' and §DSTtstpda = *blanks;
016800130430            wNrPda += 1;
016900130430          ENDIF;
017000130430
017100130430       //?Controllo se ha la fase RQE
017200130430          chain (DSTnpg:DSTnfv:DSTfgs:wTRD) FIDSF02L;
017300130430          IF  not %found(FIDSF02L);
017400130430            wNrRQE += 1;
017500130430          ENDIF;
017600130304
017700130304         ENDDO;
017800130304
017900130304       //?Chiudo il cursore
018000130304         exec sql
018100130430           close DST;
018200130204
018300130204       ENDSR;
018400130125
018500120423       //--------------------------------------------------------------
018600120423       //?Operazioni finali.
018700120423       //--------------------------------------------------------------
018800120423       BEGSR RoutEnd;
018900120423
019000120423         *inLR = *on;
019100120423         return;
019200120423
019300120423       ENDSR;
019400051221
019500051221      /end-free
019600051221
