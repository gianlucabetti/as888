000100100413      //---------------------------------------------------------------
000200140716      //?TNVRMB21R - Prg. 823 Mod. Info Commerciali
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000140716     fTICPI01L  uf a e           k disk
001100100413
001200100413      //---------------------------------------------------------------
001300100413      //?Definizione costanti.
001400100413      //---------------------------------------------------------------
001500100413
001600100413      //---------------------------------------------------------------
001700100413      //?Definizione schiere.
001800100413      //---------------------------------------------------------------
001900090715
002000100413      //---------------------------------------------------------------
002100100413      //?Definizione aree dati.
002200100413      //---------------------------------------------------------------
002300100413
002400100413      //---------------------------------------------------------------
002500100413      //?Definizione strutture dati.
002600100413      //---------------------------------------------------------------
002700140716
002800140716      // Info commerciali
002900140716     d TICPIds       e ds                  extname(TICPI00F)
003000100423
003100140716      // Info commerciali
003200140716     d TICPIsds      e ds                  extname(TICPI00F) prefix(s)
003300100415
003400100413      //---------------------------------------------------------------
003500100413      //?Definizione variabili globali.
003600100413      //---------------------------------------------------------------
003700100413
003800100413      // - Flags booleani
003900140714     d wEnd            s               n   inz(*off)
004000100413
004100100413      // - Campi di comodo
004200100413
004300100413      //---------------------------------------------------------------
004400100413      //?Definizione procedure esterne.
004500100413      //---------------------------------------------------------------
004600100413
004700100413      //---------------------------------------------------------------
004800140714      //?Definizione prototipi.
004900100413      //---------------------------------------------------------------
005000100413
005100100413      //---------------------------------------------------------------
005200100413      //?Definizione key-list.
005300100413      //---------------------------------------------------------------
005400100413
005500100413      //---------------------------------------------------------------
005600100413      //?Riepilogo indicatori.
005700100413      //---------------------------------------------------------------
005800100413
005900100413      //---------------------------------------------------------------
006000100413      //?M A I N - L I N E
006100100413      //---------------------------------------------------------------
006200100413
006300100413      /free
006400110304
006500140716       //?Unifico PRO (IT-Messag.Espressa) con MES (IT-Messag.Tradizionale)
006600140716       //?unica info PRO
006700140716       exsr Elabora_PRO;
006800140716
006900140716       //?Unifico PRI (Sped. a Privati) con ECM (Sped. da E-Commerce)
007000140716       //?unica info PRI
007100140716       exsr Elabora_PRI;
007200100413
007300100413       //?Operazioni finali
007400110304       exsr RoutEnd;
007500100420
007600100413       //--------------------------------------------------------------
007700140716       //?Elabora INFO PRO.
007800100413       //--------------------------------------------------------------
007900140716       BEGSR Elabora_PRO;
008000110304
008100140714         wEnd = *off;
008200110304
008300140716         //?Con SQL leggo le sole INFO MES
008400110304         exec sql
008500140716         DECLARE INFOMES cursor for
008600140716         SELECT *
008700140716         FROM TICPI00F
008800140716         WHERE CPItpf = 'MES'
008900140716         ORDER by CPIcpo;
009000110304
009100110304         //?Apertura del cursore
009200140716         exec sql open INFOMES;
009300110304
009400110304         IF sqlcode < 0;
009500140714           wEnd = *on;
009600110304         ENDIF;
009700110304
009800140714         DOW not wEnd;
009900110304
010000140716           exec sql FETCH next from INFOMES into :TICPIsds;
010100110304
010200110304           IF sqlcod = 100 or sqlcod < 0;
010300140714             wEnd = *on;
010400110304             leave;
010500110304           ENDIF;
010600110304
010700140716           chain (sCPIcpo:'PRO') TICPI01L;
010800140716           IF  %found(TICPI01L);
010900140716             CPIval += sCPIval;
011000140717             IF  sCpidim > CPIdim;
011100140717               CPIdim = sCpidim;
011200140717               CPIfil = sCPIfil;
011300140717               CPIpru = sCPIpru;
011400140717             ENDIF;
011500140716             update TICPI000;
011600140716           ENDIF;
011700140716           IF  not %found(TICPI01L);
011800140716             clear TICPI000;
011900140716             TICPIds = TICPIsds;
012000140716             CPItpf = 'PRO';
012100140716             write TICPI000;
012200140714           ENDIF;
012300110304
012400110304         ENDDO;
012500110304
012600110304         //?chiudo il cursore
012700140716         exec sql CLOSE INFOMES;
012800100423
012900100423       ENDSR;
013000110304
013100140716       //--------------------------------------------------------------
013200140716       //?Elabora INFO PRI.
013300140716       //--------------------------------------------------------------
013400140716       BEGSR Elabora_PRI;
013500140716
013600140716         wEnd = *off;
013700140716
013800140716         //?Con SQL leggo le sole INFO ECM
013900140716         exec sql
014000140716         DECLARE INFOECM cursor for
014100140716         SELECT *
014200140716         FROM TICPI00F
014300140716         WHERE CPItpf = 'ECM'
014400140716         ORDER by CPIcpo;
014500140716
014600140716         //?Apertura del cursore
014700140716         exec sql open INFOECM;
014800140716
014900140716         IF sqlcode < 0;
015000140716           wEnd = *on;
015100140716         ENDIF;
015200140716
015300140716         DOW not wEnd;
015400140716
015500140716           exec sql FETCH next from INFOECM into :TICPIsds;
015600140716
015700140716           IF sqlcod = 100 or sqlcod < 0;
015800140716             wEnd = *on;
015900140716             leave;
016000140716           ENDIF;
016100140716
016200140716           chain (sCPIcpo:'PRI') TICPI01L;
016300140716           IF  %found(TICPI01L);
016400140716             IF  sCPIval > CPIval;
016500140716               CPIval = sCPIval;
016600140716             ENDIF;
016700140717             IF  sCpidim > CPIdim;
016800140717               CPIdim = sCpidim;
016900140717               CPIfil = sCPIfil;
017000140717               CPIpru = sCPIpru;
017100140717             ENDIF;
017200140716             update TICPI000;
017300140716           ENDIF;
017400140716           IF  not %found(TICPI01L);
017500140716             clear TICPI000;
017600140716             TICPIds = TICPIsds;
017700140716             CPItpf = 'PRI';
017800140716             write TICPI000;
017900140716           ENDIF;
018000140716
018100140716         ENDDO;
018200140716
018300140716         //?chiudo il cursore
018400140716         exec sql CLOSE INFOECM;
018500140716
018600140716       ENDSR;
018700100426
018800100413       //--------------------------------------------------------------
018900100413       //?Operazioni finali.
019000100413       //--------------------------------------------------------------
019100110304       BEGSR RoutEnd;
019200100413
019300100413         *inLR = *on;
019400100413         return;
019500100413
019600100413       ENDSR;
019700100413
019800100413      /end-free
