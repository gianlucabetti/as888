000100150506      //---------------------------------------------------------------
000200150506      //?TNVRMB28R - Spalma note 89 - 82 - 85
000300150506      //---------------------------------------------------------------
000400150506
000500150506     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600150506
000700150506      //---------------------------------------------------------------
000800150506      //?Dichiarazione file.
000900150506      //---------------------------------------------------------------
001000150506     fTFNTC01L  if   e           k disk    rename(TFNTC:TFNTC01)
001100150506     f                                     prefix(w)
001200150506     fTIVIS05L  if   e           k disk
001300150506     fTFNTC00F  o    e             disk
001400150506
001500150506      //---------------------------------------------------------------
001600150506      //?Definizione costanti.
001700150506      //---------------------------------------------------------------
001800150506
001900150506      //---------------------------------------------------------------
002000150506      //?Definizione schiere.
002100150506      //---------------------------------------------------------------
002200150506
002300150506      //---------------------------------------------------------------
002400150506      //?Definizione aree dati.
002500150506      //---------------------------------------------------------------
002600150506
002700150506      //---------------------------------------------------------------
002800150506      //?Definizione strutture dati.
002900150506      //---------------------------------------------------------------
003000150506
003100150506     d KPJBA         e ds
003200150506
003300150506      // - File TFACO
003400150506     d TFACODS       e ds                  extname(TFACO00F)
003500150506
003600150506      //---------------------------------------------------------------
003700150506      //?Definizione variabili globali.
003800150506      //---------------------------------------------------------------
003900150506
004000150506      // - Flags booleani
004100150506     d wEnd            s               n   inz(*off)
004200150506     d wNo82           s               n   inz(*off)
004300150506     d wNo85           s               n   inz(*off)
004400150506     d wNo89           s               n   inz(*off)
004500150506     d wSi06           s               n   inz(*off)
004600150506     d wSi84           s               n   inz(*off)
004700150506
004800150506      // - Campi di comodo
004900150506     d wAPL            s                   like(NTCapl) inz('T')
005000150527     d wData           s              6  0 inz(150531)
005100150506     d wNK1            s                   like(NTCnk1) inz
005200150506     d wNK2            s                   like(NTCnk2) inz
005300150506     d wTNT            s                   like(NTCtnt) inz
005400150506     d wTNTda          s                   like(NTCtnt) inz
005500150506     d w0070           s              7  0 inz
005600150506
005700150506      //---------------------------------------------------------------
005800150506      //?Definizione procedure esterne.
005900150506      //---------------------------------------------------------------
006000150506
006100150506      //---------------------------------------------------------------
006200150506      //?Definizione prototipi.
006300150506      //---------------------------------------------------------------
006400150506
006500150506      //---------------------------------------------------------------
006600150506      //?Definizione key-list.
006700150506      //---------------------------------------------------------------
006800150506
006900150506      //---------------------------------------------------------------
007000150506      //?Riepilogo indicatori.
007100150506      //---------------------------------------------------------------
007200150506
007300150506      //---------------------------------------------------------------
007400150506      //?M A I N - L I N E
007500150506      //---------------------------------------------------------------
007600150506
007700150506     c     *Entry        plist
007800150506     c                   parm                    kpjba
007900150506
008000150506      /free
008100150506
008200150506       //?Operazioni iniziali
008300150506       exsr RoutInz;
008400150506
008500150506       //?Elaboro solo i clienti con fatturato nel 2015
008600150506       exsr Elabora;
008700150506
008800150506       //?Operazioni finali
008900150506       exsr RoutEnd;
009000150506
009100150506       //--------------------------------------------------------------
009200150506       //?Operazioni iniziali.
009300150506       //--------------------------------------------------------------
009400150506       BEGSR RoutInz;
009500150506
009600150506         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
009700150506
009800150506       ENDSR;
009900150506
010000150506       //--------------------------------------------------------------
010100150506       //?Elaboro clienti.
010200150506       //--------------------------------------------------------------
010300150506       BEGSR Elabora;
010400150506
010500150506         wEnd = *off;
010600150506         wNo82 = *off;
010700150506         wNo85 = *off;
010800150506         wNo89 = *off;
010900150506         wSi06 = *off;
011000150506         wSi84 = *off;
011100150506
011200150506       //?Estraggo i clienti
011300150506         exec sql
011400150506         DECLARE TFACO cursor for
011500150506         SELECT  *
011600150506         FROM TFACO00F
011700150506         WHERE ACOkcc = 151
011800150506         ORDER by ACOksc;
011900150506
012000150506         exec sql OPEN TFACO;
012100150506
012200150506         DOW  not wEnd;
012300150506           exec sql FETCH next from TFACO into :TFACODS;
012400150506
012500150506           IF  sqlcod = 100 or sqlcod < 0;
012600150506             wEnd = *on;
012700150506             leave;
012800150506           ENDIF;
012900150506
013000150507         //?Controllo se trattativa aperta e/o fittizia
013100150506           chain ACOksc TIVIS05L;
013200150507           IF  VISdch > *zeros;
013300150506             iter;
013400150506           ENDIF;
013500150507           IF  VISffz <> *blanks;
013600150507             iter;
013700150507           ENDIF;
013800150506
013900150506         //?Dati per chiave File Note
014000150506           wNK1 = %editc(ACOkcc:'X') + %editc(ACOksc:'X');
014100150506
014200150506         //?Controllo se ha la nota 89
014300150506           exsr Ctr89;
014400150506
014500150506         //?Controllo se ha la nota 82
014600150506           exsr Ctr82;
014700150506
014800150506         //?Controllo se ha la nota 85
014900150506           exsr Ctr85;
015000150506
015100150506         //?Se non ha tutte e 3 le note
015200150506           IF  wNo89 and wNo82 and wNo85;
015300150506           //?Controllo se ha la nota 84
015400150506             exsr Ctr84;
015500150506           //?Controllo se ha la nota 06
015600150506             exsr Ctr06;
015700150506           ENDIF;
015800150506
015900150506           SELECT;
016000150506
016100150506         //?Se ha tutte e 3 le note  OK
016200150506           WHEN  not wNo89 and not wNo82 and not wNo85;
016300150506
016400150506         //?Se non ha tutte e 3 le note
016500150506           WHEN  wNo89 and wNo82 and wNo85;
016600150506           //?Scrivo dalla 84
016700150506             IF  wSi84;
016800150506               wTNTda = '84';
016900150506               wTNT = '89';
017000150506               exsr WrtNota;
017100150506               wTNT = '82';
017200150506               exsr WrtNota;
017300150506               wTNT = '85';
017400150506               exsr WrtNota;
017500150506             ENDIF;
017600150506           //?Scrivo dalla 06
017700150506             IF  not wSi84 and wSi06;
017800150506               wTNTda = '06';
017900150506               wTNT = '89';
018000150506               exsr WrtNota;
018100150506               wTNT = '82';
018200150506               exsr WrtNota;
018300150506               wTNT = '85';
018400150506               exsr WrtNota;
018500150506             ENDIF;
018600150506
018700150506         //?Se ha la nota 89
018800150506           WHEN  not wNo89 and (wNo82 or wNo85);
018900150506             wTNTda = '89';
019000150506             IF  wNo82;
019100150506               wTNT = '82';
019200150506               exsr WrtNota;
019300150506             ENDIF;
019400150506             IF  wNo85;
019500150506               wTNT = '85';
019600150506               exsr WrtNota;
019700150506             ENDIF;
019800150506
019900150506         //?Se ha la nota 82
020000150506           WHEN  not wNo82;
020100150506             wTNTda = '82';
020200150506             IF  wNo89;
020300150506               wTNT = '89';
020400150506               exsr WrtNota;
020500150506             ENDIF;
020600150506             IF  wNo85;
020700150506               wTNT = '85';
020800150506               exsr WrtNota;
020900150506             ENDIF;
021000150506
021100150506         //?Se ha la nota 85
021200150506           WHEN  not wNo85;
021300150506             wTNTda = '85';
021400150506             IF  wNo89;
021500150506               wTNT = '89';
021600150506               exsr WrtNota;
021700150506             ENDIF;
021800150506             IF  wNo82;
021900150506               wTNT = '82';
022000150506               exsr WrtNota;
022100150506             ENDIF;
022200150506
022300150506           ENDSL;
022400150506
022500150506         ENDDO;
022600150506
022700150506         exec sql CLOSE TFACO;
022800150506
022900150506       ENDSR;
023000150506
023100150506       //--------------------------------------------------------------
023200150506       //?Controllo se esiste la nota 06.
023300150506       //--------------------------------------------------------------
023400150506       BEGSR Ctr06;
023500150506
023600150506         wSi06 = *off;
023700150506         wTNTda = '06';
023800150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
023900150506         IF  %found(TFNTC01L);
024000150506           wSi06 = *on;
024100150506         ENDIF;
024200150506
024300150506       ENDSR;
024400150506
024500150506       //--------------------------------------------------------------
024600150506       //?Controllo se esiste la nota 82.
024700150506       //--------------------------------------------------------------
024800150506       BEGSR Ctr82;
024900150506
025000150506         wNo82 = *off;
025100150506         wTNTda = '82';
025200150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
025300150506         IF  not %found(TFNTC01L);
025400150506           wNo82 = *on;
025500150506         ENDIF;
025600150506
025700150506       ENDSR;
025800150506
025900150506       //--------------------------------------------------------------
026000150506       //?Controllo se esiste la nota 84.
026100150506       //--------------------------------------------------------------
026200150506       BEGSR Ctr84;
026300150506
026400150506         wSi84 = *off;
026500150506         wTNTda = '84';
026600150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
026700150506         IF  %found(TFNTC01L);
026800150506           wSi84 = *on;
026900150506         ENDIF;
027000150506
027100150506       ENDSR;
027200150506
027300150506       //--------------------------------------------------------------
027400150506       //?Controllo se esiste la nota 85.
027500150506       //--------------------------------------------------------------
027600150506       BEGSR Ctr85;
027700150506
027800150506         wNo85 = *off;
027900150506         wTNTda = '85';
028000150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
028100150506         IF  not %found(TFNTC01L);
028200150506           wNo85 = *on;
028300150506         ENDIF;
028400150506
028500150506       ENDSR;
028600150506
028700150506       //--------------------------------------------------------------
028800150506       //?Controllo se esiste la nota 89.
028900150506       //--------------------------------------------------------------
029000150506       BEGSR Ctr89;
029100150506
029200150506         wNo89 = *off;
029300150506         wTNTda = '89';
029400150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
029500150506         IF  not %found(TFNTC01L);
029600150506           wNo89 = *on;
029700150506         ENDIF;
029800150506
029900150506       ENDSR;
030000150506
030100150506       //--------------------------------------------------------------
030200150506       //?Scrivo la nota.
030300150506       //--------------------------------------------------------------
030400150506       BEGSR WrtNota;
030500150506
030600150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
030700150506         IF  %found(TFNTC01L);
030800150506           clear TFNTC;
030900150506           NTCapl = wNTCapl;
031000150506           NTCnk1 = wNTCnk1;
031100150506           NTCnk2 = wNTCnk2;
031200150506           NTCtnt = wTNT;
031300150506           NTCrnt = wNTCrnt;
031400150506           NTCsns = wNTCsns;
031500150506           NTCflt = wNTCflt;
031600150506           NTCntr = wdata;
031700150506           write TFNTC;
031800150506         ENDIF;
031900150506
032000150506       ENDSR;
032100150506
032200150506       //--------------------------------------------------------------
032300150506       //?Operazioni finali.
032400150506       //--------------------------------------------------------------
032500150506       BEGSR RoutEnd;
032600150506
032700150506         *inLR = *on;
032800150506         return;
032900150506
033000150506       ENDSR;
033100150506
033200150506      /end-free
