000100150506      //---------------------------------------------------------------
000200150506      //?TNVRMB27R - Spalma note 89 - 82 - 85
000300150506      //---------------------------------------------------------------
000400150506
000500150506     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600150506
000700150506      //---------------------------------------------------------------
000800150506      //?Dichiarazione file.
000900150506      //---------------------------------------------------------------
001000150506     fTFNTC01L  if   e           k disk    rename(TFNTC:TFNTC01)
001100150506     f                                     prefix(w)
001200150506     fTFNTC00F  o    e             disk
001300150506     fCNACO00F  if   e           k disk
001400150506
001500150506      //---------------------------------------------------------------
001600150506      //?Definizione costanti.
001700150506      //---------------------------------------------------------------
001800150506
001900150506      //---------------------------------------------------------------
002000150506      //?Definizione schiere.
002100150506      //---------------------------------------------------------------
002200150506
002300150506      //---------------------------------------------------------------
002400150506      //?Definizione aree dati.
002500150506      //---------------------------------------------------------------
002600150506
002700150506      //---------------------------------------------------------------
002800150506      //?Definizione strutture dati.
002900150506      //---------------------------------------------------------------
003000150506
003100150506     d KPJBA         e ds
003200150506
003300150506      // - File CNCLP
003400150506     d CNCLPDS       e ds                  extname(CNCLP00F)
003500150506
003600150506      //---------------------------------------------------------------
003700150506      //?Definizione variabili globali.
003800150506      //---------------------------------------------------------------
003900150506
004000150506      // - Flags booleani
004100150506     d wEnd            s               n   inz(*off)
004200150506     d wNoACO          s               n   inz(*off)
004300150506     d wNo06           s               n   inz(*off)
004400150506     d wNo82           s               n   inz(*off)
004500150506     d wNo84           s               n   inz(*off)
004600150506     d wNo85           s               n   inz(*off)
004700150506     d wNo89           s               n   inz(*off)
004800150506
004900150506      // - Campi di comodo
005000150506     d wAPL            s                   like(NTCapl) inz('C')
005100150506     d wData           s              6  0 inz(150506)
005200150506     d wDataa          s              6  0 inz(151231)
005300150506     d wDatada         s              6  0 inz(150101)
005400150506     d wNK1            s                   like(NTCnk1) inz
005500150506     d wNK2            s                   like(NTCnk2) inz
005600150506     d wTNT            s                   like(NTCtnt) inz
005700150506     d wTNTda          s                   like(NTCtnt) inz
005800150506     d w0070           s              7  0 inz
005900150506
006000150506      //---------------------------------------------------------------
006100150506      //?Definizione procedure esterne.
006200150506      //---------------------------------------------------------------
006300150506
006400150506      //---------------------------------------------------------------
006500150506      //?Definizione prototipi.
006600150506      //---------------------------------------------------------------
006700150506
006800150506      //---------------------------------------------------------------
006900150506      //?Definizione key-list.
007000150506      //---------------------------------------------------------------
007100150506
007200150506      //---------------------------------------------------------------
007300150506      //?Riepilogo indicatori.
007400150506      //---------------------------------------------------------------
007500150506
007600150506      //---------------------------------------------------------------
007700150506      //?M A I N - L I N E
007800150506      //---------------------------------------------------------------
007900150506
008000150506     c     *Entry        plist
008100150506     c                   parm                    kpjba
008200150506
008300150506      /free
008400150506
008500150506       //?Operazioni iniziali
008600150506       exsr RoutInz;
008700150506
008800150506       //?Elaboro solo i clienti con fatturato nel 2015
008900150506       exsr Elabora;
009000150506
009100150506       //?Operazioni finali
009200150506       exsr RoutEnd;
009300150506
009400150506       //--------------------------------------------------------------
009500150506       //?Operazioni iniziali.
009600150506       //--------------------------------------------------------------
009700150506       BEGSR RoutInz;
009800150506
009900150506         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
010000150506
010100150506       ENDSR;
010200150506
010300150506       //--------------------------------------------------------------
010400150506       //?Elaboro clienti.
010500150506       //--------------------------------------------------------------
010600150506       BEGSR Elabora;
010700150506
010800150506         wEnd = *off;
010900150506         wNoAco = *off;
011000150506         wNo06 = *off;
011100150506         wNo82 = *off;
011200150506         wNo84 = *off;
011300150506         wNo85 = *off;
011400150506         wNo89 = *off;
011500150506
011600150506       //?Estraggo solo i clienti con fatturato nel 2015
011700150506         exec sql
011800150506         DECLARE CNCLP cursor for
011900150506         SELECT  *
012000150506         FROM CNCLP00F
012100150506         WHERE CLPkcc = 151 and CLPdus between :wdatada and
012200150506                                               :wdataa
012300150506         ORDER by CLPksc;
012400150506
012500150506         exec sql OPEN CNCLP;
012600150506
012700150506         DOW  not wEnd;
012800150506           exec sql FETCH next from CNCLP into :CNCLPDS;
012900150506
013000150506           IF  sqlcod = 100 or sqlcod < 0;
013100150506             wEnd = *on;
013200150506             leave;
013300150506           ENDIF;
013400150506
013500150506         //?Controllo se esiste il cliente su CNACO
013600150506         //?Se NON trovo CNACO leggo altro rcd
013700150506           exsr CtrAco;
013800150506           IF  wNoAco;
013900150506             iter;
014000150506           ENDIF;
014100150506
014200150506         //?Dati per chiave File Note
014300150506           wNK1 = %editc(CLPkcc:'X') + %editc(CLPksc:'X');
014400150506
014500150506         //?Controllo se ha la nota 89
014600150506           exsr Ctr89;
014700150506
014800150506         //?Controllo se ha la nota 82
014900150506           exsr Ctr82;
015000150506
015100150506         //?Controllo se ha la nota 85
015200150506           exsr Ctr85;
015300150506
015400150506         //?Se non ha tutte e 3 le note
015500150506           IF  wNo89 and wNo82 and wNo85;
015600150506           //?Controllo se ha la nota 84
015700150506             exsr Ctr84;
015800150506           //?Controllo se ha la nota 06
015900150506             exsr Ctr06;
016000150506           ENDIF;
016100150506
016200150506           SELECT;
016300150506
016400150506         //?Se ha tutte e 3 le note  OK
016500150506           WHEN  not wNo89 and not wNo82 and not wNo85;
016600150506
016700150506         //?Se non ha tutte e 3 le note
016800150506           WHEN  wNo89 and wNo82 and wNo85;
016900150506           //?Scrivo dalla 84
017000150506             IF  wNo84;
017100150506               wTNTda = '84';
017200150506               wTNT = '89';
017300150506               exsr WrtNota;
017400150506               wTNT = '82';
017500150506               exsr WrtNota;
017600150506               wTNT = '85';
017700150506               exsr WrtNota;
017800150506             ENDIF;
017900150506           //?Scrivo dalla 06
018000150506             IF  not wNo84 and wNo06;
018100150506               wTNTda = '06';
018200150506               wTNT = '89';
018300150506               exsr WrtNota;
018400150506               wTNT = '82';
018500150506               exsr WrtNota;
018600150506               wTNT = '85';
018700150506               exsr WrtNota;
018800150506             ENDIF;
018900150506
019000150506         //?Se ha la nota 89
019100150506           WHEN  not wNo89 and (wNo82 or wNo85);
019200150506             wTNTda = '89';
019300150506             IF  wNo82;
019400150506               wTNT = '82';
019500150506               exsr WrtNota;
019600150506             ENDIF;
019700150506             IF  wNo85;
019800150506               wTNT = '85';
019900150506               exsr WrtNota;
020000150506             ENDIF;
020100150506
020200150506         //?Se ha la nota 82
020300150506           WHEN  not wNo82;
020400150506             wTNTda = '82';
020500150506             IF  wNo89;
020600150506               wTNT = '89';
020700150506               exsr WrtNota;
020800150506             ENDIF;
020900150506             IF  wNo85;
021000150506               wTNT = '85';
021100150506               exsr WrtNota;
021200150506             ENDIF;
021300150506
021400150506         //?Se ha la nota 85
021500150506           WHEN  not wNo85;
021600150506             wTNTda = '85';
021700150506             IF  wNo89;
021800150506               wTNT = '89';
021900150506               exsr WrtNota;
022000150506             ENDIF;
022100150506             IF  wNo82;
022200150506               wTNT = '82';
022300150506               exsr WrtNota;
022400150506             ENDIF;
022500150506
022600150506           ENDSL;
022700150506
022800150506         ENDDO;
022900150506
023000150506         exec sql CLOSE CNCLP;
023100150506
023200150506       ENDSR;
023300150506
023400150506       //--------------------------------------------------------------
023500150506       //?Controllo se esiste il cliente su CNACO.
023600150506       //--------------------------------------------------------------
023700150506       BEGSR CtrAco;
023800150506
023900150506         wNoAco = *off;
024000150506         chain (CLPkut:CLPkcc:CLPksc) CNACO00F;
024100150506         IF  not %found(CNACO00F);
024200150506           wNoAco = *on;
024300150506         ENDIF;
024400150506
024500150506       ENDSR;
024600150506
024700150506       //--------------------------------------------------------------
024800150506       //?Controllo se esiste la nota 06.
024900150506       //--------------------------------------------------------------
025000150506       BEGSR Ctr06;
025100150506
025200150506         wNo06 = *off;
025300150506         wTNTda = '06';
025400150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
025500150506         IF  not %found(TFNTC01L);
025600150506           wNo06 = *on;
025700150506         ENDIF;
025800150506
025900150506       ENDSR;
026000150506
026100150506       //--------------------------------------------------------------
026200150506       //?Controllo se esiste la nota 82.
026300150506       //--------------------------------------------------------------
026400150506       BEGSR Ctr82;
026500150506
026600150506         wNo82 = *off;
026700150506         wTNTda = '82';
026800150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
026900150506         IF  not %found(TFNTC01L);
027000150506           wNo82 = *on;
027100150506         ENDIF;
027200150506
027300150506       ENDSR;
027400150506
027500150506       //--------------------------------------------------------------
027600150506       //?Controllo se esiste la nota 84.
027700150506       //--------------------------------------------------------------
027800150506       BEGSR Ctr84;
027900150506
028000150506         wNo84 = *off;
028100150506         wTNTda = '84';
028200150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
028300150506         IF  not %found(TFNTC01L);
028400150506           wNo84 = *on;
028500150506         ENDIF;
028600150506
028700150506       ENDSR;
028800150506
028900150506       //--------------------------------------------------------------
029000150506       //?Controllo se esiste la nota 85.
029100150506       //--------------------------------------------------------------
029200150506       BEGSR Ctr85;
029300150506
029400150506         wNo85 = *off;
029500150506         wTNTda = '85';
029600150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
029700150506         IF  not %found(TFNTC01L);
029800150506           wNo85 = *on;
029900150506         ENDIF;
030000150506
030100150506       ENDSR;
030200150506
030300150506       //--------------------------------------------------------------
030400150506       //?Controllo se esiste la nota 89.
030500150506       //--------------------------------------------------------------
030600150506       BEGSR Ctr89;
030700150506
030800150506         wNo89 = *off;
030900150506         wTNTda = '89';
031000150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
031100150506         IF  not %found(TFNTC01L);
031200150506           wNo89 = *on;
031300150506         ENDIF;
031400150506
031500150506       ENDSR;
031600150506
031700150506       //--------------------------------------------------------------
031800150506       //?Scrivo la nota.
031900150506       //--------------------------------------------------------------
032000150506       BEGSR WrtNota;
032100150506
032200150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
032300150506         IF  %found(TFNTC01L);
032400150506           clear TFNTC;
032500150506           NTCapl = wNTCapl;
032600150506           NTCnk1 = wNTCnk1;
032700150506           NTCnk2 = wNTCnk2;
032800150506           NTCtnt = wTNT;
032900150506           NTCrnt = wNTCrnt;
033000150506           NTCsns = wNTCsns;
033100150506           NTCflt = wNTCflt;
033200150506           NTCntr = wdata;
033300150506           write TFNTC;
033400150506         ENDIF;
033500150506
033600150506       ENDSR;
033700150506
033800150506       //--------------------------------------------------------------
033900150506       //?Operazioni finali.
034000150506       //--------------------------------------------------------------
034100150506       BEGSR RoutEnd;
034200150506
034300150506         *inLR = *on;
034400150506         return;
034500150506
034600150506       ENDSR;
034700150506
034800150506      /end-free
