000100120423      //---------------------------------------------------------------
000200120423      //
000300150610      //?      Imposto tipo pagamento 2 se IBAN SM
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130314
001300150611     fTFCLP00F  uf   e           k disk
001400150611     fTFCLS01L  uf   e           k disk
001500120423
001600120423      //---------------------------------------------------------------
001700120423      //?Definizione costanti.
001800120423      //---------------------------------------------------------------
001900120423
002000120423      //---------------------------------------------------------------
002100120423      //?Definizione schiere.
002200120423      //---------------------------------------------------------------
002300120423
002400120423      //---------------------------------------------------------------
002500120423      //?Definizione aree dati.
002600120423      //---------------------------------------------------------------
002700120423
002800120423      //---------------------------------------------------------------
002900120423      //?Definizione strutture dati.
003000120423      //---------------------------------------------------------------
003100130214
003200130214       // -?Parametri ricevuti?
003300130214     d kpjba         e ds
003400150610
003500150611      // - File TFCLP
003600150611     d TFCLPDS       e ds                  extname(TFCLP00F)
003700150610     d                                     prefix(w)
003800150610
003900150611      // - File TFCBA00F
004000150611     d TFCBA00F      e ds                  extname(TFCBA00F)
004100120423
004200120423      //---------------------------------------------------------------
004300120423      //?Definizione variabili globali.
004400120423      //---------------------------------------------------------------
004500120423      // - Flags booleani
004600120423     d wEoF            s               n   inz(*off)
004700120423
004800150610      // - Campi di comodo
004900150610
005000120423      //---------------------------------------------------------------
005100120423      //?Definizione procedure esterne.
005200120423      //---------------------------------------------------------------
005300120423
005400120423      //---------------------------------------------------------------
005500120423      //?Definizione prototipi.
005600120423      //---------------------------------------------------------------
005700120423
005800120423      //---------------------------------------------------------------
005900120423      //?Definizione key-list.
006000120423      //---------------------------------------------------------------
006100120423
006200120423      //---------------------------------------------------------------
006300120423      //?Riepilogo indicatori.
006400120423      //---------------------------------------------------------------
006500120423
006600120423      //---------------------------------------------------------------
006700120423      //?M A I N - L I N E
006800120423      //---------------------------------------------------------------
006900130214
007000130214     c     *Entry        plist
007100130214     c                   parm                    kpjba
007200120423
007300120423      /free
007400120423
007500120423       //?Operazioni iniziali
007600120423       exsr RoutInz;
007700120423
007800120430       //?Elabora file
007900120430       exsr Elabora;
008000120423
008100120423       //?Operazioni finali
008200120423       exsr RoutEnd;
008300120423
008400120423       //--------------------------------------------------------------
008500120423       //?Operazioni iniziali.
008600120423       //--------------------------------------------------------------
008700120423       BEGSR RoutInz;
008800120706
008900130214       //?Impostazione opzioni per SQL?
009000130214         exec sql   set  option  DynUsrPrf = *Owner,
009100130214                                 CloSqlCsr = *EndMod;
009200120423
009300120423       ENDSR;
009400130204
009500130204       //--------------------------------------------------------------
009600130204       //?Elabora
009700130204       //--------------------------------------------------------------
009800130204       BEGSR elabora;
009900130304
010000130304         wEoF = *off;
010100130304
010200150611       //?Leggo TFCLP
010300150610       //?clienti con tipo pagamento 6 e IBAN SM
010400130304         exec sql
010500150610         DECLARE CLP cursor FOR
010600130314         SELECT *
010700150611         from TFCLP00F
010800150610         where CLPfpc = '6' and substr(CLPbab, 1, 2) = 'SM'
010900150610         order by CLPksc;
011000130304
011100130304         exec sql
011200150610         open CLP;
011300130304         IF sqlcode < 0;
011400130304           wEoF = *on;
011500130304         ENDIF;
011600130304
011700130304         DOW not wEoF;
011800130304           exec sql
011900150611           FETCH NEXT from CLP into :TFCLPDS;
012000130304           IF sqlcod = 100 or sqlcod < 0;
012100130304             wEOF = *on;
012200130304             leave;
012300130304           ENDIF;
012400150610
012500150610         //?Aggiorno
012600150611           chain (wCLPkut:wCLPkcc:wCLPksc) TFCLP00F;
012700150611           IF  %found(TFCLP00F);
012800150610             CLPfpc = '2';
012900150611             update CNCLP000;
013000150610           ENDIF;
013100130304
013200130304         ENDDO;
013300130304
013400130304       //?Chiudo il cursore
013500130304         exec sql
013600150610           close CLP;
013700150610
013800150610         wEoF = *off;
013900150610
014000150611       //?Leggo TFCBA
014100150610       //?clienti con IBAN SM
014200150610         exec sql
014300150610         DECLARE CBA cursor FOR
014400150610         SELECT *
014500150611         from TFCBA00F
014600150610         where substr(CBAiban, 1, 2) = 'SM'
014700150610         order by CBAksc, CBApag;
014800150610
014900150610         exec sql
015000150610         open CBA;
015100150610         IF sqlcode < 0;
015200150610           wEoF = *on;
015300150610         ENDIF;
015400150610
015500150610         DOW not wEoF;
015600150610           exec sql
015700150611           FETCH NEXT from CBA into :TFCBA00F;
015800150610           IF sqlcod = 100 or sqlcod < 0;
015900150610             wEOF = *on;
016000150610             leave;
016100150610           ENDIF;
016200150610
016300150610         //?Aggiorno
016400150611           chain CBAksc TFCLS01L;
016500150611           IF  not %found(TFCLS01L);
016600150611             iter;
016700150611           ENDIF;
016800150611           IF  CBApag = 'DN' and %subst(CLStic:1:1) = '6';
016900150611             %subst(CLStic:1:1) = '2';
017000150611             update FNCLS000;
017100150611           ENDIF;
017200150611           IF  CBApag = 'NA' and %subst(CLStic:2:1) = '6';
017300150611             %subst(CLStic:2:1) = '2';
017400150611             update FNCLS000;
017500150611           ENDIF;
017600150610
017700150610         ENDDO;
017800150610
017900150610       //?Chiudo il cursore
018000150610         exec sql
018100150610           close CBA;
018200130204
018300130204       ENDSR;
018400130125
018500120423       //--------------------------------------------------------------
018600120423       //?Operazioni finali.
018700120423       //--------------------------------------------------------------
018800120423       BEGSR RoutEnd;
018900120423
019000120423         *inLR = *on;
019100120423         return;
019200120423
019300120423       ENDSR;
019400051221
019500051221      /end-free
019600051221
