000100150727      //---------------------------------------------------------------
000200150727      //?TNVRMB32R - Spalma nota 87
000300150727      //---------------------------------------------------------------
000400150727
000500150727     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600150727
000700150727      //---------------------------------------------------------------
000800150727      //?Dichiarazione file.
000900150727      //---------------------------------------------------------------
001000150727     fCNACVT1L  if   e           k disk
001100150727     fFNSPE01L  if   e           k disk
001200150727     fTFNTC01L  if   e           k disk    rename(TFNTC:TFNTC01)
001300150727     f                                     prefix(w)
001400150727     fTFNTC00F  o    e             disk
001500150727
001600150727      //---------------------------------------------------------------
001700150727      //?Definizione costanti.
001800150727      //---------------------------------------------------------------
001900150727
002000150727      //---------------------------------------------------------------
002100150727      //?Definizione schiere.
002200150727      //---------------------------------------------------------------
002300150727
002400150727      //---------------------------------------------------------------
002500150727      //?Definizione aree dati.
002600150727      //---------------------------------------------------------------
002700150727
002800150727      //---------------------------------------------------------------
002900150727      //?Definizione strutture dati.
003000150727      //---------------------------------------------------------------
003100150727
003200150727      // - Controllo data
003300150727     d wlbdat          ds                  inz
003400150727     d  g02dat                 1      8  0
003500150727     d  g02inv                 9     16  0
003600150727     d  g02err                17     17
003700150727     d  g02tgi                18     22  0
003800150727
003900150727      // - Parametri ricevuti
004000150727     d KPJBA         e ds
004100150727
004200150727      // - Anagrafico clienti
004300150727     d CNACO00F      e ds                  extname(CNACO00F)
004400150727     d CNCLP00F      e ds                  extname(CNCLP00F)
004500150727
004600150727      //---------------------------------------------------------------
004700150727      //?Definizione variabili globali.
004800150727      //---------------------------------------------------------------
004900150727
005000150727      // - Flags booleani
005100150727     d wEnd            s               n   inz(*off)
005200150727     d wEndCvt         s               n   inz(*off)
005300150727     d wNoACO          s               n   inz(*off)
005400150727     d wNo87           s               n   inz(*off)
005500150727     d wNo008          s               n   inz(*off)
005600150727     d wSi82           s               n   inz(*off)
005700150727
005800150727      // - Campi di comodo
005900150727     d wAPL            s                   like(NTCapl) inz('C')
006000150727     d wData           s              6  0 inz(150802)
006100150727     d wDataAco        s              8  0 inz
006200150727     d wNK1            s                   like(NTCnk1) inz
006300150727     d wNK2            s                   like(NTCnk2) inz
006400150727     d wTNT            s                   like(NTCtnt) inz
006500150727     d wTNTda          s                   like(NTCtnt) inz
006600150727     d w0070           s              7  0 inz
006700150727
006800150727      //---------------------------------------------------------------
006900150727      //?Definizione procedure esterne.
007000150727      //---------------------------------------------------------------
007100150727
007200150727      //---------------------------------------------------------------
007300150727      //?Definizione prototipi.
007400150727      //---------------------------------------------------------------
007500150727      /copy gaitrasrc/srcprotopr,xsrda8
007600150727
007700150727      //---------------------------------------------------------------
007800150727      //?Definizione key-list.
007900150727      //---------------------------------------------------------------
008000150727
008100150727      //---------------------------------------------------------------
008200150727      //?Riepilogo indicatori.
008300150727      //---------------------------------------------------------------
008400150727
008500150727      //---------------------------------------------------------------
008600150727      //?M A I N - L I N E
008700150727      //---------------------------------------------------------------
008800150727
008900150727     c     *Entry        plist
009000150727     c                   parm                    kpjba
009100150727
009200150727      /free
009300150727
009400150727       //?Operazioni iniziali
009500150727       exsr RoutInz;
009600150727
009700150727       //?Elaboro solo i clienti con fatturato nel 2015
009800150727       exsr Elabora;
009900150727
010000150727       //?Operazioni finali
010100150727       exsr RoutEnd;
010200150727
010300150727       //--------------------------------------------------------------
010400150727       //?Operazioni iniziali.
010500150727       //--------------------------------------------------------------
010600150727       BEGSR RoutInz;
010700150727
010800150727         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
010900150727
011000150727       ENDSR;
011100150727
011200150727       //--------------------------------------------------------------
011300150727       //?Elaboro clienti.
011400150727       //--------------------------------------------------------------
011500150727       BEGSR Elabora;
011600150727
011700150727         wEnd = *off;
011800150727         wNoAco = *off;
011900150727         wNo87 = *off;
012000150727         wNo008 = *off;
012100150727         wSi82 = *off;
012200150727
012300150727       //?Estraggo solo i clienti con fatturato nel 2015
012400150727         exec sql
012500150727         DECLARE ANAGRA cursor for
012600150727         SELECT  * FROM
012700150727         CNCLP00F, CNACO00F
012800150727         WHERE CLPkcc = ACOkcc and CLPksc = ACOksc
012900150727           and CLPkcc = 151
013000150727         ORDER by CLPksc;
013100150727
013200150727         exec sql OPEN ANAGRA;
013300150727
013400150727         DOW  not wEnd;
013500150727           exec sql FETCH next from ANAGRA into :CNCLP00F, :CNACO00F;
013600150727
013700150727           IF  sqlcod = 100 or sqlcod < 0;
013800150727             wEnd = *on;
013900150727             leave;
014000150727           ENDIF;
014100150727
014200150727         //?Controllo se cliente nuovo o attivo nel 2015
014300150727           exsr CtrAco;
014400150727           IF  wNoAco;
014500150727             iter;
014600150727           ENDIF;
014700150727
014800150727         //?Dati per chiave File Note
014900150727           wNK1 = %editc(CLPkcc:'X') + %editc(CLPksc:'X');
015000150727
015100150727         //?Controlla se ha il luovo 008
015200150727           exsr Ctr008;
015300150727
015400150727         //?Controllo se ha la nota 87
015500150727           exsr Ctr87;
015600150727
015700150727         //?Controllo se ha la nota 82
015800150727           exsr Ctr82;
015900150727
016000150727         //?Se NON ha luogo 008 e non ha la mail 87
016100150727         //?ma ha la nota 82
016200150727         //?Scrivo la nota 87 dalla nota 82
016300150727           IF  wNo87 and wNo008 and wSi82;
016400150727             wTNTda = '82';
016500150727             wTNT = '87';
016600150727             exsr WrtNota;
016700150727           ENDIF;
016800150727
016900150727         ENDDO;
017000150727
017100150727         exec sql CLOSE ANAGRA;
017200150727
017300150727       ENDSR;
017400150727
017500150727       //--------------------------------------------------------------
017600150727       //?Controllo Anagrafica.
017700150727       //--------------------------------------------------------------
017800150727       BEGSR CtrAco;
017900150727
018000150727         wNoAco = *off;
018100150727
018200150727       //?Controllo se attivo nel 2015
018300150727         IF  CLPdus > 0;
018400150727       //?da 6 la porto lunga 8
018500150727           clear wlbdat;
018600150727           g02inv = CLPdus;
018700150727           g02err = '3';
018800150727           xsrda8(wlbdat);
018900150727           wDataAco = g02inv;
019000150727         //?se non del 2015 leggo altro rcd
019100150727           IF  wDataAco < 20150101;
019200150727             wNoAco = *on;
019300150727             leavesr;
019400150727           ENDIF;
019500150727         ENDIF;
019600150727
019700150727       //?Non c'è data ultima spedizione fattura
019800150727       //?controllo quando è stato aperto il codice
019900150727         IF  CLPdus = 0;
020000150727           wEndCvt = *off;
020100150727         //?cerco il rcd di inserimento nel file delle variazioni
020200150727         //?per recuperare la data di apertura codice
020300150727         //?deve essere del 2015
020400150727           setll (ACOkcc:ACOksc) CNACVT1L;
020500150727           DOW  not wEndCvt;
020600150727             reade (ACOkcc:ACOksc) CNACVT1L;
020700150727             IF  %eof(CNACVT1L);
020800150727               wEndCvt = *on;
020900150727             ENDIF;
021000150727             IF  not %eof(CNACVT1L) and ACVcta <> 'M';
021100150727               wDataAco = ACVdav;
021200150727               wEndCvt = *on;
021300150727             ENDIF;
021400150727           ENDDO;
021500150727         //?se non del 2015 leggo altro rcd
021600150727           IF  wDataAco < 20150101;
021700150727             wNoAco = *on;
021800150727             leavesr;
021900150727           ENDIF;
022000150727         ENDIF;
022100150727
022200150727       ENDSR;
022300150727
022400150727       //--------------------------------------------------------------
022500150727       //?Controllo se esiste la nota 82.
022600150727       //--------------------------------------------------------------
022700150727       BEGSR Ctr82;
022800150727
022900150727         wSi82 = *off;
023000150727         wTNTda = '82';
023100150727         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
023200150727         IF  %found(TFNTC01L);
023300150727           wSi82 = *on;
023400150727         ENDIF;
023500150727
023600150727       ENDSR;
023700150727
023800150727       //--------------------------------------------------------------
023900150727       //?Controllo se esiste la nota 87.
024000150727       //--------------------------------------------------------------
024100150727       BEGSR Ctr87;
024200150727
024300150727         wNo87 = *off;
024400150727         wTNTda = '87';
024500150727         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
024600150727         IF  not %found(TFNTC01L);
024700150727           wNo87 = *on;
024800150727         ENDIF;
024900150727
025000150727       ENDSR;
025100150727
025200150727       //--------------------------------------------------------------
025300150727       //?Controllo se esiste il luogo 008.
025400150727       //--------------------------------------------------------------
025500150727       BEGSR Ctr008;
025600150727
025700150727         wNo008 = *off;
025800150727         SPEfls = 'L';
025900150727         SPEcod = '008';
026000150727         chain (SPEfls:CLPksc:SPEcod) FNSPE01L;
026100150727         IF  not %found(FNSPE01L);
026200150727           wNo008 = *on;
026300150727         ENDIF;
026400150727
026500150727       ENDSR;
026600150727
026700150727       //--------------------------------------------------------------
026800150727       //?Scrivo la nota.
026900150727       //--------------------------------------------------------------
027000150727       BEGSR WrtNota;
027100150727
027200150727         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
027300150727         IF  %found(TFNTC01L);
027400150727           clear TFNTC;
027500150727           NTCapl = wNTCapl;
027600150727           NTCnk1 = wNTCnk1;
027700150727           NTCnk2 = wNTCnk2;
027800150727           NTCtnt = wTNT;
027900150727           NTCrnt = wNTCrnt;
028000150727           NTCsns = wNTCsns;
028100150727           NTCflt = wNTCflt;
028200150727           NTCntr = wData;
028300150727           write TFNTC;
028400150727         ENDIF;
028500150727
028600150727       ENDSR;
028700150727
028800150727       //--------------------------------------------------------------
028900150727       //?Operazioni finali.
029000150727       //--------------------------------------------------------------
029100150727       BEGSR RoutEnd;
029200150727
029300150727         *inLR = *on;
029400150727         return;
029500150727
029600150727       ENDSR;
029700150727
029800150727      /end-free
