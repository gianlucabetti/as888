000100150506      //---------------------------------------------------------------
000200150506      //?TNVRMB27R - Spalma note 89 - 82 - 85
000300150506      //---------------------------------------------------------------
000400150506
000500150506     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600150506
000700150506      //---------------------------------------------------------------
000800150506      //?Dichiarazione file.
000900150506      //---------------------------------------------------------------
001000150507     fCNACVT1L  if   e           k disk
001100150507     fTFNTC01L  if   e           k disk    rename(TFNTC:TFNTC01)
001200150507     f                                     prefix(w)
001300150507     fTFNTC00F  o    e             disk
001400150506
001500150506      //---------------------------------------------------------------
001600150506      //?Definizione costanti.
001700150506      //---------------------------------------------------------------
001800150506
001900150506      //---------------------------------------------------------------
002000150506      //?Definizione schiere.
002100150506      //---------------------------------------------------------------
002200150506
002300150506      //---------------------------------------------------------------
002400150506      //?Definizione aree dati.
002500150506      //---------------------------------------------------------------
002600150506
002700150506      //---------------------------------------------------------------
002800150506      //?Definizione strutture dati.
002900150506      //---------------------------------------------------------------
003000150507
003100150507      // - Controllo data
003200150507     d wlbdat          ds                  inz
003300150507     d  g02dat                 1      8  0
003400150507     d  g02inv                 9     16  0
003500150507     d  g02err                17     17
003600150507     d  g02tgi                18     22  0
003700150506
003800150507      // - Parametri ricevuti
003900150506     d KPJBA         e ds
004000150506
004100150507      // - Anagrafico clienti
004200150507     d CNACO00F      e ds                  extname(CNACO00F)
004300150507     d CNCLP00F      e ds                  extname(CNCLP00F)
004400150506
004500150506      //---------------------------------------------------------------
004600150506      //?Definizione variabili globali.
004700150506      //---------------------------------------------------------------
004800150506
004900150506      // - Flags booleani
005000150506     d wEnd            s               n   inz(*off)
005100150507     d wEndCvt         s               n
005200150506     d wNoACO          s               n   inz(*off)
005300150506     d wNo82           s               n   inz(*off)
005400150506     d wNo85           s               n   inz(*off)
005500150506     d wNo89           s               n   inz(*off)
005600150506     d wSi06           s               n   inz(*off)
005700150506     d wSi84           s               n   inz(*off)
005800150506
005900150506      // - Campi di comodo
006000150506     d wAPL            s                   like(NTCapl) inz('C')
006100150527     d wData           s              6  0 inz(150531)
006200150507     d wDataAco        s              8  0 inz
006300150506     d wNK1            s                   like(NTCnk1) inz
006400150506     d wNK2            s                   like(NTCnk2) inz
006500150506     d wTNT            s                   like(NTCtnt) inz
006600150506     d wTNTda          s                   like(NTCtnt) inz
006700150506     d w0070           s              7  0 inz
006800150506
006900150506      //---------------------------------------------------------------
007000150506      //?Definizione procedure esterne.
007100150506      //---------------------------------------------------------------
007200150506
007300150506      //---------------------------------------------------------------
007400150506      //?Definizione prototipi.
007500150506      //---------------------------------------------------------------
007600150507      /copy gaitrasrc/srcprotopr,xsrda8
007700150506
007800150506      //---------------------------------------------------------------
007900150506      //?Definizione key-list.
008000150506      //---------------------------------------------------------------
008100150506
008200150506      //---------------------------------------------------------------
008300150506      //?Riepilogo indicatori.
008400150506      //---------------------------------------------------------------
008500150506
008600150506      //---------------------------------------------------------------
008700150506      //?M A I N - L I N E
008800150506      //---------------------------------------------------------------
008900150506
009000150506     c     *Entry        plist
009100150506     c                   parm                    kpjba
009200150506
009300150506      /free
009400150506
009500150506       //?Operazioni iniziali
009600150506       exsr RoutInz;
009700150506
009800150506       //?Elaboro solo i clienti con fatturato nel 2015
009900150506       exsr Elabora;
010000150506
010100150506       //?Operazioni finali
010200150506       exsr RoutEnd;
010300150506
010400150506       //--------------------------------------------------------------
010500150506       //?Operazioni iniziali.
010600150506       //--------------------------------------------------------------
010700150506       BEGSR RoutInz;
010800150506
010900150506         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
011000150506
011100150506       ENDSR;
011200150506
011300150506       //--------------------------------------------------------------
011400150506       //?Elaboro clienti.
011500150506       //--------------------------------------------------------------
011600150506       BEGSR Elabora;
011700150506
011800150506         wEnd = *off;
011900150506         wNoAco = *off;
012000150506         wNo82 = *off;
012100150506         wNo85 = *off;
012200150506         wNo89 = *off;
012300150506         wSi06 = *off;
012400150506         wSi84 = *off;
012500150506
012600150506       //?Estraggo solo i clienti con fatturato nel 2015
012700150506         exec sql
012800150507         DECLARE ANAGRA cursor for
012900150507         SELECT  * FROM
013000150507         CNCLP00F, CNACO00F
013100150507         WHERE CLPkcc = ACOkcc and CLPksc = ACOksc
013200150507           and CLPkcc = 151
013300150506         ORDER by CLPksc;
013400150506
013500150507         exec sql OPEN ANAGRA;
013600150506
013700150506         DOW  not wEnd;
013800150507           exec sql FETCH next from ANAGRA into :CNCLP00F, :CNACO00F;
013900150506
014000150506           IF  sqlcod = 100 or sqlcod < 0;
014100150506             wEnd = *on;
014200150506             leave;
014300150506           ENDIF;
014400150506
014500150507         //?Controllo se cliente nuovo o attivo nel 2015
014600150507           exsr CtrAco;
014700150507           IF  wNoAco;
014800150507             iter;
014900150507           ENDIF;
015000150506
015100150506         //?Dati per chiave File Note
015200150506           wNK1 = %editc(CLPkcc:'X') + %editc(CLPksc:'X');
015300150506
015400150506         //?Controllo se ha la nota 89
015500150506           exsr Ctr89;
015600150506
015700150506         //?Controllo se ha la nota 82
015800150506           exsr Ctr82;
015900150506
016000150506         //?Controllo se ha la nota 85
016100150506           exsr Ctr85;
016200150506
016300150506         //?Se non ha tutte e 3 le note
016400150506           IF  wNo89 and wNo82 and wNo85;
016500150506           //?Controllo se ha la nota 84
016600150506             exsr Ctr84;
016700150506           //?Controllo se ha la nota 06
016800150506             exsr Ctr06;
016900150506           ENDIF;
017000150506
017100150506           SELECT;
017200150506
017300150506         //?Se ha tutte e 3 le note  OK
017400150506           WHEN  not wNo89 and not wNo82 and not wNo85;
017500150506
017600150506         //?Se non ha tutte e 3 le note
017700150506           WHEN  wNo89 and wNo82 and wNo85;
017800150506           //?Scrivo dalla 84
017900150506             IF  wSi84;
018000150506               wTNTda = '84';
018100150506               wTNT = '89';
018200150506               exsr WrtNota;
018300150506               wTNT = '82';
018400150506               exsr WrtNota;
018500150506               wTNT = '85';
018600150506               exsr WrtNota;
018700150506             ENDIF;
018800150506           //?Scrivo dalla 06
018900150506             IF  not wSi84 and wSi06;
019000150506               wTNTda = '06';
019100150506               wTNT = '89';
019200150506               exsr WrtNota;
019300150506               wTNT = '82';
019400150506               exsr WrtNota;
019500150506               wTNT = '85';
019600150506               exsr WrtNota;
019700150506             ENDIF;
019800150506
019900150506         //?Se ha la nota 89
020000150506           WHEN  not wNo89 and (wNo82 or wNo85);
020100150506             wTNTda = '89';
020200150506             IF  wNo82;
020300150506               wTNT = '82';
020400150506               exsr WrtNota;
020500150506             ENDIF;
020600150506             IF  wNo85;
020700150506               wTNT = '85';
020800150506               exsr WrtNota;
020900150506             ENDIF;
021000150506
021100150506         //?Se ha la nota 82
021200150506           WHEN  not wNo82;
021300150506             wTNTda = '82';
021400150506             IF  wNo89;
021500150506               wTNT = '89';
021600150506               exsr WrtNota;
021700150506             ENDIF;
021800150506             IF  wNo85;
021900150506               wTNT = '85';
022000150506               exsr WrtNota;
022100150506             ENDIF;
022200150506
022300150506         //?Se ha la nota 85
022400150506           WHEN  not wNo85;
022500150506             wTNTda = '85';
022600150506             IF  wNo89;
022700150506               wTNT = '89';
022800150506               exsr WrtNota;
022900150506             ENDIF;
023000150506             IF  wNo82;
023100150506               wTNT = '82';
023200150506               exsr WrtNota;
023300150506             ENDIF;
023400150506
023500150506           ENDSL;
023600150506
023700150506         ENDDO;
023800150506
023900150507         exec sql CLOSE ANAGRA;
024000150506
024100150506       ENDSR;
024200150506
024300150506       //--------------------------------------------------------------
024400150507       //?Controllo Anagrafica.
024500150506       //--------------------------------------------------------------
024600150506       BEGSR CtrAco;
024700150506
024800150506         wNoAco = *off;
024900150507
025000150507       //?Controllo se attivo nel 2015
025100150507         IF  CLPdus > 0;
025200150507       //?da 6 la porto lunga 8
025300150507           clear wlbdat;
025400150507           g02inv = CLPdus;
025500150507           g02err = '3';
025600150507           xsrda8(wlbdat);
025700150507           wDataAco = g02inv;
025800150507         //?se non del 2015 leggo altro rcd
025900150507           IF  wDataAco < 20150101;
026000150507             wNoAco = *on;
026100150507             leavesr;
026200150507           ENDIF;
026300150507         ENDIF;
026400150507
026500150507       //?Non c'è data ultima spedizione fattura
026600150507       //?controllo quando è stato aperto il codice
026700150507         IF  CLPdus = 0;
026800150507           wEndCvt = *off;
026900150507         //?cerco il rcd di inserimento nel file delle variazioni
027000150507         //?per recuperare la data di apertura codice
027100150507         //?deve essere del 2015
027200150507           setll (ACOkcc:ACOksc) CNACVT1L;
027300150507           DOW  not wEndCvt;
027400150507             reade (ACOkcc:ACOksc) CNACVT1L;
027500150507             IF  %eof(CNACVT1L);
027600150507               wEndCvt = *on;
027700150507             ENDIF;
027800150507             IF  not %eof(CNACVT1L) and ACVcta <> 'M';
027900150507               wDataAco = ACVdav;
028000150507               wEndCvt = *on;
028100150507             ENDIF;
028200150507           ENDDO;
028300150507         //?se non del 2015 leggo altro rcd
028400150507           IF  wDataAco < 20150101;
028500150507             wNoAco = *on;
028600150507             leavesr;
028700150507           ENDIF;
028800150507         ENDIF;
028900150507
029000150507       ENDSR;
029100150506
029200150506       //--------------------------------------------------------------
029300150506       //?Controllo se esiste la nota 06.
029400150506       //--------------------------------------------------------------
029500150506       BEGSR Ctr06;
029600150506
029700150506         wSi06 = *off;
029800150506         wTNTda = '06';
029900150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
030000150506         IF  %found(TFNTC01L);
030100150506           wSi06 = *on;
030200150506         ENDIF;
030300150506
030400150506       ENDSR;
030500150506
030600150506       //--------------------------------------------------------------
030700150506       //?Controllo se esiste la nota 82.
030800150506       //--------------------------------------------------------------
030900150506       BEGSR Ctr82;
031000150506
031100150506         wNo82 = *off;
031200150506         wTNTda = '82';
031300150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
031400150506         IF  not %found(TFNTC01L);
031500150506           wNo82 = *on;
031600150506         ENDIF;
031700150506
031800150506       ENDSR;
031900150506
032000150506       //--------------------------------------------------------------
032100150506       //?Controllo se esiste la nota 84.
032200150506       //--------------------------------------------------------------
032300150506       BEGSR Ctr84;
032400150506
032500150506         wSi84 = *off;
032600150506         wTNTda = '84';
032700150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
032800150506         IF  %found(TFNTC01L);
032900150506           wSi84 = *on;
033000150506         ENDIF;
033100150506
033200150506       ENDSR;
033300150506
033400150506       //--------------------------------------------------------------
033500150506       //?Controllo se esiste la nota 85.
033600150506       //--------------------------------------------------------------
033700150506       BEGSR Ctr85;
033800150506
033900150506         wNo85 = *off;
034000150506         wTNTda = '85';
034100150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
034200150506         IF  not %found(TFNTC01L);
034300150506           wNo85 = *on;
034400150506         ENDIF;
034500150506
034600150506       ENDSR;
034700150506
034800150506       //--------------------------------------------------------------
034900150506       //?Controllo se esiste la nota 89.
035000150506       //--------------------------------------------------------------
035100150506       BEGSR Ctr89;
035200150506
035300150506         wNo89 = *off;
035400150506         wTNTda = '89';
035500150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
035600150506         IF  not %found(TFNTC01L);
035700150506           wNo89 = *on;
035800150506         ENDIF;
035900150506
036000150506       ENDSR;
036100150506
036200150506       //--------------------------------------------------------------
036300150506       //?Scrivo la nota.
036400150506       //--------------------------------------------------------------
036500150506       BEGSR WrtNota;
036600150506
036700150506         chain (wAPL:wNK1:wNK2:wTNTda) TFNTC01L;
036800150506         IF  %found(TFNTC01L);
036900150506           clear TFNTC;
037000150506           NTCapl = wNTCapl;
037100150506           NTCnk1 = wNTCnk1;
037200150506           NTCnk2 = wNTCnk2;
037300150506           NTCtnt = wTNT;
037400150506           NTCrnt = wNTCrnt;
037500150506           NTCsns = wNTCsns;
037600150506           NTCflt = wNTCflt;
037700150507           NTCntr = wData;
037800150506           write TFNTC;
037900150506         ENDIF;
038000150506
038100150506       ENDSR;
038200150506
038300150506       //--------------------------------------------------------------
038400150506       //?Operazioni finali.
038500150506       //--------------------------------------------------------------
038600150506       BEGSR RoutEnd;
038700150506
038800150506         *inLR = *on;
038900150506         return;
039000150506
039100150506       ENDSR;
039200150506
039300150506      /end-free
