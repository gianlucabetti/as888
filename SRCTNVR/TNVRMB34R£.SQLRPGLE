000100131001      //---------------------------------------------------------------
000200131001      //
000300150911      //?      Controllo ORM
000400131001      //
000500131001      //---------------------------------------------------------------
000600131001
000700080520     h decedit('0,') datedit(*ymd.) option(*nodebugio)
000800150909     h dftactgrp(*no) actgrp(*caller)
000900040511
001000131001      //---------------------------------------------------------------
001100131001      //?Dichiarazione file.
001200131001      //---------------------------------------------------------------
001300150909      // -?File Bolle        ?
001400150909     fTITAS30C  if   e           k disk
001500150909     fTITA432C  if   e           k disk
001600080710
001700150909      // -?File di Work      ?
001800150909     fWFACR01L  uf a e           k disk    usropn
001900040511
002000131001      //---------------------------------------------------------------
002100131001      //?Definizione costanti.
002200131001      //---------------------------------------------------------------
002300131001
002400131001      //---------------------------------------------------------------
002500131001      //?Definizione schiere.
002600131001      //---------------------------------------------------------------
002700131001
002800131001      //---------------------------------------------------------------
002900131001      //?Definizione aree dati.
003000131001      //---------------------------------------------------------------
003100131001
003200131001      //---------------------------------------------------------------
003300131001      //?Definizione strutture dati.
003400131001      //---------------------------------------------------------------
003500131001
003600150909      // -?Parametri ricevuti?
003700131001     d kpjba         e ds
003800131001
003900131001      // -?File FNORM00F
004000131001     d FNORM00F      e ds                  extname(FNORM00F)
004100150909
004200150909      // -?Chiave ORM
004300150909     d keyORM          DS
004400150909     d  wORMpoe                       3  0
004500150909     d  wORMnsr                       2  0
004600150909     d  wORMnor                       7  0
004700150909     d  wORMnrv                       2  0
004800131001
004900131001      //---------------------------------------------------------------
005000131001      //?Definizione variabili globali.
005100131001      //---------------------------------------------------------------
005200131001
005300131001      // -?Flag booleani
005400131001     d wEoF            s               n   inz(*off)
005500131001
005600131001      // -?Campi di comodo
005700150909     d cmd             s            512a   varying
005800150909     d norm            s              6s 0
005900150909     d wdataini        s              8s 0
006000150909     d wdatafin        s              8s 0
006100131001
006200131001      //---------------------------------------------------------------
006300131001      //?Definizione procedure esterne.
006400131001      //---------------------------------------------------------------
006500131001
006600131001      //---------------------------------------------------------------
006700131001      //?Definizione prototipi.
006800131001      //---------------------------------------------------------------
006900150909      /copy gaitrasrc/srcprotopr,SYSTEM
007000131001
007100131001      //---------------------------------------------------------------
007200131001      //?Definizione key-list.
007300131001      //---------------------------------------------------------------
007400131001
007500131001      //---------------------------------------------------------------
007600131001      //?Riepilogo indicatori.
007700131001      //---------------------------------------------------------------
007800131001
007900131001      //---------------------------------------------------------------
008000131001      //?M A I N - L I N E
008100131001      //---------------------------------------------------------------
008200131001
008300131001     c     *Entry        plist
008400131001     c                   parm                    kpjba
008500131001
008600131001      /free
008700131001
008800131001       //?Operazioni iniziali
008900131001       exsr RoutInz;
009000131001
009100131001       //?Elabora file
009200131001       exsr Elabora;
009300131001
009400131001       //?Operazioni finali
009500131001       exsr RoutEnd;
009600131001
009700131001       //--------------------------------------------------------------
009800131001       //?Operazioni iniziali.
009900131001       //--------------------------------------------------------------
010000131001       BEGSR RoutInz;
010100131001
010200131001       //?Impostazione opzioni per SQL?
010300150909         exec sql set option DynUsrPrf = *Owner,
010400150909                             CloSqlCsr = *EndMod;
010500150909
010600150909       //?Imposto le date
010700150909         wdataini = 20150701;
010800150909         wdatafin = 20150731;
010900150909
011000150909       //?Pulizia del file di work
011100150909         IF  %subst(knsif : 7 : 1) = 'P';
011200150909           cmd = 'CLRPFM FILE(UNITRAGRP/WFACR00F)';
011300150909         ELSE;
011400150909           cmd = 'CLRPFM FILE(UNITRAGRU/WFACR00F)';
011500150909         ENDIF;
011600150909         IF  ExecuteCommand (cmd) = 0;
011700150909         ELSE;
011800150909           exsr RoutEnd;
011900150909         ENDIF;
012000150909
012100150909       //?Apertura file di work
012200150909         open WFACR01L;
012300131001
012400131001       ENDSR;
012500131001
012600131001       //--------------------------------------------------------------
012700131001       //?Elabora
012800131001       //--------------------------------------------------------------
012900150909       BEGSR Elabora;
013000131001
013100131001         wEoF = *off;
013200131001
013300131001       //?Leggo gli ORM
013400131001         exec sql
013500131001         DECLARE ORM cursor FOR
013600131001         SELECT *
013700150909         from FNORM00F
013800131001         WHERE  ORMdao between :wdataini and :wdatafin
013900150909                and ORMnsr = 0 and ORMcra > 0
014000150909         ORDER BY ORMcra, ORMpoe, ORMnsr, ORMnor, ORMnrv;
014100131001
014200131001         exec sql
014300131001         open ORM;
014400131001         IF sqlcode < 0;
014500131001           wEoF = *on;
014600131001         ENDIF;
014700131001
014800131001         DOW not wEoF;
014900131001           exec sql
015000150909           FETCH NEXT from ORM into :FNORM00F;
015100131001           IF sqlcod = 100 or sqlcod < 0;
015200131001             wEOF = *on;
015300131001             leave;
015400131001           ENDIF;
015500131001
015600150909           exsr Conta;
015700131001
015800131001         ENDDO;
015900131001
016000131001       //?Chiudo il cursore
016100131001         exec sql
016200131001           close ORM;
016300150909
016400150909       //?Alla fine di tutto devo rileggere il file per calcolare
016500150909       //?la % di incidenza
016600150909         exsr Percentuale;
016700131001
016800131001       ENDSR;
016900131001
017000131001       //--------------------------------------------------------------
017100150909       //?Conto x LNP.
017200131001       //--------------------------------------------------------------
017300150909       BEGSR Conta;
017400150909
017500150909         wORMpoe = ORMpoe;
017600150909         wORMnsr = ORMnsr;
017700150909         wORMnor = ORMnor;
017800150909         wORMnrv = ORMnrv;
017900131001
018000150909       //?Aggancio la bolla legata
018100150909         setll (keyORM) TITA432C;
018200150909         reade (keyORM) TITA432C;
018300150909         DOW  not %eof(TITA432C);
018400150909         //?Solo bolle di tipo F1
018500150910           chain (TA4aas:TA4lnp:TA4nrs:TA4nsp:'F1') TITAS30C;
018600150909           IF  %found(TITAS30C);
018700150909           //?Scrivo/Aggiorno file di work
018800150909             exsr FileWork;
018900150909             leavesr;
019000150909           ENDIF;
019100150909           reade (keyORM) TITA432C;
019200150909         ENDDO;
019300131001
019400131001       ENDSR;
019500131001
019600131001       //--------------------------------------------------------------
019700150909       //?Scrivo/Aggiorno File di Work.
019800131001       //--------------------------------------------------------------
019900150909       BEGSR FileWork;
020000150909
020100150909         chain (ORMcra:TASlnp) WFACR01L;
020200150909         IF  %found(WFACR01L);
020300150909           WACRorm += 1;
020400150909           update WFACR000;
020500150909         ELSE;
020600150909           clear WFACR000;
020700150909           WACRcra = ORMcra;
020800150909           WACRrag = ORMrsr;
020900150909           WACRlnp = TASlnp;
021000150909           WACRorm = 1;
021100150909           write  WFACR000;
021200150909         ENDIF;
021300131001
021400131001       ENDSR;
021500150909
021600150909       //--------------------------------------------------------------
021700150909       //?Calcolo la % di incidenza.
021800150909       //--------------------------------------------------------------
021900150909       BEGSR Percentuale;
022000150909
022100150909         wEoF = *off;
022200150909
022300150909       //?Leggo file di work a totale per cliente
022400150909         exec sql
022500150909         DECLARE ACR cursor FOR
022600150909         SELECT WACRcra, sum(WACRorm)
022700150909         from WFACR00F
022800150909         GROUP BY WACRcra
022900150909         ORDER BY WACRcra;
023000150909
023100150909         exec sql
023200150909         open ACR;
023300150909         IF sqlcode < 0;
023400150909           wEoF = *on;
023500150909         ENDIF;
023600150909
023700150909         DOW not wEoF;
023800150909           exec sql
023900150909           FETCH NEXT from ACR into :WACRcra, :norm;
024000150909           IF sqlcod = 100 or sqlcod < 0;
024100150909             wEOF = *on;
024200150909             leave;
024300150909           ENDIF;
024400150909
024500150909           setll (WACRcra) WFACR01L;
024600150909           reade (WACRcra) WFACR01L;
024700150909           DOW not %eof(WFACR01L);
024800150909             eval(h) WACRper = 100 * WACRorm / norm;
024900150909             update WFACR000;
025000150909             reade (WACRcra) WFACR01L;
025100150909           ENDDO;
025200150909
025300150909         ENDDO;
025400150909
025500150909       //?Chiudo il cursore
025600150909         exec sql
025700150909           close ACR;
025800150909
025900150909       ENDSR;
026000131001
026100131001       //--------------------------------------------------------------
026200131001       //?Operazioni finali.
026300131001       //--------------------------------------------------------------
026400131001       BEGSR RoutEnd;
026500131001
026600131001         *inLR = *on;
026700131001         return;
026800131001
026900131001       ENDSR;
027000131001
027100131001      /end-free
027200131001
