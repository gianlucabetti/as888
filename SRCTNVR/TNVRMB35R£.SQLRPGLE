000100131001      //---------------------------------------------------------------
000200131001      //
000300150911      //?      Controllo ORM
000400131001      //
000500131001      //---------------------------------------------------------------
000600131001
000700080520     h decedit('0,') datedit(*ymd.) option(*nodebugio)
000800040511
000900131001      //---------------------------------------------------------------
001000131001      //?Dichiarazione file.
001100131001      //---------------------------------------------------------------
001200150909      // -?File Bolle        ?
001300150909     fTITAS30C  if   e           k disk
001400150909     fTITA432C  if   e           k disk
001500150911
001600150911      // -?File di stampa    ?
001700150911     fPRTF198   o    f  198        printer oflind(*inof)
001800040511
001900131001      //---------------------------------------------------------------
002000131001      //?Definizione costanti.
002100131001      //---------------------------------------------------------------
002200131001
002300131001      //---------------------------------------------------------------
002400131001      //?Definizione schiere.
002500131001      //---------------------------------------------------------------
002600131001
002700131001      //---------------------------------------------------------------
002800131001      //?Definizione aree dati.
002900131001      //---------------------------------------------------------------
003000131001
003100131001      //---------------------------------------------------------------
003200131001      //?Definizione strutture dati.
003300131001      //---------------------------------------------------------------
003400131001
003500150909      // -?Parametri ricevuti?
003600131001     d kpjba         e ds
003700131001
003800131001      // -?File FNORM00F
003900131001     d FNORM00F      e ds                  extname(FNORM00F)
004000150909
004100150909      // -?Chiave ORM
004200150909     d keyORM          DS
004300150909     d  wORMpoe                       3  0
004400150909     d  wORMnsr                       2  0
004500150909     d  wORMnor                       7  0
004600150909     d  wORMnrv                       2  0
004700131001
004800131001      //---------------------------------------------------------------
004900131001      //?Definizione variabili globali.
005000131001      //---------------------------------------------------------------
005100131001
005200131001      // -?Flag booleani
005300131001     d wEoF            s               n   inz(*off)
005400131001
005500131001      // -?Campi di comodo
005600150911     d TOT_cod         s              6s 0
005700150911     d TOT_no_cod      s              6s 0
005800150909     d wdataini        s              8s 0
005900150909     d wdatafin        s              8s 0
006000131001
006100131001      //---------------------------------------------------------------
006200131001      //?Definizione procedure esterne.
006300131001      //---------------------------------------------------------------
006400131001
006500131001      //---------------------------------------------------------------
006600131001      //?Definizione prototipi.
006700131001      //---------------------------------------------------------------
006800131001
006900131001      //---------------------------------------------------------------
007000131001      //?Definizione key-list.
007100131001      //---------------------------------------------------------------
007200131001
007300131001      //---------------------------------------------------------------
007400131001      //?Riepilogo indicatori.
007500131001      //---------------------------------------------------------------
007600131001
007700131001      //---------------------------------------------------------------
007800131001      //?M A I N - L I N E
007900131001      //---------------------------------------------------------------
008000131001
008100131001     c     *Entry        plist
008200131001     c                   parm                    kpjba
008300131001
008400131001      /free
008500131001
008600131001       //?Operazioni iniziali
008700131001       exsr RoutInz;
008800131001
008900131001       //?Elabora file
009000131001       exsr Elabora;
009100131001
009200131001       //?Operazioni finali
009300131001       exsr RoutEnd;
009400131001
009500131001       //--------------------------------------------------------------
009600131001       //?Operazioni iniziali.
009700131001       //--------------------------------------------------------------
009800131001       BEGSR RoutInz;
009900131001
010000131001       //?Impostazione opzioni per SQL?
010100150909         exec sql set option DynUsrPrf = *Owner,
010200150909                             CloSqlCsr = *EndMod;
010300150909
010400150909       //?Imposto le date
010500150909         wdataini = 20150701;
010600150909         wdatafin = 20150731;
010700131001
010800131001       ENDSR;
010900131001
011000131001       //--------------------------------------------------------------
011100131001       //?Elabora
011200131001       //--------------------------------------------------------------
011300150909       BEGSR Elabora;
011400131001
011500131001         wEoF = *off;
011600150911         clear TOT_cod;
011700150911         clear TOT_no_cod;
011800131001
011900131001       //?Leggo gli ORM
012000131001         exec sql
012100131001         DECLARE ORM cursor FOR
012200131001         SELECT *
012300150909         from FNORM00F
012400150911         WHERE ORMdao between :wdataini and :wdatafin
012500150911               and ORMnsr = 0 and ORMcra = 0
012600150911               and ORMpoe = ORMpor and ORMpoe = 275
012700150911         ORDER BY ORMpoe, ORMnsr, ORMnor, ORMnrv;
012800131001
012900131001         exec sql
013000131001         open ORM;
013100131001         IF sqlcode < 0;
013200131001           wEoF = *on;
013300131001         ENDIF;
013400131001
013500131001         DOW not wEoF;
013600131001           exec sql
013700150909           FETCH NEXT from ORM into :FNORM00F;
013800131001           IF sqlcod = 100 or sqlcod < 0;
013900131001             wEOF = *on;
014000131001             leave;
014100131001           ENDIF;
014200131001
014300150911           exsr BolleLegate;
014400131001
014500131001         ENDDO;
014600131001
014700131001       //?Chiudo il cursore
014800131001         exec sql
014900131001           close ORM;
015000150911
015100150911       //?Stampo totali
015200150911         except totali;
015300131001
015400131001       ENDSR;
015500131001
015600131001       //--------------------------------------------------------------
015700150911       //?Cerco le bolle legate di tipo F1.
015800131001       //--------------------------------------------------------------
015900150911       BEGSR BolleLegate;
016000150909
016100150909         wORMpoe = ORMpoe;
016200150909         wORMnsr = ORMnsr;
016300150909         wORMnor = ORMnor;
016400150909         wORMnrv = ORMnrv;
016500131001
016600150909       //?Aggancio la bolla legata
016700150909         setll (keyORM) TITA432C;
016800150909         reade (keyORM) TITA432C;
016900150909         DOW  not %eof(TITA432C);
017000150909         //?Solo bolle di tipo F1
017100150910           chain (TA4aas:TA4lnp:TA4nrs:TA4nsp:'F1') TITAS30C;
017200150909           IF  %found(TITAS30C);
017300150911           //?Sommo se codificato o non codificato
017400150911             IF  %subst(%editc(TASksc:'X'):4:4) = '8888';
017500150911               TOT_no_cod += 1;
017600150911             ELSE;
017700150911               TOT_cod += 1;
017800150911             ENDIF;
017900150909             leavesr;
018000150909           ENDIF;
018100150909           reade (keyORM) TITA432C;
018200150909         ENDDO;
018300131001
018400131001       ENDSR;
018500131001
018600131001       //--------------------------------------------------------------
018700131001       //?Operazioni finali.
018800131001       //--------------------------------------------------------------
018900131001       BEGSR RoutEnd;
019000131001
019100131001         *inLR = *on;
019200131001         return;
019300131001
019400131001       ENDSR;
019500131001
019600131001      /end-free
019700131001
019800150911     oPRTF198   e            totali         2 02
019900150911     o                                           20 'BRT S.p.A.'
020000150911     o                                           60 '**  TOTALI x ORM 275 **'
020100150911     o                       udate              110 '  /  /  '
020200150911     o                                          120 'TNVRMB34R'
020300150911     o                                          128 'Pag.'
020400150911     o                       page          Z    132
020500150911     o          e            totali         2
020600150911     o                                           20 'Totale codificati:'
020700150911     o                       TOT_cod       2   +  1
020800150911     o                                         +  1 'Totale NON codificati:'
020900150911     o                       TOT_no_cod    2   +  1
