000100131001      //---------------------------------------------------------------
000200131001      //
000300150911      //?      Aggiorna Fil.Ritiro su FNACR da WFACR
000400131001      //
000500131001      //---------------------------------------------------------------
000600131001
000700080520     h decedit('0,') datedit(*ymd.) option(*nodebugio)
000800150909     h dftactgrp(*no) actgrp(*caller)
000900040511
001000131001      //---------------------------------------------------------------
001100131001      //?Dichiarazione file.
001200131001      //---------------------------------------------------------------
001300150911      // -?File Anagrafica clienti ritiro
001400150911     fFNACR01L  uf   e           k disk
001500040511
001600131001      //---------------------------------------------------------------
001700131001      //?Definizione costanti.
001800131001      //---------------------------------------------------------------
001900131001
002000131001      //---------------------------------------------------------------
002100131001      //?Definizione schiere.
002200131001      //---------------------------------------------------------------
002300131001
002400131001      //---------------------------------------------------------------
002500131001      //?Definizione aree dati.
002600131001      //---------------------------------------------------------------
002700131001
002800131001      //---------------------------------------------------------------
002900131001      //?Definizione strutture dati.
003000131001      //---------------------------------------------------------------
003100131001
003200150909      // -?Parametri ricevuti?
003300131001     d kpjba         e ds
003400150911
003500150911      // -?File di work
003600150911     d WFACR00F      e ds                  extname(WFACR00F)
003700131001
003800131001      //---------------------------------------------------------------
003900131001      //?Definizione variabili globali.
004000131001      //---------------------------------------------------------------
004100131001
004200131001      // -?Flag booleani
004300131001     d wEoF            s               n   inz(*off)
004400131001
004500131001      // -?Campi di comodo
004600150911     d wperc           s              3s 0 inz
004700150911     d wnorm           s              5s 0 inz
004800131001
004900131001      //---------------------------------------------------------------
005000131001      //?Definizione procedure esterne.
005100131001      //---------------------------------------------------------------
005200131001
005300131001      //---------------------------------------------------------------
005400131001      //?Definizione prototipi.
005500131001      //---------------------------------------------------------------
005600131001
005700131001      //---------------------------------------------------------------
005800131001      //?Definizione key-list.
005900131001      //---------------------------------------------------------------
006000131001
006100131001      //---------------------------------------------------------------
006200131001      //?Riepilogo indicatori.
006300131001      //---------------------------------------------------------------
006400131001
006500131001      //---------------------------------------------------------------
006600131001      //?M A I N - L I N E
006700131001      //---------------------------------------------------------------
006800131001
006900131001     c     *Entry        plist
007000131001     c                   parm                    kpjba
007100131001
007200131001      /free
007300131001
007400131001       //?Operazioni iniziali
007500131001       exsr RoutInz;
007600131001
007700131001       //?Elabora file
007800131001       exsr Elabora;
007900131001
008000131001       //?Operazioni finali
008100131001       exsr RoutEnd;
008200131001
008300131001       //--------------------------------------------------------------
008400131001       //?Operazioni iniziali.
008500131001       //--------------------------------------------------------------
008600131001       BEGSR RoutInz;
008700131001
008800131001       //?Impostazione opzioni per SQL?
008900150909         exec sql set option DynUsrPrf = *Owner,
009000150909                             CloSqlCsr = *EndMod;
009100150911
009200150911       //?Impostazione i parametri
009300150911         IF  %subst(kpjbu:1:3) <> *blanks and
009400150911             %subst(kpjbu:1:3)  > *zeros;
009500150911           wperc = %dec(%subst(kpjbu:1:3):3:0);
009600150911         ENDIF;
009700150911         IF  %subst(kpjbu:4:5) <> *blanks and
009800150911             %subst(kpjbu:4:5)  > *zeros;
009900150911           wnorm = %dec(%subst(kpjbu:4:5):5:0);
010000150911         ENDIF;
010100131001
010200131001       ENDSR;
010300131001
010400131001       //--------------------------------------------------------------
010500131001       //?Elabora
010600131001       //--------------------------------------------------------------
010700150909       BEGSR Elabora;
010800131001
010900131001         wEoF = *off;
011000131001
011100131001       //?Leggo gli ORM
011200131001         exec sql
011300150911         DECLARE WFACR cursor FOR
011400131001         SELECT *
011500150911         from WFACR00F
011600150911         WHERE substr(digits(WACRcra), 1, 3) <> digits(WACRlnp)
011700150911         ORDER BY WACRcra;
011800131001
011900131001         exec sql
012000150911         open WFACR;
012100131001         IF sqlcode < 0;
012200131001           wEoF = *on;
012300131001         ENDIF;
012400131001
012500131001         DOW not wEoF;
012600131001           exec sql
012700150911           FETCH NEXT from WFACR into :WFACR00F;
012800131001           IF sqlcod = 100 or sqlcod < 0;
012900131001             wEOF = *on;
013000131001             leave;
013100131001           ENDIF;
013200131001
013300150911           IF  (wperc > 0 and wnorm = 0 and WACRper >= wperc) or
013400150911               (wperc > 0 and wnorm > 0 and WACRper >= wperc and
013500150911                WACRorm >= wnorm);
013600150911             exsr Aggiorna;
013700150911           ENDIF;
013800131001
013900131001         ENDDO;
014000131001
014100131001       //?Chiudo il cursore
014200131001         exec sql
014300150911           close WFACR;
014400131001
014500131001       ENDSR;
014600131001
014700131001       //--------------------------------------------------------------
014800150911       //?Aggiorno FNACR00F.
014900131001       //--------------------------------------------------------------
015000150911       BEGSR Aggiorna;
015100150909
015200150911         chain (WACRcra) FNACR01L;
015300150911         IF  %found(FNACR01L);
015400150911           ACRpoa = WACRlnp;
015500150911           update FNACR000;
015600150911         ENDIF;
015700131001
015800131001       ENDSR;
015900131001
016000131001       //--------------------------------------------------------------
016100131001       //?Operazioni finali.
016200131001       //--------------------------------------------------------------
016300131001       BEGSR RoutEnd;
016400131001
016500131001         *inLR = *on;
016600131001         return;
016700131001
016800131001       ENDSR;
016900131001
017000131001      /end-free
017100131001
