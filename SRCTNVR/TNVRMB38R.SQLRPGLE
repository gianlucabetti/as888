000100120423      //---------------------------------------------------------------
000200120423      //
000300151209      //?      Modifica tipi pagamento
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130314
001300130314     fCNACO00F  uf   e           k disk
001400130314     fCNCLP00F  uf   e           k disk
001500150610     fFNCLS01L  uf   e           k disk
001600120423
001700120423      //---------------------------------------------------------------
001800120423      //?Definizione costanti.
001900120423      //---------------------------------------------------------------
002000120423
002100120423      //---------------------------------------------------------------
002200120423      //?Definizione schiere.
002300120423      //---------------------------------------------------------------
002400120423
002500120423      //---------------------------------------------------------------
002600120423      //?Definizione aree dati.
002700120423      //---------------------------------------------------------------
002800120423
002900120423      //---------------------------------------------------------------
003000120423      //?Definizione strutture dati.
003100120423      //---------------------------------------------------------------
003200130214
003300130214       // -?Parametri ricevuti?
003400130214     d kpjba         e ds
003500150610
003600150610      // - File CNCLP
003700150610     d CNCLPDS       e ds                  extname(CNCLP00F)
003800150610     d                                     prefix(w)
003900150610
004000151112      // - File FNCLS
004100151112     d FNCLSDS       e ds                  extname(FNCLS00F)
004200151112     d                                     prefix(w)
004300120423
004400120423      //---------------------------------------------------------------
004500120423      //?Definizione variabili globali.
004600120423      //---------------------------------------------------------------
004700120423      // - Flags booleani
004800120423     d wEoF            s               n   inz(*off)
004900120423
005000150610      // - Campi di comodo
005100150610
005200120423      //---------------------------------------------------------------
005300120423      //?Definizione procedure esterne.
005400120423      //---------------------------------------------------------------
005500120423
005600120423      //---------------------------------------------------------------
005700120423      //?Definizione prototipi.
005800120423      //---------------------------------------------------------------
005900120423
006000120423      //---------------------------------------------------------------
006100120423      //?Definizione key-list.
006200120423      //---------------------------------------------------------------
006300120423
006400120423      //---------------------------------------------------------------
006500120423      //?Riepilogo indicatori.
006600120423      //---------------------------------------------------------------
006700120423
006800120423      //---------------------------------------------------------------
006900120423      //?M A I N - L I N E
007000120423      //---------------------------------------------------------------
007100130214
007200130214     c     *Entry        plist
007300130214     c                   parm                    kpjba
007400120423
007500120423      /free
007600120423
007700120423       //?Operazioni iniziali
007800120423       exsr RoutInz;
007900120423
008000120430       //?Elabora file
008100120430       exsr Elabora;
008200151209
008300151209       //?Elabora 8888 e 9999
008400151209       exsr Ela8899;
008500120423
008600120423       //?Operazioni finali
008700120423       exsr RoutEnd;
008800120423
008900120423       //--------------------------------------------------------------
009000120423       //?Operazioni iniziali.
009100120423       //--------------------------------------------------------------
009200120423       BEGSR RoutInz;
009300120706
009400130214       //?Impostazione opzioni per SQL?
009500130214         exec sql   set  option  DynUsrPrf = *Owner,
009600130214                                 CloSqlCsr = *EndMod;
009700120423
009800120423       ENDSR;
009900130204
010000130204       //--------------------------------------------------------------
010100130204       //?Elabora
010200130204       //--------------------------------------------------------------
010300130204       BEGSR elabora;
010400130304
010500130304         wEoF = *off;
010600130304
010700150610       //?Leggo CNCLP
010800151112       //?clienti con tipo pagamento 4
010900130304         exec sql
011000150610         DECLARE CLP cursor FOR
011100130314         SELECT *
011200150610         from CNCLP00F
011300151112         where CLPfpc = '4'
011400150610         order by CLPksc;
011500130304
011600130304         exec sql
011700150610         open CLP;
011800130304         IF sqlcode < 0;
011900130304           wEoF = *on;
012000130304         ENDIF;
012100130304
012200130304         DOW not wEoF;
012300130304           exec sql
012400150610           FETCH NEXT from CLP into :CNCLPDS;
012500130304           IF sqlcod = 100 or sqlcod < 0;
012600130304             wEOF = *on;
012700130304             leave;
012800130304           ENDIF;
012900150610
013000150610         //?Aggiorno
013100150610           chain (wCLPkut:wCLPkcc:wCLPksc) CNCLP00F;
013200150610           IF  %found(CNCLP00F);
013300151112             CLPfpc = ' ';
013400150610             update CNCLP000;
013500150610             chain (wCLPkut:wCLPkcc:wCLPksc) CNACO00F;
013600150610             IF  %found(CNACO00F);
013700150610               clear ACOdtr;
013800150610               clear ACOftr;
013900150610               update CNACO000;
014000150610             ENDIF;
014100150610           ENDIF;
014200130304
014300130304         ENDDO;
014400130304
014500130304       //?Chiudo il cursore
014600130304         exec sql
014700150610           close CLP;
014800151112
014900151112         wEoF = *off;
015000151112
015100151112       //?Leggo FNCLS
015200151112         exec sql
015300151112         DECLARE CLS cursor FOR
015400151112         SELECT *
015500151112         from FNCLS00F
015600151112         where substr(CLStic, 1, 1) = '4' or
015700151112               substr(CLStic, 2, 1) = '4'
015800151112         order by CLSksc;
015900151112
016000151112         exec sql
016100151112         open CLS;
016200151112         IF sqlcode < 0;
016300151112           wEoF = *on;
016400151112         ENDIF;
016500151112
016600151112         DOW not wEoF;
016700151112           exec sql
016800151112           FETCH NEXT from CLS into :FNCLSDS;
016900151112           IF sqlcod = 100 or sqlcod < 0;
017000151112             wEOF = *on;
017100151112             leave;
017200151112           ENDIF;
017300151112
017400151112         //?Aggiorno
017500151112           chain (wCLSksc) FNCLS01L;
017600151112           IF  %found(FNCLS01L);
017700151112             IF  %subst(CLStic:1:1) = '4';
017800151112               %subst(CLStic:1:1) = ' ';
017900151112             ENDIF;
018000151112             IF  %subst(CLStic:2:1) = '4';
018100151112               %subst(CLStic:2:1) = ' ';
018200151112             ENDIF;
018300151112             update FNCLS000;
018400151112             ACOkut = 1;
018500151112             ACOkcc = 151;
018600151112             chain (ACOkut:ACOkcc:wCLSksc) CNACO00F;
018700151112             IF  %found(CNACO00F);
018800151112               clear ACOdtr;
018900151112               clear ACOftr;
019000151112               update CNACO000;
019100151112             ENDIF;
019200151112           ENDIF;
019300151112
019400151112         ENDDO;
019500151112
019600151112       //?Chiudo il cursore
019700151112         exec sql
019800151112           close CLS;
019900130204
020000130204       ENDSR;
020100151209
020200151209       //--------------------------------------------------------------
020300151209       //?Elabora 8888 e 9999
020400151209       //--------------------------------------------------------------
020500151209       BEGSR Ela8899;
020600151209
020700151209         wEoF = *off;
020800151209
020900151209       //?Leggo CNCLP
021000151209       //?clienti 8888 e 9999 con pagamento a blank
021100151209         exec sql
021200151209         DECLARE CLP8899 cursor FOR
021300151209         SELECT *
021400151209         from CNCLP00F
021500151209         where substr(digits(CLPksc), 4, 4) in('8888', '9999')
021600151209         order by CLPksc;
021700151209
021800151209         exec sql
021900151209         open CLP8899;
022000151209         IF sqlcode < 0;
022100151209           wEoF = *on;
022200151209         ENDIF;
022300151209
022400151209         DOW not wEoF;
022500151209           exec sql
022600151209           FETCH NEXT from CLP8899 into :CNCLPDS;
022700151209           IF sqlcod = 100 or sqlcod < 0;
022800151209             wEOF = *on;
022900151209             leave;
023000151209           ENDIF;
023100151209
023200151209         //?Aggiorno
023300151209           chain (wCLPkut:wCLPkcc:wCLPksc) CNCLP00F;
023400151209           IF  %found(CNCLP00F) and CLPfpc = ' ';
023500151209             CLPfpc = '1';
023600151209             update CNCLP000;
023700151209             chain (wCLPkut:wCLPkcc:wCLPksc) CNACO00F;
023800151209             IF  %found(CNACO00F);
023900151209               clear ACOdtr;
024000151209               clear ACOftr;
024100151209               update CNACO000;
024200151209             ENDIF;
024300151209           ENDIF;
024400151209
024500151209         ENDDO;
024600151209
024700151209       //?Chiudo il cursore
024800151209         exec sql
024900151209           close CLP8899;
025000151209
025100151209         wEoF = *off;
025200151209
025300151209       //?Leggo FNCLS
025400151209         exec sql
025500151209         DECLARE CLS8899 cursor FOR
025600151209         SELECT *
025700151209         from FNCLS00F
025800151209         where substr(digits(CLSksc), 4, 4) in('8888', '9999')
025900151209         order by CLSksc;
026000151209
026100151209         exec sql
026200151209         open CLS8899;
026300151209         IF sqlcode < 0;
026400151209           wEoF = *on;
026500151209         ENDIF;
026600151209
026700151209         DOW not wEoF;
026800151209           exec sql
026900151209           FETCH NEXT from CLS8899 into :FNCLSDS;
027000151209           IF sqlcod = 100 or sqlcod < 0;
027100151209             wEOF = *on;
027200151209             leave;
027300151209           ENDIF;
027400151209
027500151209         //?Aggiorno
027600151209           chain (wCLSksc) FNCLS01L;
027700151209           IF  %found(FNCLS01L);
027800151209             IF  %subst(CLStic:1:1) = ' ';
027900151209               %subst(CLStic:1:1) = '1';
028000151209             ENDIF;
028100151209             IF  %subst(CLStic:2:1) = ' ';
028200151209               %subst(CLStic:2:1) = '1';
028300151209             ENDIF;
028400151209             update FNCLS000;
028500151209             ACOkut = 1;
028600151209             ACOkcc = 151;
028700151209             chain (ACOkut:ACOkcc:wCLSksc) CNACO00F;
028800151209             IF  %found(CNACO00F);
028900151209               clear ACOdtr;
029000151209               clear ACOftr;
029100151209               update CNACO000;
029200151209             ENDIF;
029300151209           ENDIF;
029400151209
029500151209         ENDDO;
029600151209
029700151209       //?Chiudo il cursore
029800151209         exec sql
029900151209           close CLS8899;
030000151209
030100151209       ENDSR;
030200130125
030300120423       //--------------------------------------------------------------
030400120423       //?Operazioni finali.
030500120423       //--------------------------------------------------------------
030600120423       BEGSR RoutEnd;
030700120423
030800120423         *inLR = *on;
030900120423         return;
031000120423
031100120423       ENDSR;
031200051221
031300051221      /end-free
031400051221
