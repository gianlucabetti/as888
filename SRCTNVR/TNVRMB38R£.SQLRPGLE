000100120423      //---------------------------------------------------------------
000200120423      //
000300150610      //?      Imposto tipo pagamento 2 se IBAN SM
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130314
001300130314     fCNACO00F  uf   e           k disk
001400130314     fCNCLP00F  uf   e           k disk
001500150610     fFNCLS01L  uf   e           k disk
001600120423
001700120423      //---------------------------------------------------------------
001800120423      //?Definizione costanti.
001900120423      //---------------------------------------------------------------
002000120423
002100120423      //---------------------------------------------------------------
002200120423      //?Definizione schiere.
002300120423      //---------------------------------------------------------------
002400120423
002500120423      //---------------------------------------------------------------
002600120423      //?Definizione aree dati.
002700120423      //---------------------------------------------------------------
002800120423
002900120423      //---------------------------------------------------------------
003000120423      //?Definizione strutture dati.
003100120423      //---------------------------------------------------------------
003200130214
003300130214       // -?Parametri ricevuti?
003400130214     d kpjba         e ds
003500150610
003600150610      // - File CNCLP
003700150610     d CNCLPDS       e ds                  extname(CNCLP00F)
003800150610     d                                     prefix(w)
003900150610
004000150610      // - File FNCBA00F
004100150610     d FNCBA00F      e ds                  extname(FNCBA00F)
004200120423
004300120423      //---------------------------------------------------------------
004400120423      //?Definizione variabili globali.
004500120423      //---------------------------------------------------------------
004600120423      // - Flags booleani
004700120423     d wEoF            s               n   inz(*off)
004800120423
004900150610      // - Campi di comodo
005000150610
005100120423      //---------------------------------------------------------------
005200120423      //?Definizione procedure esterne.
005300120423      //---------------------------------------------------------------
005400120423
005500120423      //---------------------------------------------------------------
005600120423      //?Definizione prototipi.
005700120423      //---------------------------------------------------------------
005800120423
005900120423      //---------------------------------------------------------------
006000120423      //?Definizione key-list.
006100120423      //---------------------------------------------------------------
006200120423
006300120423      //---------------------------------------------------------------
006400120423      //?Riepilogo indicatori.
006500120423      //---------------------------------------------------------------
006600120423
006700120423      //---------------------------------------------------------------
006800120423      //?M A I N - L I N E
006900120423      //---------------------------------------------------------------
007000130214
007100130214     c     *Entry        plist
007200130214     c                   parm                    kpjba
007300120423
007400120423      /free
007500120423
007600120423       //?Operazioni iniziali
007700120423       exsr RoutInz;
007800120423
007900120430       //?Elabora file
008000120430       exsr Elabora;
008100120423
008200120423       //?Operazioni finali
008300120423       exsr RoutEnd;
008400120423
008500120423       //--------------------------------------------------------------
008600120423       //?Operazioni iniziali.
008700120423       //--------------------------------------------------------------
008800120423       BEGSR RoutInz;
008900120706
009000130214       //?Impostazione opzioni per SQL?
009100130214         exec sql   set  option  DynUsrPrf = *Owner,
009200130214                                 CloSqlCsr = *EndMod;
009300120423
009400120423       ENDSR;
009500130204
009600130204       //--------------------------------------------------------------
009700130204       //?Elabora
009800130204       //--------------------------------------------------------------
009900130204       BEGSR elabora;
010000130304
010100130304         wEoF = *off;
010200130304
010300150610       //?Leggo CNCLP
010400150610       //?clienti con tipo pagamento 6 e IBAN SM
010500130304         exec sql
010600150610         DECLARE CLP cursor FOR
010700130314         SELECT *
010800150610         from CNCLP00F
010900150610         where CLPfpc = '6' and substr(CLPbab, 1, 2) = 'SM'
011000150610         order by CLPksc;
011100130304
011200130304         exec sql
011300150610         open CLP;
011400130304         IF sqlcode < 0;
011500130304           wEoF = *on;
011600130304         ENDIF;
011700130304
011800130304         DOW not wEoF;
011900130304           exec sql
012000150610           FETCH NEXT from CLP into :CNCLPDS;
012100130304           IF sqlcod = 100 or sqlcod < 0;
012200130304             wEOF = *on;
012300130304             leave;
012400130304           ENDIF;
012500150610
012600150610         //?Aggiorno
012700150610           chain (wCLPkut:wCLPkcc:wCLPksc) CNCLP00F;
012800150610           IF  %found(CNCLP00F);
012900150610             CLPfpc = '2';
013000150610             update CNCLP000;
013100150610             chain (wCLPkut:wCLPkcc:wCLPksc) CNACO00F;
013200150610             IF  %found(CNACO00F);
013300150610               clear ACOdtr;
013400150610               clear ACOftr;
013500150610               update CNACO000;
013600150610             ENDIF;
013700150610           ENDIF;
013800130304
013900130304         ENDDO;
014000130304
014100130304       //?Chiudo il cursore
014200130304         exec sql
014300150610           close CLP;
014400150610
014500150610         wEoF = *off;
014600150610
014700150610       //?Leggo FNCBA
014800150610       //?clienti con IBAN SM
014900150610         exec sql
015000150610         DECLARE CBA cursor FOR
015100150610         SELECT *
015200150610         from FNCBA00F
015300150610         where substr(CBAiban, 1, 2) = 'SM'
015400150610         order by CBAksc, CBApag;
015500150610
015600150610         exec sql
015700150610         open CBA;
015800150610         IF sqlcode < 0;
015900150610           wEoF = *on;
016000150610         ENDIF;
016100150610
016200150610         DOW not wEoF;
016300150610           exec sql
016400150610           FETCH NEXT from CBA into :FNCBA00F;
016500150610           IF sqlcod = 100 or sqlcod < 0;
016600150610             wEOF = *on;
016700150610             leave;
016800150610           ENDIF;
016900150610
017000150610         //?Aggiorno
017100150610           chain CBAksc FNCLS01L;
017200150611           IF  not %found(FNCLS01L);
017300150611             iter;
017400150611           ENDIF;
017500150611           IF  CBApag = 'DN' and %subst(CLStic:1:1) = '6';
017600150611             %subst(CLStic:1:1) = '2';
017700150611             update FNCLS000;
017800150611             chain (1:151:CBAksc) CNACO00F;
017900150611             IF  %found(CNACO00F);
018000150611               clear ACOdtr;
018100150611               clear ACOftr;
018200150611               update CNACO000;
018300150611             ENDIF;
018400150611           ENDIF;
018500150611           IF  CBApag = 'NA' and %subst(CLStic:2:1) = '6';
018600150611             %subst(CLStic:2:1) = '2';
018700150611             update FNCLS000;
018800150611             chain (1:151:CBAksc) CNACO00F;
018900150611             IF  %found(CNACO00F);
019000150611               clear ACOdtr;
019100150611               clear ACOftr;
019200150611               update CNACO000;
019300150611             ENDIF;
019400150611           ENDIF;
019500150610
019600150610         ENDDO;
019700150610
019800150610       //?Chiudo il cursore
019900150610         exec sql
020000150610           close CBA;
020100130204
020200130204       ENDSR;
020300130125
020400120423       //--------------------------------------------------------------
020500120423       //?Operazioni finali.
020600120423       //--------------------------------------------------------------
020700120423       BEGSR RoutEnd;
020800120423
020900120423         *inLR = *on;
021000120423         return;
021100120423
021200120423       ENDSR;
021300051221
021400051221      /end-free
021500051221
