000100131001      //---------------------------------------------------------------
000200131001      //
000300150911      //?      Controllo ORM
000400131001      //
000500131001      //---------------------------------------------------------------
000600131001
000700080520     h decedit('0,') datedit(*ymd.) option(*nodebugio)
000800040511
000900131001      //---------------------------------------------------------------
001000131001      //?Dichiarazione file.
001100131001      //---------------------------------------------------------------
001200150911      // -?File Organigramma ?
001300150911     fAZORG01L  if   e           k disk
001400150911
001500150911      // -?File Tabelle
001600150911     fTABEL00F  if   e           k disk
001700150911
001800150911      // -?File di work
001900150911     fWFORMTOT1 uf a e           k disk
002000040511
002100131001      //---------------------------------------------------------------
002200131001      //?Definizione costanti.
002300131001      //---------------------------------------------------------------
002400131001
002500131001      //---------------------------------------------------------------
002600131001      //?Definizione schiere.
002700131001      //---------------------------------------------------------------
002800131001
002900131001      //---------------------------------------------------------------
003000131001      //?Definizione aree dati.
003100131001      //---------------------------------------------------------------
003200131001
003300131001      //---------------------------------------------------------------
003400131001      //?Definizione strutture dati.
003500131001      //---------------------------------------------------------------
003600150911
003700150911      // -?Tabella Aree - TABEL00F
003800150911     d ds05          e ds
003900131001
004000150909      // -?Parametri ricevuti?
004100131001     d kpjba         e ds
004200150911
004300150911      // -?Campo ORGde3 di AZORG00F
004400150911     d OG143         e ds
004500131001
004600131001      // -?File FNORM00F
004700131001     d FNORM00F      e ds                  extname(FNORM00F)
004800150911
004900150911       // -?Controllo instradamento
005000150911     d TISI95DS      e ds                  QUALIFIED INZ
005100131001
005200131001      //---------------------------------------------------------------
005300131001      //?Definizione variabili globali.
005400131001      //---------------------------------------------------------------
005500131001
005600131001      // -?Flag booleani
005700131001     d wEoF            s               n   inz(*off)
005800131001
005900131001      // -?Campi di comodo
006000150911     d Filiale         s                   like(ORMpor)
006100150911     d Peso            s             10s 1 inz
006200150911     d Volume          s             10s 3 inz
006300150909     d wdataini        s              8s 0
006400150909     d wdatafin        s              8s 0
006500150911     d wdespoe         s                   like(ORGdes)
006600150911     d wdespor         s                   like(ORGdes)
006700150911     d wtipo           s                   like(tipo)
006800131001
006900131001      //---------------------------------------------------------------
007000131001      //?Definizione procedure esterne.
007100131001      //---------------------------------------------------------------
007200131001
007300131001      //---------------------------------------------------------------
007400131001      //?Definizione prototipi.
007500131001      //---------------------------------------------------------------
007600150911      /copy gaitrasrc/srcprotopr,TISI95R
007700131001
007800131001      //---------------------------------------------------------------
007900131001      //?Definizione key-list.
008000131001      //---------------------------------------------------------------
008100150911      // -?File TABEL00F
008200150911     d k03TABEL      e ds                  extname(TABEL00F:*key)
008300150911     d                                     prefix(k_)
008400150911     d                                     inz
008500131001
008600131001      //---------------------------------------------------------------
008700131001      //?Riepilogo indicatori.
008800131001      //---------------------------------------------------------------
008900131001
009000131001      //---------------------------------------------------------------
009100131001      //?M A I N - L I N E
009200131001      //---------------------------------------------------------------
009300131001
009400131001     c     *Entry        plist
009500131001     c                   parm                    kpjba
009600131001
009700131001      /free
009800131001
009900131001       //?Operazioni iniziali
010000131001       exsr RoutInz;
010100131001
010200131001       //?Elabora file
010300131001       exsr Elabora;
010400131001
010500131001       //?Operazioni finali
010600131001       exsr RoutEnd;
010700131001
010800131001       //--------------------------------------------------------------
010900131001       //?Operazioni iniziali.
011000131001       //--------------------------------------------------------------
011100131001       BEGSR RoutInz;
011200131001
011300131001       //?Impostazione opzioni per SQL?
011400150909         exec sql set option DynUsrPrf = *Owner,
011500150909                             CloSqlCsr = *EndMod;
011600150909
011700150909       //?Imposto le date
011800150909         wdataini = 20150701;
011900150909         wdatafin = 20150731;
012000131001
012100131001       ENDSR;
012200131001
012300131001       //--------------------------------------------------------------
012400131001       //?Elabora
012500131001       //--------------------------------------------------------------
012600150909       BEGSR Elabora;
012700131001
012800131001         wEoF = *off;
012900131001
013000131001       //?Leggo gli ORM
013100131001         exec sql
013200131001         DECLARE ORM cursor FOR
013300131001         SELECT *
013400150909         from FNORM00F
013500150911         WHERE ORMdao between :wdataini and :wdatafin
013600150911               and ORMnsr = 0 and ORMcra = 0
013700150911               and ORMtco <> 'S' and ORMtco <> 'P'
013800150911         ORDER BY ORMpoe, ORMnsr, ORMnor, ORMnrv;
013900131001
014000131001         exec sql
014100131001         open ORM;
014200131001         IF sqlcode < 0;
014300131001           wEoF = *on;
014400131001         ENDIF;
014500131001
014600131001         DOW not wEoF;
014700131001           exec sql
014800150909           FETCH NEXT from ORM into :FNORM00F;
014900131001           IF sqlcod = 100 or sqlcod < 0;
015000131001             wEOF = *on;
015100131001             leave;
015200131001           ENDIF;
015300150911
015400150911         //?Se po emissione NTW estero leggo altro ritiro
015500150911           clear OG143;
015600150911           clear ORGdes;
015700150911           chain (ORMpoe) AZORG01L;
015800150911           IF  %found(AZORG01L);
015900150911             OG143 = ORGde3;
016000150911           ENDIF;
016100150911           IF  §OGntw = 'EEX' or §OGntw = 'FED' or
016200150911               §OGntw = 'DPD';
016300150911             iter;
016400150911           ENDIF;
016500150911           wdespoe = ORGdes;
016600150911
016700150911         //?Se po ritiro NTW estero leggo altro ritiro
016800150911           clear OG143;
016900150911           chain (ORMpor) AZORG01L;
017000150911           IF  %found(AZORG01L);
017100150911             OG143 = ORGde3;
017200150911           ENDIF;
017300150911           IF  §OGntw = 'EEX' or §OGntw = 'FED' or
017400150911               §OGntw = 'DPD';
017500150911             iter;
017600150911           ENDIF;
017700150911           wdespor = ORGdes;
017800150911
017900150911         //?Decodifico tipo comunicazione ORM
018000150911           SELECT;
018100150911           WHEN  ORMtco = 'E';
018200150911             wtipo = 'MAIL/FAX';
018300150911           WHEN  ORMtco = 'F';
018400150911             wtipo = 'FILE';
018500150911           WHEN  ORMtco = 'I';
018600150911             wtipo = 'INTERNET';
018700150911           WHEN  ORMtco = 'M';
018800150911             wtipo = 'TELEFONICO';
018900150911           ENDSL;
019000131001
019100150911         //?Calcolo il peso e/o volume
019200150911           exsr PesoVolume;
019300150911
019400150911         //?Calcolo instradamento
019500150911           exsr Instradamento;
019600150911
019700150911         //?Scrivo/Aggiorno file work
019800150911           exsr FileWork;
019900131001
020000131001         ENDDO;
020100131001
020200131001       //?Chiudo il cursore
020300131001         exec sql
020400131001           close ORM;
020500131001
020600131001       ENDSR;
020700150911
020800150911       //--------------------------------------------------------------
020900150911       //?Calcolo il peso e/o volume.
021000150911       //--------------------------------------------------------------
021100150911       BEGSR  PesoVolume;
021200150911
021300150911         Peso = ORMpkg;
021400150911         Volume = ORMvlm;
021500150911
021600150911       //?Se peso a 0 lo calcolo in base ai bancali o al volume
021700150911         IF  Peso = 0;
021800150911           SELECT;
021900150911           WHEN  ORMbnc <> 0;
022000150911             Peso = ORMbnc / 1 * 200;
022100150911           WHEN  ORMvlm <> 0;
022200150911             Peso = ORMvlm * 200;
022300150911           ENDSL;
022400150911           IF  Peso > 999999,9;
022500150911             Peso = 999999,9;
022600150911           ENDIF;
022700150911         ENDIF;
022800150911
022900150911       //?Se volume a 0 lo calcolo in base ai bancali o al volume
023000150911         IF  Volume = 0;
023100150911           SELECT;
023200150911           WHEN  ORMbnc <> 0;
023300150911             Volume = ORMbnc / 1;
023400150911           WHEN  ORMpkg <> 0;
023500150911             Volume = ORMpkg / 200;
023600150911           ENDSL;
023700150911           IF  Volume > 99,999;
023800150911             Volume = 99,999;
023900150911           ENDIF;
024000150911         ENDIF;
024100150911
024200150911       ENDSR;
024300131001
024400131001       //--------------------------------------------------------------
024500150911       //?Ricalcolo l'instradamento.
024600131001       //--------------------------------------------------------------
024700150911       BEGSR Instradamento;
024800150911
024900150911         Filiale = ORMpor;
025000150911
025100150911         clear TISI95DS;
025200150911         tisi95ds.I95tcn = '7';
025300150911         tisi95ds.I95nar = ORMnar;
025400150911         tisi95ds.I95cap = ORMcar;
025500150911         tisi95ds.I95loc = ORMlor;
025600150911         tisi95ds.I95prv = ORMprr;
025700150911         tisi95ds.I95ind = ORMinr;
025800150911         tisi95ds.I95dat = ORMdar;
025900150911         tisi95ds.I95lkg = Peso;
026000150911         tisi95ds.I95lmc = Volume;
026100150911
026200150911       //?richiamo il tisi95r
026300150911         ChkCapLocalita (tisi95ds);
026400150911       //?errore o dato non affidabile
026500150911         IF  ORMnar = *blanks and tisi95ds.O95lia <> '3'  or
026600150911             ORMnar <> *blanks and tisi95ds.O95lia <> '2';
026700150911           leavesr;
026800150911         ENDIF;
026900150911
027000150911       //?Imposto la linea di instradamento
027100150911         Filiale = tisi95ds.O95lna;
027200131001
027300131001       ENDSR;
027400150911
027500150911       //--------------------------------------------------------------
027600150911       //?Scrivo/Aggiorno file di work.
027700150911       //--------------------------------------------------------------
027800150911       BEGSR FileWork;
027900150911
028000150911         chain (wtipo:ORMpoe:ORMpor:Filiale) WFORMTOT1;
028100150911         IF  %found(WFORMTOT1);
028200150911           norm += 1;
028300150911           update WFORMTOT0;
028400150911         ELSE;
028500150911           clear WFORMTOT0;
028600150911           tipo = wtipo;
028700150911           poe = ORMpoe;
028800150911           despoe = wdespoe;
028900150911           por = ORMpor;
029000150911           despor = wdespor;
029100150911           newpor = Filiale;
029200150911           chain (NEWPOR) AZORG01L;
029300150911           IF  %found(AZORG01L);
029400150911             desnewpor = ORGdes;
029500150911           ENDIF;
029600150911           norm = 1;
029700150911           chain (POE) AZORG01L;
029800150911           IF  %found(AZORG01L);
029900150911             car = ORGcar;
030000150911           ENDIF;
030100150911           clear ds05;
030200150911           k_TBLkut = 1;
030300150911           k_TBLcod = '05';
030400150911           k_TBLkey = %editc(CAR:'X');
030500150911           chain %kds(k03TABEL) TABEL00F;
030600150911           IF  %found(TABEL00F);
030700150911             ds05 = TBLuni;
030800150911           ENDIF;
030900150911           descar = §05des;
031000150911           write WFORMTOT0;
031100150911         ENDIF;
031200150911
031300150911       ENDSR;
031400131001
031500131001       //--------------------------------------------------------------
031600131001       //?Operazioni finali.
031700131001       //--------------------------------------------------------------
031800131001       BEGSR RoutEnd;
031900131001
032000131001         *inLR = *on;
032100131001         return;
032200131001
032300131001       ENDSR;
032400131001
032500131001      /end-free
