000100131001      //---------------------------------------------------------------
000200131001      //
000300160121      //?      Conta le telefonate x Appuntamento su bolle
000400160419      //?      del Anno/Mese passato
000500131001      //
000600131001      //---------------------------------------------------------------
000700131001
000800080520     h decedit('0,') datedit(*ymd.) option(*nodebugio)
000900150909     h dftactgrp(*no) actgrp(*caller)
001000040511
001100131001      //---------------------------------------------------------------
001200131001      //?Dichiarazione file.
001300131001      //---------------------------------------------------------------
001400150909      // -?File Bolle        ?
001500160121     fTITAS38C  if   e           k disk
001600080710
001700160121      // -?File Telefonate   ?
001800160121     fFITGD02L  if   e           k disk
001900160121
002000160121      // -?File di stampa    ?
002100160121     fPRTF198   o    f  198        printer oflind(*inof)
002200160121
002300160121      // -?File bolle x controllo in EDPMBTEST
002400160121     fTITASMB   o    e             disk    rename(TITAS000:TITAS)
002500040511
002600160121      // -?File Telefonate x controllo in EDPMBTEST
002700160121     fFITGDMB   o    e             disk    rename(FITGD000:FITGD)
002800160121
002900131001      //---------------------------------------------------------------
003000131001      //?Definizione costanti.
003100131001      //---------------------------------------------------------------
003200131001
003300131001      //---------------------------------------------------------------
003400131001      //?Definizione schiere.
003500131001      //---------------------------------------------------------------
003600131001
003700131001      //---------------------------------------------------------------
003800131001      //?Definizione aree dati.
003900131001      //---------------------------------------------------------------
004000131001
004100131001      //---------------------------------------------------------------
004200131001      //?Definizione strutture dati.
004300131001      //---------------------------------------------------------------
004400131001
004500150909      // -?Parametri ricevuti?
004600131001     d kpjba         e ds
004700150909
004800160121      // -?Chiave Telefonate
004900160121     d keyOGG          DS
005000160121     d  wTASlnp                       3  0
005100160121     d  wTASnrs                       2  0
005200160121     d  wTASnsp                       7  0
005300160121     d  wTASaas                       4  0
005400160121     d  wBlank                        4
005500160419
005600160419      // -?Periodo estrazione
005700160419     d periodo         DS
005800160419     d  annomese               1      6  0
005900160419     d  waas                   1      4  0
006000131001
006100131001      //---------------------------------------------------------------
006200131001      //?Definizione variabili globali.
006300131001      //---------------------------------------------------------------
006400131001
006500131001      // -?Flag booleani
006600131001     d wEoF            s               n   inz(*off)
006700131001
006800131001      // -?Campi di comodo
006900160419     d dataiso1        s               d   datfmt(*iso)
007000160419     d dataiso2        s               d   datfmt(*iso)
007100160419     d wdatai          s              8  0 inz
007200160419     d wdataf          s              8  0 inz
007300160419     d wmgsini         s                   like(TASmgs)
007400160419     d wmgsfin         s                   like(TASmgs)
007500131001
007600131001      //---------------------------------------------------------------
007700131001      //?Definizione procedure esterne.
007800131001      //---------------------------------------------------------------
007900131001
008000131001      //---------------------------------------------------------------
008100131001      //?Definizione prototipi.
008200131001      //---------------------------------------------------------------
008300131001
008400131001      //---------------------------------------------------------------
008500131001      //?Definizione key-list.
008600131001      //---------------------------------------------------------------
008700131001
008800131001      //---------------------------------------------------------------
008900131001      //?Riepilogo indicatori.
009000131001      //---------------------------------------------------------------
009100131001
009200131001      //---------------------------------------------------------------
009300131001      //?M A I N - L I N E
009400131001      //---------------------------------------------------------------
009500131001
009600131001     c     *Entry        plist
009700131001     c                   parm                    kpjba
009800131001
009900131001      /free
010000131001
010100131001       //?Operazioni iniziali
010200131001       exsr RoutInz;
010300131001
010400131001       //?Elabora file
010500131001       exsr Elabora;
010600131001
010700131001       //?Operazioni finali
010800131001       exsr RoutEnd;
010900131001
011000131001       //--------------------------------------------------------------
011100131001       //?Operazioni iniziali.
011200131001       //--------------------------------------------------------------
011300131001       BEGSR RoutInz;
011400160419
011500160419         periodo = kpjbu;
011600160419
011700160419       //?Calcolo inizio mese
011800160419         wdatai = annomese *100 + 1;
011900160419         dataiso1 = %date(wdatai);
012000160419       //?Calcolo fine mese
012100160419         dataiso2 = dataiso1 + %months(1) - %days(1);
012200160419         wdataf = %dec(dataiso2);
012300160419
012400160419       //?Imposto mese/giorno inizio e fine elaborazione
012500160419         wmgsini = %dec(%subst(%editc(wdatai:'X'):5:4):4:0);
012600160419         wmgsfin = %dec(%subst(%editc(wdataf:'X'):5:4):4:0);
012700160419
012800160419       //?Pulisco i file di work
012900160419         exec sql
013000160419         DELETE from edpmbstat/TITASMB;
013100160419         exec sql
013200160419         DELETE from edpmbstat/FITGDMB;
013300131001
013400131001       ENDSR;
013500131001
013600131001       //--------------------------------------------------------------
013700131001       //?Elabora
013800131001       //--------------------------------------------------------------
013900150909       BEGSR Elabora;
014000131001
014100131001         wEoF = *off;
014200131001
014300160419       //?Leggo le bolle del mese richiesto
014400160121         setll (waas:wmgsini) TITAS38C;
014500160121         reade (waas) TITAS38C;
014600160121         DOW not %eof(TITAS38C);
014700160121
014800160121           IF  TASmgs > wmgsfin;
014900160121             leave;
015000160121           ENDIF;
015100160121
015200160121           IF  TASftc = 'A' or TAStc2 = 'A';
015300160121             exsr Conta;
015400160121           ENDIF;
015500160121
015600160121           reade (waas) TITAS38C;
015700131001
015800131001         ENDDO;
015900131001
016000131001       ENDSR;
016100131001
016200131001       //--------------------------------------------------------------
016300160121       //?Conto le telefonate
016400131001       //--------------------------------------------------------------
016500150909       BEGSR Conta;
016600150909
016700160121         wTASlnp = TASlnp;
016800160121         wTASnrs = TASnrs;
016900160121         wTASnsp = TASnsp;
017000160121         wTASaas = TASaas;
017100160121         clear wBlank;
017200131001
017300160121       //?Aggancio il file delle telefonate
017400160121         setll ('S':keyOGG) FITGD02L;
017500160121         reade ('S':keyOGG) FITGD02L;
017600160121         DOW  not %eof(FITGD02L);
017700160121         //?Solo Telefonate
017800160122           IF  %subst(TGDflo:1:1) <> ' ' and
017900160121         //?Solo causale Appuntamento
018000160121             TGDmad = ' 15';
018100160121         //?Scrivo file x controllo
018200160121             write TITAS;
018300160121             write FITGD;
018400160121           ENDIF;
018500160121           reade ('S':keyOGG) FITGD02L;
018600150909         ENDDO;
018700131001
018800131001       ENDSR;
018900131001
019000131001       //--------------------------------------------------------------
019100131001       //?Operazioni finali.
019200131001       //--------------------------------------------------------------
019300131001       BEGSR RoutEnd;
019400160121
019500131001
019600131001         *inLR = *on;
019700131001         return;
019800131001
019900131001       ENDSR;
020000131001
020100131001      /end-free
