000100160210      //---------------------------------------------------------------
000200160210      //
000300160505      //?      Controllo Alert con Anagrafiche e ORM
000400160210      //
000500160210      //---------------------------------------------------------------
000600160210
000700160210     h decedit('0,') datedit(*ymd.) option(*nodebugio)
000800160210
000900160210      //---------------------------------------------------------------
001000160210      //?Dichiarazione file.
001100160210      //---------------------------------------------------------------
001200160505      // -?File ORM
001300160505     fFNORM01L  if   e           k disk
001400160505     fFNORE01L  if   e           k disk
001500160505
001600160505      // -?File Anagrafica Cliente - estensione
001700160505     fFNACRE1L  if   e           k disk
001800160411
001900160505      // -?File work
002000160505     fALERT     o    e             disk    rename(alert:alertorm)
002100160210
002200160210      //---------------------------------------------------------------
002300160210      //?Definizione costanti.
002400160210      //---------------------------------------------------------------
002500160210
002600160210      //---------------------------------------------------------------
002700160210      //?Definizione schiere.
002800160210      //---------------------------------------------------------------
002900160210
003000160210      //---------------------------------------------------------------
003100160210      //?Definizione aree dati.
003200160210      //---------------------------------------------------------------
003300160210
003400160210      //---------------------------------------------------------------
003500160210      //?Definizione strutture dati.
003600160210      //---------------------------------------------------------------
003700160210      // -?Parametri ricevuti?
003800160210     d kpjba         e ds
003900160210
004000160505      // -?File FISAO00F
004100160505     d FISAO00F      e ds                  extname(FISAO00F)
004200160210
004300160210      //---------------------------------------------------------------
004400160210      //?Definizione variabili globali.
004500160210      //---------------------------------------------------------------
004600160210      // -?Flag booleani
004700160210     d wEoF            s               n   inz(*off)
004800160210
004900160210      // -?Campi di comodo
005000160210
005100160210      //---------------------------------------------------------------
005200160210      //?Definizione procedure esterne.
005300160210      //---------------------------------------------------------------
005400160210
005500160210      //---------------------------------------------------------------
005600160210      //?Definizione prototipi.
005700160210      //---------------------------------------------------------------
005800160210
005900160210      //---------------------------------------------------------------
006000160210      //?Definizione key-list.
006100160210      //---------------------------------------------------------------
006200160210
006300160210      //---------------------------------------------------------------
006400160210      //?Riepilogo indicatori.
006500160210      //---------------------------------------------------------------
006600160210
006700160210      //---------------------------------------------------------------
006800160210      //?M A I N - L I N E
006900160210      //---------------------------------------------------------------
007000160210     c     *Entry        plist
007100160210     c                   parm                    kpjba
007200160210
007300160210      /free
007400160210
007500160210       //?Operazioni iniziali
007600160210       exsr RoutInz;
007700160210
007800160210       //?Elabora file
007900160210       exsr Elabora;
008000160210
008100160210       //?Operazioni finali
008200160210       exsr RoutEnd;
008300160210
008400160210       //--------------------------------------------------------------
008500160210       //?Operazioni iniziali.
008600160210       //--------------------------------------------------------------
008700160210       BEGSR RoutInz;
008800160210
008900160210       //?Impostazione opzioni per SQL?
009000160210         exec sql set option DynUsrPrf = *Owner,
009100160210                             CloSqlCsr = *EndMod;
009200160210
009300160210       ENDSR;
009400160210
009500160210       //--------------------------------------------------------------
009600160210       //?Elabora
009700160210       //--------------------------------------------------------------
009800160210       BEGSR Elabora;
009900160210
010000160210         wEoF = *off;
010100160210
010200160505       //?Leggo Alert
010300160210         exec sql
010400160505         DECLARE SAO cursor FOR
010500160210         SELECT *
010600160505         from FISAO00F
010700160505         WHERE SAOdaori > '2016-05-02-00.00.00.000000' and
010800160505               SAOtipa = 'CON' and
010900160505               SAOsts = '1'
011000160505         ORDER BY SAOpoe, SAOnsr, SAOnor, SAOnrv;
011100160210
011200160210         exec sql
011300160505         open SAO;
011400160210         IF sqlcode < 0;
011500160210           wEoF = *on;
011600160210         ENDIF;
011700160210
011800160210         DOW not wEoF;
011900160210           exec sql
012000160505           FETCH NEXT from SAO into :FISAO00F;
012100160210           IF sqlcod = 100 or sqlcod < 0;
012200160210             wEoF = *on;
012300160210             leave;
012400160210           ENDIF;
012500160210
012600160505         //?Aggancio ORM
012700160505           chain (SAOpoe:SAOnsr:SAOnor:SAOnrv) FNORM01L;
012800160505           IF  not %found(FNORM01L);
012900160210             iter;
013000160210           ENDIF;
013100160505
013200160505         //?Aggancio Dati Alert
013300160505           chain (SAOpoe:SAOnsr:SAOnor:SAOnrv:'SC') FNORE01L;
013400160505           IF  not %found(FNORE01L);
013500160505             iter;
013600160505           ENDIF;
013700160210
013800160505         //?Aggancio Anagrafica Cliente
013900160505           IF  ORMcor > 0;
014000160505             setll (ORMcor) FNACRE1L;
014100160505             reade (ORMcor) FNACRE1L;
014200160505             DOW  not %eof(FNACRE1L);
014300160505               IF  ACREtrc = 'SC';
014400160505                 exsr Scrivi;
014500160505               ENDIF;
014600160505               reade (ORMcor) FNACRE1L;
014700160505             ENDDO;
014800160505             iter;
014900160411           ENDIF;
015000160505           IF  ORMcra > 0;
015100160505             setll (ORMcra) FNACRE1L;
015200160505             reade (ORMcra) FNACRE1L;
015300160505             DOW  not %eof(FNACRE1L);
015400160505               IF  ACREtrc = 'SC' or ACREtrc = 'MC';
015500160505                 exsr Scrivi;
015600160505               ENDIF;
015700160505               reade (ORMcra) FNACRE1L;
015800160505             ENDDO;
015900160505           ENDIF;
016000160210
016100160210         ENDDO;
016200160210
016300160210       //?Chiudo il cursore
016400160210         exec sql
016500160505           close SAO;
016600160210
016700160210       ENDSR;
016800160411
016900160411       //--------------------------------------------------------------
017000160505       //?Scrivo file di work.
017100160411       //--------------------------------------------------------------
017200160505       BEGSR Scrivi;
017300160411
017400160505          write alertorm;
017500160411
017600160411       ENDSR;
017700160210
017800160210       //--------------------------------------------------------------
017900160210       //?Operazioni finali.
018000160210       //--------------------------------------------------------------
018100160210       BEGSR RoutEnd;
018200160210
018300160210         *inLR = *on;
018400160210         return;
018500160210
018600160210       ENDSR;
018700160210
018800160210      /end-free
