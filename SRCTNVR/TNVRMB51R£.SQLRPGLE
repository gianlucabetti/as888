000100120423      //---------------------------------------------------------------
000200120423      //
000300130125      //?      Cancella TFACO + file legato non presenti su TIVIS
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200130125
001300130125      // - File anagrafiche provvisorie
001400130125     fTFACO00F  uf   e           k disk
001500130125     fTFIND00F  uf   e           k disk
001600130125     fTFCLP00F  uf   e           k disk
001700130125     fTFCLS01L  uf   e           k disk
001800130125     fTFCBA01L  uf   e           k disk
001900120423
002000120423      //---------------------------------------------------------------
002100120423      //?Definizione costanti.
002200120423      //---------------------------------------------------------------
002300120423
002400120423      //---------------------------------------------------------------
002500120423      //?Definizione schiere.
002600120423      //---------------------------------------------------------------
002700120423
002800120423      //---------------------------------------------------------------
002900120423      //?Definizione aree dati.
003000120423      //---------------------------------------------------------------
003100120423
003200120423      //---------------------------------------------------------------
003300120423      //?Definizione strutture dati.
003400120423      //---------------------------------------------------------------
003500120706
003600120706      // - File trattative
003700120706     d tivisds       e ds                  extname(TIVIS00F)
003800120423
003900120423      //---------------------------------------------------------------
004000120423      //?Definizione variabili globali.
004100120423      //---------------------------------------------------------------
004200120423      // - Flags booleani
004300120423     d wEoF            s               n   inz(*off)
004400120423
004500120423      // - Campi di comodo
004600120423
004700120423      //---------------------------------------------------------------
004800120423      //?Definizione procedure esterne.
004900120423      //---------------------------------------------------------------
005000120423
005100120423      //---------------------------------------------------------------
005200120423      //?Definizione prototipi.
005300120423      //---------------------------------------------------------------
005400120423
005500120423      //---------------------------------------------------------------
005600120423      //?Definizione key-list.
005700120423      //---------------------------------------------------------------
005800120423
005900120423      //---------------------------------------------------------------
006000120423      //?Riepilogo indicatori.
006100120423      //---------------------------------------------------------------
006200120423
006300120423      //---------------------------------------------------------------
006400120423      //?M A I N - L I N E
006500120423      //---------------------------------------------------------------
006600120423
006700120423      /free
006800120423
006900120423       //?Operazioni iniziali
007000120423       exsr RoutInz;
007100120423
007200120430       //?Elabora file
007300120430       exsr Elabora;
007400120423
007500120423       //?Operazioni finali
007600120423       exsr RoutEnd;
007700120423
007800120423       //--------------------------------------------------------------
007900120423       //?Operazioni iniziali.
008000120423       //--------------------------------------------------------------
008100120423       BEGSR RoutInz;
008200120706
008300120706       //?Impostazione opzioni per SQL?
008400120706         exec sql   set  option  DynUsrPrf = *Owner,
008500120706                                 CloSqlCsr = *EndMod;
008600120423
008700120423       ENDSR;
008800120423
008900120423       //--------------------------------------------------------------
009000120430       //?Elabora file
009100120423       //--------------------------------------------------------------
009200120430       BEGSR Elabora;
009300120423
009400120423         wEoF = *off;
009500120423
009600130125       //?Leggo file Anagrafica provvisoria
009700120706         exec sql
009800130125           DECLARE  ANAGR cursor FOR
009900130125           SELECT   ACOkut, ACOkcc, ACOksc from TFACO00F
010000130125           EXCEPTION JOIN TIVIS00F
010100130125           on ACOksc = VISnrv
010200130125           ORDER BY ACOksc;
010300120706
010400120706         exec sql
010500130125           open ANAGR;
010600120706           IF sqlcode < 0;
010700120706             wEoF = *on;
010800120706           ENDIF;
010900120706
011000120706         DOW not wEoF;
011100120706           exec sql
011200130125             FETCH NEXT from ANAGR into :ACOkut, :ACOkcc, :ACOksc;
011300120706           IF sqlcod = 100 or sqlcod < 0;
011400120706             wEOF = *on;
011500120706             leave;
011600120706           ENDIF;
011700120706
011800130125         //?Cancello le anagrafiche provvisorie
011900130125           DELETE (ACOkut : ACOkcc : ACOksc) TFACO00F;
012000130125           DELETE (ACOkut : ACOkcc : ACOksc) TFIND00F;
012100130125           DELETE (ACOkut : ACOkcc : ACOksc) TFCLP00F;
012200130125           DELETE  ACOksc TFCLS01L;
012300130125
012400130125           setll ACOksc TFCBA01L;
012500130125           reade ACOksc TFCBA01L;
012600130125           DOW not %eof(TFCBA01L);
012700130125             DELETE TFCBA01L;
012800130125             reade ACOksc TFCBA01L;
012900130125           ENDDO;
013000120706
013100120706         ENDDO;
013200120706
013300120706       //?Chiudo il cursore
013400120706         exec sql
013500130125           close ANAGR;
013600120706
013700120706       ENDSR;
013800130125
013900120423       //--------------------------------------------------------------
014000120423       //?Operazioni finali.
014100120423       //--------------------------------------------------------------
014200120423       BEGSR RoutEnd;
014300120423
014400120423         *inLR = *on;
014500120423         return;
014600120423
014700120423       ENDSR;
014800051221
014900051221      /end-free
015000051221
