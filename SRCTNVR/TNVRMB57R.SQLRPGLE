000100170310      //---------------------------------------------------------------
000200170310      //?TNVRMB57R - Controllo ORM commissionati da Internet
000300170310      //---------------------------------------------------------------
000400170310     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000500170310
000600170310      //---------------------------------------------------------------
000700170310      //?Dichiarazione file.
000800170310      //---------------------------------------------------------------
000900170310     fFNORF01L  if   e           k disk
001000170310     fFNORV01L  if   e           k disk
001100170310     fTIORI01L  if   e           k disk
001200170310     fTIORE01L  if   e           k disk
001300170310     fTNVRMB57P o    e             printer oflind(*in99)
001400170310
001500170310      //---------------------------------------------------------------
001600170310      //?Definizione costanti.
001700170310      //---------------------------------------------------------------
001800170310
001900170310      //---------------------------------------------------------------
002000170310      //?Definizione schiere.
002100170310      //---------------------------------------------------------------
002200170310
002300170310      //---------------------------------------------------------------
002400170310      //?Definizione aree dati.
002500170310      //---------------------------------------------------------------
002600170310
002700170310      //---------------------------------------------------------------
002800170310      //?Definizione strutture dati.
002900170310      //---------------------------------------------------------------
003000170310     d KPJBA         e ds
003100170310
003200170310      // File ORM
003300170310     d FNORM00F      e ds                  extname(FNORM00F)
003400170310
003500170310      // Campo ORMFLO
003600170310     d dORM01        e ds
003700170310
003800170310      // Campo VAOEDATI - Rcd "G "
003900170310     d dOREgen       e ds
004000170310
004100170310      //---------------------------------------------------------------
004200170310      //?Definizione variabili globali.
004300170310      //---------------------------------------------------------------
004400170310      // - Flags booleani
004500170310     d Fine            s               n   inz(*off)
004600170310     d wStampa         s               n   inz(*off)
004700170310
004800170310      // - Campi di comodo
004900170310     d mail            s                   like(VAOEdati) inz
005000170310     d sms             s                   like(VAOEdati) inz
005100170310     d sav_ORMdao      s                   like(ORMdao) inz
005200170310     d w0070           s              7s 0
005300170310
005400170310      //---------------------------------------------------------------
005500170310      //?Definizione procedure esterne.
005600170310      //---------------------------------------------------------------
005700170310
005800170310      //---------------------------------------------------------------
005900170310      //?Definizione prototipi.
006000170310      //---------------------------------------------------------------
006100170310
006200170310      //---------------------------------------------------------------
006300170310      //?Definizione key-list.
006400170310      //---------------------------------------------------------------
006500170310
006600170310      //---------------------------------------------------------------
006700170310      //?Riepilogo indicatori.
006800170310      //---------------------------------------------------------------
006900170310      // 99 : Salto pagina
007000170310
007100170310      //---------------------------------------------------------------
007200170310      //?M A I N - L I N E
007300170310      //---------------------------------------------------------------
007400170310
007500170310      /free
007600170310
007700170310       //?Operazioni iniziali
007800170310       exsr RoutInz;
007900170310
008000170310       //?Leggo ORM SOLO Internet Commissionati senza serie
008100170310       exec sql
008200170310       DECLARE ORM cursor for
008300170310       SELECT * from FNORM00F
008400170310       WHERE ORMnsr = 0 and ORMtco = 'I' and substr(ORMflo, 6, 1) = 'S'
008500170310       ORDER BY ORMdao;
008600170310
008700170310       //?Apertura del cursore
008800170310       exec sql open ORM;
008900170310
009000170310       IF sqlcode < 0;
009100170310         Fine = *on;
009200170310       ENDIF;
009300170310
009400170310       DOW not Fine;
009500170310
009600170310         exec sql FETCH next from ORM into :FNORM00F;
009700170310
009800170310         IF  sqlcod = 100 or sqlcod < 0;
009900170310           Fine = *on;
010000170310           leave;
010100170310         ENDIF;
010200170310
010300170310         exsr Elabora;
010400170310
010500170310       ENDDO;
010600170310
010700170310       //?chiudo il cursore
010800170310       exec sql CLOSE ORM;
010900170310
011000170310       //?Stampa totali
011100170310       exsr Stampa;
011200170310
011300170310       //?Operazioni finali
011400170310       exsr RoutEnd;
011500170310
011600170310       //--------------------------------------------------------------
011700170310       //?Operazioni iniziali.
011800170310       //--------------------------------------------------------------
011900170310       BEGSR RoutInz;
012000170310
012100170310       ENDSR;
012200170310
012300170310       //--------------------------------------------------------------
012400170310       //?Aggiorna potenziale.
012500170310       //--------------------------------------------------------------
012600170310       BEGSR Elabora;
012700170310
012800170310       //?A rottura di Data stampa il totale degli ORM trovati
012900170310         IF  ORMdao <> sav_ORMdao;
013000170310           IF  sav_ORMdao > 0 and ORMimmessi > 0;
013100170310             exsr Stampa;
013200170310           ENDIF;
013300170310           clear ORMimmessi;
013400170310           clear ORMvariati;
013500170310           sav_ORMdao = ORMdao;
013600170310         ENDIF;
013700170310
013800170310       //?Cerco il corrispondente su TIORI
013900170310         dORM01 = ORMflo;
014000170310         w0070 = %int(§ORMpg);
014100170310         chain w0070 TIORI01L;
014200170310         IF  not %found(TIORI01L);
014300170310           leavesr;
014400170310         ENDIF;
014500170310
014600170310       //?Conto quanti immessi
014700170310         ORMimmessi += 1;
014800170310
014900170310       //?Stessa data vado via
015000170310         IF  ORMdar = VAOdar;
015100170310           leavesr;
015200170310         ENDIF;
015300170310
015400170310       //?Cerco il rcd 'G'
015500170310         VAOEtrc = 'G ';
015600170310         clear dOREgen;
015700170310         chain (w0070:VAOEtrc) TIORE01L;
015800170310         IF  not %found(TIORE01L);
015900170310           leavesr;
016000170310         ENDIF;
016100170310
016200170310         dOREgen = VAOEdati;
016300170310
016400170310       //?Se richiesto l'alert vado via
016500170310         IF  §OREfimv = 'S' and §OREFisv = 'S';
016600170310           leavesr;
016700170310         ENDIF;
016800170310
016900170310         clear mail;
017000170310         clear sms;
017100170310
017200170310       //?Cerco il rcd 'MA'
017300170310         VAOEtrc = 'MA';
017400170310         chain (w0070:VAOEtrc) TIORE01L;
017500170310         IF  %found(TIORE01L);
017600170310           mail = VAOEdati;
017700170310         ENDIF;
017800170310
017900170310       //?Cerco il rcd 'S'
018000170310         VAOEtrc = 'S ';
018100170310         chain (w0070:VAOEtrc) TIORE01L;
018200170310         IF  %found(TIORE01L);
018300170310           sms = VAOEdati;
018400170310         ENDIF;
018500170310
018600170310       //?Non ho richiesto l'alert ma ho i dati
018700170310         IF  (sms <> *blanks and §OREfisv <> 'S') or
018800170310             (mail <> *blanks and §OREfimv <> 'S');
018900170310         //?Vado a vedere se ho una variazione fatta alla data di ritiro
019000170310           setll (ORMpoe:ORMnsr:ORMnor:ORMnrv) FNORV01L;
019100170310           reade (ORMpoe:ORMnsr:ORMnor:ORMnrv) FNORV01L;
019200170310           DOW  not %eof(FNORV01L);
019300170310           //?Trovo la data variata esco
019400170310             IF  ORVdar <> ORMdar;
019500170310               leavesr;
019600170310             ENDIF;
019700170310             reade (ORMpoe:ORMnsr:ORMnor:ORMnrv) FNORV01L;
019800170310           ENDDO;
019900170310
020000170310       //?Se arrivo qua vuol dire che la data non è stata variata
020100170310       //?quindi controllo se la prima fase fatta sull'ORM è stata
020200170310       //?fatta in maniera automatica
020300170310       //?se non è così vado via
020400170310           chain (ORMpoe:ORMnsr:ORMnor:ORMnrv) FNORF01L;
020500170310           IF  ORFpue <> 'BATCH';
020600170310             leavesr;
020700170310           ENDIF;
020800170310
020900170310       //?Conto quanti ORM sono stati variati in automatico
021000170310           ORMvariati += 1;
021100170310         ENDIF;
021200170310
021300170310       ENDSR;
021400170310
021500170310       //--------------------------------------------------------------
021600170310       //?Stampa di controllo.
021700170310       //--------------------------------------------------------------
021800170310       BEGSR Stampa;
021900170310
022000170310         IF  not wStampa or *in99;
022100170310           write MB5701P;
022200170310           write MB5702P;
022300170310           wStampa = *on;
022400170310           *in99 = *off;
022500170310         ENDIF;
022600170310
022700170310         write MB5703P;
022800170310
022900170310       ENDSR;
023000170310
023100170310       //--------------------------------------------------------------
023200170310       //?Operazioni finali.
023300170310       //--------------------------------------------------------------
023400170310       BEGSR RoutEnd;
023500170310
023600170310         *inLR = *on;
023700170310         return;
023800170310
023900170310       ENDSR;
024000170310
024100170310      /end-free
