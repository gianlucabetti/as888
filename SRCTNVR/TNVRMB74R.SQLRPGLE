000100100413      //---------------------------------------------------------------
000200111124      //?TNVRMB74R - BAN x Nicola
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000111125     fBOLLEBAN01uf a e           k disk
001100100413
001200100413      //---------------------------------------------------------------
001300100413      //?Definizione costanti.
001400100413      //---------------------------------------------------------------
001500100413
001600100413      //---------------------------------------------------------------
001700100413      //?Definizione schiere.
001800100413      //---------------------------------------------------------------
001900090715
002000100413      //---------------------------------------------------------------
002100100413      //?Definizione aree dati.
002200100413      //---------------------------------------------------------------
002300100413
002400100413      //---------------------------------------------------------------
002500100413      //?Definizione strutture dati.
002600100413      //---------------------------------------------------------------
002700111125
002800111125      // Bolle di sede
002900111125     d SISDPds       e ds                  extname(SISDP00F)
003000111125     d SISDEds       e ds                  extname(SISDE00F)
003100111124
003200111124      // DS x AR5
003300111125     d dAR5BANsde    e ds
003400110704
003500100413      //---------------------------------------------------------------
003600100413      //?Definizione variabili globali.
003700100413      //---------------------------------------------------------------
003800100413
003900100413      // - Flags booleani
004000100413     d $End            s               n   inz(*off)
004100111124
004200111124      // - Campi di comodo
004300111125     d sav_TASksc      s                   like(SDPksc)
004400111124     d totban          s              7  0
004500111124     d totspe          s              7  0
004600111125     d totfat          s             15  3
004700100413
004800100413      //---------------------------------------------------------------
004900100413      //?Definizione procedure esterne.
005000100413      //---------------------------------------------------------------
005100100413
005200100413      //---------------------------------------------------------------
005300100413      //?prototipi
005400100413      //---------------------------------------------------------------
005500100413
005600100413      //---------------------------------------------------------------
005700100413      //?Definizione key-list.
005800100413      //---------------------------------------------------------------
005900100413
006000100413      //---------------------------------------------------------------
006100100413      //?Riepilogo indicatori.
006200100413      //---------------------------------------------------------------
006300100413
006400100413      //---------------------------------------------------------------
006500100413      //?M A I N - L I N E
006600100413      //---------------------------------------------------------------
006700100413
006800100413      /free
006900111124
007000111124       //?Operazioni iniziali
007100111124       exsr RoutInz;
007200111124
007300111124       //?Elabora i dati
007400111124       exsr Elabora;
007500111124
007600111124       //?Operazioni finali
007700111124       exsr RoutEnd;
007800100413
007900111124       //--------------------------------------------------------------
008000111124       //?Operazioni iniziali.
008100111124       //--------------------------------------------------------------
008200111124       BEGSR RoutInz;
008300111124
008400111124
008500111124       ENDSR;
008600111124
008700111124       //--------------------------------------------------------------
008800111124       //?Elabora i dati.
008900111124       //--------------------------------------------------------------
009000111124       BEGSR Elabora;
009100111125
009200111125         //?Leggo SISDP
009300111125         $End = *off;
009400111125
009500111125         //?Dichiarazione del cursore
009600111125         exec sql
009700111125         DECLARE SDP cursor for
009800111125         SELECT SDPksc, SDPnsp, SDPrcp
009900111125         FROM SISDP00F
010000111125         WHERE SDPANN = 2011 and SDPsvr = '='
010100111125         ORDER by SDPKSC;
010200111125
010300111125         //?Apertura del cursore
010400111125         exec sql open SDP;
010500111125
010600111125         IF sqlcode < 0;
010700111125           $End = *on;
010800111125         ENDIF;
010900111125
011000111125         //?Leggo il file estratto
011100111125         DOW not $End;
011200111125
011300111125           exec sql FETCH next from SDP into :SDPksc, :SDPnsp, :SDPrcp;
011400111125
011500111125           IF sqlcod = 100 or sqlcod < 0;
011600111125             $End = *on;
011700111125             leave;
011800111125           ENDIF;
011900111125
012000111125           exsr Calfat;
012100111125
012200111125         ENDDO;
012300111125
012400111125       //?Scrivo ultimo cliente
012500111125         chain sav_TASksc BOLLEBAN01;
012600111125         IF  %found(BOLLEBAN01);
012700111125           spe += totspe;
012800111125           fat += totfat;
012900111125           update BOLLEBAN00;
013000111125         ELSE;
013100111125           ksc = sav_TASksc;
013200111125           clear ban;
013300111125           spe = totspe;
013400111125           fat = totfat;
013500111125           write BOLLEBAN00;
013600111125         ENDIF;
013700111125         sav_TASksc = SDPksc;
013800111125         clear totspe;
013900111125         clear totfat;
014000111125
014100111125         //?chiudo il cursore
014200111125         exec sql CLOSE SDP;
014300111125
014400111125         //?Leggo SISDE
014500111125         $End = *off;
014600111125         clear sav_TASksc;
014700111125         clear totspe;
014800111125         clear totfat;
014900111125
015000111125         //?Dichiarazione del cursore
015100111125         exec sql
015200111125         DECLARE SDE cursor for
015300111125         SELECT SDEksc, SDEuni
015400111125         FROM SISDE00F
015500111125         WHERE SDEANN = 2011 and SDEtrd = 'BAN' and
015600111125               SDErbl not in('R', 'C')
015700111125         ORDER by SDEKSC;
015800111125
015900111125         //?Apertura del cursore
016000111125         exec sql open SDE;
016100111125
016200111125         IF sqlcode < 0;
016300111125           $End = *on;
016400111125         ENDIF;
016500111125
016600111125         //?Leggo il file estratto
016700111125         DOW not $End;
016800111125
016900111125           exec sql FETCH next from SDE into :SDEksc, :SDEuni;
017000111125
017100111125           IF sqlcod = 100 or sqlcod < 0;
017200111125             $End = *on;
017300111125             leave;
017400111125           ENDIF;
017500111125
017600111125           exsr Calban;
017700111125
017800111125         ENDDO;
017900111125
018000111125         //?Aggiorno ultimo cliente
018100111125         chain sav_TASksc BOLLEBAN01;
018200111125         IF  %found(BOLLEBAN01);
018300111125           ban += totban;
018400111125           update BOLLEBAN00;
018500111125         ENDIF;
018600111125
018700111125         //?chiudo il cursore
018800111125         exec sql CLOSE SDE;
018900111124
019000111124       ENDSR;
019100111125
019200111125       //--------------------------------------------------------------
019300111125       //?Calcola e scrive file.
019400111125       //--------------------------------------------------------------
019500111125       BEGSR Calfat;
019600111125
019700111125         //?A rottura di KSC scrivo il file
019800111125         IF  SDPksc <> sav_TASksc;
019900111125           IF  sav_TASksc > 0;
020000111125             chain sav_TASksc BOLLEBAN01;
020100111125             IF  %found(BOLLEBAN01);
020200111125               spe += totspe;
020300111125               fat += totfat;
020400111125               update BOLLEBAN00;
020500111125             ELSE;
020600111125               ksc = sav_TASksc;
020700111125               clear ban;
020800111125               spe = totspe;
020900111125               fat = totfat;
021000111125               write BOLLEBAN00;
021100111125             ENDIF;
021200111125           ENDIF;
021300111125           sav_TASksc = SDPksc;
021400111125           clear totspe;
021500111125           clear totfat;
021600111125         ENDIF;
021700111125
021800111125         totspe += SDPnsp;
021900111125         totfat += SDPrcp;
022000111125
022100111125       ENDSR;
022200111125
022300111125       //--------------------------------------------------------------
022400111125       //?Calcola e scrive file.
022500111125       //--------------------------------------------------------------
022600111125       BEGSR Calban;
022700111125
022800111125         //?A rottura di KSC scrivo il file
022900111125         IF  SDEksc <> sav_TASksc;
023000111125           IF  sav_TASksc > 0;
023100111125             chain sav_TASksc BOLLEBAN01;
023200111125             IF  %found(BOLLEBAN01);
023300111125               ban += totban;
023400111125               update BOLLEBAN00;
023500111125             ENDIF;
023600111125           ENDIF;
023700111125           sav_TASksc = SDEksc;
023800111125           clear totban;
023900111125         ENDIF;
024000111125
024100111125         dAR5BANsde = SDEuni;
024200111125         totban += §BANnba + §BANnb2;
024300111125
024400111125       ENDSR;
024500111125
024600111124       //--------------------------------------------------------------
024700111124       //?Operazioni finali.
024800111124       //--------------------------------------------------------------
024900111124       BEGSR RoutEnd;
025000111124
025100100413         *inLR = *on;
025200100413         return;
025300111124
025400111124       ENDSR;
025500100413
025600100413      /end-free
