000100100413      //---------------------------------------------------------------
000200111124      //?TNVRMB75R - BNB x Nicola
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000111124     fFIAR531C  if   e           k disk
001100111125     fBOLLEBNB01uf a e           k disk
001200100413
001300100413      //---------------------------------------------------------------
001400100413      //?Definizione costanti.
001500100413      //---------------------------------------------------------------
001600100413
001700100413      //---------------------------------------------------------------
001800100413      //?Definizione schiere.
001900100413      //---------------------------------------------------------------
002000090715
002100100413      //---------------------------------------------------------------
002200100413      //?Definizione aree dati.
002300100413      //---------------------------------------------------------------
002400100413
002500100413      //---------------------------------------------------------------
002600100413      //?Definizione strutture dati.
002700100413      //---------------------------------------------------------------
002800111125
002900111125      // Bolle di sede
003000111125     d TITASds       e ds                  extname(TITAS00F)
003100111124
003200111124      // DS x AR5
003300111124     d dAR5BNB       e ds
003400110704
003500100413      //---------------------------------------------------------------
003600100413      //?Definizione variabili globali.
003700100413      //---------------------------------------------------------------
003800100413
003900100413      // - Flags booleani
004000100413     d $End            s               n   inz(*off)
004100111124
004200111124      // - Campi di comodo
004300111124     d sav_TASlnp      s                   like(TASlnp)
004400111124     d totban          s              7  0
004500111124     d totspe          s              7  0
004600111124     d bannrs          s              7  0
004700111124     d spenrs          s              7  0
004800111124     d w_TASaas        s                   like(TASaas)
004900100413
005000100413      //---------------------------------------------------------------
005100100413      //?Definizione procedure esterne.
005200100413      //---------------------------------------------------------------
005300100413
005400100413      //---------------------------------------------------------------
005500100413      //?prototipi
005600100413      //---------------------------------------------------------------
005700100413
005800100413      //---------------------------------------------------------------
005900100413      //?Definizione key-list.
006000100413      //---------------------------------------------------------------
006100100413
006200100413      //---------------------------------------------------------------
006300100413      //?Riepilogo indicatori.
006400100413      //---------------------------------------------------------------
006500100413
006600100413      //---------------------------------------------------------------
006700100413      //?M A I N - L I N E
006800100413      //---------------------------------------------------------------
006900100413
007000100413      /free
007100111124
007200111124       //?Operazioni iniziali
007300111124       exsr RoutInz;
007400111124
007500111124       //?Elabora i dati
007600111124       exsr Elabora;
007700111124
007800111124       //?Operazioni finali
007900111124       exsr RoutEnd;
008000100413
008100111124       //--------------------------------------------------------------
008200111124       //?Operazioni iniziali.
008300111124       //--------------------------------------------------------------
008400111124       BEGSR RoutInz;
008500111124
008600111124
008700111124       ENDSR;
008800111124
008900111124       //--------------------------------------------------------------
009000111124       //?Elabora i dati.
009100111124       //--------------------------------------------------------------
009200111124       BEGSR Elabora;
009300111125
009400111125         //?Estraggo le bolle 2011 da TITASP
009500111125         $End = *off;
009600111125
009700111125         //?Dichiarazione del cursore
009800111125         exec sql
009900111125         DECLARE TASP cursor for
010000111125         SELECT TITASP0F.*
010100111125         FROM TITASP0F
010200111125         WHERE TASAAS = 2011 and
010300111125               substr(TASgva, 1, 1) = 'O'
010400111125         ORDER by TASaas, TASlnp;
010500111125
010600111125         //?Apertura del cursore
010700111125         exec sql open TASP;
010800111125
010900111125         IF sqlcode < 0;
011000111125           $End = *on;
011100111125         ENDIF;
011200111125
011300111125         //?Leggo il file estratto
011400111125         DOW not $End;
011500111125
011600111125           exec sql FETCH next from TASP into :TITASds;
011700111125
011800111125           IF sqlcod = 100 or sqlcod < 0;
011900111125             $End = *on;
012000111125             leave;
012100111125           ENDIF;
012200111125
012300111125           exsr Calcola;
012400111125
012500111125         ENDDO;
012600111125
012700111125         exsr Ultimo;
012800111125
012900111125         //?chiudo il cursore
013000111125         exec sql CLOSE TASP;
013100111125
013200111125         //?Estraggo le bolle 2011 da TITAS10
013300111125         $End = *off;
013400111125
013500111125         //?Dichiarazione del cursore
013600111125         exec sql
013700111125         DECLARE TAS10 cursor for
013800111125         SELECT TITAS10F.*
013900111125         FROM TITAS10F
014000111125         WHERE TASAAS = 2011 and
014100111125               substr(TASgva, 1, 1) = 'O' and
014200111125               TASmgs < 1100
014300111125         ORDER by TASaas, TASlnp;
014400111125
014500111125         //?Apertura del cursore
014600111125         exec sql open TAS10;
014700111125
014800111125         IF sqlcode < 0;
014900111125           $End = *on;
015000111125         ENDIF;
015100111125
015200111125         //?Leggo il file estratto
015300111125         DOW not $End;
015400111125
015500111125           exec sql FETCH next from TAS10 into :TITASds;
015600111125
015700111125           IF sqlcod = 100 or sqlcod < 0;
015800111125             $End = *on;
015900111125             leave;
016000111125           ENDIF;
016100111125
016200111125           exsr Calcola;
016300111125
016400111125         ENDDO;
016500111125
016600111125         exsr Ultimo;
016700111125
016800111125         //?chiudo il cursore
016900111125         exec sql CLOSE TAS10;
017000111125
017100111125         //?Estraggo le bolle 2011 da TITAS0
017200111125         $End = *off;
017300111125
017400111125         //?Dichiarazione del cursore
017500111125         exec sql
017600111125         DECLARE TAS0 cursor for
017700111125         SELECT TITAS00F.*
017800111125         FROM TITAS00F
017900111125         WHERE TASAAS = 2011 and
018000111125               substr(TASgva, 1, 1) = 'O' and
018100111125               TASmgs < 1100
018200111125         ORDER by TASaas, TASlnp;
018300111125
018400111125         //?Apertura del cursore
018500111125         exec sql open TAS0;
018600111125
018700111125         IF sqlcode < 0;
018800111125           $End = *on;
018900111125         ENDIF;
019000111125
019100111125         //?Leggo il file estratto
019200111125         DOW not $End;
019300111125
019400111125           exec sql FETCH next from TAS0 into :TITASds;
019500111125
019600111125           IF sqlcod = 100 or sqlcod < 0;
019700111125             $End = *on;
019800111125             leave;
019900111125           ENDIF;
020000111125
020100111125           exsr Calcola;
020200111125
020300111125         ENDDO;
020400111125
020500111125         exsr Ultimo;
020600111125
020700111125         //?chiudo il cursore
020800111125         exec sql CLOSE TAS0;
020900111125
021000111125       ENDSR;
021100111125
021200111125       //--------------------------------------------------------------
021300111125       //?Calcola e scrive file.
021400111125       //--------------------------------------------------------------
021500111125       BEGSR Calcola;
021600111124
021700111124         //?A rottura di LNP scrivo il file
021800111125         IF  TASlnp <> sav_TASlnp;
021900111125           IF  sav_TASlnp > 0;
022000111125             chain sav_TASLNP BOLLEBNB01;
022100111125             IF  %found(BOLLEBNB01);
022200111125               bnb += totban;
022300111125               spe += totspe;
022400111125               bnbdiskb += bannrs;
022500111125               spediskb += spenrs;
022600111125               update BOLLEBNB00;
022700111125             ELSE;
022800111125               lnp = sav_TASlnp;
022900111125               bnb = totban;
023000111125               spe = totspe;
023100111125               bnbdiskb  = bannrs;
023200111125               spediskb  = spenrs;
023300111125               write BOLLEBNB00;
023400111125             ENDIF;
023500111125           ENDIF;
023600111125           sav_TASlnp = TASlnp;
023700111125           clear totban;
023800111125           clear totspe;
023900111125           clear bannrs;
024000111125           clear spenrs;
024100111125         ENDIF;
024200111124
024300111125         //?Aggancio FIAR5 rcd BNB
024400111125         chain (TASaas:TASlnp:TASnrs:TASnsp:'BNB') FIAR531C;
024500111125         IF   %found(FIAR531C);
024600111125           dAR5bnb = AR5uni;
024700111125         //?Sommo bancali e conto le bolle
024800111125           totban += 你R5bnba + 你R5bnb2;
024900111125           totspe += 1;
025000111125           //?Controllo se DISK B
025100111125           IF  AR5nrs > 0;
025200111125             bannrs += 你R5bnba + 你R5bnb2;
025300111125             spenrs += 1;
025400111125           ENDIF;
025500111125         ENDIF;
025600111124
025700111124       ENDSR;
025800111125
025900111125       //--------------------------------------------------------------
026000111125       //?Scrivo l'ultimo rcd.
026100111125       //--------------------------------------------------------------
026200111125       BEGSR Ultimo;
026300111125
026400111125         //?Scrivo l'ultima LNP
026500111125         IF  sav_TASlnp > 0;
026600111125           chain sav_TASLNP BOLLEBNB01;
026700111125           IF  %found(BOLLEBNB01);
026800111125             bnb += totban;
026900111125             spe += totspe;
027000111125             bnbdiskb += bannrs;
027100111125             spediskb += spenrs;
027200111125             update BOLLEBNB00;
027300111125           ELSE;
027400111125             lnp = sav_TASlnp;
027500111125             bnb = totban;
027600111125             spe = totspe;
027700111125             bnbdiskb  = bannrs;
027800111125             spediskb  = spenrs;
027900111125             write BOLLEBNB00;
028000111125           ENDIF;
028100111125           clear sav_TASlnp;
028200111125           clear totban;
028300111125           clear totspe;
028400111125           clear bannrs;
028500111125           clear spenrs;
028600111125         ENDIF;
028700111125
028800111125       ENDSR;
028900111124
029000111124       //--------------------------------------------------------------
029100111124       //?Operazioni finali.
029200111124       //--------------------------------------------------------------
029300111124       BEGSR RoutEnd;
029400111124
029500100413         *inLR = *on;
029600100413         return;
029700111124
029800111124       ENDSR;
029900100413
030000100413      /end-free
