000100120423      //---------------------------------------------------------------
000200120423      //
000300120706      //?      Sistema VISINFOT se trattativa con tutte le INFO
000400120423      //
000500120423      //---------------------------------------------------------------
000600120423
000700120423     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000800120423
000900120423      //---------------------------------------------------------------
001000120423      //?Dichiarazione file.
001100120423      //---------------------------------------------------------------
001200120423
001300120706      // - File Trattative
001400120706     fTIVIS05L  uf   e           k disk
001500120423
001600120706      // - File Info Trattative
001700120706     fTIVII01L  if   e           k disk
001800120423
001900120423      //---------------------------------------------------------------
002000120423      //?Definizione costanti.
002100120423      //---------------------------------------------------------------
002200120423
002300120423      //---------------------------------------------------------------
002400120423      //?Definizione schiere.
002500120423      //---------------------------------------------------------------
002600120423
002700120423      //---------------------------------------------------------------
002800120423      //?Definizione aree dati.
002900120423      //---------------------------------------------------------------
003000120423
003100120423      //---------------------------------------------------------------
003200120423      //?Definizione strutture dati.
003300120423      //---------------------------------------------------------------
003400120706
003500120706      // - File trattative
003600120706     d tivisds       e ds                  extname(TIVIS00F)
003700120706     d                                     prefix(w_)
003800120423
003900120423      //---------------------------------------------------------------
004000120423      //?Definizione variabili globali.
004100120423      //---------------------------------------------------------------
004200120423      // - Flags booleani
004300120423     d wEoF            s               n   inz(*off)
004400120706     d wOkInfo         s               n   inz(*off)
004500120423
004600120423      // - Campi di comodo
004700120423
004800120423      //---------------------------------------------------------------
004900120423      //?Definizione procedure esterne.
005000120423      //---------------------------------------------------------------
005100120423
005200120423      //---------------------------------------------------------------
005300120423      //?Definizione prototipi.
005400120423      //---------------------------------------------------------------
005500120423
005600120423      //---------------------------------------------------------------
005700120423      //?Definizione key-list.
005800120423      //---------------------------------------------------------------
005900120423
006000120423      //---------------------------------------------------------------
006100120423      //?Riepilogo indicatori.
006200120423      //---------------------------------------------------------------
006300120423
006400120423      //---------------------------------------------------------------
006500120423      //?M A I N - L I N E
006600120423      //---------------------------------------------------------------
006700120423
006800120423      /free
006900120423
007000120423       //?Operazioni iniziali
007100120423       exsr RoutInz;
007200120423
007300120430       //?Elabora file
007400120430       exsr Elabora;
007500120423
007600120423       //?Operazioni finali
007700120423       exsr RoutEnd;
007800120423
007900120423       //--------------------------------------------------------------
008000120423       //?Operazioni iniziali.
008100120423       //--------------------------------------------------------------
008200120423       BEGSR RoutInz;
008300120706
008400120706       //?Impostazione opzioni per SQL?
008500120706         exec sql   set  option  DynUsrPrf = *Owner,
008600120706                                 CloSqlCsr = *EndMod;
008700120423
008800120423       ENDSR;
008900120423
009000120423       //--------------------------------------------------------------
009100120430       //?Elabora file
009200120423       //--------------------------------------------------------------
009300120430       BEGSR Elabora;
009400120423
009500120423         wEoF = *off;
009600120423
009700120706       //?Leggo file Trattative
009800120706         exec sql
009900120706           DECLARE  TRATT cursor FOR
010000120706           SELECT   * from TIVIS00F
010100120706           WHERE    VISinfot = ' '
010200120706           ORDER BY VISnrv;
010300120706
010400120706         exec sql
010500120706           open TRATT;
010600120706           IF sqlcode < 0;
010700120706             wEoF = *on;
010800120706           ENDIF;
010900120706
011000120706         DOW not wEoF;
011100120706           exec sql
011200120706             FETCH NEXT from TRATT into :TIVISDS;
011300120706           IF sqlcod = 100 or sqlcod < 0;
011400120706             wEOF = *on;
011500120706             leave;
011600120706           ENDIF;
011700120706
011800120706         //?Controllo se OK tutte le INFO
011900120706           wOkInfo = *on;
012000120706           exsr CtrInfo;
012100120706
012200120706         //?Se OK aggiorno TIVIS
012300120706           IF  wOkInfo;
012400120706           chain(e)  w_VISnrv  TIVIS05L;
012500120706             IF  not %error;
012600120706               VISinfot = 'S';
012700120706               update TIVIS000;
012800120706             ENDIF;
012900120706           ENDIF;
013000120706
013100120706         ENDDO;
013200120706
013300120706       //?Chiudo il cursore
013400120706         exec sql
013500120706           close TRATT;
013600120706
013700120706       ENDSR;
013800120706
013900120706       //--------------------------------------------------------------
014000120706       //?Controllo le INFO.
014100120706       //--------------------------------------------------------------
014200120706       BEGSR CtrInfo;
014300120423
014400120706         //?Fatturato/Spedizioni totale
014500120706         chain (w_VISNRV:'TRT') TIVII01L;
014600120706         IF  not %found(TIVII01L);
014700120706           wOkInfo = *off;
014800120706           leavesr;
014900120706         ENDIF;
015000120706         //?Delta
015100120706         chain (w_VISNRV:'DEL') TIVII01L;
015200120706         IF  not %found(TIVII01L);
015300120706           wOkInfo = *off;
015400120706           leavesr;
015500120706         ENDIF;
015600120706         //?Peso
015700120706         chain (w_VISNRV:'KMS') TIVII01L;
015800120706         IF  not %found(TIVII01L);
015900120706           wOkInfo = *off;
016000120706           leavesr;
016100120706         ENDIF;
016200120706         //?Concorrenti
016300120706         chain (w_VISNRV:'10') TIVII01L;
016400120706         IF  not %found(TIVII01L);
016500120706           wOkInfo = *off;
016600120706           leavesr;
016700120706         ENDIF;
016800120706         //?Aumento/Sconto
016900120706         IF  w_VIStpv = 'A';
017000120706           chain (w_VISNRV:'A/S') TIVII01L;
017100120706           IF  not %found(TIVII01L);
017200120706             wOkInfo = *off;
017300120706             leavesr;
017400120706           ENDIF;
017500120706         ENDIF;
017600120423
017700120423       ENDSR;
017800120423
017900120423       //--------------------------------------------------------------
018000120423       //?Operazioni finali.
018100120423       //--------------------------------------------------------------
018200120423       BEGSR RoutEnd;
018300120423
018400120423         *inLR = *on;
018500120423         return;
018600120423
018700120423       ENDSR;
018800051221
018900051221      /end-free
019000051221
