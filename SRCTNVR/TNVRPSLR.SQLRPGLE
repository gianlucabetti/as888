000100100809      //---------------------------------------------------------------
000200100809      //?TNVRPSL - Lista spunte da PDA
000300100809      //---------------------------------------------------------------
000400100809
000500100809     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100809
000700091021      //---------------------------------------------------------------
000800091021      //?Dichiarazione file.
000900091021      //---------------------------------------------------------------
001000100809
001100100809      // - Organigramma
001200100809     fAZORG01L  if   e           k disk
001300091021
001400100809      // - Video
001500100809     fTNVRPSLD  cf   e             workstn
001600100809     f                                     indds(IndDspF)
001700100809     f                                     infds(InfDspF)
001800100809
001900100809      // - Stampa
002000100809     fTNVRPSLP  o    e             printer oflind(*in99)
002100091021
002200091021      //---------------------------------------------------------------
002300091021      //?Definizione costanti.
002400091021      //---------------------------------------------------------------
002500100809
002600100809      // - Tasti funzionali a video
002700100809     d c_F01           c                   const(x'31')
002800100809     d c_F02           c                   const(x'32')
002900100809     d c_F03           c                   const(x'33')
003000100809     d c_F04           c                   const(x'34')
003100100809     d c_F05           c                   const(x'35')
003200100809     d c_F06           c                   const(x'36')
003300100809     d c_F07           c                   const(x'37')
003400100809     d c_F08           c                   const(x'38')
003500100809     d c_F09           c                   const(x'39')
003600100809     d c_F10           c                   const(x'3A')
003700100809     d c_F11           c                   const(x'3B')
003800100809     d c_F12           c                   const(x'3C')
003900100809     d c_F13           c                   const(x'B1')
004000100809     d c_F14           c                   const(x'B2')
004100100809     d c_F15           c                   const(x'B3')
004200100809     d c_F16           c                   const(x'B4')
004300100809     d c_F17           c                   const(x'B5')
004400100809     d c_F18           c                   const(x'B6')
004500100809     d c_F19           c                   const(x'B7')
004600100809     d c_F20           c                   const(x'B8')
004700100809     d c_F21           c                   const(x'B9')
004800100809     d c_F22           c                   const(x'BA')
004900100809     d c_F23           c                   const(x'BB')
005000100809     d c_F24           c                   const(x'BC')
005100100809     d c_Enter         c                   const(x'F1')
005200100809
005300100809     d Digits          c                   const('0123456789')
005400091021
005500091021      //---------------------------------------------------------------
005600091021      //?Definizione schiere.
005700091021      //---------------------------------------------------------------
005800091021
005900091021      //---------------------------------------------------------------
006000091021      //?Definizione aree dati.
006100091021      //---------------------------------------------------------------
006200091021
006300091021      //---------------------------------------------------------------
006400091021      //?Definizione strutture dati.
006500091021      //---------------------------------------------------------------
006600100809
006700100809      // - InfDS
006800100809     d InfDspF         ds
006900100809     d  dsp_aid              369    369a                                        AID byte
007000100809     d  dsp_rig              370    370
007100100809     d  dsp_col              371    371
007200100809
007300100809      // - Indicatori su DspF
007400100809     d IndDspF         ds
007500100809        // - Indicatori di errore
007600100809     d  ErrMessage                    1n   overlay(IndDspF : 28)
007700100809        // - Indicatore di pozionamento cursore
007800100809     d  PosCur01                      1n   overlay(IndDspF : 50)
007900100809     d  PosCur02                      1n   overlay(IndDspF : 51)
008000100809     d  PosCur03                      1n   overlay(IndDspF : 52)
008100100809        // - Indicatori di errore generico
008200100809     d  ErrGenerico                   1n   overlay(IndDspF : 99)
008300100809
008400100809      // Campi di comodo per gestione indicatori a video
008500100809     d WindDspF        ds                  inz
008600100809     d   WindDspFa             1     49    inz(*zero)
008700100809     d   WindDspFb            50     99    inz(*zero)
008800100809
008900100809      // - Controllo data
009000100809     d wlbdat          ds                  inz
009100100809     d  g02dat                 1      8  0
009200100809     d  g02inv                 9     16  0
009300100809     d  g02err                17     17
009400100809     d  g02tgi                18     22  0
009500100809
009600100809      // File spunte
009700100809     d FIPSLDS       e ds                  extname(FIPSL00F)
009800091021
009900091021      //---------------------------------------------------------------
010000091021      //?Definizione variabili globali.
010100091021      //---------------------------------------------------------------
010200100809
010300091021      // - Flags booleani
010400091021     d $End            s               n   inz(*off)
010500100809     d $Fine           s               n   inz(*off)
010600100809     d $InzW01         s               n   inz(*on)
010700100809     d $Stampa         s               n   inz(*off)
010800100809
010900100809      // - Campi associati al video
011000100809     d $Video          s              2    inz('W1')
011100100809
011200100809      // - Campi di comodo data
011300100809     d wdata           s              8
011400100809     d wmin            s              5  0 inz
011500100809     d wtime           s             14  0
011600100809     d wtimeiso        s             20  0
011700100809     d wtmstp          s               z   inz(*loval)
011800100809     d wtmstpr         s               z   inz(*loval)
011900091021
012000100809      // - Campi di comodo
012100100809     d saviddisp       s                   like(PSLiddisp)
012200100809     d wfil            s              3  0
012300100809
012400091021      //---------------------------------------------------------------
012500091021      //?Definizione procedure esterne.
012600091021      //---------------------------------------------------------------
012700100809
012800100809      //---------------------------------------------------------------
012900100809      //?Prototipi.
013000100809      //---------------------------------------------------------------
013100100809
013200100809      /copy gaitrasrc/srcprotopr,xsrda8
013300091021
013400091021      //---------------------------------------------------------------
013500091021      //?Definizione key-list.
013600091021      //---------------------------------------------------------------
013700100809
013800100809      //---------------------------------------------------------------
013900100809      //?Riepilogo indicatori.
014000100809      //---------------------------------------------------------------
014100100809
014200100809      // 28    : Emissione messaggio di errore a video
014300100809      // 50    : Errore: Filiale
014400100809      // 51    : Errore: Data
014500100809      // 52    : Errore: Minuti
014600100809      // 98    : Salto pagina
014700100809      // 99    : Generico di Errore
014800091021
014900091021      //---------------------------------------------------------------
015000100809      //?M A I N - L I N E
015100091021      //---------------------------------------------------------------
015200091021
015300091021      /free
015400100809
015500100809       //?Operazioni iniziali
015600100809       exsr RoutInz;
015700100809
015800100809       // Gestione video
015900100809       DOW $Fine = *off;
016000100809         select;
016100100809           when $Video = 'W1';
016200100809             exsr GesW01;
016300100809           other;
016400100809             $Fine = *on;
016500100809         ENDSL;
016600100809       ENDDO;
016700100809
016800100809       //?Operazioni finali
016900100809       exsr RoutEnd;
017000100809
017100100809
017200100809       //--------------------------------------------------------------
017300100809       //?Operazioni iniziali.
017400100809       //--------------------------------------------------------------
017500100809       BEGSR RoutInz;
017600100809
017700100809       ENDSR;
017800100809
017900100809       //--------------------------------------------------------------
018000100809       //?Gestione videata W01 - Richiesta parametri.
018100100809       //--------------------------------------------------------------
018200100809       BEGSR GesW01;
018300100809
018400100809       //?Inizializzazione videata
018500100809         IF  $InzW01 = *on;
018600100809           exsr Inzw01;
018700100809           $InzW01 = *off;
018800100809         ENDIF;
018900100809
019000100809       //?Emissione videata
019100100809         exfmt WIND01;
019200100809         errMessage   = *off;
019300100809         errGenerico  = *off;
019400100809         clear W01msg;
019500100809
019600100809         SELECT;
019700100809
019800100809       //?F3 = Fine
019900100809           WHEN dsp_aid = c_F03;
020000100809             exsr F03W01;
020100100809             leavesr ;
020200100809
020300100809       //?F6 = Conferma
020400100809           WHEN dsp_aid = c_F06;
020500100809             exsr F06W01;
020600100809             leavesr ;
020700100809
020800100809       //?Enter
020900100809           OTHER;
021000100809       //?Controllo i dati
021100100809             exsr CtrW01;
021200100809             IF  ErrGenerico;
021300100809               leavesr;
021400100809             ENDIF;
021500100809         ENDSL;
021600100809
021700100809       ENDSR;
021800100809
021900100809       //--------------------------------------------------------------
022000100809       //?Caricamento videata W01.
022100100809       //--------------------------------------------------------------
022200100809       BEGSR InzW01;
022300100809
022400100809         clear W01fil;
022500100809         clear W01data;
022600100809         clear W01min;
022700100809
022800100809       ENDSR;
022900100809
023000100809       //--------------------------------------------------------------
023100100809       //?Controllo videata W01.
023200100809       //--------------------------------------------------------------
023300100809       BEGSR CtrW01;
023400100809
023500100809         WindDspF = IndDspF;
023600100809         reset WindDspFb;
023700100809         IndDspF  = WindDspF;
023800100809
023900100809       //?Controllo la filiale
024000100809         IF  W01fil > 0;
024100100809         chain W01fil AZORG01L;
024200100809           IF  not %found(AZORG01L) or  ORGfva <> *blanks or
024300100809              (ORGfag <> 'F' and ORGfag <> 'A');
024400100809             ErrGenerico = *on;
024500100809             ErrMessage  = *on;
024600100809             W01msg = 'Filiale errata';
024700100809             PosCur01 = *on;
024800100809             leavesr;
024900100809           ENDIF;
025000100809         ENDIF;
025100100809
025200100809       //?Controllo la data
025300100809         IF  W01data = 0;
025400100809           ErrGenerico = *on;
025500100809           ErrMessage   = *on;
025600100809           PosCur02     = *on;
025700100809           W01msg = 'Data errata';
025800100809           leavesr;
025900100809         ENDIF;
026000100809
026100100809         clear wlbdat;
026200100809         g02dat = W01data;
026300100809         xsrda8(wlbdat);
026400100809         IF  g02err    = '1';
026500100809           ErrGenerico = *on;
026600100809           ErrMessage   = *on;
026700100809           PosCur02     = *on;
026800100809           W01msg = 'Data errata';
026900100809           leavesr;
027000100809         ENDIF;
027100100809
027200100809         W01data = g02dat;
027300100809         wdata   = %editc(g02inv:'X');
027400100809
027500100809       //?Controllo i minuti di dly
027600100809         IF  W01min = 0;
027700100809           ErrGenerico = *on;
027800100809           ErrMessage   = *on;
027900100809           PosCur03     = *on;
028000100809           W01msg = 'Minuti errati';
028100100809           leavesr;
028200100809         ENDIF;
028300100809
028400100809         IF  W01min > 59;
028500100809           ErrGenerico = *on;
028600100809           ErrMessage   = *on;
028700100809           PosCur03     = *on;
028800100809           W01msg = 'Minuti errati';
028900100809           leavesr;
029000100809         ENDIF;
029100100809
029200100809       ENDSR;
029300100809
029400100809       //--------------------------------------------------------------
029500100809       //?Gestione tasto funzionale F03 da videata W01.
029600100809       //?F3=Fine
029700100809       //--------------------------------------------------------------
029800100809       BEGSR F03W01;
029900100809
030000100809       //?Esco
030100100809         $Fine = *on;
030200100809
030300100809       ENDSR;
030400100809
030500100809       //--------------------------------------------------------------
030600100809       //?Gestione tasto funzionale F06 da videata W01.
030700100809       //?F6=Conferma
030800100809       //--------------------------------------------------------------
030900100809       BEGSR F06W01;
031000100809
031100100809       //?Elaboro
031200100809
031300100809         exec sql
031400100809          declare Spunte cursor for
031500100809          select * from FIPSL00F
031600100809          WHERE  substr(PSLdtorar, 1, 8) = :wdata
031700100809          order by PSLfil, PSLiddisp;
031800100809
031900100809         exec sql
032000100809           open Spunte;
032100100809           IF sqlcode < 0;
032200100809             $End = *on;
032300100809           ENDIF;
032400100809
032500100809         DOW not $End;
032600100809
032700100809           exec sql
032800100809             fetch next from Spunte into :FIPSLDS;
032900100809             IF sqlcod = 100 or sqlcod < 0;
033000100809               $End = *on;
033100100809               leave;
033200100809             ENDIF;
033300100809
033400100809           wfil = %dec(PSLfil:3:0);
033500100809
033600100809         //?se richiesta una filiale specifica elaboro solo quella
033700100809           IF  W01fil <> 0 and W01fil <> wfil;
033800100809             iter;
033900100809           ENDIF;
034000100809
034100100809         //?metto i campi data ora spunta e data ora ricezione in campi
034200100809           wtime    = %dec(PSLdtorar:14:0);
034300100809           wtimeiso = wtime * 1000000;
034400100809           wtmstpr  = %timestamp(wtimeiso);
034500100809           wtime    = %dec(PSLdatora:14:0);
034600100809           wtimeiso = wtime * 1000000;
034700100809           wtmstp   = %timestamp(wtimeiso);
034800100809
034900100809         //?calcolo la differenza in minuti
035000100809           wmin = %diff(wtmstp : wtmstpr : *minutes);
035100100809
035200100809         //?i minuti trovati sono uguali o maggiori del dly richiesto stampo
035300100809           IF  wmin >= w01min and PSLiddisp <> saviddisp;
035400100809             datar = %subst(PSLdtorar:1:8);
035500100809             orar  = %subst(PSLdtorar:9:6);
035600100809             data  = %subst(PSLdatora:1:8);
035700100809             ora   = %subst(PSLdatora:9:6);
035800100809             exsr stampa;
035900100809             saviddisp = PSLiddisp;
036000100809           ENDIF;
036100100809
036200100809         ENDDO;
036300100809
036400100809         exec sql close Spunte;
036500100809
036600100809         $Fine = *on;
036700100809
036800100809       ENDSR;
036900100809
037000100809       //--------------------------------------------------------------
037100100809       //?Stampa.
037200100809       //--------------------------------------------------------------
037300100809       BEGSR Stampa;
037400100809
037500100809         IF  not $Stampa or *in99;
037600100809           write STPT01;
037700100809           *in99 = *off;
037800100809           $Stampa = *on;
037900100809         ENDIF;
038000100809
038100100809         write STPD01;
038200100809
038300100809       ENDSR;
038400100809
038500100809       //--------------------------------------------------------------
038600100809       //?Operazioni finali.
038700100809       //--------------------------------------------------------------
038800100809       BEGSR RoutEnd;
038900100809
039000100809         *inLR = *on;
039100100809         return;
039200100809
039300100809       ENDSR;
