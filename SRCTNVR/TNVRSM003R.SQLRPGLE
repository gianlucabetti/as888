000100080507      *PARMS CLOSQLCSR(*ENDMOD) DBGVIEW(*SOURCE) DYNUSRPRF(*OWNER)
000200080507      *PARMS OPTION(*NOXREF)
000300080507
000400080507       //==============================================================
000500080507       //?TNVRSM003R - Allineamento descrizione MsgQ a quelle in UsrPrf
000600080507       //--------------------------------------------------------------
000700080507       // Il programma allinea la descrizione della coda messaggi a
000800080507       //   quella del profilo utente.
000900080507       //==============================================================
001000080507
001100080507     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001200080507     h alwnull(*inputonly)
001300080507
001400080507       //--------------------------------------------------------------
001500080507       //?Dichiarazione file.
001600080507       //--------------------------------------------------------------
001700080507
001800080507       // - Printer File
001900080507     fQSYSPRT   o    f  132        printer usropn oflind(*inOF)
002000080507
002100080507       //--------------------------------------------------------------
002200080507       //?Definizione costanti.
002300080507       //--------------------------------------------------------------
002400080507
002500080507
002600080507       //--------------------------------------------------------------
002700080507       //?Definizione schiere.
002800080507       //--------------------------------------------------------------
002900080507
003000080507
003100080507       //--------------------------------------------------------------
003200080507       //?Definizione aree dati.
003300080507       //--------------------------------------------------------------
003400080507
003500080507
003600080507       //--------------------------------------------------------------
003700080507       //?Definizione strutture dati.
003800080507       //--------------------------------------------------------------
003900080507
004000080508     d Status         sds
004100080508     d  SDSpgm           *proc
004200080508     d  SDSusr               254    263
004300080508
004400080507     d wSQLrec         ds                  inz
004500080507     d   SQL_User...
004600080507     d                               10    inz
004700080507     d   SQL_Descr_User...
004800080507     d                               50    inz
004900080507     d   SQL_Descr_MsgQ...
005000080507     d                               50    inz
005100080507
005200080507       //--------------------------------------------------------------
005300080507       //?Definizione variabili globali.
005400080507       //--------------------------------------------------------------
005500080507
005600080508       // - Orario
005700080508     d wTime           s             10    inz
005800080508
005900080507       // - Comando da eseguire
006000080507     d Qcmd            s            256    inz
006100080507
006200080507       // - Strainga SQL da eseguire
006300080507     d wrkSQLstr       s            512a   varying        inz
006400080507
006500080507       //--------------------------------------------------------------
006600080507       //?Definizione procedure usate.
006700080507       //--------------------------------------------------------------
006800080507
006900080507     d qCmdExc         pr                  extpgm('QCMDEXC')
007000080507     d  qCmdExcCmd                  256    const   options(*varsize)
007100080507     d  qCmdExcLen                   15  5 const
007200080507
007300080507       //--------------------------------------------------------------
007400080507       //?Definizione key-list.
007500080507       //--------------------------------------------------------------
007600080507
007700080507
007800080507       //--------------------------------------------------------------
007900080507       //?Riepilogo indicatori.
008000080507       //--------------------------------------------------------------
008100080507
008200080507
008300080507       //--------------------------------------------------------------
008400080507       //?M A I N - L I N E
008500080507       //--------------------------------------------------------------
008600080507
008700080507      /free
008800080507
008900080507       // Operazioni iniziali
009000080507       exsr RoutInz;
009100080507
009200080507       // Selezione delle code messaggio di cui aggiornare la descriz.
009300080507       dou  sqlCode <> *zero;
009400080507         exsr ExecSQL;
009500080507       enddo;
009600080507
009700080507       // Operazioni finali
009800080507       exsr RoutEnd;
009900080507
010000080507       //--------------------------------------------------------------
010100080507       //?Operazioni iniziali.
010200080507       //--------------------------------------------------------------
010300080507       BEGSR RoutInz;
010400080507
010500080507         *inLR = *on;
010600080507
010700080507       // Impostazione opzioni per SQL
010800080507         exec SQL   set option   DynUsrPrf = *owner,
010900080507                                 CloSqlCsr = *endmod;
011000080507
011100080507         // Dichiarazione cursore SQL da eseguire
011200080507         exec sql  declare C1 cursor for
011300080507                    select UTEute, u.ODobtx, m.ODobtx
011400080507                    from   AZUTE00F inner join WF_USRPRF u
011500080507                    on     UTEute = u.ODobnm
011600080507                                    inner join WF_MSGQ   m
011700080507                    on     UTEute = m.ODobnm
011800080507                    where  u.ODobtx <> m.ODobtx
011900080507                    for    fetch only ;
012000080507
012100080507         // Apertura Cursore
012200080507         exec sql  open    C1 ;
012300080507
012400080507       ENDSR;
012500080507
012600080507       //--------------------------------------------------------------
012700080507       //?Cancellazione records di FIVAB00F con campo VABCCM errato
012800080507       //--------------------------------------------------------------
012900080507       BEGSR ExecSQL;
013000080507
013100080507         exec SQL   fetch  next  from C1  into  :wSQLrec ;
013200080507
013300080507         select;
013400080507           when  sqlCode = 100;
013500080507             exsr RoutEnd;
013600080507           when  sqlCode < *zero;
013700080507             dump(a);
013800080507             exsr RoutEnd;
013900080507           other;
014000080507             exsr sr_Upd_MsgQ;
014100080507         endsl;
014200080507
014300080507       ENDSR;
014400080507
014500080507       //--------------------------------------------------------------
014600080507       //?Cancellazione records di FIVAB00F con campo VABCCM errato
014700080507       //--------------------------------------------------------------
014800080507       BEGSR sr_Upd_MsgQ;
014900080507
015000080507         Qcmd = 'CHGMSGQ'
015100080507              + ' msgq('
015200080507              + %trimr(Sql_User)
015300080507              + ') text('''
015400080507              + %trimr(Sql_Descr_User)
015500080507              + ''')' ;
015600080507
015700080507         callp(e) QCmdExc (Qcmd : %size(Qcmd));
015800080507
015900080507         if %error;
016000080508
016100080507           if not %open (QSYSPRT);
016200080508             open   QSYSPRT;
016300080508             *inOF = *on;
016400080507           endif;
016500080508
016600080508           if *inOF;
016700080508             wTime = %char( %time() );
016800080508             except PRTtxt;
016900080508             *inOF = *off;
017000080508           endif;
017100080508
017200080507           except PRTerr;
017300080508
017400080507         endif;
017500080507
017600080507       ENDSR;
017700080507
017800080507       //--------------------------------------------------------------
017900080507       //?Operazioni finali.
018000080507       //--------------------------------------------------------------
018100080507       BEGSR RoutEnd;
018200080507
018300080507         // Chiusura printer-file
018400080507         if %open (QSYSPRT);
018500080508           except PRTend;
018600080508           close  QSYSPRT;
018700080507         endif;
018800080507
018900080507         // Chiusura Cursore
019000080507         exec sql  close   C1 ;
019100080507
019200080507         return;
019300080507
019400080507       ENDSR;
019500080507
019600080507      /end-free
019700080507
019800080507       //--------------------------------------------------------------
019900080507       //?P R I N T E R - F I L E S
020000080507       //--------------------------------------------------------------
020100080507
020200080508     oQSYSPRT   e            PRTtxt            2
020300080508     o                       SDSusr
020400080508     o                                        +   3 'ALLINEAMENTO DESC+
020500080508     o                                              RIZIONE CODA MESSA+
020600080508     o                                              GGI ALLA DESCRIZIO+
020700080508     o                                              NE UTENTE'
020800080508     o                       SDSpgm           +   5
020900080508     o                       *date         y  +   3
021000080508     o                       wTime            +   3
021100080508     o          e            PRTtxt      2  1
021200080508     o                                              'Utente    '
021300080508     o                                        +   3 'Descrizione Utent+
021400080508     o                                              e / Descrizione Co+
021500080508     o                                              da Messaggi'
021600080508     o          e            PRTtxt      1  1
021700080508     o                                              '----------'
021800080508     o                                        +   3 '-----------------+
021900080508     o                                              ------------------+
022000080508     o                                              -----------'
022100080508      *
022200080508     o          e            PRTerr      1
022300080507     o                       Sql_User
022400080507     o                       Sql_Descr_User   +   3
022500080507     o          e            PRTerr      1
022600080507     o                       Sql_Descr_MsgQ   +  13
022700080507     o                                        +   3 '=> CHGMSGQ FAILED!'
022800080508      *
022900080508     o          e            PRTend      2
023000080508     o                                        +  13 '***  Fine Lista  +
023100080508     o                                               ***'
