000100100119     /*PRM  closqlcsr(*endmod)  dbgview(*source)  dynusrprf(*owner)
000200100119     /*PRM  option(*noxref)
000300100119     /*END
000400100119
000500100119       //==============================================================
000600100119       //?TNVRSM008R - Estrazione lunghezza min & max del CHI-SONO nel ?
000700100119       //?*            file FIARS00F                                   ?
000800100119       //==============================================================
000900100119
001000100119     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001100100119     h alwnull(*inputonly)
001200100119
001300100119       //--------------------------------------------------------------
001400100119       //?Dichiarazione file.                                          ?
001500100119       //--------------------------------------------------------------
001600100119
001700100119       // -?Printer File?
001800100119     fQSYSPRT   o    f  132        printer usropn oflind(*inOF)
001900100119
002000100119       //--------------------------------------------------------------
002100100119       //?Definizione costanti.                                        ?
002200100119       //--------------------------------------------------------------
002300100119
002400100119
002500100119       //--------------------------------------------------------------
002600100119       //?Definizione schiere.                                         ?
002700100119       //--------------------------------------------------------------
002800100119
002900100119     d sch_Fil         s              3  0 dim(300) inz
003000100119     d sch_Num         s              7  0 dim(300) inz
003100100119
003200100119       //--------------------------------------------------------------
003300100119       //?Definizione aree dati.                                       ?
003400100119       //--------------------------------------------------------------
003500100119
003600100119
003700100119       //--------------------------------------------------------------
003800100119       //?Definizione strutture dati.                                  ?
003900100119       //--------------------------------------------------------------
004000100119
004100100119     d Status         sds
004200100119     d  SDSpgm           *proc
004300100119     d  SDSusr               254    263
004400100119
004500100119     d wSQLrec         ds                  inz
004600100119     d   SQL_arsFLS...
004700100119     d                                3  0 inz
004800100119     d   SQL_arsNOT...
004900100119     d                               35    inz
005000100119
005100100119       //--------------------------------------------------------------
005200100119       //?Definizione variabili globali.                               ?
005300100119       //--------------------------------------------------------------
005400100119
005500100119       // -?Indici di schiera?
005600100119     d xx              s              3  0 inz
005700100119
005800100119       // -?Orario?
005900100119     d wTime           s             10    inz
006000100119
006100100119       // -?Stringa SQL da eseguire?
006200100119     d wrkSQLstr       s            512a   varying  inz
006300100119
006400100119       // -?Variabili di comodo?
006500100119     d SaveFIL         s                   like(SQL_arsFLS) inz(*loval)
006600100119     d wMaxLen         s              7  0 inz(*loval)
006700100119     d wTotRecT        s              7  0 inz
006800100119
006900100119       //--------------------------------------------------------------
007000100119       //?Definizione procedure usate.                                 ?
007100100119       //--------------------------------------------------------------
007200100119
007300100119
007400100119       //--------------------------------------------------------------
007500100119       //?Definizione key-list.                                        ?
007600100119       //--------------------------------------------------------------
007700100119
007800100119
007900100119       //--------------------------------------------------------------
008000100119       //?Riepilogo indicatori.                                        ?
008100100119       //--------------------------------------------------------------
008200100119
008300100119
008400100119       //--------------------------------------------------------------
008500100119       //?M A I N - L I N E                                            ?
008600100119       //--------------------------------------------------------------
008700100119
008800100119      /free
008900100119
009000100119       // -?Operazioni iniziali?
009100100119       exsr sr_RoutInz;
009200100119
009300100119       // -?Selezione delle code messaggio di cui aggiornare la descriz?
009400100119       dou  sqlCode <> *zero;
009500100119         exsr sr_ExecSQL;
009600100119       enddo;
009700100119
009800100119       // -?Operazioni finali?
009900100119       exsr sr_RoutEnd;
010000100119
010100100119       //--------------------------------------------------------------
010200100119       //?Operazioni iniziali.
010300100119       //--------------------------------------------------------------
010400100119       BEGSR sr_RoutInz;
010500100119
010600100119         *inLR = *on;
010700100119         reset  SaveFIL;
010800100119         reset  wMaxLen;
010900100119         clear  wTotRecT;
011000100119
011100100119         // -?Impostazione opzioni per SQL?
011200100119         exec SQL   set option   DynUsrPrf = *owner,
011300100119                                 CloSqlCsr = *endmod;
011400100119
011500100119         // -?Dichiarazione cursore SQL da eseguire?
011600100119         exec sql   declare C1 cursor for
011700100119                     select ARSfls, ARSnot
011800100119                       from FIARS00F
011900100119                      where ARStrc = 'C'
012000100119                      order by ARSfls, ARSnot
012100100119                        for fetch only;
012200100119
012300100119         // -?Apertura Cursore?                                        ?
012400100119         exec sql   open C1 ;
012500100119
012600100119       ENDSR;
012700100119
012800100119       //--------------------------------------------------------------
012900100119       //?Cancellazione records di FIVAB00F con campo VABCCM errato
013000100119       //--------------------------------------------------------------
013100100119       BEGSR sr_ExecSQL;
013200100119
013300100119         exec SQL   fetch  next  from C1  into  :wSQLrec ;
013400100119
013500100119         select;
013600100119           when  sqlCode = 100;
013700100119             exsr sr_RoutEnd;
013800100119           when  sqlCode < *zero;
013900100119             dump(a);
014000100119             exsr sr_RoutEnd;
014100100119           other;
014200100119             exsr sr_ElabRec;
014300100119         endsl;
014400100119
014500100119       ENDSR;
014600100119
014700100119       //--------------------------------------------------------------
014800100119       //?Elaborazione singolo record estratto.
014900100119       //--------------------------------------------------------------
015000100119       BEGSR sr_ElabRec;
015100100119
015200100119         // -?Estrazione limite massimo di lunghezza?
015300100119         if  %len( %trim( SQL_arsNOT ) ) >= wMaxLen;
015400100119
015500100119           if  %len( %trim( SQL_arsNOT ) ) > wMaxLen;
015600100119             clear  xx;
015700100119             clear  sch_Fil;
015800100119             clear  sch_Num;
015900100119           endif;
016000100119
016100100119           eval  wMaxLen = %len( %trim( SQL_arsNOT ) );
016200100119
016300100119           select;
016400100119             when  xx = *zero;
016500100119               xx += 1;
016600100119               sch_Fil(xx) =  SQL_arsFLS;
016700100119             when  SQL_arsFLS <> sch_Fil(xx);
016800100119               xx += 1;
016900100119               sch_Fil(xx) =  SQL_arsFLS;
017000100119           endsl;
017100100119           sch_Num(xx) += 1;
017200100119
017300100119         endif;
017400100119
017500100119         wTotRecT += 1;
017600100119
017700100119       ENDSR;
017800100119
017900100119       //--------------------------------------------------------------
018000100119       //?Stampa totali.
018100100119       //--------------------------------------------------------------
018200100119       BEGSR sr_PrintTot;
018300100119
018400100119         if  not %open (QSYSPRT);
018500100119           open   QSYSPRT;
018600100119           *inOF = *on;
018700100119         endif;
018800100119
018900100119         if  *inOF;
019000100119           wTime = %char( %time() );
019100100119           except PRTtxt;
019200100119           *inOF = *off;
019300100119         endif;
019400100119
019500100119         except PRTtot;
019600100119
019700100119       ENDSR;
019800100119
019900100119       //--------------------------------------------------------------
020000100119       //?Operazioni finali.
020100100119       //--------------------------------------------------------------
020200100119       BEGSR sr_RoutEnd;
020300100119
020400100119         // -?Stampa dati?
020500100119         For  xx = 1  To  %elem(sch_Fil);
020600100119           if  sch_Fil(xx) = *zero;
020700100119             leave;
020800100119           endif;
020900100119           exsr  sr_PrintTot;
021000100119         EndFor;
021100100119
021200100119         // -?Chiusura printer-file?
021300100119         if  %open (QSYSPRT);
021400100119           except PRTend;
021500100119           close  QSYSPRT;
021600100119         endif;
021700100119
021800100119         // -?Chiusura Cursore?
021900100119         exec sql   close C1;
022000100119
022100100119         return;
022200100119
022300100119       ENDSR;
022400100119
022500100119      /end-free
022600100119
022700100119       //--------------------------------------------------------------
022800100119       //?P R I N T E R - F I L E S
022900100119       //--------------------------------------------------------------
023000100119
023100100119     oQSYSPRT   e            PRTtxt            2
023200100119     o                       SDSusr
023300100119     o                                        +   3 'ESTRAZIONE LUNGHE-
023400100119     o                                              ZZE "CHI-SONO" DAL-
023500100119     o                                               FILE FIARS00F'
023600100119     o                       SDSpgm           +   5
023700100119     o                       *date         y  +   3
023800100119     o                       wTime            +   3
023900100119     o          e            PRTtxt      2  1
024000100119     o                                              'Fil'
024100100119     o                                        +   3 'Lungh.Max'
024200100119     o                                        +   3 'Num. Rec.'
024300100119     o          e            PRTtxt      1  1
024400100119     o                                              '---'
024500100119     o                                        +   3 '---------'
024600100119     o                                        +   3 '---------'
024700100119      *
024800100119     o          e            PRTtot      1
024900100119     o                       sch_Fil(xx)   x
025000100119     o                       wMaxLen       k  +   3
025100100119     o                       sch_Num(xx)   k  +   2
025200100119      *
025300100119     o          e            PRTend      2
025400100119     o                                        +   5 '***  Fine Lista  +
025500100119     o                                               ***'
025600100119     o                                        +   3 'Tot. rec. = '
025700100119     o                       wTotRecT      k  +   1
