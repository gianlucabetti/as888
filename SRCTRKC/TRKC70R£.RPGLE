000100130702       //==============================================================
000200141103       //?MKCM70R * Verifica se CLIENTE in Campgna                     ?
000300130702       //==============================================================
000400130702
000500130702       //--------------------------------------------------------------
000600130702       //?Specifiche di controllo.                                     ?
000700130702       //--------------------------------------------------------------
000800130702
000900130702     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001000130702     h dftactgrp(*no)
001100130702
001200130702       //--------------------------------------------------------------
001300130702       //?Dichiarazione file.                                          ?
001400130702       //--------------------------------------------------------------
001500130702
001600141103       // -?Anagrafica clienti in campagna
001700141103     fTICMC02L  if   e           k disk
001800141103
001900141103       // -?Anagrafica Campagne
002000141103     fTICMP01L  if   e           k disk
002100141103
002200130702       //--------------------------------------------------------------
002300130702       //?Definizione costanti.                                        ?
002400130702       //--------------------------------------------------------------
002500130702
002600130702
002700130702       //--------------------------------------------------------------
002800130702       //?Definizione schiere.                                         ?
002900130702       //--------------------------------------------------------------
003000130702
003100130702       // -?Messaggi di errore?
003200130704     d $Msg            s             78    dim( 7) ctdata perrcd(1)
003300130702
003400130702       //--------------------------------------------------------------
003500130702       //?Definizione aree dati.                                       ?
003600130702       //--------------------------------------------------------------
003700130702
003800130704       // -?Dati utente?
003900130704     d §AzUte        e ds                  extname(AZUTE00F)
004000130704     d                                     dtaara
004100130704     d §DatiUte      e ds                  extname(dDatiUte)
004200130704     d                                     dtaara
004300130702
004400130702       //--------------------------------------------------------------
004500130702       //?Definizione strutture dati.                                  ?
004600130702       //--------------------------------------------------------------
004700130702
004800130702       // -?Parametri ricevuti?
004900130702     d KPJBA         e ds
005000141106     d MKCM70ds      e ds
005100130702
005200130702       //--------------------------------------------------------------
005300130702       //?Definizione variabili globali.                               ?
005400130702       //--------------------------------------------------------------
005500130702
005600130704       // -?Stringa SQL?
005700130704     d wSQL            s           4096    varying
005800130704
005900130704       // -?Conteggio record estratti via SQL [count(*)]?
006000130704     d wConta          s              5  0 inz
006100130704
006200130704       // -?Campi di comodo?
006300130704     d wDate           s              8  0 inz
006400130702
006500130702       //--------------------------------------------------------------
006600130702       //?Definizione prototipi procedure.                             ?
006700130702       //--------------------------------------------------------------
006800130702
006900141103       // -?Ricerca unificante padre?
007000141103     d TIBS10ds      e ds                  inz
007100141103      /copy gaitrasrc/srcprotopr,tibs10r
007200141103
007300130704       // -?Reperimento dati utente?
007400130704     d TIBS34ds      e ds                  inz
007500130704      /copy gaitrasrc/srcProtoPR,TIBS34R
007600130702
007700130702       //--------------------------------------------------------------
007800130702       //?Definizione key-list.                                        ?
007900130702       //--------------------------------------------------------------
008000130702
008100141103       // -?File TICMC02L: Anagrafica Clienti in Campagna
008200141103     d k01ticmc02    e ds                  extname(TICMC02L : *key)
008300130702     d                                     prefix(k_)   inz
008400130704
008500141103       // -?File TICMP01L: Anagrafica Campagne
008600141103     d k01ticmp01    e ds                  extname(TICMP01L : *key)
008700130704     d                                     prefix(k_)   inz
008800130704
008900130702       //--------------------------------------------------------------
009000130702       //?M A I N - L I N E                                            ?
009100130702       //--------------------------------------------------------------
009200130702
009300130702     c     *Entry        plist
009400130702     c                   parm                    KPJBA
009500141106     c                   parm                    MKCM70DS
009600130702
009700130702      /free
009800130702
009900130702       // -?Operazioni iniziali?
010000130702       exsr sr_RoutInz;
010100130702
010200141103       // -?Verifica se il cliente è in campagna?
010300141103       exsr  sr_CtrlKscCmp;
010400130702
010500130702       // -?Operazioni finali?
010600130702       exsr sr_RoutEnd;
010700130702
010800130702       //--------------------------------------------------------------
010900130702       //?Operazioni iniziali.                                         ?
011000130702       //--------------------------------------------------------------
011100130702       BEGSR  sr_RoutInz;
011200130702
011300130702         *inLR = *on;
011400130704
011500130704         // -?Reperimento dati job?
011600130704         exsr  sr_DatiJob;
011700130702
011800130702         // -?Reperimento data odierna?
011900130702         wDate = %int( %subst( %char( %dec( %timestamp() ) )
012000130702                               : 1 : 8 ) );
012100130702
012200130704         // -?Pulizia eventuali parametri di output?
012300141104         OCM70err = *blank ;
012400141103         clear  oCM70msg;
012500130702
012600130702       ENDSR;
012700130704
012800130704       //--------------------------------------------------------------
012900130704       //?Reperimento Dati del job (Utente/Operativi).                 ?
013000130704       //--------------------------------------------------------------
013100130704       BEGSR  sr_DatiJob;
013200130704
013300130704         in(e) §AzUte;
013400130704         if NOT %error;
013500130704           in(e) §DatiUte;
013600130704         endif;
013700130704         if %error or RSut = *blank;
013800130704           tibs34r ( tibs34ds );
013900130704           in §AzUte;
014000130704           in §DatiUte;
014100130704         endif;
014200130704
014300130704       ENDSR;
014400130703
014500130703       //--------------------------------------------------------------
014600141103       //?Verifica se il Cliente è in campagna                         ?
014700130703       //--------------------------------------------------------------
014800141103       BEGSR  sr_CtrlKscCmp;
014900130704
015000141103         // ·?Cliente in campagna?
015100141103
015200141103         K_CmcKsu = icm70ksu;
015300141106         setll  %kds(k01ticmc02:1)  TICMC000;
015400141104         if   not %equal(TICMC02L);
015500141103
015600141103         // ·?Se non trovato verifico se il codice che mi è stato passato è un codice figlio?
015700141103
015800141103              clear TIBS10DS;
015900141103              D10tle = 'ST';
016000141103              D10paf = 'P';
016100141103              D10cod = icm70ksu ;
016200141103              tibs10r (TIBS10DS);
016300141103              IF  D10err = *blanks and D10cop > 0;
016400141103                 K_CmcKsu = D10COP;
016500141104              ENDIF;
016600141106              setll  %kds(k01ticmc02:1)  TICMC000;
016700141103         Endif;
016800141104
016900141106         reade  %kds(k01ticmc02:1)  TICMC000;
017000141103
017100141104         // ·?Se trovato verifico se la campagna è ancora aperta?
017200141104         Dow not %eof  ;
017300141104             K_Cmpncm = cmcncm ;
017400141104             chain  %kds(k01ticmp01)  TICMP000;
017500141104             if  %found(TICMP01L) and  cmpdfc > wdate ;
017600141111           //?Verifico se OK per la trattativa?
017700141111               IF  ICM70dat > 0 and
017800141111                   (ICM70dat < CMPdit or ICM70dat > CMPdft);
017900141111               ELSE;
018000141106                 OCM70ksu = k_CMCksu;
018100141104                 ocm70cmp = cmcncm ;
018200141104                 ocm70cmdes = cmpdes ;
018300141104                 leave;
018400141111               ENDIF;
018500141104             endif ;
018600141106             reade  %kds(k01ticmc02:1)  TICMC000;
018700141104         enddo;
018800130704
018900130704       ENDSR;
019000130704
019100130704       //--------------------------------------------------------------
019200130704       //?Operazioni iniziali.                                         ?
019300130704       //--------------------------------------------------------------
019400130704       BEGSR  sr_RoutEnd;
019500130704
019600130704         // -?Uscita?
019700130704         return;
019800130704
019900130704       ENDSR;
020000130704
020100130704      /end-free
020200130702
020300130702       //--------------------------------------------------------------
020400130702       //?Schiere a tempo di compilazione.                             ?
020500130702       //--------------------------------------------------------------
020600130702
020700130702** -?$Msg?(Messaggi di errore)?----------------------------------------------*
020800141104Non trovato il cliente in campagna                                             1
