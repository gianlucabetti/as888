000100150102       //==============================================================
000200150112       //?TRKC73R * Verifica se CLIENTE in Campgna                     ?
000300150102       //==============================================================
000400150102
000500150102       //--------------------------------------------------------------
000600150102       //?Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700150102       //--------------------------------------------------------------
000800150102
000900150102     /*PRM  dbgview(*source)
001000150102     /*END
001100150102
001200150102       //--------------------------------------------------------------
001300150102       //?Specifiche di controllo.                                     ?
001400150102       //--------------------------------------------------------------
001500150102
001600150102     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001700150102     h dftactgrp(*no)
001800150102
001900150102       //--------------------------------------------------------------
002000150102       //?Dichiarazione file.                                          ?
002100150102       //--------------------------------------------------------------
002200150102
002300150102       // -?Anagrafica clienti in campagna?
002400150102     fTICMC02L  if   e           k disk
002500150102
002600150102       // -?Anagrafica Campagne?
002700150102     fTICMP01L  if   e           k disk
002800150102
002900150102       //--------------------------------------------------------------
003000150102       //?Definizione costanti.                                        ?
003100150102       //--------------------------------------------------------------
003200150102
003300150102
003400150102       //--------------------------------------------------------------
003500150102       //?Definizione schiere.                                         ?
003600150102       //--------------------------------------------------------------
003700150102
003800150102       // -?Messaggi di errore?
003900150102     d sk_Msg          s             78    dim( 2)  ctdata  perrcd(1)
004000150102
004100150102       //--------------------------------------------------------------
004200150102       //?Definizione aree dati.                                       ?
004300150102       //--------------------------------------------------------------
004400150102
004500150102       // -?Dati utente?
004600150102     d §AzUte        e ds                  extname(AZUTE00F)
004700150102     d                                     dtaara
004800150102     d §DatiUte      e ds                  extname(dDatiUte)
004900150102     d                                     dtaara
005000150102
005100150102       //--------------------------------------------------------------
005200150102       //?Definizione strutture dati.                                  ?
005300150102       //--------------------------------------------------------------
005400150102
005500150102       // -?Parametri ricevuti?
005600150102     d KPJBA         e ds
005700150112     d TRKC73ds      e ds
005800150206     d   sk_oKC73nc           24     93  0 dim(10)
005900150206     d   sk_oKC73dc           94    493    dim(10)
006000150102
006100150102       //--------------------------------------------------------------
006200150102       //?Definizione variabili globali.                               ?
006300150102       //--------------------------------------------------------------
006400150102
006500150102       // -?Indici di schiera?
006600150102     d xx              s              3  0 inz
006700150102
006800150102       // -?Campi di comodo?
006900150102     d wDate           s              8  0 inz
007000150102
007100150102       //--------------------------------------------------------------
007200150102       //?Definizione prototipi procedure.                             ?
007300150102       //--------------------------------------------------------------
007400150102
007500150102       // -?Ricerca unificante padre?
007600150102     d TIBS10ds      e ds                  inz
007700150102      /copy gaitrasrc/srcProtoPR,TIBS10R
007800150102
007900150102       // -?Reperimento dati utente?
008000150102     d TIBS34ds      e ds                  inz
008100150102      /copy gaitrasrc/srcProtoPR,TIBS34R
008200150102
008300150102       //--------------------------------------------------------------
008400150102       //?Definizione key-list.                                        ?
008500150102       //--------------------------------------------------------------
008600150102
008700150102       // -?File TICMC02L: Anagrafica Clienti in Campagna?
008800150102     d keyTICMC02    e ds                  extname(TICMC02L : *key)
008900150102     d                                     prefix(k_)   inz
009000150102
009100150102       // -?File TICMP01L: Anagrafica Campagne?
009200150102     d keyTICMP01    e ds                  extname(TICMP01L : *key)
009300150102     d                                     prefix(k_)   inz
009400150102
009500150102       //--------------------------------------------------------------
009600150102       //?M A I N - L I N E                                            ?
009700150102       //--------------------------------------------------------------
009800150102
009900150102     c     *Entry        plist
010000150102     c                   parm                    KPJBA
010100150112     c                   parm                    TRKC73DS
010200150102
010300150102      /free
010400150102
010500150102       // -?Operazioni iniziali?
010600150102       exsr sr_RoutInz;
010700150102
010800150102       // -?Verifica se il cliente è in campagna?
010900150102       exsr  sr_CtrlKscCmp;
011000150102
011100150102       // -?Operazioni finali?
011200150102       exsr sr_RoutEnd;
011300150102
011400150102       //--------------------------------------------------------------
011500150102       //?Operazioni iniziali.                                         ?
011600150102       //--------------------------------------------------------------
011700150102       BEGSR  sr_RoutInz;
011800150102
011900150102         *inLR = *on;
012000150102
012100150102         // -?Reperimento dati job?
012200150102         exsr  sr_DatiJob;
012300150102
012400150102         // -?Reperimento data odierna?
012500150102         wDate = %int( %subst( %char( %dec( %timestamp() ) )
012600150102                               : 1 : 8 ) );
012700150102
012800150102         // -?Pulizia eventuali parametri di output?
012900150112         clear  oKC73ksu;
013000150112         clear  oKC73nc1;
013100150112         clear  oKC73dc1;
013200150112         clear  oKC73nc2;
013300150112         clear  oKC73dc2;
013400150112         clear  oKC73nc3;
013500150112         clear  oKC73dc3;
013600150112         clear  oKC73nc4;
013700150112         clear  oKC73dc4;
013800150112         clear  oKC73nc5;
013900150112         clear  oKC73dc5;
014000150112         clear  oKC73nc6;
014100150112         clear  oKC73dc6;
014200150112         clear  oKC73nc7;
014300150112         clear  oKC73dc7;
014400150112         clear  oKC73nc8;
014500150112         clear  oKC73dc8;
014600150112         clear  oKC73nc9;
014700150112         clear  oKC73dc9;
014800150112         clear  oKC73nc0;
014900150112         clear  oKC73dc0;
015000150112         clear  oKC73err;
015100150112         clear  oKC73msg;
015200150102
015300150102       ENDSR;
015400150102
015500150102       //--------------------------------------------------------------
015600150102       //?Reperimento Dati del job (Utente/Operativi).                 ?
015700150102       //--------------------------------------------------------------
015800150102       BEGSR  sr_DatiJob;
015900150102
016000150102         in(e) §AzUte;
016100150102         if NOT %error;
016200150102           in(e) §DatiUte;
016300150102         endif;
016400150102         if %error or RSut = *blank;
016500150102           tibs34r ( tibs34ds );
016600150102           in §AzUte;
016700150102           in §DatiUte;
016800150102         endif;
016900150102
017000150102       ENDSR;
017100150102
017200150102       //--------------------------------------------------------------
017300150102       //?Verifica se il Cliente è in Campagna.                        ?
017400150102       //--------------------------------------------------------------
017500150102       BEGSR  sr_CtrlKscCmp;
017600150102
017700150102         // -?Ciclo di lettura file TICMC02L?
017800150102         clear  xx;
017900150112         k_CMCksu = iKC73ksu;
018000150102         setll  %kds( keyTICMC02 : 1 )  TICMC000;
018100150102
018200150102         // -?Se NON trovato:?
018300150102         //  ?verifica SE il codice ricevuto è un codice FIGLIO?
018400150102         If  NOT %equal(TICMC02L);
018500150102
018600150102           clear TIBS10DS;
018700150102           D10tle = 'ST';
018800150102           D10paf = 'P';
018900150112           D10cod = iKC73ksu ;
019000150102           TIBS10R ( TIBS10ds );
019100150102           if  D10err = *blank  and  D10cop > *zero;
019200150102             k_CMCksu = D10cop;
019300150102           endif;
019400150102
019500150102           setll  %kds( keyTICMC02 : 1 )  TICMC000;
019600150102
019700150102         EndIf;
019800150102
019900150102         reade  %kds( keyTICMC02 : 1 )  TICMC000;
020000150102
020100150102         // -?Se trovato:?
020200150102         //  ?verifica SE la campagna è ancora aperta?
020300150102         //         ?e SE con trattative ancora inseribili?
020400150105         DOW  NOT %eof(TICMC02L);
020500150102
020600150102           k_CMPncm = CMCncm;
020700150102           chain  %kds( keyTICMP01 )  TICMP000;
020800150102
020900150430           If  %found(TICMP01L)  and  CMPdfc >= wDate  and
021000150112               ( iKC73dat = *zero    or
021100150206                (iKC73dat >= CMPdic  and  iKC73dat <= CMPdfc) );
021200150102
021300150206             // ·?SE richiesto: si scartano le Campagne con Data Trattativa?
021400150206             //     ?esclusa dal periodo "Inserimento Trattative"?
021500150206             // ·?Si scartano anche le stesse fasi della stessa Campagna?
021600150105             //  ?(già memorizzata)?
021700150206             If  ( iKC73ftr <> 'S'     or
021800150206                  (iKC73ftr =  'S'     and
021900150206                   iKC73dat >= CMPdit  and  iKC73dat <= CMPdft) )  and
022000150206                 %lookup( CMCncm : sk_oKC73nc ) = *zero;
022100150105
022200150105               // ·?Restituzione dei dati della Campagna?
022300150112               if  xx = %elem( sk_oKC73nc );
022400150112                 //oKC73err = 'E';
022500150112                 oKC73msg = sk_Msg(02);
022600150105                 leave;
022700150105               endif;
022800150105
022900150105               if  xx = *zero;
023000150112                 oKC73ksu   = CMCksu;
023100150105               endif;
023200150105               xx += 1;
023300150112               sk_oKC73nc(xx) = CMCncm;
023400150112               sk_oKC73dc(xx) = CMPdes;
023500150105
023600150105               k_CMCncm = CMCncm;
023700150105               setGT  %kds( keyTICMC02 )  TICMC000;
023800150105
023900150105             EndIf;
024000150102
024100150102           EndIf;
024200150102
024300150102           reade  %kds( keyTICMC02 :1 )  TICMC000;
024400150102
024500150102         ENDDO;
024600150102
024700150102         if  xx = *zero;
024800150112           oKC73err = 'E';
024900150112           oKC73msg = sk_Msg(01);
025000150102         endif;
025100150102
025200150102       ENDSR;
025300150102
025400150102       //--------------------------------------------------------------
025500150102       //?Operazioni iniziali.                                         ?
025600150102       //--------------------------------------------------------------
025700150102       BEGSR  sr_RoutEnd;
025800150102
025900150102         // -?Uscita?
026000150102         return;
026100150102
026200150102       ENDSR;
026300150102
026400150102      /end-free
026500150102
026600150102       //--------------------------------------------------------------
026700150102       //?Schiere a tempo di compilazione.                             ?
026800150102       //--------------------------------------------------------------
026900150102
027000150102** -?sk_Msg?(Messaggi di errore)?--------------------------------------------*
027100150102Non trovato il cliente in campagna                                             1
027200150102Cliente in più di 10 campagne                                                  2
