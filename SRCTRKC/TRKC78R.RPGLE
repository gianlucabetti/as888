000100170222      //--------------------------------------------------------------
000200170222      //?TRKC78R - Calcolo spedizioni mensili e % delta
000300170222      //--------------------------------------------------------------
000400170222     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000500170222
000600170222      //--------------------------------------------------------------
000700170222      //?Dichiarazione file.                                          ?
000800170222      //--------------------------------------------------------------
000900170223      // - Tabelle
001000170223     fTABEL00F  if   e           k disk
001100170222
001200170222      //--------------------------------------------------------------
001300170222      //?Definizione costanti.                                        ?
001400170222      //--------------------------------------------------------------
001500170222
001600170222      //--------------------------------------------------------------
001700170222      //?Definizione schiere.                                         ?
001800170222      //--------------------------------------------------------------
001900170222      // - Messaggi di errore?
002000170222     d Msg             s             78    dim(03)  ctdata  perrcd(01)
002100170222
002200170222      //--------------------------------------------------------------
002300170222      //?Definizione aree dati.                                       ?
002400170222      //--------------------------------------------------------------
002500170222      // - Dati utente?
002600170222     d §AzUte        e ds                  extname(AZUTE00F)
002700170222     d                                     dtaara
002800170222     d §DatiUte      e ds                  extname(dDatiUte)
002900170222     d                                     dtaara
003000170222
003100170222      //--------------------------------------------------------------
003200170222      //?Definizione strutture dati.                                  ?
003300170222      //--------------------------------------------------------------
003400170222      // - Parametri ricevuti?
003500170222     d KPJBA         e ds
003600170222     d TRKC78DS      e ds
003700170222
003800170222      // - Reperimento dati utente?
003900170222     d TIBS34DS      e ds                  inz
004000170222
004100170222      // - Calcola Saldi cliente  ?
004200170222     d TISE70DS      e ds                  inz
004300170223
004400170223      // - Tabella 5S - Statistiche
004500170223     d ds5S          e ds
004600170222
004700170222      //--------------------------------------------------------------
004800170222      //?Definizione variabili globali.                               ?
004900170222      //--------------------------------------------------------------
005000170223      // - Campi di comodo data
005100170223     d Data_EUR        s               d   datfmt(*eur)
005200170223     d Data_ISO        s               d   datfmt(*iso)
005300170223      // - Campi di comodo
005400170223     d Oggi            s              8s 0 inz
005500170223     d wanno           s              4s 0 inz
005600170223     d wdata           s              8s 0 inz
005700170223     d wdel            s              8s 1 inz
005800170223     d wmese           s              2s 0 inz
005900170223     d wval            s             20s 3 inz
006000170222
006100170222      //--------------------------------------------------------------
006200170223      //?Definizione Prototipi e Procedure.                             ?
006300170222      //--------------------------------------------------------------
006400170222      // - Reperimento dati utente?
006500170222      /copy gaitrasrc/srcProtoPR,TIBS34R
006600170223
006700170223      // - Calcola saldi cliente
006800170223     d TISE70R         pr                  extpgm('TISE70R')
006900170223     d  tise70ds                           likeds(TISE70DS)
007000170222
007100170222      //--------------------------------------------------------------
007200170222      //?Definizione key-list.                                        ?
007300170222      //--------------------------------------------------------------
007400170223      // - File TABEL00F
007500170223     d k03tabel      e ds                  extname(TABEL00F:*key)
007600170223     d                                     prefix(k_)
007700170222
007800170222      //--------------------------------------------------------------
007900170222      //?M A I N - L I N E                                            ?
008000170222      //--------------------------------------------------------------
008100170222
008200170222     c     *Entry        plist
008300170222     c                   parm                    KPJBA
008400170222     c                   parm                    TRKC78DS
008500170222
008600170222      /free
008700170222
008800170222      //?Operazioni iniziali?
008900170222       exsr RoutInz;
009000170222
009100170222      //?Elabora?
009200170222       exsr Elabora;
009300170222
009400170222      //?Operazioni finali?
009500170222       exsr RoutEnd;
009600170222
009700170222      //--------------------------------------------------------------
009800170222      //?Operazioni iniziali.                                         ?
009900170222      //--------------------------------------------------------------
010000170222       BEGSR RoutInz;
010100170222
010200170222       //?Reperimento dati job
010300170222         exsr DatiJob;
010400170222
010500170222       //?Pulizia campi output
010600170222         clear OKC78err;
010700170222         clear OKC78msg;
010800170222         clear OKC78sped;
010900170222         clear OKC78delta;
011000170223
011100170223       //?Cliente obbligatorio
011200170223         IF  IKC78ksu = 0;
011300170223           OKC78err = '1';
011400170223           OKC78msg = Msg(01);
011500170223           exsr RoutEnd;
011600170223         ENDIF;
011700170223
011800170223       //?Dalla tabella "5S" recupero le date aggiornamento saldi
011900170223         k_TBLkut = 1;
012000170223         k_TBLcod = '5S';
012100170223         clear k_TBLkey;
012200170223         clear ds5S;
012300170223         chain %kds(K03tabel) TABEL00F;
012400170223         IF  %found(TABEL00F) and TBLflg = *blanks;
012500170223           ds5S = TBLuni;
012600170223         ENDIF;
012700170223
012800170223       //?Imposto Anno e Mese per calcolo saldi clienti
012900170223         Data_ISO = %date(§5Sdac);
013000170223       //?Devo elaborare il mese precedente alla data ultimo aggiornamento saldi
013100170223         wdata = %dec(Data_ISO - %months(1));
013200170223         Data_ISO = %date(wdata);
013300170223         wanno = %subdt(Data_ISO:*years);
013400170223         wmese = %subdt(Data_ISO:*months);
013500170223
013600170223       ENDSR;
013700170223
013800170223       //--------------------------------------------------------------
013900170222       //?Reperimento Dati del job (Utente/Operativi).
014000170222       //--------------------------------------------------------------
014100170222       BEGSR DatiJob;
014200170222
014300170222         in(E) §AzUte;
014400170222         IF  NOT %error;
014500170222           in(E) §DatiUte;
014600170222         ENDIF;
014700170222         IF  %error or RSut = *blanks;
014800170222           clear TIBS34ds;
014900170222           tibs34r(tibs34ds);
015000170222           in §AzUte;
015100170222           in §DatiUte;
015200170222         ENDIF;
015300170222
015400170222       ENDSR;
015500170222
015600170222       //--------------------------------------------------------------
015700170222       //?Elaborazione.
015800170222       //--------------------------------------------------------------
015900170222       BEGSR Elabora;
016000170223
016100170223         clear wVal;
016200170223         clear wDel;
016300170223         clear TISE70DS;
016400170223         I70tla = 'U';
016500170223         I70tle = 'ST';
016600170223         I70ksc = IKC78ksu;
016700170223         I70dai = wanno * 100 + wmese;
016800170223         I70daf = I70dai;
016900170222
017000170223       //?Cerco i saldi cliente
017100170223         tise70r (TISE70DS);
017200170223         OKC78sped = O70nsp;
017300170223
017400170223       //?Calcolo il delta
017500170223       //?Ricavo Reale - Ricavo presunto * 100 / Ricavo Reale
017600170223         wVal = (O70rir - O70rip) * 100;
017700170223
017800170223         IF  O70rir = 0;
017900170223           O70rir = 1;
018000170223         ENDIF;
018100170223
018200170223         wVal = wVal / O70rir;
018300170223         eval(h) wDel = wVal;
018400170223
018500170223         SELECT;
018600170223         WHEN  wDel = 0;
018700170223         WHEN  wDel >= 1000;
018800170223           OKC78delta = 999,9;
018900170223         WHEN  wDel <= -1000;
019000170223           OKC78delta = -999,9;
019100170223         OTHER;
019200170223           OKC78delta = wDel;
019300170223         ENDSL;
019400170222
019500170222       ENDSR;
019600170222
019700170222       //--------------------------------------------------------------
019800170222       //?Operazioni finali.
019900170222       //--------------------------------------------------------------
020000170222       BEGSR RoutEnd;
020100170222
020200170222         *inLR = *on;
020300170222         return;
020400170222
020500170222       ENDSR;
020600170222
020700170222      /end-free
020800170222** -?Msg --------------------------------------------------------------------*
020900170222Non trovato il cliente in campagna                                             1
