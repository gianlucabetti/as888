000100141106      //--------------------------------------------------------------
000200150305      //?TRKC80R1 - Cancella i clienti in campagna
000300141106      //--------------------------------------------------------------
000400141106
000500141106     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600141106
000700141106      //---------------------------------------------------------------
000800141106      //?Dichiarazione file.
000900141106      //---------------------------------------------------------------
001000150211
001100150305      // - Fasi Campagna
001200150305     fTICMF01L  if   e           k disk
001300141106
001400141106      //---------------------------------------------------------------
001500141106      //?Definizione costanti.
001600141106      //---------------------------------------------------------------
001700150305
001800150305     d FaseObjFine     c                   const(' 30')
001900150305     d FaseChiudi      c                   const(' 90')
002000141106
002100141106      //---------------------------------------------------------------
002200141106      //?Definizione schiere.
002300141106      //---------------------------------------------------------------
002400141106
002500141106      //---------------------------------------------------------------
002600141106      //?Definizione aree dati.
002700141106      //---------------------------------------------------------------
002800141106
002900141106      // - Dati utente
003000141106     d §AzUte        e ds                  extname(AZUTE00F)
003100141106     d                                     dtaara
003200141106     d §DatiUte      e ds                  extname(dDatiUte)
003300141106     d                                     dtaara
003400141106
003500141106      //---------------------------------------------------------------
003600141106      //?Definizione strutture dati.
003700141106      //---------------------------------------------------------------
003800141106
003900141106      // - Status
004000141106     d Psds           sds
004100141106     d   SDSpgm          *proc
004200141106
004300141106      // - Parametri ricevuti
004400141106     d KPJBA         e ds
004500141106
004600141106      // - Reperimento dati utente
004700141106     d TIBS34DS      e ds
004800150211
004900150305      // - Cancella clienti in campagna
005000150305     d TRKC77DS      e ds
005100150211
005200150211      // - File Clienti in Campagna Commerciale
005300150211     d TICMC00F      e ds                  extname(TICMC00F)
005400150211
005500150211      // - File INFO Clienti in Campagna Commerciale
005600150211     d TICMI00F      e ds                  extname(TICMI00F)
005700150211
005800141106      //---------------------------------------------------------------
005900141106      //?Definizione variabili globali.
006000141106      //---------------------------------------------------------------
006100150305
006200150305      // - Flag Booleani
006300150305     d EoF             s               n   inz(*off)
006400141106
006500141106      // - Campi di comodo data
006600141106     d Data_EUR        s               d   datfmt(*eur)
006700141106     d Data_ISO        s               d   datfmt(*iso)
006800141106
006900141106      // - Campi di comodo
007000150305     d Delta           s              4s 1 inz
007100141106     d Oggi            s              8s 0 inz
007200141106
007300141106      //---------------------------------------------------------------
007400141106      //?Definizione procedure usate.
007500141106      //---------------------------------------------------------------
007600150305
007700150305      // - Cancello clienti in campagna
007800150305     d TRKC77R         pr                  extpgm('TRKC77R')
007900150305     d  kpjba                              likeds(kpjba)
008000150305     d  trkc77ds                           likeds(TRKC77DS)
008100141106
008200141106      //---------------------------------------------------------------
008300141106      //?Definizione Prototipi.
008400141106      //---------------------------------------------------------------
008500141106      /copy gaitrasrc/srcprotopr,TIBS34R
008600141106
008700141106      //---------------------------------------------------------------
008800141106      //?Definizione key-list.
008900141106      //---------------------------------------------------------------
009000141106
009100141106      //---------------------------------------------------------------
009200141106      //?M A I N - L I N E
009300141106      //---------------------------------------------------------------
009400141106
009500141106     c     *Entry        plist
009600141106     c                   parm                    kpjba
009700141106
009800141106      /free
009900141106
010000141106       //?Operazioni iniziali
010100141106       exsr RoutInz;
010200141106
010300150305       //?Elabora
010400150305       exsr Elabora;
010500141106
010600141106       //?Operazioni finali
010700141106       exsr RoutEnd;
010800141106
010900141106       //--------------------------------------------------------------
011000141106       //?Operazioni iniziali.
011100141106       //--------------------------------------------------------------
011200141106       BEGSR RoutInz;
011300141106
011400141106       //?Imposto oggi
011500141106         Oggi = %dec(%date());
011600141106
011700141106       //?Reperimento dati job
011800141106         exsr DatiJob;
011900150305
012000150305       //?Imposto Delta di riferimento
012100150305         Delta = -15;
012200141106
012300141106       ENDSR;
012400141106
012500141106       //--------------------------------------------------------------
012600141106       //?Reperimento Dati del job (Utente/Operativi).
012700141106       //--------------------------------------------------------------
012800141106       BEGSR DatiJob;
012900141106
013000141106         in(E) §AzUte;
013100141106         IF  NOT %error;
013200141106           in(E) §DatiUte;
013300141106         ENDIF;
013400141106         IF  %error or RSut = *blanks;
013500141106           clear TIBS34ds;
013600141106           tibs34r(tibs34ds);
013700141106           in §AzUte;
013800141106           in §DatiUte;
013900141106         ENDIF;
014000141106
014100141106       ENDSR;
014200141106
014300141106       //--------------------------------------------------------------
014400150305       //?Elabora.
014500141106       //--------------------------------------------------------------
014600150305       BEGSR Elabora;
014700141106
014800150211         exec sql
014900150305         declare CMC cursor for
015000150305         select * from TICMC00F join TICMI00F on
015100150305         CMCncm = CMIncm and CMCksu = CMIksu and
015200150305         CMCksc = CMIksc and CMCcpo = CMIcpo
015300150305         where CMCncm in(1, 2)
015400150305         order by CMCncm, CMCksu, CMCksc, CMCcpo;
015500150305
015600150305         exec sql open CMC;
015700150305
015800150305         Eof = *off;
015900150305
016000150305         IF sqlcode < 0;
016100150305           EoF = *on;
016200150305           leavesr;
016300150305         ENDIF;
016400150305
016500150305         DOW  not EoF;
016600150305           exec sql
016700150305           fetch next from CMC into :TICMC00F, :TICMI00F;
016800150305           IF sqlcod = 100 or sqlcod < 0;
016900150305             EoF = *on;
017000150305             leave;
017100150305           ENDIF;
017200150305
017300150305       //?Se ultima fase cliente è di chiusura vuol dire
017400150305       //?che è un cliente bloccato quindi lo cancello
017500150305           IF  CMCufe = FaseChiudi;
017600150305             clear TRKC77DS;
017700150305             IKC77ncm  = CMCncm;
017800150305             IKC77ksu  = CMCksu;
017900150305             IKC77ksc  = CMCksc;
018000150305             IKC77cpo  = CMCcpo;
018100150305             TRKC77R (kpjba:TRKC77DS);
018200150305             iter;
018300150305           ENDIF;
018400150305
018500150305       //?Se ultima fase cliente è fase finale controllo l'obiettivo
018600150305       //?se a 0 lo cancello
018700150305           IF  CMCufe = FaseObjFine;
018800150305             chain (CMCncm:CMCksu:CMCksc:CMCcpo:CMCufe) TICMF01L;
018900150305             IF  %found(TICMF01L) and CMFpea = 0;
019000150305               clear TRKC77DS;
019100150305               IKC77ncm  = CMCncm;
019200150305               IKC77ksu  = CMCksu;
019300150305               IKC77ksc  = CMCksc;
019400150305               IKC77cpo  = CMCcpo;
019500150305               TRKC77R (kpjba:TRKC77DS);
019600150305               iter;
019700150305             ENDIF;
019800150305           ENDIF;
019900150305
020000150305       //?Se arrivo qua vuol dire che non è un bloccato e che non ha
020100150305       //?obiettivo finale 0 quindi controllo il delta
020200150305       //?se tra - 15 e 99
020300150305       //?cancello il cliente
020400150305           IF  CMIpde >= Delta;
020500150305             clear TRKC77DS;
020600150305             IKC77ncm  = CMCncm;
020700150305             IKC77ksu  = CMCksu;
020800150305             IKC77ksc  = CMCksc;
020900150305             IKC77cpo  = CMCcpo;
021000150305             TRKC77R (kpjba:TRKC77DS);
021100150305           ENDIF;
021200150305
021300150305         ENDDO;
021400141106
021500141106       ENDSR;
021600141106
021700141106       //--------------------------------------------------------------
021800141106       //?Operazioni finali.
021900141106       //--------------------------------------------------------------
022000141106       BEGSR RoutEnd;
022100141106
022200141106         *inLR = *on;
022300141106         return;
022400141106
022500141106       ENDSR;
022600141106
022700141106      /end-free
