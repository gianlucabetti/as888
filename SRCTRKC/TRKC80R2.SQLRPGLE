000100141106      //--------------------------------------------------------------
000200150401      //?TRKC80R2 - Cancella i clienti in campagna
000300141106      //--------------------------------------------------------------
000400141106
000500141106     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600141106
000700141106      //---------------------------------------------------------------
000800141106      //?Dichiarazione file.
000900141106      //---------------------------------------------------------------
001000150211
001100150305      // - Fasi Campagna
001200150305     fTICMF01L  if   e           k disk
001300141106
001400141106      //---------------------------------------------------------------
001500141106      //?Definizione costanti.
001600141106      //---------------------------------------------------------------
001700150305
001800150305     d FaseChiudi      c                   const(' 90')
001900141106
002000141106      //---------------------------------------------------------------
002100141106      //?Definizione schiere.
002200141106      //---------------------------------------------------------------
002300141106
002400141106      //---------------------------------------------------------------
002500141106      //?Definizione aree dati.
002600141106      //---------------------------------------------------------------
002700141106
002800141106      // - Dati utente
002900141106     d §AzUte        e ds                  extname(AZUTE00F)
003000141106     d                                     dtaara
003100141106     d §DatiUte      e ds                  extname(dDatiUte)
003200141106     d                                     dtaara
003300141106
003400141106      //---------------------------------------------------------------
003500141106      //?Definizione strutture dati.
003600141106      //---------------------------------------------------------------
003700141106
003800141106      // - Status
003900141106     d Psds           sds
004000141106     d   SDSpgm          *proc
004100141106
004200141106      // - Parametri ricevuti
004300141106     d KPJBA         e ds
004400141106
004500141106      // - Reperimento dati utente
004600141106     d TIBS34DS      e ds
004700150211
004800150305      // - Cancella clienti in campagna
004900150305     d TRKC77DS      e ds
005000150211
005100150211      // - File Clienti in Campagna Commerciale
005200150211     d TICMC00F      e ds                  extname(TICMC00F)
005300150211
005400150211      // - File INFO Clienti in Campagna Commerciale
005500150211     d TICMI00F      e ds                  extname(TICMI00F)
005600150211
005700141106      //---------------------------------------------------------------
005800141106      //?Definizione variabili globali.
005900141106      //---------------------------------------------------------------
006000150305
006100150305      // - Flag Booleani
006200150305     d EoF             s               n   inz(*off)
006300141106
006400141106      // - Campi di comodo data
006500141106     d Data_EUR        s               d   datfmt(*eur)
006600141106     d Data_ISO        s               d   datfmt(*iso)
006700141106
006800141106      // - Campi di comodo
006900150305     d Delta           s              4s 1 inz
007000141106     d Oggi            s              8s 0 inz
007100141106
007200141106      //---------------------------------------------------------------
007300141106      //?Definizione procedure usate.
007400141106      //---------------------------------------------------------------
007500150305
007600150305      // - Cancello clienti in campagna
007700150305     d TRKC77R         pr                  extpgm('TRKC77R')
007800150305     d  kpjba                              likeds(kpjba)
007900150305     d  trkc77ds                           likeds(TRKC77DS)
008000141106
008100141106      //---------------------------------------------------------------
008200141106      //?Definizione Prototipi.
008300141106      //---------------------------------------------------------------
008400141106      /copy gaitrasrc/srcprotopr,TIBS34R
008500141106
008600141106      //---------------------------------------------------------------
008700141106      //?Definizione key-list.
008800141106      //---------------------------------------------------------------
008900141106
009000141106      //---------------------------------------------------------------
009100141106      //?M A I N - L I N E
009200141106      //---------------------------------------------------------------
009300141106
009400141106     c     *Entry        plist
009500141106     c                   parm                    kpjba
009600141106
009700141106      /free
009800141106
009900141106       //?Operazioni iniziali
010000141106       exsr RoutInz;
010100141106
010200150305       //?Elabora
010300150305       exsr Elabora;
010400141106
010500141106       //?Operazioni finali
010600141106       exsr RoutEnd;
010700141106
010800141106       //--------------------------------------------------------------
010900141106       //?Operazioni iniziali.
011000141106       //--------------------------------------------------------------
011100141106       BEGSR RoutInz;
011200141106
011300141106       //?Imposto oggi
011400141106         Oggi = %dec(%date());
011500141106
011600141106       //?Reperimento dati job
011700141106         exsr DatiJob;
011800141106
011900141106       ENDSR;
012000141106
012100141106       //--------------------------------------------------------------
012200141106       //?Reperimento Dati del job (Utente/Operativi).
012300141106       //--------------------------------------------------------------
012400141106       BEGSR DatiJob;
012500141106
012600141106         in(E) §AzUte;
012700141106         IF  NOT %error;
012800141106           in(E) §DatiUte;
012900141106         ENDIF;
013000141106         IF  %error or RSut = *blanks;
013100141106           clear TIBS34ds;
013200141106           tibs34r(tibs34ds);
013300141106           in §AzUte;
013400141106           in §DatiUte;
013500141106         ENDIF;
013600141106
013700141106       ENDSR;
013800141106
013900141106       //--------------------------------------------------------------
014000150305       //?Elabora.
014100141106       //--------------------------------------------------------------
014200150305       BEGSR Elabora;
014300141106
014400150211         exec sql
014500150305         declare CMC cursor for
014600150401         select * from TICMC00F
014700150401         where CMCncm in(2, 4);
014800150305
014900150305         exec sql open CMC;
015000150305
015100150305         Eof = *off;
015200150305
015300150305         IF sqlcode < 0;
015400150305           EoF = *on;
015500150305           leavesr;
015600150305         ENDIF;
015700150305
015800150305         DOW  not EoF;
015900150305           exec sql
016000150401           fetch next from CMC into :TICMC00F;
016100150305           IF sqlcod = 100 or sqlcod < 0;
016200150305             EoF = *on;
016300150305             leave;
016400150305           ENDIF;
016500150305
016600150305       //?Se ultima fase cliente è di chiusura vuol dire
016700150305       //?che è un cliente bloccato quindi lo cancello
016800150305           IF  CMCufe = FaseChiudi;
016900150305             clear TRKC77DS;
017000150305             IKC77ncm  = CMCncm;
017100150305             IKC77ksu  = CMCksu;
017200150305             IKC77ksc  = CMCksc;
017300150305             IKC77cpo  = CMCcpo;
017400150305             TRKC77R (kpjba:TRKC77DS);
017500150305             iter;
017600150305           ENDIF;
017700150305
017800150305         ENDDO;
017900141106
018000141106       ENDSR;
018100141106
018200141106       //--------------------------------------------------------------
018300141106       //?Operazioni finali.
018400141106       //--------------------------------------------------------------
018500141106       BEGSR RoutEnd;
018600141106
018700141106         *inLR = *on;
018800141106         return;
018900141106
019000141106       ENDSR;
019100141106
019200141106      /end-free
