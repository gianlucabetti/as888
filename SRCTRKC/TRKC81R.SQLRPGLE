000100150223       //==============================================================
000200150305       //?TRKC81R * Fase obiettivo finale Campagna 2 clinti C         ?
000300150223       //==============================================================
000400150223       //--------------------------------------------------------------
000500150223       //?Specifiche di controllo.                                     ?
000600150223       //--------------------------------------------------------------
000700150223
000800150223     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000900150223     h dftactgrp(*no)
001000150223     h bnddir('TRUL')
001100150223     h alwnull(*inputonly)
001200150223
001300150223       //--------------------------------------------------------------
001400150223       //?Dichiarazione file.                                          ?
001500150223       //--------------------------------------------------------------
001600150224
001700150224       // -?Anagrafica Clienti in Campagna?
001800150224     fTICMC01L  if   e           k disk     usropn
001900150223
002000150224       // -?File di stampa (SE non richiesto l'aggiornamento)?
002100150224     fQSYSPRT   o    f  132        printer  usropn  oflind(*inOA)
002200150223
002300150223       //--------------------------------------------------------------
002400150223       //?Definizione costanti.                                        ?
002500150223       //--------------------------------------------------------------
002600150305       // -?Fase
002700150305     d c_Fase          c                   const(' 30')
002800150223
002900150223
003000150223       //--------------------------------------------------------------
003100150223       //?Definizione schiere.                                         ?
003200150223       //--------------------------------------------------------------
003300150223
003400150223
003500150223       //--------------------------------------------------------------
003600150223       //?Definizione aree dati.                                       ?
003700150223       //--------------------------------------------------------------
003800150223
003900150223       // -?Dati utente?
004000150223     d §AzUte        e ds                  extname(AZUTE00F)
004100150223     d                                     dtaara
004200150223     d §DatiUte      e ds                  extname(dDatiUte)
004300150223     d                                     dtaara
004400150223
004500150223       //--------------------------------------------------------------
004600150223       //?Definizione strutture dati.                                  ?
004700150223       //--------------------------------------------------------------
004800150223
004900150305     d wSQL_ds         ds                  qualified     inz
005000150305     d   wNCM                              like(CMCncm)  inz
005100150305     d   wKSU                              like(CMCksu)  inz
005200150305     d   wKSC                              like(CMCksc)  inz
005300150305     d   wCPO                              like(CMCcpo)  inz
005400150305     d   wIST                              like(FLGIst)  inz
005500150305
005600150223
005700150223       // -?Data/Ora attuali?
005800150223     d wTime_ds        ds                  inz
005900150223     d   wDate                        8s 0 inz
006000150223     d   wTime                        6s 0 inz
006100150223
006200150223       // -?Parametri ricevuti?
006300150223     d KPJBA         e ds
006400150223
006500150223
006600150223      //---------------------------------------------------------------
006700150223      //?Definizione variabili globali.
006800150223      //---------------------------------------------------------------
006900150223
007000150223       // -?Flags booleani?
007100150223     d $EoF            s               n   inz
007200150224     d $SoloStampa     s               n   inz
007300150223
007400150223       // -?Stringa SQL da eseguire?
007500150223     d wSQL            s           7000    inz  varying
007600150223
007700150223       // -?Codice errore rilevato?
007800150223     d wErr            s              3  0 inz
007900150223
008000150223       // -?Data *ISO?
008100150223     d wDate_Eur       s               d   inz  datfmt(*EUR)
008200150223
008300150305       // -?Campo di comodo?
008400150305     d FLGist          s              1
008500150223       //--------------------------------------------------------------
008600150223       //?Definizione prototipi/procedure usate.                       ?
008700150223       //--------------------------------------------------------------
008800150223
008900150223       // -?Reperimento dati utente?
009000150223     d TIBS34ds      e ds                  inz
009100150223      /copy gaitrasrc/srcProtoPR,TIBS34R
009200150223
009300150305       // -?Esegue fase clienti in campagna
009400150305     d TRKC71ds      e ds                  inz
009500150305      /copy gaitrasrc/srcProtoPR,TRKC71R
009600150223
009700150223       //--------------------------------------------------------------
009800150223       //?Definizione key-list.                                        ?
009900150223       //--------------------------------------------------------------
010000150223
010100150224       // -?File TICMC01L: Anagrafica Clienti in Campagna?
010200150224     d keyTICMC01    e ds                  extname( TICMC01L : *key )
010300150224     d                                     prefix( k_ )   inz
010400150223
010500150223       //--------------------------------------------------------------
010600150223       //?Riepilogo indicatori utilizzati.                             ?
010700150223       //--------------------------------------------------------------
010800150223
010900150223
011000150223       //--------------------------------------------------------------
011100150223       //?M A I N - L I N E                                            ?
011200150223       //--------------------------------------------------------------
011300150223
011400150223     c     *Entry        plist
011500150223     c                   parm                    KPJBA
011600150223
011700150223      /free
011800150223
011900150223       // -?Operazioni iniziali?
012000150223       exsr  sr_RoutInz;
012100150223
012200150223       // -?Preparazione SQL per estrazione dati?
012300150223       exsr  sr_PrepSQL;
012400150223
012500150223       // -?Ciclo di elaborazione?
012600150223       exsr  sr_OpenCursor;
012700150223
012800150223       DoW  Not $EoF;
012900150223         exsr  sr_ReadCursor;
013000150223       EndDo;
013100150223
013200150223       exsr  sr_CloseCursor;
013300150223
013400150223       // -?Operazioni finali?
013500150223       exsr  sr_RoutEnd;
013600150223
013700150223       //--------------------------------------------------------------
013800150223       //?Operazioni iniziali.                                         ?
013900150223       //--------------------------------------------------------------
014000150223       BEGSR  sr_RoutInz;
014100150223
014200150223         // -?Impostazione opzioni per SQL?
014300150223         exec sql   set  option  DynUsrPrf = *Owner,
014400150223                                 CloSqlCsr = *EndMod;
014500150223
014600150223         // -?Impostazione chiusura?
014700150223         *inLR = *on;
014800150223
014900150223         // -?Reperimento dati job?
015000150223         exsr  sr_DatiJob;
015100150223
015200150223         // -?Reperimento data e ora attuali?
015300150223         wTime_ds  = %editc( %dec( %timestamp() ) : 'X' );
015400150223         wDate_Eur = %date( wDate : *Iso );
015500150223         wDate     = %dec( wDate_Eur );
015600150224
015700150224         // -?Verifica SE richiesta solo la stampa?
015800150224         $SoloStampa = ( %subst( kpjbu : 1 : 10 ) = 'STAMPA    ' );
015900150224         if  $SoloStampa;
016000150224           open  TICMC01L;
016100150224           open  QSYSPRT;
016200150224           except  STAMPAtxt;
016300150224           *inOA = *off;
016400150224         endif;
016500150223
016600150223       ENDSR;
016700150223
016800150223       //--------------------------------------------------------------
016900150223       //?Reperimento Dati del job (Utente/Operativi).                 ?
017000150223       //--------------------------------------------------------------
017100150223       BEGSR  sr_DatiJob;
017200150223
017300150223         in(e) §AzUte;
017400150223         if NOT %error;
017500150223           in(e) §DatiUte;
017600150223         endif;
017700150223         if %error or RSut = *blank;
017800150223           tibs34r ( tibs34ds );
017900150223           in §AzUte;
018000150223           in §DatiUte;
018100150223         endif;
018200150223
018300150223       ENDSR;
018400150223
018500150223       //--------------------------------------------------------------
018600150223       //?Preparazione SQL.                                            ?
018700150223       //--------------------------------------------------------------
018800150223       BEGSR  sr_PrepSQL;
018900150223
019000150303         // -?Preparazione SQL?
019100150223         clear  wSQL;
019200150305         wSQL = 'select CMCncm as NCM, CMCksu as KSU, +
019300150305                        CMCksc as KSC, CMCcpo as CPO, +
019400150305                        CMIIST +
019500150305                 from TICMC00F join TICMI00F on +
019600150305                 CMCncm = CMIncm and CMCksu = CMIksu +
019700150305                                  where CMCncm = 2 +
019800150305                                    and CMCcch =  ''  '' +
019900150305                                  order by CMCksu    +
020000150223                    for fetch only';
020100150223
020200150223         exec sql   prepare S1   from :wSQL;
020300150223
020400150223         // -?Dichiarazione cursore?
020500150223         exec sql   declare C1   cursor for S1;
020600150223
020700150223         if  SQLcode < *zero;
020800150223           $EoF = *on;
020900150223           exsr  sr_PrintErrSQL;
021000150223         endif;
021100150223
021200150223       ENDSR;
021300150223
021400150223       //--------------------------------------------------------------
021500150223       //?Apertura cursore.                                            ?
021600150223       //--------------------------------------------------------------
021700150223       BEGSR  sr_OpenCursor;
021800150223
021900150223         // -?Apertura del cursore?
022000150223         exec sql   open C1;
022100150223
022200150223         if  SQLcode < *zero;
022300150223           $EoF = *on;
022400150223           exsr  sr_PrintErrSQL;
022500150223         endif;
022600150223
022700150223       ENDSR;
022800150223
022900150223       //--------------------------------------------------------------
023000150223       //?Lettura cursore.                                             ?
023100150223       //--------------------------------------------------------------
023200150223       BEGSR  sr_ReadCursor;
023300150223
023400150223         clear  wSQL_ds;
023500150223
023600150223         exec sql   fetch next   from C1   into :wSQL_ds;
023700150223
023800150223         Select;
023900150223
024000150223           // -?Fine File?
024100150223           When  SQLcode = 100;
024200150223             $EoF = *on;
024300150223
024400150223           // -?Errore SQL?
024500150223           When  SQLcode < *zero;
024600150223             $EoF = *on;
024700150223             exsr  sr_PrintErrSQL;
024800150223
024900150224           // -?Richiesta SOLO stampa?
025000150224           When  $SoloStampa;
025100150224             exsr  sr_Stampa;
025200150224
025300150223           // -?Elaborazione singolo cliente?
025400150223           Other;
025500150223             exsr  sr_ElabRec;
025600150223
025700150223         EndSl;
025800150223
025900150223       ENDSR;
026000150224
026100150224       //--------------------------------------------------------------
026200150224       //?Stampa del singolo Cliente eliminabile della Campagna.       ?
026300150224       //--------------------------------------------------------------
026400150224       BEGSR  sr_Stampa;
026500150224
026600150224         clear  keyTICMC01;
026700150224         k_CMCncm = wSQL_ds.wNCM;
026800150224         k_CMCksu = wSQL_ds.wKSU;
026900150224         k_CMCksc = wSQL_ds.wKSC;
027000150224         k_CMCcpo = wSQL_ds.wCPO;
027100150224         chain  %kds( keyTICMC01 )  TICMC000;
027200150224         if  Not %found(TICMC01L);
027300150224           clear  CMCufe;
027400150224           clear  CMCcch;
027500150224           clear  CMCdch;
027600150224         endif;
027700150223
027800150224         if  *inOA;
027900150224           except  STAMPAtxt;
028000150224           *inOA = *off;
028100150224         endif;
028200150224
028300150224         except STAMPAdet;
028400150224
028500150224       ENDSR;
028600150223       //--------------------------------------------------------------
028700150223       //?Elaborazione singolo Cliente da eliminare dalla Campagna.    ?
028800150223       //--------------------------------------------------------------
028900150223       BEGSR  sr_ElabRec;
029000150223
029100150305         // -?Creo fase 30 con % aumento 4 se cliente senza ISTAT e % 4,3 se cliente con ISTAT SI
029200150305         clear TRKC71DS;
029300150305         IKC71ncm = wSQL_ds.wNCM;
029400150305         IKC71ksu = wSQL_ds.wKSU;
029500150305         IKC71ksc = wSQL_ds.wKSC;
029600150305         IKC71cpo = wSQL_ds.wCPO;
029700150305         IKC71acm = c_Fase  ;
029800150305           if  wsql_ds.WIST = 'S' ;
029900150305             iKC71pea = 4,3 ;
030000150305           else ;
030100150305             iKC71pea = 4   ;
030200150305           endif;
030300150305         IKC71aut = 'A';
030400150305         IKC71dfa = %dec(%date());
030500150305         IKC71hfc = %dec(%time());
030600150305         TRKC71R (kpjba:TRKC71DS);
030700150305
030800150223       ENDSR;
030900150223
031000150223       //--------------------------------------------------------------
031100150223       //?Chiusura cursore.                                            ?
031200150223       //--------------------------------------------------------------
031300150223       BEGSR  sr_CloseCursor;
031400150223
031500150223         // -?Chiusura del cursore?
031600150223         exec sql   close C1;
031700150223
031800150223       ENDSR;
031900150223
032000150223       //--------------------------------------------------------------
032100150223       //?Stampa segnalazione dell'errore rilevato via SQL             ?
032200150223       //--------------------------------------------------------------
032300150223       BEGSR  sr_PrintErrSQL;
032400150223
032500150223         // -?Chiusura del programma?
032600150223         exsr  sr_RoutEnd;
032700150223
032800150223       ENDSR;
032900150223
033000150223       //--------------------------------------------------------------
033100150223       //?Operazioni finali.                                           ?
033200150223       //--------------------------------------------------------------
033300150223       BEGSR  sr_RoutEnd;
033400150223
033500150223         // -?Uscita dal *pgm?
033600150223         return;
033700150223
033800150223       ENDSR;
033900150223
034000150223      /end-free
034100150223
034200150223       //--------------------------------------------------------------
034300150223       //?S P O O L - F I L E S                                        ?
034400150223       //--------------------------------------------------------------
034500150223
034600150224
034700150224       //--------------------------------------------------------------
034800150224
034900150224     oQSYSPRT   e            STAMPAtxt         1
035000150224     o                       RSUT
035100150305     o                                        +   5 'Fase 30 clienti C'
035200150224     o                       wDate         y  +   5
035300150224     o          e            STAMPAtxt   1
035400150224     o                       KNSIF
035500150224     o                       KNMUS            +   1
035600150224     o                                        +   4 '-----------------------+
035700150224     o                                               --------'
035800150224     o                                        +   5 'Pag.'
035900150224     o                       Page2         z  +   0
036000150224     o                       wTime            +   7 '  :  :  '
036100150224     o          e            STAMPAtxt   2
036200150224     o                                              'Campagna'
036300150224     o                                        +   3 'Unific.'
036400150224     o          e            STAMPAtxt   1  1
036500150224     o                                              '--------'
036600150224     o                                        +   3 '-------'
036700150224      *
036800150224Campag*a   Unific.   Cliente    Potenziale   Fase   C.Ch   Data (CMC)
036900150224123456*    1234567   1234567   12345678901   123     12    1234/56/78
037000150224     o          e            STAMPAdet   1
037100150224     o                       k_CMCncm      z
037200150224     o                       k_CMCksu         +   4
037300150224      *
037400150224     o          e            STAMPAend   2
037500150224     o                                        +  25 '***  Fine Lista  ***'
