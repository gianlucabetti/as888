000100150327      //--------------------------------------------------------------
000200150327      //?TRKC82R - Ripristina clienti in campagna (da EDPCAMPAGN)
000300150327      //--------------------------------------------------------------
000400150327
000500150327     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600150327
000700150327      //---------------------------------------------------------------
000800150327      //?Dichiarazione file.
000900150327      //---------------------------------------------------------------
001000150327
001100150327      // - Fasi Campagna
001200150327     fTICMF01L  if   e           k disk
001300150327
001400150327      //---------------------------------------------------------------
001500150327      //?Definizione costanti.
001600150327      //---------------------------------------------------------------
001700150327
001800150327     d FaseObjFine     c                   const(' 30')
001900150330     d FaseChiudi      c                   const(' 90')
002000150327
002100150327      //---------------------------------------------------------------
002200150327      //?Definizione schiere.
002300150327      //---------------------------------------------------------------
002400150327
002500150327      //---------------------------------------------------------------
002600150327      //?Definizione aree dati.
002700150327      //---------------------------------------------------------------
002800150327
002900150327      // - Dati utente
003000150327     d §AzUte        e ds                  extname(AZUTE00F)
003100150327     d                                     dtaara
003200150327     d §DatiUte      e ds                  extname(dDatiUte)
003300150327     d                                     dtaara
003400150327
003500150327      //---------------------------------------------------------------
003600150327      //?Definizione strutture dati.
003700150327      //---------------------------------------------------------------
003800150327
003900150327      // - Status
004000150327     d Psds           sds
004100150327     d   SDSpgm          *proc
004200150327
004300150327      // - Parametri ricevuti
004400150327     d KPJBA         e ds
004500150327
004600150327      // - Reperimento dati utente
004700150327     d TIBS34DS      e ds
004800150327
004900150327      // - Modifica numero campagna
005000150327     d TRKC75DS      e ds
005100150327
005200150327      // - File Clienti in Campagna Commerciale
005300150327     d TICMC00F      e ds                  extname(TICMC00F)
005400150327
005500150327      // - File INFO Clienti in Campagna Commerciale
005600150327     d TICMI00F      e ds                  extname(TICMI00F)
005700150327
005800150327      //---------------------------------------------------------------
005900150327      //?Definizione variabili globali.
006000150327      //---------------------------------------------------------------
006100150327
006200150327      // - Flag Booleani
006300150327     d EoF             s               n   inz(*off)
006400150327
006500150327      // - Campi di comodo data
006600150327     d Data_EUR        s               d   datfmt(*eur)
006700150327     d Data_ISO        s               d   datfmt(*iso)
006800150327
006900150327      // - Campi di comodo
007000150327     d Delta           s              4s 1 inz
007100150327     d Oggi            s              8s 0 inz
007200150327
007300150327      //---------------------------------------------------------------
007400150327      //?Definizione procedure usate.
007500150327      //---------------------------------------------------------------
007600150327
007700150327      // - Modifica Numero Campagna
007800150327     d TRKC75R         pr                  extpgm('TRKC75R')
007900150327     d  kpjba                              likeds(kpjba)
008000150327     d  trkc75ds                           likeds(TRKC75DS)
008100150327
008200150327      //---------------------------------------------------------------
008300150327      //?Definizione Prototipi.
008400150327      //---------------------------------------------------------------
008500150327      /copy gaitrasrc/srcprotopr,TIBS34R
008600150327
008700150327      //---------------------------------------------------------------
008800150327      //?Definizione key-list.
008900150327      //---------------------------------------------------------------
009000150327
009100150327      //---------------------------------------------------------------
009200150327      //?M A I N - L I N E
009300150327      //---------------------------------------------------------------
009400150327
009500150327     c     *Entry        plist
009600150327     c                   parm                    kpjba
009700150327
009800150327      /free
009900150327
010000150327       //?Operazioni iniziali
010100150327       exsr RoutInz;
010200150327
010300150327       //?Elabora
010400150327       exsr Elabora;
010500150327
010600150327       //?Operazioni finali
010700150327       exsr RoutEnd;
010800150327
010900150327       //--------------------------------------------------------------
011000150327       //?Operazioni iniziali.
011100150327       //--------------------------------------------------------------
011200150327       BEGSR RoutInz;
011300150327
011400150327       //?Imposto oggi
011500150327         Oggi = %dec(%date());
011600150327
011700150327       //?Reperimento dati job
011800150327         exsr DatiJob;
011900150327
012000150327       //?Imposto Delta di riferimento
012100150327         Delta = -15;
012200150327
012300150327       ENDSR;
012400150327
012500150327       //--------------------------------------------------------------
012600150327       //?Reperimento Dati del job (Utente/Operativi).
012700150327       //--------------------------------------------------------------
012800150327       BEGSR DatiJob;
012900150327
013000150327         in(E) §AzUte;
013100150327         IF  NOT %error;
013200150327           in(E) §DatiUte;
013300150327         ENDIF;
013400150327         IF  %error or RSut = *blanks;
013500150327           clear TIBS34ds;
013600150327           tibs34r(tibs34ds);
013700150327           in §AzUte;
013800150327           in §DatiUte;
013900150327         ENDIF;
014000150327
014100150327       ENDSR;
014200150327
014300150327       //--------------------------------------------------------------
014400150327       //?Elabora.
014500150327       //--------------------------------------------------------------
014600150327       BEGSR Elabora;
014700150327
014800150327         exec sql
014900150327         declare CMC cursor for
015000150327         select * from TICMC00F join TICMI00F on
015100150327         CMCncm = CMIncm and CMCksu = CMIksu and
015200150327         CMCksc = CMIksc and CMCcpo = CMIcpo
015300150327         where CMCncm in(1, 2)
015400150327         order by CMCncm, CMCksu, CMCksc, CMCcpo;
015500150327
015600150327         exec sql open CMC;
015700150327
015800150327         Eof = *off;
015900150327
016000150327         IF sqlcode < 0;
016100150327           EoF = *on;
016200150327           leavesr;
016300150327         ENDIF;
016400150327
016500150327         DOW  not EoF;
016600150327           exec sql
016700150327           fetch next from CMC into :TICMC00F, :TICMI00F;
016800150327           IF sqlcod = 100 or sqlcod < 0;
016900150327             EoF = *on;
017000150327             leave;
017100150327           ENDIF;
017200150330
017300150330       //?Se ultima fase cliente è di chiusura vuol dire
017400150330       //?che è un cliente bloccato quindi lo salto
017500150330           IF  CMCufe = FaseChiudi;
017600150330             iter;
017700150330           ENDIF;
017800150327
017900150327       //?Se obiettivo finale a 0 salto
018000150327           chain (CMCncm:CMCksu:CMCksc:CMCcpo:FaseObjFine) TICMF01L;
018100150330           IF  %found(TICMF01L) and CMFpea <= 0;
018200150327             iter;
018300150327           ENDIF;
018400150327
018500150327       //?Se delta tra - 15 e 99 ripristino
018600150327           IF  CMIpde >= Delta;
018700150327             clear TRKC75DS;
018800150327             IKC75ncm  = CMCncm;
018900150327             IKC75ksu  = CMCksu;
019000150327             IKC75ksc  = CMCksc;
019100150327             IKC75cpo  = CMCcpo;
019200150327       //?metto in campagna 3 se ora è im campagna 1
019300150327             IF  CMCncm = 1;
019400150327               IKC75nncm = 3;
019500150327             ENDIF;
019600150327       //?metto in campagna 4 se ora è im campagna 2
019700150327             IF  CMCncm = 2;
019800150327               IKC75nncm = 4;
019900150327             ENDIF;
020000150327             TRKC75R (kpjba:TRKC75DS);
020100150327           ENDIF;
020200150327
020300150327         ENDDO;
020400150327
020500150327       ENDSR;
020600150327
020700150327       //--------------------------------------------------------------
020800150327       //?Operazioni finali.
020900150327       //--------------------------------------------------------------
021000150327       BEGSR RoutEnd;
021100150327
021200150327         *inLR = *on;
021300150327         return;
021400150327
021500150327       ENDSR;
021600150327
021700150327      /end-free
