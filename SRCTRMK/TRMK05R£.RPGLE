000100091029      //---------------------------------------------------------------
000200110201      //?TRMK05R - Calcolo la categoria del potenziale
000300091029      //---------------------------------------------------------------
000400091029
000500091029     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600091029     h dftactgrp(*no) actgrp(*caller)
000700091029
000800091029      //---------------------------------------------------------------
000900091029      //?Dichiarazione file.
001000091029      //---------------------------------------------------------------
001100101217      // - File Anagrafica clienti
001200101217     fCNACO16L  if   e           k disk
001300091029
001400110411      // - File Attività
001500110426     fTiatc05L  if   e           k disk
001600110412
001700110412      // - File Trattative
001800110803     fTivis01L  if   e           k disk
001900110415
002000091029      //---------------------------------------------------------------
002100091029      //?Definizione costanti.
002200091029      //---------------------------------------------------------------
002300091029
002400091029      //---------------------------------------------------------------
002500091029      //?Definizione schiere.
002600091029      //---------------------------------------------------------------
002700091029
002800091029      //---------------------------------------------------------------
002900091029      //?Definizione aree dati.
003000091029      //---------------------------------------------------------------
003100091029      //---------------------------------------------------------------
003200091029      //?Definizione strutture dati.
003300091029      //---------------------------------------------------------------
003400101216
003500091029      // - Parametri ricevuti
003600091029     d KPJBA         e ds
003700110131     d TRMK05ds      e ds
003800110201
003900110201      // File Trattative
004000110201     d TIVIS00F      e ds                  extname(TIVIS00F)
004100110201
004200091029      //---------------------------------------------------------------
004300091029      //?Definizione variabili globali.
004400091029      //---------------------------------------------------------------
004500091029
004600091029      // - Flags booleani
004700101217     d $AcoBlc         s               n   inz(*off)
004800091029     d $End            s               n   inz(*off)
004900110201     d $EndAtc         s               n   inz(*off)
005000091029     d $Fine           s               n   inz(*off)
005100101216
005200101216      // - Indici di schiera
005300101216     d xx              s              4  0 inz
005400091029
005500091029      // - Campi di comodo
005600101217
005700110131     d wNrAtc          s              5i 0
005800110131     d wNrVis          s              5i 0
005900110415
006000091029      //---------------------------------------------------------------
006100091029      //?Definizione procedure esterne.
006200091029      //---------------------------------------------------------------
006300101216
006400110131
006500101216      //---------------------------------------------------------------
006600101216      //?Definizione prototipi.
006700101216      //---------------------------------------------------------------
006800091029
006900091029      //---------------------------------------------------------------
007000091029      //?Definizione key-list.
007100091029      //---------------------------------------------------------------
007200091029
007300091029      //---------------------------------------------------------------
007400091029      //?Riepilogo indicatori.
007500091029      //---------------------------------------------------------------
007600091029
007700091029      //---------------------------------------------------------------
007800091029      //?M A I N - L I N E
007900091029      //---------------------------------------------------------------
008000091029
008100091029     c     *Entry        plist
008200091029     c                   parm                    KPJBA
008300110131     c                   parm                    TRMK05ds
008400091029
008500091029      /free
008600091029
008700091029       //?Operazioni iniziali
008800101216       exsr RoutInz;
008900110131
009000101216       //?Elabora
009100091029       DOW  $Fine = *off;
009200101216         exsr Elabora;
009300091029       ENDDO;
009400091029
009500091029       //?Operazioni finali
009600101216       exsr RoutEnd;
009700091029
009800091029       //--------------------------------------------------------------
009900091029       //?Operazioni iniziali.
010000091029       //--------------------------------------------------------------
010100101216       BEGSR RoutInz;
010200101216
010300110131         clear OMK05err;
010400091029
010500101216         //?Se Non ho il potenziale esco dal pgm con errore
010600110131         IF  IMK05CPO = 0;
010700110131           OMK05err = '1';
010800091029           $Fine = *on;
010900091029           leavesr;
011000091029         ENDIF;
011100091029
011200091029       ENDSR;
011300101217
011400101216       //--------------------------------------------------------------
011500101216       //?Elabora.
011600101216       //--------------------------------------------------------------
011700101216       BEGSR Elabora;
011800101217
011900101216         //?Cerco tutti i clienti con il potenziale ricevuto
012000101217         $AcoBlc = *off;
012100101217         $End = *off;
012200110131         setll IMK05cpo CNACO16L;
012300110131
012400110131         //?Nessun KSC associato il potenziale è in Categoria mai codificato
012500110131         IF  not %Equal(CNACO16L);
012600110131           OMK05cat = 'M';
012700110407           exsr Sr_elimina ;
012800101216           $Fine = *on;
012900101216           leavesr;
013000101216         ENDIF;
013100101216
013200110201         //?Se tutti KSC associati bloccati oppure no
013300110131         reade IMK05cpo CNACO16L;
013400110131         DOW not %eof(CNACO16L) ;
013500110131           //?Cliente bloccato
013600101216             IF  ACOabl <> *blanks;
013700101217               $AcoBlc = *on;
013800110131             else ;
013900110131           //?almeno un codice Cliente non bloccato Potenziale caregoria Codificato
014000110131               $acoBlc = *off ;
014100110131               OMK05cat = 'C';
014200110131               $Fine = *on;
014300110131               leavesr;
014400101216             ENDIF;
014500110131
014600110131           reade IMK05cpo CNACO16L;
014700110131         ENDDO  ;
014800110131
014900110131         //?Se tutti i codici collegati sono bloccati bisogna verificare se ce ne è
015000110131
015100110131         If  $AcoBlc = *on ;
015200110131               OMK05cat = 'P';
015300110407               exsr Sr_elimina ;
015400110131               $Fine = *on;
015500110131               leavesr;
015600110131         Endif ;
015700101216
015800101216       ENDSR;
015900110131
016000110131       //--------------------------------------------------------------
016100110131       //?Verifico se Potenziale Eliminabile
016200110131       //--------------------------------------------------------------
016300110131       BEGSR Sr_elimina ;
016400110131
016500110131         //?Verifico se il potenziale Perso o mai codificato è ache eliminabile
016600110131
016700110201         //?Controllo se ci sono trattative aperte sul potenziale
016800110201         //?se ne trovo vuol dire che il potenizale non è eliminabile
016900110201         //?alla prima trattativa esco dal ciclo
017000110412         setll imk05cpo tivis01l ;
017100110412         reade imk05cpo tivis01l ;
017200110201
017300110201         //?Ho trovato almeno 1 trattativa aperta
017400110412         IF  not %eof(tivis01l) and visdch = 0 ;
017500110201           $Fine = *on;
017600110201           leavesr;
017700110201         ENDIF;
017800110201
017900110201
018000110131         //?Controllo se ci sono attività da eseguire sul potenziale
018100110131         //?se ne trovo vuol dire che il potenziale lavora
018200110131
018300110131         clear wNrAtc;
018400110426         setll imk05cpo tiatc05l ;
018500110426         reade imk05cpo tiatc05l ;
018600110426         If not %eof(tiatc05l) and atcdco = 0;
018700110411           $Fine = *on;
018800110411           leavesr;
018900110411         ENDIF;
019000110426         setgt imk05cpo tiatc05l ;
019100110426         readpe imk05cpo tiatc05l ;
019200110426         If not %eof(tiatc05l) ;
019300110131         //?Controllo se l'ultima attività eseguita sul potenziale è una 14 o 15
019400110201             If Atccac = '14' or Atccac = '15' ;
019500110201               OMK05cat = 'E';
019600110131             ENDIF;
019700110411         ENDIF ;
019800110201
019900110131       ENDSR;
020000110131
020100091029       //--------------------------------------------------------------
020200091029       //?Operazioni finali.
020300091029       //--------------------------------------------------------------
020400101216       BEGSR RoutEnd;
020500091029
020600091029         *inLR = *on;
020700091029         return;
020800091029
020900091029       ENDSR;
021000091029
021100091029      /end-free
