000100080206      //--------------------------------------------------------------
000200110201      //?TRMK06R - Aggiorna categoria Potenziali su TNCPO
000300080206      //--------------------------------------------------------------
000400080206
000500100820     h decedit('0,') datedit(*ymd) option(*nodebugio)
000600080206
000700080206      //---------------------------------------------------------------
000800080206      //?Dichiarazione file.
000900080206      //---------------------------------------------------------------
001000080206
001100110201      // - Archivio Potenziali
001200110201     fTNCPO01L  uf   e           k disk
001300080206
001400080206      //---------------------------------------------------------------
001500090406      //?Definizione costanti.
001600080206      //---------------------------------------------------------------
001700050519
001800080206
001900080206      //---------------------------------------------------------------
002000080206      //?Definizione schiere.
002100080206      //---------------------------------------------------------------
002200080206
002300080206
002400080206      //---------------------------------------------------------------
002500080206      //?Definizione aree dati.
002600080206      //---------------------------------------------------------------
002700080206
002800080206
002900080206      //---------------------------------------------------------------
003000080206      //?Definizione strutture dati.
003100080206      //---------------------------------------------------------------
003200080206
003300080206      // - Status
003400080206     d Psds           sds
003500080206     d   SDSpgm          *proc
003600080206
003700080206      // - Parametri ricevuti
003800080206     d KPJBA         e ds
003900090717
004000110201      // - Calcolo categoria potenziale
004100110201     d TRMK05ds      e ds                  inz
004200100719
004300080206      //---------------------------------------------------------------
004400080206      //?Definizione variabili globali.
004500080206      //---------------------------------------------------------------
004600080206
004700080206      // - Flags booleani
004800100312     d $End            s               n   inz(*off)
004900110201     d $EndCpo         s               n   inz(*off)
005000080206
005100090401
005200080206      // - Campi di comodo
005300090717
005400100723     d StringaSql      s            750    Varying       inz
005500080208
005600090508      //---------------------------------------------------------------
005700090508      //?Definizione procedure usate.
005800090508      //---------------------------------------------------------------
005900080206
006000080626      //---------------------------------------------------------------
006100080626      //?prototipi
006200080626      //---------------------------------------------------------------
006300100719
006400110201     d TRMK05R         pr                  extpgm('TRMK05R')
006500100719     d  kpjba                              likeds(kpjba)
006600110201     d  trmk05ds                           likeds(trmk05ds)
006700100820
006800110415     d TRMK09R         pr                  extpgm('TRMK09R')
006900110415     d  kpjba                              likeds(kpjba)
007000110415
007100080206      //---------------------------------------------------------------
007200080206      //?Definizione key-list.
007300080206      //---------------------------------------------------------------
007400080206
007500080206
007600080206      //---------------------------------------------------------------
007700080206      //?Riepilogo indicatori.
007800080206      //---------------------------------------------------------------
007900090518      // - Comuni
008000080207      // 99    : Generico di Errore
008100080206      //---------------------------------------------------------------
008200080206
008300080206      //---------------------------------------------------------------
008400080206      //?M A I N - L I N E
008500080206      //---------------------------------------------------------------
008600080206
008700080206     c     *Entry        plist
008800080206     c                   parm                    KPJBA
008900080206
009000080206      /free
009100080206
009200080206       // Operazioni iniziali
009300080206       exsr RoutInz;
009400090601
009500100909       // Esegui
009600100909       exsr Esegui ;
009700080206
009800080206       // Operazioni finali
009900080206       exsr RoutEnd;
010000080206
010100080206       //--------------------------------------------------------------
010200080206       //?Operazioni iniziali.
010300080206       //--------------------------------------------------------------
010400080206       BEGSR RoutInz;
010500100427
010600100427         exec sql  set option  dynusrprf = *owner,
010700100427                               closqlcsr = *endmod;
010800080206
010900090714
011000080206       ENDSR;
011100080206
011200100909       //--------------------------------------------------------------
011300100909       //?Esecuzione lettura Tivis
011400100909       //--------------------------------------------------------------
011500100909       BEGSR Esegui ;
011600100909
011700100927         exec sql
011800110201          declare CPO cursor for
011900110201          select cpocpo, cpofls
012000110201          from tncpo00f  ;
012100100927
012200100927         exec sql
012300110201           open CPO;
012400100927           IF sqlcode < 0;
012500110201             $EndCpo = *on;
012600100927           ENDIF;
012700100927
012800110201         DOW not $EndCpo;
012900100927           exec sql
013000110201             fetch next from CPO into :CpoCpo, :CpoFls ;
013100100927             IF sqlcod = 100 or sqlcod < 0;
013200110201               $EndCpo = *on;
013300100927               leave;
013400100927             ENDIF;
013500110201         // ricalcolo la categoria del potenziale
013600110201             clear trmk05ds ;
013700110201             imk05cpo = CpoCpo ;
013800110201             trmk05r (Kpjba:Trmk05ds) ;
013900110201             If omk05err = ' ' and omk05cat <> cpofls ;
014000110201                Chain(e) CpoCpo tncpo01l ;
014100110201                 If %error ;
014200110304                    //leave ;
014300110304                    iter;
014400100927                 endif ;
014500110201                 cpofls = Omk05cat ;
014600110201                 update tncpo000 ;
014700110201             endif ;
014800100927
014900100927         ENDDO;
015000100927
015100110201         exec sql close CPO ;
015200110415
015300110415
015400110415         // aggiorno la categoria del potenziale sulle attività da fare ed eseguite dal 11/04/2011
015500110415             trmk09r (Kpjba) ;
015600100927
015700100909       ENDSR;
015800100909
015900080206       //--------------------------------------------------------------
016000080206       //?Operazioni finali.
016100080206       //--------------------------------------------------------------
016200080206       BEGSR RoutEnd;
016300080206
016400080206         *inLR = *on;
016500080206         return;
016600080206
016700080206       ENDSR;
016800080206
016900080206      /end-free
