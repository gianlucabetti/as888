000100110415      //--------------------------------------------------------------
000200110415      //?Trmk09r  - Aggiorna Categoria Potenziale in TIATC
000300110415      //?         - nel FLO dei file
000400110415      //--------------------------------------------------------------
000500110415
000600110415     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000700110415     h dftactgrp(*no) actgrp(*caller)
000800110415
000900110415      //---------------------------------------------------------------
001000110415      //?Dichiarazione file.
001100110415      //---------------------------------------------------------------
001200110415     fTNCPO01L  if   e           k disk
001300110418     fTIATC04L  if   e           k disk    rename(tiatc000:tiatc04) prefix(T_)
001400110418     fTIATC01L  uf   e           k disk
001500110415
001600110415      //---------------------------------------------------------------
001700110415      //?Definizione costanti.
001800110415      //---------------------------------------------------------------
001900110415
002000110415      //---------------------------------------------------------------
002100110415      //?Definizione schiere.
002200110415      //---------------------------------------------------------------
002300110415
002400110415      //---------------------------------------------------------------
002500110415      //?Definizione aree dati.
002600110415      //---------------------------------------------------------------
002700110415
002800110415      // - Dati utente
002900110415     d §AzUte        e ds                  extname(AZUTE00F)
003000110415     d                                     dtaara
003100110415     d §DatiUte      e ds                  extname(dDatiUte)
003200110415     d                                     dtaara
003300110415
003400110415      //---------------------------------------------------------------
003500110415      //?Definizione strutture dati.
003600110415      //---------------------------------------------------------------
003700110415
003800110415      // - Parametri ricevuti
003900110415     d KPJBA         e ds
004000110415
004100110415      // - Flag operativi tiatc
004200110415     d datc01        e ds                  inz
004300110415
004400110415      // - Flag operativi tivis
004500110415     d dvis01        e ds                  inz
004600110415
004700110415
004800110415      //---------------------------------------------------------------
004900110415      //?Definizione variabili globali.
005000110415      //---------------------------------------------------------------
005100110415
005200110415      // - Flags booleani
005300110415     d $End            s               n   inz(*off)
005400110418     d $Aggiorna       s               n   inz(*off)
005500110415
005600110415      // - Indici di schiera
005700110415
005800110415      // - Campi di comodo
005900110415     d w_cpo           s             11  0 inz
006000110415
006100110415      //---------------------------------------------------------------
006200110415      //?Definizione procedure esterne.
006300110415      //---------------------------------------------------------------
006400110415
006500110415
006600110415      //---------------------------------------------------------------
006700110415      //?prototipi
006800110415      //---------------------------------------------------------------
006900110415
007000110415      //---------------------------------------------------------------
007100110415      //?Definizione key-list.
007200110415      //---------------------------------------------------------------
007300110415
007400110415      //---------------------------------------------------------------
007500110415      //?Riepilogo indicatori.
007600110415      //---------------------------------------------------------------
007700110415
007800110415      //---------------------------------------------------------------
007900110415
008000110415      //---------------------------------------------------------------
008100110415      //?M A I N - L I N E
008200110415      //---------------------------------------------------------------
008300110415
008400110415     c     *Entry        plist
008500110415     c                   parm                    KPJBA
008600110415
008700110415      /free
008800110415
008900110415       //?Elaborazione attività / Visite
009000110415       exsr Sr_Aggiorna ;
009100110415
009200110415       //?Operazioni finali
009300110415       exsr RoutEnd;
009400110415
009500110415       //--------------------------------------------------------------
009600110415       //?Aggiornamento archivi Tiatc Tivis
009700110415       //--------------------------------------------------------------
009800110415       BEGSR Sr_aggiorna ;
009900110415
010000110415       // Imposto uno alla chiave perchè voglio evitare di leggere tutte
010100110415       // le attività non legate ai potenziali
010200110415         W_cpo = 1 ;
010300110415         setll W_cpo tiatc04l ;
010400110415         Dow not $end ;
010500110418             $aggiorna = *off ;
010600110418             read    tiatc04l ;
010700110415             If %eof(tiatc04l) ;
010800110415                leave ;
010900110415             Endif ;
011000110418             If T_atccpo = 0 ;
011100110415                iter ;
011200110415             Endif ;
011300110415        // elaboro i soli record attività ancora da eseguire oppure eseguiti dal 11/Aprile/2011
011400110418             If T_atcdco > 0  and T_atcdco < 20110411 ;
011500110415                iter ;
011600110415             Endif ;
011700110415
011800110418             If W_cpo <> T_atccpo  ;
011900110418                W_cpo = T_atccpo   ;
012000110415       // a rottura di codice aggancio il file TNCPO per recuperare l'attuale
012100110415       // categoria da aggiornare sui files
012200110418                chain T_atccpo tncpo01l ;
012300110415                If not %found(tncpo01l) ;
012400110415       // Se non trovo il potenziale mi posizione sulle attività del potenmziale successivo
012500110415                   setgt W_cpo tiatc04l ;
012600110415                   Clear W_cpo ;
012700110415                   iter ;
012800110415                endif ;
012900110415             endif ;
013000110418             datc01 = T_atcflo ;
013100110415       // verifico se 1° categoria potenziale è blank e causale da fare valorizzata
013200110415       // valorizzo la categoria
013300110418             If §atccapo1 = ' ' and T_atccad <> '  ' ;
013400110415                §atccapo1 = cpofls ;
013500110418                $aggiorna  =  *on ;
013600110415             Endif ;
013700110415
013800110415       // verifico se 2° categoria potenziale è blank e causale esecuzione valorizzata
013900110415       // valorizzo la categoria
014000110418             If §atccapo2 = ' ' and T_atccac <> '  ' ;
014100110415                §atccapo2 = cpofls ;
014200110418                $aggiorna  =  *on ;
014300110415             Endif ;
014400110418
014500110418             If $aggiorna = *on ;
014600110418                chain(e) (T_atctat:T_atcatn:T_atcatnp) Tiatc01l ;
014700110418        // se record impegnato leggo il successivo
014800110418                If %error ;
014900110418                   iter;
015000110418                endif ;
015100110418        // aggiorna il flo
015200110418                If %Found(Tiatc01l);
015300110418                   atcflo = datc01 ;
015400110418                   update tiatc000 ;
015500110418                Endif ;
015600110418             Endif ;
015700110415
015800110415         Enddo ;
015900110415
016000110415       ENDSR ;
016100110415       //--------------------------------------------------------------
016200110415       //?Operazioni finali.
016300110415       //--------------------------------------------------------------
016400110415       BEGSR RoutEnd;
016500110415
016600110415         *inLR = *on;
016700110415         return;
016800110415
016900110415       ENDSR;
017000110415
017100110415      /end-free
