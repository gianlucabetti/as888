000100110415      //--------------------------------------------------------------
000200110415      //?Trmk09r  - Aggiorna Categoria Potenziale in TIATC
000300110415      //?         - nel FLO dei file
000400110415      //--------------------------------------------------------------
000500110415
000600110415     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000700110415     h dftactgrp(*no) actgrp(*caller)
000800110415
000900110415      //---------------------------------------------------------------
001000110415      //?Dichiarazione file.
001100110415      //---------------------------------------------------------------
001200110415     fTNCPO01L  if   e           k disk
001300110415     fTIATC04L  uf   e           k disk
001400110415
001500110415      //---------------------------------------------------------------
001600110415      //?Definizione costanti.
001700110415      //---------------------------------------------------------------
001800110415
001900110415      //---------------------------------------------------------------
002000110415      //?Definizione schiere.
002100110415      //---------------------------------------------------------------
002200110415
002300110415      //---------------------------------------------------------------
002400110415      //?Definizione aree dati.
002500110415      //---------------------------------------------------------------
002600110415
002700110415      // - Dati utente
002800110415     d §AzUte        e ds                  extname(AZUTE00F)
002900110415     d                                     dtaara
003000110415     d §DatiUte      e ds                  extname(dDatiUte)
003100110415     d                                     dtaara
003200110415
003300110415      //---------------------------------------------------------------
003400110415      //?Definizione strutture dati.
003500110415      //---------------------------------------------------------------
003600110415
003700110415      // - Parametri ricevuti
003800110415     d KPJBA         e ds
003900110415
004000110415      // - Flag operativi tiatc
004100110415     d datc01        e ds                  inz
004200110415
004300110415      // - Flag operativi tivis
004400110415     d dvis01        e ds                  inz
004500110415
004600110415
004700110415      //---------------------------------------------------------------
004800110415      //?Definizione variabili globali.
004900110415      //---------------------------------------------------------------
005000110415
005100110415      // - Flags booleani
005200110415     d $End            s               n   inz(*off)
005300110415
005400110415      // - Indici di schiera
005500110415
005600110415      // - Campi di comodo
005700110415     d w_cpo           s             11  0 inz
005800110415
005900110415      //---------------------------------------------------------------
006000110415      //?Definizione procedure esterne.
006100110415      //---------------------------------------------------------------
006200110415
006300110415
006400110415      //---------------------------------------------------------------
006500110415      //?prototipi
006600110415      //---------------------------------------------------------------
006700110415
006800110415      //---------------------------------------------------------------
006900110415      //?Definizione key-list.
007000110415      //---------------------------------------------------------------
007100110415
007200110415      //---------------------------------------------------------------
007300110415      //?Riepilogo indicatori.
007400110415      //---------------------------------------------------------------
007500110415
007600110415      //---------------------------------------------------------------
007700110415
007800110415      //---------------------------------------------------------------
007900110415      //?M A I N - L I N E
008000110415      //---------------------------------------------------------------
008100110415
008200110415     c     *Entry        plist
008300110415     c                   parm                    KPJBA
008400110415
008500110415      /free
008600110415
008700110415       //?Elaborazione attività / Visite
008800110415       exsr Sr_Aggiorna ;
008900110415
009000110415       //?Operazioni finali
009100110415       exsr RoutEnd;
009200110415
009300110415       //--------------------------------------------------------------
009400110415       //?Aggiornamento archivi Tiatc Tivis
009500110415       //--------------------------------------------------------------
009600110415       BEGSR Sr_aggiorna ;
009700110415
009800110415       // Imposto uno alla chiave perchè voglio evitare di leggere tutte
009900110415       // le attività non legate ai potenziali
010000110415         W_cpo = 1 ;
010100110415         setll W_cpo tiatc04l ;
010200110415         Dow not $end ;
010300110415             read(e) tiatc04l ;
010400110415        // se record impegnato leggo il successivo
010500110415             If %error ;
010600110415                iter;
010700110415             endif ;
010800110415             If %eof(tiatc04l) ;
010900110415                leave ;
011000110415             Endif ;
011100110415             If atccpo = 0 ;
011200110415                iter ;
011300110415             Endif ;
011400110415        // elaboro i soli record attività ancora da eseguire oppure eseguiti dal 11/Aprile/2011
011500110415             If atcdco > 0  and atcdco < 20110411 ;
011600110415                iter ;
011700110415             Endif ;
011800110415
011900110415             If W_cpo <> atccpo  ;
012000110415                W_cpo = atccpo   ;
012100110415       // a rottura di codice aggancio il file TNCPO per recuperare l'attuale
012200110415       // categoria da aggiornare sui files
012300110415                chain atccpo tncpo01l ;
012400110415                If not %found(tncpo01l) ;
012500110415       // Se non trovo il potenziale mi posizione sulle attività del potenmziale successivo
012600110415                   setgt W_cpo tiatc04l ;
012700110415                   Clear W_cpo ;
012800110415                   iter ;
012900110415                endif ;
013000110415             endif ;
013100110415             datc01 = atcflo ;
013200110415       // verifico se 1° categoria potenziale è blank e causale da fare valorizzata
013300110415       // valorizzo la categoria
013400110415             If §atccapo1 = ' ' and atccad <> '  ' ;
013500110415                §atccapo1 = cpofls ;
013600110415             Endif ;
013700110415
013800110415       // verifico se 2° categoria potenziale è blank e causale esecuzione valorizzata
013900110415       // valorizzo la categoria
014000110415             If §atccapo2 = ' ' and atccac <> '  ' ;
014100110415                §atccapo2 = cpofls ;
014200110415             Endif ;
014300110415
014400110415             atcflo = datc01 ;
014500110415             update tiatc000 ;
014600110415
014700110415         Enddo ;
014800110415
014900110415       ENDSR ;
015000110415       //--------------------------------------------------------------
015100110415       //?Operazioni finali.
015200110415       //--------------------------------------------------------------
015300110415       BEGSR RoutEnd;
015400110415
015500110415         *inLR = *on;
015600110415         return;
015700110415
015800110415       ENDSR;
015900110415
016000110415      /end-free
