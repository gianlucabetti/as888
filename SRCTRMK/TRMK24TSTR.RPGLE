000100100806       //--------------------------------------------------------------
000200100806       //?TEST - PREPARA E-MAIL DI CONFERMA APPUNTAMENTO               ?
000300100806       //--------------------------------------------------------------
000400100806
000500100806     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600100806     h dftactgrp(*no) actgrp('QILE')
000700100806
000800100806       //--------------------------------------------------------------
000900100806       //?Dichiarazione file.                                          ?
001000100806       //--------------------------------------------------------------
001100100806
001200100806       // -?Video?
001300100806     fTRMK24TSTDcf   e             workstn
001400100806     f                                     indds(IndDspF)
001500100806     f                                     infds(InfDspF)
001600100806
001700100806       //--------------------------------------------------------------
001800100806       //?Definizione costanti.                                        ?
001900100806       //--------------------------------------------------------------
002000100806
002100100806       // -?Tasti funzionali a video?
002200100806     d c_F01           c                   const(x'31')
002300100806     d c_F02           c                   const(x'32')
002400100806     d c_F03           c                   const(x'33')
002500100806     d c_F04           c                   const(x'34')
002600100806     d c_F05           c                   const(x'35')
002700100806     d c_F06           c                   const(x'36')
002800100806     d c_F07           c                   const(x'37')
002900100806     d c_F08           c                   const(x'38')
003000100806     d c_F09           c                   const(x'39')
003100100806     d c_F10           c                   const(x'3A')
003200100806     d c_F11           c                   const(x'3B')
003300100806     d c_F12           c                   const(x'3C')
003400100806     d c_F13           c                   const(x'B1')
003500100806     d c_F14           c                   const(x'B2')
003600100806     d c_F15           c                   const(x'B3')
003700100806     d c_F16           c                   const(x'B4')
003800100806     d c_F17           c                   const(x'B5')
003900100806     d c_F18           c                   const(x'B6')
004000100806     d c_F19           c                   const(x'B7')
004100100806     d c_F20           c                   const(x'B8')
004200100806     d c_F21           c                   const(x'B9')
004300100806     d c_F22           c                   const(x'BA')
004400100806     d c_F23           c                   const(x'BB')
004500100806     d c_F24           c                   const(x'BC')
004600100806     d c_Enter         c                   const(x'F1')
004700100806     d c_RollDown      c                   const(x'F4')
004800100806     d c_RollUp        c                   const(x'F5')
004900100806
005000100806       //--------------------------------------------------------------
005100100806       //?Definizione schiere.                                         ?
005200100806       //--------------------------------------------------------------
005300100806
005400100806
005500100806       //--------------------------------------------------------------
005600100806       //?Definizione aree dati.                                       ?
005700100806       //--------------------------------------------------------------
005800100806
005900100806       // -?Dati utente?
006000100806     d §AzUte        e ds                  extname(AZUTE00F)
006100100806     d                                     dtaara
006200100806     d §DatiUte      e ds                  extname(dDatiUte)
006300100806     d                                     dtaara
006400100806
006500100806       //--------------------------------------------------------------
006600100806       //?Definizione strutture dati.                                  ?
006700100806       //--------------------------------------------------------------
006800100806
006900100806       // -?Status ds?
007000100806     d Status         sds
007100100806     d   SDSpgm          *proc
007200100806     d   SDSprm          *parms
007300100806     d   SDSusr              254    263
007400100806
007500100806       // -?InfDS?
007600100806     d InfDspF         ds
007700100806     d   dsp_aid             369    369a
007800100806
007900100806       // -?Indicatori su DspF?
008000100806     d IndDspF         ds
008100100806         // -?Indicatori di errore?
008200100806     d   ErrMessage                    n   overlay(IndDspF : 28)
008300100806     d   ErrGenerico                   n   overlay(IndDspF : 99)
008400100806
008500100806       // -?Parametri ricevuti?
008600100806     d KPJBA         e ds
008700100806
008800100806       // -?Parametri x Controllo profilo utenti?
008900100806     d TIBS34ds      e ds
009000100806
009100100806       // -?Dati da stampare?
009200100806     d TRMK24ds      e ds                  inz
009300100806
009400100806       //--------------------------------------------------------------
009500100806       //?Definizione variabili globali.                               ?
009600100806       //--------------------------------------------------------------
009700100806
009800100806       // -?Flags booleani?
009900100806     d $Fine           s               n   inz(*off)
010000100806     d $InzD01         s               n   inz(*on)
010100100806
010200100806       //--------------------------------------------------------------
010300100806       //?Definizione procedure usate.                                 ?
010400100806       //--------------------------------------------------------------
010500100806
010600100806       // -?Reperimento dati utente?
010700100806     d tibs34r         pr                  extpgm('TIBS34R')
010800100806     d   tibs34ds                          likeds(TIBS34ds)
010900100806
011000100806       // -?Stampa e-mail?
011100100806     d trmk24r         pr                  extpgm('TRMK24R')
011200100806     d   kpjba                             likeds(KPJBA)
011300100806     d   trmk24ds                          likeds(TRMK24ds)
011400100806
011500100806       //--------------------------------------------------------------
011600100806       //?Definizione key-list.                                        ?
011700100806       //--------------------------------------------------------------
011800100806
011900100806
012000100806       //--------------------------------------------------------------
012100100806       //?MAIN-LINE.                                                   ?
012200100806       //--------------------------------------------------------------
012300100806
012400100806     c     *Entry        plist
012500100806     c                   parm                    KPJBA
012600100806
012700100806      /free
012800100806
012900100806       // -?Start?
013000100806       *inLR = *on;
013100100806
013200100806       // -?Elab?
013300100806       dow  $Fine = *off;
013400100806         exsr sr_GesD01;
013500100806       enddo;
013600100806
013700100806       // -?End?
013800100806       return;
013900100806
014000100806       //--------------------------------------------------------------
014100100806       //?Operazioni iniziali                                          ?
014200100806       //--------------------------------------------------------------
014300100806       BEGSR  *InzSR;
014400100806
014500100806         // -?Reperimento dati utente?
014600100806         exsr sr_DatiJob;
014700100806
014800100806         // -?Impostazione nome programma in testata a video?
014900100806         VTDpgm = SDSpgm;
015000100806
015100100806       ENDSR;
015200100806
015300100806       //--------------------------------------------------------------
015400100806       //?Reperimento Dati del job (Utente/Operativi).                 ?
015500100806       //--------------------------------------------------------------
015600100806       BEGSR  sr_DatiJob;
015700100806
015800100806         in(E) §AzUte;
015900100806         if NOT %error;
016000100806           in(E) §DatiUte;
016100100806         endif;
016200100806         if %error or RSut = *blanks;
016300100806           clear TIBS34ds;
016400100806           tibs34r(tibs34ds);
016500100806           in §AzUte;
016600100806           in §DatiUte;
016700100806         endif;
016800100806
016900100806       ENDSR;
017000100806
017100100806       //--------------------------------------------------------------
017200100806       //?Gestione videata D01                                         ?
017300100806       //--------------------------------------------------------------
017400100806       BEGSR  sr_GesD01;
017500100806
017600100806         // -?Inizializzazione videata?
017700100806         if  $InzD01 = *on;
017800100806           clear  TRMK24ds;
017900100806           $InzD01  = *off;
018000100806         endif;
018100100806
018200100806         // -?Emissione videata?
018300100806         if  ErrMessage = *off;
018400100806           write  MK24T01;
018500100806           write  MK24Z01;
018600100806         endif;
018700100806
018800100806         exfmt  MK24D01;
018900100806
019000100806         reset  ErrMessage;
019100100806         reset  ErrGenerico;
019200100806         clear  V1Dmsg;
019300100806
019400100806         SELECT;
019500100806
019600100806           // -?F3=Fine?
019700100806           WHEN  dsp_aid = c_F03;
019800100806             $Fine = *on;
019900100806
020000100806           // -?Invio o F6=Conferma?
020100100806           OTHER;
020200100806             exsr  sr_CtrD01;
020300100806             select;
020400100806               // -?rilevato errore?
020500100806               when  ErrGenerico = *on;
020600100806               // -?non premuto F6?
020700100806               when  dsp_aid <> c_F06;
020800100806               // -?invio e-mail?
020900100806               other;
021000100806                 exsr  Call_TRMK24R;
021100100806                 //reset  $InzD01;
021200100806             endsl;
021300100806
021400100806         ENDSL;
021500100806
021600100806       ENDSR;
021700100806
021800100806       //--------------------------------------------------------------
021900100806       //?Richiamo *pgm per invio e-mail con materiale illustrativo    ?
022000100806       //--------------------------------------------------------------
022100100806       BEGSR  Call_TRMK24R;
022200100806
022300100806         Imk24rst = D01rst1 + D01rst2;
022400100806         Imk24mai = D01mai1 + D01mai2;
022500100908
022600100806         trmk24r ( kpjba : TRMK24ds );
022700100908
022800100908         D02mai1  = %subst( Omk24mai : 1 : %len( D02mai1 ) );
022900100908         D02mai2  = %subst( Omk24mai : %len( D02mai1 ) + 1 );
023000100908         D02rst1  = %subst( Omk24rst : 1 : %len( D02rst1 ) );
023100100908         D02rst2  = %subst( Omk24rst : %len( D02rst1 ) + 1 );
023200100806
023300100915         D02sep   = *all'=';
023400100915
023500100806         write  Protect;
023600100806         exfmt  MK24D02;
023700100806
023800100806         // -?F3=Fine?
023900100806         if  dsp_aid = c_F03;
024000100806           $Fine = *on;
024100100806           leavesr;
024200100806         endif;
024300100806
024400100806       ENDSR;
024500100806
024600100806       //--------------------------------------------------------------
024700100806       //?Controllo dati in videata D01                                ?
024800100806       //--------------------------------------------------------------
024900100806       BEGSR  sr_CtrD01;
025000100806
025100100806         %subst( IndDspF : 50 ) = *off;
025200100806
025300100806       ENDSR;
025400100806
025500100806      /end-free
