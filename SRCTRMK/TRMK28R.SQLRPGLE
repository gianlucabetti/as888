000100090708      //---------------------------------------------------------------
000200100407      //?TRMK28R - Sistema potenziale se variato sul cliente
000300090708      //---------------------------------------------------------------
000400090708
000500090708     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600090708
000700090708      //---------------------------------------------------------------
000800090708      //?Dichiarazione file.
000900090708      //---------------------------------------------------------------
001000100407     fTFACO00F  uf   e           k disk
001100100407     fTIATC04L  uf   e           k disk
001200100407     fTIVIS05L  uf   e           k disk    rename(TIVIS000:TIVIS05)
001300100407     f                                     prefix(w_)
001400110217     fTNCPO01L  uf   e           k disk
001500090708
001600090708      //---------------------------------------------------------------
001700090511      //?Definizione costanti.
001800090511      //---------------------------------------------------------------
001900090511
002000090511      //---------------------------------------------------------------
002100090511      //?Definizione schiere.
002200090511      //---------------------------------------------------------------
002300090708
002400090708      // - Messaggi di errore
002500090708     d $Msg            s             78    dim(10) ctdata perrcd(1)
002600090721
002700090511      //---------------------------------------------------------------
002800090511      //?Definizione aree dati.
002900090511      //---------------------------------------------------------------
003000090511
003100090511      //---------------------------------------------------------------
003200090511      //?Definizione strutture dati.
003300090511      //---------------------------------------------------------------
003400090708
003500090708      // - Parametri ricevuti
003600100407     d TRMK28DS      e ds
003700100407
003800100407      // File trattative
003900100407     d tivis00f      e ds                  extname(TIVIS00F)
004000110217
004100110217     d kpjba         e ds
004200110217
004300110217      // Calcolo categoria potenziale
004400110217     d Trmk05ds      e ds
004500090511
004600090511      //---------------------------------------------------------------
004700090511      //?Definizione variabili globali.
004800090511      //---------------------------------------------------------------
004900090708
005000090708      // - Flags booleani
005100091009     d $Fine           s               n   inz(*off)
005200090708
005300090708      // - Campi di comodo
005400090511
005500090511      //---------------------------------------------------------------
005600090511      //?Definizione procedure esterne.
005700090511      //---------------------------------------------------------------
005800110217
005900110217      // - Calcolo categoria potenziale
006000110217     d trmk05r         pr                  extpgm('TRMK05R')
006100110217     d  kpjba                              likeds(KPJBA)
006200110217     d  trmk05ds                           likeds(TRMK05ds)
006300090708
006400090511      //---------------------------------------------------------------
006500090511      //?Definizione key-list.
006600090511      //---------------------------------------------------------------
006700090708
006800090708      //---------------------------------------------------------------
006900090708      //?Riepilogo indicatori.
007000090708      //---------------------------------------------------------------
007100090511
007200090511      //---------------------------------------------------------------
007300090708      //?M A I N - L I N E
007400090511      //---------------------------------------------------------------
007500090708
007600090708     c     *Entry        plist
007700100407     c                   parm                    trmk28ds
007800090708
007900090708      /free
008000090708
008100090708       //?Operazioni iniziali
008200090708       exsr sr_RoutInz;
008300091007
008400091007       //?Controllo dati passati
008500091007       exsr sr_CtrDati;
008600091007
008700100407       //?Aggiorno i file necessari
008800100407       IF  OMK28err = *blanks;
008900100407         exsr sr_Aggiorna;
009000091007       ENDIF;
009100090708
009200090708       //?Operazioni finali
009300090708       exsr sr_RoutEnd;
009400090708
009500090708       //--------------------------------------------------------------
009600090708       //?Operazioni iniziali.
009700090708       //--------------------------------------------------------------
009800090708       BEGSR sr_RoutInz;
009900090708
010000100407         clear OMK28err;
010100100407         clear OMK28msg;
010200091009
010300090708         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
010400090708
010500090708       ENDSR;
010600090805
010700090805       //--------------------------------------------------------------
010800091007       //?Controllo dati passati.
010900090805       //--------------------------------------------------------------
011000091007       BEGSR sr_CtrDati;
011100090810
011200100407         IF  IMK28cpo = 0 or IMK28cpoex = 0 or IMK28ksc = 0;
011300100407           OMK28err = '9';
011400100407           OMK28msg = $msg(01);
011500091009           leavesr;
011600090810         ENDIF;
011700090805
011800090805       ENDSR;
011900091007
012000091007       //--------------------------------------------------------------
012100100407       //?Aggiorna i file necessari.
012200091007       //--------------------------------------------------------------
012300100407       BEGSR sr_Aggiorna;
012400110217
012500110217       //?Calcolo la categoria del potenziale OLD e aggiorno
012600110217         clear trmk05ds;
012700110217         IMK05cpo = IMK28cpoex;
012800110217         trmk05r (kpjba : TRMK05DS);
012900110927         IF  OMK05err = *blanks;
013000110927           chain(e) IMK05cpo TNCPO01L;
013100110223           IF  not %error and %found(TNCPO01L);
013200110223             CPOfls = OMK05cat;
013300110223             update TNCPO000;
013400110223           ENDIF;
013500110217         ENDIF;
013600110223       //?Calcolo la categoria del potenziale NEW e aggiorno
013700110223         clear trmk05ds;
013800110223         IMK05cpo = IMK28cpo;
013900110223         trmk05r (kpjba : TRMK05DS);
014000110927         IF  OMK05err = *blanks;
014100110927           chain(e) IMK05cpo TNCPO01L;
014200110223           IF  not %error and %found(TNCPO01L);
014300110223             CPOfls = OMK05cat;
014400110223             update TNCPO000;
014500110223           ENDIF;
014600110223         ENDIF;
014700091008
014800100407         //?controllo se c'è una trattativa aperte sul potenziale OLD
014900100407         exec sql
015000100407         declare TIVIS cursor for
015100100407         select visnrv from
015200100407         TIVIS00F where viscpo = :IMK28cpoex and visdch = 0;
015300091009
015400100407           exec sql open TIVIS;
015500091009
015600091009           DOW  not $Fine;
015700100407             exec sql fetch next from TIVIS into :visnrv;
015800100407
015900091009             IF  sqlcod = 100 or sqlcod < 0;
016000091009               $Fine = *on;
016100091009               leave;
016200091009             ENDIF;
016300091014
016400100407             //?Aggancio TIVIS05L e aggiorno potenziale
016500100407             chain visnrv TIVIS05L;
016600100407             IF  %found(TIVIS05L);
016700100407               w_viscpo = IMK28cpo;
016800100407               update TIVIS05;
016900091014             ENDIF;
017000100407
017100100407             //?Aggancio TFACO00F e aggiorno potenziale
017200100407             acokut = 1;
017300100407             acokcc = 151;
017400100407             chain (acokut : acokcc : visnrv) TFACO00F;
017500100407             IF  %found(TFACO00F);
017600100407               acolib = IMK28cpo;
017700100407               update CNACO000;
017800100407             ENDIF;
017900100407
018000100407             //?Aggancio TIATC00F e aggiorno potenziale
018100100407             setll (IMK28cpoex : IMK28ksc : visnrv) TIATC04L;
018200100407             reade (IMK28cpoex : IMK28ksc : visnrv) TIATC04L;
018300100407             DOW  not %eof(TIATC04L);
018400100407               IF  ATCdco = 0;
018500100407                 atccpo = IMK28cpo;
018600100407                 update TIATC000;
018700100407               ENDIF;
018800100407               reade (IMK28cpoex : IMK28ksc : visnrv) TIATC04L;
018900100407             ENDDO;
019000091014
019100091009           ENDDO;
019200091009
019300100407           exec sql close TIVIS;
019400091007
019500091007       ENDSR;
019600090708
019700090708       //--------------------------------------------------------------
019800090708       //?Operazioni finali.
019900090708       //--------------------------------------------------------------
020000090708       BEGSR sr_RoutEnd;
020100090708
020200090708         *inLR = *on;
020300090708         return;
020400090708
020500090708       ENDSR;
020600090708
020700090708      /end-free
020800090708
020900090708       //--------------------------------------------------------------
021000090708       //?Schiere a tempo di compilazione.
021100090708       //--------------------------------------------------------------
021200090708
021300090708** - $MSG -------------------------------------------------------------------*
021400091014Dati non passati                                                              01
