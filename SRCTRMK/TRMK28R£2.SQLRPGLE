000100090708      //---------------------------------------------------------------
000200100407      //?TRMK28R - Sistema potenziale se variato sul cliente
000300090708      //---------------------------------------------------------------
000400090708
000500090708     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600090708
000700090708      //---------------------------------------------------------------
000800090708      //?Dichiarazione file.
000900090708      //---------------------------------------------------------------
001000100407     fTFACO00F  uf   e           k disk
001100100407     fTIATC04L  uf   e           k disk
001200100407     fTIVIS05L  uf   e           k disk    rename(TIVIS000:TIVIS05)
001300100407     f                                     prefix(w_)
001400090708
001500090708      //---------------------------------------------------------------
001600090511      //?Definizione costanti.
001700090511      //---------------------------------------------------------------
001800090511
001900090511      //---------------------------------------------------------------
002000090511      //?Definizione schiere.
002100090511      //---------------------------------------------------------------
002200090708
002300090708      // - Messaggi di errore
002400090708     d $Msg            s             78    dim(10) ctdata perrcd(1)
002500090721
002600090511      //---------------------------------------------------------------
002700090511      //?Definizione aree dati.
002800090511      //---------------------------------------------------------------
002900090511
003000090511      //---------------------------------------------------------------
003100090511      //?Definizione strutture dati.
003200090511      //---------------------------------------------------------------
003300090708
003400090708      // - Parametri ricevuti
003500100407     d TRMK28DS      e ds
003600100407
003700100407      // File trattative
003800100407     d tivis00f      e ds                  extname(TIVIS00F)
003900090511
004000090511      //---------------------------------------------------------------
004100090511      //?Definizione variabili globali.
004200090511      //---------------------------------------------------------------
004300090708
004400090708      // - Flags booleani
004500091009     d $Fine           s               n   inz(*off)
004600090708
004700090708      // - Campi di comodo
004800090511
004900090511      //---------------------------------------------------------------
005000090511      //?Definizione procedure esterne.
005100090511      //---------------------------------------------------------------
005200090708
005300090511      //---------------------------------------------------------------
005400090511      //?Definizione key-list.
005500090511      //---------------------------------------------------------------
005600090708
005700090708      //---------------------------------------------------------------
005800090708      //?Riepilogo indicatori.
005900090708      //---------------------------------------------------------------
006000090511
006100090511      //---------------------------------------------------------------
006200090708      //?M A I N - L I N E
006300090511      //---------------------------------------------------------------
006400090708
006500090708     c     *Entry        plist
006600100407     c                   parm                    trmk28ds
006700090708
006800090708      /free
006900090708
007000090708       //?Operazioni iniziali
007100090708       exsr sr_RoutInz;
007200091007
007300091007       //?Controllo dati passati
007400091007       exsr sr_CtrDati;
007500091007
007600100407       //?Aggiorno i file necessari
007700100407       IF  OMK28err = *blanks;
007800100407         exsr sr_Aggiorna;
007900091007       ENDIF;
008000090708
008100090708       //?Operazioni finali
008200090708       exsr sr_RoutEnd;
008300090708
008400090708       //--------------------------------------------------------------
008500090708       //?Operazioni iniziali.
008600090708       //--------------------------------------------------------------
008700090708       BEGSR sr_RoutInz;
008800090708
008900100407         clear OMK28err;
009000100407         clear OMK28msg;
009100091009
009200090708         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
009300090708
009400090708       ENDSR;
009500090805
009600090805       //--------------------------------------------------------------
009700091007       //?Controllo dati passati.
009800090805       //--------------------------------------------------------------
009900091007       BEGSR sr_CtrDati;
010000090810
010100100407         IF  IMK28cpo = 0 or IMK28cpoex = 0 or IMK28ksc = 0;
010200100407           OMK28err = '9';
010300100407           OMK28msg = $msg(01);
010400091009           leavesr;
010500090810         ENDIF;
010600090805
010700090805       ENDSR;
010800091007
010900091007       //--------------------------------------------------------------
011000100407       //?Aggiorna i file necessari.
011100091007       //--------------------------------------------------------------
011200100407       BEGSR sr_Aggiorna;
011300091008
011400100407         //?controllo se c'è una trattativa aperte sul potenziale OLD
011500100407         exec sql
011600100407         declare TIVIS cursor for
011700100407         select visnrv from
011800100407         TIVIS00F where viscpo = :IMK28cpoex and visdch = 0;
011900091009
012000100407           exec sql open TIVIS;
012100091009
012200091009           DOW  not $Fine;
012300100407             exec sql fetch next from TIVIS into :visnrv;
012400100407
012500091009             IF  sqlcod = 100 or sqlcod < 0;
012600091009               $Fine = *on;
012700091009               leave;
012800091009             ENDIF;
012900091014
013000100407             //?Aggancio TIVIS05L e aggiorno potenziale
013100100407             chain visnrv TIVIS05L;
013200100407             IF  %found(TIVIS05L);
013300100407               w_viscpo = IMK28cpo;
013400100407               update TIVIS05;
013500091014             ENDIF;
013600100407
013700100407             //?Aggancio TFACO00F e aggiorno potenziale
013800100407             acokut = 1;
013900100407             acokcc = 151;
014000100407             chain (acokut : acokcc : visnrv) TFACO00F;
014100100407             IF  %found(TFACO00F);
014200100407               acolib = IMK28cpo;
014300100407               update CNACO000;
014400100407             ENDIF;
014500100407
014600100407             //?Aggancio TIATC00F e aggiorno potenziale
014700100407             setll (IMK28cpoex : IMK28ksc : visnrv) TIATC04L;
014800100407             reade (IMK28cpoex : IMK28ksc : visnrv) TIATC04L;
014900100407             DOW  not %eof(TIATC04L);
015000100407               IF  ATCdco = 0;
015100100407                 atccpo = IMK28cpo;
015200100407                 update TIATC000;
015300100407               ENDIF;
015400100407               reade (IMK28cpoex : IMK28ksc : visnrv) TIATC04L;
015500100407             ENDDO;
015600091014
015700091009           ENDDO;
015800091009
015900100407           exec sql close TIVIS;
016000091007
016100091007       ENDSR;
016200090708
016300090708       //--------------------------------------------------------------
016400090708       //?Operazioni finali.
016500090708       //--------------------------------------------------------------
016600090708       BEGSR sr_RoutEnd;
016700090708
016800090708         *inLR = *on;
016900090708         return;
017000090708
017100090708       ENDSR;
017200090708
017300090708      /end-free
017400090708
017500090708       //--------------------------------------------------------------
017600090708       //?Schiere a tempo di compilazione.
017700090708       //--------------------------------------------------------------
017800090708
017900090708** - $MSG -------------------------------------------------------------------*
018000091014Dati non passati                                                              01
