000100100413      //---------------------------------------------------------------
000200110131      //?TRMK35R - Crea attività 70 su potenziali codificati
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000100415     fTIATC00F  o    e             disk
001100100413
001200100413      //---------------------------------------------------------------
001300100413      //?Definizione costanti.
001400100413      //---------------------------------------------------------------
001500100413
001600100413      //---------------------------------------------------------------
001700100413      //?Definizione schiere.
001800100413      //---------------------------------------------------------------
001900090715
002000100413      //---------------------------------------------------------------
002100100413      //?Definizione aree dati.
002200100413      //---------------------------------------------------------------
002300100413
002400100413      //---------------------------------------------------------------
002500100413      //?Definizione strutture dati.
002600100413      //---------------------------------------------------------------
002700100415
002800110131      // - Parametri ricevuti
002900100415     d KPJBA         e ds
003000110211
003100110211      // ds x ATCflo
003200110211     d dATC01        e ds
003300100726
003400100726      // File potenziali
003500100726     d TNCPOds       e ds                  extname(TNCPO00F)
003600110131
003700110131      // - Controllo se potenziale lavora
003800110131     d TRMK04ds      e ds                  inz
003900110329     d TRMK85ds      e ds                  inz
004000100415
004100100415      // - Ricerca ultimo numero attività
004200100415     d TRUL33ds      e ds                  inz
004300110131
004400110131      // - Aggiunge/Toglie gg/mm dalla data
004500110131     d XGIOLAVds     e ds                  inz
004600100415
004700100413      //---------------------------------------------------------------
004800100413      //?Definizione variabili globali.
004900100413      //---------------------------------------------------------------
005000100413
005100100413      // - Flags booleani
005200100413     d $End            s               n   inz(*off)
005300110131
005400110131      // - Campi di comodo
005500110426     d NrAtt           s              5i 0
005600110131     d wDad            s                   like(ATCdad)
005700110207     d wgg             s                   like(IXGLgg) inz(1)
005800100413
005900100413      //---------------------------------------------------------------
006000100413      //?Definizione procedure esterne.
006100100413      //---------------------------------------------------------------
006200110131
006300110131      // - Controllo se potenziale lavora
006400110131     d Trmk04R         pr                  extpgm('TRMK04R')
006500110131     d  KPJBA                              likeds(KPJBA)
006600110131     d  TRMK04ds                           likeds(TRMK04ds)
006700110329     d  TRMK85ds                           likeds(TRMK85ds) options(*nopass)
006800110131
006900110131      // - Aggiunge/Toglie gg/mm dalla data
007000110131     d Xgiolav         pr                  extpgm('XGIOLAV')
007100110131     d  xgiolavds                          likeds(xgiolavds)
007200100413
007300100413      //---------------------------------------------------------------
007400110131      //?Prototipi
007500100413      //---------------------------------------------------------------
007600100414
007700100415      /copy gaitrasrc/srcprotopr,trul33r
007800100413
007900100413      //---------------------------------------------------------------
008000100413      //?Definizione key-list.
008100100413      //---------------------------------------------------------------
008200100415
008300100413
008400100413      //---------------------------------------------------------------
008500100413      //?Riepilogo indicatori.
008600100413      //---------------------------------------------------------------
008700100413
008800100413      //---------------------------------------------------------------
008900100413      //?M A I N - L I N E
009000100413      //---------------------------------------------------------------
009100100413
009200100413     c     *Entry        plist
009300110131     c                   parm                    kpjba
009400100413
009500100413      /free
009600100413
009700100413       //?Operazioni iniziali
009800100513       exsr RoutInz;
009900100413
010000100726       //?Elaboro
010100100726       exsr Elabora;
010200100413
010300100413       //?Operazioni finali
010400100513       exsr RoutEnd;
010500100413
010600100413       //--------------------------------------------------------------
010700100413       //?Operazioni iniziali.
010800100413       //--------------------------------------------------------------
010900100513       BEGSR RoutInz;
011000100726
011100100726         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
011200100413
011300100413       ENDSR;
011400100413
011500100413       //--------------------------------------------------------------
011600110131       //?Elabora.
011700100413       //--------------------------------------------------------------
011800100513       BEGSR Elabora;
011900100413
012000100413         $End = *off;
012100100413
012200110131       //?Estraggo solo i potenziali codificati
012300100413         exec sql
012400100726         DECLARE CPO cursor for
012500110218         SELECT  CPOcpo, CPOfls, CPOflt
012600110131         FROM TNCPO00F
012700110201         WHERE CPOfls = 'C'
012800100726         ORDER by CPOcpo;
012900100413
013000100726         exec sql OPEN CPO;
013100100413
013200100413         DOW  not $End;
013300110218           exec sql FETCH next from CPO into :CPOCPO,
013400110211                                             :CPOFLS, :CPOFLT;
013500100413           IF  sqlcod = 100 or sqlcod < 0;
013600100413             $End = *on;
013700100413             leave;
013800100413           ENDIF;
013900100422
014000110131         //?Controllo se potenziale lavora o no
014100110131           clear TRMK04DS;
014200110131           IMK04cpo = CPOcpo;
014300110131           trmk04r (kpjba: TRMK04DS);
014400110131           IF  OMK04err <> *blanks;
014500110131             iter;
014600110131           ENDIF;
014700110426
014800110426         //?Controllo se il potenziale ha già un'attività 70/75 da eseguire
014900110426           clear NrAtt;
015000110426           exec sql
015100110426           select count(*) into :NrAtt from tiatc00f
015200110426           where atccpo = :CPOcpo and atcdco = 0 and atccad in('70', '75');
015300100726
015400110426         //?Se NON lavora creao attività 70, e se c'è il commerciale sul potenziale
015500110426         //?Ma solo se c'è il commerciale sul potenziale
015600110426         //?e se non c'è già un'attività 70/75 da eseguire
015700110426           IF  OMK04lav = 'NO' and OMK04cmm > 0 and NrAtt = 0;
015800100726             exsr Scrivi;
015900100726           ENDIF;
016000100413         ENDDO;
016100100413
016200100726         exec sql CLOSE CPO;
016300100413
016400100413       ENDSR;
016500100413
016600100413       //--------------------------------------------------------------
016700100726       //?Scrivo nuova attività.
016800100413       //--------------------------------------------------------------
016900100413       BEGSR Scrivi;
017000100422
017100100422         clear wDad;
017200100415
017300100726       //?Stacco nuovo numero attività
017400110131         exsr Stacca_Numero;
017500110131       //?Calcolo la data attività
017600110131         clear XGIOLAVDS;
017700110131         IXGLdata = %dec(%date());
017800110131         IXGLadd  = 'S';
017900110207         IXGLgg   = wgg;
018000110131         IXGLpa   = 'P';
018100110131         IXGLlav  = 'S';
018200110223         IXGLfil  = %dec(%subst(%editc(OMK04cmm:'X'):1:3):3:0);
018300110131         XGIOLAV (xgiolavds);
018400110131         IF  OXGLerr = *blanks;
018500110131           wDad = OXGLdata;
018600110131         ELSE;
018700110131           wDad = %dec(%date());
018800110131         ENDIF;
018900110131       //?Scrivo la nuova attività
019000110131         exsr Scrivi_TIATC;
019100100413
019200100413       ENDSR;
019300100415
019400100415       //--------------------------------------------------------------
019500100415       //?Stacco nuovo numero attività.
019600100415       //--------------------------------------------------------------
019700100415       BEGSR Stacca_Numero;
019800100415
019900100415         clear TRUL33ds;
020000100415         I33tla = 'L';
020100100415         I33ope = 0;
020200100415         I33cnu = 070;
020300100415         I33num = 1;
020400100415         I33aaa = *year;
020500100415         kpjbu  = TRUL33ds;
020600100415         trul33r (kpjba);
020700100415         TRUL33ds = kpjbu;
020800100415
020900100415       ENDSR;
021000100415
021100100415       //--------------------------------------------------------------
021200100415       //?Scrivo file TIATC.
021300100415       //--------------------------------------------------------------
021400100415       BEGSR Scrivi_TIATC;
021500100415
021600110211         clear dATC01;
021700100415         clear TIATC000;
021800110131         ATCtat  = 'T';
021900100415         ATCatn  = O33Nrf;
022000100415         ATCatnp = 1;
022100110131         ATCcpo  = CPOcpo;
022200110207         ATCksc  = OMK04ksc;
022300110131         ATCcad  = '70';
022400110131         ATCdad  = wDad;
022500100422         ATChda  = 103000;
022600110218         ATCcmm  = OMK04cmm;
022700110218         ATCco3  = OMK04cmm;
022800110131         ATCcnw = 'C';
022900100415         ATCdim  = %dec(%date());
023000100415         ATChim  = %dec(%time());
023100100415         ATCpri  = 'BATCH';
023200110211         §ATCcapo1 = CPOfls;
023300110211         ATCflo = dATC01;
023400100415         write TIATC000;
023500100415
023600100415       ENDSR;
023700100413
023800100413       //--------------------------------------------------------------
023900100413       //?Operazioni finali.
024000100413       //--------------------------------------------------------------
024100100513       BEGSR RoutEnd;
024200100413
024300100413         *inLR = *on;
024400100413         return;
024500100413
024600100413       ENDSR;
024700100413
024800100413      /end-free
