000100100413      //---------------------------------------------------------------
000200110203      //?TRMK37R - Crea attività 60 su potenziali mai codificati
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000100415     fTIATC00F  o    e             disk
001100110428     fTIATC05L  if   e           k disk    rename(TIATC000:TIATC05)
001200110803     fTIVIS01L  if   e           k disk
001300100413
001400100413      //---------------------------------------------------------------
001500100413      //?Definizione costanti.
001600100413      //---------------------------------------------------------------
001700100413
001800100413      //---------------------------------------------------------------
001900100413      //?Definizione schiere.
002000100413      //---------------------------------------------------------------
002100090715
002200100413      //---------------------------------------------------------------
002300100413      //?Definizione aree dati.
002400100413      //---------------------------------------------------------------
002500100413
002600100413      //---------------------------------------------------------------
002700100413      //?Definizione strutture dati.
002800100413      //---------------------------------------------------------------
002900100415
003000100415     d KPJBA         e ds
003100110211
003200110211      // ds x ATCflo
003300110211     d dATC01        e ds
003400100726
003500100726      // File potenziali
003600100726     d TNCPOds       e ds                  extname(TNCPO00F)
003700100415
003800100415      // - Ricerca ultimo numero attività
003900100415     d TRUL33ds      e ds                  inz
004000100422
004100110203      // - Aggiunge/Toglie gg/mm dalla data
004200110203     d XGIOLAVds     e ds                  inz
004300100415
004400100413      //---------------------------------------------------------------
004500100413      //?Definizione variabili globali.
004600100413      //---------------------------------------------------------------
004700100413
004800100413      // - Flags booleani
004900100413     d $End            s               n   inz(*off)
005000100413
005100100413      // - Campi di comodo
005200100726     d NrAtt           s              5i 0
005300100726     d NrVis           s              5i 0
005400100415     d wDad            s                   like(ATCdad)
005500110427     d wdata           s              8  0
005600110427     d wDate_ISO       s               d   datfmt(*iso)
005700110426     d wgg             s                   like(IXGLgg) inz(25)
005800110427     d wName_Of_Day    s             10    inz
005900110429
006000100413
006100100413      //---------------------------------------------------------------
006200100413      //?Definizione procedure esterne.
006300100413      //---------------------------------------------------------------
006400110203
006500110203      // - Aggiunge/Toglie gg/mm dalla data
006600110203     d Xgiolav         pr                  extpgm('XGIOLAV')
006700110203     d  xgiolavds                          likeds(xgiolavds)
006800100413
006900100413      //---------------------------------------------------------------
007000100413      //?prototipi
007100100413      //---------------------------------------------------------------
007200100414
007300100415      /copy gaitrasrc/srcprotopr,trul33r
007400100413
007500100413      //---------------------------------------------------------------
007600100413      //?Definizione key-list.
007700100413      //---------------------------------------------------------------
007800100413
007900100413      //---------------------------------------------------------------
008000100413      //?Riepilogo indicatori.
008100100413      //---------------------------------------------------------------
008200100413
008300100413      //---------------------------------------------------------------
008400100413      //?M A I N - L I N E
008500100413      //---------------------------------------------------------------
008600100413
008700100413     c     *Entry        plist
008800110203     c                   parm                    kpjba
008900100413
009000100413      /free
009100100413
009200100413       //?Operazioni iniziali
009300100513       exsr RoutInz;
009400110427
009500110427       //?Elaboro solo se è lunedì
009600110427       IF  %subst(wName_Of_Day:1:3) = 'Lun';
009700100413
009800110427         //?Elaboro
009900110427         exsr Elabora;
010000110427
010100110427       ENDIF;
010200100413
010300100413       //?Operazioni finali
010400100513       exsr RoutEnd;
010500100413
010600100413       //--------------------------------------------------------------
010700100413       //?Operazioni iniziali.
010800100413       //--------------------------------------------------------------
010900100513       BEGSR RoutInz;
011000100726
011100100726         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
011200110427
011300110427         wdata = %dec(%date());
011400110427         wDate_ISO = %date(wdata:*iso);
011500110427
011600110427       //?Recupero il nome del giorno
011700110427         clear wName_Of_Day;
011800110427         exec sql
011900110427         set :wName_Of_Day = dayname(:wDate_ISO);
012000110429
012100100413       ENDSR;
012200100413
012300100413       //--------------------------------------------------------------
012400100422       //?Elaboro.
012500100413       //--------------------------------------------------------------
012600100513       BEGSR Elabora;
012700100413
012800100413         $End = *off;
012900100413
013000100726       //?Estraggo solo i potenziali mai codificati
013100120919       //?con codice commerciale già impostato
013200120919       //?e già contatti
013300100413         exec sql
013400100726         DECLARE CPO cursor for
013500110211         SELECT  CPOcpo, CPOcmm, CPOfls, CPOflt
013600110428         FROM TNCPO01L
013700120919         WHERE CPOfls = 'M' and CPOcmm > 0 and
013800120919               substr(CPOrst, 13, 8) <> ' ' and
013900120919               substr(CPOrst, 13, 8) >  '00000000'
014000110203         ORDER by CPOcpo;
014100100413
014200100726         exec sql OPEN CPO;
014300100413
014400100413         DOW  not $End;
014500110211           exec sql FETCH next from CPO into :CPOCPO, :CPOCMM,
014600110211                                             :CPOFLS, :CPOFLT;
014700100413           IF  sqlcod = 100 or sqlcod < 0;
014800100413             $End = *on;
014900100413             leave;
015000100413           ENDIF;
015100100422
015200100726         //?Controllo se potenziale ha azioni o trattative aperte
015300110428           exsr CtrDati;
015400110203
015500110203         //?Scrivo nuova attività solo se NON trovo attività da eseguire o trattative aperte
015600120919           IF  NrAtt = 0 and NrVis = 0;
015700100726
015800110203           //?Genero nuova attività 60
015900110203             exsr Scrivi;
016000110203           ENDIF;
016100100726
016200100413         ENDDO;
016300100413
016400100726         exec sql CLOSE CPO;
016500100413
016600100413       ENDSR;
016700100726
016800100726       //--------------------------------------------------------------
016900110428       //?Controllo attività/trattative e stati.
017000100726       //--------------------------------------------------------------
017100110428       BEGSR CtrDati;
017200100726
017300100726         clear NrAtt;
017400100726         clear NrVis;
017500110426
017600110426       //?Controllo se ci sono attività da eseguire
017700110428         chain (CPOcpo:0:0) TIATC05L;
017800110428         IF  %found(TIATC05L);
017900110428           NrAtt = 1;
018000110428           leavesr;
018100110428         ENDIF;
018200110203
018300110203       //?Se non ho trovato attività controllo se il potenziale ha trattative aperte
018400110428         setll (CPOcpo:0) TIVIS01L;
018500110428         reade (CPOcpo:0) TIVIS01L;
018600110428         DOW not %eof(TIVIS01L);
018700110428           IF  VISffz = ' ';
018800110428             NrVis = 1;
018900110428             leavesr;
019000110428           ENDIF;
019100110428           reade (CPOcpo:0) TIVIS01L;
019200110428         ENDDO;
019300110422
019400110422       ENDSR;
019500100413
019600100413       //--------------------------------------------------------------
019700100726       //?Scrivo nuova attività.
019800100413       //--------------------------------------------------------------
019900100413       BEGSR Scrivi;
020000100422
020100100422         clear wDad;
020200100415
020300100726       //?Stacco nuovo numero attività
020400110203         exsr Stacca_Numero;
020500110203       //?Calcolo la data attività
020600110203         clear XGIOLAVDS;
020700110203         IXGLdata = %dec(%date());
020800110203         IXGLadd  = 'S';
020900110203         IXGLgg   = wgg;
021000110203         IXGLpa   = 'P';
021100110223         IXGLfil  = %dec(%subst(%editc(CPOcmm:'X'):1:3):3:0);
021200110203         XGIOLAV (xgiolavds);
021300110203         IF  OXGLerr = *blanks;
021400110203           wDad = OXGLdata;
021500110203         ELSE;
021600110203           wDad = %dec(%date());
021700110203         ENDIF;
021800110203
021900110203       //?Scrivo la nuova attività
022000110203         exsr Scrivi_TIATC;
022100100413
022200100413       ENDSR;
022300100415
022400100415       //--------------------------------------------------------------
022500100415       //?Stacco nuovo numero attività.
022600100415       //--------------------------------------------------------------
022700100415       BEGSR Stacca_Numero;
022800100415
022900100415         clear TRUL33ds;
023000100415         I33tla = 'L';
023100100415         I33ope = 0;
023200100415         I33cnu = 070;
023300100415         I33num = 1;
023400100415         I33aaa = *year;
023500100415         kpjbu  = TRUL33ds;
023600100415         trul33r (kpjba);
023700100415         TRUL33ds = kpjbu;
023800100415
023900100415       ENDSR;
024000100415
024100100415       //--------------------------------------------------------------
024200100415       //?Scrivo file TIATC.
024300100415       //--------------------------------------------------------------
024400100415       BEGSR Scrivi_TIATC;
024500110203
024600110211         clear dATC01;
024700110203         clear TIATC000;
024800110203         ATCtat  = 'T';
024900110203         ATCatn  = O33Nrf;
025000110203         ATCatnp = 1;
025100110203         ATCcpo  = CPOcpo;
025200110203         ATCcad  = '60';
025300110203         ATCdad  = wDad;
025400110203         ATChda  = 103000;
025500110203         ATCcmm  = CPOcmm;
025600110203         ATCco3  = CPOcmm;
025700110203         ATCcnw = 'P';
025800110203         ATCdim  = %dec(%date());
025900110203         ATChim  = %dec(%time());
026000110203         ATCpri  = 'BATCH';
026100110211         §ATCcapo1 = CPOfls;
026200110211         ATCflo = dATC01;
026300110203         write TIATC000;
026400100415
026500100415       ENDSR;
026600100414
026700100413       //--------------------------------------------------------------
026800100413       //?Operazioni finali.
026900100413       //--------------------------------------------------------------
027000100513       BEGSR RoutEnd;
027100100413
027200100413         *inLR = *on;
027300100413         return;
027400100413
027500100413       ENDSR;
027600100413
027700100413      /end-free
