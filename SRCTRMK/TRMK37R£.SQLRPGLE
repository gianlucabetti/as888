000100100413      //---------------------------------------------------------------
000200110203      //?TRMK37R - Crea attività 60 su potenziali mai codificati
000300100413      //---------------------------------------------------------------
000400100413
000500100413     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600100413
000700100413      //---------------------------------------------------------------
000800100413      //?Dichiarazione file.
000900100413      //---------------------------------------------------------------
001000100415     fTIATC00F  o    e             disk
001100110428     fTIATC05L  if   e           k disk    rename(TIATC000:TIATC05)
001200110428     fTICPS01L  if   e           k disk
001300110803     fTIVIS01L  if   e           k disk
001400100413
001500100413      //---------------------------------------------------------------
001600100413      //?Definizione costanti.
001700100413      //---------------------------------------------------------------
001800100413
001900100413      //---------------------------------------------------------------
002000100413      //?Definizione schiere.
002100100413      //---------------------------------------------------------------
002200090715
002300100413      //---------------------------------------------------------------
002400100413      //?Definizione aree dati.
002500100413      //---------------------------------------------------------------
002600100413
002700100413      //---------------------------------------------------------------
002800100413      //?Definizione strutture dati.
002900100413      //---------------------------------------------------------------
003000100415
003100100415     d KPJBA         e ds
003200110211
003300110211      // ds x ATCflo
003400110211     d dATC01        e ds
003500100726
003600100726      // File potenziali
003700100726     d TNCPOds       e ds                  extname(TNCPO00F)
003800100415
003900100415      // - Ricerca ultimo numero attività
004000100415     d TRUL33ds      e ds                  inz
004100100422
004200110203      // - Aggiunge/Toglie gg/mm dalla data
004300110203     d XGIOLAVds     e ds                  inz
004400100415
004500100413      //---------------------------------------------------------------
004600100413      //?Definizione variabili globali.
004700100413      //---------------------------------------------------------------
004800100413
004900100413      // - Flags booleani
005000100413     d $End            s               n   inz(*off)
005100100413
005200100413      // - Campi di comodo
005300100726     d NrAtt           s              5i 0
005400110422     d NrCps           s              5i 0
005500100726     d NrVis           s              5i 0
005600100415     d wDad            s                   like(ATCdad)
005700110427     d wdata           s              8  0
005800110427     d wDate_ISO       s               d   datfmt(*iso)
005900110426     d wgg             s                   like(IXGLgg) inz(25)
006000110427     d wName_Of_Day    s             10    inz
006100110429
006200100413
006300100413      //---------------------------------------------------------------
006400100413      //?Definizione procedure esterne.
006500100413      //---------------------------------------------------------------
006600110203
006700110203      // - Aggiunge/Toglie gg/mm dalla data
006800110203     d Xgiolav         pr                  extpgm('XGIOLAV')
006900110203     d  xgiolavds                          likeds(xgiolavds)
007000100413
007100100413      //---------------------------------------------------------------
007200100413      //?prototipi
007300100413      //---------------------------------------------------------------
007400100414
007500100415      /copy gaitrasrc/srcprotopr,trul33r
007600100413
007700100413      //---------------------------------------------------------------
007800100413      //?Definizione key-list.
007900100413      //---------------------------------------------------------------
008000100413
008100100413      //---------------------------------------------------------------
008200100413      //?Riepilogo indicatori.
008300100413      //---------------------------------------------------------------
008400100413
008500100413      //---------------------------------------------------------------
008600100413      //?M A I N - L I N E
008700100413      //---------------------------------------------------------------
008800100413
008900100413     c     *Entry        plist
009000110203     c                   parm                    kpjba
009100100413
009200100413      /free
009300100413
009400100413       //?Operazioni iniziali
009500100513       exsr RoutInz;
009600110427
009700110427       //?Elaboro solo se è lunedì
009800110427       IF  %subst(wName_Of_Day:1:3) = 'Lun';
009900100413
010000110427         //?Elaboro
010100110427         exsr Elabora;
010200110427
010300110427       ENDIF;
010400100413
010500100413       //?Operazioni finali
010600100513       exsr RoutEnd;
010700100413
010800100413       //--------------------------------------------------------------
010900100413       //?Operazioni iniziali.
011000100413       //--------------------------------------------------------------
011100100513       BEGSR RoutInz;
011200100726
011300100726         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
011400110427
011500110427         wdata = %dec(%date());
011600110427         wDate_ISO = %date(wdata:*iso);
011700110427
011800110427       //?Recupero il nome del giorno
011900110427         clear wName_Of_Day;
012000110427         exec sql
012100110427         set :wName_Of_Day = dayname(:wDate_ISO);
012200110429
012300100413       ENDSR;
012400100413
012500100413       //--------------------------------------------------------------
012600100422       //?Elaboro.
012700100413       //--------------------------------------------------------------
012800100513       BEGSR Elabora;
012900100413
013000100413         $End = *off;
013100100413
013200100726       //?Estraggo solo i potenziali mai codificati
013300100413         exec sql
013400100726         DECLARE CPO cursor for
013500110211         SELECT  CPOcpo, CPOcmm, CPOfls, CPOflt
013600110428         FROM TNCPO01L
013700110203         WHERE CPOfls = 'M'
013800110203         ORDER by CPOcpo;
013900100413
014000100726         exec sql OPEN CPO;
014100100413
014200100413         DOW  not $End;
014300110211           exec sql FETCH next from CPO into :CPOCPO, :CPOCMM,
014400110211                                             :CPOFLS, :CPOFLT;
014500100413           IF  sqlcod = 100 or sqlcod < 0;
014600100413             $End = *on;
014700100413             leave;
014800100413           ENDIF;
014900100422
015000100726         //?Controllo se potenziale ha azioni o trattative aperte
015100110428         //?e se ha stati
015200110428           exsr CtrDati;
015300110203
015400110203         //?Scrivo nuova attività solo se NON trovo attività da eseguire o trattative aperte
015500110422         //?e il potenziale ha almeno 1 stato
015600110223         //?e c'è il codice del commerciale sul potenziale
015700110422           IF  NrAtt = 0 and NrVis = 0 and NrCps > 0 and CPOcmm > 0;
015800100726
015900110203           //?Genero nuova attività 60
016000110203             exsr Scrivi;
016100110203           ENDIF;
016200100726
016300100413         ENDDO;
016400100413
016500100726         exec sql CLOSE CPO;
016600100413
016700100413       ENDSR;
016800100726
016900100726       //--------------------------------------------------------------
017000110428       //?Controllo attività/trattative e stati.
017100100726       //--------------------------------------------------------------
017200110428       BEGSR CtrDati;
017300100726
017400100726         clear NrAtt;
017500100726         clear NrVis;
017600110428         clear NrCps;
017700110426
017800110426       //?Controllo se ci sono attività da eseguire
017900110428         chain (CPOcpo:0:0) TIATC05L;
018000110428         IF  %found(TIATC05L);
018100110428           NrAtt = 1;
018200110428           leavesr;
018300110428         ENDIF;
018400110203
018500110203       //?Se non ho trovato attività controllo se il potenziale ha trattative aperte
018600110428         setll (CPOcpo:0) TIVIS01L;
018700110428         reade (CPOcpo:0) TIVIS01L;
018800110428         DOW not %eof(TIVIS01L);
018900110428           IF  VISffz = ' ';
019000110428             NrVis = 1;
019100110428             leavesr;
019200110428           ENDIF;
019300110428           reade (CPOcpo:0) TIVIS01L;
019400110428         ENDDO;
019500110422
019600110428       //?Controllo se il potenziale ha stati
019700110428         chain (CPOcpo) TICPS01L;
019800110428         IF  %found(TICPS01L);
019900110428           NrCps = 1;
020000110428           leavesr;
020100110428         ENDIF;
020200110422
020300110422       ENDSR;
020400100413
020500100413       //--------------------------------------------------------------
020600100726       //?Scrivo nuova attività.
020700100413       //--------------------------------------------------------------
020800100413       BEGSR Scrivi;
020900100422
021000100422         clear wDad;
021100100415
021200100726       //?Stacco nuovo numero attività
021300110203         exsr Stacca_Numero;
021400110203       //?Calcolo la data attività
021500110203         clear XGIOLAVDS;
021600110203         IXGLdata = %dec(%date());
021700110203         IXGLadd  = 'S';
021800110203         IXGLgg   = wgg;
021900110203         IXGLpa   = 'P';
022000110223         IXGLfil  = %dec(%subst(%editc(CPOcmm:'X'):1:3):3:0);
022100110203         XGIOLAV (xgiolavds);
022200110203         IF  OXGLerr = *blanks;
022300110203           wDad = OXGLdata;
022400110203         ELSE;
022500110203           wDad = %dec(%date());
022600110203         ENDIF;
022700110203
022800110203       //?Scrivo la nuova attività
022900110203         exsr Scrivi_TIATC;
023000100413
023100100413       ENDSR;
023200100415
023300100415       //--------------------------------------------------------------
023400100415       //?Stacco nuovo numero attività.
023500100415       //--------------------------------------------------------------
023600100415       BEGSR Stacca_Numero;
023700100415
023800100415         clear TRUL33ds;
023900100415         I33tla = 'L';
024000100415         I33ope = 0;
024100100415         I33cnu = 070;
024200100415         I33num = 1;
024300100415         I33aaa = *year;
024400100415         kpjbu  = TRUL33ds;
024500100415         trul33r (kpjba);
024600100415         TRUL33ds = kpjbu;
024700100415
024800100415       ENDSR;
024900100415
025000100415       //--------------------------------------------------------------
025100100415       //?Scrivo file TIATC.
025200100415       //--------------------------------------------------------------
025300100415       BEGSR Scrivi_TIATC;
025400110203
025500110211         clear dATC01;
025600110203         clear TIATC000;
025700110203         ATCtat  = 'T';
025800110203         ATCatn  = O33Nrf;
025900110203         ATCatnp = 1;
026000110203         ATCcpo  = CPOcpo;
026100110203         ATCcad  = '60';
026200110203         ATCdad  = wDad;
026300110203         ATChda  = 103000;
026400110203         ATCcmm  = CPOcmm;
026500110203         ATCco3  = CPOcmm;
026600110203         ATCcnw = 'P';
026700110203         ATCdim  = %dec(%date());
026800110203         ATChim  = %dec(%time());
026900110203         ATCpri  = 'BATCH';
027000110211         §ATCcapo1 = CPOfls;
027100110211         ATCflo = dATC01;
027200110203         write TIATC000;
027300100415
027400100415       ENDSR;
027500100414
027600100413       //--------------------------------------------------------------
027700100413       //?Operazioni finali.
027800100413       //--------------------------------------------------------------
027900100513       BEGSR RoutEnd;
028000100413
028100100413         *inLR = *on;
028200100413         return;
028300100413
028400100413       ENDSR;
028500100413
028600100413      /end-free
