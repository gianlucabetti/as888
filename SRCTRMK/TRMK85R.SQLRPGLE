000100090708      //---------------------------------------------------------------
000200091215      //?TRMK85R - Controlla se attività aperte
000300090708      //---------------------------------------------------------------
000400090708
000500090708     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600090708
000700090708      //---------------------------------------------------------------
000800090708      //?Dichiarazione file.
000900090708      //---------------------------------------------------------------
001000090708
001100090708      //---------------------------------------------------------------
001200090511      //?Definizione costanti.
001300090511      //---------------------------------------------------------------
001400090511
001500090511      //---------------------------------------------------------------
001600090511      //?Definizione schiere.
001700090511      //---------------------------------------------------------------
001800090708
001900090708      // - Messaggi di errore
002000090708     d $Msg            s             78    dim(10) ctdata perrcd(1)
002100090721
002200090511      //---------------------------------------------------------------
002300090511      //?Definizione aree dati.
002400090511      //---------------------------------------------------------------
002500090511
002600090511      //---------------------------------------------------------------
002700090511      //?Definizione strutture dati.
002800090511      //---------------------------------------------------------------
002900090708
003000090708      // - Parametri ricevuti
003100091215     d TRMK85ds      e ds
003200090709
003300091008      // File attività
003400091008     d tiatc00f      e ds                  extname(TIATC00F)
003500090511
003600090511      //---------------------------------------------------------------
003700090511      //?Definizione variabili globali.
003800090511      //---------------------------------------------------------------
003900090708
004000090708      // - Campi di comodo
004100091215     d NrAtt           s              5i 0
004200090511
004300090511      //---------------------------------------------------------------
004400090511      //?Definizione procedure esterne.
004500090511      //---------------------------------------------------------------
004600090708
004700090511      //---------------------------------------------------------------
004800090511      //?Definizione key-list.
004900090511      //---------------------------------------------------------------
005000090708
005100090708      //---------------------------------------------------------------
005200090708      //?Riepilogo indicatori.
005300090708      //---------------------------------------------------------------
005400090511
005500090511      //---------------------------------------------------------------
005600090708      //?M A I N - L I N E
005700090511      //---------------------------------------------------------------
005800090708
005900090708     c     *Entry        plist
006000091215     c                   parm                    trmk85ds
006100090708
006200090708      /free
006300090708
006400090708       //?Operazioni iniziali
006500090708       exsr sr_RoutInz;
006600091007
006700091007       //?Controllo dati passati
006800091007       exsr sr_CtrDati;
006900091007
007000091215       //?Verifico se ci sono attività aperte per potenziale/cliente
007100091215       IF  OMK85err = *blanks;
007200091215         exsr sr_CtrAttivita;
007300091007       ENDIF;
007400090708
007500090708       //?Operazioni finali
007600090708       exsr sr_RoutEnd;
007700090708
007800090708       //--------------------------------------------------------------
007900090708       //?Operazioni iniziali.
008000090708       //--------------------------------------------------------------
008100090708       BEGSR sr_RoutInz;
008200090708
008300091215         clear OMK85err;
008400091215         clear OMK85msg;
008500091009
008600090708         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
008700090708
008800090708       ENDSR;
008900090805
009000090805       //--------------------------------------------------------------
009100091007       //?Controllo dati passati.
009200090805       //--------------------------------------------------------------
009300091007       BEGSR sr_CtrDati;
009400090810
009500091215         IF  IMK85cpo = 0;
009600091215           OMK85err = '9';
009700091215           OMK85msg = $msg(01);
009800091009           leavesr;
009900090810         ENDIF;
010000090805
010100090805       ENDSR;
010200091007
010300091007       //--------------------------------------------------------------
010400091215       //?Controllo attività
010500091007       //--------------------------------------------------------------
010600091215       BEGSR sr_CtrAttivita;
010700091215
010800091215         clear NrAtt;
010900100115
011000100115         //?Controllo attività aperte non legate alla trattativa passata
011100100115         IF  IMK85nrv > 0;
011200100115           //?con il codice potenziale
011300100115           IF  IMK85ksc = 0;
011400100115             exec sql
011500100115              select count(*) into :NrAtt from tiatc00f
011600100115              where atccpo = :IMK85cpo and atcnrv <> :IMK85nrv
011700100115                and atcdco = 0;
011800100115              //?trovo almeno un'attività torna il messaggio
011900100115              IF  NrAtt > *zeros;
012000100115                OMK85err = '1';
012100100115                OMK85msg = $msg(02);
012200100115              ENDIF;
012300100115            ENDIF;
012400100118         //?con codice potenziale e codice cliente
012500100115           IF  IMK85ksc > 0;
012600100115             exec sql
012700100115              select count(*) into :NrAtt from tiatc00f
012800100115              where atccpo = :IMK85cpo and atcksc = :IMK85ksc
012900100115                and atcnrv <> :IMK85nrv and atcdco = 0;
013000100115              //?trovo almeno un'attività torna il messaggio
013100100115              IF  NrAtt > *zeros;
013200100115                OMK85err = '1';
013300100115                OMK85msg = $msg(02);
013400100115              ENDIF;
013500100115            ENDIF;
013600100115           leavesr;
013700100115         ENDIF;
013800091008
013900100118         //?Controllo attività aperte con codice potenziale
014000100129         //?escludo l'attività passata
014100100115         IF  IMK85ksc = 0;
014200100115           exec sql
014300100115            select count(*) into :NrAtt from tiatc00f
014400100129            where atccpo = :IMK85cpo and atcdco = 0 and
014500100129            atcatn <> :IMK85atn;
014600100115            //?trovo almeno un'attività torna il messaggio
014700100115            IF  NrAtt > *zeros;
014800100115              OMK85err = '1';
014900100115              OMK85msg = $msg(02);
015000100115            ENDIF;
015100100115         ENDIF;
015200091215
015300100118         //?Controllo attività aperte con codice potenziale e cliente
015400100115         IF  IMK85ksc > 0;
015500100115           exec sql
015600100115            select count(*) into :NrAtt from tiatc00f
015700100129            where atccpo = :IMK85cpo and atcksc = :IMK85ksc and atcdco = 0
015800100129            and atcatn <> :IMK85atn;
015900100115            //?trovo almeno un'attività torna il messaggio
016000100115            IF  NrAtt > *zeros;
016100100115              OMK85err = '1';
016200100115              OMK85msg = $msg(02);
016300100115            ENDIF;
016400100115         ENDIF;
016500091007
016600091007       ENDSR;
016700090708
016800090708       //--------------------------------------------------------------
016900090708       //?Operazioni finali.
017000090708       //--------------------------------------------------------------
017100090708       BEGSR sr_RoutEnd;
017200090708
017300090708         *inLR = *on;
017400090708         return;
017500090708
017600090708       ENDSR;
017700090708
017800090708      /end-free
017900090708
018000090708       //--------------------------------------------------------------
018100090708       //?Schiere a tempo di compilazione.
018200090708       //--------------------------------------------------------------
018300090708
018400090708** - $MSG -------------------------------------------------------------------*
018500091014Dati non passati                                                              01
018600091215Attenzione: esistono altre attività aperte                                    02
