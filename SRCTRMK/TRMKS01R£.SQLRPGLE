000100120925      //--------------------------------------------------------------
000200121015      //?TRMKS01R - Pulizia CRM - Att. Ferie Ufficio AA + note
000300120925      //--------------------------------------------------------------
000400120925
000500120925     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600120925
000700120925      //---------------------------------------------------------------
000800120925      //?Dichiarazione file.
000900120925      //---------------------------------------------------------------
001000120928
001100120928       // -?File Attivita
001200120928     fTIATC00F  uf   e             disk    prefix(w)
001300120928
001400120928       // -?File Note
001500120928     fTICPN03L  uf   e           k disk
001600120925
001700120925      //---------------------------------------------------------------
001800120925      //?Definizione costanti.
001900120925      //---------------------------------------------------------------
002000120925
002100120925      //---------------------------------------------------------------
002200120925      //?Definizione schiere.
002300120925      //---------------------------------------------------------------
002400120925
002500120925      //---------------------------------------------------------------
002600120925      //?Definizione aree dati.
002700120925      //---------------------------------------------------------------
002800120925
002900120925      //---------------------------------------------------------------
003000120925      //?Definizione strutture dati.
003100120925      //---------------------------------------------------------------
003200121015
003300121015       // -?KPJBA
003400121015     d kpjba         e ds
003500121015     d  DataEla              247    254s 0
003600120928
003700120928       // -?File TIATC00F
003800120928     d TIATCds       e ds                  extname(TIATC00F)
003900120925
004000120925      //---------------------------------------------------------------
004100120925      //?Definizione variabili globali.
004200120925      //---------------------------------------------------------------
004300120925
004400120925       // -?Flags booleani
004500120925     d wEoF            s               n   inz(*off)
004600120928
004700120928       // -?Campi Rnn
004800120928     d Atc_Rrn         s              9  0
004900120925
005000120925       // -?Campi di comodo data
005100121008     d DataPul         s              8s 0
005200121015       // DataEla         s              8s 0 inz(20130101)
005300120928     d DataISO         s               d   datfmt(*iso)
005400120925
005500120925      //---------------------------------------------------------------
005600120925      //?Definizione procedure esterne.
005700120925      //---------------------------------------------------------------
005800120925
005900120925      //---------------------------------------------------------------
006000120925      //?Definizione prototipi.
006100120925      //---------------------------------------------------------------
006200120925
006300120925      //---------------------------------------------------------------
006400120925      //?Definizione key-list.
006500120925      //---------------------------------------------------------------
006600120925
006700120925      //---------------------------------------------------------------
006800120925      //?Riepilogo indicatori.
006900120925      //---------------------------------------------------------------
007000120925
007100120925      //---------------------------------------------------------------
007200120925
007300120925      //---------------------------------------------------------------
007400120925      //?M A I N - L I N E
007500120925      //---------------------------------------------------------------
007600121015
007700121015     c     *entry        plist
007800121015     c                   parm                    KPJBA
007900120925
008000120925      /free
008100120925
008200120925       //?Operazioni iniziali
008300120925       exsr RoutInz;
008400120925
008500120925       //?Elabora
008600120928       exsr Pul_Att_U_F;
008700121001       exsr Pul_Att_AA;
008800120925
008900120925       //?Operazioni finali
009000120925       exsr RoutEnd;
009100120925
009200120925       //--------------------------------------------------------------
009300120925       //?Operazioni iniziali.
009400120925       //--------------------------------------------------------------
009500120925       BEGSR RoutInz;
009600120925
009700120925         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
009800120927
009900120928       //?Calcolo la data pulizia
010000120928         DataISO = %date(DataEla:*ISO);
010100120928         DataISO = DataISO - %years(2);
010200120928         DataPul = %dec(DataISO);
010300120925
010400120925       ENDSR;
010500120928
010600120928       //--------------------------------------------------------------
010700120928       //?Pulisco tutte le attività Uffico e Ferie.
010800120928       //--------------------------------------------------------------
010900120928       BEGSR Pul_Att_U_F;
011000120928
011100120928         wEoF = *off;
011200120927
011300120928       //?Leggo tutte le attività Ferie e Ufficio
011400120928       //?con data attività minore data pulizia
011500120928         exec sql
011600120928          DECLARE UFF cursor for
011700120928          SELECT rrn(TIATC00F), TIATC00F.* from TIATC00F
011800120928          WHERE ATCtat in('F', 'U') and ATCdad > 0 and
011900120928                ATCdad < :DataPul
012000120928          ORDER BY ATCtat, ATCatn, ATCatnp;
012100120928
012200120928         exec sql
012300120928           open UFF;
012400120928
012500120928         IF sqlcode < 0;
012600120928           wEoF = *on;
012700120928           leavesr;
012800120928         ENDIF;
012900120928
013000120928         DOW  not wEoF;
013100120928
013200120928           exec sql fetch next from UFF into :Atc_Rrn, :TIATCds;
013300120928           IF  sqlcod = 100 or sqlcod < 0;
013400120928             wEoF = *on;
013500120928             leave;
013600120928           ENDIF;
013700120928
013800120928         //?Se ci sono note legate all'attività da pulire le cancello
013900120928           setll (0:ATCtat:ATCatn) TICPN03L;
014000120928           reade (0:ATCtat:ATCatn) TICPN03L;
014100120928             DOW not %eof(TICPN03L);
014200120928               DELETE  TICPN000;
014300120928               reade (0:ATCtat:ATCatn) TICPN03L;
014400120928             ENDDO;
014500120928
014600120928         //?Deleto l'attività
014700120928           chain Atc_Rrn TIATC00F;
014800120928           IF  %found(TIATC00F);
014900120928             DELETE  TIATC000;
015000120928           ENDIF;
015100120928
015200120928         ENDDO;
015300120928
015400120928         exec sql close UFF;
015500120928         wEoF = *off;
015600120928
015700120928       ENDSR;
015800121001
015900121001       //--------------------------------------------------------------
016000121001       //?Pulisco tutte le attività AA.
016100121001       //--------------------------------------------------------------
016200121001       BEGSR Pul_Att_AA;
016300121001
016400121001         wEoF = *off;
016500121001
016600121001       //?Leggo tutte le attività AA
016700121001       //?con data esecuzione minore data pulizia
016800121001         exec sql
016900121001          DECLARE ATTAA cursor for
017000121001          SELECT rrn(TIATC00F), TIATC00F.* from TIATC00F
017100121001          WHERE ATCcac = 'AA' and ATCdco > 0 and
017200121001                ATCdco < :DataPul
017300121001          ORDER BY ATCtat, ATCatn, ATCatnp;
017400121001
017500121001         exec sql
017600121001           open ATTAA;
017700121001
017800121001         IF sqlcode < 0;
017900121001           wEoF = *on;
018000121001           leavesr;
018100121001         ENDIF;
018200121001
018300121001         DOW  not wEoF;
018400121001
018500121001           exec sql fetch next from ATTAA into :Atc_Rrn, :TIATCds;
018600121001           IF  sqlcod = 100 or sqlcod < 0;
018700121001             wEoF = *on;
018800121001             leave;
018900121001           ENDIF;
019000121001
019100121001         //?Se ci sono note legate all'attività da pulire
019200121001         //?le modifico pulendo i campi Tipo attività, nr. attività e progressivo
019300121001           setll (ATCcpo:ATCtat:ATCatn:ATCatnp) TICPN03L;
019400121001           reade (ATCcpo:ATCtat:ATCatn:ATCatnp) TICPN03L;
019500121001             DOW not %eof(TICPN03L);
019600121001               clear CPNtat;
019700121001               clear CPNatn;
019800121001               clear CPNatnp;
019900121001               UPDATE  TICPN000;
020000121001               reade (ATCcpo:ATCtat:ATCatn:ATCatnp) TICPN03L;
020100121001             ENDDO;
020200121001
020300121001         //?Deleto l'attività
020400121001           chain Atc_Rrn TIATC00F;
020500121001           IF  %found(TIATC00F);
020600121001             DELETE  TIATC000;
020700121001           ENDIF;
020800121001
020900121001         ENDDO;
021000121001
021100121001         exec sql close ATTAA;
021200121001         wEoF = *off;
021300121001
021400121001       ENDSR;
021500120925
021600120925       //--------------------------------------------------------------
021700120925       //?Operazioni finali.
021800120925       //--------------------------------------------------------------
021900120925       BEGSR RoutEnd;
022000120925
022100120925         *inLR = *on;
022200120925         return;
022300120925
022400120925       ENDSR;
022500120925
022600120925      /end-free
