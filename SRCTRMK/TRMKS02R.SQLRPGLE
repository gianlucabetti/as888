000100120925      //--------------------------------------------------------------
000200121015      //?TRMKS02R - Pulizia CRM - Trattative Fittizie + file legati
000300120925      //--------------------------------------------------------------
000400120925
000500120925     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600120925
000700120925      //---------------------------------------------------------------
000800120925      //?Dichiarazione file.
000900120925      //---------------------------------------------------------------
001000120925
001100120925      //---------------------------------------------------------------
001200120925      //?Definizione costanti.
001300120925      //---------------------------------------------------------------
001400120925
001500120925      //---------------------------------------------------------------
001600120925      //?Definizione schiere.
001700120925      //---------------------------------------------------------------
001800120925
001900120925      //---------------------------------------------------------------
002000120925      //?Definizione aree dati.
002100120925      //---------------------------------------------------------------
002200120925
002300120925      //---------------------------------------------------------------
002400120925      //?Definizione strutture dati.
002500120925      //---------------------------------------------------------------
002600121015
002700121015       // -?KPJBA
002800121015     d kpjba         e ds
002900121107     d  DataParm             247    254s 0
003000121025
003100121025       // -?File TICPN00F
003200121025     d TICPNds       e ds                  extname(TICPN00F)
003300120928
003400121001       // -?File TIVIS00F
003500121001     d TIVISds       e ds                  extname(TIVIS00F)
003600121025
003700121025       // -?Pulizia Trattative + file legati
003800121025     d TNTA16ds      e ds                  inz
003900120925
004000120925      //---------------------------------------------------------------
004100120925      //?Definizione variabili globali.
004200120925      //---------------------------------------------------------------
004300120925
004400120925       // -?Flags booleani
004500120925     d wEoF            s               n   inz(*off)
004600120925
004700120925       // -?Campi di comodo data
004800120928     d DataISO         s               d   datfmt(*iso)
004900121107     d DataPul         s              8  0 inz
005000121107     d DataSav         s              8  0 inz
005100120925
005200120925      //---------------------------------------------------------------
005300120925      //?Definizione procedure esterne.
005400120925      //---------------------------------------------------------------
005500121025
005600121025       // -?Pulizia Trattative + file legati
005700121109     d TNTA16R         pr                  extpgm('TNTA16R')
005800121025     d  kpjba                              likeds(kpjba)
005900121025     d  tnta16ds                           likeds(tnta16ds)
006000120925
006100120925      //---------------------------------------------------------------
006200120925      //?Definizione prototipi.
006300120925      //---------------------------------------------------------------
006400120925
006500120925      //---------------------------------------------------------------
006600120925      //?Definizione key-list.
006700120925      //---------------------------------------------------------------
006800120925
006900120925      //---------------------------------------------------------------
007000120925      //?Riepilogo indicatori.
007100120925      //---------------------------------------------------------------
007200120925
007300120925      //---------------------------------------------------------------
007400120925
007500120925      //---------------------------------------------------------------
007600120925      //?M A I N - L I N E
007700120925      //---------------------------------------------------------------
007800121015
007900121015     c     *entry        plist
008000121015     c                   parm                    KPJBA
008100120925
008200120925      /free
008300120925
008400120925       //?Operazioni iniziali
008500120925       exsr RoutInz;
008600120925
008700120925       //?Elabora
008800121001       exsr Pul_Ntc_VisF;
008900121001       exsr Pul_Vis_F;
009000120925
009100120925       //?Operazioni finali
009200120925       exsr RoutEnd;
009300120925
009400120925       //--------------------------------------------------------------
009500120925       //?Operazioni iniziali.
009600120925       //--------------------------------------------------------------
009700120925       BEGSR RoutInz;
009800120925
009900120925         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
010000121107
010100121107       //?Salvo la data passata
010200121107         DataSav = DataParm;
010300120927
010400121025       //?Alla data pulizia aggiungo 1 gg
010500121107         DataISO = %date(DataParm:*ISO);
010600121025         DataISO = DataISO + %days(1);
010700120928         DataPul = %dec(DataISO);
010800120925
010900120925       ENDSR;
011000120928
011100120928       //--------------------------------------------------------------
011200121001       //?Pulisco tutte le note automatiche delle trattative fittizie.
011300120928       //--------------------------------------------------------------
011400121001       BEGSR Pul_Ntc_VisF;
011500120928
011600121001       //?Cancello le note automatiche delle trattative Fittizie
011700120928         exec sql
011800121001          DELETE from TICPN00F
011900121001          WHERE CPNnrv > 0 and CPNpru = 'BATCH' and CPNnot =
012000121001                'Trattativa modificata in FITTIZIA';
012100120928
012200120928       ENDSR;
012300121001
012400121001       //--------------------------------------------------------------
012500121001       //?Pulisco tutte le trattative fittizie.
012600121001       //--------------------------------------------------------------
012700121001       BEGSR Pul_Vis_F;
012800121001
012900121001         wEoF = *off;
013000121001
013100121001       //?Leggo tutte le trattative Fittizie
013200121001       //?con data apertura minore data pulizia
013300121001         exec sql
013400121001          DECLARE VISF cursor for
013500121105          SELECT * from TIVIS00F
013600121001          WHERE VISffz = 'S' and VISdat > 0 and
013700121001                VISdat < :DataPul
013800121001          ORDER BY VISnrv;
013900121001
014000121001         exec sql
014100121001           open VISF;
014200121001
014300121001         IF sqlcode < 0;
014400121001           wEoF = *on;
014500121001           leavesr;
014600121001         ENDIF;
014700121001
014800121001         DOW  not wEoF;
014900121001
015000121025           exec sql fetch next from VISF into :TIVISds;
015100121001           IF  sqlcod = 100 or sqlcod < 0;
015200121001             wEoF = *on;
015300121001             leave;
015400121001           ENDIF;
015500121025
015600121025           clear TNTA16DS;
015700121025           ITA16nrv = VISnrv;
015800121025           ITA16ffz = 'S';
015900121109           tnta16r (KPJBA:TNTA16DS);
016000121001
016100121001         ENDDO;
016200121001
016300121001         exec sql close VISF;
016400121001         wEoF = *off;
016500121001
016600121001       ENDSR;
016700120925
016800120925       //--------------------------------------------------------------
016900120925       //?Operazioni finali.
017000120925       //--------------------------------------------------------------
017100120925       BEGSR RoutEnd;
017200121107
017300121107       //?Reimposto la data passata
017400121107         DataParm = DataSav;
017500120925
017600120925         *inLR = *on;
017700120925         return;
017800120925
017900120925       ENDSR;
018000120925
018100120925      /end-free
