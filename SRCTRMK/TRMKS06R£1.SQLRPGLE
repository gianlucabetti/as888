000100121206      //--------------------------------------------------------------
000200121206      //?TRMKS06R - Pulizia Potenziali Eliminabili.
000300121206      //--------------------------------------------------------------
000400121206
000500121206     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600121206
000700121206      //---------------------------------------------------------------
000800121206      //?Dichiarazione file.
000900121206      //---------------------------------------------------------------
001000121206
001100121206       // -?Anagrafica Clienti
001200121206     fCNACO16L  if   e           k disk
001300121206
001400121206       // -?File Trattative
001500121207     fTIATC05L  if   e           k disk
001600130103
001700130103       // -?File Storico potenziali
001800130103     fTNCPO00S  o    e             disk    rename(TNCPO000:TNCPOS) prefix(S)
001900121206
002000121206      //---------------------------------------------------------------
002100121206      //?Definizione costanti.
002200121206      //---------------------------------------------------------------
002300121206
002400121206      //---------------------------------------------------------------
002500121206      //?Definizione schiere.
002600121206      //---------------------------------------------------------------
002700121206
002800121206      //---------------------------------------------------------------
002900121206      //?Definizione aree dati.
003000121206      //---------------------------------------------------------------
003100121206
003200121206      //---------------------------------------------------------------
003300121206      //?Definizione strutture dati.
003400121206      //---------------------------------------------------------------
003500121206
003600121206       // -?KPJBA
003700121206     d kpjba         e ds
003800121206     d  DataParm             247    254s 0
003900121206
004000121206       // -?File TIVIS00F
004100121206     d TIVISds       e ds                  extname(TIVIS00F)
004200121206
004300121206       // -?File TNCPO00F
004400121206     d TNCPOds       e ds                  extname(TNCPO00F)
004500130103
004600130103       // -?File TNCPO00S
004700130103     d TNCPOSds      e ds                  extname(TNCPO00S) prefix(S)
004800121206
004900121206       // -?Pulizia Trattative + file legati
005000121206     d TNTA16ds      e ds                  inz
005100121206
005200121206      //---------------------------------------------------------------
005300121206      //?Definizione variabili globali.
005400121206      //---------------------------------------------------------------
005500121206
005600121206       // -?Flags booleani
005700121206     d wEoF            s               n   inz(*off)
005800121206     d wEoF_1          s               n   inz(*off)
005900121206     d wOKdelPot       s               n   inz(*off)
006000121206
006100121206       // -?Campi di comodo data
006200121206     d DataISO         s               d   datfmt(*iso)
006300121206     d DataPul         s              8  0 inz
006400121206     d DataSav         s              8  0 inz
006500121206
006600121206       // -?Campi di comodo
006700121206     d wCPO            s             11a
006800121206
006900121206
007000121206      //---------------------------------------------------------------
007100121206      //?Definizione procedure esterne.
007200121206      //---------------------------------------------------------------
007300121206
007400121206       // -?Pulizia Trattative + file legati
007500121206     d TNTA16R         pr                  extpgm('TNTA16R')
007600121206     d  kpjba                              likeds(kpjba)
007700121206     d  tnta16ds                           likeds(tnta16ds)
007800121206
007900121206      //---------------------------------------------------------------
008000121206      //?Definizione prototipi.
008100121206      //---------------------------------------------------------------
008200121206
008300121206      //---------------------------------------------------------------
008400121206      //?Definizione key-list.
008500121206      //---------------------------------------------------------------
008600121206
008700121206      //---------------------------------------------------------------
008800121206      //?Riepilogo indicatori.
008900121206      //---------------------------------------------------------------
009000121206
009100121206      //---------------------------------------------------------------
009200121206
009300121206      //---------------------------------------------------------------
009400121206      //?M A I N - L I N E
009500121206      //---------------------------------------------------------------
009600121206
009700121206     c     *entry        plist
009800121206     c                   parm                    KPJBA
009900121206
010000121206      /free
010100121206
010200121206       //?Operazioni iniziali
010300121206       exsr RoutInz;
010400121206
010500121206       //?Leggo i potenziali Eliminabili
010600121206       exsr Leggi_CPO;
010700121206
010800121206       //?Operazioni finali
010900121206       exsr RoutEnd;
011000121206
011100121206       //--------------------------------------------------------------
011200121206       //?Operazioni iniziali.
011300121206       //--------------------------------------------------------------
011400121206       BEGSR RoutInz;
011500121206
011600121206         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
011700121206
011800121206       //?Salvo la data passata
011900121206         DataSav = DataParm;
012000121206
012100121206       //?Alla data pulizia aggiungo 1 gg
012200121206         DataISO = %date(DataParm:*ISO);
012300121206         DataISO = DataISO + %days(1);
012400121206         DataPul = %dec(DataISO);
012500121206
012600121206       ENDSR;
012700121206
012800121206       //--------------------------------------------------------------
012900121206       //?Lettura dei potenziali già contattati.
013000121206       //--------------------------------------------------------------
013100121206       BEGSR Leggi_CPO;
013200121206
013300121206         wEoF = *off;
013400121206
013500121206       //?Leggo i potenziali SOLO quelli Eliminabili
013600121206         exec sql
013700121206          DECLARE CPOE cursor for
013800130103          SELECT * from TNCPO00F
013900121206          WHERE CPOfls = 'E'
014000121206          ORDER BY CPOcpo;
014100121206
014200121206         exec sql
014300121206           open CPOE;
014400121206
014500121206         IF sqlcode < 0;
014600121206           wEoF = *on;
014700121206           leavesr;
014800121206         ENDIF;
014900121206
015000121206         DOW  not wEoF;
015100121206
015200130103           exec sql fetch next from CPOE into :TNCPOds;
015300121206           IF  sqlcod = 100 or sqlcod < 0;
015400121206             wEoF = *on;
015500121206             leave;
015600121206           ENDIF;
015700121206
015800121206         //?Resetto flag "OK posso cancellare il potenziale"
015900121206           wOKdelPot = *off;
016000121206
016100121206         //?Se potenziale ancora presente su anagrafica clienti torno a leggere
016200121206           setll (CPOcpo) CNACO16L;
016300121206           IF  %equal(CNACO16L);
016400121206             iter;
016500121206           ENDIF;
016600121206
016700121206         //?Controllo che l'ultima attività eseguita sia
016800121206         //?una 14 o 15 e con data esecuzione entro la data pulizia
016900121206           exsr ctrATC;
017000121206         //?Se devo cancellare il potenziale pulisco tutto quello che è legato a lui
017100121206           IF  wOKdelPot;
017200121206             exsr Elimina;
017300121206           ENDIF;
017400121206
017500121206         ENDDO;
017600121206
017700121206         exec sql close CPOE;
017800121206         wEoF = *off;
017900121206
018000121206       ENDSR;
018100121206
018200121206       //--------------------------------------------------------------
018300121206       //?Controllo l'ultima attività del potenziale.
018400121206       //--------------------------------------------------------------
018500121206       BEGSR ctrATC;
018600121206
018700121206       //?Leggo le attività del potenziale
018800121206         setgt  (CPOcpo) TIATC05L;
018900121206         readpe (CPOcpo) TIATC05L;
019000121206
019100121206         DOW not %eof(TIATC05L);
019200121206
019300121206         //?se l'ultima attività eseguita sul potenziale è una "AA" leggo quella prima
019400121206           IF  ATCcac = 'AA';
019500121206             readpe (CPOcpo) TIATC05L;
019600121206             iter;
019700121206           ENDIF;
019800121206
019900121206         //?se l'ultima attività eseguita sul potenziale è una "14" o "15"
020000121206         //?ed è stata fatta entro la data pulizia
020100121207           IF  (ATCcac = '14' or ATCcac = '15') and
020200121207                ATCdco < DataPul;
020300121206           //?posso cancellare
020400121206             wOKdelpot = *on;
020500121206           ENDIF;
020600121206
020700121206         //?esco dal ciclo
020800121206           leavesr;
020900121206
021000121206         ENDDO;
021100121206
021200121206       ENDSR;
021300121206
021400121206       //--------------------------------------------------------------
021500121206       //?Elimino tutto quello che è lagato al potenziale.
021600121206       //--------------------------------------------------------------
021700121206       BEGSR Elimina;
021800121206
021900121206       //?Cancello Storico
022000121206         exsr delTICRM;
022100121206
022200121206       //?Cancello Trattative
022300121206         exsr delTIVIS;
022400121206
022500121206       //?Cancello Attività
022600121206         exsr delTIATC;
022700121206
022800121206       //?Cancello Note
022900121206         exsr delTICPN;
023000121206
023100121206       //?Cancello Rubrica
023200121206         exsr delTFNTC;
023300121206
023400121206       //?Cancello Info Commerciali
023500121206         exsr delTICPI;
023600130103
023700130103       //?Scrivo storico Potenziale
023800130103         exsr wrtTNCPOS;
023900121206
024000121206       //?Cancello Potenziale
024100121206         exsr delTNCPO;
024200121206
024300121206       ENDSR;
024400121206
024500121206       //--------------------------------------------------------------
024600121206       //?Cancello Storico.
024700121206       //--------------------------------------------------------------
024800121206       BEGSR delTICRM;
024900121206
025000121206       //?Cancello lo storico legato al potenziale che devo cancellare
025100121206         exec sql
025200121206          DELETE from TICRM00F
025300121206          WHERE CRMcpo = :CPOcpo;
025400121206
025500121206       ENDSR;
025600121206
025700121206       //--------------------------------------------------------------
025800121206       //?Cancello Trattative.
025900121206       //--------------------------------------------------------------
026000121206       BEGSR delTIVIS;
026100121206
026200121206         wEoF_1 = *off;
026300121206
026400121206       //?Leggo tutte le trattative legate al potenziale che devo cancellare
026500121206         exec sql
026600121206          DECLARE VISP cursor for
026700121206          SELECT * from TIVIS00F
026800121206          WHERE VIScpo = :CPOcpo
026900121206          ORDER BY VISnrv;
027000121206
027100121206         exec sql
027200121206           open VISP;
027300121206
027400121206         IF sqlcode < 0;
027500121206           wEoF_1 = *on;
027600121206           leavesr;
027700121206         ENDIF;
027800121206
027900121206         DOW  not wEoF_1;
028000121206
028100121206           exec sql fetch next from VISP into :TIVISds;
028200121206           IF  sqlcod = 100 or sqlcod < 0;
028300121206             wEoF_1 = *on;
028400121206             leave;
028500121206           ENDIF;
028600121206
028700121206           clear TNTA16DS;
028800121206           ITA16nrv = VISnrv;
028900121206           tnta16r (KPJBA:TNTA16DS);
029000121206
029100121206         ENDDO;
029200121206
029300121206         exec sql close VISP;
029400121206         wEoF_1 = *off;
029500121206
029600121206       ENDSR;
029700121206
029800121206       //--------------------------------------------------------------
029900121206       //?Cancello Attività.
030000121206       //--------------------------------------------------------------
030100121206       BEGSR delTIATC;
030200121206
030300121206         exec sql
030400121206          DELETE from TIATC00F
030500121206          WHERE ATCcpo = :CPOcpo;
030600121206
030700121206       ENDSR;
030800121206
030900121206       //--------------------------------------------------------------
031000121206       //?Cancello Note.
031100121206       //--------------------------------------------------------------
031200121206       BEGSR delTICPN;
031300121206
031400121206         exec sql
031500121206          DELETE from TICPN00F
031600121206          WHERE CPNcpo = :CPOcpo;
031700121206
031800121206       ENDSR;
031900121206
032000121206       //--------------------------------------------------------------
032100121206       //?Cancello Rubrica.
032200121206       //--------------------------------------------------------------
032300121206       BEGSR delTFNTC;
032400121206
032500121206         wCPO = %editc(CPOcpo:'X');
032600121206
032700121206         exec sql
032800121206          DELETE from TFNTC00F
032900121206          WHERE NTCapl = 'P' and NTCnk1 = :wCPO;
033000121206
033100121206       ENDSR;
033200121206
033300121206       //--------------------------------------------------------------
033400121206       //?Cancello Info Commerciali.
033500121206       //--------------------------------------------------------------
033600121206       BEGSR delTICPI;
033700121206
033800121206         exec sql
033900121206          DELETE from TICPI00F
034000121206          WHERE CPIcpo = :CPOcpo;
034100121206
034200121206       ENDSR;
034300130103
034400130103       //--------------------------------------------------------------
034500130103       //?Scrivo Storico Potenziale.
034600130103       //--------------------------------------------------------------
034700130103       BEGSR wrtTNCPOS;
034800130103
034900130103         TNCPOSds = TNCPOds;
035000130103         write TNCPOS;
035100130103
035200130103       ENDSR;
035300121206
035400121206       //--------------------------------------------------------------
035500121206       //?Cancello Potenziale.
035600121206       //--------------------------------------------------------------
035700121206       BEGSR delTNCPO;
035800130103
035900121206         exec sql
036000121206          DELETE from TNCPO00F
036100121206          WHERE CPOcpo = :CPOcpo;
036200121206
036300121206       ENDSR;
036400121206
036500121206       //--------------------------------------------------------------
036600121206       //?Operazioni finali.
036700121206       //--------------------------------------------------------------
036800121206       BEGSR RoutEnd;
036900121206
037000121206       //?Reimposto la data passata
037100121206         DataParm = DataSav;
037200121206
037300121206         *inLR = *on;
037400121206         return;
037500121206
037600121206       ENDSR;
037700121206
037800121206      /end-free
