000100121206      //--------------------------------------------------------------
000200121206      //?TRMKS06R - Pulizia Potenziali Eliminabili.
000300121206      //--------------------------------------------------------------
000400121206
000500121206     h decedit('0,') datedit(*ymd/) option(*nodebugio)
000600121206
000700121206      //---------------------------------------------------------------
000800121206      //?Dichiarazione file.
000900121206      //---------------------------------------------------------------
001000121206
001100121206       // -?Anagrafica Clienti
001200121206     fCNACO16L  if   e           k disk
001300121206
001400121206       // -?File Trattative
001500121207     fTIATC05L  if   e           k disk
001600130103
001700130103       // -?File Storico potenziali
001800130103     fTNCPO00S  o    e             disk    rename(TNCPO000:TNCPOS) prefix(S)
001900140715     fTNCPO10S  o    e             disk    rename(TNCPO100:TNCPO1S) prefix(S)
002000121206
002100121206      //---------------------------------------------------------------
002200121206      //?Definizione costanti.
002300121206      //---------------------------------------------------------------
002400121206
002500121206      //---------------------------------------------------------------
002600121206      //?Definizione schiere.
002700121206      //---------------------------------------------------------------
002800121206
002900121206      //---------------------------------------------------------------
003000121206      //?Definizione aree dati.
003100121206      //---------------------------------------------------------------
003200121206
003300121206      //---------------------------------------------------------------
003400121206      //?Definizione strutture dati.
003500121206      //---------------------------------------------------------------
003600121206
003700121206       // -?KPJBA
003800121206     d kpjba         e ds
003900121206     d  DataParm             247    254s 0
004000121206
004100121206       // -?File TIVIS00F
004200121206     d TIVISds       e ds                  extname(TIVIS00F)
004300121206
004400121206       // -?File TNCPO00F
004500121206     d TNCPOds       e ds                  extname(TNCPO00F)
004600140715     d TNCPO1ds      e ds                  extname(TNCPO10F)
004700130103
004800130103       // -?File TNCPO00S
004900130103     d TNCPOSds      e ds                  extname(TNCPO00S) prefix(S)
005000140715     d TNCPO1Sds     e ds                  extname(TNCPO10S) prefix(S)
005100121206
005200121206       // -?Pulizia Trattative + file legati
005300121206     d TNTA16ds      e ds                  inz
005400121206
005500121206      //---------------------------------------------------------------
005600121206      //?Definizione variabili globali.
005700121206      //---------------------------------------------------------------
005800121206
005900121206       // -?Flags booleani
006000121206     d wEoF            s               n   inz(*off)
006100121206     d wEoF_1          s               n   inz(*off)
006200121206     d wOKdelPot       s               n   inz(*off)
006300121206
006400121206       // -?Campi di comodo data
006500121206     d DataISO         s               d   datfmt(*iso)
006600121206     d DataPul         s              8  0 inz
006700121206     d DataSav         s              8  0 inz
006800121206
006900121206       // -?Campi di comodo
007000121206     d wCPO            s             11a
007100121206
007200121206
007300121206      //---------------------------------------------------------------
007400121206      //?Definizione procedure esterne.
007500121206      //---------------------------------------------------------------
007600121206
007700121206       // -?Pulizia Trattative + file legati
007800121206     d TNTA16R         pr                  extpgm('TNTA16R')
007900121206     d  kpjba                              likeds(kpjba)
008000121206     d  tnta16ds                           likeds(tnta16ds)
008100121206
008200121206      //---------------------------------------------------------------
008300121206      //?Definizione prototipi.
008400121206      //---------------------------------------------------------------
008500121206
008600121206      //---------------------------------------------------------------
008700121206      //?Definizione key-list.
008800121206      //---------------------------------------------------------------
008900121206
009000121206      //---------------------------------------------------------------
009100121206      //?Riepilogo indicatori.
009200121206      //---------------------------------------------------------------
009300121206
009400121206      //---------------------------------------------------------------
009500121206
009600121206      //---------------------------------------------------------------
009700121206      //?M A I N - L I N E
009800121206      //---------------------------------------------------------------
009900121206
010000121206     c     *entry        plist
010100121206     c                   parm                    KPJBA
010200121206
010300121206      /free
010400121206
010500121206       //?Operazioni iniziali
010600121206       exsr RoutInz;
010700121206
010800121206       //?Leggo i potenziali Eliminabili
010900121206       exsr Leggi_CPO;
011000121206
011100121206       //?Operazioni finali
011200121206       exsr RoutEnd;
011300121206
011400121206       //--------------------------------------------------------------
011500121206       //?Operazioni iniziali.
011600121206       //--------------------------------------------------------------
011700121206       BEGSR RoutInz;
011800121206
011900121206         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
012000121206
012100121206       //?Salvo la data passata
012200121206         DataSav = DataParm;
012300121206
012400121206       //?Alla data pulizia aggiungo 1 gg
012500121206         DataISO = %date(DataParm:*ISO);
012600121206         DataISO = DataISO + %days(1);
012700121206         DataPul = %dec(DataISO);
012800121206
012900121206       ENDSR;
013000121206
013100121206       //--------------------------------------------------------------
013200121206       //?Lettura dei potenziali già contattati.
013300121206       //--------------------------------------------------------------
013400121206       BEGSR Leggi_CPO;
013500121206
013600121206         wEoF = *off;
013700121206
013800121206       //?Leggo i potenziali SOLO quelli Eliminabili
013900121206         exec sql
014000121206          DECLARE CPOE cursor for
014100140715          SELECT * from TNCPO00F join TNCPO10F
014200140715          on CPOcpo = CPO1cpo
014300121206          WHERE CPOfls = 'E'
014400121206          ORDER BY CPOcpo;
014500121206
014600121206         exec sql
014700121206           open CPOE;
014800121206
014900121206         IF sqlcode < 0;
015000121206           wEoF = *on;
015100121206           leavesr;
015200121206         ENDIF;
015300121206
015400121206         DOW  not wEoF;
015500121206
015600140715           exec sql fetch next from CPOE into :TNCPOds, :TNCPO1ds;
015700121206           IF  sqlcod = 100 or sqlcod < 0;
015800121206             wEoF = *on;
015900121206             leave;
016000121206           ENDIF;
016100121206
016200121206         //?Resetto flag "OK posso cancellare il potenziale"
016300121206           wOKdelPot = *off;
016400121206
016500121206         //?Se potenziale ancora presente su anagrafica clienti torno a leggere
016600121206           setll (CPOcpo) CNACO16L;
016700121206           IF  %equal(CNACO16L);
016800121206             iter;
016900121206           ENDIF;
017000121206
017100121206         //?Controllo che l'ultima attività eseguita sia
017200121206         //?una 14 o 15 e con data esecuzione entro la data pulizia
017300121206           exsr ctrATC;
017400121206         //?Se devo cancellare il potenziale pulisco tutto quello che è legato a lui
017500121206           IF  wOKdelPot;
017600121206             exsr Elimina;
017700121206           ENDIF;
017800121206
017900121206         ENDDO;
018000121206
018100121206         exec sql close CPOE;
018200121206         wEoF = *off;
018300121206
018400121206       ENDSR;
018500121206
018600121206       //--------------------------------------------------------------
018700121206       //?Controllo l'ultima attività del potenziale.
018800121206       //--------------------------------------------------------------
018900121206       BEGSR ctrATC;
019000121206
019100121206       //?Leggo le attività del potenziale
019200121206         setgt  (CPOcpo) TIATC05L;
019300121206         readpe (CPOcpo) TIATC05L;
019400121206
019500121206         DOW not %eof(TIATC05L);
019600121206
019700121206         //?se l'ultima attività eseguita sul potenziale è una "AA" leggo quella prima
019800121206           IF  ATCcac = 'AA';
019900121206             readpe (CPOcpo) TIATC05L;
020000121206             iter;
020100121206           ENDIF;
020200121206
020300121206         //?se l'ultima attività eseguita sul potenziale è una "14" o "15"
020400121206         //?ed è stata fatta entro la data pulizia
020500121207           IF  (ATCcac = '14' or ATCcac = '15') and
020600121207                ATCdco < DataPul;
020700121206           //?posso cancellare
020800121206             wOKdelpot = *on;
020900121206           ENDIF;
021000121206
021100121206         //?esco dal ciclo
021200121206           leavesr;
021300121206
021400121206         ENDDO;
021500121206
021600121206       ENDSR;
021700121206
021800121206       //--------------------------------------------------------------
021900121206       //?Elimino tutto quello che è lagato al potenziale.
022000121206       //--------------------------------------------------------------
022100121206       BEGSR Elimina;
022200121206
022300121206       //?Cancello Storico
022400121206         exsr delTICRM;
022500121206
022600121206       //?Cancello Trattative
022700121206         exsr delTIVIS;
022800121206
022900121206       //?Cancello Attività
023000121206         exsr delTIATC;
023100121206
023200121206       //?Cancello Note
023300121206         exsr delTICPN;
023400121206
023500121206       //?Cancello Rubrica
023600121206         exsr delTFNTC;
023700121206
023800121206       //?Cancello Info Commerciali
023900121206         exsr delTICPI;
024000130103
024100130103       //?Scrivo storico Potenziale
024200130103         exsr wrtTNCPOS;
024300121206
024400121206       //?Cancello Potenziale
024500121206         exsr delTNCPO;
024600121206
024700121206       ENDSR;
024800121206
024900121206       //--------------------------------------------------------------
025000121206       //?Cancello Storico.
025100121206       //--------------------------------------------------------------
025200121206       BEGSR delTICRM;
025300121206
025400121206       //?Cancello lo storico legato al potenziale che devo cancellare
025500121206         exec sql
025600121206          DELETE from TICRM00F
025700121206          WHERE CRMcpo = :CPOcpo;
025800121206
025900121206       ENDSR;
026000121206
026100121206       //--------------------------------------------------------------
026200121206       //?Cancello Trattative.
026300121206       //--------------------------------------------------------------
026400121206       BEGSR delTIVIS;
026500121206
026600121206         wEoF_1 = *off;
026700121206
026800121206       //?Leggo tutte le trattative legate al potenziale che devo cancellare
026900121206         exec sql
027000121206          DECLARE VISP cursor for
027100121206          SELECT * from TIVIS00F
027200121206          WHERE VIScpo = :CPOcpo
027300121206          ORDER BY VISnrv;
027400121206
027500121206         exec sql
027600121206           open VISP;
027700121206
027800121206         IF sqlcode < 0;
027900121206           wEoF_1 = *on;
028000121206           leavesr;
028100121206         ENDIF;
028200121206
028300121206         DOW  not wEoF_1;
028400121206
028500121206           exec sql fetch next from VISP into :TIVISds;
028600121206           IF  sqlcod = 100 or sqlcod < 0;
028700121206             wEoF_1 = *on;
028800121206             leave;
028900121206           ENDIF;
029000121206
029100121206           clear TNTA16DS;
029200121206           ITA16nrv = VISnrv;
029300121206           tnta16r (KPJBA:TNTA16DS);
029400121206
029500121206         ENDDO;
029600121206
029700121206         exec sql close VISP;
029800121206         wEoF_1 = *off;
029900121206
030000121206       ENDSR;
030100121206
030200121206       //--------------------------------------------------------------
030300121206       //?Cancello Attività.
030400121206       //--------------------------------------------------------------
030500121206       BEGSR delTIATC;
030600121206
030700121206         exec sql
030800121206          DELETE from TIATC00F
030900121206          WHERE ATCcpo = :CPOcpo;
031000121206
031100121206       ENDSR;
031200121206
031300121206       //--------------------------------------------------------------
031400121206       //?Cancello Note.
031500121206       //--------------------------------------------------------------
031600121206       BEGSR delTICPN;
031700121206
031800121206         exec sql
031900121206          DELETE from TICPN00F
032000121206          WHERE CPNcpo = :CPOcpo;
032100121206
032200121206       ENDSR;
032300121206
032400121206       //--------------------------------------------------------------
032500121206       //?Cancello Rubrica.
032600121206       //--------------------------------------------------------------
032700121206       BEGSR delTFNTC;
032800121206
032900121206         wCPO = %editc(CPOcpo:'X');
033000121206
033100121206         exec sql
033200121206          DELETE from TFNTC00F
033300121206          WHERE NTCapl = 'P' and NTCnk1 = :wCPO;
033400121206
033500121206       ENDSR;
033600121206
033700121206       //--------------------------------------------------------------
033800121206       //?Cancello Info Commerciali.
033900121206       //--------------------------------------------------------------
034000121206       BEGSR delTICPI;
034100121206
034200121206         exec sql
034300121206          DELETE from TICPI00F
034400121206          WHERE CPIcpo = :CPOcpo;
034500121206
034600121206       ENDSR;
034700130103
034800130103       //--------------------------------------------------------------
034900130103       //?Scrivo Storico Potenziale.
035000130103       //--------------------------------------------------------------
035100130103       BEGSR wrtTNCPOS;
035200140715
035300140715         TNCPO1Sds = TNCPO1ds;
035400140715         write TNCPO1S;
035500130103
035600130103         TNCPOSds = TNCPOds;
035700130103         write TNCPOS;
035800130103
035900130103       ENDSR;
036000121206
036100121206       //--------------------------------------------------------------
036200121206       //?Cancello Potenziale.
036300121206       //--------------------------------------------------------------
036400121206       BEGSR delTNCPO;
036500140715
036600140715         exec sql
036700140715          DELETE from TNCPO10F
036800140715          WHERE CPO1cpo = :CPOcpo;
036900130103
037000121206         exec sql
037100121206          DELETE from TNCPO00F
037200121206          WHERE CPOcpo = :CPOcpo;
037300121206
037400121206       ENDSR;
037500121206
037600121206       //--------------------------------------------------------------
037700121206       //?Operazioni finali.
037800121206       //--------------------------------------------------------------
037900121206       BEGSR RoutEnd;
038000121206
038100121206       //?Reimposto la data passata
038200121206         DataParm = DataSav;
038300121206
038400121206         *inLR = *on;
038500121206         return;
038600121206
038700121206       ENDSR;
038800121206
038900121206      /end-free
