000100111202     ***************************************************************************
000200111202     **
000300111202     ** Questo programma calcola la quantità di bolli necessari per bollare
000400111202     ** i contratti e gli allegati tariffari presenti in una coda si stampa.
000500111202     **
000600111202     ***************************************************************************
000700111202     H DFTACTGRP(*NO) ACTGRP(*NEW)
000800111202
000900111202     ***************************************************************************
001000111202     **
001100111202     ** Files.
001200111202     **
001300111202     ***************************************************************************
001400111207     Ftrmz0500p O    F  132        PRINTER OFLIND(overFlow)
001500111202
001600111202     ***************************************************************************
001700111202     **
001800111202     ** Costanti.
001900111202     **
002000111202     ***************************************************************************
002100111202     D ADD             C                   'A'
002200111202     D ESITO_ERRORE    C                   -1
002300111202     D ESITO_OK        C                   0
002400111202     D REPLACE         C                   'R'
002500111202     D TUTTO           C                   '*ALL'
002600111202
002700111202     ***************************************************************************
002800111202     **
002900111202     ** Prototipi.
003000111202     **
003100111202     ***************************************************************************
003200111202     D Trulsplf0       PR                  EXTPGM('TRULSPLF0')
003300111202     D  userName                     10A   CONST
003400111202     D  qualifiedOutQ                20A   CONST
003500111202     D  formType                     10A   CONST
003600111202     D  usrDta                       10A   CONST
003700111202     D  job                          26A   CONST
003800111202     D  addReplace                    1A   CONST
003900111202     D  msgId                         7A
004000111202
004100111202     ***************************************************************************
004200111202     **
004300111202     ** Strutture dati.
004400111202     **
004500111202     ***************************************************************************
004600111202     D kpjba         E DS                  QUALIFIED
004700111202     D usrDta          DS                  QUALIFIED
004800111202     D  tbeUni                      256A
004900111202     D  ary                          10A   DIM(25) OVERLAY(usrDta)
005000111202
005100111202     ***************************************************************************
005200111202     **
005300111202     ** Campi.
005400111202     **
005500111202     ***************************************************************************
005600111202     D addReplace      S              1A   INZ(REPLACE)
005700111202     D i               S              3U 0
005800111202     D esito           S             10I 0
005900111202     D outQ            S             10A
006000111202     D msgId           S              7A
006100111202     D oFileName       S             10A
006200111202     D oUsrDta         S             10A
006300111202     D oOutQ           S             10A
006400111202     D oFormType       S             10A
006500111202     D oPages          S              5U 0
006600111202     D oBolli          S              5U 0
006700111202     D oBolliPrg       S              5U 0
006800111202
006900111202     ***************************************************************************
007000111202     **
007100111202     ** Parametri.
007200111202     **
007300111202     ***************************************************************************
007400111202     C     *ENTRY        PLIST
007500111202     C                   PARM                    kpjba
007600111202
007700111202     ***************************************************************************
007800111202     **
007900111202     ** Main.
008000111202     **
008100111202     ***************************************************************************
008200111202
008300111202      /FREE
008400111202
008500111202       *INLR = *ON;
008600111202
008700111202       outQ = kpjba.kpjbu;
008800111202
008900111202       IF outQ = *BLANK;
009000111202         DUMP(A);
009100111202         RETURN;
009200111202       ENDIF;
009300111202
009400111202       EXEC SQL
009500111202         SELECT tbeUni
009600111202           INTO :usrDta.tbeUni
009700111202           FROM tntbe00f
009800111202           WHERE tbeCod = '008'
009900111202             AND tbeKe1 = '*LIST_SPLF'
010000111202             AND tbeKe2 = '*USRDTA'
010100111202             AND tbeLin = ''
010200111202             AND tbeSif = ''
010300111202             AND tbeAtb = ''
010400111202       ;
010500111202
010600111202       SELECT;
010700111202         WHEN sqlCode < *ZERO;
010800111202           DUMP(A);
010900111202           RETURN;
011000111202         WHEN sqlCode = 100;
011100111202           usrDta.ary(1) = TUTTO;
011200111202       ENDSL;
011300111202
011400111202       FOR i = 1 TO %ELEM(usrDta.ary);
011500111202         IF usrDta.ary(i) = *BLANK;
011600111202           LEAVE;
011700111202         ENDIF;
011800111202         Trulsplf0( TUTTO
011900111202                  : outQ + '*LIBL'
012000111202                  : TUTTO
012100111202                  : usrDta.ary(i)
012200111202                  : *BLANK
012300111202                  : addReplace
012400111202                  : msgId
012500111202                  );
012600111202         IF msgId <> *BLANK;
012700111202           DUMP(A);
012800111202           esito = ESITO_ERRORE;
012900111202           LEAVE;
013000111202         ENDIF;
013100111202         IF i = 1;
013200111202           addReplace = ADD;
013300111202         ENDIF;
013400111202       ENDFOR;
013500111202
013600111202       IF esito < ESITO_OK;
013700111202         RETURN;
013800111202       ENDIF;
013900111202
014000111202       EXEC SQL
014100111202         DECLARE spool_files INSENSITIVE NO SCROLL CURSOR FOR
014200111202           SELECT lsplkey206 AS OUTPUT_QUEUE_NAME
014300111202                , lsplkey201 AS SPOOLED_FILE_NAME
014400111202                , lsplkey209 AS USER_SPECIFIED_DATA
014500111202                , lsplkey214 AS FORM_TYPE
014600111202                , lsplkey211 AS TOTAL_PAGES
014700111202                , ROUND(DEC(lsplkey211, 10, 1) / 2 , 0) AS BOLLI
014800111202           FROM qtemp/lsplf00f
014900111202           FOR FETCH ONLY
015000111202       ;
015100111202
015200111202       EXEC SQL OPEN spool_files;
015300111202
015400111202       SELECT;
015500111202         WHEN sqlCode < *ZERO;
015600111202           DUMP(A);
015700111202           RETURN;
015800111202       ENDSL;
015900111202
016000111202       EXCEPT colHdg;
016100111202
016200111202       DOU sqlCode < *ZERO;
016300111202
016400111202         EXEC SQL
016500111202           FETCH NEXT FROM spool_files
016600111202              INTO :oOutQ
016700111202                 , :oFileName
016800111202                 , :oUsrDta
016900111202                 , :oFormType
017000111202                 , :oPages
017100111202                 , :oBolli
017200111202         ;
017300111202
017400111202         SELECT;
017500111202           WHEN sqlCode < *ZERO;
017600111202             DUMP(A);
017700111202             LEAVE;
017800111202           WHEN sqlCode = 100;
017900111202             LEAVE;
018000111202         ENDSL;
018100111202
018200111202         oBolliPrg += oBolli;
018300111202         EXCEPT spool;
018400111202
018500111202       ENDDO;
018600111202
018700111202       EXEC SQL CLOSE spool_files;
018800111202
018900111202      /END-FREE
019000111202
019100111202     ***************************************************************************
019200111202     **
019300111202     ** Stampe.
019400111202     **
019500111202     ***************************************************************************
019600111207     Otrmz0500p E            colHdg            1
019700111202     O                                              'Coda      '
019800111202     O                                           +1 'File      '
019900111202     O                                           +1 'Dati ut.  '
020000111202     O                                           +1 'Tipo mod. '
020100111206     O                                           +1 'Pagine'
020200111206     O                                           +1 'Fogli'
020300111202     O                                           +1 'Prog.'
020400111207     Otrmz0500p E            spool       1
020500111202     O                       oOutQ
020600111202     O                       oFileName           +1
020700111202     O                       oUsrDta             +1
020800111202     O                       oFormType           +1
020900111206     O                       oPages        Z     +2
021000111202     O                       oBolli        Z     +1
021100111202     O                       oBolliPrg     Z     +1
