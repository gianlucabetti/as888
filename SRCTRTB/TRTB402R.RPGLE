000100110803      //--------------------------------------------------------------
000200110811      //?TRTB402R - Interrogazione tabella 3K - VAG
000300110803      //--------------------------------------------------------------
000400110803     h Decedit('0,') Datedit(*ymd.) Option(*nodebugio)
000500110803
000600110803      //---------------------------------------------------------------
000700110803      //?Dichiarazione file.
000800110803      //---------------------------------------------------------------
000900110803
001000110803      // - Tabelle
001100110810     fTABEL00F  if   e           k disk
001200120112      // - Regole cliente x scambio dati
001300120112     fTIVIR06L  if   e           k disk    usropn
001400120112     f                                     extfile(wLibVir)
001500110803
001600110803      // - Video
001700110811     fTRTB402D  cf   e             workstn
001800110803
001900110803      //---------------------------------------------------------------
002000110803      //?Definizione costanti.
002100110803      //---------------------------------------------------------------
002200110803
002300110803      //---------------------------------------------------------------
002400110803      //?Definizione schiere.
002500110803      //---------------------------------------------------------------
002600110803
002700110803      //---------------------------------------------------------------
002800110803      //?Definizione aree dati.
002900110803      //---------------------------------------------------------------
003000110803
003100110803      // - Dati utente
003200110803     d §AzUte        e ds                  extname(AZUTE00F)
003300110803     d                                     dtaara
003400110803     d §DatiUte      e ds                  extname(dDatiUte)
003500110803     d                                     dtaara
003600110803
003700110803      //---------------------------------------------------------------
003800110803      //?Definizione strutture dati.
003900110803      //---------------------------------------------------------------
004000110803
004100110803      // - Parametri ricevuti
004200110803     d KPJBA         e ds
004300110803     d TNTA61DS      e ds
004400120112
004500120112      // - Ricerca/Controllo tabelle
004600120112     d TIBS02ds      e ds                  inz
004700110803
004800110803      // - Reperimento dati utente
004900110803     d TIBS34DS      e ds
005000120112
005100120112      // - Tabella ISV
005200120112     d dISV          e ds                  inz
005300110803
005400110811      // - Tabella 3K
005500110811     d ds3K          e ds                  inz
005600110803
005700110803      //---------------------------------------------------------------
005800110803      //?Definizione variabili globali.
005900110803      //---------------------------------------------------------------
006000110803
006100110803      // - Flags booleani
006200110803     d $Fine           s               n   inz(*off)
006300110803     d $InzD01         s               n   inz(*on)
006400120112
006500120112      // - Nome libreria file tivir00f
006600120112     d wLibVir         s             21a   inz
006700120112
006800120112      // - Campi di comodo
006900120112     d wTipoServ       s                   like(VIRfi1)
007000120112     d w008a           s              8a   inz
007100120112
007200120112      // - Campi di comodo x date
007300120112     d wOggi           s              8s 0 inz
007400110803
007500110803      //---------------------------------------------------------------
007600110803      //?Definizione procedure esterne.
007700110803      //---------------------------------------------------------------
007800110803
007900110803      //---------------------------------------------------------------
008000110803      //?Prototipi.
008100110803      //---------------------------------------------------------------
008200110803
008300120112      /copy gaitrasrc/srcprotopr,tibs02r
008400110803      /copy gaitrasrc/srcprotopr,tibs34r
008500110810      /copy gaitrasrc/srcprotopi,tibs69r
008600110810      /copy gaitrasrc/srcprotopr,tibs69r
008700110803
008800110803      //---------------------------------------------------------------
008900110803      //?Definizione key-list.
009000110803      //---------------------------------------------------------------
009100110803
009200110803      //---------------------------------------------------------------
009300110803      //?Riepilogo indicatori.
009400110803      //---------------------------------------------------------------
009500110803
009600110803      //---------------------------------------------------------------
009700110803
009800110803      //---------------------------------------------------------------
009900110803      //?M A I N - L I N E
010000110803      //---------------------------------------------------------------
010100110803
010200110803     c     *Entry        plist
010300110803     c                   parm                    KPJBA
010400110803     c                   parm                    TNTA61DS
010500110803
010600110803      /free
010700110803
010800110803       //?Operazioni iniziali
010900110803       exsr RoutInz;
011000110803
011100110803       //?Gestione video
011200110803       DOW $Fine = *off;
011300110803         exsr GesD01;
011400110803       ENDDO;
011500110803
011600110803       //?Operazioni finali
011700110803       exsr RoutEnd;
011800110803
011900110803       //--------------------------------------------------------------
012000110803       //?Operazioni iniziali.
012100110803       //--------------------------------------------------------------
012200110803       BEGSR RoutInz;
012300110803
012400110803         //?Reperimento dati job
012500110803         exsr DatiJob;
012600110805
012700110805         IF  TA61ksc <= *zeros;
012800110805           TA61err = *on;
012900110805           TA61msg = 'Richiesto il codice cliente';
013000110805           $Fine = *on;
013100110805         ENDIF;
013200120112
013300120112       //?Controllo in che sistema informativo sono
013400120112       //?S.I. di Prova o S.I. di Produzione
013500120112         IF  (%subst(knsif : 7 : 1) = 'P');
013600120112         //?Imposto la libreria per file TIVIR
013700120112             wLibVir = 'GAITRAGRPS/TIVIR06L';
013800120112         ELSE;
013900120112             wLibVir = 'GAITRAGRU/TIVIR06L';
014000120112         ENDIF;
014100120112
014200120112       //?Apro il file
014300120112         open  TIVIR06L;
014400120112
014500120112       //?Imposto la data del giorno
014600120112         wOggi = %dec(%date());
014700110803
014800110803       ENDSR;
014900110803
015000110803       //--------------------------------------------------------------
015100110803       //?Reperimento Dati del job (Utente/Operativi).
015200110803       //--------------------------------------------------------------
015300110803       BEGSR DatiJob;
015400110803
015500110803         in(E) §AzUte;
015600110803         if NOT %error;
015700110803           in(E) §DatiUte;
015800110803         endif;
015900110803         if %error or RSut = *blanks;
016000110803           clear TIBS34ds;
016100110803           tibs34r(tibs34ds);
016200110803           in §AzUte;
016300110803           in §DatiUte;
016400110803         endif;
016500110803
016600110803       ENDSR;
016700110803
016800110803       //--------------------------------------------------------------
016900110803       //?Gestione videata.
017000110803       //--------------------------------------------------------------
017100110803       BEGSR GesD01;
017200110803
017300110803         //?Iniziallizazione videata
017400110803         IF $InzD01 = *on;
017500110803           exsr InzD01;
017600110803           $InzD01 = *off;
017700110803         ENDIF;
017800110803
017900110803       //?Emissione videata
018000110811         exfmt TB40D01;
018100110803
018200110803       //?F12 = Ritorno
018300110803         IF  *inkl;
018400110803           $fine = *on ;
018500110803           leavesr ;
018600110803         ENDIF;
018700110803
018800110803       ENDSR;
018900110803
019000110803       //--------------------------------------------------------------
019100110803       //?Caricamento videata D01.
019200110803       //--------------------------------------------------------------
019300110803       BEGSR InzD01;
019400110803
019500110810         clear V1Dksc;
019600110810         clear V1Dksu;
019700120112         clear V1Disv;
019800110812         clear V1Ccq6;
019900110812         clear V1Ccq7;
020000110812         clear V1Cnmc;
020100110812         clear V1Cgqi;
020200110812         clear V1Capp;
020300110810
020400110810       //?Decodifico il cliente
020500110810         clear  tibs69ds;
020600110810         I69kac = TA61ksc;
020700110810         TIBS69R (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
020800110810         V1Cksc = TA61ksc;
020900110811         IF  O69err = *blanks;
021000110811           V1Dksc = ACORag;
021100110811         ELSE;
021200110811           V1Dksc = '? ? ? ? ? ?';
021300110811         ENDIF;
021400110810
021500110810       //?Aggancio la tabella
021600110811         clear ds3K;
021700110810         TBLkut = 1;
021800110811         TBLcod = '3K';
021900110810         TBLkey = %editc(V1Cksc:'X');
022000110810
022100110810         chain (TBLkut : TBLcod : TBLkey) TABEL00F;
022200110810         IF  %Found(TABEL00F) and TBLflg = *blanks;
022300110811
022400110811         ds3K = TBLuni;
022500110811
022600110811         //?Se presente decodifico l'unificante giac.
022700110811           IF  §3Kgks <> 0;
022800110811             clear  tibs69ds;
022900110811             I69kac = §3Kgks;
023000110811             TIBS69R (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
023100110811             V1Cksu = §3Kgks;
023200110811             IF  O69err = *blanks;
023300110811               V1Dksu = ACORag;
023400110811             ELSE;
023500110811               V1Dksu = '? ? ? ? ? ?';
023600110811             ENDIF;
023700110811           ELSE;
023800110811             clear V1Cksu;
023900110811           ENDIF;
024000110810
024100110811         //?Se presente decodifico l'unificante cons.
024200110811           IF  §3Kcks <> 0;
024300110810             clear  tibs69ds;
024400110811             I69kac = §3Kcks;
024500110810             TIBS69R (tibs69ds:ds_cnaco:ds_cnind:ds_cnclp:ds_fncls);
024600110811             V1Cksu = §3Kcks;
024700110811             IF  O69err = *blanks;
024800110811               V1Dksu = ACORag;
024900110811             ELSE;
025000110811               V1Dksu = '? ? ? ? ? ?';
025100110811             ENDIF;
025200110810           ELSE;
025300110810             clear V1Cksu;
025400110810           ENDIF;
025500120112
025600120112         //?Cerco la modalità invio dati
025700120112           IF  V1Cksu > 0;
025800120112             clear wTipoServ;
025900120112             w008a = *all'0';
026000120112             %subst(w008a:2:7) = %editc(V1Cksu:'X');
026100120112             setll (w008a : 'VG') TIVIR06L;
026200120112             reade (w008a : 'VG') TIVIR06L;
026300120112             DOW  not %eof(TIVIR06L);
026400120112               IF  VIRdtf >= woggi;
026500120112                 wTipoServ = VIRfi1;
026600120112               ENDIF;
026700120112               reade (w008a : 'VG') TIVIR06L;
026800120112             ENDDO;
026900120112           //?Decodifico la modalità invio dati
027000120112             clear TIBS02ds;
027100120112             T02mod = 'C';
027200120112             T02cod = 'ISV';
027300120112             T02ke1 = wTipoServ;
027400120112             T02sif = KNSIF;
027500120112             TNTBE_RicercaControllo  (kpjba : tibs02ds);
027600120112             IF  T02err = *blanks;
027700120112               dISV = T02Uni;
027800120112             ENDIF;
027900120112             V1Disv = §ISVdesc;
028000120112           ENDIF;
028100110810
028200110811         //?Flag
028300110812           IF  §3Kcq6 = 'S';
028400110812             V1Ccq6 = 'SI';
028500110914           ELSE;
028600110914             V1Ccq6 = 'NO';
028700110812           ENDIF;
028800110812           IF  §3Kcq7 = 'S';
028900110812             V1Ccq7 = 'SI';
029000110914           ELSE;
029100110914             V1Ccq7 = 'NO';
029200110812           ENDIF;
029300110812           IF  §3Knmc = 'S';
029400110812             V1Cnmc = 'SI';
029500110914           ELSE;
029600110914             V1Cnmc = 'NO';
029700110812           ENDIF;
029800110812           SELECT;
029900110812             WHEN  §3Kgqi = 'A';
030000110812               V1cgqi = 'Aperte';
030100110812             WHEN  §3Kgqi = 'C';
030200110812               V1cgqi = 'Chiuse';
030300110812             WHEN  §3Kgqi = 'E';
030400110812               V1cgqi = 'Aperte/Chiuse';
030500110812           ENDSL;
030600110812           IF  §3Kapp = 'S';
030700110812             V1Capp = 'SI';
030800110914           ELSE;
030900110914             V1Capp = 'NO';
031000110812           ENDIF;
031100110810
031200110810         ENDIF;
031300110803
031400110803       ENDSR;
031500110803
031600110803       //--------------------------------------------------------------
031700110803       //?Operazioni finali.
031800110803       //--------------------------------------------------------------
031900110803       BEGSR RoutEnd;
032000110803
032100110803         *inLR = *on;
032200110803         return;
032300110803
032400110803       ENDSR;
