000100110901     ***************************************************************************
000200110901     **
000300110901     ** Allineamento anagrafico sportelli bancari CNABI00F -> Proj.
000400110901     **
000500110901     ***************************************************************************
000600110901     H DFTACTGRP(*NO) BNDDIR('QC2LE')
000700110901
000800110901     ***************************************************************************
000900110901     **
001000110901     ** Costanti.
001100110901     **
001200110901     ***************************************************************************
001300110901     D SQLCODE_ROW_NOT_FOUND...
001400110901     D                 C                   100
001500110901     D TRASMESSO...
001600110901     D                 S              1A   INZ('T')
001700110901
001800110901     ***************************************************************************
001900110901     **
002000110901     ** Strutture dati.
002100110901     **
002200110901     ***************************************************************************
002300110901     D cnabi00f      E DS                  QUALIFIED
002400110901     D kpjba         E DS                  QUALIFIED
002500110901
002600110901     ***************************************************************************
002700110901     **
002800110901     ** Campi.
002900110901     **
003000110901     ***************************************************************************
003100110901     D dataTrasmissione...
003200110901     D                 S                   LIKE(cnabi00f.abiDtr)
003300110901     D rowsDelAcR      S              9B 0
003400110901     D rowsDelAcT      S              9B 0
003500110901
003600110901     ***************************************************************************
003700110901     **
003800110901     ** Prototipi.
003900110901     **
004000110901     ***************************************************************************
004100110901      /COPY GAITRASRC/SRCPROTOPR,SYSTEM
004200110901     D YCOAB1R         PR                  EXTPGM('YCOAB1R')
004300110901     D  cnabi00f                           LIKEDS(cnabi00f)
004400110901     D YCOAB2R         PR                  EXTPGM('YCOAB2R')
004500110901     D  rowsDelAcT                    9B 0
004600110901     D  rowsDelAcR                    9B 0
004700110901
004800110901     D*--------------------------------------------------
004900110901     D* Procedure name: Main
005000110901     D* Purpose:
005100110901     D* Returns:        Esito.
005200110901     D*--------------------------------------------------
005300110901     D Main            PR            10I 0
005400110901
005500110901
005600110901     ***************************************************************************
005700110901     **
005800110901     ** Parametri.
005900110901     **
006000110901     ***************************************************************************
006100110901     C     *ENTRY        PLIST
006200110901     C                   PARM                    kpjba
006300110901
006400110901     ***************************************************************************
006500110901     **
006600110901     ** Main.
006700110901     **
006800110901     ***************************************************************************
006900110901
007000110901      /FREE
007100110901
007200110901       *INLR = *ON;
007300110901
007400110901       IF Main() < *ZERO;
007500110901         kpjba.kmsmn = 'PRO9999';
007600110901         %SUBST(kpjba.kpjbu : 207) =
007700110901                                 'Trasmissione sportelli bancari non riuscita.';
007800110901         ExecuteCommand('DSPJOBLOG OUTPUT(*PRINT)');
007900110901       ENDIF;
008000110901
008100110901      /END-FREE
008200110901
008300110901     P*--------------------------------------------------
008400110901     P* Procedure name: Main
008500110901     P* Purpose:
008600110901     P* Returns:        Esito.
008700110901     P*--------------------------------------------------
008800110901     P Main            B
008900110901     D Main            PI            10I 0
009000110901
009100110901     D retField        S             10I 0
009200110901
009300110901      /FREE
009400110901
009500110901       EXEC SQL SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
009600110901
009700110901       EXEC SQL
009800110901         DECLARE sportelli NO SCROLL CURSOR FOR
009900110901           SELECT *
010000110901           FROM cnabi00f
010100110901           WHERE abiFtr = ''
010200110901           FOR UPDATE OF abiFtr, abiDtr
010300110901           SKIP LOCKED DATA
010400110901       ;
010500110901
010600110901       EXEC SQL OPEN sportelli;
010700110901
010800110901       IF sqlCode < *ZERO;
010900110901         DUMP(A);
011000110901         RETURN sqlCode;
011100110901       ENDIF;
011200110901
011300110901       dataTrasmissione = %DEC(%DATE() : *YMD);
011400110901
011500110901       DOU sqlCode < *ZERO;
011600110901
011700110901         EXEC SQL FETCH NEXT FROM sportelli INTO :cnabi00f;
011800110901
011900110901         SELECT;
012000110901           WHEN sqlCode = SQLCODE_ROW_NOT_FOUND;
012100110901             LEAVE;
012200110901           WHEN sqlCode < *ZERO;
012300110901             DUMP(A);
012400110901             retField = sqlCode;
012500110901             LEAVE;
012600110901         ENDSL;
012700110901
012800110901         YCOAB1R(cnabi00f);
012900110901
013000110901         EXEC SQL
013100110901           UPDATE cnabi00f
013200110901             SET abiFtr = :TRASMESSO
013300110901               , abiDtr = :dataTrasmissione
013400110901             WHERE CURRENT OF sportelli
013500110901         ;
013600110901
013700110901         IF sqlCode < *ZERO;
013800110901           DUMP(A);
013900110901           retField = sqlCode;
014000110901           EXEC SQL ROLLBACK;
014100110901           LEAVE;
014200110901         ENDIF;
014300110901
014400110901         EXEC SQL COMMIT HOLD;
014500110901
014600110901       ENDDO;
014700110901
014800110901       EXEC SQL CLOSE sportelli;
014900110901
015000110901       YCOAB2R(rowsDelAcT : rowsDelAcR);
015100110901
015200110901       RETURN retField;
015300110901
015400110901      /END-FREE
015500110901     P Main            E
015600110901
