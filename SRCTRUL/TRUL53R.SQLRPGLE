000100111128       //==============================================================
000200111128       //?TRUL53R - Cancellazione spool utenti Strategisu AS777.       ?
000300111128       //==============================================================
000400111128
000500111128       //--------------------------------------------------------------
000600111128       //?Specifiche di controllo.                                     ?
000700111128       //--------------------------------------------------------------
000800111128
000900111128     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001000111128     h dftactgrp(*no)
001100111128     h alwnull(*inputonly)
001200111128
001300111128       //--------------------------------------------------------------
001400111128       //?Dichiarazione file.                                          ?
001500111128       //--------------------------------------------------------------
001600111128
001700111128
001800111128       //--------------------------------------------------------------
001900111128       //?Definizione costanti.                                        ?
002000111128       //--------------------------------------------------------------
002100111128
002200111128
002300111128       //--------------------------------------------------------------
002400111128       //?Definizione schiere.                                         ?
002500111128       //--------------------------------------------------------------
002600111128
002700111128
002800111128       //--------------------------------------------------------------
002900111128       //?Definizione aree dati.                                       ?
003000111128       //--------------------------------------------------------------
003100111128
003200111128
003300111128       //--------------------------------------------------------------
003400111128       //?Definizione strutture dati.                                  ?
003500111128       //--------------------------------------------------------------
003600111128
003700111128       // -?Definizione campi?
003800111128     d TIVSS00F      e ds                  qualified  based(nullPtr)
003900111128
004000111128       //--------------------------------------------------------------
004100111128       //?Definizione variabili globali.                               ?
004200111128       //--------------------------------------------------------------
004300111128
004400111128       // -?Stringa SQL da eseguire?
004500160406     d wSQL            s           1024    inz  varying
004600111128
004700111128       // -?Parametri SQL?
004800111128     d wVSSsun         s                   like(TIVSS00F.VSSsun)  inz
004900111128
005000111128       //--------------------------------------------------------------
005100111128       //?Definizione procedure usate.                                 ?
005200111128       //--------------------------------------------------------------
005300111128
005400111128       // -?Iscrizione Clienti ai servizi Strategi?
005500111128     d Qcmd            s            500    inz
005600111128     d tis730c         pr                  extpgm('TIS730C')
005700111128     d   Qcmd                              like(Qcmd)
005800111128
005900111128       // -?Parametri API QCAPCMD (Process Commands)?
006000111128     d*// Qcmd            s           1024    inz  varying
006100111128      /copy qSysInc/qRpgleSrc,QCAPCMD
006200111128      /copy gaitrasrc/srcProtoPR,QCAPCMD
006300111128
006400111128       // -?Parametri gestione errori API.?
006500111128      /copy qSysInc/qRpgleSrc,QUSEC
006600111128
006700111128       //--------------------------------------------------------------
006800111128       //?Definizione key-list.                                        ?
006900111128       //--------------------------------------------------------------
007000111128
007100111128
007200111128       //--------------------------------------------------------------
007300111128       //?Riepilogo indicatori.                                        ?
007400111128       //--------------------------------------------------------------
007500111128       //--------------------------------------------------------------
007600111128
007700111128
007800111128       //--------------------------------------------------------------
007900111128       //?M A I N - L I N E                                            ?
008000111128       //--------------------------------------------------------------
008100111128
008200111128      /free
008300111128
008400111128       // -?Operazioni iniziali?
008500111128       exsr  sr_RoutInz;
008600111128
008700111128       // -?Estrazione loghi non utilizzati?
008800111128       DoW  sqlCode = *zero;
008900111128         exsr  sr_ReadCursor;
009000111128       EndDo;
009100111128
009200111128       // -?Operazioni finali?
009300111128       exsr  sr_RoutEnd;
009400111128
009500111128       //--------------------------------------------------------------
009600111128       //?Operazioni iniziali.                                         ?
009700111128       //--------------------------------------------------------------
009800111128       BEGSR sr_RoutInz;
009900111128
010000111128         *inLR = *on;
010100111128
010200111128         // -?Impostazione opzioni per SQL?
010300111128         exec SQL   set option   DynUsrPrf = *owner,
010400111128                                 CloSqlCsr = *endmod;
010500111128
010600111128         // -?Creazione stringa SQL da eseguire?
010700160406         wSQL = 'select VSSsun ' +
010800160406                  ' from TIVSS00F ' +
010900160406                ' where substr(VSSksu, 2, 3) <> ''102'' ' +
011000160406                  ' and substr(VSSsun, 1, 1) = ''0'' ' +
011100160406                  ' and VSSisv = ''TT'' ' +
011200160406                  ' and VSSsun not in (select VSSsun ' +
011300160406                  ' from TIVSS00F where VSSisv = ''T1'') ' +
011400160406                  ' order by VSSsun ';
011500111128
011600111128         // -?Apertura cursore?
011700111128         exsr  sr_OpenCursor;
011800111128
011900111128       ENDSR;
012000111128
012100111128       //--------------------------------------------------------------
012200111128       //?Apertura cursore C1.                                         ?
012300111128       //--------------------------------------------------------------
012400111128       BEGSR  sr_OpenCursor;
012500111128
012600111128         // -?Dichiarazione del cursore?
012700111128         exec sql  prepare S1  from :wSQL;
012800111128         exec sql  declare C1  cursor for S1;
012900111128
013000111128         // -?Apertura del cursore?
013100111128         exec sql   open C1;
013200111128
013300111128       ENDSR;
013400111128
013500111128       //--------------------------------------------------------------
013600111128       //?Chiusura cursore C1.                                         ?
013700111128       //--------------------------------------------------------------
013800111128       BEGSR  sr_CloseCursor;
013900111128
014000111128         // -?Chiusura del cursore?
014100111128         exec sql   close C1;
014200111128
014300111128       ENDSR;
014400111128
014500111128       //--------------------------------------------------------------
014600111128       //?Lettura cursore C1.                                          ?
014700111128       //--------------------------------------------------------------
014800111128       BEGSR  sr_ReadCursor;
014900111128
015000111128         clear  wVSSsun;
015100111128
015200111128         exec sql  fetch next  from C1  into :wVSSsun;
015300111128
015400111128         select;
015500111128
015600111128           // -?Fine lettura?
015700111128           when  sqlCode = 100;
015800111128             exsr  sr_RoutEnd;
015900111128
016000111128           // -?Errore?
016100111128           when  sqlCode < *zero;
016200111128             exsr  sr_PrintErr;
016300111128
016400111128           // -?Elaborazione?
016500111128           other;
016600111128             exsr  sr_ElabRec;
016700111128
016800111128         endsl;
016900111128
017000111128       ENDSR;
017100111128
017200111128       //--------------------------------------------------------------
017300111128       //?Elaborazione singolo record estratto.                        ?
017400111128       //--------------------------------------------------------------
017500111128       BEGSR  sr_ElabRec;
017600111128
017700111128         // -?Impostazione ed esecuzione del comando remoto?
017800111128         Qcmd = 'STRATEGI/CHGSGIUSR ' + wVSSsun +
017900160407                                      ' ALWSPOOL(*NO)';
018000111128
018100111128         callp(E)  TIS730C ( Qcmd );
018200111128
018300111128         // -?Impostazione ed esecuzione del comando remoto?
018400160406         // Qcmd = 'DLTOUTQ OUTQ(STRATEGI/' + 'S' + wVSSsun + ')';
018500111128
018600160406         // callp(E)  TIS730C ( Qcmd );
018700111128
018800111128       ENDSR;
018900111128
019000111128       //--------------------------------------------------------------
019100111128       //?Esecuzione del comando (già impostato).                      ?
019200111128       //--------------------------------------------------------------
019300111128       BEGSR  sr_ExecCmd;
019400111128
019500111128         clear Qcap0100;
019600111128         Qcabcsdh = *off;
019700111128         Qcapa    = *off;
019800111128         Qcacmdss = *off;
019900111128         Qcaerved = *allX'00';
020000111128
020100111128         clear Qusec;
020200111128         Qusbprv  = %size(Qusec);
020300111128
020400111128         ProcessCommands ( Qcmd : %len( %trimr( Qcmd ) ) : Qcap0100 :
020500111128                           %size(Qcap0100) : 'CPOP0100' : *omit :
020600111128                           0 : 0 : Qusec);
020700111128
020800111128         // -?Stampa DUMP + JobLog  &  Chiusura *pgm  in caso di errore?
020900111128         if  Qusei <> *blank;
021000111128           exsr  sr_PrintErr;
021100111128         endif;
021200111128
021300111128       ENDSR;
021400111128
021500111128       //--------------------------------------------------------------
021600111128       //?Stampa segnalazione dell'errore rilevato.                    ?
021700111128       //--------------------------------------------------------------
021800111128       BEGSR  sr_PrintErr;
021900111128
022000111128         // -?Stampa del Dump?
022100111128         Dump(A);
022200111128
022300111128         // -?Stampa del Job-Log?
022400111128         Qcmd = 'DSPJOBLOG job(*) output(*print)';
022500111128         exsr  sr_ExecCmd;
022600111128
022700111128         // -?Chiusura del programma?
022800111128         exsr  sr_RoutEnd;
022900111128
023000111128       ENDSR;
023100111128
023200111128       //--------------------------------------------------------------
023300111128       //?Operazioni finali.                                           ?
023400111128       //--------------------------------------------------------------
023500111128       BEGSR  sr_RoutEnd;
023600111128
023700111128         // -?Chiusura cursore?
023800111128         exsr  sr_CloseCursor;
023900111128
024000111128         // -?Uscita?
024100111128         return;
024200111128
024300111128       ENDSR;
024400111128
024500111128      /end-free
