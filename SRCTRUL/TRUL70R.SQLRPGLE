000100151015       //==============================================================
000200151015       //?Verifica se C.F. di Pubblica Amministrazione.                ?
000300151015       //==============================================================
000400151015
000500151015       //--------------------------------------------------------------
000600151015       //?Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700151015       //--------------------------------------------------------------
000800151015
000900151015     /*PRM  dbgview(*source)
001000151015     /*END
001100151015
001200151015       //--------------------------------------------------------------
001300151015       //?Specifiche di controllo.                                     ?
001400151015       //--------------------------------------------------------------
001500151015
001600151015     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001700151015     h dftactgrp(*no) actgrp(*caller)
001800151016     h alwnull(*inputonly)
001900151015
002000151015       //--------------------------------------------------------------
002100151015       //?Dichiarazione file.                                          ?
002200151015       //--------------------------------------------------------------
002300151015
002400151015
002500151015       //--------------------------------------------------------------
002600151015       //?Definizione costanti.                                        ?
002700151015       //--------------------------------------------------------------
002800151015
002900151015
003000151015       //--------------------------------------------------------------
003100151015       //?Definizione schiere.                                         ?
003200151015       //--------------------------------------------------------------
003300151015
003400151015
003500151015       //--------------------------------------------------------------
003600151015       //?Definizione aree dati.                                       ?
003700151015       //--------------------------------------------------------------
003800151015
003900151015
004000151015       //--------------------------------------------------------------
004100151015       //?Definizione strutture dati.                                  ?
004200151015       //--------------------------------------------------------------
004300151015
004400151015       // -?Parametri ricevuti?
004500151016     d trul70ds      e ds
004600160923     d AZIPAds       e ds                  qualified
004700160923     d                                     extname(AZIPA00F)
004800151016
004900151016       // -?Dati elaborati via SQL?
005000160923     d AZIPA_ds      e ds                  qualified
005100160923     d                                     extname(AZIPA00F)  inz
005200151015
005300151015       //--------------------------------------------------------------
005400151015       //?Definizione variabili globali.                               ?
005500151015       //--------------------------------------------------------------
005600151015
005700151016       // -?Flags booleani?
005800151016     d $EoF            s               n   inz
005900151016
006000151016       // -?Stringa SQL da eseguire?
006100151016     d wSQL            s           5000    inz  varying
006200151015
006300151015       //--------------------------------------------------------------
006400151015       //?Definizione prototipi procedure.                             ?
006500151015       //--------------------------------------------------------------
006600151015
006700151016       // -?Parametri API QCAPCMD (Process Commands)?
006800151016     d Qcmd            s           2048    inz  varying
006900151016      /copy qSysInc/qRpgleSrc,QCAPCMD
007000151016       // -?API QCAPCMD (Process Commands)?
007100151016      /copy gaitrasrc/srcProtoPR,QCAPCMD
007200151016
007300151016       // -?Parametri gestione errori API.?
007400151016      /copy qsysinc/qrpglesrc,QUSEC
007500151015
007600151015       //--------------------------------------------------------------
007700151015       //?Definizione key-list.                                        ?
007800151015       //--------------------------------------------------------------
007900151015
008000151015
008100151015       //--------------------------------------------------------------
008200151015       //?M A I N - L I N E                                            ?
008300151015       //--------------------------------------------------------------
008400151015
008500151015     c     *Entry        plist
008600151016     c                   parm                    trul70ds
008700160923     c                   parm                    AZIPAds
008800151015
008900151015      /free
009000151015
009100151015       // -?Operazioni iniziali?
009200151015       exsr  sr_RoutInz;
009300151015
009400151015       // -?Verifica SE Codice Fiscale di Pubblica Amministrazione?
009500151015       exsr  sr_Ctrl_CF_PA;
009600151015
009700151015       // -?Operazioni finali?
009800151015       exsr  sr_RoutEnd;
009900151015
010000151015       //--------------------------------------------------------------
010100151015       //?Operazioni iniziali.                                         ?
010200151015       //--------------------------------------------------------------
010300151015       BEGSR  sr_RoutInz;
010400151015
010500151016         // -?Impostazione opzioni per SQL?
010600151016         exec sql   set  option  DynUsrPrf = *Owner,
010700151016                                 CloSqlCsr = *EndMod;
010800151016
010900151016         // -?Impostazione chiusura?
011000151015         *inLR = *on;
011100151015
011200151016         // -?Pulizia parametri di output?
011300151016         clear  oUL70esi;
011400160923         clear  oUL70cf;
011500151016         clear  oUL70cod;
011600151016         clear  oUL70uff;
011700160923         clear  oUL70piu;
011800160923         if  %parms() > 1;
011900160923           clear  AZIPAds;
012000160923         endif;
012100151016
012200151016         // -?Controllo dei parametri ricevuti?
012300151016         select;
012400160923           when  iUL70cf  = *blank  and
012500160923                 iUL70cod = *blank  and
012600160923                 iUL70uff = *blank;
012700151016             oUL70esi = 'E';
012800160923           when  iUL70cf <> *blank  and
012900160923                 %len( %trim( iUL70cf ) ) <> %size( iUL70cf );
013000151016             oUL70esi = 'E';
013100151016         endsl;
013200151015
013300151015       ENDSR;
013400151015
013500151015       //--------------------------------------------------------------
013600151015       //?Verifica SE Codice Fiscale di Pubblica Amministrazione.      ?
013700151015       //--------------------------------------------------------------
013800151015       BEGSR  sr_Ctrl_CF_PA;
013900151015
014000151016         clear  $EoF;
014100151016
014200151016         // -?Preparazione SQL per estrazione dati?
014300151016         exsr  sr_PrepSQL;
014400151016
014500151016         // -?Estrazione dati?
014600151016         exsr  sr_OpenCursor;
014700151016
014800151016         DoW  Not $EoF;
014900151016           exsr  sr_ReadCursor;
015000151016         EndDo;
015100151016
015200151016         exsr  sr_CloseCursor;
015300151015
015400151015       ENDSR;
015500151016
015600151016       //--------------------------------------------------------------
015700151016       //?Preparazione SQL.                                            ?
015800151016       //--------------------------------------------------------------
015900151016       BEGSR  sr_PrepSQL;
016000151016
016100151016         // -?Preparazione SQL?
016200151016         clear  wSQL;
016300160923         wSQL = 'select * +
016400160923                   from AZIPA00F +
016500160923                  where';
016600160923
016700160923         if  iUL70cf  > *blank;
016800160923           wSQL +=    ' IPAcf = ''' + iUL70cf + '''';
016900160923         endif;
017000160923
017100160923         if  iUL70cod > *blank;
017200160923           if  iUL70cf  > *blank;
017300160923             wSQL +=  ' and';
017400160923           endif;
017500160923           wSQL +=    ' IPAcod = ''' + iUL70cod + '''';
017600160923         endif;
017700160923
017800160923         if  iUL70uff > *blank;
017900160923           if  iUL70cf  > *blank  or  iUL70cod > *blank;
018000160923             wSQL +=  ' and';
018100160923           endif;
018200160923           wSQL +=    ' IPAuff = ''' + iUL70uff + '''';
018300160923         endif;
018400160923
018500160923         wSQL +=    ' +
018600160923                  order by IPAcf, IPAcod, IPAuff +
018700151016                    for fetch only';
018800151016
018900151016         exec sql   prepare S1   from :wSQL;
019000151016
019100151016         // -?Dichiarazione cursore?
019200151016         exec sql   declare C1   cursor for S1;
019300151016
019400151016         if  SQLcode < *zero;
019500151016           exsr  sr_PrintErr;
019600151016         endif;
019700151016
019800151016       ENDSR;
019900151016
020000151016       //--------------------------------------------------------------
020100151016       //?Apertura cursore.                                            ?
020200151016       //--------------------------------------------------------------
020300151016       BEGSR  sr_OpenCursor;
020400151016
020500151016         // -?Apertura del cursore?
020600151016         exec sql   open C1;
020700151016
020800151016         if  SQLcode < *zero;
020900151016           exsr  sr_PrintErr;
021000151016         endif;
021100151016
021200151016       ENDSR;
021300151016
021400151016       //--------------------------------------------------------------
021500151016       //?Lettura cursore.                                             ?
021600151016       //--------------------------------------------------------------
021700151016       BEGSR  sr_ReadCursor;
021800151016
021900151016         clear  AZIPA_ds;
022000151016
022100160923         exec sql   fetch next   from C1   into :AZIPA_ds;
022200151016
022300151016         Select;
022400151016
022500151016           // -?Fine File?
022600151016           When  SQLcode = 100;
022700151016             $EoF = *on;
022800151016             leavesr;
022900151016
023000151016           // -?Errore SQL?
023100151016           When  SQLcode < *zero;
023200151016             exsr  sr_PrintErr;
023300151016
023400151016           // -?Elaborazione singolo record?
023500151016           Other;
023600151016             exsr  sr_Elab_CF;
023700151016
023800151016         EndSl;
023900151016
024000151016       ENDSR;
024100151016
024200151016       //--------------------------------------------------------------
024300151016       //?Chiusura cursore.                                            ?
024400151016       //--------------------------------------------------------------
024500151016       BEGSR  sr_CloseCursor;
024600151016
024700151016         // -?Chiusura del cursore?
024800151016         exec sql   close C1;
024900151016
025000151016       ENDSR;
025100151016
025200151016       //--------------------------------------------------------------
025300151016       //?Elaborazione singolo record di AZIPA00F.                     ?
025400151016       //--------------------------------------------------------------
025500151016       BEGSR  sr_Elab_CF;
025600151016
025700160923         // -?1° ufficio reperito?
025800151016         if  oUL70esi = *blank;
025900151016           oUL70esi = *on;
026000160923           oUL70cf  = AZIPA_ds.IPAcf;
026100160923           oUL70cod = AZIPA_ds.IPAcod;
026200160923           oUL70uff = AZIPA_ds.IPAuff;
026300160923           if  %parms() > 1;
026400160923             AZIPAds = AZIPA_ds;
026500160923           endif;
026600160923         // -?Altro ufficio reperito?
026700151016         else;
026800160916           oUL70piu = '+';
026900151016           $EoF = *on;
027000151016         endif;
027100151016
027200151016       ENDSR;
027300151016
027400151016       //--------------------------------------------------------------
027500151016       //?Stampa segnalazione dell'errore rilevato via SQL             ?
027600151016       //--------------------------------------------------------------
027700151016       BEGSR  sr_PrintErr;
027800151016
027900151016         oUL70esi = 'E';
028000151016
028100151016         // -?Stampa del Dump?
028200151016         Dump(A);
028300151016
028400151016         // -?Stampa del Job-Log?
028500151016         Qcmd = 'DSPJOBLOG job(*) output(*print)';
028600151016         exsr  sr_ExecCmd;
028700151016
028800151016         // -?Chiusura del programma?
028900151016         exsr  sr_RoutEnd;
029000151016
029100151016       ENDSR;
029200151016
029300151016       //--------------------------------------------------------------
029400151016       //?Esecuzione del comando (già impostato).                      ?
029500151016       //--------------------------------------------------------------
029600151016       BEGSR  sr_ExecCmd;
029700151016
029800151016         clear Qcap0100;
029900151016         Qcabcsdh = *off;
030000151016         Qcapa    = *off;
030100151016         Qcacmdss = *off;
030200151016         Qcaerved = *allX'00';
030300151016
030400151016         clear Qusec;
030500151016         Qusbprv  = %size(Qusec);
030600151016
030700151016         ProcessCommands ( Qcmd : %size(Qcmd) : Qcap0100 :
030800151016                           %size(Qcap0100) : 'CPOP0100' : *omit :
030900151016                           0 : 0 : Qusec);
031000151016
031100151016         //if  Qusei <> *blank;
031200151016         //  ...;
031300151016         //endif;
031400151016
031500151016       ENDSR;
031600151015
031700151015       //--------------------------------------------------------------
031800151015       //?Operazioni finali.                                           ?
031900151015       //--------------------------------------------------------------
032000151015       BEGSR  sr_RoutEnd;
032100151015
032200151015         return;
032300151015
032400151015       ENDSR;
032500151015
032600151015      /end-free
