000100151015       //==============================================================
000200151015       //?Verifica se C.F. di Pubblica Amministrazione.                ?
000300151015       //==============================================================
000400151015
000500151015       //--------------------------------------------------------------
000600151015       //?Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700151015       //--------------------------------------------------------------
000800151015
000900151015     /*PRM  dbgview(*source)
001000151015     /*END
001100151015
001200151015       //--------------------------------------------------------------
001300151015       //?Specifiche di controllo.                                     ?
001400151015       //--------------------------------------------------------------
001500151015
001600151015     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001700151015     h dftactgrp(*no) actgrp(*caller)
001800151016     h alwnull(*inputonly)
001900151015
002000151015       //--------------------------------------------------------------
002100151015       //?Dichiarazione file.                                          ?
002200151015       //--------------------------------------------------------------
002300151015
002400151015
002500151015       //--------------------------------------------------------------
002600151015       //?Definizione costanti.                                        ?
002700151015       //--------------------------------------------------------------
002800151015
002900151015
003000151015       //--------------------------------------------------------------
003100151015       //?Definizione schiere.                                         ?
003200151015       //--------------------------------------------------------------
003300151015
003400151015
003500151015       //--------------------------------------------------------------
003600151015       //?Definizione aree dati.                                       ?
003700151015       //--------------------------------------------------------------
003800151015
003900151015
004000151015       //--------------------------------------------------------------
004100151015       //?Definizione strutture dati.                                  ?
004200151015       //--------------------------------------------------------------
004300151015
004400151015       // -?Parametri ricevuti?
004500151016     d trul70ds      e ds
004600151016
004700151016       // -?Dati elaborati via SQL?
004800151016     d AZIPA_ds      e ds                  extname(AZIPA00F)  inz
004900151015
005000151015       //--------------------------------------------------------------
005100151015       //?Definizione variabili globali.                               ?
005200151015       //--------------------------------------------------------------
005300151015
005400151016       // -?Flags booleani?
005500151016     d $EoF            s               n   inz
005600151016
005700151016       // -?Stringa SQL da eseguire?
005800151016     d wSQL            s           5000    inz  varying
005900151015
006000151015       //--------------------------------------------------------------
006100151015       //?Definizione prototipi procedure.                             ?
006200151015       //--------------------------------------------------------------
006300151015
006400151016       // -?Parametri API QCAPCMD (Process Commands)?
006500151016     d Qcmd            s           2048    inz  varying
006600151016      /copy qSysInc/qRpgleSrc,QCAPCMD
006700151016       // -?API QCAPCMD (Process Commands)?
006800151016      /copy gaitrasrc/srcProtoPR,QCAPCMD
006900151016
007000151016       // -?Parametri gestione errori API.?
007100151016      /copy qsysinc/qrpglesrc,QUSEC
007200151015
007300151015       //--------------------------------------------------------------
007400151015       //?Definizione key-list.                                        ?
007500151015       //--------------------------------------------------------------
007600151015
007700151015
007800151015       //--------------------------------------------------------------
007900151015       //?M A I N - L I N E                                            ?
008000151015       //--------------------------------------------------------------
008100151015
008200151015     c     *Entry        plist
008300151016     c                   parm                    trul70ds
008400151015
008500151015      /free
008600151015
008700151015       // -?Operazioni iniziali?
008800151015       exsr  sr_RoutInz;
008900151015
009000151015       // -?Verifica SE Codice Fiscale di Pubblica Amministrazione?
009100151015       exsr  sr_Ctrl_CF_PA;
009200151015
009300151015       // -?Operazioni finali?
009400151015       exsr  sr_RoutEnd;
009500151015
009600151015       //--------------------------------------------------------------
009700151015       //?Operazioni iniziali.                                         ?
009800151015       //--------------------------------------------------------------
009900151015       BEGSR  sr_RoutInz;
010000151015
010100151016         // -?Impostazione opzioni per SQL?
010200151016         exec sql   set  option  DynUsrPrf = *Owner,
010300151016                                 CloSqlCsr = *EndMod;
010400151016
010500151016         // -?Impostazione chiusura?
010600151015         *inLR = *on;
010700151015
010800151016         // -?Pulizia parametri di output?
010900151016         clear  oUL70esi;
011000151016         clear  oUL70cod;
011100151016         clear  oUL70cuo;
011200151016         clear  oUL70uff;
011300151016
011400151016         // -?Controllo dei parametri ricevuti?
011500151016         select;
011600151016           when  iUL70cf = *blank;
011700151016             oUL70esi = 'E';
011800151016           when  %len( %trim( iUL70cf ) ) <> %size( iUL70cf );
011900151016             oUL70esi = 'E';
012000151016         endsl;
012100151015
012200151015       ENDSR;
012300151015
012400151015       //--------------------------------------------------------------
012500151015       //?Verifica SE Codice Fiscale di Pubblica Amministrazione.      ?
012600151015       //--------------------------------------------------------------
012700151015       BEGSR  sr_Ctrl_CF_PA;
012800151015
012900151016         clear  $EoF;
013000151016
013100151016         // -?Preparazione SQL per estrazione dati?
013200151016         exsr  sr_PrepSQL;
013300151016
013400151016         // -?Estrazione dati?
013500151016         exsr  sr_OpenCursor;
013600151016
013700151016         DoW  Not $EoF;
013800151016           exsr  sr_ReadCursor;
013900151016         EndDo;
014000151016
014100151016         exsr  sr_CloseCursor;
014200151015
014300151015       ENDSR;
014400151016
014500151016       //--------------------------------------------------------------
014600151016       //?Preparazione SQL.                                            ?
014700151016       //--------------------------------------------------------------
014800151016       BEGSR  sr_PrepSQL;
014900151016
015000151016         // -?Preparazione SQL?
015100151016         clear  wSQL;
015200151016         wSQL = 'select * +
015300151016                   from AZIPA00F +
015400151016                  where IPAcf = ''' + iUL70cf + ''' +
015500160916               order by IPAaoo, IPAuoCod, IPAuff +
015600151016                    for fetch only';
015700151016
015800151016         exec sql   prepare S1   from :wSQL;
015900151016
016000151016         // -?Dichiarazione cursore?
016100151016         exec sql   declare C1   cursor for S1;
016200151016
016300151016         if  SQLcode < *zero;
016400151016           exsr  sr_PrintErr;
016500151016         endif;
016600151016
016700151016       ENDSR;
016800151016
016900151016       //--------------------------------------------------------------
017000151016       //?Apertura cursore.                                            ?
017100151016       //--------------------------------------------------------------
017200151016       BEGSR  sr_OpenCursor;
017300151016
017400151016         // -?Apertura del cursore?
017500151016         exec sql   open C1;
017600151016
017700151016         if  SQLcode < *zero;
017800151016           exsr  sr_PrintErr;
017900151016         endif;
018000151016
018100151016       ENDSR;
018200151016
018300151016       //--------------------------------------------------------------
018400151016       //?Lettura cursore.                                             ?
018500151016       //--------------------------------------------------------------
018600151016       BEGSR  sr_ReadCursor;
018700151016
018800151016         clear  AZIPA_ds;
018900151016
019000151016         exec sql   fetch next   from C1   into :AZIPA_ds;
019100151016
019200151016         Select;
019300151016
019400151016           // -?Fine File?
019500151016           When  SQLcode = 100;
019600151016             $EoF = *on;
019700151016             leavesr;
019800151016
019900151016           // -?Errore SQL?
020000151016           When  SQLcode < *zero;
020100151016             exsr  sr_PrintErr;
020200151016
020300151016           // -?Elaborazione singolo record?
020400151016           Other;
020500151016             exsr  sr_Elab_CF;
020600151016
020700151016         EndSl;
020800151016
020900151016       ENDSR;
021000151016
021100151016       //--------------------------------------------------------------
021200151016       //?Chiusura cursore.                                            ?
021300151016       //--------------------------------------------------------------
021400151016       BEGSR  sr_CloseCursor;
021500151016
021600151016         // -?Chiusura del cursore?
021700151016         exec sql   close C1;
021800151016
021900151016       ENDSR;
022000151016
022100151016       //--------------------------------------------------------------
022200151016       //?Elaborazione singolo record di AZIPA00F.                     ?
022300151016       //--------------------------------------------------------------
022400151016       BEGSR  sr_Elab_CF;
022500151016
022600160916         // -?1° ufficio reperito con quella P.I.?
022700151016         if  oUL70esi = *blank;
022800151016           oUL70esi = *on;
022900151016           oUL70cod = IPAcod;
023000151016           oUL70cuo = IPAuoCod;
023100151016           oUL70uff = IPAuff;
023200160916         // -?Altro ufficio reperito con quella P.I.?
023300151016         else;
023400160916           oUL70piu = '+';
023500151016           $EoF = *on;
023600151016         endif;
023700151016
023800151016       ENDSR;
023900151016
024000151016       //--------------------------------------------------------------
024100151016       //?Stampa segnalazione dell'errore rilevato via SQL             ?
024200151016       //--------------------------------------------------------------
024300151016       BEGSR  sr_PrintErr;
024400151016
024500151016         oUL70esi = 'E';
024600151016
024700151016         // -?Stampa del Dump?
024800151016         Dump(A);
024900151016
025000151016         // -?Stampa del Job-Log?
025100151016         Qcmd = 'DSPJOBLOG job(*) output(*print)';
025200151016         exsr  sr_ExecCmd;
025300151016
025400151016         // -?Chiusura del programma?
025500151016         exsr  sr_RoutEnd;
025600151016
025700151016       ENDSR;
025800151016
025900151016       //--------------------------------------------------------------
026000151016       //?Esecuzione del comando (già impostato).                      ?
026100151016       //--------------------------------------------------------------
026200151016       BEGSR  sr_ExecCmd;
026300151016
026400151016         clear Qcap0100;
026500151016         Qcabcsdh = *off;
026600151016         Qcapa    = *off;
026700151016         Qcacmdss = *off;
026800151016         Qcaerved = *allX'00';
026900151016
027000151016         clear Qusec;
027100151016         Qusbprv  = %size(Qusec);
027200151016
027300151016         ProcessCommands ( Qcmd : %size(Qcmd) : Qcap0100 :
027400151016                           %size(Qcap0100) : 'CPOP0100' : *omit :
027500151016                           0 : 0 : Qusec);
027600151016
027700151016         //if  Qusei <> *blank;
027800151016         //  ...;
027900151016         //endif;
028000151016
028100151016       ENDSR;
028200151015
028300151015       //--------------------------------------------------------------
028400151015       //?Operazioni finali.                                           ?
028500151015       //--------------------------------------------------------------
028600151015       BEGSR  sr_RoutEnd;
028700151015
028800151015         return;
028900151015
029000151015       ENDSR;
029100151015
029200151015      /end-free
