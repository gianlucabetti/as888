000100141120       //==============================================================
000200141120       //?TEST - Scrittura Nuovo rcd per Prezzo MEDIO Gasolio (VMA).   ?
000300141120       //==============================================================
000400141120
000500141120     h decedit('0,') datedit(*dmy/) option(*nodebugio)
000600141120     h dftactgrp(*no)
000700141120
000800141120       //--------------------------------------------------------------
000900141120       //?Dichiarazione file.                                          ?
001000141120       //--------------------------------------------------------------
001100141120
001200141120       // -?Video?
001300141120     fTRULDPBTSDcf   e             workstn
001400141120     f                                     indds(IndDspF)
001500141120     f                                     infds(InfDspF)
001600141120
001700141120       //--------------------------------------------------------------
001800141120       //?Definizione costanti.                                        ?
001900141120       //--------------------------------------------------------------
002000141120
002100141120       // -?Tasti funzionali a video?
002200141120     d c_F01           c                   const(x'31')
002300141120     d c_F02           c                   const(x'32')
002400141120     d c_F03           c                   const(x'33')
002500141120     d c_F04           c                   const(x'34')
002600141120     d c_F05           c                   const(x'35')
002700141120     d c_F06           c                   const(x'36')
002800141120     d c_F07           c                   const(x'37')
002900141120     d c_F08           c                   const(x'38')
003000141120     d c_F09           c                   const(x'39')
003100141120     d c_F10           c                   const(x'3A')
003200141120     d c_F11           c                   const(x'3B')
003300141120     d c_F12           c                   const(x'3C')
003400141120     d c_F13           c                   const(x'B1')
003500141120     d c_F14           c                   const(x'B2')
003600141120     d c_F15           c                   const(x'B3')
003700141120     d c_F16           c                   const(x'B4')
003800141120     d c_F17           c                   const(x'B5')
003900141120     d c_F18           c                   const(x'B6')
004000141120     d c_F19           c                   const(x'B7')
004100141120     d c_F20           c                   const(x'B8')
004200141120     d c_F21           c                   const(x'B9')
004300141120     d c_F22           c                   const(x'BA')
004400141120     d c_F23           c                   const(x'BB')
004500141120     d c_F24           c                   const(x'BC')
004600141120     d c_Enter         c                   const(x'F1')
004700141120     d c_RollDown      c                   const(x'F4')
004800141120     d c_RollUp        c                   const(x'F5')
004900141120
005000141120       //--------------------------------------------------------------
005100141120       //?Definizione schiere.                                         ?
005200141120       //--------------------------------------------------------------
005300141120
005400141120
005500141120       //--------------------------------------------------------------
005600141120       //?Definizione aree dati.                                       ?
005700141120       //--------------------------------------------------------------
005800141120
005900141120       // -?Dati utente?
006000141120     d §AzUte        e ds                  extname(AZUTE00F)
006100141120     d                                     dtaara
006200141120     d §DatiUte      e ds                  extname(dDatiUte)
006300141120     d                                     dtaara
006400141120
006500141120       //--------------------------------------------------------------
006600141120       //?Definizione strutture dati.                                  ?
006700141120       //--------------------------------------------------------------
006800141120
006900141120       // -?Status ds?
007000141120     d Status         sds
007100141120     d   SDSpgm          *proc
007200141120     d   SDSprm          *parms
007300141120     d   SDSusr              254    263
007400141120
007500141120       // -?InfDS?
007600141120     d InfDspF         ds
007700141120     d   dsp_aid             369    369a
007800141120
007900141120       // -?Indicatori su DspF?
008000141120     d IndDspF         ds
008100141120         // -?Abilitazione tasti funzionali?
008200141120     d   F6Attivo                      n   overlay(IndDspF : 06)
008300141120     d   F12Attivo                     n   overlay(IndDspF : 12)
008400141120         // -?Emissione messaggio di errore?
008500141120     d   ErrMessage                    n   overlay(IndDspF : 28)
008600141120         // -?Riemissione videata?
008700141120     d   ErrGenerico                   n   overlay(IndDspF : 99)
008800141120
008900141120       // -?Kpjba?
009000141120     d kpjba         e ds                  qualified
009100141120
009200141120       //--------------------------------------------------------------
009300141120       //?Definizione variabili globali.                               ?
009400141120       //--------------------------------------------------------------
009500141120
009600141120       // -?Flags booleani?
009700141120     d wFine           s               n   inz(*off)
009800141120     d wInzD01         s               n   inz(*on)
009900141120
010000141120       //--------------------------------------------------------------
010100141120       //?Definizione procedure usate.                                 ?
010200141120       //--------------------------------------------------------------
010300141120
010400141120      // - File Date
010500141120     d DATECNV0F     e ds                  extname(DATECNV0F)
010600141120
010700141120       // -?Reperimento dati utente?
010800141120     d TIBS34ds      e ds
010900141120      /copy gaitrasrc/srcProtoPR,TIBS34R
011000141120
011100141120       // -?Recupero Data/Scaglione da Prezzo gasolio?
011200141120     d TRULDPBDS     e ds                  inz
011300141120     d TRULDPBR        pr                  extpgm('TRULDPBR')
011400141120     d   kpjba                             likeds(KPJBA)
011500141120     d   truldpbds                         likeds(TRULDPBDS)
011600141120
011700141120       //--------------------------------------------------------------
011800141120       //?Definizione key-list.                                        ?
011900141120       //--------------------------------------------------------------
012000141120
012100141120
012200141120       //--------------------------------------------------------------
012300141120       //?Riepilogo indicatori.                                        ?
012400141120       //--------------------------------------------------------------
012500141120
012600141120
012700141120       //--------------------------------------------------------------
012800141120       //?M A I N - L I N E .                                          ?
012900141120       //--------------------------------------------------------------
013000141120
013100141120     c     *Entry        plist
013200141120     c                   parm                    KPJBA
013300141120
013400141120      /free
013500141120
013600141120       // -?Start?
013700141120       exsr RoutInz;
013800141120
013900141120       // -?Elab?
014000141120       DOW  not wFine;
014100141120         exsr GesD01;
014200141120       ENDDO;
014300141120
014400141120       // -?End?
014500141120       return;
014600141120
014700141120       //--------------------------------------------------------------
014800141120       //?Operazioni iniziali.                                         ?
014900141120       //--------------------------------------------------------------
015000141120       BEGSR  RoutInz;
015100141120
015200141120         // -?Reperimento dati job?
015300141120         exsr DatiJob;
015400141120
015500141120         *inLR = *on;
015600141120
015700141120       ENDSR;
015800141120
015900141120       //--------------------------------------------------------------
016000141120       //?Reperimento Dati del job (Utente/Operativi).
016100141120       //--------------------------------------------------------------
016200141120       BEGSR DatiJob;
016300141120
016400141120         in(E) §AzUte;
016500141120         IF  NOT %error;
016600141120           in(E) §DatiUte;
016700141120         ENDIF;
016800141120         IF  %error or RSut = *blanks;
016900141120           clear TIBS34ds;
017000141120           tibs34r(tibs34ds);
017100141120           in §AzUte;
017200141120           in §DatiUte;
017300141120         ENDIF;
017400141120
017500141120       ENDSR;
017600141120
017700141120       //--------------------------------------------------------------
017800141120       //?Gestione videata D01.
017900141120       //--------------------------------------------------------------
018000141120       BEGSR GesD01;
018100141120
018200140218         // -?Inizializzazione videata?
018300141120         IF  wInzD01;
018400141120           clear TADPBD1;
018500141120           wInzD01 = *off;
018600141120         ENDIF;
018700141120
018800141120         F6Attivo  = *on;
018900141120         F12Attivo = *off;
019000141120
019100141120         // -?Emissione videata?
019200141120         IF  not ErrMessage;
019300141120           write TADPBT1;
019400141120           write TADPBZ1;
019500141120         ENDIF;
019600141120         exfmt TADPBD1;
019700141120
019800141120         reset  ErrMessage;
019900141120         reset  ErrGenerico;
020000141120         clear  V1Dmsg;
020100141120
020200141120         SELECT;
020300141120
020400141120           // -?F3=Fine?
020500141120           WHEN  dsp_aid = c_F03;
020600141120             wFine = *on;
020700141120
020800141120           // -?Invio o F6=Conferma?
020900141120           OTHER;
021000141120             exsr CtrD01;
021100141120             SELECT;
021200141120               // -?rilevato errore?
021300141120               WHEN  ErrGenerico;
021400141120               // -?non premuto F6?
021500141120               WHEN  dsp_aid <> c_F06;
021600141120               // -?richiamo da eseguire?
021700141120               OTHER;
021800141120                 exsr CallTRULDPBR;
021900141120             ENDSL;
022000141120
022100141120         ENDSL;
022200141120
022300141120       ENDSR;
022400141120
022500141120       //--------------------------------------------------------------
022600141120       //?Richiamo *pgm TRULDPBR.                                      ?
022700141120       //--------------------------------------------------------------
022800141120       BEGSR CallTRULDPBR;
022900141120
023000141120         clear datadpb;
023100141120
023200141120         // -?Richiamo *pgm TRULDPBR?
023300141120         TRULDPBR (kpjba:TRULDPBDS);
023400141120         exec sql
023500141120         set :datadpb =
023600141120              (select DC_DMYY_Z from DATECNV0F
023700141120               where DC_YYMD_Z = :ODPBdpb);
023800141120
023900141120         *in28  = (ODPBerr = 'E');
024000141120         V1Dmsg = ODPBmsg;
024100141120         F6Attivo  = *off;
024200141120         F12Attivo = *on;
024300141120
024400141120         write TADPBT1;
024500141120         write TADPBZ1;
024600141120         write TADPBD1;
024700141120         write Protect;
024800141120
024900141120         // -?Emissione 2ª videata (con il risultato)?
025000141120         DOU  dsp_aid = c_F03  or  dsp_aid = c_F12;
025100141120
025200141120           exfmt TADPBD2;
025300141120
025400141120           // -?F3=Fine?
025500141120           IF  dsp_aid = c_F03;
025600141120             WFine = *on;
025700141120           ENDIF;
025800141120
025900141120         ENDDO;
026000141120
026100141120       ENDSR;
026200141120
026300141120       //--------------------------------------------------------------
026400141120       //?Controllo dati in videata D01.                               ?
026500141120       //--------------------------------------------------------------
026600141120       BEGSR CtrD01;
026700141120
026800141120         %subst(IndDspF : 28) = *off;
026900141120
027000141120       ENDSR;
027100141120
027200141120      /end-free
