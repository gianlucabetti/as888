000100091228       //==============================================================
000200170515       // Reperimento Cliente Unificante
000300091228       //==============================================================
000400091228
000500091228
000600160202     **
000700160202     ** ISTRUZIONI PER LA COMPILAZIONE
000800160202     **
000900170515     ** 1. Creare il modulo UBBS10R   (Opz 15 PDM)
001000161017     **    indicando TGTRLS(*CURRENT) e CLOSQLCSR(*ENDACTGRP)
001100170522     **
001200170515     ** 2. Creare/Aggiornare il programma di servizio UBBS10R   (CRTSRVPGM / UPDSRVPGM)
001300170522     **    con ACTGRP(*caller)
001400170515     **      CRTSRVPGM SRVPGM(GAITRAOBJ/UBBS10R) EXPORT(*ALL)
001500170522     **            EXPORT(*SRCFILE) SRCFILE(GAITRASRC/SRCSRVPGM)
001600170522     **            TEXT('Driver Reperimento Cliente Unificante  ')
001700170522     **            TGTRLS(*CURRENT)
001800170522     **
001900170515     ** 3. Creare/Aggiornare il programma UBBS10R  (CRTPGM / UPDPGM)
002000160601     **    con ACTGRP(*caller), la BNDDIR non è importante tanto non chiama niente
002100170515     **      CRTPGM PGM(GAITRAOBJ/UBBS10R) ACTGRP(*CALLER)
002200170522     **                 TGTRLS(*CURRENT)
002300170522     **
002400161017     ** 4. Eventualmente si può cancellare il modulo.
002500160202     **
002600091228
002700091228       //--------------------------------------------------------------
002800121106       // Specifiche di controllo.
002900091228       //--------------------------------------------------------------
003000091223
003100091223     h decedit('0,') datedit(*dmy/) option(*nodebugio)
003200160601     h alwnull(*inputonly)
003300091223
003400091223       //--------------------------------------------------------------
003500121106       // Dichiarazione file.
003600091223       //--------------------------------------------------------------
003700170508
003800170508
003900170508       //--------------------------------------------------------------
004000170508       // Definizione prototipi
004100170508       //--------------------------------------------------------------
004200160218
004300160531
004400091223       //--------------------------------------------------------------
004500121106       // Definizione costanti.
004600091223       //--------------------------------------------------------------
004700100302
004800091223
004900091223       //--------------------------------------------------------------
005000121106       // Definizione schiere.
005100091223       //--------------------------------------------------------------
005200091223
005300091223
005400091223       //--------------------------------------------------------------
005500121106       // Definizione aree dati.
005600091223       //--------------------------------------------------------------
005700091223
005800091223
005900140724       //--------------------------------------------------------------
006000140724       // Definizione strutture dati.
006100140724       //--------------------------------------------------------------
006200091223
006300160802
006400091223       //--------------------------------------------------------------
006500121106       // Definizione variabili.
006600091223       //--------------------------------------------------------------
006700170515      /COPY GAITRASRC/SRCPROTOPI,UBBS10R
006800121106
006900121106       // Campi di comodo
007000161017     D wSQL            s           1024a   inz varying
007100170515     D wBS10DRF        s                   inz like(iBS10DRF)
007200170515     D wKUNCOP         s             11p 0 inz
007300170515     D wKUNORD         s              3a   inz
007400170515     D wApi            c                   const('''')
007500091223
007600160802
007700091223       //--------------------------------------------------------------
007800160603       // Definizione costanti.
007900091223       //--------------------------------------------------------------
008000130307
008100160531
008200160603       //--------------------------------------------------------------
008300160603       // Definizione prototipi procedure.
008400160603       //--------------------------------------------------------------
008500160603
008600160603
008700091223       //--------------------------------------------------------------
008800121106       // Definizione key-list.
008900091223       //--------------------------------------------------------------
009000091223
009100091223
009200091223       //--------------------------------------------------------------
009300121107       // Definizione parametri procedura.
009400091223       //--------------------------------------------------------------
009500091223
009600091223     c     *Entry        plist
009700170515     c                   parm                    iBS10DRF
009800170515     c                   parm                    iBS10TLE
009900170515     c                   parm                    iBS10CLI
010000170515     c                   parm                    oBS10Esito
010100170515     c                   parm                    oBS10COP
010200170515     c                   parm                    oBS10TIP
010300091223
010400130307      /free
010500091223
010600091223       //--------------------------------------------------------------
010700121106       // M A I N - L I N E
010800091223       //--------------------------------------------------------------
010900140806
011000160805       // Monitorizzo tutto (per necessità massima solidità stack chiamate)
011100160805       Monitor;
011200160805
011300130307       // Operazioni iniziali?
011400170508       exsr RoutInz;
011500130307
011600170515       // Verifica unificazioni
011700170515       exsr chkKUN;
011800160804
011900160805       // Fine monitoring
012000160805       On-Error;
012100170515          oBS10Esito = -1;
012200160921          exsr exeUscita;
012300160805       Endmon;
012400160805
012500160920       // Uscita
012600160921       exsr exeUscita;
012700160802
012800160802
012900160601       //--------------------------------------------------------------
013000160601       //
013100160601       //--------------------------------------------------------------
013200160601       BEGSR  *inzsr;
013300160601
013400160601         // Inizializzazioni parametri esecuzione comandi sql
013500160802         exec sql set option dynusrprf = *owner, closqlcsr = *endmod;
013600160601
013700160601       ENDSR;
013800091223
013900160802
014000091223       //--------------------------------------------------------------
014100121107       // Operazioni iniziali.
014200091223       //--------------------------------------------------------------
014300170508       BEGSR  RoutInz;
014400160601
014500160920         // Inizializzo l'esito a errore generico
014600170515         oBS10Esito = -1;
014700170511
014800170515         // Inizializzazione campi di work
014900170515         clear wKUNCOP;
015000170515         clear wKUNORD;
015100160608
015200160608         // Controllo i parametri di input
015300170508         exsr CtrlPIn;
015400160202
015500160202       ENDSR;
015600160802
015700160804
015800160202       //--------------------------------------------------------------
015900160202       // Controllo i parametri di input
016000160202       //--------------------------------------------------------------
016100170508       BEGSR  CtrlPIn;
016200170515
016300170515         // Se data di riferimento non specificata assumo DATA CORRENTE
016400170515         if iBS10DRF = *zeros;
016500170515            wBS10DRF = %dec(%date() : *iso);
016600170515         else;
016700170515            wBS10DRF = iBS10DRF;
016800170515         endif;
016900170508
017000170508         // I parametri fondamentali devono essere valorizzati
017100170515         if iBS10TLE = *blanks;
017200170515            oBS10Esito = -2;
017300170515            exsr exeUscita;
017400170515         endif;
017500170515         if iBS10CLI = *zeros;
017600170515            oBS10Esito = -2;
017700170515            exsr exeUscita;
017800170515         endif;
017900091223
018000091223       ENDSR;
018100121106
018200160802
018300091223       //--------------------------------------------------------------
018400160217       // Esecuzione
018500091223       //--------------------------------------------------------------
018600170515       BEGSR  chkKUN;
018700160531
018800170515         // Effettuo verifica sulle unificazioni secondo i parametri di input richiesti
018900170515         wSQL =
019000170515          'select kunCOP, kunORD from tikun13v where ' +
019100170515          'kunTLE = ' + wApi + iBS10TLE + wApi + ' and ' +
019200170515          %char(wBS10DRF) + ' between kunDDE and kunDSC and ' +
019300170515          'kunCOPF = ' + %char(iBS10CLI) ;
019400170515
019500170515         // Dichiarazione cursore
019600170515         exec sql   prepare S0   from :wSQL;
019700170515         exec sql   declare C0   cursor   for S0;
019800170515
019900170515         // Apro il cursore
020000170515         exec sql open C0;
020100170515
020200170515         // Leggo i dati
020300170515         exec sql
020400170515              fetch next from C0 into :wKUNCOP,
020500170515                                      :wKUNORD;
020600170515
020700170515         select;
020800170515           when sqlcod = *zeros;
020900170515             oBS10Esito = *zeros;
021000170515             oBS10COP = wKUNCOP;
021100170515             select;
021200170515               when %trim(wKUNORD) = '1';
021300170515                 oBS10TIP = 'P';
021400170515               when %trim(wKUNORD) = '2';
021500170515                 oBS10TIP = 'F';
021600170515               other;
021700170515                 oBS10TIP = %trim(wKUNORD);
021800170515             endsl;
021900170515           when sqlcod = 100;
022000170515             oBS10Esito = *zeros;
022100170515             clear oBS10COP;
022200170515             oBS10TIP = 'S';
022300170515           other;
022400170515             oBS10Esito = -1;
022500170515         endsl;
022600170515
022700170515         // Chiusura cursore
022800170515         exec sql close C0;
022900160217
023000160217       ENDSR;
023100160921
023200160921
023300160921       //--------------------------------------------------------------
023400160921       // Uscita
023500160921       //--------------------------------------------------------------
023600160921       BEGSR exeUscita;
023700160921
023800160921         // Chiusura cursore
023900160921         exec sql close C0;
024000160921
024100160921         return;
024200160921
024300160921       ENDSR;
024400091223
024500160802
024600091223      /end-free
