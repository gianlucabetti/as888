000100121217       //==============================================================
000200170202       // Cicla su lista librerie per Agg. Dati oggetto per logica richiesta
000300121217       //==============================================================
000400141008
000500121217       //--------------------------------------------------------------
000600161103       // Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700121217       //--------------------------------------------------------------
000800121217
000900121217     /*PRM dbgview(*source)
001000121217     /*PRM commit(*none)
001100121217     /*END
001200161108     **
001300161108     ** ISTRUZIONI PER LA COMPILAZIONE
001400161108     **
001500170202     ** 1. Creare il pgm UBLGOBR2 (Opz 14 PDM)
001600161108     **
001700121217
001800121217       //--------------------------------------------------------------
001900161103       // Specifiche di controllo.                                     ?
002000121217       //--------------------------------------------------------------
002100121217
002200170202     h decedit('0,') datedit(*dmy/) option(*nodebugio)
002300170202     h dftactgrp(*no) actgrp('QILE')
002400170202     h bnddir('UBBNDDIR')
002500161104
002600121217       //--------------------------------------------------------------
002700161103       // Dichiarazione file.                                          ?
002800121217       //--------------------------------------------------------------
002900121217
003000121217       //--------------------------------------------------------------
003100161103       // Definizione costanti.                                        ?
003200121217       //--------------------------------------------------------------
003300121217
003400121217
003500121217       //--------------------------------------------------------------
003600161103       // Definizione schiere.                                         ?
003700121217       //--------------------------------------------------------------
003800121217
003900121217
004000121217       //--------------------------------------------------------------
004100161103       // Definizione aree dati.                                       ?
004200121217       //--------------------------------------------------------------
004300121217
004400121217
004500121217       //--------------------------------------------------------------
004600161103       // Definizione strutture dati.                                  ?
004700121217       //--------------------------------------------------------------
004800121218
004900161103       // - Status?
005000121217     d Psds           sds
005100121217     d   SDSpgm          *proc
005200121217     d*//JobName             244    253                                         Job name
005300161103     d*//JobUser             254    263
005400121217     d*//JobNumber           264    269s 0                                      Job number
005500170202
005600170202     D KPJBA         E DS
005700170306
005800170306       // Ricerca/Controllo tabelle (TNTBE)?
005900170306     d TIBS02ds      e ds                  inz
006000170306     d   T02mod      e                     inz('C')
006100170306     d   T02cod      e                     inz('VPR')
006200170323     d   T02ke1      e                     inz
006300170306     d   T02ke2      e                     inz
006400121217
006500121217       //--------------------------------------------------------------
006600161103       // Definizione variabili.                                       ?
006700121217       //--------------------------------------------------------------
006800121217
006900161103       // - Campi di comodo?
007000170202     d wX              s              3s 0
007100170202     d error           s              2a
007200170202     d errorD          s             70a
007300121218
007400161103       // - Stringa SQL da eseguire?
007500161014     d wSQL            s           2048    inz  varying
007600121217
007700121217       //--------------------------------------------------------------
007800161103       // Definizione prototipi procedure.                             ?
007900121217       //--------------------------------------------------------------
008000121217
008100170202       /copy gaitrasrc/srcProtoPR,UBLGOBR
008200121217
008300121217       //--------------------------------------------------------------
008400161103       // Definizione key-list.                                        ?
008500121217       //--------------------------------------------------------------
008600161104
008700121217
008800121217       //--------------------------------------------------------------
008900161103       // Definizione parametri procedura.                             ?
009000121217       //--------------------------------------------------------------
009100121217
009200170202     d Logica          s              2
009300170202     d Lib             ds
009400170202     d  LibDim                       10    dim(12)
009500170202     d Obj             s             10
009600170202     d ObjType         s              7
009700170504     d UsrCrt          s             10
009800170202     d DltLg           s              1
009900170306
010000170306      /copy gaitrasrc/srcProtoPR,TIBS02R
010100161103
010200121217       //--------------------------------------------------------------
010300121217       //?M A I N - L I N E                                            ?
010400121217       //--------------------------------------------------------------
010500121217
010600170202     C     *ENTRY        PLIST
010700170202     C                   PARM                    KPJBA
010800170202
010900161014       // Operazioni iniziali?
011000121217       exsr sr_RoutInz;
011100121217
011200170202       // Esecuzione
011300170202       exsr  sr_Esegui;
011400121217
011500161103       // - Operazioni finali?
011600121217       exsr sr_RoutEnd;
011700121217
011800121217       //--------------------------------------------------------------
011900161103       // Operazioni iniziali.                                         ?
012000121217       //--------------------------------------------------------------
012100121217       BEGSR  sr_RoutInz;
012200121217
012300121217         exec sql  set option  dynusrprf = *owner,
012400121217                               closqlcsr = *endmod;
012500121217
012600161103         // - Controllo parametri d'ingresso
012700161103         exsr  sr_CtrlParms;
012800161103
012900170202         // - Pulizia Dati se richiesta
013000170202         if DltLg = 'S';
013100170202           exsr  sr_DltLg;
013200170202         endif;
013300130208
013400140925       ENDSR;
013500141028
013600141028       //--------------------------------------------------------------
013700161103       // Controllo parametri
013800141028       //--------------------------------------------------------------
013900161103       BEGSR  sr_CtrlParms;
014000161014
014100170202         // valorizzo con i parametri di ingresso
014200170202         Logica = %subst(kpjbu : 01 :2);
014300170202         DltLg  = %subst(kpjbu : 03 :1);
014400170202         Lib    = %subst(kpjbu : 04 :120);
014500170202         ObjType= %subst(kpjbu :124 :  7);
014600170202         Obj    = %subst(kpjbu :131 : 10);
014700170504         UsrCrt = %subst(kpjbu :141 : 10);
014800170202
014900170202         // dati obbligatori
015000170202         //  logica
015100170202         if Logica = *blank;
015200170202           exsr sr_RoutEnd;
015300161104         endif;
015400170202         //  tipo oggetto
015500170202         if ObjType = *blank;
015600170202           exsr sr_RoutEnd;
015700170202         endif;
015800170202         //  oggetto
015900170202         if Obj = *blank;
016000170202           exsr sr_RoutEnd;
016100170202         endif;
016200170306
016300170323         //  se la lista librerie è vuota vedo se c'è un dft in tab. VPR
016400170306         if Lib = *blank;
016500170505           select;
016600170505            when Logica = '01';
016700170306             // recupero dati da tab. VPR  key CTRLOBJ_LOG01
016800170306             // limite data ultimo utilizzo
016900170306             clear kpjbu;
017000170306             //T02mod = 'C';              (già così)?
017100170306             //T02cod = 'VPR';            (già così)?
017200170323             T02ke1 = 'LIBLIST_LOG01';
017300170306             //T02sif = knsif;            (non serve perché quasta è una tab. solo sede)
017400170306             TNTBE_RicercaControllo ( kpjba : tibs02ds );
017500170306             if T02err = *blank;
017600170306               Lib = %subst(T02uni:1:120);
017700170306             else;
017800170306               exsr sr_RoutEnd;
017900170306             endif;
018000170505            when Logica = '02';
018100170323             // recupero dati da tab. VPR  key CTRLOBJ_LOG02
018200170323             // limite data ultimo utilizzo
018300170323             clear kpjbu;
018400170323             //T02mod = 'C';              (già così)?
018500170323             //T02cod = 'VPR';            (già così)?
018600170323             T02ke1 = 'LIBLIST_LOG02';
018700170323             //T02sif = knsif;            (non serve perché quasta è una tab. solo sede)
018800170323             TNTBE_RicercaControllo ( kpjba : tibs02ds );
018900170323             if T02err = *blank;
019000170323               Lib = %subst(T02uni:1:120);
019100170323             else;
019200170323               exsr sr_RoutEnd;
019300170323             endif;
019400170505            other;
019500170323             exsr sr_RoutEnd;
019600170505           endsl;
019700170306         endif;
019800161103
019900161103       ENDSR;
020000161103
020100161103       //--------------------------------------------------------------
020200170202       // Pulisco la logica
020300161103       //--------------------------------------------------------------
020400170202       BEGSR  sr_DltLg;
020500161110
020600170504         wSQL =
020700170504          'delete from wafob00f where foblogica=' + logica;
020800170504         if Obj <> '*ALL';
020900170504           if %scan('*':Obj) > 0;
021000170504             wSQL = %trim(wSQL) + ' ' +
021100170504             'and fobobj like ''' + %trim(%scanrpl('*':'':Obj)) + '%''';
021200170504           else;
021300170504             wSQL = %trim(wSQL) + ' ' +
021400170504             'and fobobj = ''' +
021500170504              %trim(Obj) + '''';
021600170504           endif;
021700170504         endif;
021800170504         if ObjType <> '*ALL';
021900170504           if %scan('*':ObjType) > 0;
022000170504             wSQL = %trim(wSQL) + ' ' +
022100170504             'and fobobjt like ''' + %trim(%scanrpl('*':'':ObjType)) + '%''';
022200170504           else;
022300170504             wSQL = %trim(wSQL) + ' ' +
022400170504             'and fobobjt = ''' +
022500170504              %trim(ObjType) + '''';
022600170504           endif;
022700170504         endif;
022800170504         // prendo come assunto che l'utente sia nei primi 10 char
022900170504         if UsrCrt <> *blank;
023000170504           if %scan('*':UsrCrt) > 0;
023100170504             wSQL = %trim(wSQL) + ' ' +
023200170504             'and substr(fobdati , 1 , 10) like ''' +
023300170504              %trim(%scanrpl('*':'':UsrCrt)) + '%''';
023400170504           else;
023500170504             wSQL = %trim(wSQL) + ' ' +
023600170504             'and substr(fobdati , 1 , 10) = ''' +
023700170504              %trim(UsrCrt) + '''';
023800170504           endif;
023900170504         endif;
024000170504      *UsrCrt          s             10
024100170504
024200170504         // eseguo
024300170504         exec sql execute immediate :wSQL;
024400170504
024500170504         // non testo il risultato perché va bene anche se non trova niente
024600161109
024700141020       ENDSR;
024800121217
024900121217       //--------------------------------------------------------------
025000170202       // Esecuzione
025100121217       //--------------------------------------------------------------
025200170202       BEGSR  sr_Esegui;
025300170202
025400170202         for wX = 1 to %elem(LibDim);
025500170202           if LibDim(wX) <> *blank;
025600170504             ublgobr_s(Logica : LibDim(wX) : Obj : ObjType : UsrCrt
025700170504                       : Error : ErrorD);
025800170202           endif;
025900170202         endfor;
026000161103
026100121217       ENDSR;
026200121217
026300121217       //--------------------------------------------------------------
026400161104       // Operazioni finali.                                           ?
026500121217       //--------------------------------------------------------------
026600121217       BEGSR  sr_RoutEnd;
026700161103
026800161103         // - Chiusura pgm?
026900121217         return;
027000121217
027100121217       ENDSR;
027200121217
