000100121217       //==============================================================
000200170202       // Cicla su lista librerie per Agg. Dati oggetto per logica richiesta
000300121217       //==============================================================
000400141008
000500121217       //--------------------------------------------------------------
000600161103       // Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700121217       //--------------------------------------------------------------
000800121217
000900121217     /*PRM dbgview(*source)
001000121217     /*PRM commit(*none)
001100121217     /*END
001200161108     **
001300161108     ** ISTRUZIONI PER LA COMPILAZIONE
001400161108     **
001500170202     ** 1. Creare il pgm UBLGOBR2 (Opz 14 PDM)
001600161108     **
001700121217
001800121217       //--------------------------------------------------------------
001900161103       // Specifiche di controllo.                                     ?
002000121217       //--------------------------------------------------------------
002100121217
002200170202     h decedit('0,') datedit(*dmy/) option(*nodebugio)
002300170202     h dftactgrp(*no) actgrp('QILE')
002400170202     h bnddir('UBBNDDIR')
002500161104
002600121217       //--------------------------------------------------------------
002700161103       // Dichiarazione file.                                          ?
002800121217       //--------------------------------------------------------------
002900121217
003000121217       //--------------------------------------------------------------
003100161103       // Definizione costanti.                                        ?
003200121217       //--------------------------------------------------------------
003300121217
003400121217
003500121217       //--------------------------------------------------------------
003600161103       // Definizione schiere.                                         ?
003700121217       //--------------------------------------------------------------
003800121217
003900121217
004000121217       //--------------------------------------------------------------
004100161103       // Definizione aree dati.                                       ?
004200121217       //--------------------------------------------------------------
004300121217
004400121217
004500121217       //--------------------------------------------------------------
004600161103       // Definizione strutture dati.                                  ?
004700121217       //--------------------------------------------------------------
004800121218
004900161103       // - Status?
005000121217     d Psds           sds
005100121217     d   SDSpgm          *proc
005200121217     d*//JobName             244    253                                         Job name
005300161103     d*//JobUser             254    263
005400121217     d*//JobNumber           264    269s 0                                      Job number
005500170202
005600170202     D KPJBA         E DS
005700170306
005800170306       // Ricerca/Controllo tabelle (TNTBE)?
005900170306     d TIBS02ds      e ds                  inz
006000170306     d   T02mod      e                     inz('C')
006100170306     d   T02cod      e                     inz('VPR')
006200170323     d   T02ke1      e                     inz
006300170306     d   T02ke2      e                     inz
006400121217
006500121217       //--------------------------------------------------------------
006600161103       // Definizione variabili.                                       ?
006700121217       //--------------------------------------------------------------
006800121217
006900161103       // - Campi di comodo?
007000170202     d wX              s              3s 0
007100170202     d error           s              2a
007200170202     d errorD          s             70a
007300121218
007400161103       // - Stringa SQL da eseguire?
007500161014     d wSQL            s           2048    inz  varying
007600121217
007700121217       //--------------------------------------------------------------
007800161103       // Definizione prototipi procedure.                             ?
007900121217       //--------------------------------------------------------------
008000121217
008100170202       /copy gaitrasrc/srcProtoPR,UBLGOBR
008200121217
008300121217       //--------------------------------------------------------------
008400161103       // Definizione key-list.                                        ?
008500121217       //--------------------------------------------------------------
008600161104
008700121217
008800121217       //--------------------------------------------------------------
008900161103       // Definizione parametri procedura.                             ?
009000121217       //--------------------------------------------------------------
009100121217
009200170202     d Logica          s              2
009300170202     d Lib             ds
009400170202     d  LibDim                       10    dim(12)
009500170202     d Obj             s             10
009600170202     d ObjType         s              7
009700170202     d DltLg           s              1
009800170306
009900170306      /copy gaitrasrc/srcProtoPR,TIBS02R
010000161103
010100121217       //--------------------------------------------------------------
010200121217       //?M A I N - L I N E                                            ?
010300121217       //--------------------------------------------------------------
010400121217
010500170202     C     *ENTRY        PLIST
010600170202     C                   PARM                    KPJBA
010700170202
010800161014       // Operazioni iniziali?
010900121217       exsr sr_RoutInz;
011000121217
011100170202       // Esecuzione
011200170202       exsr  sr_Esegui;
011300121217
011400161103       // - Operazioni finali?
011500121217       exsr sr_RoutEnd;
011600121217
011700121217       //--------------------------------------------------------------
011800161103       // Operazioni iniziali.                                         ?
011900121217       //--------------------------------------------------------------
012000121217       BEGSR  sr_RoutInz;
012100121217
012200121217         exec sql  set option  dynusrprf = *owner,
012300121217                               closqlcsr = *endmod;
012400121217
012500161103         // - Controllo parametri d'ingresso
012600161103         exsr  sr_CtrlParms;
012700161103
012800170202         // - Pulizia Dati se richiesta
012900170202         if DltLg = 'S';
013000170202           exsr  sr_DltLg;
013100170202         endif;
013200130208
013300140925       ENDSR;
013400141028
013500141028       //--------------------------------------------------------------
013600161103       // Controllo parametri
013700141028       //--------------------------------------------------------------
013800161103       BEGSR  sr_CtrlParms;
013900161014
014000170202         // valorizzo con i parametri di ingresso
014100170202         Logica = %subst(kpjbu : 01 :2);
014200170202         DltLg  = %subst(kpjbu : 03 :1);
014300170202         Lib    = %subst(kpjbu : 04 :120);
014400170202         ObjType= %subst(kpjbu :124 :  7);
014500170202         Obj    = %subst(kpjbu :131 : 10);
014600170202
014700170202         // dati obbligatori
014800170202         //  logica
014900170202         if Logica = *blank;
015000170202           exsr sr_RoutEnd;
015100161104         endif;
015200170202         //  tipo oggetto
015300170202         if ObjType = *blank;
015400170202           exsr sr_RoutEnd;
015500170202         endif;
015600170202         //  oggetto
015700170202         if Obj = *blank;
015800170202           exsr sr_RoutEnd;
015900170202         endif;
016000170306
016100170323         //  se la lista librerie è vuota vedo se c'è un dft in tab. VPR
016200170306         if Lib = *blank;
016300170306           if Logica = '01';
016400170306             // recupero dati da tab. VPR  key CTRLOBJ_LOG01
016500170306             // limite data ultimo utilizzo
016600170306             clear kpjbu;
016700170306             //T02mod = 'C';              (già così)?
016800170306             //T02cod = 'VPR';            (già così)?
016900170323             T02ke1 = 'LIBLIST_LOG01';
017000170306             //T02sif = knsif;            (non serve perché quasta è una tab. solo sede)
017100170306             TNTBE_RicercaControllo ( kpjba : tibs02ds );
017200170306             if T02err = *blank;
017300170306               Lib = %subst(T02uni:1:120);
017400170306             else;
017500170306               exsr sr_RoutEnd;
017600170306             endif;
017700170306           else;
017800170306             exsr sr_RoutEnd;
017900170306           endif;
018000170323           if Logica = '02';
018100170323             // recupero dati da tab. VPR  key CTRLOBJ_LOG02
018200170323             // limite data ultimo utilizzo
018300170323             clear kpjbu;
018400170323             //T02mod = 'C';              (già così)?
018500170323             //T02cod = 'VPR';            (già così)?
018600170323             T02ke1 = 'LIBLIST_LOG02';
018700170323             //T02sif = knsif;            (non serve perché quasta è una tab. solo sede)
018800170323             TNTBE_RicercaControllo ( kpjba : tibs02ds );
018900170323             if T02err = *blank;
019000170323               Lib = %subst(T02uni:1:120);
019100170323             else;
019200170323               exsr sr_RoutEnd;
019300170323             endif;
019400170323           else;
019500170323             exsr sr_RoutEnd;
019600170323           endif;
019700170306         endif;
019800161103
019900161103       ENDSR;
020000161103
020100161103       //--------------------------------------------------------------
020200170202       // Pulisco la logica
020300161103       //--------------------------------------------------------------
020400170202       BEGSR  sr_DltLg;
020500161110
020600170202         exec sql
020700170202          delete from wafob00f where foblogica = :logica;
020800161109
020900141020       ENDSR;
021000121217
021100121217       //--------------------------------------------------------------
021200170202       // Esecuzione
021300121217       //--------------------------------------------------------------
021400170202       BEGSR  sr_Esegui;
021500170202
021600170202         for wX = 1 to %elem(LibDim);
021700170202           if LibDim(wX) <> *blank;
021800170202             ublgobr_s(Logica : LibDim(wX) : Obj : ObjType : Error : ErrorD);
021900170202           endif;
022000170202         endfor;
022100161103
022200121217       ENDSR;
022300121217
022400121217       //--------------------------------------------------------------
022500161104       // Operazioni finali.                                           ?
022600121217       //--------------------------------------------------------------
022700121217       BEGSR  sr_RoutEnd;
022800161103
022900161103         // - Chiusura pgm?
023000121217         return;
023100121217
023200121217       ENDSR;
023300121217
