000100121217       //==============================================================
000200161014       // Generazione fake su TIMAT00F per pareggiare
000300121217       //==============================================================
000400141008
000500121217       //--------------------------------------------------------------
000600121217       //?Parametri di compilazione (vedi *cmd UBCRTOBJ).              ?
000700121217       //--------------------------------------------------------------
000800121217
000900121217     /*PRM dbgview(*source)
001000121217     /*PRM commit(*none)
001100121217     /*END
001200121217
001300121217       //--------------------------------------------------------------
001400121217       //?Specifiche di controllo.                                     ?
001500121217       //--------------------------------------------------------------
001600121217
001700121217     h decedit('0,') datedit(*dmy/) option(*nodebugio)
001800121217     h dftactgrp(*no)
001900121217     h alwnull(*inputonly)
002000121217     h bnddir('UBBNDDIR')
002100141029       // per dire che i calcoli intermedi devono avere lo stesso num. decimali del risultato
002200141029     h expropts(*resdecpos)
002300121217
002400121217       //--------------------------------------------------------------
002500121217       //?Dichiarazione file.                                          ?
002600121217       //--------------------------------------------------------------
002700121217
002800121217       //--------------------------------------------------------------
002900121217       //?Definizione costanti.                                        ?
003000121217       //--------------------------------------------------------------
003100121217
003900121217
004000121217       //--------------------------------------------------------------
004100121217       //?Definizione schiere.                                         ?
004200121217       //--------------------------------------------------------------
004300121217
005100121217
005200121217       //--------------------------------------------------------------
005300121217       //?Definizione aree dati.                                       ?
005400121217       //--------------------------------------------------------------
005500121217
006100121217
006200121217       //--------------------------------------------------------------
006300121217       //?Definizione strutture dati.                                  ?
006400121217       //--------------------------------------------------------------
006500121217
006600121217       // -?Parametri in input?
006700121218     d KPJBA         e ds
006800121218
007300121217       // -?Status?
007400121217     d Psds           sds
007500121217     d   SDSpgm          *proc
007600121217     d*//JobName             244    253                                         Job name
007700121217     d*//JobUser             254    263                                         User name
007800121217     d*//JobNumber           264    269s 0                                      Job number
007900121217
008000121217       //--------------------------------------------------------------
008100121217       //?Definizione variabili.                                       ?
008200121217       //--------------------------------------------------------------
009700121217
009800121217       // -?Campi di comodo?
011200121218
011300141027       // -?Dati di  dialogo
011301161014     D UBMATFKDS       DS                  inz
011302161014     D  iTmStD                         z
011303161014     D  iTmStA                         z
011304161014     D  oEsito                        3s 0
011700141027
011800121217       // -?Stringa SQL da eseguire?
011900161014     d wSQL            s           2048    inz  varying
012300121217
012400121217       //--------------------------------------------------------------
012500121217       //?Definizione prototipi procedure.                             ?
012600121217       //--------------------------------------------------------------
013500121217
013800121217
013900121217       //--------------------------------------------------------------
014000121217       //?Definizione key-list.                                        ?
014100121217       //--------------------------------------------------------------
014200121217
014300121217
014400121217       //--------------------------------------------------------------
014500121217       //?Definizione parametri procedura.                             ?
014600121217       //--------------------------------------------------------------
014700121217
014800121217     c     *Entry        plist
014900121217     c                   parm                    KPJBA
015000121217
015100121217      /free
015200121217
015300121217       //--------------------------------------------------------------
015400121217       //?M A I N - L I N E                                            ?
015500121217       //--------------------------------------------------------------
015600121217
015700161014       // Operazioni iniziali?
015800121217       exsr sr_RoutInz;
015900121217
016000161014       // Esecuzione pareggio
016200161014       exsr  sr_Pareggio;
017000121217
017100121217       // -?Operazioni finali?
017200121217       exsr sr_RoutEnd;
017300121217
017400121217       //--------------------------------------------------------------
017500121217       //?Operazioni iniziali.                                         ?
017600121217       //--------------------------------------------------------------
017700121217       BEGSR  sr_RoutInz;
017800141217
017900161014         UBMATFKDS = kpjbu;
018400121217
018500121217         exec sql  set option  dynusrprf = *owner,
018600121217                               closqlcsr = *endmod;
021000121217
021100121217         // -?Preparazione stringa SQL?
021200121217         exsr  sr_PrepSQL;
021300121217
021400121217         // -?Apertura cursore SQL?
021500121217         exsr  sr_OpenCursor;
021900130208
022000140925       ENDSR;
023900141028
024000141028       //--------------------------------------------------------------
024100161014       //?Preparazione stringhe SQL                                     ?
024200141028       //--------------------------------------------------------------
024300141028       BEGSR  sr_PrepSQL;
025731161014
025732161014         wSQL  ='insert into timat00f +
025733161014                 SELECT ''BM1'' , malprog, 0 , rrn(TIMAL00F) , +
025734161014                 ''Reset by CED IT-VAS ('' concat +
025735161014                 char(current_timestamp) +
025736161014                 concat '')'' , +
025737161014                 '' '', '' '', '' '', '' '', ''Reset by CED IT-VAS'' , +
025738161014                 dec( +
025739161014                 SUBSTR(CHAR(curdate(),iso) , 1 , 4) concat +
025740161014                 SUBSTR(CHAR(curdate(),iso) , 6 , 2) concat +
025741161014                 SUBSTR(CHAR(curdate(),iso) , 9 , 2)        +
025742161014                 concat                                     +
025743161014                 SUBSTR(CHAR(curtime(),iso) , 1 , 2) concat +
025744161014                 SUBSTR(CHAR(curtime(),iso) , 4 , 2) concat +
025745161014                 SUBSTR(CHAR(curtime(),iso) , 7 , 2)         ) +
025746161014                 ,                                             +
025747161014                 dec(                                          +
025748161014                 SUBSTR(CHAR(curdate(),iso) , 1 , 4) concat    +
025749161014                 SUBSTR(CHAR(curdate(),iso) , 6 , 2) concat    +
025750161014                 SUBSTR(CHAR(curdate(),iso) , 9 , 2)           +
025751161014                 concat                                        +
025752161014                 SUBSTR(CHAR(curtime(),iso) , 1 , 2) concat    +
025753161014                 SUBSTR(CHAR(curtime(),iso) , 4 , 2) concat    +
025754161014                 SUBSTR(CHAR(curtime(),iso) , 7 , 2)         ) +
025755161014                 ,                                             +
025756161014                 dec(                                          +
025757161014                 SUBSTR(maldaor , 1 , 4) concat                +
025758161014                 SUBSTR(maldaor , 6 , 2)                       +
025759161014                 )                                             +
025760161014                 from timal00f +
025761161014                 exception join +
025762161014                 timat00f +
025763161014                 on matprog = malprog and mattrc=''BM1'' and +
025764161014                    char(mataas)  = substr(maldaor , 1 , 4) concat +
025765161014                                    substr(maldaor , 6 , 2) +
025766161014                 where +
025767161014                 substr(MALDUEX, 31, 121) <> '' '' and MALATT = MALTOTATT +
025768161014                 and MALSTS <> ''2'' +
025769161014                 and timestamp(maldaor) between ''' +
025770161014                 %char(iTmStD) + ''' and ''' +
025771161014                 %char(iTmStA) + '''';
025772161014
025800141020       ENDSR;
025900121217
026000121217       //--------------------------------------------------------------
026100121217       //?Apertura cursore.                                            ?
026200121217       //--------------------------------------------------------------
026300121217       BEGSR  sr_OpenCursor;
026400121217
026401161014         // non ho cursori da aprire
027700121217
027800121217       ENDSR;
027900121217
028000121217       //--------------------------------------------------------------
028100121217       //?Lettura cursore.                                             ?
028200121217       //--------------------------------------------------------------
028300161014       BEGSR  sr_Pareggio;
028400121217
028401161014         exec sql   execute immediate  :wsql;
028402161014
028403161014         if sqlcode < 0;     //errore in insert
028404161014           oEsito = 0;
028405161014         else;
028406161014           oEsito = 1;
028407161014         endif;
033800121217
033900121217       ENDSR;
034000121217
034100121217       //--------------------------------------------------------------
034200121217       //?Chiusura cursore.                                            ?
034300121217       //--------------------------------------------------------------
034400121217       BEGSR  sr_CloseCursor;
034500121217
034501161014         // non ho cursori da chiudere
034800121217
034900121217       ENDSR;
036100121217
036200121217       //--------------------------------------------------------------
036300121217       //?Operazioni finali.                                           ?
036400121217       //--------------------------------------------------------------
036500121217       BEGSR  sr_RoutEnd;
036600121217
036700121217         // -?Chiusura cursore SQL?
036800121217         exsr  sr_CloseCursor;
036900141028
037000141028         // -?valorizza i parametri di output?
037100161014         kpjbu = UBMATFKDS;
037200121217
037300121217         // -?Chiusura pgm?
037400141029         *inlr = *on;
037500121217         return;
037600121217
037700121217       ENDSR;
037800121217
037900121217      /end-free
