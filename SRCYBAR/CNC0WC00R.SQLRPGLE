000100060321      //**********************************************************************************
000200060321      //
000300060330      // Questo programma immette il dettaglio del pos
000400060321      //
000500060321      //**********************************************************************************
000600060320     H DFTACTGRP(*NO) ACTGRP(*CALLER)
000700060320     H DATEDIT(*YMD) DECEDIT(*JOBRUN)
000800060320
000900060321      //**********************************************************************************
001000060321      //
001100060321      // Definizione files.
001200060321      //
001300060321      //**********************************************************************************
001400060330     Fcnc0wc00d CF   E             WORKSTN
001600060320     F                                     INFDS(infDspF)
001700060320     F                                     INDDS(indDspF)
001800060320     F                                     SFILE(s01:s01Rrn)
001900060320
002000060321      //**********************************************************************************
002100060321      //
002200060321      // Definizione costanti.
002300060321      //
002400060321      //**********************************************************************************
002500060320     D F3              C                   X'33'
002600060320     D F5              C                   X'35'
002700060320     D F6              C                   X'36'
002800060320     D F8              C                   X'38'
002900060320     D F12             C                   X'3C'
003000060322     D F21             C                   X'B9'
003100060320     D Enter           C                   X'F1'
003200060320     D ReverseImage    C                   X'21'
003300060320     D HighIntensity   C                   X'22'
003400060320     D Blink           C                   X'28'
003500060321     D IgnoreDBCSdata...
003600060321     D                 C                   '0'
003700060321     D NeverPromptTheCommand...
003800060321     D                 C                   '0'
003900060321     D CommandRunning...
004000060321     D                 C                   '0'
004100060320
004200060321      //**********************************************************************************
004300060321      //
004400060321      // Definizione delle procedure esterne usate.
004500060321      //
004600060321      //**********************************************************************************
004700060322     D tibs34r         PR
004800060322     D                                     EXTPGM('TIBS34R')
004900060322     D  tibs34ds
005000060322     D                                     LIKEDS(tibs34ds)
005100060322     D trul29c         PR
005200060320     D                                     EXTPGM('TRUL29C')
005300060320     D  obj                          10A
005400060320     D                                     CONST
005500060320     D  objType                       8A
005600060320     D                                     CONST
005700060320     D  rtnLib                       10A
005800060321     D ProcessCommands...
005900060321     D                 PR
006000060320     D                                     EXTPGM('QCAPCMD')
006100060320     D  sourceCommandString...
006200060321     D                            32767A
006300060321     D                                     CONST
006400060321     D                                     OPTIONS(*VARSIZE)
006500060320     D  sourceCommandStringLength...
006600060320     D                               10I 0
006700060320     D                                     CONST
006800060320     D  optionsControlBlock...
006900060321     D                                     LIKE(QCAP0100)
007000060321     D                                     CONST
007100060321     D                                     OPTIONS(*VARSIZE)
007200060320     D  optionsControlBlockLength...
007300060320     D                               10I 0
007400060320     D                                     CONST
007500060320     D  optionsControlBlockFormat...
007600060320     D                                8A
007700060320     D                                     CONST
007800060320     D  changedCommandString...
007900060321     D                            32767A
008000060321     D                                     OPTIONS(*VARSIZE:*OMIT)
008100060320     D  lengthAvailableForChangedCommandString...
008200060320     D                               10I 0
008300060320     D                                     CONST
008400060320     D  lengthOfChangedCommandStringAvailableToReturn...
008500060320     D                               10I 0
008600060320     D  errorCode...
008700060321     D                                     LIKE(qusec)
008800060321     D                                     OPTIONS(*VARSIZE)
008900060321     D DisplayLongText...
009000060321     D                 PR
009100060321     D                                     EXTPGM('QUILNGTX')
009200060321     D  TextString...
009300060321     D                              256A
009400060321     D                                     CONST
009500060321     D                                     OPTIONS(*VARSIZE)
009600060321     D  LengthOfTextString...
009700060321     D                               10I 0
009800060321     D                                     CONST
009900060321     D  MessageID...
010000060321     D                                7A
010100060321     D                                     CONST
010200060321     D  QualifiedMessageFileName...
010300060321     D                               20A
010400060321     D                                     CONST
010500060321     D  ErrorCode...
010600060321     D                                     LIKE(qusec)
010700060321     D                                     OPTIONS(*VARSIZE)
010800060330     D cnc0wc01r       PR
010900060330     D                                     EXTPGM('CNC0WC01R')
011000060323     D  kpjba
011100060323     D                                     LIKEDS(kpjba)
011200060323
011300060321      //**********************************************************************************
011400060321      //
011500060321      // Definizione strutture dati.
011600060321      //
011700060321      //**********************************************************************************
011800060320     D infDspF         DS
011900060320     D  dsp_aid              369    369A                                        AID byte
012000060320     D  sf_rrn               376    377I 0                                      Subfile rr
012100060320     D indDspF         DS
012200060320     D  sflDspCtl             25     25N
012300060320     D  sflDsp                26     26N
012400060320     D  sflClr                27     27N
012500060320     D  sflEnd                28     28N
012600060321     D  sflNxtChg             29     29N
012700060321     D  errQuadratura         30     30N
012800060321     D  errGenerico           99     99N
012900060320     D cndizion      E DS
013000060320     D                                     BASED(nullPtr)
013100060320     D                                     PREFIX(diz)
013200060320     D andiz00f      E DS
013300060320     D                                     BASED(nullPtr)
013400060320     D                                     PREFIX(pjz)
013500060320     D kpjba         E DS
013600060330     D cnc0wc00s     E DS
013700060320     D                                     INZ
013800060321     D                                     PREFIX(prm)
013900060322     D tibs34ds      E DS
014000060322     D                                     INZ
014001060330     D fidpids       E DS                  extname(fidpi00f)
014002060330     D                                     INZ
014100060322
014200060321      //**********************************************************************************
014300060321      //
014400060321      // Definizione variabili.
014500060321      //
014600060321      //**********************************************************************************
014700060322     D/COPY QSYSINC/QRPGLESRC,QCAPCMD
014800060322     D/COPY QSYSINC/QRPGLESRC,QUSEC
014900060320     D nullPtr         S               *
015000060320     D rtnLib          S             10A
015100060320     D opCode          S             10A
015200060320     D                                     INZ('INZC01')
015300060320     D s01Rrn          S              5I 0
015400060320     D esito           S             10I 0
015500060320     D comando         S            256A
015600060321     D testo           S            256A
015700060323     D stampare        S              1N
015800060321
015900060322      //**********************************************************************************
016000060322      //
016100060322      // Definizione aree dati.
016200060322      //
016300060322      //**********************************************************************************
016400060322     D §azute        E DS
016500060322     D                                     EXTNAME(azute00f)
016600060322     D                                     DTAARA
016700060322     D §DatiUte      E DS
016800060322     D                                     EXTNAME(dDatiUte)
016900060322     D                                     DTAARA
017000060322
017100060321      //**********************************************************************************
017200060321      //
017300060321      // Definizione parametri procedura.
017400060321      //
017500060321      //**********************************************************************************
017600060320     C     *ENTRY        PLIST
017700060320     C                   PARM                    kpjba
017800060320
017900060320      /FREE
018000060320
018100060320       EXSR inzProc;
018200060320
018300060320       DOU opCode = 'END';
018400060320         SELECT;
018500060320           WHEN opCode = 'END';
018600060320             LEAVE;
018900060320           WHEN opCode = 'PUTC01';
019000060320             EXSR putC01;
019100060320           WHEN opCode = 'CHKC01';
019200060320             EXSR getC01Chk;
019300060323           WHEN opCode = 'PRTDATA';
019400060323             EXSR prtData;
019700060321           WHEN opCode = 'ERRORE';
019800060321             EXSR errore;
019900060320           OTHER;
020000060321             prmOpCode = opCode;
020100060320             LEAVE;
020200060320         ENDSL;
020300060320       ENDDO;
020400060320
020500060320       EXSR uscita;
020600060320
020700060320       //*********************************************************************************
020800060320       //
020900060320       // Operazioni iniziali da eseguire una tantum.
021000060320       //
021100060320       //*********************************************************************************
021200060320       BEGSR *INZSR;
021300060321      /END-FREE
021400060321     C/EXEC SQL
021500060321     C+ SET OPTION CLOSQLCSR = *ENDMOD, DYNUSRPRF = *OWNER
021600060321     C/END-EXEC
021700060321      /FREE
021800060322
021900060322         IN(E) §azute;
022000060322         IF NOT %ERROR;
022100060322           IN(E) §DatiUte;
022200060322         ENDIF;
022300060322         IF %ERROR OR rsut = ' ';
022400060322           tibs34r(tibs34ds);
022500060322           IN §azute;
022600060322           IN §DatiUte;
022700060322         ENDIF;
022701060330
022702060330       EXSR inzc01;
022800060322
022900060322       ENDSR;
023000060320
023100060320       //*********************************************************************************
023200060320       //
023300060320       // Operazioni iniziali.
023400060320       //
023500060320       //*********************************************************************************
023600060320       BEGSR inzProc;
023700060320
023800060321         RESET opCode;
023900060323         RESET stampare;
024000060320         EXSR chkParm;
026700060320
026800060320       ENDSR;
026900060320
027000060320       //*********************************************************************************
027100060320       //
027200060320       // Controllo dei parametri ricevuti.
027300060320       //
027400060320       //*********************************************************************************
027500060320       BEGSR chkParm;
027600060320
027700060330         cnc0wc00s = kpjbu;
027800060320         CLEAR prmRtnCmd;
027900060320         CLEAR prmRtnCode;
028000060321         CLEAR prmImpImmesso;
028600060320
028700060320       ENDSR;
028800060320
028900060320       //*********************************************************************************
029000060320       //
029100060321       // Inizializzo subfile contante.
029200060320       //
029300060320       //*********************************************************************************
029400060320       BEGSR inzC01;
029500060320
029600060321         opCode = 'PUTC01';
029700060321
030200060321         sflDspCtl = *OFF;
030300060320         sflDsp = *OFF;
030400060320         sflEnd = *OFF;
030500060320         sflClr = *ON;
030600060320         WRITE c01;
030700060321         sflDspCtl = *ON;
030800060320         sflDsp = *ON;
030900060320         sflClr = *OFF;
031000060320         sflNxtChg = *OFF;
031100060320         CLEAR s01Rrn;
031200060320         EXSR azzeraTotali;
031300060320
031400060321      /END-FREE
031500060321     C/EXEC SQL
031600060321     C+ DECLARE CONTANTE CURSOR FOR
031700060330     C+ SELECT *
031800060330     C+ FROM fidpi00F
032000060330     C+ WHERE dpiknraz = :knraz
032200060330     C+ ORDER BY dpivalore
032300060321     C+ FOR READ ONLY
032400060321     C/END-EXEC
032500060321     C
032600060321     C/EXEC SQL
032700060321     C+ OPEN CONTANTE
032800060321     C/END-EXEC
032900060321      /FREE
033000060321
033100060321         IF sqlCod < 0;
033200060321           prmRtnCode = 'ERRSQLOPN';
033300060321           esito = sqlCod;
033400060321           opCode = 'ERRORE';
033500060321           LEAVESR;
033600060321         ENDIF;
033700060321
033800060321         DOU sqlCod = 100;
033900060321      /END-FREE
034000060321     C/EXEC SQL
034100060330     C+ FETCH CONTANTE INTO :fidpids
034200060321     C/END-EXEC
034300060321      /FREE
034400060321           SELECT;
034500060321             WHEN sqlCod = 100;
034600060321               sflEnd = *ON;
034700060321               LEAVE;
034800060321             WHEN sqlCod < 0;
034900060321               prmRtnCode = 'ERRSQLFET';
035000060321               esito = sqlCod;
035100060321               opCode = 'ERRORE';
035200060321               LEAVE;
035300060321             OTHER;
035400060321               EXSR setS01;
035500060330               sflNxtChg = (selv <> ' ');
035600060321               s01Rrn += 1;
035700060321               WRITE s01;
035800060321               EXSR calcolaTotali;
035900060321           ENDSL;
036000060321         ENDDO;
036100060321
036200060321      /END-FREE
036300060321     C/EXEC SQL
036400060321     C+ CLOSE CONTANTE
036500060321     C/END-EXEC
036600060321      /FREE
036700060320
036800060320       ENDSR;
036900060321
037000060321       //*********************************************************************************
037100060321       //
037200060321       // Impostazione riga contante.
037300060321       //
037400060321       //*********************************************************************************
037500060321       BEGSR setS01;
037501060330         selv = ' ';
037502060330         aasv = dpiaas;
037503060330         lnpv = dpilnp;
037504060330         nrsv = dpinrs;
037505060330         nspv = dpinsp;
037506060330         vcav = dpidiv;
037507060330         casv = dpivalore;
037800060321
037900060321       ENDSR;
038000060320
038100060320       //*********************************************************************************
038200060320       //
038300060321       // Emissione subfile contante.
038400060320       //
038500060320       //*********************************************************************************
038600060320       BEGSR putC01;
038700060320
038800060321         opCode = 'PUTC01';
038900060320
039000060330         c01Div = 'EUR';
039100060321         IF prmImpTotale > 0;
039200060321           c01Importo = prmImpTotale;
039300060321         ELSE;
039400060321           c01Importo = prmImpImmesso;
039500060321         ENDIF;
039600060321
039700060320         WRITE f01;
039800060320         EXFMT c01;
039900060320
040000060320         prmRtnCmd = dsp_aid;
040100060320
040200060320         SELECT;
040300060320           WHEN dsp_aid = F3 OR dsp_aid = F8 OR dsp_aid = F12;
040400060320             opCode = 'END';
040500060320           WHEN dsp_aid = F5;
040600060320             opCode = 'INZC01';
040700060320           WHEN dsp_aid = F6 OR dsp_aid = Enter;
040800060320             opCode = 'CHKC01';
040900060322           WHEN dsp_aid = F21;
041000060323             stampare = *ON;
041100060320         ENDSL;
041200060320
041300060320       ENDSR;
041400060320
041500060320       //*********************************************************************************
041600060320       //
041700060320       // Lettura subfile partite incassate per controlli.
041800060320       //
041900060320       //*********************************************************************************
042000060320       BEGSR getC01Chk;
042001060330
042200060321         opCode = 'PUTC01';
042201060330
042202060330         if dsp_aid = F6;
042203060330         opCode = 'END';
042204060330         endif;
042205060330
042300060320         *IN99 = *OFF;
042400060321         CLEAR p01Importo;
042500060321         CLEAR p01MsgId30;
042600060320         EXSR azzeraTotali;
042700060321         sflNxtChg = *ON;
042800060320
042900060320         DOU %EOF;
043000060320           READC s01;
043100060320           IF %EOF;
043200060320             LEAVE;
043300060320           ENDIF;
043500060320           EXSR calcolaTotali;
043600060320           UPDATE s01;
043700060320         ENDDO;
043800060320
043900060320         sflNxtChg = *OFF;
044000060320
044100060321         IF prmImpTotale > 0 AND prmImpTotale <> prmImpImmesso;
044200060321           *IN99 = *ON;
044300060321           p01Importo = ReverseImage;
044400060321           errQuadratura = *ON;
044500060321           p01MsgId30 = 'Squadratura ' +
044600060321           %TRIML(%EDITC(prmImpImmesso-prmImpTotale:'K')) + '.';
044700060321         ENDIF;
045200060320
045300060320       ENDSR;
045400060320
052200060320       //*********************************************************************************
052300060320       //
052400060320       // Azzera totali.
052500060320       //
052600060320       //*********************************************************************************
052700060320       BEGSR azzeraTotali;
052800060320
052900060321         c01Importo = prmImpTotale;
053000060321         CLEAR prmImpImmesso;
053100060320
053200060320       ENDSR;
053300060320
053400060320       //*********************************************************************************
053500060320       //
053600060320       // Calcolo totali.
053700060320       //
053800060320       //*********************************************************************************
053900060320       BEGSR calcolaTotali;
054000060320
054001060330       if selv = '1';
054100060330         prmImpImmesso += casv;
054101060330       endif;
054200060320
054300060320       ENDSR;
054400060322
054500060322       //*********************************************************************************
054600060322       //
054700060322       // Stampa dati immessi.
054800060322       //
054900060322       //*********************************************************************************
055000060323       BEGSR prtData;
055100060322
055200060323         opCode = 'END';
055300060323         CLEAR esito;
055400060330         kpjbu = cnc0wc00s;
055500060330         cnc0wc01r(kpjba);
055600060330         cnc0wc00s = kpjbu;
055700060322
055800060322       ENDSR;
055900060321
056000060321       //*********************************************************************************
056100060321       //
056200060321       // Errore.
056300060321       //
056400060321       //*********************************************************************************
056500060321       BEGSR errore;
056600060321
056700060321         opCode = 'END';
056800060321         testo = 'Si è verificato l''errore ' + %TRIMR(prmRtnCode)
056900060321         + ' esito ' + %TRIML(%CHAR(esito))
057000060321         + '. Premere invio per continuare.';
057100060321         CLEAR qusec;
057200060321         qusbprv = %SIZE(qusec);
057300060321         DisplayLongText(testo:%SIZE(testo):'BAR0019':'YBARMSG   *LIBL'
057400060321         :qusec);
057500060321
057600060321       ENDSR;
057700060320
057800060320       //*********************************************************************************
057900060320       //
058000060320       // Uscita.
058100060320       //
058200060320       //*********************************************************************************
058300060320       BEGSR uscita;
058400060320
058600060321         IF prmRtnCode = ' ';
058700060321           prmRtnCode = 'DONE';
058800060321         ENDIF;
058900060330         kpjbu = cnc0wc00s;
058901060330         write frcdta;
059000060320         RETURN;
059100060320
059200060320       ENDSR;
059300060320
059400060320      /END-FREE
